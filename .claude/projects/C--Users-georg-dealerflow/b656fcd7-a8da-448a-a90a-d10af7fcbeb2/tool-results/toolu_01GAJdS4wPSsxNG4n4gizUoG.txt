     1→import { useState, useEffect, useRef } from "react";
     2→import { useRouter } from "next/router";
     3→import Head from "next/head";
     4→import Link from "next/link";
     5→import DashboardLayout from "@/components/DashboardLayout";
     6→import { toast } from "react-hot-toast";
     7→import { showDummyNotification } from "@/utils/notifications";
     8→
     9→export default function NewVehicle() {
    10→  const router = useRouter();
    11→  const [isLoading, setIsLoading] = useState(false);
    12→  const [isLookingUp, setIsLookingUp] = useState(false);
    13→
    14→  // VRM suggestions state
    15→  const [vrmSuggestions, setVrmSuggestions] = useState([]);
    16→  const [showSuggestions, setShowSuggestions] = useState(false);
    17→  const [isSearching, setIsSearching] = useState(false);
    18→  const [selectedAppraisal, setSelectedAppraisal] = useState(null);
    19→  const suggestionRef = useRef(null);
    20→  const searchTimeoutRef = useRef(null);
    21→
    22→  const [formData, setFormData] = useState({
    23→    vehicleReg: "",
    24→    make: "",
    25→    model: "",
    26→    year: "",
    27→    colour: "",
    28→    mileage: "",
    29→    fuelType: "",
    30→    transmission: "",
    31→    engineSize: "",
    32→    doors: "",
    33→    purchasePrice: "",
    34→    salePrice: "",
    35→    notes: "",
    36→    motExpiryDate: "",
    37→  });
    38→  const [dvlaDetails, setDvlaDetails] = useState(null);
    39→  const [lastDvlaFetchAt, setLastDvlaFetchAt] = useState(null);
    40→
    41→  // Close suggestions when clicking outside
    42→  useEffect(() => {
    43→    function handleClickOutside(event) {
    44→      if (suggestionRef.current && !suggestionRef.current.contains(event.target)) {
    45→        setShowSuggestions(false);
    46→      }
    47→    }
    48→    document.addEventListener("mousedown", handleClickOutside);
    49→    return () => document.removeEventListener("mousedown", handleClickOutside);
    50→  }, []);
    51→
    52→  const handleChange = (e) => {
    53→    const { name, value } = e.target;
    54→    setFormData((prev) => ({ ...prev, [name]: value }));
    55→
    56→    // Search for VRM suggestions when typing in the registration field
    57→    if (name === "vehicleReg" && value.length >= 2) {
    58→      // Debounce the search
    59→      if (searchTimeoutRef.current) {
    60→        clearTimeout(searchTimeoutRef.current);
    61→      }
    62→      searchTimeoutRef.current = setTimeout(() => {
    63→        searchVrmSuggestions(value);
    64→      }, 300);
    65→    } else if (name === "vehicleReg" && value.length < 2) {
    66→      setVrmSuggestions([]);
    67→      setShowSuggestions(false);
    68→    }
    69→  };
    70→
    71→  const searchVrmSuggestions = async (query) => {
    72→    setIsSearching(true);
    73→    try {
    74→      const res = await fetch(`/api/vehicles/vrm-suggestions?q=${encodeURIComponent(query)}`);
    75→      if (res.ok) {
    76→        const data = await res.json();
    77→        setVrmSuggestions(data);
    78→        setShowSuggestions(data.length > 0);
    79→      }
    80→    } catch (error) {
    81→      console.error("Error fetching VRM suggestions:", error);
    82→    } finally {
    83→      setIsSearching(false);
    84→    }
    85→  };
    86→
    87→  const selectAppraisal = (appraisal) => {
    88→    setSelectedAppraisal(appraisal);
    89→    setFormData((prev) => ({
    90→      ...prev,
    91→      vehicleReg: appraisal.vehicleReg,
    92→      make: appraisal.vehicleMake || prev.make,
    93→      model: appraisal.vehicleModel || prev.model,
    94→      year: appraisal.vehicleYear || prev.year,
    95→      colour: appraisal.colour || prev.colour,
    96→      mileage: appraisal.mileage || prev.mileage,
    97→      fuelType: appraisal.fuelType || prev.fuelType,
    98→      purchasePrice: appraisal.proposedPurchasePrice || prev.purchasePrice,
    99→      notes: appraisal.conditionNotes || prev.notes,
   100→    }));
   101→    setShowSuggestions(false);
   102→    toast.success(`Loaded data from ${appraisal.type === "buying" ? "buying appraisal" : "customer PX"}`);
   103→  };
   104→
   105→  const handleDvlaLookup = async () => {
   106→    if (!formData.vehicleReg) {
   107→      toast.error("Please enter a registration number");
   108→      return;
   109→    }
   110→
   111→    setIsLookingUp(true);
   112→    try {
   113→      // Call both new DVLA VES endpoint and MOT APIs in parallel
   114→      const [dvlaResponse, motResponse] = await Promise.all([
   115→        fetch("/api/dvla/vehicle-enquiry", {
   116→          method: "POST",
   117→          headers: { "Content-Type": "application/json" },
   118→          body: JSON.stringify({ registrationNumber: formData.vehicleReg }),
   119→        }),
   120→        fetch(`/api/mot?vrm=${encodeURIComponent(formData.vehicleReg)}`).catch(() => null),
   121→      ]);
   122→
   123→      const dvlaResult = await dvlaResponse.json();
   124→      const motData = motResponse?.ok ? await motResponse.json() : null;
   125→
   126→      // Handle DVLA error responses
   127→      if (!dvlaResult.ok) {
   128→        const errorCode = dvlaResult.code || "UNKNOWN";
   129→        switch (errorCode) {
   130→          case "NOT_FOUND":
   131→            toast.error("VRM not found - please check the registration");
   132→            break;
   133→          case "INVALID_FORMAT":
   134→            toast.error("Invalid registration format");
   135→            break;
   136→          case "NOT_CONFIGURED":
   137→            toast.error("DVLA integration not configured");
   138→            break;
   139→          case "RATE_LIMIT":
   140→            toast.error("Too many requests, please try again later");
   141→            break;
   142→          case "DVLA_ERROR":
   143→            toast.error("DVLA service unavailable, try again later");
   144→            break;
   145→          default:
   146→            toast.error(dvlaResult.message || "Lookup failed");
   147→        }
   148→        return;
   149→      }
   150→
   151→      const dvlaData = dvlaResult.data;
   152→
   153→      if (dvlaResult.isDummy) {
   154→        showDummyNotification("DVLA API");
   155→      }
   156→
   157→      // Store DVLA details for persisting when vehicle is saved
   158→      setDvlaDetails(dvlaData.dvlaDetails);
   159→      setLastDvlaFetchAt(dvlaData.lastDvlaFetchAt);
   160→
   161→      // Use DVLA data primarily, but fallback to MOT data for fields DVLA often misses
   162→      // MOT API (DVSA) typically has better model/fuelType data than DVLA
   163→      setFormData((prev) => ({
   164→        ...prev,
   165→        make: dvlaData.make || motData?.make || prev.make,
   166→        model: motData?.model || prev.model, // DVLA doesn't return model, use MOT data
   167→        year: dvlaData.yearOfManufacture || motData?.manufactureYear || prev.year,
   168→        colour: dvlaData.colour || motData?.primaryColour || prev.colour,
   169→        fuelType: dvlaData.dvlaDetails?.fuelType || motData?.fuelType || prev.fuelType,
   170→        engineSize: dvlaData.dvlaDetails?.engineCapacity ? `${dvlaData.dvlaDetails.engineCapacity}cc` : (motData?.engineSize || prev.engineSize),
   171→        motExpiryDate: dvlaData.dvlaDetails?.motExpiryDate || motData?.motExpiry || prev.motExpiryDate,
   172→      }));
   173→
   174→      const messages = ["Vehicle details loaded"];
   175→      if (dvlaData.dvlaDetails?.motExpiryDate || motData?.motExpiry) {
   176→        const motDate = dvlaData.dvlaDetails?.motExpiryDate || motData?.motExpiry;
   177→        messages.push(`MOT expires: ${new Date(motDate).toLocaleDateString()}`);
   178→      }
   179→      toast.success(messages.join(" • "));
   180→    } catch (error) {
   181→      toast.error("DVLA service unavailable, try again later");
   182→    } finally {
   183→      setIsLookingUp(false);
   184→    }
   185→  };
   186→
   187→  const handleSubmit = async (e) => {
   188→    e.preventDefault();
   189→    setIsLoading(true);
   190→
   191→    try {
   192→      const response = await fetch("/api/vehicles", {
   193→        method: "POST",
   194→        headers: { "Content-Type": "application/json" },
   195→        body: JSON.stringify({
   196→          regCurrent: formData.vehicleReg,
   197→          make: formData.make,
   198→          model: formData.model,
   199→          year: formData.year,
   200→          colour: formData.colour,
   201→          mileageCurrent: formData.mileage,
   202→          fuelType: formData.fuelType,
   203→          transmission: formData.transmission,
   204→          notes: formData.notes,
   205→          motExpiryDate: formData.motExpiryDate || null,
   206→          // Include DVLA details if available from lookup
   207→          dvlaDetails: dvlaDetails || null,
   208→          lastDvlaFetchAt: lastDvlaFetchAt || null,
   209→        }),
   210→      });
   211→
   212→      if (!response.ok) {
   213→        const err = await response.json();
   214→        throw new Error(err.error || "Failed to create vehicle");
   215→      }
   216→
   217→      toast.success("Vehicle added successfully!");
   218→      router.push("/vehicles");
   219→    } catch (error) {
   220→      console.error(error);
   221→      toast.error(error.message);
   222→    } finally {
   223→      setIsLoading(false);
   224→    }
   225→  };
   226→
   227→  return (
   228→    <DashboardLayout>
   229→      <Head>
   230→        <title>Add Vehicle | DealerFlow</title>
   231→      </Head>
   232→
   233→      <div className="mb-8">
   234→        <Link href="/vehicles" className="btn btn-ghost btn-sm mb-4">
   235→          ← Back to Vehicles
   236→        </Link>
   237→        <h1 className="text-3xl font-bold">Add New Vehicle</h1>
   238→        <p className="text-base-content/60 mt-2">
   239→          Add a vehicle directly to your stock
   240→        </p>
   241→      </div>
   242→
   243→      <form onSubmit={handleSubmit} className="max-w-4xl space-y-6">
   244→        {/* Vehicle Registration Lookup */}
   245→        <div className="card bg-base-200">
   246→          <div className="card-body">
   247→            <h2 className="card-title">Vehicle Registration</h2>
   248→            <div className="flex gap-4">
   249→              <div className="form-control flex-1 relative" ref={suggestionRef}>
   250→                <input
   251→                  type="text"
   252→                  name="vehicleReg"
   253→                  value={formData.vehicleReg}
   254→                  onChange={handleChange}
   255→                  onFocus={() => {
   256→                    if (vrmSuggestions.length > 0) setShowSuggestions(true);
   257→                  }}
   258→                  className="input input-bordered uppercase text-xl font-mono"
   259→                  placeholder="AB12 CDE"
   260→                  required
   261→                  autoComplete="off"
   262→                />
   263→
   264→                {/* VRM Suggestions Dropdown */}
   265→                {showSuggestions && vrmSuggestions.length > 0 && (
   266→                  <div className="absolute top-full left-0 right-0 mt-1 bg-base-100 border border-base-300 rounded-lg shadow-xl z-50 max-h-80 overflow-y-auto">
   267→                    <div className="p-2 text-xs text-base-content/60 border-b border-base-300 bg-base-200">
   268→                      Existing appraisals found - click to import data
   269→                    </div>
   270→                    {vrmSuggestions.map((suggestion) => (
   271→                      <button
   272→                        key={`${suggestion.type}-${suggestion.id}`}
   273→                        type="button"
   274→                        onClick={() => selectAppraisal(suggestion)}
   275→                        className="w-full p-3 text-left hover:bg-base-200 border-b border-base-300 last:border-b-0 transition-colors"
   276→                      >
   277→                        <div className="flex items-start justify-between gap-2">
   278→                          <div className="flex-1 min-w-0">
   279→                            <div className="flex items-center gap-2 mb-1">
   280→                              <span className="font-mono font-bold text-lg">
   281→                                {suggestion.vehicleReg}
   282→                              </span>
   283→                              <span className={`badge badge-sm ${suggestion.type === "buying" ? "badge-primary" : "badge-secondary"}`}>
   284→                                {suggestion.type === "buying" ? "Buying" : "Customer PX"}
   285→                              </span>
   286→                              {suggestion.issueCount > 0 && (
   287→                                <span className="badge badge-sm badge-warning">
   288→                                  {suggestion.issueCount} issue{suggestion.issueCount !== 1 ? "s" : ""}
   289→                                </span>
   290→                              )}
   291→                            </div>
   292→                            <div className="text-sm text-base-content/70">
   293→                              {suggestion.vehicleYear && `${suggestion.vehicleYear} `}
   294→                              {suggestion.vehicleMake} {suggestion.vehicleModel}
   295→                              {suggestion.colour && ` - ${suggestion.colour}`}
   296→                            </div>
   297→                            {suggestion.mileage && (
   298→                              <div className="text-xs text-base-content/50">
   299→                                {Number(suggestion.mileage).toLocaleString()} miles
   300→                              </div>
   301→                            )}
   302→                            {suggestion.type === "customer_px" && suggestion.customerName && (
   303→                              <div className="text-xs text-base-content/50 mt-1">
   304→                                From: {suggestion.customerName}
   305→                              </div>
   306→                            )}
   307→                          </div>
   308→                          <div className="text-right">
   309→                            {suggestion.proposedPurchasePrice && (
   310→                              <div className="text-sm font-semibold text-success">
   311→                                £{Number(suggestion.proposedPurchasePrice).toLocaleString()}
   312→                              </div>
   313→                            )}
   314→                            <div className="text-xs text-base-content/50">
   315→                              {new Date(suggestion.createdAt).toLocaleDateString()}
   316→                            </div>
   317→                          </div>
   318→                        </div>
   319→                      </button>
   320→                    ))}
   321→                  </div>
   322→                )}
   323→
   324→                {isSearching && (
   325→                  <div className="absolute right-3 top-1/2 -translate-y-1/2">
   326→                    <span className="loading loading-spinner loading-sm"></span>
   327→                  </div>
   328→                )}
   329→              </div>
   330→              <button
   331→                type="button"
   332→                className="btn btn-secondary"
   333→                onClick={handleDvlaLookup}
   334→                disabled={isLookingUp}
   335→              >
   336→                {isLookingUp ? (
   337→                  <span className="loading loading-spinner"></span>
   338→                ) : (
   339→                  "Lookup"
   340→                )}
   341→              </button>
   342→            </div>
   343→
   344→            {/* Selected appraisal info */}
   345→            {selectedAppraisal && (
   346→              <div className="alert alert-info mt-4">
   347→                <div className="flex-1">
   348→                  <span className="font-semibold">
   349→                    Imported from {selectedAppraisal.type === "buying" ? "buying appraisal" : "customer PX"}
   350→                  </span>
   351→                  {selectedAppraisal.issueCount > 0 && (
   352→                    <span className="ml-2 badge badge-warning">
   353→                      {selectedAppraisal.issueCount} recorded issue{selectedAppraisal.issueCount !== 1 ? "s" : ""}
   354→                    </span>
   355→                  )}
   356→                  <p className="text-sm mt-1">
   357→                    Issues and documents will be transferred when you save.
   358→                    {selectedAppraisal.type === "customer_px" && selectedAppraisal.customerName && (
   359→                      <> From customer: {selectedAppraisal.customerName}</>
   360→                    )}
   361→                  </p>
   362→                </div>
   363→                <button
   364→                  type="button"
   365→                  className="btn btn-ghost btn-sm"
   366→                  onClick={() => setSelectedAppraisal(null)}
   367→                >
   368→                  Clear
   369→                </button>
   370→              </div>
   371→            )}
   372→          </div>
   373→        </div>
   374→
   375→        {/* Vehicle Details */}
   376→        <div className="card bg-base-200">
   377→          <div className="card-body">
   378→            <h2 className="card-title">Vehicle Details</h2>
   379→
   380→            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
   381→              <div className="form-control">
   382→                <label className="label">
   383→                  <span className="label-text">Make *</span>
   384→                </label>
   385→                <input
   386→                  type="text"
   387→                  name="make"
   388→                  value={formData.make}
   389→                  onChange={handleChange}
   390→                  className="input input-bordered"
   391→                  placeholder="Ford"
   392→                  required
   393→                />
   394→              </div>
   395→              <div className="form-control">
   396→                <label className="label">
   397→                  <span className="label-text">Model *</span>
   398→                </label>
   399→                <input
   400→                  type="text"
   401→                  name="model"
   402→                  value={formData.model}
   403→                  onChange={handleChange}
   404→                  className="input input-bordered"
   405→                  placeholder="Focus"
   406→                  required
   407→                />
   408→              </div>
   409→            </div>
   410→
   411→            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
   412→              <div className="form-control">
   413→                <label className="label">
   414→                  <span className="label-text">Year</span>
   415→                </label>
   416→                <input
   417→                  type="number"
   418→                  name="year"
   419→                  value={formData.year}
   420→                  onChange={handleChange}
   421→                  className="input input-bordered"
   422→                  placeholder="2019"
   423→                />
   424→              </div>
   425→              <div className="form-control">
   426→                <label className="label">
   427→                  <span className="label-text">Colour</span>
   428→                </label>
   429→                <input
   430→                  type="text"
   431→                  name="colour"
   432→                  value={formData.colour}
   433→                  onChange={handleChange}
   434→                  className="input input-bordered"
   435→                  placeholder="Blue"
   436→                />
   437→              </div>
   438→              <div className="form-control">
   439→                <label className="label">
   440→                  <span className="label-text">Mileage</span>
   441→                </label>
   442→                <input
   443→                  type="number"
   444→                  name="mileage"
   445→                  value={formData.mileage}
   446→                  onChange={handleChange}
   447→                  className="input input-bordered"
   448→                  placeholder="50000"
   449→                />
   450→              </div>
   451→              <div className="form-control">
   452→                <label className="label">
   453→                  <span className="label-text">Doors</span>
   454→                </label>
   455→                <input
   456→                  type="number"
   457→                  name="doors"
   458→                  value={formData.doors}
   459→                  onChange={handleChange}
   460→                  className="input input-bordered"
   461→                  placeholder="5"
   462→                />
   463→              </div>
   464→            </div>
   465→
   466→            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
   467→              <div className="form-control">
   468→                <label className="label">
   469→                  <span className="label-text">Fuel Type</span>
   470→                </label>
   471→                <select
   472→                  name="fuelType"
   473→                  value={formData.fuelType}
   474→                  onChange={handleChange}
   475→                  className="select select-bordered"
   476→                >
   477→                  <option value="">Select...</option>
   478→                  <option value="Petrol">Petrol</option>
   479→                  <option value="Diesel">Diesel</option>
   480→                  <option value="Hybrid">Hybrid</option>
   481→                  <option value="Electric">Electric</option>
   482→                </select>
   483→              </div>
   484→              <div className="form-control">
   485→                <label className="label">
   486→                  <span className="label-text">Transmission</span>
   487→                </label>
   488→                <select
   489→                  name="transmission"
   490→                  value={formData.transmission}
   491→                  onChange={handleChange}
   492→                  className="select select-bordered"
   493→                >
   494→                  <option value="">Select...</option>
   495→                  <option value="Manual">Manual</option>
   496→                  <option value="Automatic">Automatic</option>
   497→                </select>
   498→              </div>
   499→              <div className="form-control">
   500→                <label className="label">
   501→                  <span className="label-text">Engine Size</span>
   502→                </label>
   503→                <input
   504→                  type="text"
   505→                  name="engineSize"
   506→                  value={formData.engineSize}
   507→                  onChange={handleChange}
   508→                  className="input input-bordered"
   509→                  placeholder="1.5L"
   510→                />
   511→              </div>
   512→              <div className="form-control">
   513→                <label className="label">
   514→                  <span className="label-text">MOT Expiry</span>
   515→                </label>
   516→                <input
   517→                  type="date"
   518→                  name="motExpiryDate"
   519→                  value={formData.motExpiryDate ? formData.motExpiryDate.split("T")[0] : ""}
   520→                  onChange={handleChange}
   521→                  className="input input-bordered"
   522→                />
   523→              </div>
   524→            </div>
   525→          </div>
   526→        </div>
   527→
   528→        {/* Pricing */}
   529→        <div className="card bg-base-200">
   530→          <div className="card-body">
   531→            <h2 className="card-title">Pricing</h2>
   532→
   533→            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
   534→              <div className="form-control">
   535→                <label className="label">
   536→                  <span className="label-text">Purchase Price (£)</span>
   537→                </label>
   538→                <input
   539→                  type="number"
   540→                  name="purchasePrice"
   541→                  value={formData.purchasePrice}
   542→                  onChange={handleChange}
   543→                  className="input input-bordered"
   544→                  placeholder="5000"
   545→                />
   546→              </div>
   547→              <div className="form-control">
   548→                <label className="label">
   549→                  <span className="label-text">Sale Price (£)</span>
   550→                </label>
   551→                <input
   552→                  type="number"
   553→                  name="salePrice"
   554→                  value={formData.salePrice}
   555→                  onChange={handleChange}
   556→                  className="input input-bordered"
   557→                  placeholder="6500"
   558→                />
   559→              </div>
   560→            </div>
   561→
   562→            {formData.purchasePrice && formData.salePrice && (
   563→              <div className="alert alert-info mt-4">
   564→                <span>
   565→                  Potential Profit: £{(Number(formData.salePrice) - Number(formData.purchasePrice)).toLocaleString()}
   566→                </span>
   567→              </div>
   568→            )}
   569→          </div>
   570→        </div>
   571→
   572→        {/* Notes */}
   573→        <div className="card bg-base-200">
   574→          <div className="card-body">
   575→            <h2 className="card-title">Notes</h2>
   576→            <div className="form-control">
   577→              <textarea
   578→                name="notes"
   579→                value={formData.notes}
   580→                onChange={handleChange}
   581→                className="textarea textarea-bordered h-32"
   582→                placeholder="Any additional notes about this vehicle..."
   583→              ></textarea>
   584→            </div>
   585→          </div>
   586→        </div>
   587→
   588→        {/* Actions */}
   589→        <div className="flex gap-4">
   590→          <Link href="/vehicles" className="btn btn-ghost">
   591→            Cancel
   592→          </Link>
   593→          <button
   594→            type="submit"
   595→            className="btn btn-primary"
   596→            disabled={isLoading}
   597→          >
   598→            {isLoading ? (
   599→              <>
   600→                <span className="loading loading-spinner"></span>
   601→                Saving...
   602→              </>
   603→            ) : (
   604→              "Add Vehicle"
   605→            )}
   606→          </button>
   607→        </div>
   608→      </form>
   609→    </DashboardLayout>
   610→  );
   611→}
   612→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
