     1→import { useState, useEffect } from "react";
     2→import { toast } from "react-hot-toast";
     3→
     4→// Helper for relative time display
     5→const relativeTime = (date) => {
     6→  if (!date) return "";
     7→  const days = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60 * 60 * 24));
     8→  if (days === 0) {
     9→    const hours = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60 * 60));
    10→    if (hours === 0) {
    11→      const mins = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60));
    12→      return mins <= 1 ? "Just now" : `${mins}m ago`;
    13→    }
    14→    return `${hours}h ago`;
    15→  }
    16→  if (days === 1) return "Yesterday";
    17→  if (days < 7) return `${days}d ago`;
    18→  if (days < 30) return `${Math.floor(days / 7)}w ago`;
    19→  return `${Math.floor(days / 30)}mo ago`;
    20→};
    21→
    22→// Format date helper
    23→const formatDate = (date) => {
    24→  if (!date) return "";
    25→  return new Date(date).toLocaleDateString("en-GB", {
    26→    day: "numeric",
    27→    month: "short",
    28→    year: "numeric",
    29→  });
    30→};
    31→
    32→const STATUS_LABELS = {
    33→  in_stock: "In Prep",
    34→  in_prep: "Advertised",
    35→  live: "Sold In Progress",
    36→  reserved: "Completed",
    37→  delivered: "Delivered",
    38→};
    39→
    40→/**
    41→ * VehicleDrawer - A reusable component to display vehicle details in a drawer/modal
    42→ *
    43→ * Props:
    44→ * - vehicleId: The ID of the vehicle to display
    45→ * - isOpen: Whether the drawer is open
    46→ * - onClose: Function to call when closing the drawer
    47→ * - isStacked: If true, renders as a stacked drawer (overlays another drawer)
    48→ * - readOnly: If true, hides editing controls (default: true for warranty context)
    49→ */
    50→export default function VehicleDrawer({
    51→  vehicleId,
    52→  isOpen,
    53→  onClose,
    54→  isStacked = false,
    55→  readOnly = true,
    56→}) {
    57→  const [vehicle, setVehicle] = useState(null);
    58→  const [isLoading, setIsLoading] = useState(false);
    59→  const [activeTab, setActiveTab] = useState("overview");
    60→  const [expandedIssues, setExpandedIssues] = useState({});
    61→
    62→  useEffect(() => {
    63→    if (isOpen && vehicleId) {
    64→      fetchVehicle();
    65→    }
    66→  }, [isOpen, vehicleId]);
    67→
    68→  const fetchVehicle = async () => {
    69→    setIsLoading(true);
    70→    try {
    71→      const res = await fetch(`/api/vehicles/${vehicleId}`);
    72→      if (!res.ok) throw new Error("Failed to load vehicle");
    73→      const data = await res.json();
    74→      setVehicle(data);
    75→    } catch (error) {
    76→      toast.error("Failed to load vehicle details");
    77→      console.error(error);
    78→    } finally {
    79→      setIsLoading(false);
    80→    }
    81→  };
    82→
    83→  if (!isOpen) return null;
    84→
    85→  return (
    86→    <div className={`fixed inset-0 flex justify-end ${isStacked ? "z-[60]" : "z-50"}`}>
    87→      {/* Backdrop */}
    88→      <div
    89→        className={`absolute inset-0 ${isStacked ? "bg-black/30" : "bg-black/50"}`}
    90→        onClick={onClose}
    91→      />
    92→
    93→      {/* Drawer */}
    94→      <div
    95→        className={`relative bg-white h-full overflow-y-auto flex flex-col ${
    96→          isStacked ? "w-full max-w-2xl shadow-2xl" : "w-full max-w-3xl"
    97→        }`}
    98→      >
    99→        {isLoading ? (
   100→          <div className="flex items-center justify-center h-full">
   101→            <span className="loading loading-spinner loading-lg"></span>
   102→          </div>
   103→        ) : !vehicle ? (
   104→          <div className="flex flex-col items-center justify-center h-full">
   105→            <p className="text-base-content/60">Vehicle not found</p>
   106→            <button className="btn btn-ghost btn-sm mt-2" onClick={onClose}>
   107→              Close
   108→            </button>
   109→          </div>
   110→        ) : (
   111→          <>
   112→            {/* Header */}
   113→            <div className="sticky top-0 bg-white border-b border-slate-200 px-4 md:px-6 py-3 md:py-4 flex justify-between items-center z-10">
   114→              <div className="flex items-center gap-3">
   115→                <button
   116→                  className="btn btn-ghost btn-sm btn-circle"
   117→                  onClick={onClose}
   118→                  title="Close"
   119→                >
   120→                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   121→                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
   122→                  </svg>
   123→                </button>
   124→                <div>
   125→                  <h2 className="text-lg md:text-xl font-bold text-slate-900">
   126→                    {vehicle.year || ""} {vehicle.make} {vehicle.model}
   127→                  </h2>
   128→                  <p className="text-xs md:text-sm text-slate-500 font-mono mt-0.5">
   129→                    {vehicle.regCurrent}
   130→                  </p>
   131→                </div>
   132→              </div>
   133→              <button className="btn btn-ghost btn-sm" onClick={onClose}>
   134→                ✕
   135→              </button>
   136→            </div>
   137→
   138→            {/* Tabs */}
   139→            <div className="bg-base-100 border-b border-base-300 px-4">
   140→              <div className="tabs tabs-bordered">
   141→                <button
   142→                  className={`tab ${activeTab === "overview" ? "tab-active" : ""}`}
   143→                  onClick={() => setActiveTab("overview")}
   144→                >
   145→                  Overview
   146→                </button>
   147→                <button
   148→                  className={`tab ${activeTab === "checklist" ? "tab-active" : ""}`}
   149→                  onClick={() => setActiveTab("checklist")}
   150→                >
   151→                  Checklist {vehicle.tasks?.length > 0 && `(${vehicle.tasks.length})`}
   152→                </button>
   153→                <button
   154→                  className={`tab ${activeTab === "issues" ? "tab-active" : ""}`}
   155→                  onClick={() => setActiveTab("issues")}
   156→                >
   157→                  Issues {vehicle.issues?.length > 0 && `(${vehicle.issues.length})`}
   158→                </button>
   159→                <button
   160→                  className={`tab ${activeTab === "documents" ? "tab-active" : ""}`}
   161→                  onClick={() => setActiveTab("documents")}
   162→                >
   163→                  Documents {vehicle.documents?.length > 0 && `(${vehicle.documents.length})`}
   164→                </button>
   165→              </div>
   166→            </div>
   167→
   168→            {/* Content */}
   169→            <div className="p-4 md:p-6 space-y-4 md:space-y-6 flex-1">
   170→              {/* Overview Tab */}
   171→              {activeTab === "overview" && (
   172→                <div className="space-y-4">
   173→                  {/* Identity Section */}
   174→                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
   175→                    <h3 className="text-sm font-semibold text-slate-900 mb-3">Identity</h3>
   176→                    <div className="grid grid-cols-2 gap-3 text-sm">
   177→                      <div>
   178→                        <span className="text-slate-500">Registration:</span>
   179→                        <p className="font-mono font-semibold">{vehicle.regCurrent || "—"}</p>
   180→                      </div>
   181→                      <div>
   182→                        <span className="text-slate-500">VIN:</span>
   183→                        <p className="font-mono text-xs">{vehicle.vin || "—"}</p>
   184→                      </div>
   185→                    </div>
   186→                  </div>
   187→
   188→                  {/* Status Section */}
   189→                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
   190→                    <h3 className="text-sm font-semibold text-slate-900 mb-3">Status & Location</h3>
   191→                    <div className="grid grid-cols-2 gap-3 text-sm">
   192→                      <div>
   193→                        <span className="text-slate-500">Status:</span>
   194→                        <p className="font-medium">{STATUS_LABELS[vehicle.status] || vehicle.status}</p>
   195→                      </div>
   196→                      <div>
   197→                        <span className="text-slate-500">Location:</span>
   198→                        <p>{vehicle.locationId?.name || "On Site"}</p>
   199→                      </div>
   200→                      <div>
   201→                        <span className="text-slate-500">Vehicle Type:</span>
   202→                        <p>{vehicle.type || "Stock"}</p>
   203→                      </div>
   204→                      {(vehicle.type === "STOCK" || !vehicle.type) && (
   205→                        <div>
   206→                          <span className="text-slate-500">Sale Type:</span>
   207→                          <p>{vehicle.saleType || "Retail"}</p>
   208→                        </div>
   209→                      )}
   210→                    </div>
   211→                  </div>
   212→
   213→                  {/* Labels */}
   214→                  {vehicle.labels?.length > 0 && (
   215→                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
   216→                      <h3 className="text-sm font-semibold text-slate-900 mb-3">Labels</h3>
   217→                      <div className="flex flex-wrap gap-2">
   218→                        {vehicle.labels.map((label) => (
   219→                          <span
   220→                            key={label.id}
   221→                            className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold"
   222→                            style={{
   223→                              backgroundColor: `${label.colour}20`,
   224→                              color: label.colour,
   225→                            }}
   226→                          >
   227→                            <span className="w-2 h-2 rounded-full" style={{ backgroundColor: label.colour }}></span>
   228→                            {label.name}
   229→                          </span>
   230→                        ))}
   231→                      </div>
   232→                    </div>
   233→                  )}
   234→
   235→                  {/* Specs Section */}
   236→                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
   237→                    <h3 className="text-sm font-semibold text-slate-900 mb-3">Specifications</h3>
   238→                    <div className="grid grid-cols-2 gap-3 text-sm">
   239→                      <div>
   240→                        <span className="text-slate-500">Make:</span>
   241→                        <p className="font-medium">{vehicle.make || "—"}</p>
   242→                      </div>
   243→                      <div>
   244→                        <span className="text-slate-500">Model:</span>
   245→                        <p className="font-medium">{vehicle.model || "—"}</p>
   246→                      </div>
   247→                      <div>
   248→                        <span className="text-slate-500">Year:</span>
   249→                        <p>{vehicle.year || "—"}</p>
   250→                      </div>
   251→                      <div>
   252→                        <span className="text-slate-500">Mileage:</span>
   253→                        <p>{vehicle.mileageCurrent ? `${vehicle.mileageCurrent.toLocaleString()} miles` : "—"}</p>
   254→                      </div>
   255→                      <div>
   256→                        <span className="text-slate-500">Colour:</span>
   257→                        <p>{vehicle.colour || "—"}</p>
   258→                      </div>
   259→                      <div>
   260→                        <span className="text-slate-500">Fuel Type:</span>
   261→                        <p>{vehicle.fuelType || "—"}</p>
   262→                      </div>
   263→                      <div className="col-span-2">
   264→                        <span className="text-slate-500">MOT Expiry:</span>
   265→                        <p>{vehicle.motExpiryDate ? formatDate(vehicle.motExpiryDate) : "—"}</p>
   266→                      </div>
   267→                    </div>
   268→                  </div>
   269→
   270→                  {/* V5 Document */}
   271→                  {vehicle.v5Url && (
   272→                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
   273→                      <h3 className="text-sm font-semibold text-slate-900 mb-3">V5 Document</h3>
   274→                      <a
   275→                        href={vehicle.v5Url}
   276→                        target="_blank"
   277→                        rel="noopener noreferrer"
   278→                        className="btn btn-sm btn-outline w-full"
   279→                      >
   280→                        View V5 Document
   281→                      </a>
   282→                    </div>
   283→                  )}
   284→
   285→                  {/* Notes */}
   286→                  {vehicle.notes && (
   287→                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
   288→                      <h3 className="text-sm font-semibold text-slate-900 mb-2">Notes</h3>
   289→                      <p className="text-sm whitespace-pre-wrap text-slate-600">{vehicle.notes}</p>
   290→                    </div>
   291→                  )}
   292→                </div>
   293→              )}
   294→
   295→              {/* Checklist Tab */}
   296→              {activeTab === "checklist" && (
   297→                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
   298→                  <h3 className="text-sm font-semibold text-slate-900 mb-3">Prep Checklist</h3>
   299→                  {vehicle.tasks?.length > 0 ? (
   300→                    <div className="space-y-2">
   301→                      {vehicle.tasks.map((task) => (
   302→                        <div
   303→                          key={task.id}
   304→                          className="flex items-center gap-2 p-2 rounded bg-white border border-slate-100"
   305→                        >
   306→                          <span
   307→                            className={`badge badge-sm ${
   308→                              task.status === "done"
   309→                                ? "badge-success"
   310→                                : task.status === "in_progress"
   311→                                ? "badge-warning"
   312→                                : task.status === "not_required"
   313→                                ? "badge-ghost"
   314→                                : "badge-outline"
   315→                            }`}
   316→                          >
   317→                            {task.status === "done" && "Done"}
   318→                            {task.status === "in_progress" && "In Progress"}
   319→                            {task.status === "pending" && "Pending"}
   320→                            {task.status === "not_required" && "N/A"}
   321→                            {!task.status && "Pending"}
   322→                          </span>
   323→                          <span
   324→                            className={`flex-1 text-sm ${
   325→                              task.status === "done" ? "line-through text-slate-400" : ""
   326→                            }`}
   327→                          >
   328→                            {task.name}
   329→                          </span>
   330→                          {task.completedAt && (
   331→                            <span className="text-xs text-slate-400">
   332→                              {formatDate(task.completedAt)}
   333→                            </span>
   334→                          )}
   335→                        </div>
   336→                      ))}
   337→                    </div>
   338→                  ) : (
   339→                    <p className="text-sm text-slate-500 text-center py-4">No tasks</p>
   340→                  )}
   341→                </div>
   342→              )}
   343→
   344→              {/* Issues Tab */}
   345→              {activeTab === "issues" && (
   346→                <div className="space-y-3">
   347→                  {vehicle.issues?.length > 0 ? (
   348→                    vehicle.issues.map((issue) => (
   349→                      <div key={issue.id} className="bg-slate-50 border border-slate-200 rounded-lg p-4">
   350→                        {/* Header with badges and status */}
   351→                        <div className="flex justify-between items-start mb-2">
   352→                          <div className="flex gap-1 flex-wrap">
   353→                            <span className="badge badge-sm">{issue.category}</span>
   354→                            {issue.subcategory && (
   355→                              <span className="badge badge-sm badge-ghost">{issue.subcategory}</span>
   356→                            )}
   357→                          </div>
   358→                          <span
   359→                            className={`badge badge-sm ${
   360→                              issue.status === "Complete"
   361→                                ? "badge-success"
   362→                                : issue.status === "In Progress"
   363→                                ? "badge-warning"
   364→                                : issue.status === "Ordered"
   365→                                ? "badge-info"
   366→                                : "badge-error"
   367→                            }`}
   368→                          >
   369→                            {issue.status || "Outstanding"}
   370→                          </span>
   371→                        </div>
   372→
   373→                        {/* Issue details */}
   374→                        <p className="text-sm font-medium">{issue.description}</p>
   375→                        {issue.actionNeeded && (
   376→                          <p className="text-xs text-slate-500 mt-1">
   377→                            <strong>Action:</strong> {issue.actionNeeded}
   378→                          </p>
   379→                        )}
   380→                        {issue.notes && (
   381→                          <p className="text-xs text-slate-500 mt-1">
   382→                            <strong>Notes:</strong> {issue.notes}
   383→                          </p>
   384→                        )}
   385→
   386→                        {/* Photos */}
   387→                        {issue.photos?.length > 0 && (
   388→                          <div className="flex flex-wrap gap-2 mt-3">
   389→                            {issue.photos.map((photo, idx) => (
   390→                              <a
   391→                                key={idx}
   392→                                href={photo}
   393→                                target="_blank"
   394→                                rel="noopener noreferrer"
   395→                              >
   396→                                <img
   397→                                  src={photo}
   398→                                  alt={`Issue photo ${idx + 1}`}
   399→                                  className="w-16 h-16 object-cover rounded-lg hover:opacity-80 transition-opacity border border-slate-200"
   400→                                />
   401→                              </a>
   402→                            ))}
   403→                          </div>
   404→                        )}
   405→
   406→                        {/* Updates */}
   407→                        {issue.updates?.length > 0 && (
   408→                          <div className="mt-3">
   409→                            <button
   410→                              className="btn btn-ghost btn-xs w-full justify-between"
   411→                              onClick={() =>
   412→                                setExpandedIssues((prev) => ({
   413→                                  ...prev,
   414→                                  [issue.id]: !prev[issue.id],
   415→                                }))
   416→                              }
   417→                            >
   418→                              <span>
   419→                                {expandedIssues[issue.id] ? "Hide" : "Show"} Updates ({issue.updates.length})
   420→                              </span>
   421→                              <span>{expandedIssues[issue.id] ? "▲" : "▼"}</span>
   422→                            </button>
   423→
   424→                            {expandedIssues[issue.id] && (
   425→                              <div className="mt-2 space-y-2 pl-3 border-l-2 border-slate-200">
   426→                                {issue.updates.map((update, idx) => (
   427→                                  <div key={idx} className="text-xs">
   428→                                    <p className="font-medium text-slate-700">
   429→                                      {update.userName || "User"}
   430→                                    </p>
   431→                                    <p className="text-slate-600 mt-0.5">{update.content}</p>
   432→                                    <p className="text-slate-400 mt-0.5">
   433→                                      {formatDate(update.createdAt)}
   434→                                    </p>
   435→                                  </div>
   436→                                ))}
   437→                              </div>
   438→                            )}
   439→                          </div>
   440→                        )}
   441→                      </div>
   442→                    ))
   443→                  ) : (
   444→                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-8 text-center">
   445→                      <p className="text-sm text-slate-500">No issues recorded</p>
   446→                    </div>
   447→                  )}
   448→                </div>
   449→              )}
   450→
   451→              {/* Documents Tab */}
   452→              {activeTab === "documents" && (
   453→                <div className="space-y-3">
   454→                  {vehicle.documents?.length > 0 ? (
   455→                    vehicle.documents.map((doc) => (
   456→                      <div
   457→                        key={doc.id}
   458→                        className="bg-slate-50 border border-slate-200 rounded-lg p-4 flex justify-between items-center"
   459→                      >
   460→                        <div>
   461→                          <p className="text-sm font-medium">{doc.name}</p>
   462→                          <span className="badge badge-sm badge-ghost mt-1">
   463→                            {doc.type === "v5" && "V5"}
   464→                            {doc.type === "service_history" && "Service History"}
   465→                            {doc.type === "fault_codes" && "Fault Codes"}
   466→                            {doc.type === "other" && "Other"}
   467→                          </span>
   468→                        </div>
   469→                        <a
   470→                          href={doc.url}
   471→                          target="_blank"
   472→                          rel="noopener noreferrer"
   473→                          className="btn btn-ghost btn-sm"
   474→                        >
   475→                          View
   476→                        </a>
   477→                      </div>
   478→                    ))
   479→                  ) : (
   480→                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-8 text-center">
   481→                      <p className="text-sm text-slate-500">No documents uploaded</p>
   482→                    </div>
   483→                  )}
   484→                </div>
   485→              )}
   486→            </div>
   487→          </>
   488→        )}
   489→      </div>
   490→    </div>
   491→  );
   492→}
   493→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
