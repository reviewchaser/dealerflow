   500â†’  const markPartsReceived = async (taskId, orderId) => {
   501â†’    try {
   502â†’      await fetch(`/api/tasks/${taskId}`, {
   503â†’        method: "PUT",
   504â†’        headers: { "Content-Type": "application/json" },
   505â†’        body: JSON.stringify({
   506â†’          updatePartsOrder: {
   507â†’            orderId,
   508â†’            status: "RECEIVED",
   509â†’            receivedAt: new Date().toISOString(),
   510â†’          },
   511â†’        }),
   512â†’      });
   513â†’
   514â†’      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
   515â†’      const data = await res.json();
   516â†’      setSelectedVehicle(data);
   517â†’      fetchVehicles();
   518â†’      toast.success("Parts marked as received");
   519â†’    } catch (error) {
   520â†’      toast.error("Failed to update parts order");
   521â†’    }
   522â†’  };
   523â†’
   524â†’  // Helper to get supplier display name
   525â†’  const getSupplierDisplay = (order) => {
   526â†’    const labels = {
   527â†’      EURO_CAR_PARTS: "Euro Car Parts",
   528â†’      TPS: "TPS",
   529â†’      MAIN_DEALER: "Main Dealer",
   530â†’      LOCAL_FACTOR: "Local Factor",
   531â†’      ONLINE: "Online",
   532â†’      OTHER: order.supplierName || "Other",
   533â†’    };
   534â†’    return labels[order.supplierType] || order.supplierType;
   535â†’  };
   536â†’
   537â†’  const updateTaskName = async (taskId, newName) => {
   538â†’    if (!newName.trim()) {
   539â†’      toast.error("Task name cannot be empty");
   540â†’      return;
   541â†’    }
   542â†’    try {
   543â†’      await fetch(`/api/tasks/${taskId}`, {
   544â†’        method: "PUT",
   545â†’        headers: { "Content-Type": "application/json" },
   546â†’        body: JSON.stringify({ name: newName }),
   547â†’      });
   548â†’      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
   549â†’      const data = await res.json();
   550â†’      setSelectedVehicle(data);
   551â†’      fetchVehicles();
   552â†’      setEditingTaskId(null);
   553â†’      setEditingTaskName("");
   554â†’      toast.success("Task updated");
   555â†’    } catch (error) {
   556â†’      toast.error("Failed to update task");
   557â†’    }
   558â†’  };
   559â†’
   560â†’  const addTask = async () => {
   561â†’    if (!newTaskName.trim()) return toast.error("Task name is required");
   562â†’    try {
   563â†’      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/tasks`, {
   564â†’        method: "POST",
   565â†’        headers: { "Content-Type": "application/json" },
   566â†’        body: JSON.stringify({ name: newTaskName }),
   567â†’      });
   568â†’      if (!res.ok) {
   569â†’        const errorData = await res.json();
   570â†’        throw new Error(errorData.error || "Failed to add task");
   571â†’      }
   572â†’      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
   573â†’      setSelectedVehicle(updatedVehicle);
   574â†’      setNewTaskName("");
   575â†’      fetchVehicles();
   576â†’      toast.success("Task added");
   577â†’    } catch (error) {
   578â†’      console.error("Add task error:", error);
   579â†’      toast.error(error.message || "Failed to add task");
   580â†’    }
   581â†’  };
   582â†’
   583â†’  const deleteTask = async (taskId) => {
   584â†’    try {
   585â†’      await fetch(`/api/tasks/${taskId}`, { method: "DELETE" });
   586â†’      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
   587â†’      setSelectedVehicle(updatedVehicle);
   588â†’      fetchVehicles();
   589â†’      toast.success("Task removed");
   590â†’    } catch (error) {
   591â†’      toast.error("Failed to delete task");
   592â†’    }
   593â†’  };
   594â†’
   595â†’  // Issue functions
   596â†’  const addIssue = async (photoUrls = []) => {
   597â†’    if (!issueForm.category || !issueForm.subcategory || !issueForm.description) {
   598â†’      return toast.error("Category, subcategory, and description are required");
   599â†’    }
   600â†’    try {
   601â†’      const issueData = {
   602â†’        ...issueForm,
   603â†’        photos: [...(issueForm.photos || []), ...photoUrls],
   604â†’      };
   605â†’      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/issues`, {
   606â†’        method: "POST",
   607â†’        headers: { "Content-Type": "application/json" },
   608â†’        body: JSON.stringify(issueData),
   609â†’      });
   610â†’      if (!res.ok) {
   611â†’        const errorData = await res.json();
   612â†’        throw new Error(errorData.error || "Failed to add issue");
   613â†’      }
   614â†’      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
   615â†’      setSelectedVehicle(updatedVehicle);
   616â†’      fetchVehicles();
   617â†’      setShowAddIssueModal(false);
   618â†’      setIssueForm({
   619â†’        category: "",
   620â†’        subcategory: "",
   621â†’        description: "",
   622â†’        actionNeeded: "",
   623â†’        status: "outstanding",
   624â†’        notes: "",
   625â†’        photos: [],
   626â†’      });
   627â†’      toast.success("Issue added");
   628â†’    } catch (error) {
   629â†’      console.error("Add issue error:", error);
   630â†’      toast.error(error.message || "Failed to add issue");
   631â†’    }
   632â†’  };
   633â†’
   634â†’  const updateIssue = async (issueId, updates) => {
   635â†’    try {
   636â†’      const res = await fetch(`/api/issues/${issueId}`, {
   637â†’        method: "PUT",
   638â†’        headers: { "Content-Type": "application/json" },
   639â†’        body: JSON.stringify(updates),
   640â†’      });
   641â†’      if (!res.ok) throw new Error("Failed to update issue");
   642â†’      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
   643â†’      setSelectedVehicle(updatedVehicle);
   644â†’      fetchVehicles();
   645â†’      toast.success("Issue updated");
   646â†’    } catch (error) {
   647â†’      toast.error("Failed to update issue");
   648â†’    }
   649â†’  };
   650â†’
   651â†’  const deleteIssue = async (issueId) => {
   652â†’    try {
   653â†’      await fetch(`/api/issues/${issueId}`, { method: "DELETE" });
   654â†’      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
   655â†’      setSelectedVehicle(updatedVehicle);
   656â†’      fetchVehicles();
   657â†’      toast.success("Issue removed");
   658â†’    } catch (error) {
   659â†’      toast.error("Failed to delete issue");
   660â†’    }
   661â†’  };
   662â†’
   663â†’  const addIssueUpdate = async (issueId, content) => {
   664â†’    if (!content?.trim()) {
   665â†’      return toast.error("Update content cannot be empty");
   666â†’    }
   667â†’
   668â†’    try {
   669â†’      await fetch(`/api/issues/${issueId}`, {
   670â†’        method: "POST",
   671â†’        headers: { "Content-Type": "application/json" },
   672â†’        body: JSON.stringify({
   673â†’          content: content.trim(),
   674â†’          userName: "Current User" // TODO: Replace with actual user name from auth
   675â†’        }),
   676â†’      });
   677â†’
   678â†’      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
   679â†’      setSelectedVehicle(updatedVehicle);
   680â†’      fetchVehicles();
   681â†’      setIssueUpdateContent(prev => ({ ...prev, [issueId]: "" }));
   682â†’      toast.success("Update added");
   683â†’    } catch (error) {
   684â†’      toast.error("Failed to add update");
   685â†’    }
   686â†’  };
   687â†’
   688â†’  // Document functions
   689â†’  const uploadDocument = async (file, name, type) => {
   690â†’    if (!file) return;
   691â†’
   692â†’    try {
   693â†’      // First upload the file
   694â†’      const uploadFormData = new FormData();
   695â†’      uploadFormData.append("file", file);
   696â†’
   697â†’      const uploadRes = await fetch("/api/vehicles/upload", {
   698â†’        method: "POST",
   699â†’        body: uploadFormData,
   700â†’      });
   701â†’      if (!uploadRes.ok) throw new Error("File upload failed");
   702â†’      const uploadData = await uploadRes.json();
   703â†’
   704â†’      // Then create the document record with the URL
   705â†’      const docRes = await fetch(`/api/vehicles/${selectedVehicle.id}/documents`, {
   706â†’        method: "POST",
   707â†’        headers: { "Content-Type": "application/json" },
   708â†’        body: JSON.stringify({ name, type, url: uploadData.url }),
   709â†’      });
   710â†’      if (!docRes.ok) throw new Error("Document creation failed");
   711â†’
   712â†’      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
   713â†’      setSelectedVehicle(updatedVehicle);
   714â†’      fetchVehicles();
   715â†’      setShowAddDocumentModal(false);
   716â†’      setDocumentForm({ name: "", type: "other", file: null });
   717â†’      toast.success("Document uploaded");
   718â†’    } catch (error) {
   719â†’      console.error("Upload error:", error);
   720â†’      toast.error("Failed to upload document");
   721â†’    }
   722â†’  };
   723â†’
   724â†’  const deleteDocument = async (documentId) => {
   725â†’    try {
   726â†’      await fetch(`/api/documents/${documentId}`, { method: "DELETE" });
   727â†’      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
   728â†’      setSelectedVehicle(updatedVehicle);
   729â†’      fetchVehicles();
   730â†’      toast.success("Document removed");
   731â†’    } catch (error) {
   732â†’      toast.error("Failed to delete document");
   733â†’    }
   734â†’  };
   735â†’
   736â†’  const handleDragStart = (e, vehicle) => {
   737â†’    setDraggedCard(vehicle);
   738â†’    setDragPosition({ x: e.clientX, y: e.clientY });
   739â†’    e.dataTransfer.effectAllowed = "move";
   740â†’    // Create invisible drag image (we'll render our own preview)
   741â†’    const emptyImg = new Image();
   742â†’    emptyImg.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
   743â†’    e.dataTransfer.setDragImage(emptyImg, 0, 0);
   744â†’  };
   745â†’
   746â†’  const handleDrag = (e) => {
   747â†’    if (e.clientX !== 0 && e.clientY !== 0) {
   748â†’      setDragPosition({ x: e.clientX, y: e.clientY });
   749â†’    }
   750â†’  };
   751â†’
   752â†’  const handleDragOver = (e) => {
   753â†’    e.preventDefault();
   754â†’    e.dataTransfer.dropEffect = "move";
   755â†’  };
   756â†’
   757â†’  const handleDragEnd = () => {
   758â†’    setDraggedCard(null);
   759â†’  };
   760â†’
   761â†’  const handleDrop = async (e, newStatus) => {
   762â†’    e.preventDefault();
   763â†’    if (!draggedCard || draggedCard.status === newStatus) {
   764â†’      setDraggedCard(null);
   765â†’      return;
   766â†’    }
   767â†’    const vehicleId = draggedCard.id || draggedCard._id;
   768â†’    await updateVehicleStatus(vehicleId, newStatus);
   769â†’    setDraggedCard(null);
   770â†’  };
   771â†’
   772â†’  const uploadV5 = async (file) => {
   773â†’    if (!file) return;
   774â†’
   775â†’    try {
   776â†’      // First upload the file
   777â†’      const formData = new FormData();
   778â†’      formData.append("file", file);
   779â†’
   780â†’      const uploadRes = await fetch("/api/vehicles/upload", {
   781â†’        method: "POST",
   782â†’        body: formData,
   783â†’      });
   784â†’      if (!uploadRes.ok) throw new Error("Upload failed");
   785â†’      const uploadData = await uploadRes.json();
   786â†’
   787â†’      // Then update the vehicle with the V5 URL
   788â†’      await fetch(`/api/vehicles/${selectedVehicle.id}`, {
   789â†’        method: "PUT",
   790â†’        headers: { "Content-Type": "application/json" },
   791â†’        body: JSON.stringify({ v5Url: uploadData.url }),
   792â†’      });
   793â†’
   794â†’      const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
   795â†’      setSelectedVehicle(updated);
   796â†’      fetchVehicles();
   797â†’      toast.success("V5 uploaded");
   798â†’    } catch (error) {
   799â†’      console.error("V5 upload error:", error);
   800â†’      toast.error("Failed to upload V5");
   801â†’    }
   802â†’  };
   803â†’
   804â†’  const formatDate = (date) => {
   805â†’    if (!date) return "â€”";
   806â†’    return new Date(date).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
   807â†’  };
   808â†’
   809â†’  const toggleFilter = (filter) => {
   810â†’    setActiveFilters(prev =>
   811â†’      prev.includes(filter)
   812â†’        ? prev.filter(f => f !== filter)
   813â†’        : [...prev, filter]
   814â†’    );
   815â†’  };
   816â†’
   817â†’  const getFilteredVehicles = (vehicleList) => {
   818â†’    if (activeFilters.length === 0) return vehicleList;
   819â†’
   820â†’    return vehicleList.filter(vehicle => {
   821â†’      return activeFilters.every(filter => {
   822â†’        const tasks = vehicle.tasks || [];
   823â†’        const issues = vehicle.issues || [];
   824â†’        const activeIssues = issues.filter(i => {
   825â†’          const status = (i.status || "").toLowerCase();
   826â†’          return ["outstanding", "ordered", "in progress", "in_progress"].includes(status);
   827â†’        });
   828â†’
   829â†’        // Prep task filters
   830â†’        if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
   831â†’        if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
   832â†’        if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
   833â†’        if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");
   834â†’
   835â†’        // Issue filters
   836â†’        if (filter === "needs_paint") return activeIssues.some(i => {
   837â†’          const cat = (i.category || "").toLowerCase();
   838â†’          return cat === "bodywork" || cat === "cosmetic";
   839â†’        });
   840â†’        if (filter === "needs_mechanical") return activeIssues.some(i => {
   841â†’          const cat = (i.category || "").toLowerCase();
   842â†’          return cat === "mechanical";
   843â†’        });
   844â†’        if (filter === "needs_electrical") return activeIssues.some(i => {
   845â†’          const cat = (i.category || "").toLowerCase();
   846â†’          return cat === "electrical";
   847â†’        });
   848â†’
   849â†’        // Location filter
   850â†’        if (filter === "offsite") return vehicle.locationId != null;
   851â†’
   852â†’        // MOT filters
   853â†’        if (filter === "mot_due_soon") {
   854â†’          if (!vehicle.motExpiryDate) return false;
   855â†’          const expiry = new Date(vehicle.motExpiryDate);
   856â†’          const now = new Date();
   857â†’          const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
   858â†’          return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
   859â†’        }
   860â†’        if (filter === "mot_expired") {
   861â†’          if (!vehicle.motExpiryDate) return false;
   862â†’          const expiry = new Date(vehicle.motExpiryDate);
   863â†’          const now = new Date();
   864â†’          return expiry < now;
   865â†’        }
   866â†’
   867â†’        // Sale type filters
   868â†’        if (filter === "trade_only") return vehicle.saleType === "TRADE";
   869â†’        if (filter === "retail_only") return vehicle.saleType === "RETAIL" || !vehicle.saleType;
   870â†’
   871â†’        // Vehicle type filters
   872â†’        if (filter === "type_stock") return vehicle.type === "STOCK" || !vehicle.type;
   873â†’        if (filter === "type_courtesy") return vehicle.type === "COURTESY";
   874â†’        if (filter === "type_fleet") return vehicle.type === "FLEET_OTHER";
   875â†’
   876â†’        return true;
   877â†’      });
   878â†’    });
   879â†’  };
   880â†’
   881â†’  const getVehiclesByStatus = (status) => {
   882â†’    const statusVehicles = vehicles.filter(v => v.status === status);
   883â†’    const filtered = getFilteredVehicles(statusVehicles);
   884â†’
   885â†’    // Apply sorting based on columnSortOptions
   886â†’    const sortOption = columnSortOptions[status] || "oldest_first";
   887â†’
   888â†’    return [...filtered].sort((a, b) => {
   889â†’      const daysA = a.createdAt ? Math.floor((new Date() - new Date(a.createdAt)) / (1000 * 60 * 60 * 24)) : 0;
   890â†’      const daysB = b.createdAt ? Math.floor((new Date() - new Date(b.createdAt)) / (1000 * 60 * 60 * 24)) : 0;
   891â†’
   892â†’      switch (sortOption) {
   893â†’        case "oldest_first":
   894â†’          return daysB - daysA; // More days = older = first
   895â†’        case "newest_first":
   896â†’          return daysA - daysB; // Fewer days = newer = first
   897â†’        case "alphabetical":
   898â†’          const nameA = `${a.make || ""} ${a.model || ""}`.toLowerCase();
   899â†’          const nameB = `${b.make || ""} ${b.model || ""}`.toLowerCase();
   900â†’          return nameA.localeCompare(nameB);
   901â†’        default:
   902â†’          return daysB - daysA;
   903â†’      }
   904â†’    });
   905â†’  };
   906â†’
   907â†’  const getFilterCount = (filter) => {
   908â†’    const allFiltered = getFilteredVehicles(vehicles.filter(v => {
   909â†’      const tasks = v.tasks || [];
   910â†’      const issues = v.issues || [];
   911â†’      const activeIssues = issues.filter(i => {
   912â†’        const status = (i.status || "").toLowerCase();
   913â†’        return ["outstanding", "ordered", "in progress", "in_progress"].includes(status);
   914â†’      });
   915â†’
   916â†’      if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
   917â†’      if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
   918â†’      if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
   919â†’      if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");
   920â†’      if (filter === "needs_paint") return activeIssues.some(i => {
   921â†’        const cat = (i.category || "").toLowerCase();
   922â†’        return cat === "bodywork" || cat === "cosmetic";
   923â†’      });
   924â†’      if (filter === "needs_mechanical") return activeIssues.some(i => {
   925â†’        const cat = (i.category || "").toLowerCase();
   926â†’        return cat === "mechanical";
   927â†’      });
   928â†’      if (filter === "needs_electrical") return activeIssues.some(i => {
   929â†’        const cat = (i.category || "").toLowerCase();
   930â†’        return cat === "electrical";
   931â†’      });
   932â†’      if (filter === "offsite") return v.locationId != null;
   933â†’      if (filter === "mot_due_soon") {
   934â†’        if (!v.motExpiryDate) return false;
   935â†’        const expiry = new Date(v.motExpiryDate);
   936â†’        const now = new Date();
   937â†’        const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
   938â†’        return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
   939â†’      }
   940â†’      if (filter === "mot_expired") {
   941â†’        if (!v.motExpiryDate) return false;
   942â†’        const expiry = new Date(v.motExpiryDate);
   943â†’        return expiry < new Date();
   944â†’      }
   945â†’      if (filter === "trade_only") return v.saleType === "TRADE";
   946â†’      if (filter === "retail_only") return v.saleType === "RETAIL" || !v.saleType;
   947â†’      if (filter === "type_stock") return v.type === "STOCK" || !v.type;
   948â†’      if (filter === "type_courtesy") return v.type === "COURTESY";
   949â†’      if (filter === "type_fleet") return v.type === "FLEET_OTHER";
   950â†’      return false;
   951â†’    }));
   952â†’    return allFiltered.length;
   953â†’  };
   954â†’
   955â†’  // VRM Search functions
   956â†’  const getVrmSearchResults = () => {
   957â†’    if (vrmSearch.length < 2) return [];
   958â†’    const searchTerm = vrmSearch.toUpperCase().replace(/\s/g, "");
   959â†’    return vehicles.filter(v => {
   960â†’      const reg = (v.regCurrent || "").toUpperCase().replace(/\s/g, "");
   961â†’      return reg.includes(searchTerm);
   962â†’    }).slice(0, 8); // Limit to 8 results
   963â†’  };
   964â†’
   965â†’  const handleVrmSelect = (vehicle) => {
   966â†’    // Close dropdown and clear search
   967â†’    setVrmSearch("");
   968â†’    setShowVrmDropdown(false);
   969â†’
   970â†’    // Find which column this vehicle is in and scroll to it
   971â†’    const columnIndex = COLUMNS.findIndex(col => col.key === vehicle.status);
   972â†’    if (columnIndex >= 0) {
   973â†’      // Scroll the column into view
   974â†’      const columnElements = document.querySelectorAll('[data-column-key]');
   975â†’      if (columnElements[columnIndex]) {
   976â†’        columnElements[columnIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
   977â†’      }
   978â†’    }
   979â†’
   980â†’    // Open the vehicle drawer with full details
   981â†’    openVehicleDrawer(vehicle);
   982â†’  };
   983â†’
   984â†’  const getStatusLabel = (statusKey) => {
   985â†’    const col = COLUMNS.find(c => c.key === statusKey);
   986â†’    return col ? col.label : statusKey;
   987â†’  };
   988â†’
   989â†’  const handlePrintVehicle = () => {
   990â†’    if (!selectedVehicle) return;
   991â†’
   992â†’    const vehicle = selectedVehicle;
   993â†’    const tasks = vehicle.tasks || [];
   994â†’    const issues = vehicle.issues || [];
   995â†’    const documents = vehicle.documents || [];
   996â†’    const completedTasks = tasks.filter(t => t.status === "done").length;
   997â†’    const daysInStock = vehicle.createdAt
   998â†’      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
   999â†’      : 0;
  1000â†’
  1001â†’    // Get status label from COLUMNS
  1002â†’    const statusColumn = COLUMNS.find(col => col.key === vehicle.status);
  1003â†’    const statusLabel = statusColumn ? statusColumn.label : vehicle.status;
  1004â†’
  1005â†’    // Generate HTML for print
  1006â†’    const printContent = `
  1007â†’<!DOCTYPE html>
  1008â†’<html>
  1009â†’<head>
  1010â†’  <title>${vehicle.year || ""} ${vehicle.make} ${vehicle.model} - ${vehicle.regCurrent}</title>
  1011â†’  <style>
  1012â†’    * { margin: 0; padding: 0; box-sizing: border-box; }
  1013â†’    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }
  1014â†’    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
  1015â†’    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
  1016â†’    .reg { font-size: 18px; font-family: monospace; color: #64748b; }
  1017â†’    .section { margin-bottom: 30px; }
  1018â†’    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
  1019â†’    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  1020â†’    .field { margin-bottom: 12px; }
  1021â†’    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
  1022â†’    .field-value { font-size: 14px; color: #1e293b; }
  1023â†’    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
  1024â†’    .badge-status { background: #e0e7ff; color: #4338ca; }
  1025â†’    .badge-days { background: ${daysInStock > 30 ? '#fef2f2' : '#f1f5f9'}; color: ${daysInStock > 30 ? '#dc2626' : '#475569'}; }
  1026â†’    .task-list { list-style: none; }
  1027â†’    .task-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
  1028â†’    .task-status { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
  1029â†’    .task-done { background: #dcfce7; color: #16a34a; }
  1030â†’    .task-pending { background: #fef3c7; color: #d97706; }
  1031â†’    .task-progress { background: #dbeafe; color: #2563eb; }
  1032â†’    .issue-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
  1033â†’    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; }
  1034â†’    .issue-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
  1035â†’    .issue-desc { font-size: 14px; color: #1e293b; }
  1036â†’    .doc-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
  1037â†’    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }
  1038â†’    @media print {
  1039â†’      body { padding: 20px; }
  1040â†’      .no-print { display: none; }
  1041â†’    }
  1042â†’  </style>
  1043â†’</head>
  1044â†’<body>
  1045â†’  <div class="header">
  1046â†’    <div class="title">${vehicle.year || ""} ${vehicle.make} ${vehicle.model}</div>
  1047â†’    <div class="reg">${vehicle.regCurrent}</div>
  1048â†’  </div>
  1049â†’
  1050â†’  <div class="section">
  1051â†’    <div class="section-title">Overview</div>
  1052â†’    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
  1053â†’      <span class="badge badge-status">${statusLabel}</span>
  1054â†’      <span class="badge badge-days">Days in Stock: ${daysInStock}</span>
  1055â†’      ${vehicle.locationId ? `<span class="badge" style="background:#eef2ff;color:#4f46e5;">ğŸ“ ${vehicle.locationId.name || 'Offsite'}</span>` : '<span class="badge" style="background:#f0fdf4;color:#16a34a;">ğŸ“ On Site</span>'}
  1056â†’    </div>
  1057â†’  </div>
  1058â†’
  1059â†’  <div class="section">
  1060â†’    <div class="section-title">Vehicle Details</div>
  1061â†’    <div class="grid">
  1062â†’      <div class="field">
  1063â†’        <div class="field-label">Registration</div>
  1064â†’        <div class="field-value">${vehicle.regCurrent || 'â€”'}</div>
  1065â†’      </div>
  1066â†’      <div class="field">
  1067â†’        <div class="field-label">VIN</div>
  1068â†’        <div class="field-value">${vehicle.vin || 'â€”'}</div>
  1069â†’      </div>
  1070â†’      <div class="field">
  1071â†’        <div class="field-label">Make</div>
  1072â†’        <div class="field-value">${vehicle.make || 'â€”'}</div>
  1073â†’      </div>
  1074â†’      <div class="field">
  1075â†’        <div class="field-label">Model</div>
  1076â†’        <div class="field-value">${vehicle.model || 'â€”'}</div>
  1077â†’      </div>
  1078â†’      <div class="field">
  1079â†’        <div class="field-label">Year</div>
  1080â†’        <div class="field-value">${vehicle.year || 'â€”'}</div>
  1081â†’      </div>
  1082â†’      <div class="field">
  1083â†’        <div class="field-label">Mileage</div>
  1084â†’        <div class="field-value">${vehicle.mileageCurrent ? vehicle.mileageCurrent.toLocaleString() + ' miles' : 'â€”'}</div>
  1085â†’      </div>
  1086â†’      <div class="field">
  1087â†’        <div class="field-label">Colour</div>
  1088â†’        <div class="field-value">${vehicle.colour || 'â€”'}</div>
  1089â†’      </div>
  1090â†’      <div class="field">
  1091â†’        <div class="field-label">Fuel Type</div>
  1092â†’        <div class="field-value">${vehicle.fuelType || 'â€”'}</div>
  1093â†’      </div>
  1094â†’      <div class="field">
  1095â†’        <div class="field-label">MOT Expiry</div>
  1096â†’        <div class="field-value">${vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : 'â€”'}</div>
  1097â†’      </div>
  1098â†’    </div>
  1099â†’  </div>
  1100â†’
  1101â†’  <div class="section">
  1102â†’    <div class="section-title">Prep Checklist (${completedTasks}/${tasks.length} complete)</div>
  1103â†’    ${tasks.length > 0 ? `
  1104â†’    <ul class="task-list">
  1105â†’      ${tasks.map(task => `
  1106â†’        <li class="task-item">
  1107â†’          <span class="task-status ${task.status === 'done' ? 'task-done' : task.status === 'in_progress' ? 'task-progress' : 'task-pending'}">
  1108â†’            ${task.status === 'done' ? 'âœ“' : task.status === 'in_progress' ? 'â†’' : 'â—‹'}
  1109â†’          </span>
  1110â†’          <span style="${task.status === 'done' ? 'text-decoration: line-through; color: #94a3b8;' : ''}">${task.name}</span>
  1111â†’          ${task.completedAt ? `<span style="font-size: 11px; color: #94a3b8; margin-left: auto;">${new Date(task.completedAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</span>` : ''}
  1112â†’        </li>
  1113â†’      `).join('')}
  1114â†’    </ul>
  1115â†’    ` : '<p style="color: #94a3b8; font-size: 14px;">No tasks</p>'}
  1116â†’  </div>
  1117â†’
  1118â†’  <div class="section">
  1119â†’    <div class="section-title">Issues (${issues.length})</div>
  1120â†’    ${issues.length > 0 ? issues.map(issue => `
  1121â†’      <div class="issue-card">
  1122â†’        <div class="issue-header">
  1123â†’          <span class="issue-badge">${issue.category}</span>
  1124â†’          ${issue.subcategory ? `<span class="issue-badge">${issue.subcategory}</span>` : ''}
  1125â†’          <span class="issue-badge" style="margin-left: auto;">${issue.status || 'Outstanding'}</span>
  1126â†’        </div>
  1127â†’        <div class="issue-desc">${issue.description}</div>
  1128â†’        ${issue.actionNeeded ? `<div style="font-size: 12px; color: #64748b; margin-top: 6px;">Action: ${issue.actionNeeded}</div>` : ''}
  1129â†’      </div>
  1130â†’    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No issues recorded</p>'}
  1131â†’  </div>
  1132â†’
  1133â†’  <div class="section">
  1134â†’    <div class="section-title">Documents (${documents.length})</div>
  1135â†’    ${documents.length > 0 ? documents.map(doc => `
  1136â†’      <div class="doc-item">
  1137â†’        <span style="font-weight: 500;">${doc.name}</span>
  1138â†’        <span style="font-size: 12px; color: #94a3b8; margin-left: 8px;">(${doc.type.replace(/_/g, ' ')})</span>
  1139â†’      </div>
  1140â†’    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No documents uploaded</p>'}
  1141â†’    ${vehicle.v5Url ? '<div class="doc-item"><span style="font-weight: 500;">V5 Document</span> <span style="font-size: 12px; color: #16a34a;">âœ“ Uploaded</span></div>' : ''}
  1142â†’  </div>
  1143â†’
  1144â†’  ${vehicle.notes ? `
  1145â†’  <div class="section">
  1146â†’    <div class="section-title">Notes</div>
  1147â†’    <p style="font-size: 14px; white-space: pre-wrap;">${vehicle.notes}</p>
  1148â†’  </div>
  1149â†’  ` : ''}
  1150â†’
  1151â†’  <div class="footer">
  1152â†’    Printed from DealerFlow on ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
  1153â†’  </div>
  1154â†’</body>
  1155â†’</html>
  1156â†’    `;
  1157â†’
  1158â†’    // Open in new tab
  1159â†’    const printWindow = window.open('', '_blank');
  1160â†’    printWindow.document.write(printContent);
  1161â†’    printWindow.document.close();
  1162â†’  };
  1163â†’
  1164â†’  // Share utility with fallback chain: Web Share API â†’ Clipboard â†’ Manual modal
  1165â†’  // SSR-safe: only runs client-side, with guards for browser API availability
  1166â†’  const shareWithFallback = async (url, title, text) => {
  1167â†’    // Guard against SSR - this should only run client-side
  1168â†’    if (typeof window === "undefined" || typeof navigator === "undefined") {
  1169â†’      return false;
  1170â†’    }
  1171â†’
  1172â†’    // 1. Try Web Share API (native sharing on mobile/supported browsers)
  1173â†’    if (typeof navigator.share === "function") {
  1174â†’      try {
  1175â†’        await navigator.share({ title, text, url });
  1176â†’        return true;
  1177â†’      } catch (error) {
  1178â†’        // User cancelled or share failed - continue to fallback
  1179â†’        if (error.name !== "AbortError") {
  1180â†’          console.log("Web Share API failed, trying clipboard fallback");
  1181â†’        }
  1182â†’      }
  1183â†’    }
  1184â†’
  1185â†’    // 2. Try Clipboard API
  1186â†’    if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
  1187â†’      try {
  1188â†’        await navigator.clipboard.writeText(url);
  1189â†’        toast.success("Link copied to clipboard!");
  1190â†’        return true;
  1191â†’      } catch (error) {
  1192â†’        console.log("Clipboard API failed, showing manual modal");
  1193â†’      }
  1194â†’    }
  1195â†’
  1196â†’    // 3. Fallback to manual modal
  1197â†’    setManualShareUrl(url);
  1198â†’    setShowManualShareModal(true);
  1199â†’    return false;
  1200â†’  };
  1201â†’
  1202â†’  // Job sheet share handlers
  1203â†’  const handleGenerateJobSheet = async () => {
  1204â†’    if (!selectedVehicle) return;
  1205â†’    setIsGeneratingJobSheet(true);
  1206â†’    try {
  1207â†’      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/job-sheet`, {
  1208â†’        method: "POST",
  1209â†’        headers: { "Content-Type": "application/json" },
  1210â†’        body: JSON.stringify({ expiresInDays: 60 }),
  1211â†’      });
  1212â†’      if (!res.ok) throw new Error("Failed to generate share link");
  1213â†’      const data = await res.json();
  1214â†’      const fullUrl = `${window.location.origin}${data.shareUrl}`;
  1215â†’      setJobSheetLink({
  1216â†’        url: fullUrl,
  1217â†’        expiresAt: data.expiresAt,
  1218â†’      });
  1219â†’      setShowJobSheetModal(true);
  1220â†’    } catch (error) {
  1221â†’      toast.error(error.message);
  1222â†’    } finally {
  1223â†’      setIsGeneratingJobSheet(false);
  1224â†’    }
  1225â†’  };
  1226â†’
  1227â†’  const copyJobSheetLink = async () => {
  1228â†’    if (jobSheetLink?.url) {
  1229â†’      await shareWithFallback(
  1230â†’        jobSheetLink.url,
  1231â†’        `Job Sheet - ${selectedVehicle?.regCurrent || "Vehicle"}`,
  1232â†’        `Job sheet for ${selectedVehicle?.regCurrent}: ${jobSheetLink.url}`
  1233â†’      );
  1234â†’    }
  1235â†’  };
  1236â†’
  1237â†’  const shareViaWhatsApp = () => {
  1238â†’    if (typeof window === "undefined") return;
  1239â†’    if (jobSheetLink?.url) {
  1240â†’      const text = `Job sheet for ${selectedVehicle?.regCurrent || "Vehicle"}: ${jobSheetLink.url}`;
  1241â†’      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
  1242â†’    }
  1243â†’  };
  1244â†’
  1245â†’  // Prep summary share handlers
  1246â†’  const handleGeneratePrepSummary = async () => {
  1247â†’    if (!selectedVehicle) return;
  1248â†’    setIsGeneratingPrepSummary(true);
  1249â†’    try {
  1250â†’      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/prep-summary`, {
  1251â†’        method: "POST",
  1252â†’        headers: { "Content-Type": "application/json" },
  1253â†’        body: JSON.stringify({ expiresInDays: 60 }),
  1254â†’      });
  1255â†’      if (!res.ok) throw new Error("Failed to generate share link");
  1256â†’      const data = await res.json();
  1257â†’      const fullUrl = `${window.location.origin}${data.shareUrl}`;
  1258â†’      setPrepSummaryLink({
  1259â†’        url: fullUrl,
  1260â†’        expiresAt: data.expiresAt,
  1261â†’      });
  1262â†’      setShowPrepSummaryModal(true);
  1263â†’    } catch (error) {
  1264â†’      toast.error(error.message);
  1265â†’    } finally {
  1266â†’      setIsGeneratingPrepSummary(false);
  1267â†’    }
  1268â†’  };
  1269â†’
  1270â†’  const copyPrepSummaryLink = async () => {
  1271â†’    if (prepSummaryLink?.url) {
  1272â†’      await shareWithFallback(
  1273â†’        prepSummaryLink.url,
  1274â†’        `Prep Summary - ${selectedVehicle?.regCurrent || "Vehicle"}`,
  1275â†’        `Prep summary for ${selectedVehicle?.regCurrent}: ${prepSummaryLink.url}`
  1276â†’      );
  1277â†’    }
  1278â†’  };
  1279â†’
  1280â†’  const sharePrepSummaryViaWhatsApp = () => {
  1281â†’    if (typeof window === "undefined") return;
  1282â†’    if (prepSummaryLink?.url) {
  1283â†’      const text = `Prep summary for ${selectedVehicle?.regCurrent || "Vehicle"}: ${prepSummaryLink.url}`;
  1284â†’      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
  1285â†’    }
  1286â†’  };
  1287â†’
  1288â†’  const getMOTStatus = (motExpiryDate) => {
  1289â†’    if (!motExpiryDate) {
  1290â†’      return { type: "unknown", label: "Unknown", days: null, class: "bg-slate-100 text-slate-500 border border-slate-200" };
  1291â†’    }
  1292â†’    const expiry = new Date(motExpiryDate);
  1293â†’    const now = new Date();
  1294â†’    const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
  1295â†’
  1296â†’    if (daysUntilExpiry < 0) {
  1297â†’      const daysOverdue = Math.abs(daysUntilExpiry);
  1298â†’      return { type: "expired", label: `Expired ${daysOverdue}d`, days: daysOverdue, class: "bg-red-50 text-red-700 border border-red-200" };
  1299â†’    }

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
