     1â†’import { useEffect, useState } from "react";
     2â†’import { useRouter } from "next/router";
     3â†’import Head from "next/head";
     4â†’import Link from "next/link";
     5â†’import DashboardLayout from "@/components/DashboardLayout";
     6â†’import { toast } from "react-hot-toast";
     7â†’import { Card, CardHeader, CardContent } from "@/components/ui/Card";
     8â†’import { KeyValue, KeyValueGrid } from "@/components/ui/KeyValue";
     9â†’import { Badge, StatusBadge } from "@/components/ui/Badge";
    10â†’import { PhotoGallery } from "@/components/ui/PhotoGallery";
    11â†’
    12â†’// Categories must match CustomerPXIssue model schema (lowercase)
    13â†’const ISSUE_CATEGORIES = ["mechanical", "electrical", "bodywork", "interior", "tyres", "mot", "service", "fault_codes", "other"];
    14â†’const ISSUE_SUBCATEGORIES = {
    15â†’  mechanical: ["Engine", "Transmission", "Suspension", "Brakes", "Exhaust", "Other"],
    16â†’  electrical: ["Battery", "Lights", "Starter Motor", "Alternator", "Sensors", "Other"],
    17â†’  bodywork: ["Panel Damage", "Scratches", "Dents", "Bumper", "Windscreen", "Other"],
    18â†’  interior: ["Seats", "Dashboard", "Trim", "Carpet", "Controls", "Other"],
    19â†’  tyres: ["Tread Depth", "Puncture", "Alloys", "Alignment", "Other"],
    20â†’  mot: ["Advisory", "Failed Item", "Due Soon", "Other"],
    21â†’  service: ["Oil Change", "Filters", "Fluids", "Timing Belt", "Other"],
    22â†’  fault_codes: ["Engine", "Transmission", "ABS", "Airbag", "Emissions", "Other"],
    23â†’  other: ["General", "Misc"],
    24â†’};
    25â†’const CATEGORY_LABELS = {
    26â†’  mechanical: "Mechanical",
    27â†’  electrical: "Electrical",
    28â†’  bodywork: "Bodywork",
    29â†’  interior: "Interior",
    30â†’  tyres: "Tyres",
    31â†’  mot: "MOT",
    32â†’  service: "Service",
    33â†’  fault_codes: "Fault Codes",
    34â†’  other: "Other",
    35â†’};
    36â†’
    37â†’export default function CustomerPXAppraisalDetail() {
    38â†’  const router = useRouter();
    39â†’  const { id } = router.query;
    40â†’  const [appraisal, setAppraisal] = useState(null);
    41â†’  const [issues, setIssues] = useState([]);
    42â†’  const [isLoading, setIsLoading] = useState(true);
    43â†’  const [isConverting, setIsConverting] = useState(false);
    44â†’
    45â†’  // Issue modal state
    46â†’  const [showIssueModal, setShowIssueModal] = useState(false);
    47â†’  const [issueForm, setIssueForm] = useState({
    48â†’    category: "mechanical",
    49â†’    subcategory: "Engine",
    50â†’    description: "",
    51â†’    actionNeeded: "",
    52â†’    estimatedCost: "",
    53â†’    notes: "",
    54â†’  });
    55â†’  const [photoFiles, setPhotoFiles] = useState([]);
    56â†’  const [photoPreviews, setPhotoPreviews] = useState([]);
    57â†’  const [isUploadingPhotos, setIsUploadingPhotos] = useState(false);
    58â†’  const [isAddingIssue, setIsAddingIssue] = useState(false);
    59â†’
    60â†’  useEffect(() => {
    61â†’    if (id) {
    62â†’      fetchAppraisal();
    63â†’      fetchIssues();
    64â†’    }
    65â†’  }, [id]);
    66â†’
    67â†’  const fetchAppraisal = async () => {
    68â†’    try {
    69â†’      const res = await fetch(`/api/customer-px/${id}`);
    70â†’      const data = await res.json();
    71â†’      setAppraisal(data);
    72â†’    } catch (error) {
    73â†’      toast.error("Failed to load");
    74â†’    } finally {
    75â†’      setIsLoading(false);
    76â†’    }
    77â†’  };
    78â†’
    79â†’  const fetchIssues = async () => {
    80â†’    try {
    81â†’      const res = await fetch(`/api/customer-px/issues?customerPXAppraisalId=${id}`);
    82â†’      const data = await res.json();
    83â†’      setIssues(Array.isArray(data) ? data : []);
    84â†’    } catch (error) {
    85â†’      console.error("Failed to load issues:", error);
    86â†’      setIssues([]);
    87â†’    }
    88â†’  };
    89â†’
    90â†’  const handleDecision = async (decision) => {
    91â†’    try {
    92â†’      await fetch(`/api/customer-px/${id}`, {
    93â†’        method: "PUT",
    94â†’        headers: { "Content-Type": "application/json" },
    95â†’        body: JSON.stringify({ decision }),
    96â†’      });
    97â†’      toast.success(`Marked as ${decision}`);
    98â†’      fetchAppraisal();
    99â†’    } catch (error) {
   100â†’      toast.error("Failed to update");
   101â†’    }
   102â†’  };
   103â†’
   104â†’  const handleConvert = async () => {
   105â†’    setIsConverting(true);
   106â†’    try {
   107â†’      const res = await fetch(`/api/customer-px/${id}/convert`, {
   108â†’        method: "POST",
   109â†’        headers: { "Content-Type": "application/json" },
   110â†’        body: JSON.stringify({ initialStatus: "in_stock" }),
   111â†’      });
   112â†’      if (!res.ok) throw new Error("Failed to convert");
   113â†’      toast.success("Vehicle created!");
   114â†’      router.push("/sales-prep");
   115â†’    } catch (error) {
   116â†’      toast.error(error.message);
   117â†’    } finally {
   118â†’      setIsConverting(false);
   119â†’    }
   120â†’  };
   121â†’
   122â†’  const handlePhotoChange = (e) => {
   123â†’    const files = Array.from(e.target.files);
   124â†’    setPhotoFiles(prev => [...prev, ...files]);
   125â†’
   126â†’    files.forEach(file => {
   127â†’      const reader = new FileReader();
   128â†’      reader.onloadend = () => {
   129â†’        setPhotoPreviews(prev => [...prev, reader.result]);
   130â†’      };
   131â†’      reader.readAsDataURL(file);
   132â†’    });
   133â†’  };
   134â†’
   135â†’  const removePhoto = (index) => {
   136â†’    setPhotoFiles(prev => prev.filter((_, i) => i !== index));
   137â†’    setPhotoPreviews(prev => prev.filter((_, i) => i !== index));
   138â†’  };
   139â†’
   140â†’  const uploadPhotos = async () => {
   141â†’    const uploadedUrls = [];
   142â†’    for (const file of photoFiles) {
   143â†’      const formData = new FormData();
   144â†’      formData.append("file", file);
   145â†’      try {
   146â†’        const res = await fetch("/api/vehicles/upload", {
   147â†’          method: "POST",
   148â†’          body: formData,
   149â†’        });
   150â†’        if (res.ok) {
   151â†’          const data = await res.json();
   152â†’          uploadedUrls.push(data.url);
   153â†’        }
   154â†’      } catch (error) {
   155â†’        console.error("Photo upload failed:", error);
   156â†’      }
   157â†’    }
   158â†’    return uploadedUrls;
   159â†’  };
   160â†’
   161â†’  const handleAddIssue = async () => {
   162â†’    if (!issueForm.description.trim()) {
   163â†’      toast.error("Description is required");
   164â†’      return;
   165â†’    }
   166â†’
   167â†’    setIsAddingIssue(true);
   168â†’
   169â†’    try {
   170â†’      let photoUrls = [];
   171â†’      if (photoFiles.length > 0) {
   172â†’        setIsUploadingPhotos(true);
   173â†’        photoUrls = await uploadPhotos();
   174â†’        setIsUploadingPhotos(false);
   175â†’      }
   176â†’
   177â†’      const res = await fetch("/api/customer-px/issues", {
   178â†’        method: "POST",
   179â†’        headers: { "Content-Type": "application/json" },
   180â†’        body: JSON.stringify({
   181â†’          customerPXAppraisalId: id,
   182â†’          ...issueForm,
   183â†’          estimatedCost: issueForm.estimatedCost ? parseFloat(issueForm.estimatedCost) : undefined,
   184â†’          photos: photoUrls,
   185â†’        }),
   186â†’      });
   187â†’
   188â†’      if (!res.ok) throw new Error("Failed to add issue");
   189â†’
   190â†’      toast.success("Issue added");
   191â†’      setShowIssueModal(false);
   192â†’      setIssueForm({
   193â†’        category: "mechanical",
   194â†’        subcategory: "Engine",
   195â†’        description: "",
   196â†’        actionNeeded: "",
   197â†’        estimatedCost: "",
   198â†’        notes: "",
   199â†’      });
   200â†’      setPhotoFiles([]);
   201â†’      setPhotoPreviews([]);
   202â†’      fetchIssues();
   203â†’    } catch (error) {
   204â†’      toast.error(error.message);
   205â†’    } finally {
   206â†’      setIsAddingIssue(false);
   207â†’    }
   208â†’  };
   209â†’
   210â†’  const handleDeleteIssue = async (issueId) => {
   211â†’    if (!confirm("Delete this issue?")) return;
   212â†’
   213â†’    try {
   214â†’      await fetch(`/api/customer-px/issues/${issueId}`, { method: "DELETE" });
   215â†’      toast.success("Issue deleted");
   216â†’      fetchIssues();
   217â†’    } catch (error) {
   218â†’      toast.error("Failed to delete");
   219â†’    }
   220â†’  };
   221â†’
   222â†’  const totalEstimatedCost = issues.reduce((sum, issue) => sum + (issue.estimatedCost || 0), 0);
   223â†’
   224â†’  if (isLoading) {
   225â†’    return (
   226â†’      <DashboardLayout>
   227â†’        <div className="flex justify-center py-20">
   228â†’          <span className="loading loading-spinner loading-lg"></span>
   229â†’        </div>
   230â†’      </DashboardLayout>
   231â†’    );
   232â†’  }
   233â†’
   234â†’  if (!appraisal) {
   235â†’    return (
   236â†’      <DashboardLayout>
   237â†’        <div className="alert alert-error">Customer PX Appraisal not found</div>
   238â†’      </DashboardLayout>
   239â†’    );
   240â†’  }
   241â†’
   242â†’  return (
   243â†’    <DashboardLayout>
   244â†’      <Head><title>PX Appraisal {appraisal.vehicleReg} | DealerFlow</title></Head>
   245â†’
   246â†’      <div className="mb-8">
   247â†’        <Link href="/appraisals" className="btn btn-ghost btn-sm mb-4">â† Back</Link>
   248â†’        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
   249â†’          <div>
   250â†’            <div className="flex items-center gap-3">
   251â†’              <h1 className="text-3xl font-bold font-mono">{appraisal.vehicleReg}</h1>
   252â†’              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-200">Customer PX</span>
   253â†’            </div>
   254â†’            <p className="text-base-content/60 mt-2">
   255â†’              {appraisal.vehicleMake} {appraisal.vehicleModel} {appraisal.vehicleYear ? `(${appraisal.vehicleYear})` : ""}
   256â†’            </p>
   257â†’          </div>
   258â†’          <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold border ${
   259â†’            appraisal.decision === "converted" ? "bg-emerald-50 text-emerald-700 border-emerald-200" :
   260â†’            appraisal.decision === "declined" ? "bg-red-50 text-red-700 border-red-200" :
   261â†’            appraisal.decision === "reviewed" ? "bg-blue-50 text-blue-700 border-blue-200" : "bg-amber-50 text-amber-700 border-amber-200"
   262â†’          }`}>
   263â†’            {appraisal.decision === "pending" ? "New" :
   264â†’             appraisal.decision === "reviewed" ? "Reviewed" :
   265â†’             appraisal.decision === "converted" ? "Converted" :
   266â†’             appraisal.decision === "declined" ? "Declined" : appraisal.decision}
   267â†’          </span>
   268â†’        </div>
   269â†’      </div>
   270â†’
   271â†’      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
   272â†’        <div className="lg:col-span-2 space-y-6">
   273â†’          {/* Customer Details */}
   274â†’          <Card>
   275â†’            <CardHeader title="Customer Details" />
   276â†’            <CardContent>
   277â†’              <KeyValueGrid cols={3}>
   278â†’                <KeyValue label="Name" value={appraisal.customerName || appraisal.contactId?.name} />
   279â†’                <KeyValue label="Email" value={appraisal.customerEmail || appraisal.contactId?.email} />
   280â†’                <KeyValue label="Phone" value={appraisal.customerPhone || appraisal.contactId?.phone} />
   281â†’                {appraisal.interestedInVehicle && (
   282â†’                  <div className="md:col-span-3">
   283â†’                    <KeyValue label="Interested In Vehicle" value={appraisal.interestedInVehicle} />
   284â†’                  </div>
   285â†’                )}
   286â†’              </KeyValueGrid>
   287â†’            </CardContent>
   288â†’          </Card>
   289â†’
   290â†’          {/* Vehicle Details */}
   291â†’          <Card>
   292â†’            <CardHeader title="Vehicle Details" />
   293â†’            <CardContent>
   294â†’              <KeyValueGrid cols={2}>
   295â†’                <KeyValue label="Make" value={appraisal.vehicleMake} />
   296â†’                <KeyValue label="Model" value={appraisal.vehicleModel} />
   297â†’                <KeyValue label="Year" value={appraisal.vehicleYear} />
   298â†’                <KeyValue label="Mileage" value={appraisal.mileage ? `${appraisal.mileage.toLocaleString()} mi` : null} />
   299â†’                <KeyValue label="Colour" value={appraisal.colour} />
   300â†’                <KeyValue label="Fuel Type" value={appraisal.fuelType} />
   301â†’                {appraisal.conditionRating && (
   302â†’                  <KeyValue label="Condition" value={<Badge variant={
   303â†’                    appraisal.conditionRating === 'excellent' ? 'success' :
   304â†’                    appraisal.conditionRating === 'good' ? 'info' :
   305â†’                    appraisal.conditionRating === 'fair' ? 'warning' : 'danger'
   306â†’                  }>{appraisal.conditionRating}</Badge>} />
   307â†’                )}
   308â†’                {appraisal.outstandingFinanceAmount > 0 && (
   309â†’                  <KeyValue label="Outstanding Finance" value={<span className="text-red-600 font-bold">Â£{appraisal.outstandingFinanceAmount?.toLocaleString()}</span>} />
   310â†’                )}
   311â†’                {appraisal.proposedPurchasePrice > 0 && (
   312â†’                  <KeyValue label="Proposed Price" value={<span className="text-lg font-bold text-emerald-600">Â£{appraisal.proposedPurchasePrice?.toLocaleString()}</span>} size="lg" />
   313â†’                )}
   314â†’              </KeyValueGrid>
   315â†’            </CardContent>
   316â†’          </Card>
   317â†’
   318â†’          {/* Condition Notes */}
   319â†’          <Card>
   320â†’            <CardHeader title="Condition Notes" />
   321â†’            <CardContent>
   322â†’              <p className="whitespace-pre-wrap text-slate-700">{appraisal.conditionNotes || <span className="text-slate-400 italic">No notes recorded</span>}</p>
   323â†’            </CardContent>
   324â†’          </Card>
   325â†’
   326â†’          {/* Vehicle Photos Gallery */}
   327â†’          {appraisal.photos && (
   328â†’            (appraisal.photos.exterior?.length > 0 || appraisal.photos.interior?.length > 0 ||
   329â†’             appraisal.photos.dashboard || appraisal.photos.odometer) && (
   330â†’              <Card>
   331â†’                <CardHeader title="Vehicle Photos" icon="ğŸ“·" />
   332â†’                <CardContent>
   333â†’                  <PhotoGallery
   334â†’                    photos={[
   335â†’                      ...(appraisal.photos.exterior || []).map(url => ({ url, category: 'exterior' })),
   336â†’                      ...(appraisal.photos.interior || []).map(url => ({ url, category: 'interior' })),
   337â†’                      ...(appraisal.photos.dashboard ? [{ url: appraisal.photos.dashboard, category: 'dashboard', caption: 'Dashboard' }] : []),
   338â†’                      ...(appraisal.photos.odometer ? [{ url: appraisal.photos.odometer, category: 'odometer', caption: 'Odometer' }] : []),
   339â†’                    ]}
   340â†’                    groupByCategory
   341â†’                    showCount={false}
   342â†’                  />
   343â†’                </CardContent>
   344â†’              </Card>
   345â†’            )
   346â†’          )}
   347â†’
   348â†’          {/* Issues Section */}
   349â†’          <Card>
   350â†’            <CardHeader
   351â†’              title="Issues & Damage"
   352â†’              icon="âš ï¸"
   353â†’              subtitle={totalEstimatedCost > 0 ? `Total est. repair: Â£${totalEstimatedCost.toLocaleString()}` : undefined}
   354â†’              action={
   355â†’                <button
   356â†’                  className="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-lg bg-violet-600 text-white hover:bg-violet-700 transition-colors"
   357â†’                  onClick={() => setShowIssueModal(true)}
   358â†’                >
   359â†’                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   360â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
   361â†’                  </svg>
   362â†’                  Add Issue
   363â†’                </button>
   364â†’              }
   365â†’            />
   366â†’            <CardContent>
   367â†’              {issues.length === 0 ? (
   368â†’                <div className="text-center py-8">
   369â†’                  <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
   370â†’                    <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   371â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
   372â†’                    </svg>
   373â†’                  </div>
   374â†’                  <p className="text-slate-600 font-medium">No issues recorded</p>
   375â†’                  <p className="text-sm text-slate-400 mt-1">Click "Add Issue" to log damage, faults, or condition notes</p>
   376â†’                </div>
   377â†’              ) : (
   378â†’                <div className="space-y-3">
   379â†’                  {issues.map((issue) => (
   380â†’                    <div key={issue.id} className="bg-slate-50 rounded-xl border border-slate-200 p-4">
   381â†’                      <div className="flex items-start justify-between gap-2 mb-2">
   382â†’                        <div className="flex items-center gap-2 flex-wrap">
   383â†’                          <Badge variant={
   384â†’                            issue.category === 'mechanical' ? 'danger' :
   385â†’                            issue.category === 'electrical' ? 'warning' :
   386â†’                            issue.category === 'bodywork' ? 'info' :
   387â†’                            issue.category === 'fault_codes' ? 'danger' :
   388â†’                            issue.category === 'mot' ? 'secondary' : 'default'
   389â†’                          }>
   390â†’                            {CATEGORY_LABELS[issue.category] || issue.category}
   391â†’                          </Badge>
   392â†’                          <span className="font-semibold text-slate-800">{issue.subcategory}</span>
   393â†’                        </div>
   394â†’                        <button
   395â†’                          className="text-xs text-red-500 hover:text-red-700 hover:underline transition-colors"
   396â†’                          onClick={() => handleDeleteIssue(issue.id)}
   397â†’                        >
   398â†’                          Delete
   399â†’                        </button>
   400â†’                      </div>
   401â†’                      <p className="text-sm text-slate-700 mb-2">{issue.description}</p>
   402â†’                      {issue.actionNeeded && (
   403â†’                        <p className="text-xs text-slate-500 mb-1">
   404â†’                          <span className="font-medium text-slate-600">Action needed:</span> {issue.actionNeeded}
   405â†’                        </p>
   406â†’                      )}
   407â†’                      {issue.estimatedCost > 0 && (
   408â†’                        <p className="text-sm font-semibold text-red-600">
   409â†’                          Est. cost: Â£{issue.estimatedCost.toLocaleString()}
   410â†’                        </p>
   411â†’                      )}
   412â†’                      {/* Photos - use PhotoGallery component */}
   413â†’                      {issue.photos && issue.photos.length > 0 && (
   414â†’                        <div className="mt-3 pt-3 border-t border-slate-200">
   415â†’                          <PhotoGallery
   416â†’                            photos={issue.photos}
   417â†’                            thumbnailSize="sm"
   418â†’                            showCount={false}
   419â†’                          />
   420â†’                        </div>
   421â†’                      )}
   422â†’                      {/* Attachments format */}
   423â†’                      {issue.attachments && issue.attachments.length > 0 && (
   424â†’                        <div className="mt-3 pt-3 border-t border-slate-200">
   425â†’                          <PhotoGallery
   426â†’                            photos={issue.attachments.map(a => ({ url: a.url, caption: a.caption }))}
   427â†’                            thumbnailSize="sm"
   428â†’                            showCount={false}
   429â†’                          />
   430â†’                        </div>
   431â†’                      )}
   432â†’                    </div>
   433â†’                  ))}
   434â†’                </div>
   435â†’              )}
   436â†’            </CardContent>
   437â†’          </Card>
   438â†’
   439â†’          {/* Documents Section */}
   440â†’          {(appraisal.v5Url || appraisal.serviceHistoryUrl || (appraisal.otherDocuments && appraisal.otherDocuments.length > 0)) && (
   441â†’            <Card>
   442â†’              <CardHeader title="Documents" icon="ğŸ“„" />
   443â†’              <CardContent>
   444â†’                <div className="flex flex-wrap gap-2">
   445â†’                  {appraisal.v5Url && (
   446â†’                    <a
   447â†’                      href={appraisal.v5Url}
   448â†’                      target="_blank"
   449â†’                      rel="noopener noreferrer"
   450â†’                      className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 hover:border-slate-300 transition-colors"
   451â†’                    >
   452â†’                      <svg className="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   453â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   454â†’                      </svg>
   455â†’                      V5 Document
   456â†’                    </a>
   457â†’                  )}
   458â†’                  {appraisal.serviceHistoryUrl && (
   459â†’                    <a
   460â†’                      href={appraisal.serviceHistoryUrl}
   461â†’                      target="_blank"
   462â†’                      rel="noopener noreferrer"
   463â†’                      className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 hover:border-slate-300 transition-colors"
   464â†’                    >
   465â†’                      <svg className="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   466â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   467â†’                      </svg>
   468â†’                      Service History
   469â†’                    </a>
   470â†’                  )}
   471â†’                  {appraisal.otherDocuments?.map((doc, idx) => (
   472â†’                    <a
   473â†’                      key={idx}
   474â†’                      href={doc.url}
   475â†’                      target="_blank"
   476â†’                      rel="noopener noreferrer"
   477â†’                      className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 hover:border-slate-300 transition-colors"
   478â†’                    >
   479â†’                      <svg className="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   480â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   481â†’                      </svg>
   482â†’                      {doc.name || "Document"}
   483â†’                    </a>
   484â†’                  ))}
   485â†’                </div>
   486â†’              </CardContent>
   487â†’            </Card>
   488â†’          )}
   489â†’
   490â†’          {/* AI Hints */}
   491â†’          {appraisal.aiHintText && (
   492â†’            <Card variant="accent">
   493â†’              <CardHeader title="AI Suggestions" icon="ğŸ¤–" />
   494â†’              <CardContent>
   495â†’                <p className="whitespace-pre-wrap text-sm text-slate-700">{appraisal.aiHintText}</p>
   496â†’              </CardContent>
   497â†’            </Card>
   498â†’          )}
   499â†’        </div>
   500â†’
   501â†’        {/* Actions Sidebar */}
   502â†’        <div className="lg:col-span-1">
   503â†’          <Card className="sticky top-20">
   504â†’            <CardHeader title="Actions" />
   505â†’            <CardContent className="space-y-4">
   506â†’              {(appraisal.decision === "pending" || appraisal.decision === "reviewed") && !appraisal.vehicleId && (
   507â†’                <div className="space-y-3">
   508â†’                  <button
   509â†’                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-semibold rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50 transition-colors"
   510â†’                    onClick={handleConvert}
   511â†’                    disabled={isConverting}
   512â†’                  >
   513â†’                    {isConverting ? (
   514â†’                      <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
   515â†’                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
   516â†’                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
   517â†’                      </svg>
   518â†’                    ) : (
   519â†’                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   520â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   521â†’                      </svg>
   522â†’                    )}
   523â†’                    Convert to Stock
   524â†’                  </button>
   525â†’                  <button
   526â†’                    className="w-full px-4 py-2 text-sm font-medium rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 transition-colors"
   527â†’                    onClick={() => handleDecision("reviewed")}
   528â†’                  >
   529â†’                    Mark as Reviewed
   530â†’                  </button>
   531â†’                  <button
   532â†’                    className="w-full px-4 py-2 text-sm font-medium rounded-lg border border-red-200 text-red-600 hover:bg-red-50 transition-colors"
   533â†’                    onClick={() => handleDecision("declined")}
   534â†’                  >
   535â†’                    Decline
   536â†’                  </button>
   537â†’                  <p className="text-xs text-slate-500 text-center">Converting will create a vehicle and default prep tasks.</p>
   538â†’                </div>
   539â†’              )}
   540â†’
   541â†’              {appraisal.decision === "converted" || appraisal.vehicleId ? (
   542â†’                <div className="space-y-3">
   543â†’                  <div className="p-3 rounded-lg bg-emerald-50 border border-emerald-200 text-sm text-emerald-700 text-center">
   544â†’                    Vehicle added to stock
   545â†’                  </div>
   546â†’                  <Link
   547â†’                    href="/sales-prep"
   548â†’                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-semibold rounded-lg bg-violet-600 text-white hover:bg-violet-700 transition-colors"
   549â†’                  >
   550â†’                    View in Stock & Prep
   551â†’                  </Link>
   552â†’                </div>
   553â†’              ) : null}
   554â†’
   555â†’              {appraisal.decision === "declined" && (
   556â†’                <div className="space-y-3">
   557â†’                  <div className="p-3 rounded-lg bg-slate-100 border border-slate-200 text-sm text-slate-600 text-center">
   558â†’                    This appraisal was declined
   559â†’                  </div>
   560â†’                  <button
   561â†’                    className="w-full px-4 py-2 text-sm font-medium rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors"
   562â†’                    onClick={() => handleDecision("pending")}
   563â†’                  >
   564â†’                    Re-open
   565â†’                  </button>
   566â†’                </div>
   567â†’              )}
   568â†’
   569â†’              {/* Issues Summary */}
   570â†’              {issues.length > 0 && (
   571â†’                <div className="pt-4 border-t border-slate-200">
   572â†’                  <p className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Issues Summary</p>
   573â†’                  <p className="text-sm text-slate-700">{issues.length} issue{issues.length !== 1 ? "s" : ""} logged</p>
   574â†’                  {totalEstimatedCost > 0 && (
   575â†’                    <p className="text-sm font-semibold text-red-600">Â£{totalEstimatedCost.toLocaleString()} est. repairs</p>
   576â†’                  )}
   577â†’                </div>
   578â†’              )}
   579â†’
   580â†’              <div className="pt-4 border-t border-slate-200">
   581â†’                <button
   582â†’                  className="w-full px-4 py-2 text-sm font-medium rounded-lg text-red-500 hover:bg-red-50 transition-colors"
   583â†’                  onClick={async () => {
   584â†’                    if (confirm("Delete this appraisal?")) {
   585â†’                      await fetch(`/api/customer-px/${id}`, { method: "DELETE" });
   586â†’                      router.push("/appraisals");
   587â†’                    }
   588â†’                  }}
   589â†’                >
   590â†’                  Delete Appraisal
   591â†’                </button>
   592â†’              </div>
   593â†’            </CardContent>
   594â†’          </Card>
   595â†’        </div>
   596â†’      </div>
   597â†’
   598â†’      {/* Add Issue Modal */}
   599â†’      {showIssueModal && (
   600â†’        <div className="modal modal-open">
   601â†’          <div className="modal-box max-w-lg">
   602â†’            <h3 className="font-bold text-lg mb-4">Add Issue</h3>
   603â†’
   604â†’            <div className="space-y-4">
   605â†’              <div className="grid grid-cols-2 gap-4">
   606â†’                <div className="form-control">
   607â†’                  <label className="label"><span className="label-text">Category</span></label>
   608â†’                  <select
   609â†’                    className="select select-bordered w-full"
   610â†’                    value={issueForm.category}
   611â†’                    onChange={(e) => {
   612â†’                      const newCat = e.target.value;
   613â†’                      setIssueForm({
   614â†’                        ...issueForm,
   615â†’                        category: newCat,
   616â†’                        subcategory: ISSUE_SUBCATEGORIES[newCat][0],
   617â†’                      });
   618â†’                    }}
   619â†’                  >
   620â†’                    {ISSUE_CATEGORIES.map((cat) => (
   621â†’                      <option key={cat} value={cat}>{CATEGORY_LABELS[cat]}</option>
   622â†’                    ))}
   623â†’                  </select>
   624â†’                </div>
   625â†’                <div className="form-control">
   626â†’                  <label className="label"><span className="label-text">Subcategory</span></label>
   627â†’                  <select
   628â†’                    className="select select-bordered w-full"
   629â†’                    value={issueForm.subcategory}
   630â†’                    onChange={(e) => setIssueForm({ ...issueForm, subcategory: e.target.value })}
   631â†’                  >
   632â†’                    {ISSUE_SUBCATEGORIES[issueForm.category].map((sub) => (
   633â†’                      <option key={sub} value={sub}>{sub}</option>
   634â†’                    ))}
   635â†’                  </select>
   636â†’                </div>
   637â†’              </div>
   638â†’
   639â†’              <div className="form-control">
   640â†’                <label className="label"><span className="label-text">Description *</span></label>
   641â†’                <textarea
   642â†’                  className="textarea textarea-bordered"
   643â†’                  rows={3}
   644â†’                  placeholder="Describe the issue..."
   645â†’                  value={issueForm.description}
   646â†’                  onChange={(e) => setIssueForm({ ...issueForm, description: e.target.value })}
   647â†’                />
   648â†’              </div>
   649â†’
   650â†’              <div className="form-control">
   651â†’                <label className="label"><span className="label-text">Action Needed</span></label>
   652â†’                <input
   653â†’                  type="text"
   654â†’                  className="input input-bordered"
   655â†’                  placeholder="e.g., Replace bumper, repaint"
   656â†’                  value={issueForm.actionNeeded}
   657â†’                  onChange={(e) => setIssueForm({ ...issueForm, actionNeeded: e.target.value })}
   658â†’                />
   659â†’              </div>
   660â†’
   661â†’              <div className="form-control">
   662â†’                <label className="label"><span className="label-text">Estimated Repair Cost (Â£)</span></label>
   663â†’                <input
   664â†’                  type="number"
   665â†’                  className="input input-bordered"
   666â†’                  placeholder="0"
   667â†’                  value={issueForm.estimatedCost}
   668â†’                  onChange={(e) => setIssueForm({ ...issueForm, estimatedCost: e.target.value })}
   669â†’                />
   670â†’              </div>
   671â†’
   672â†’              {/* Photo Upload */}
   673â†’              <div className="form-control">
   674â†’                <label className="label"><span className="label-text">Photos</span></label>
   675â†’                <input
   676â†’                  type="file"
   677â†’                  accept="image/*"
   678â†’                  multiple
   679â†’                  className="file-input file-input-bordered w-full"
   680â†’                  onChange={handlePhotoChange}
   681â†’                />
   682â†’                {photoPreviews.length > 0 && (
   683â†’                  <div className="flex flex-wrap gap-2 mt-2">
   684â†’                    {photoPreviews.map((preview, idx) => (
   685â†’                      <div key={idx} className="relative">
   686â†’                        <img src={preview} alt={`Preview ${idx + 1}`} className="w-16 h-16 object-cover rounded-lg" />
   687â†’                        <button
   688â†’                          type="button"
   689â†’                          className="absolute -top-1 -right-1 btn btn-circle btn-xs btn-error"
   690â†’                          onClick={() => removePhoto(idx)}
   691â†’                        >
   692â†’                          Ã—
   693â†’                        </button>
   694â†’                      </div>
   695â†’                    ))}
   696â†’                  </div>
   697â†’                )}
   698â†’              </div>
   699â†’            </div>
   700â†’
   701â†’            <div className="modal-action">
   702â†’              <button
   703â†’                className="btn btn-ghost"
   704â†’                onClick={() => {
   705â†’                  setShowIssueModal(false);
   706â†’                  setPhotoFiles([]);
   707â†’                  setPhotoPreviews([]);
   708â†’                }}
   709â†’              >
   710â†’                Cancel
   711â†’              </button>
   712â†’              <button
   713â†’                className="btn btn-primary"
   714â†’                onClick={handleAddIssue}
   715â†’                disabled={isAddingIssue}
   716â†’              >
   717â†’                {isAddingIssue ? (
   718â†’                  <>
   719â†’                    <span className="loading loading-spinner loading-sm"></span>
   720â†’                    {isUploadingPhotos ? "Uploading..." : "Saving..."}
   721â†’                  </>
   722â†’                ) : (
   723â†’                  "Add Issue"
   724â†’                )}
   725â†’              </button>
   726â†’            </div>
   727â†’          </div>
   728â†’          <div className="modal-backdrop" onClick={() => setShowIssueModal(false)}></div>
   729â†’        </div>
   730â†’      )}
   731â†’
   732â†’    </DashboardLayout>
   733â†’  );
   734â†’}
   735â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
