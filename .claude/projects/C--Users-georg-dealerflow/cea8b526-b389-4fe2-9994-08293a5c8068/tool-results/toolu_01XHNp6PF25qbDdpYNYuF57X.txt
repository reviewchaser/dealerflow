     1â†’import { useEffect, useState } from "react";
     2â†’import { useRouter } from "next/router";
     3â†’import Head from "next/head";
     4â†’import Link from "next/link";
     5â†’import DashboardLayout from "@/components/DashboardLayout";
     6â†’import { toast } from "react-hot-toast";
     7â†’import { Card, CardHeader, CardContent } from "@/components/ui/Card";
     8â†’import { KeyValue, KeyValueGrid } from "@/components/ui/KeyValue";
     9â†’import { Badge } from "@/components/ui/Badge";
    10â†’import { PhotoGallery } from "@/components/ui/PhotoGallery";
    11â†’
    12â†’// Categories must match AppraisalIssue model schema (lowercase)
    13â†’const ISSUE_CATEGORIES = ["mechanical", "electrical", "bodywork", "interior", "tyres", "mot", "service", "fault_codes", "other"];
    14â†’const ISSUE_SUBCATEGORIES = {
    15â†’  mechanical: ["Engine", "Transmission", "Suspension", "Brakes", "Exhaust", "Other"],
    16â†’  electrical: ["Battery", "Lights", "Starter Motor", "Alternator", "Sensors", "Other"],
    17â†’  bodywork: ["Panel Damage", "Scratches", "Dents", "Bumper", "Windscreen", "Other"],
    18â†’  interior: ["Seats", "Dashboard", "Trim", "Carpet", "Controls", "Other"],
    19â†’  tyres: ["Tread Depth", "Puncture", "Alloys", "Alignment", "Other"],
    20â†’  mot: ["Advisory", "Failed Item", "Due Soon", "Other"],
    21â†’  service: ["Oil Change", "Filters", "Fluids", "Timing Belt", "Other"],
    22â†’  fault_codes: ["Engine", "Transmission", "ABS", "Airbag", "Emissions", "Other"],
    23â†’  other: ["General", "Misc"],
    24â†’};
    25â†’const CATEGORY_LABELS = {
    26â†’  mechanical: "Mechanical",
    27â†’  electrical: "Electrical",
    28â†’  bodywork: "Bodywork",
    29â†’  interior: "Interior",
    30â†’  tyres: "Tyres",
    31â†’  mot: "MOT",
    32â†’  service: "Service",
    33â†’  fault_codes: "Fault Codes",
    34â†’  other: "Other",
    35â†’};
    36â†’
    37â†’export default function AppraisalDetail() {
    38â†’  const router = useRouter();
    39â†’  const { id } = router.query;
    40â†’  const [appraisal, setAppraisal] = useState(null);
    41â†’  const [issues, setIssues] = useState([]);
    42â†’  const [isLoading, setIsLoading] = useState(true);
    43â†’  const [isConverting, setIsConverting] = useState(false);
    44â†’
    45â†’  // Issue modal state
    46â†’  const [showIssueModal, setShowIssueModal] = useState(false);
    47â†’  const [showShareModal, setShowShareModal] = useState(false);
    48â†’  const [shareLink, setShareLink] = useState(null);
    49â†’  const [isGeneratingShare, setIsGeneratingShare] = useState(false);
    50â†’  const [issueForm, setIssueForm] = useState({
    51â†’    category: "mechanical",
    52â†’    subcategory: "Engine",
    53â†’    description: "",
    54â†’    actionNeeded: "",
    55â†’    estimatedCost: "",
    56â†’    notes: "",
    57â†’  });
    58â†’  const [photoFiles, setPhotoFiles] = useState([]);
    59â†’  const [photoPreviews, setPhotoPreviews] = useState([]);
    60â†’  const [isUploadingPhotos, setIsUploadingPhotos] = useState(false);
    61â†’  const [isAddingIssue, setIsAddingIssue] = useState(false);
    62â†’
    63â†’  useEffect(() => {
    64â†’    if (id) {
    65â†’      fetchAppraisal();
    66â†’      fetchIssues();
    67â†’    }
    68â†’  }, [id]);
    69â†’
    70â†’  const fetchAppraisal = async () => {
    71â†’    try {
    72â†’      const res = await fetch(`/api/appraisals/${id}`);
    73â†’      const data = await res.json();
    74â†’      setAppraisal(data);
    75â†’    } catch (error) {
    76â†’      toast.error("Failed to load");
    77â†’    } finally {
    78â†’      setIsLoading(false);
    79â†’    }
    80â†’  };
    81â†’
    82â†’  const fetchIssues = async () => {
    83â†’    try {
    84â†’      const res = await fetch(`/api/appraisals/issues?appraisalId=${id}`);
    85â†’      const data = await res.json();
    86â†’      setIssues(Array.isArray(data) ? data : []);
    87â†’    } catch (error) {
    88â†’      console.error("Failed to load issues:", error);
    89â†’      setIssues([]);
    90â†’    }
    91â†’  };
    92â†’
    93â†’  const handleDecision = async (decision) => {
    94â†’    try {
    95â†’      await fetch(`/api/appraisals/${id}`, {
    96â†’        method: "PUT",
    97â†’        headers: { "Content-Type": "application/json" },
    98â†’        body: JSON.stringify({ decision }),
    99â†’      });
   100â†’      toast.success(`Marked as ${decision}`);
   101â†’      fetchAppraisal();
   102â†’    } catch (error) {
   103â†’      toast.error("Failed to update");
   104â†’    }
   105â†’  };
   106â†’
   107â†’  const handleConvert = async () => {
   108â†’    setIsConverting(true);
   109â†’    try {
   110â†’      const res = await fetch(`/api/appraisals/${id}/convert`, {
   111â†’        method: "POST",
   112â†’        headers: { "Content-Type": "application/json" },
   113â†’        body: JSON.stringify({ initialStatus: "in_stock" }),
   114â†’      });
   115â†’      if (!res.ok) throw new Error("Failed to convert");
   116â†’      toast.success("Vehicle created!");
   117â†’      router.push("/sales-prep");
   118â†’    } catch (error) {
   119â†’      toast.error(error.message);
   120â†’    } finally {
   121â†’      setIsConverting(false);
   122â†’    }
   123â†’  };
   124â†’
   125â†’  const handlePhotoChange = (e) => {
   126â†’    const files = Array.from(e.target.files);
   127â†’    setPhotoFiles(prev => [...prev, ...files]);
   128â†’
   129â†’    files.forEach(file => {
   130â†’      const reader = new FileReader();
   131â†’      reader.onloadend = () => {
   132â†’        setPhotoPreviews(prev => [...prev, reader.result]);
   133â†’      };
   134â†’      reader.readAsDataURL(file);
   135â†’    });
   136â†’  };
   137â†’
   138â†’  const removePhoto = (index) => {
   139â†’    setPhotoFiles(prev => prev.filter((_, i) => i !== index));
   140â†’    setPhotoPreviews(prev => prev.filter((_, i) => i !== index));
   141â†’  };
   142â†’
   143â†’  const uploadPhotos = async () => {
   144â†’    const uploadedUrls = [];
   145â†’    for (const file of photoFiles) {
   146â†’      const formData = new FormData();
   147â†’      formData.append("file", file);
   148â†’      try {
   149â†’        const res = await fetch("/api/vehicles/upload", {
   150â†’          method: "POST",
   151â†’          body: formData,
   152â†’        });
   153â†’        if (res.ok) {
   154â†’          const data = await res.json();
   155â†’          uploadedUrls.push(data.url);
   156â†’        }
   157â†’      } catch (error) {
   158â†’        console.error("Photo upload failed:", error);
   159â†’      }
   160â†’    }
   161â†’    return uploadedUrls;
   162â†’  };
   163â†’
   164â†’  const handleAddIssue = async () => {
   165â†’    if (!issueForm.description.trim()) {
   166â†’      toast.error("Description is required");
   167â†’      return;
   168â†’    }
   169â†’
   170â†’    setIsAddingIssue(true);
   171â†’
   172â†’    try {
   173â†’      let photoUrls = [];
   174â†’      if (photoFiles.length > 0) {
   175â†’        setIsUploadingPhotos(true);
   176â†’        photoUrls = await uploadPhotos();
   177â†’        setIsUploadingPhotos(false);
   178â†’      }
   179â†’
   180â†’      const res = await fetch("/api/appraisals/issues", {
   181â†’        method: "POST",
   182â†’        headers: { "Content-Type": "application/json" },
   183â†’        body: JSON.stringify({
   184â†’          appraisalId: id,
   185â†’          ...issueForm,
   186â†’          estimatedCost: issueForm.estimatedCost ? parseFloat(issueForm.estimatedCost) : undefined,
   187â†’          photos: photoUrls,
   188â†’        }),
   189â†’      });
   190â†’
   191â†’      if (!res.ok) throw new Error("Failed to add issue");
   192â†’
   193â†’      toast.success("Issue added");
   194â†’      setShowIssueModal(false);
   195â†’      setIssueForm({
   196â†’        category: "mechanical",
   197â†’        subcategory: "Engine",
   198â†’        description: "",
   199â†’        actionNeeded: "",
   200â†’        estimatedCost: "",
   201â†’        notes: "",
   202â†’      });
   203â†’      setPhotoFiles([]);
   204â†’      setPhotoPreviews([]);
   205â†’      fetchIssues();
   206â†’    } catch (error) {
   207â†’      toast.error(error.message);
   208â†’    } finally {
   209â†’      setIsAddingIssue(false);
   210â†’    }
   211â†’  };
   212â†’
   213â†’  const handleDeleteIssue = async (issueId) => {
   214â†’    if (!confirm("Delete this issue?")) return;
   215â†’
   216â†’    try {
   217â†’      await fetch(`/api/appraisals/issues/${issueId}`, { method: "DELETE" });
   218â†’      toast.success("Issue deleted");
   219â†’      fetchIssues();
   220â†’    } catch (error) {
   221â†’      toast.error("Failed to delete");
   222â†’    }
   223â†’  };
   224â†’
   225â†’  const totalEstimatedCost = issues.reduce((sum, issue) => sum + (issue.estimatedCost || 0), 0);
   226â†’
   227â†’  const handleGenerateShareLink = async () => {
   228â†’    setIsGeneratingShare(true);
   229â†’    try {
   230â†’      const res = await fetch(`/api/appraisals/${id}/share`, {
   231â†’        method: "POST",
   232â†’        headers: { "Content-Type": "application/json" },
   233â†’        body: JSON.stringify({ expiresInDays: 60 }),
   234â†’      });
   235â†’      if (!res.ok) throw new Error("Failed to generate share link");
   236â†’      const data = await res.json();
   237â†’      const fullUrl = `${window.location.origin}${data.shareUrl}`;
   238â†’      setShareLink({
   239â†’        url: fullUrl,
   240â†’        expiresAt: data.expiresAt,
   241â†’      });
   242â†’    } catch (error) {
   243â†’      toast.error(error.message);
   244â†’    } finally {
   245â†’      setIsGeneratingShare(false);
   246â†’    }
   247â†’  };
   248â†’
   249â†’  const handleRevokeShareLink = async () => {
   250â†’    if (!confirm("Revoke this share link? Anyone with the link will no longer be able to view this appraisal.")) return;
   251â†’    try {
   252â†’      const res = await fetch(`/api/appraisals/${id}/share`, { method: "DELETE" });
   253â†’      if (!res.ok) throw new Error("Failed to revoke");
   254â†’      setShareLink(null);
   255â†’      toast.success("Share link revoked");
   256â†’    } catch (error) {
   257â†’      toast.error(error.message);
   258â†’    }
   259â†’  };
   260â†’
   261â†’  const copyShareLink = () => {
   262â†’    if (shareLink?.url) {
   263â†’      navigator.clipboard.writeText(shareLink.url);
   264â†’      toast.success("Link copied to clipboard!");
   265â†’    }
   266â†’  };
   267â†’
   268â†’  const handlePrint = () => {
   269â†’    const printContent = `
   270â†’<!DOCTYPE html>
   271â†’<html>
   272â†’<head>
   273â†’  <title>Appraisal - ${appraisal.vehicleReg}</title>
   274â†’  <style>
   275â†’    * { margin: 0; padding: 0; box-sizing: border-box; }
   276â†’    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }
   277â†’    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
   278â†’    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
   279â†’    .reg { font-size: 24px; font-family: monospace; color: #1e293b; font-weight: bold; }
   280â†’    .subtitle { font-size: 16px; color: #64748b; margin-top: 8px; }
   281â†’    .section { margin-bottom: 30px; }
   282â†’    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
   283â†’    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
   284â†’    .field { margin-bottom: 12px; }
   285â†’    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
   286â†’    .field-value { font-size: 14px; color: #1e293b; }
   287â†’    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
   288â†’    .badge-warning { background: #fef3c7; color: #92400e; }
   289â†’    .badge-success { background: #dcfce7; color: #166534; }
   290â†’    .badge-error { background: #fee2e2; color: #991b1b; }
   291â†’    .notes { background: #f8fafc; padding: 16px; border-radius: 8px; white-space: pre-wrap; font-size: 14px; }
   292â†’    .issue { background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid #6366f1; }
   293â†’    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
   294â†’    .issue-badge { background: #e0e7ff; color: #4338ca; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
   295â†’    .issue-desc { font-size: 14px; margin-bottom: 4px; }
   296â†’    .issue-cost { color: #dc2626; font-weight: 600; font-size: 13px; }
   297â†’    .total-cost { font-size: 18px; color: #dc2626; font-weight: bold; margin-top: 16px; padding: 12px; background: #fef2f2; border-radius: 8px; }
   298â†’    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }
   299â†’    @media print { body { padding: 20px; } }
   300â†’  </style>
   301â†’</head>
   302â†’<body>
   303â†’  <div class="header">
   304â†’    <p class="reg">${appraisal.vehicleReg}</p>
   305â†’    <p class="subtitle">${appraisal.vehicleMake || ""} ${appraisal.vehicleModel || ""} ${appraisal.vehicleYear ? `(${appraisal.vehicleYear})` : ""}</p>
   306â†’    <span class="badge ${appraisal.decision === "converted" ? "badge-success" : appraisal.decision === "declined" ? "badge-error" : "badge-warning"}" style="margin-top: 12px;">
   307â†’      ${appraisal.decision === "pending" ? "New" : appraisal.decision === "reviewed" ? "Reviewed" : appraisal.decision === "converted" ? "Converted" : appraisal.decision === "declined" ? "Declined" : appraisal.decision}
   308â†’    </span>
   309â†’  </div>
   310â†’
   311â†’  <div class="section">
   312â†’    <h2 class="section-title">Vehicle Details</h2>
   313â†’    <div class="grid">
   314â†’      <div class="field"><div class="field-label">Make</div><div class="field-value">${appraisal.vehicleMake || "â€”"}</div></div>
   315â†’      <div class="field"><div class="field-label">Model</div><div class="field-value">${appraisal.vehicleModel || "â€”"}</div></div>
   316â†’      <div class="field"><div class="field-label">Year</div><div class="field-value">${appraisal.vehicleYear || "â€”"}</div></div>
   317â†’      <div class="field"><div class="field-label">Mileage</div><div class="field-value">${appraisal.mileage ? appraisal.mileage.toLocaleString() : "â€”"}</div></div>
   318â†’      <div class="field"><div class="field-label">Colour</div><div class="field-value">${appraisal.colour || "â€”"}</div></div>
   319â†’      <div class="field"><div class="field-label">Fuel Type</div><div class="field-value">${appraisal.fuelType || "â€”"}</div></div>
   320â†’      <div class="field"><div class="field-label">Proposed Price</div><div class="field-value" style="font-weight: bold; font-size: 18px;">${appraisal.proposedPurchasePrice ? "Â£" + appraisal.proposedPurchasePrice.toLocaleString() : "â€”"}</div></div>
   321â†’    </div>
   322â†’  </div>
   323â†’
   324â†’  ${appraisal.conditionNotes ? `
   325â†’  <div class="section">
   326â†’    <h2 class="section-title">Condition Notes</h2>
   327â†’    <div class="notes">${appraisal.conditionNotes}</div>
   328â†’  </div>
   329â†’  ` : ""}
   330â†’
   331â†’  ${issues.length > 0 ? `
   332â†’  <div class="section">
   333â†’    <h2 class="section-title">Issues & Damage (${issues.length})</h2>
   334â†’    ${issues.map(issue => `
   335â†’      <div class="issue">
   336â†’        <div class="issue-header">
   337â†’          <span class="issue-badge">${CATEGORY_LABELS[issue.category] || issue.category}</span>
   338â†’          <strong>${issue.subcategory}</strong>
   339â†’        </div>
   340â†’        <p class="issue-desc">${issue.description}</p>
   341â†’        ${issue.actionNeeded ? `<p style="font-size: 12px; color: #64748b;">Action: ${issue.actionNeeded}</p>` : ""}
   342â†’        ${issue.estimatedCost ? `<p class="issue-cost">Est. cost: Â£${issue.estimatedCost.toLocaleString()}</p>` : ""}
   343â†’      </div>
   344â†’    `).join("")}
   345â†’    ${totalEstimatedCost > 0 ? `<div class="total-cost">Total Estimated Repairs: Â£${totalEstimatedCost.toLocaleString()}</div>` : ""}
   346â†’  </div>
   347â†’  ` : ""}
   348â†’
   349â†’  ${appraisal.contactId ? `
   350â†’  <div class="section">
   351â†’    <h2 class="section-title">Seller Information</h2>
   352â†’    <div class="grid">
   353â†’      <div class="field"><div class="field-label">Name</div><div class="field-value">${appraisal.contactId.name || "â€”"}</div></div>
   354â†’      <div class="field"><div class="field-label">Phone</div><div class="field-value">${appraisal.contactId.phone || "â€”"}</div></div>
   355â†’      <div class="field"><div class="field-label">Email</div><div class="field-value">${appraisal.contactId.email || "â€”"}</div></div>
   356â†’    </div>
   357â†’  </div>
   358â†’  ` : ""}
   359â†’
   360â†’  <div class="footer">
   361â†’    <p>Appraisal created: ${new Date(appraisal.createdAt).toLocaleDateString()} ${new Date(appraisal.createdAt).toLocaleTimeString()}</p>
   362â†’    <p style="margin-top: 4px;">Printed from DealerFlow</p>
   363â†’  </div>
   364â†’</body>
   365â†’</html>`;
   366â†’
   367â†’    const printWindow = window.open("", "_blank");
   368â†’    printWindow.document.write(printContent);
   369â†’    printWindow.document.close();
   370â†’    printWindow.onload = function () {
   371â†’      printWindow.print();
   372â†’    };
   373â†’  };
   374â†’
   375â†’  if (isLoading) {
   376â†’    return (
   377â†’      <DashboardLayout>
   378â†’        <div className="flex justify-center py-20">
   379â†’          <span className="loading loading-spinner loading-lg"></span>
   380â†’        </div>
   381â†’      </DashboardLayout>
   382â†’    );
   383â†’  }
   384â†’
   385â†’  if (!appraisal) {
   386â†’    return (
   387â†’      <DashboardLayout>
   388â†’        <div className="alert alert-error">Appraisal not found</div>
   389â†’      </DashboardLayout>
   390â†’    );
   391â†’  }
   392â†’
   393â†’  return (
   394â†’    <DashboardLayout>
   395â†’      <Head><title>Appraisal {appraisal.vehicleReg} | DealerFlow</title></Head>
   396â†’
   397â†’      <div className="mb-8">
   398â†’        <div className="flex items-center gap-2 mb-4">
   399â†’          <Link href="/appraisals" className="btn btn-ghost btn-sm">â† Back</Link>
   400â†’          <button className="btn btn-ghost btn-sm" onClick={handlePrint}>
   401â†’            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   402â†’              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
   403â†’            </svg>
   404â†’            Print
   405â†’          </button>
   406â†’          <button className="btn btn-ghost btn-sm" onClick={() => setShowShareModal(true)}>
   407â†’            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   408â†’              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
   409â†’            </svg>
   410â†’            Share
   411â†’          </button>
   412â†’        </div>
   413â†’        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
   414â†’          <div>
   415â†’            <h1 className="text-3xl font-bold font-mono">{appraisal.vehicleReg}</h1>
   416â†’            <p className="text-base-content/60 mt-2">
   417â†’              {appraisal.vehicleMake} {appraisal.vehicleModel} {appraisal.vehicleYear ? `(${appraisal.vehicleYear})` : ""}
   418â†’            </p>
   419â†’          </div>
   420â†’          <span className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold border ${
   421â†’            appraisal.decision === "converted" ? "bg-emerald-50 text-emerald-700 border-emerald-200" :
   422â†’            appraisal.decision === "declined" ? "bg-red-50 text-red-700 border-red-200" :
   423â†’            appraisal.decision === "reviewed" ? "bg-blue-50 text-blue-700 border-blue-200" : "bg-amber-50 text-amber-700 border-amber-200"
   424â†’          }`}>
   425â†’            {appraisal.decision === "pending" ? "New" :
   426â†’             appraisal.decision === "reviewed" ? "Reviewed" :
   427â†’             appraisal.decision === "converted" ? "Converted" :
   428â†’             appraisal.decision === "declined" ? "Declined" : appraisal.decision}
   429â†’          </span>
   430â†’        </div>
   431â†’      </div>
   432â†’
   433â†’      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
   434â†’        <div className="lg:col-span-2 space-y-6">
   435â†’          {/* Vehicle Details */}
   436â†’          <Card>
   437â†’            <CardHeader title="Vehicle Details" icon="ğŸš—" />
   438â†’            <CardContent>
   439â†’              <KeyValueGrid cols={2}>
   440â†’                <KeyValue label="Make" value={appraisal.vehicleMake} />
   441â†’                <KeyValue label="Model" value={appraisal.vehicleModel} />
   442â†’                <KeyValue label="Year" value={appraisal.vehicleYear} />
   443â†’                <KeyValue label="Mileage" value={appraisal.mileage?.toLocaleString()} />
   444â†’              </KeyValueGrid>
   445â†’              <div className="mt-4 pt-4 border-t border-slate-100">
   446â†’                <KeyValue label="Proposed Price" value={appraisal.proposedPurchasePrice ? `Â£${appraisal.proposedPurchasePrice.toLocaleString()}` : null} size="lg" />
   447â†’              </div>
   448â†’            </CardContent>
   449â†’          </Card>
   450â†’
   451â†’          {/* Condition Notes */}
   452â†’          <Card>
   453â†’            <CardHeader title="Condition Notes" icon="ğŸ“" />
   454â†’            <CardContent>
   455â†’              <p className="whitespace-pre-wrap text-slate-700">{appraisal.conditionNotes || "No notes recorded"}</p>
   456â†’            </CardContent>
   457â†’          </Card>
   458â†’
   459â†’          {/* Issues Section */}
   460â†’          <Card>
   461â†’            <CardHeader
   462â†’              title="Issues & Damage"
   463â†’              icon="âš ï¸"
   464â†’              subtitle={totalEstimatedCost > 0 ? `Total est. repair: Â£${totalEstimatedCost.toLocaleString()}` : undefined}
   465â†’              action={
   466â†’                <button
   467â†’                  className="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-lg bg-violet-600 text-white hover:bg-violet-700 transition-colors"
   468â†’                  onClick={() => setShowIssueModal(true)}
   469â†’                >
   470â†’                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   471â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
   472â†’                  </svg>
   473â†’                  Add Issue
   474â†’                </button>
   475â†’              }
   476â†’            />
   477â†’            <CardContent>
   478â†’              {issues.length === 0 ? (
   479â†’                <div className="text-center py-8">
   480â†’                  <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center mx-auto mb-3">
   481â†’                    <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   482â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
   483â†’                    </svg>
   484â†’                  </div>
   485â†’                  <p className="text-slate-600 font-medium">No issues recorded</p>
   486â†’                  <p className="text-sm text-slate-400 mt-1">Click "Add Issue" to log damage, faults, or condition notes</p>
   487â†’                </div>
   488â†’              ) : (
   489â†’                <div className="space-y-3">
   490â†’                  {issues.map((issue) => (
   491â†’                    <div key={issue.id} className="bg-slate-50 rounded-xl border border-slate-200 p-4">
   492â†’                      <div className="flex items-start justify-between gap-2 mb-2">
   493â†’                        <div className="flex items-center gap-2 flex-wrap">
   494â†’                          <Badge variant={
   495â†’                            issue.category === 'mechanical' ? 'danger' :
   496â†’                            issue.category === 'electrical' ? 'warning' :
   497â†’                            issue.category === 'bodywork' ? 'info' :
   498â†’                            issue.category === 'fault_codes' ? 'danger' :
   499â†’                            issue.category === 'mot' ? 'secondary' : 'default'
   500â†’                          }>
   501â†’                            {CATEGORY_LABELS[issue.category] || issue.category}
   502â†’                          </Badge>
   503â†’                          <span className="font-semibold text-slate-800">{issue.subcategory}</span>
   504â†’                        </div>
   505â†’                        <button
   506â†’                          className="text-xs text-red-500 hover:text-red-700 hover:underline transition-colors"
   507â†’                          onClick={() => handleDeleteIssue(issue.id)}
   508â†’                        >
   509â†’                          Delete
   510â†’                        </button>
   511â†’                      </div>
   512â†’                      <p className="text-sm text-slate-700 mb-2">{issue.description}</p>
   513â†’                      {issue.actionNeeded && (
   514â†’                        <p className="text-xs text-slate-500 mb-1">
   515â†’                          <span className="font-medium text-slate-600">Action needed:</span> {issue.actionNeeded}
   516â†’                        </p>
   517â†’                      )}
   518â†’                      {issue.estimatedCost > 0 && (
   519â†’                        <p className="text-sm font-semibold text-red-600">
   520â†’                          Est. cost: Â£{issue.estimatedCost.toLocaleString()}
   521â†’                        </p>
   522â†’                      )}
   523â†’                      {issue.photos && issue.photos.length > 0 && (
   524â†’                        <div className="mt-3 pt-3 border-t border-slate-200">
   525â†’                          <PhotoGallery photos={issue.photos} thumbnailSize="sm" showCount={false} />
   526â†’                        </div>
   527â†’                      )}
   528â†’                    </div>
   529â†’                  ))}
   530â†’                </div>
   531â†’              )}
   532â†’            </CardContent>
   533â†’          </Card>
   534â†’
   535â†’          {/* Legacy Damage Photos - show if existing */}
   536â†’          {appraisal.damagePhotos && appraisal.damagePhotos.length > 0 && (
   537â†’            <Card>
   538â†’              <CardHeader title="Legacy Damage Photos" icon="ğŸ“·" subtitle="Consider creating issues for these photos" />
   539â†’              <CardContent>
   540â†’                <PhotoGallery photos={appraisal.damagePhotos} thumbnailSize="lg" />
   541â†’              </CardContent>
   542â†’            </Card>
   543â†’          )}
   544â†’
   545â†’          {/* Fault Code Photos - show if existing */}
   546â†’          {appraisal.faultCodePhotos && appraisal.faultCodePhotos.length > 0 && (
   547â†’            <Card>
   548â†’              <CardHeader title="Fault Code Photos" icon="ğŸ”§" />
   549â†’              <CardContent>
   550â†’                <PhotoGallery photos={appraisal.faultCodePhotos} thumbnailSize="lg" />
   551â†’              </CardContent>
   552â†’            </Card>
   553â†’          )}
   554â†’
   555â†’          {/* AI Hints */}
   556â†’          {appraisal.aiHintText && (
   557â†’            <Card variant="accent">
   558â†’              <CardHeader title="AI Suggestions" icon="ğŸ¤–" />
   559â†’              <CardContent>
   560â†’                <p className="whitespace-pre-wrap text-sm text-slate-700">{appraisal.aiHintText}</p>
   561â†’              </CardContent>
   562â†’            </Card>
   563â†’          )}
   564â†’
   565â†’          {/* Seller Info */}
   566â†’          {appraisal.contactId && (
   567â†’            <Card>
   568â†’              <CardHeader title="Seller Information" icon="ğŸ‘¤" />
   569â†’              <CardContent>
   570â†’                <KeyValueGrid cols={3}>
   571â†’                  <KeyValue label="Name" value={appraisal.contactId?.name} />
   572â†’                  <KeyValue label="Phone" value={appraisal.contactId?.phone} />
   573â†’                  <KeyValue label="Email" value={appraisal.contactId?.email} />
   574â†’                </KeyValueGrid>
   575â†’              </CardContent>
   576â†’            </Card>
   577â†’          )}
   578â†’        </div>
   579â†’
   580â†’        {/* Actions Sidebar */}
   581â†’        <div className="lg:col-span-1">
   582â†’          <Card className="sticky top-20">
   583â†’            <CardHeader title="Actions" />
   584â†’            <CardContent className="space-y-4">
   585â†’              {(appraisal.decision === "pending" || appraisal.decision === "reviewed") && !appraisal.vehicleId && (
   586â†’                <div className="space-y-3">
   587â†’                  <button
   588â†’                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-semibold rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50 transition-colors"
   589â†’                    onClick={handleConvert}
   590â†’                    disabled={isConverting}
   591â†’                  >
   592â†’                    {isConverting ? (
   593â†’                      <svg className="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
   594â†’                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
   595â†’                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
   596â†’                      </svg>
   597â†’                    ) : (
   598â†’                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   599â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   600â†’                      </svg>
   601â†’                    )}
   602â†’                    Convert to Stock
   603â†’                  </button>
   604â†’                  <button
   605â†’                    className="w-full px-4 py-2 text-sm font-medium rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 transition-colors"
   606â†’                    onClick={() => handleDecision("reviewed")}
   607â†’                  >
   608â†’                    Mark as Reviewed
   609â†’                  </button>
   610â†’                  <button
   611â†’                    className="w-full px-4 py-2 text-sm font-medium rounded-lg border border-red-200 text-red-600 hover:bg-red-50 transition-colors"
   612â†’                    onClick={() => handleDecision("declined")}
   613â†’                  >
   614â†’                    Decline
   615â†’                  </button>
   616â†’                  <p className="text-xs text-slate-500 text-center">Converting will create a vehicle and default prep tasks.</p>
   617â†’                </div>
   618â†’              )}
   619â†’
   620â†’              {appraisal.decision === "converted" || appraisal.vehicleId ? (
   621â†’                <div className="space-y-3">
   622â†’                  <div className="p-3 rounded-lg bg-emerald-50 border border-emerald-200 text-sm text-emerald-700 text-center">
   623â†’                    Vehicle added to stock
   624â†’                  </div>
   625â†’                  <Link
   626â†’                    href="/sales-prep"
   627â†’                    className="w-full inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-semibold rounded-lg bg-violet-600 text-white hover:bg-violet-700 transition-colors"
   628â†’                  >
   629â†’                    View in Stock & Prep
   630â†’                  </Link>
   631â†’                </div>
   632â†’              ) : null}
   633â†’
   634â†’              {appraisal.decision === "declined" && (
   635â†’                <div className="space-y-3">
   636â†’                  <div className="p-3 rounded-lg bg-slate-100 border border-slate-200 text-sm text-slate-600 text-center">
   637â†’                    This appraisal was declined
   638â†’                  </div>
   639â†’                  <button
   640â†’                    className="w-full px-4 py-2 text-sm font-medium rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 transition-colors"
   641â†’                    onClick={() => handleDecision("pending")}
   642â†’                  >
   643â†’                    Re-open
   644â†’                  </button>
   645â†’                </div>
   646â†’              )}
   647â†’
   648â†’              {/* Issues Summary */}
   649â†’              {issues.length > 0 && (
   650â†’                <div className="pt-4 border-t border-slate-200">
   651â†’                  <p className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Issues Summary</p>
   652â†’                  <p className="text-sm text-slate-700">{issues.length} issue{issues.length !== 1 ? "s" : ""} logged</p>
   653â†’                  {totalEstimatedCost > 0 && (
   654â†’                    <p className="text-sm font-semibold text-red-600">Â£{totalEstimatedCost.toLocaleString()} est. repairs</p>
   655â†’                  )}
   656â†’                </div>
   657â†’              )}
   658â†’
   659â†’              <div className="pt-4 border-t border-slate-200">
   660â†’                <button
   661â†’                  className="w-full px-4 py-2 text-sm font-medium rounded-lg text-red-500 hover:bg-red-50 transition-colors"
   662â†’                  onClick={async () => {
   663â†’                    if (confirm("Delete this appraisal?")) {
   664â†’                      await fetch(`/api/appraisals/${id}`, { method: "DELETE" });
   665â†’                      router.push("/appraisals");
   666â†’                    }
   667â†’                  }}
   668â†’                >
   669â†’                  Delete Appraisal
   670â†’                </button>
   671â†’              </div>
   672â†’            </CardContent>
   673â†’          </Card>
   674â†’        </div>
   675â†’      </div>
   676â†’
   677â†’      {/* Add Issue Modal */}
   678â†’      {showIssueModal && (
   679â†’        <div className="modal modal-open">
   680â†’          <div className="modal-box max-w-lg">
   681â†’            <h3 className="font-bold text-lg mb-4">Add Issue</h3>
   682â†’
   683â†’            <div className="space-y-4">
   684â†’              <div className="grid grid-cols-2 gap-4">
   685â†’                <div className="form-control">
   686â†’                  <label className="label"><span className="label-text">Category</span></label>
   687â†’                  <select
   688â†’                    className="select select-bordered w-full"
   689â†’                    value={issueForm.category}
   690â†’                    onChange={(e) => {
   691â†’                      const newCat = e.target.value;
   692â†’                      setIssueForm({
   693â†’                        ...issueForm,
   694â†’                        category: newCat,
   695â†’                        subcategory: ISSUE_SUBCATEGORIES[newCat][0],
   696â†’                      });
   697â†’                    }}
   698â†’                  >
   699â†’                    {ISSUE_CATEGORIES.map((cat) => (
   700â†’                      <option key={cat} value={cat}>{CATEGORY_LABELS[cat]}</option>
   701â†’                    ))}
   702â†’                  </select>
   703â†’                </div>
   704â†’                <div className="form-control">
   705â†’                  <label className="label"><span className="label-text">Subcategory</span></label>
   706â†’                  <select
   707â†’                    className="select select-bordered w-full"
   708â†’                    value={issueForm.subcategory}
   709â†’                    onChange={(e) => setIssueForm({ ...issueForm, subcategory: e.target.value })}
   710â†’                  >
   711â†’                    {ISSUE_SUBCATEGORIES[issueForm.category].map((sub) => (
   712â†’                      <option key={sub} value={sub}>{sub}</option>
   713â†’                    ))}
   714â†’                  </select>
   715â†’                </div>
   716â†’              </div>
   717â†’
   718â†’              <div className="form-control">
   719â†’                <label className="label"><span className="label-text">Description *</span></label>
   720â†’                <textarea
   721â†’                  className="textarea textarea-bordered"
   722â†’                  rows={3}
   723â†’                  placeholder="Describe the issue..."
   724â†’                  value={issueForm.description}
   725â†’                  onChange={(e) => setIssueForm({ ...issueForm, description: e.target.value })}
   726â†’                />
   727â†’              </div>
   728â†’
   729â†’              <div className="form-control">
   730â†’                <label className="label"><span className="label-text">Action Needed</span></label>
   731â†’                <input
   732â†’                  type="text"
   733â†’                  className="input input-bordered"
   734â†’                  placeholder="e.g., Replace bumper, repaint"
   735â†’                  value={issueForm.actionNeeded}
   736â†’                  onChange={(e) => setIssueForm({ ...issueForm, actionNeeded: e.target.value })}
   737â†’                />
   738â†’              </div>
   739â†’
   740â†’              <div className="form-control">
   741â†’                <label className="label"><span className="label-text">Estimated Repair Cost (Â£)</span></label>
   742â†’                <input
   743â†’                  type="number"
   744â†’                  className="input input-bordered"
   745â†’                  placeholder="0"
   746â†’                  value={issueForm.estimatedCost}
   747â†’                  onChange={(e) => setIssueForm({ ...issueForm, estimatedCost: e.target.value })}
   748â†’                />
   749â†’              </div>
   750â†’
   751â†’              {/* Photo Upload */}
   752â†’              <div className="form-control">
   753â†’                <label className="label"><span className="label-text">Photos</span></label>
   754â†’                <input
   755â†’                  type="file"
   756â†’                  accept="image/*"
   757â†’                  multiple
   758â†’                  className="file-input file-input-bordered w-full"
   759â†’                  onChange={handlePhotoChange}
   760â†’                />
   761â†’                {photoPreviews.length > 0 && (
   762â†’                  <div className="flex flex-wrap gap-2 mt-2">
   763â†’                    {photoPreviews.map((preview, idx) => (
   764â†’                      <div key={idx} className="relative">
   765â†’                        <img src={preview} alt={`Preview ${idx + 1}`} className="w-16 h-16 object-cover rounded-lg" />
   766â†’                        <button
   767â†’                          type="button"
   768â†’                          className="absolute -top-1 -right-1 btn btn-circle btn-xs btn-error"
   769â†’                          onClick={() => removePhoto(idx)}
   770â†’                        >
   771â†’                          Ã—
   772â†’                        </button>
   773â†’                      </div>
   774â†’                    ))}
   775â†’                  </div>
   776â†’                )}
   777â†’              </div>
   778â†’            </div>
   779â†’
   780â†’            <div className="modal-action">
   781â†’              <button
   782â†’                className="btn btn-ghost"
   783â†’                onClick={() => {
   784â†’                  setShowIssueModal(false);
   785â†’                  setPhotoFiles([]);
   786â†’                  setPhotoPreviews([]);
   787â†’                }}
   788â†’              >
   789â†’                Cancel
   790â†’              </button>
   791â†’              <button
   792â†’                className="btn btn-primary"
   793â†’                onClick={handleAddIssue}
   794â†’                disabled={isAddingIssue}
   795â†’              >
   796â†’                {isAddingIssue ? (
   797â†’                  <>
   798â†’                    <span className="loading loading-spinner loading-sm"></span>
   799â†’                    {isUploadingPhotos ? "Uploading..." : "Saving..."}
   800â†’                  </>
   801â†’                ) : (
   802â†’                  "Add Issue"
   803â†’                )}
   804â†’              </button>
   805â†’            </div>
   806â†’          </div>
   807â†’          <div className="modal-backdrop" onClick={() => setShowIssueModal(false)}></div>
   808â†’        </div>
   809â†’      )}
   810â†’
   811â†’      {/* Share Modal */}
   812â†’      {showShareModal && (
   813â†’        <div className="modal modal-open">
   814â†’          <div className="modal-box max-w-md">
   815â†’            <button
   816â†’              className="btn btn-sm btn-circle btn-ghost absolute right-2 top-2"
   817â†’              onClick={() => setShowShareModal(false)}
   818â†’            >
   819â†’              âœ•
   820â†’            </button>
   821â†’            <div className="text-center mb-6">
   822â†’              <div className="w-12 h-12 mx-auto mb-3 rounded-full bg-purple-100 flex items-center justify-center">
   823â†’                <svg className="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   824â†’                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
   825â†’                </svg>
   826â†’              </div>
   827â†’              <h3 className="font-bold text-lg">Share Appraisal</h3>
   828â†’              <p className="text-sm text-base-content/60 mt-1">
   829â†’                Share a read-only view of this appraisal
   830â†’              </p>
   831â†’            </div>
   832â†’
   833â†’            {shareLink ? (
   834â†’              <div className="space-y-4">
   835â†’                <div className="bg-base-200 rounded-lg p-4">
   836â†’                  <label className="text-xs text-base-content/60 uppercase tracking-wider">Public Link</label>
   837â†’                  <div className="flex items-center gap-2 mt-2">
   838â†’                    <input
   839â†’                      type="text"
   840â†’                      readOnly
   841â†’                      value={shareLink.url}
   842â†’                      className="input input-bordered input-sm flex-1 text-xs font-mono"
   843â†’                    />
   844â†’                    <button
   845â†’                      className="btn btn-primary btn-sm"
   846â†’                      onClick={copyShareLink}
   847â†’                    >
   848â†’                      Copy
   849â†’                    </button>
   850â†’                  </div>
   851â†’                  <p className="text-xs text-base-content/60 mt-2">
   852â†’                    Expires: {new Date(shareLink.expiresAt).toLocaleDateString()}
   853â†’                  </p>
   854â†’                </div>
   855â†’
   856â†’                <div className="grid grid-cols-2 gap-2">
   857â†’                  <button
   858â†’                    onClick={() => {
   859â†’                      window.open(`mailto:?subject=Vehicle Appraisal - ${appraisal.vehicleReg}&body=View the appraisal here: ${shareLink.url}`, "_blank");
   860â†’                    }}
   861â†’                    className="btn btn-ghost btn-sm"
   862â†’                  >
   863â†’                    <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   864â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
   865â†’                    </svg>
   866â†’                    Email
   867â†’                  </button>
   868â†’                  <button
   869â†’                    onClick={() => {
   870â†’                      window.open(`https://wa.me/?text=View this vehicle appraisal: ${encodeURIComponent(shareLink.url)}`, "_blank");
   871â†’                    }}
   872â†’                    className="btn btn-ghost btn-sm"
   873â†’                  >
   874â†’                    <svg className="w-4 h-4 mr-1 text-green-600" viewBox="0 0 24 24" fill="currentColor">
   875â†’                      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
   876â†’                    </svg>
   877â†’                    WhatsApp
   878â†’                  </button>
   879â†’                </div>
   880â†’
   881â†’                <button
   882â†’                  onClick={handleRevokeShareLink}
   883â†’                  className="btn btn-ghost btn-sm text-error w-full"
   884â†’                >
   885â†’                  Revoke Link
   886â†’                </button>
   887â†’              </div>
   888â†’            ) : (
   889â†’              <div className="space-y-4">
   890â†’                <p className="text-sm text-center text-base-content/60">
   891â†’                  Generate a secure link that allows anyone to view this appraisal (read-only). The link will expire after 60 days.
   892â†’                </p>
   893â†’                <button
   894â†’                  className="btn btn-primary w-full"
   895â†’                  onClick={handleGenerateShareLink}
   896â†’                  disabled={isGeneratingShare}
   897â†’                >
   898â†’                  {isGeneratingShare ? (
   899â†’                    <>
   900â†’                      <span className="loading loading-spinner loading-sm"></span>
   901â†’                      Generating...
   902â†’                    </>
   903â†’                  ) : (
   904â†’                    "Generate Share Link"
   905â†’                  )}
   906â†’                </button>
   907â†’              </div>
   908â†’            )}
   909â†’          </div>
   910â†’          <div className="modal-backdrop" onClick={() => setShowShareModal(false)}></div>
   911â†’        </div>
   912â†’      )}
   913â†’    </DashboardLayout>
   914â†’  );
   915â†’}
   916â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
