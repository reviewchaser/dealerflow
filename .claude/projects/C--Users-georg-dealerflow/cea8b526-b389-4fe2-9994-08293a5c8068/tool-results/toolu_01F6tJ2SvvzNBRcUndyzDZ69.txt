     1â†’import { useEffect, useState, useRef } from "react";
     2â†’import { useRouter } from "next/router";
     3â†’import Head from "next/head";
     4â†’import DashboardLayout from "@/components/DashboardLayout";
     5â†’import VehicleDrawer from "@/components/VehicleDrawer";
     6â†’import AISuggestionsPanel from "@/components/AISuggestionsPanel";
     7â†’import { toast } from "react-hot-toast";
     8â†’
     9â†’// Column config matching Sales & Prep style
    10â†’// NOTE: Internal keys are legacy names - keep stable for database compatibility
    11â†’// Display labels have been updated for clarity
    12â†’const COLUMNS = [
    13â†’  { key: "not_booked_in", label: "Not Booked In", gradient: "from-red-100/60", accent: "border-l-red-400", accentBg: "bg-red-400" },
    14â†’  { key: "on_site", label: "Booked In", gradient: "from-amber-100/60", accent: "border-l-amber-400", accentBg: "bg-amber-400" }, // Legacy key: "on_site" displays as "Booked In"
    15â†’  { key: "work_complete", label: "Work Complete", gradient: "from-blue-100/60", accent: "border-l-blue-400", accentBg: "bg-blue-400" },
    16â†’  { key: "collected", label: "Closed", gradient: "from-emerald-100/60", accent: "border-l-emerald-400", accentBg: "bg-emerald-400" }, // Legacy key: "collected" displays as "Closed"
    17â†’];
    18â†’
    19â†’const PRIORITIES = {
    20â†’  low: { bg: "bg-slate-100", text: "text-slate-600", border: "border-slate-200" },
    21â†’  normal: { bg: "bg-blue-50", text: "text-blue-700", border: "border-blue-100" },
    22â†’  high: { bg: "bg-amber-50", text: "text-amber-700", border: "border-amber-100" },
    23â†’  critical: { bg: "bg-red-50", text: "text-red-700", border: "border-red-100" },
    24â†’};
    25â†’
    26â†’const SOURCE_LABELS = {
    27â†’  warranty_claim_form: "Warranty Claim",
    28â†’  low_review: "Low Review",
    29â†’  complaint_form: "Complaint",
    30â†’  manual: "Manual",
    31â†’};
    32â†’
    33â†’// Timeline event icons
    34â†’const EVENT_ICONS = {
    35â†’  CASE_CREATED: "ðŸ“‹",
    36â†’  SUBMISSION_LINKED: "ðŸ”—",
    37â†’  COMMENT_ADDED: "ðŸ’¬",
    38â†’  STATUS_CHANGED: "ðŸ”„",
    39â†’  AI_REVIEW_GENERATED: "ðŸ¤–",
    40â†’  ATTACHMENT_ADDED: "ðŸ“Ž",
    41â†’  LOCATION_UPDATED: "ðŸ“",
    42â†’  BOOKING_UPDATED: "ðŸ“…",
    43â†’  PARTS_UPDATED: "ðŸ”§",
    44â†’  COURTESY_REQUIRED_TOGGLED: "ðŸš—",
    45â†’  COURTESY_ALLOCATED: "ðŸš—",
    46â†’  COURTESY_RETURNED: "ðŸš—",
    47â†’  COURTESY_OUT_RECORDED: "ðŸš—",
    48â†’  COURTESY_IN_RECORDED: "ðŸš—",
    49â†’  // Warranty booking auto-move events
    50â†’  WARRANTY_BOOKED_IN: "ðŸ“…",
    51â†’  WARRANTY_BOOKING_UPDATED: "ðŸ“…",
    52â†’  WARRANTY_BOOKING_CANCELLED: "âŒ",
    53â†’  WARRANTY_STAGE_MOVED: "ðŸ”€",
    54â†’};
    55â†’
    56â†’// Timeline grouping constant
    57â†’const STATUS_FLIP_GROUP_WINDOW_MS = 10 * 60 * 1000; // 10 minutes
    58â†’
    59â†’// Group consecutive STATUS_CHANGED events within the time window
    60â†’const groupTimelineEvents = (events) => {
    61â†’  if (!events || events.length === 0) return [];
    62â†’
    63â†’  const sorted = [...events].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    64â†’  const grouped = [];
    65â†’  let currentGroup = null;
    66â†’
    67â†’  for (const event of sorted) {
    68â†’    if (event.type === "STATUS_CHANGED") {
    69â†’      if (currentGroup) {
    70â†’        // Check if this event is within the time window of the last event in the group
    71â†’        const lastEventTime = new Date(currentGroup.events[currentGroup.events.length - 1].createdAt).getTime();
    72â†’        const thisEventTime = new Date(event.createdAt).getTime();
    73â†’
    74â†’        if (lastEventTime - thisEventTime <= STATUS_FLIP_GROUP_WINDOW_MS) {
    75â†’          currentGroup.events.push(event);
    76â†’          continue;
    77â†’        } else {
    78â†’          // Close current group and start new one
    79â†’          grouped.push(currentGroup);
    80â†’          currentGroup = { isGroup: true, type: "STATUS_CHANGED_GROUP", events: [event] };
    81â†’        }
    82â†’      } else {
    83â†’        currentGroup = { isGroup: true, type: "STATUS_CHANGED_GROUP", events: [event] };
    84â†’      }
    85â†’    } else {
    86â†’      // Non-status event - close any current group and add this event
    87â†’      if (currentGroup) {
    88â†’        grouped.push(currentGroup);
    89â†’        currentGroup = null;
    90â†’      }
    91â†’      grouped.push(event);
    92â†’    }
    93â†’  }
    94â†’
    95â†’  // Don't forget to add the last group if exists
    96â†’  if (currentGroup) {
    97â†’    grouped.push(currentGroup);
    98â†’  }
    99â†’
   100â†’  return grouped;
   101â†’};
   102â†’
   103â†’// Repair location type labels
   104â†’const REPAIR_LOCATION_LABELS = {
   105â†’  WITH_CUSTOMER: "With customer",
   106â†’  ON_SITE: "On-site",
   107â†’  THIRD_PARTY: "Third-party",
   108â†’};
   109â†’
   110â†’// Repair location type badge styles
   111â†’const REPAIR_LOCATION_STYLES = {
   112â†’  WITH_CUSTOMER: { bg: "bg-slate-100", text: "text-slate-600" },
   113â†’  ON_SITE: { bg: "bg-emerald-100", text: "text-emerald-700" },
   114â†’  THIRD_PARTY: { bg: "bg-purple-100", text: "text-purple-700" },
   115â†’};
   116â†’
   117â†’// Format booked date/time for display
   118â†’const formatBookedDate = (date) => {
   119â†’  if (!date) return null;
   120â†’  const d = new Date(date);
   121â†’  return d.toLocaleDateString("en-GB", { day: "numeric", month: "short" }) +
   122â†’    " " + d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" });
   123â†’};
   124â†’
   125â†’// Helper to calculate days since date
   126â†’const daysSince = (date) => {
   127â†’  if (!date) return 0;
   128â†’  const diff = Date.now() - new Date(date).getTime();
   129â†’  return Math.floor(diff / (1000 * 60 * 60 * 24));
   130â†’};
   131â†’
   132â†’// Helper for relative time display
   133â†’const relativeTime = (date) => {
   134â†’  const days = daysSince(date);
   135â†’  if (days === 0) {
   136â†’    const hours = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60 * 60));
   137â†’    if (hours === 0) {
   138â†’      const mins = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60));
   139â†’      return mins <= 1 ? "Just now" : `${mins}m ago`;
   140â†’    }
   141â†’    return `${hours}h ago`;
   142â†’  }
   143â†’  if (days === 1) return "Yesterday";
   144â†’  if (days < 7) return `${days}d ago`;
   145â†’  if (days < 30) return `${Math.floor(days / 7)}w ago`;
   146â†’  return `${Math.floor(days / 30)}mo ago`;
   147â†’};
   148â†’
   149â†’export default function Warranty() {
   150â†’  const router = useRouter();
   151â†’  const [cases, setCases] = useState([]);
   152â†’  const [isLoading, setIsLoading] = useState(true);
   153â†’  const [selectedCase, setSelectedCase] = useState(null);
   154â†’  const [showAddModal, setShowAddModal] = useState(false);
   155â†’  const [newComment, setNewComment] = useState("");
   156â†’  const [commentAttachments, setCommentAttachments] = useState([]);
   157â†’  const [isGeneratingAI, setIsGeneratingAI] = useState(false);
   158â†’  const [showRegenerateConfirm, setShowRegenerateConfirm] = useState(false);
   159â†’  const [aiDiagnostics, setAiDiagnostics] = useState(null);
   160â†’  const [isLoadingDiagnostics, setIsLoadingDiagnostics] = useState(false);
   161â†’  const [expandedTimelineGroups, setExpandedTimelineGroups] = useState({});
   162â†’  const [isVehicleDrawerOpen, setIsVehicleDrawerOpen] = useState(false);
   163â†’  const [selectedVehicleId, setSelectedVehicleId] = useState(null);
   164â†’  const fileInputRef = useRef(null);
   165â†’
   166â†’  // Drag state - matching Sales & Prep
   167â†’  const [draggedCard, setDraggedCard] = useState(null);
   168â†’  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });
   169â†’
   170â†’  // Courtesy car state
   171â†’  const [courtesyVehicles, setCourtesyVehicles] = useState([]);
   172â†’  const [isLoadingCourtesy, setIsLoadingCourtesy] = useState(false);
   173â†’
   174â†’  // Column sorting state
   175â†’  const [columnSortOptions, setColumnSortOptions] = useState({});
   176â†’
   177â†’  // Search filter state
   178â†’  const [searchQuery, setSearchQuery] = useState("");
   179â†’
   180â†’  // Filter state (matching stock board style)
   181â†’  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);
   182â†’  const [filters, setFilters] = useState({
   183â†’    location: "all",      // "all" | "ON_SITE" | "THIRD_PARTY"
   184â†’    booked: "all",        // "all" | "booked" | "not_booked"
   185â†’    partsRequired: "all", // "all" | "yes" | "no"
   186â†’    priority: "all",      // "all" | "low" | "normal" | "high" | "critical"
   187â†’  });
   188â†’
   189â†’  // Mobile column selection
   190â†’  const [mobileActiveColumn, setMobileActiveColumn] = useState("not_booked_in");
   191â†’
   192â†’  // Job sheet share state
   193â†’  const [showJobSheetModal, setShowJobSheetModal] = useState(false);
   194â†’  const [jobSheetLink, setJobSheetLink] = useState(null);
   195â†’  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);
   196â†’
   197â†’  useEffect(() => { fetchCases(); }, []);
   198â†’
   199â†’  // Auto-open case from query param (e.g., /warranty?caseId=123)
   200â†’  useEffect(() => {
   201â†’    if (router.query.caseId && !selectedCase) {
   202â†’      fetchCaseDetail(router.query.caseId);
   203â†’    }
   204â†’  }, [router.query.caseId]);
   205â†’
   206â†’  const fetchCases = async () => {
   207â†’    try {
   208â†’      const res = await fetch("/api/aftercare");
   209â†’      // Check for JSON response
   210â†’      const contentType = res.headers.get("content-type") || "";
   211â†’      if (!contentType.includes("application/json")) {
   212â†’        console.error("[Warranty] Non-JSON response:", res.status);
   213â†’        toast.error(res.status === 401 || res.status === 403 ? "Session expired - please sign in" : "Failed to load cases");
   214â†’        setCases([]);
   215â†’        return;
   216â†’      }
   217â†’      if (!res.ok) {
   218â†’        const err = await res.json();
   219â†’        toast.error(err.error || "Failed to load cases");
   220â†’        setCases([]);
   221â†’        return;
   222â†’      }
   223â†’      const data = await res.json();
   224â†’      setCases(Array.isArray(data) ? data : []);
   225â†’    } catch (error) {
   226â†’      console.error("[Warranty] Fetch error:", error);
   227â†’      toast.error("Failed to load cases");
   228â†’      setCases([]);
   229â†’    } finally {
   230â†’      setIsLoading(false);
   231â†’    }
   232â†’  };
   233â†’
   234â†’  const fetchCaseDetail = async (caseId) => {
   235â†’    if (!caseId) return; // Guard against undefined/null caseId
   236â†’    // Clear AI diagnostics when switching cases
   237â†’    setAiDiagnostics(null);
   238â†’    try {
   239â†’      const res = await fetch(`/api/aftercare/${caseId}`);
   240â†’      // Check for JSON response
   241â†’      const contentType = res.headers.get("content-type") || "";
   242â†’      if (!contentType.includes("application/json")) {
   243â†’        console.error("[Warranty] Case detail non-JSON response:", res.status);
   244â†’        toast.error("Failed to load case details");
   245â†’        return;
   246â†’      }
   247â†’      if (!res.ok) {
   248â†’        const err = await res.json();
   249â†’        toast.error(err.error || "Failed to load case");
   250â†’        return;
   251â†’      }
   252â†’      const data = await res.json();
   253â†’      // Normalize id field (API returns _id, we use id internally)
   254â†’      setSelectedCase({ ...data, id: data._id || data.id });
   255â†’    } catch (error) {
   256â†’      console.error("[Warranty] Case detail error:", error);
   257â†’      toast.error("Failed to load case");
   258â†’    }
   259â†’  };
   260â†’
   261â†’  // Helper function to update case fields with proper error handling
   262â†’  const updateCase = async (updates, successMessage) => {
   263â†’    const caseId = selectedCase?.id || selectedCase?._id;
   264â†’    if (!caseId) return false;
   265â†’    try {
   266â†’      const res = await fetch(`/api/aftercare/${caseId}`, {
   267â†’        method: "PUT",
   268â†’        headers: { "Content-Type": "application/json" },
   269â†’        body: JSON.stringify(updates),
   270â†’      });
   271â†’      const data = await res.json();
   272â†’      if (!res.ok || !data.ok) {
   273â†’        throw new Error(data.error || "Failed to update case");
   274â†’      }
   275â†’      // Update local state from response
   276â†’      if (data.case) {
   277â†’        setSelectedCase({ ...data.case, id: data.case._id || data.case.id });
   278â†’        setCases(prev => prev.map(c =>
   279â†’          (c.id || c._id) === caseId ? { ...data.case, id: data.case._id || data.case.id } : c
   280â†’        ));
   281â†’      }
   282â†’
   283â†’      // Handle auto-move toast messages for booking changes
   284â†’      if (data.autoMoved) {
   285â†’        const COLUMN_LABELS = {
   286â†’          not_booked_in: "Not Booked In",
   287â†’          on_site: "Booked In",
   288â†’          work_complete: "Work Complete",
   289â†’          collected: "Closed"
   290â†’        };
   291â†’        if (data.autoMovedTo === "on_site") {
   292â†’          toast.success(`Booked in â€” moved to Booked In`, { duration: 4000 });
   293â†’        } else if (data.autoMovedFrom === "on_site") {
   294â†’          toast.success(`Booking cancelled â€” moved back to ${COLUMN_LABELS[data.autoMovedTo] || data.autoMovedTo}`, { duration: 4000 });
   295â†’        }
   296â†’      } else if (successMessage) {
   297â†’        toast.success(successMessage);
   298â†’      }
   299â†’      return data;
   300â†’    } catch (error) {
   301â†’      toast.error(error.message || "Failed to update case");
   302â†’      return false;
   303â†’    }
   304â†’  };
   305â†’
   306â†’  // Load available courtesy vehicles
   307â†’  const loadCourtesyVehicles = async () => {
   308â†’    setIsLoadingCourtesy(true);
   309â†’    try {
   310â†’      const res = await fetch("/api/aftercare/courtesy");
   311â†’      const data = await res.json();
   312â†’      setCourtesyVehicles(data.available || []);
   313â†’    } catch (error) {
   314â†’      console.error("Error loading courtesy vehicles:", error);
   315â†’    } finally {
   316â†’      setIsLoadingCourtesy(false);
   317â†’    }
   318â†’  };
   319â†’
   320â†’  // Allocate courtesy vehicle to case
   321â†’  const allocateCourtesy = async (courtesyVehicleId, dateDueBack) => {
   322â†’    const caseId = selectedCase?.id || selectedCase?._id;
   323â†’    if (!caseId || !courtesyVehicleId) return false;
   324â†’    try {
   325â†’      const res = await fetch("/api/aftercare/courtesy", {
   326â†’        method: "POST",
   327â†’        headers: { "Content-Type": "application/json" },
   328â†’        body: JSON.stringify({ caseId, courtesyVehicleId, dateDueBack }),
   329â†’      });
   330â†’      const data = await res.json();
   331â†’      if (!res.ok || !data.ok) {
   332â†’        throw new Error(data.error || "Failed to allocate courtesy vehicle");
   333â†’      }
   334â†’      if (data.case) {
   335â†’        setSelectedCase({ ...data.case, id: data.case._id || data.case.id });
   336â†’        setCases(prev => prev.map(c =>
   337â†’          (c.id || c._id) === caseId ? { ...data.case, id: data.case._id || data.case.id } : c
   338â†’        ));
   339â†’      }
   340â†’      toast.success("Courtesy vehicle allocated");
   341â†’      loadCourtesyVehicles(); // Refresh available list
   342â†’      return true;
   343â†’    } catch (error) {
   344â†’      toast.error(error.message || "Failed to allocate courtesy vehicle");
   345â†’      return false;
   346â†’    }
   347â†’  };
   348â†’
   349â†’  // Return courtesy vehicle
   350â†’  const returnCourtesy = async () => {
   351â†’    const allocationId = selectedCase?.courtesyAllocationId || selectedCase?.courtesyAllocation?._id;
   352â†’    if (!allocationId) return false;
   353â†’    try {
   354â†’      const res = await fetch("/api/aftercare/courtesy", {
   355â†’        method: "PATCH",
   356â†’        headers: { "Content-Type": "application/json" },
   357â†’        body: JSON.stringify({ allocationId }),
   358â†’      });
   359â†’      const data = await res.json();
   360â†’      if (!res.ok || !data.ok) {
   361â†’        throw new Error(data.error || "Failed to return courtesy vehicle");
   362â†’      }
   363â†’      // Refresh case detail
   364â†’      fetchCaseDetail(selectedCase.id || selectedCase._id);
   365â†’      loadCourtesyVehicles(); // Refresh available list
   366â†’      toast.success("Courtesy vehicle returned");
   367â†’      return true;
   368â†’    } catch (error) {
   369â†’      toast.error(error.message || "Failed to return courtesy vehicle");
   370â†’      return false;
   371â†’    }
   372â†’  };
   373â†’
   374â†’  // Generate job sheet share link
   375â†’  const handleGenerateJobSheet = async () => {
   376â†’    const caseId = selectedCase?.id || selectedCase?._id;
   377â†’    if (!caseId) return;
   378â†’    setIsGeneratingJobSheet(true);
   379â†’    setShowJobSheetModal(true);
   380â†’    try {
   381â†’      const res = await fetch(`/api/aftercare/${caseId}/job-sheet`, {
   382â†’        method: "POST",
   383â†’        headers: { "Content-Type": "application/json" },
   384â†’        body: JSON.stringify({ expiresInDays: 60 }),
   385â†’      });
   386â†’      const data = await res.json();
   387â†’      if (!res.ok) {
   388â†’        throw new Error(data.error || "Failed to generate share link");
   389â†’      }
   390â†’      const fullUrl = `${window.location.origin}${data.shareUrl}`;
   391â†’      setJobSheetLink(fullUrl);
   392â†’      toast.success("Job sheet link generated");
   393â†’    } catch (error) {
   394â†’      toast.error(error.message || "Failed to generate share link");
   395â†’      setShowJobSheetModal(false);
   396â†’    } finally {
   397â†’      setIsGeneratingJobSheet(false);
   398â†’    }
   399â†’  };
   400â†’
   401â†’  // Copy job sheet link to clipboard
   402â†’  const copyJobSheetLink = () => {
   403â†’    if (jobSheetLink) {
   404â†’      navigator.clipboard.writeText(jobSheetLink);
   405â†’      toast.success("Link copied to clipboard");
   406â†’    }
   407â†’  };
   408â†’
   409â†’  // Share job sheet via WhatsApp
   410â†’  const shareViaWhatsApp = () => {
   411â†’    if (jobSheetLink) {
   412â†’      const reg = selectedCase?.regAtPurchase || selectedCase?.currentReg || "Vehicle";
   413â†’      const text = `Job Sheet for ${reg}: ${jobSheetLink}`;
   414â†’      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
   415â†’    }
   416â†’  };
   417â†’
   418â†’  // Drag handlers - matching Sales & Prep exactly
   419â†’  const handleDragStart = (e, caseItem) => {
   420â†’    setDraggedCard(caseItem);
   421â†’    setDragPosition({ x: e.clientX, y: e.clientY });
   422â†’    e.dataTransfer.effectAllowed = "move";
   423â†’    // Create invisible drag image (we render our own preview)
   424â†’    const emptyImg = new Image();
   425â†’    emptyImg.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
   426â†’    e.dataTransfer.setDragImage(emptyImg, 0, 0);
   427â†’  };
   428â†’
   429â†’  const handleDrag = (e) => {
   430â†’    if (e.clientX !== 0 && e.clientY !== 0) {
   431â†’      setDragPosition({ x: e.clientX, y: e.clientY });
   432â†’    }
   433â†’  };
   434â†’
   435â†’  const handleDragOver = (e) => {
   436â†’    e.preventDefault();
   437â†’    e.dataTransfer.dropEffect = "move";
   438â†’  };
   439â†’
   440â†’  const handleDragEnd = () => {
   441â†’    setDraggedCard(null);
   442â†’  };
   443â†’
   444â†’  const handleDrop = async (e, newStatus) => {
   445â†’    e.preventDefault();
   446â†’    if (!draggedCard || draggedCard.boardStatus === newStatus) {
   447â†’      setDraggedCard(null);
   448â†’      return;
   449â†’    }
   450â†’    const caseId = draggedCard.id || draggedCard._id;
   451â†’
   452â†’    // Optimistic update
   453â†’    setCases(prev => prev.map(c =>
   454â†’      (c.id || c._id) === caseId ? { ...c, boardStatus: newStatus } : c
   455â†’    ));
   456â†’
   457â†’    try {
   458â†’      const res = await fetch(`/api/aftercare/${caseId}`, {
   459â†’        method: "PUT",
   460â†’        headers: { "Content-Type": "application/json" },
   461â†’        body: JSON.stringify({ boardStatus: newStatus }),
   462â†’      });
   463â†’      const data = await res.json();
   464â†’      if (!res.ok || !data.ok) {
   465â†’        throw new Error(data.error || "Failed to update status");
   466â†’      }
   467â†’      toast.success(`Moved to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);
   468â†’      // Update local state from response
   469â†’      if (data.case) {
   470â†’        setCases(prev => prev.map(c =>
   471â†’          (c.id || c._id) === caseId ? { ...data.case, id: data.case._id || data.case.id } : c
   472â†’        ));
   473â†’      } else {
   474â†’        fetchCases();
   475â†’      }
   476â†’    } catch (error) {
   477â†’      toast.error(error.message || "Failed to update");
   478â†’      fetchCases(); // Revert on error
   479â†’    }
   480â†’    setDraggedCard(null);
   481â†’  };
   482â†’
   483â†’  const handleFileSelect = async (e) => {
   484â†’    const files = Array.from(e.target.files);
   485â†’    if (files.length === 0) return;
   486â†’
   487â†’    const uploadedFiles = [];
   488â†’    for (const file of files) {
   489â†’      const formData = new FormData();
   490â†’      formData.append("file", file);
   491â†’      try {
   492â†’        const res = await fetch("/api/vehicles/upload", { method: "POST", body: formData });
   493â†’        const data = await res.json();
   494â†’        if (data.url) {
   495â†’          uploadedFiles.push({ url: data.url, filename: data.filename || file.name });
   496â†’        }
   497â†’      } catch (err) {
   498â†’        toast.error(`Failed to upload ${file.name}`);
   499â†’      }
   500â†’    }

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
