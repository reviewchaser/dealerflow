   500→    }
   501→    setCommentAttachments([...commentAttachments, ...uploadedFiles]);
   502→  };
   503→
   504→  const addComment = async () => {
   505→    if (!newComment.trim() && commentAttachments.length === 0) return;
   506→    try {
   507→      const res = await fetch(`/api/aftercare/${selectedCase.id}/comments`, {
   508→        method: "POST",
   509→        headers: { "Content-Type": "application/json" },
   510→        body: JSON.stringify({
   511→          content: newComment || "(attachment)",
   512→          authorType: "staff",
   513→          attachments: commentAttachments
   514→        }),
   515→      });
   516→      const data = await res.json();
   517→      if (!res.ok || !data.ok) {
   518→        throw new Error(data.error || "Failed to add comment");
   519→      }
   520→      setNewComment("");
   521→      setCommentAttachments([]);
   522→      // Refetch the case to get updated comments and timeline events
   523→      fetchCaseDetail(selectedCase.id);
   524→      toast.success("Comment added");
   525→    } catch (error) {
   526→      toast.error(error.message || "Failed to add comment");
   527→    }
   528→  };
   529→
   530→  const generateAIReview = async (regenerate = false) => {
   531→    if (regenerate) {
   532→      setShowRegenerateConfirm(false);
   533→    }
   534→    setIsGeneratingAI(true);
   535→    try {
   536→      const res = await fetch("/api/ai/case-review", {
   537→        method: "POST",
   538→        headers: { "Content-Type": "application/json" },
   539→        body: JSON.stringify({ caseId: selectedCase.id }),
   540→      });
   541→      const data = await res.json();
   542→      if (!res.ok) throw new Error(data.error || "Failed to generate");
   543→      fetchCaseDetail(selectedCase.id);
   544→      toast.success("AI review generated");
   545→    } catch (error) {
   546→      toast.error(error.message);
   547→    } finally {
   548→      setIsGeneratingAI(false);
   549→    }
   550→  };
   551→
   552→  // Fetch AI diagnostic suggestions
   553→  const fetchAIDiagnostics = async () => {
   554→    if (!selectedCase) return;
   555→    setIsLoadingDiagnostics(true);
   556→    setAiDiagnostics(null);
   557→    try {
   558→      const vehicle = selectedCase.vehicleId;
   559→      const res = await fetch("/api/ai/warranty-suggestions", {
   560→        method: "POST",
   561→        headers: { "Content-Type": "application/json" },
   562→        body: JSON.stringify({
   563→          vehicleMake: vehicle?.make,
   564→          vehicleModel: vehicle?.model,
   565→          vehicleYear: vehicle?.year,
   566→          mileage: vehicle?.mileage,
   567→          fuelType: vehicle?.fuelType,
   568→          symptomDescription: selectedCase.summary || selectedCase.details?.description || "",
   569→          faultCodes: selectedCase.details?.faultCodes,
   570→          warrantyType: selectedCase.warrantyType,
   571→          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,
   572→        }),
   573→      });
   574→      const data = await res.json();
   575→      if (data.success) {
   576→        setAiDiagnostics({
   577→          suggestions: data.suggestions,
   578→          isDummy: data.isDummy,
   579→        });
   580→      } else {
   581→        toast.error(data.error || "Failed to get AI suggestions");
   582→      }
   583→    } catch (error) {
   584→      console.error("AI diagnostics error:", error);
   585→      toast.error("Failed to get AI suggestions");
   586→    } finally {
   587→      setIsLoadingDiagnostics(false);
   588→    }
   589→  };
   590→
   591→  const copyToClipboard = (text, label) => {
   592→    navigator.clipboard.writeText(text);
   593→    toast.success(`${label} copied to clipboard`);
   594→  };
   595→
   596→  // Filter cases by search query and filters
   597→  const getFilteredCases = () => {
   598→    let filtered = cases;
   599→
   600→    // Apply search query filter
   601→    if (searchQuery.trim()) {
   602→      const query = searchQuery.toUpperCase().replace(/\s/g, "");
   603→      filtered = filtered.filter(c => {
   604→        // Search by VRM
   605→        const regAtPurchase = (c.regAtPurchase || "").toUpperCase().replace(/\s/g, "");
   606→        const currentReg = (c.currentReg || "").toUpperCase().replace(/\s/g, "");
   607→        const detailsReg = (c.details?.vehicleReg || "").toUpperCase().replace(/\s/g, "");
   608→        // Search by customer name
   609→        const customerName = (c.contactId?.name || "").toUpperCase();
   610→        return regAtPurchase.includes(query) ||
   611→               currentReg.includes(query) ||
   612→               detailsReg.includes(query) ||
   613→               customerName.includes(query);
   614→      });
   615→    }
   616→
   617→    // Apply location filter
   618→    if (filters.location !== "all") {
   619→      filtered = filtered.filter(c => (c.repairLocationType || "WITH_CUSTOMER") === filters.location);
   620→    }
   621→
   622→    // Apply booked filter
   623→    if (filters.booked === "booked") {
   624→      filtered = filtered.filter(c => c.bookedInAt);
   625→    } else if (filters.booked === "not_booked") {
   626→      filtered = filtered.filter(c => !c.bookedInAt);
   627→    }
   628→
   629→    // Apply parts required filter
   630→    if (filters.partsRequired === "yes") {
   631→      filtered = filtered.filter(c => c.partsRequired === true);
   632→    } else if (filters.partsRequired === "no") {
   633→      filtered = filtered.filter(c => !c.partsRequired);
   634→    }
   635→
   636→    // Apply priority filter
   637→    if (filters.priority !== "all") {
   638→      filtered = filtered.filter(c => (c.priority || "normal") === filters.priority);
   639→    }
   640→
   641→    return filtered;
   642→  };
   643→
   644→  // Check if any filters are active
   645→  const hasActiveFilters = () => {
   646→    return filters.location !== "all" ||
   647→           filters.booked !== "all" ||
   648→           filters.partsRequired !== "all" ||
   649→           filters.priority !== "all";
   650→  };
   651→
   652→  // Clear all filters
   653→  const clearFilters = () => {
   654→    setFilters({
   655→      location: "all",
   656→      booked: "all",
   657→      partsRequired: "all",
   658→      priority: "all",
   659→    });
   660→  };
   661→
   662→  // Get cases by status with sorting
   663→  const getCasesByStatus = (status) => {
   664→    const filteredBySearch = getFilteredCases();
   665→    const filtered = filteredBySearch.filter(c => c.boardStatus === status);
   666→    const sortOption = columnSortOptions[status] || "oldest_first";
   667→
   668→    return filtered.sort((a, b) => {
   669→      if (sortOption === "newest_first") {
   670→        return new Date(b.createdAt) - new Date(a.createdAt);
   671→      }
   672→      if (sortOption === "alphabetical") {
   673→        const nameA = a.contactId?.name || "";
   674→        const nameB = b.contactId?.name || "";
   675→        return nameA.localeCompare(nameB);
   676→      }
   677→      // oldest_first (default)
   678→      return new Date(a.createdAt) - new Date(b.createdAt);
   679→    });
   680→  };
   681→
   682→  // Calculate attachment count for a case
   683→  const getAttachmentCount = (c) => {
   684→    const caseAttachments = c.attachments?.length || 0;
   685→    const submissionAttachments = c.submissionAttachmentCount || 0;
   686→    const commentAttachments = c.commentAttachmentCount || 0;
   687→    return caseAttachments + submissionAttachments + commentAttachments;
   688→  };
   689→
   690→  // Get activity count (events count)
   691→  const getActivityCount = (c) => c.events?.length || 0;
   692→
   693→  return (
   694→    <DashboardLayout>
   695→      <Head><title>Customer/Warranty | DealerFlow</title></Head>
   696→
   697→      <div className="flex justify-between items-center mb-6">
   698→        <div>
   699→          <h1 className="text-3xl font-bold text-slate-900">Customer / Warranty Board</h1>
   700→          <p className="text-slate-500 mt-1">Manage warranty cases and aftercare</p>
   701→        </div>
   702→        <button className="btn btn-primary" onClick={() => setShowAddModal(true)}>
   703→          + New Case
   704→        </button>
   705→      </div>
   706→
   707→      {/* Search Filter */}
   708→      <div className="mb-4">
   709→        <div className="relative w-full max-w-sm">
   710→          <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   711→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
   712→          </svg>
   713→          <input
   714→            type="text"
   715→            placeholder="Search by VRM or customer name..."
   716→            className="input input-bordered w-full pl-10 pr-10"
   717→            value={searchQuery}
   718→            onChange={(e) => setSearchQuery(e.target.value)}
   719→          />
   720→          {searchQuery && (
   721→            <button
   722→              className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
   723→              onClick={() => setSearchQuery("")}
   724→            >
   725→              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   726→                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   727→              </svg>
   728→            </button>
   729→          )}
   730→        </div>
   731→
   732→        {/* Filter Dropdown - matching stock board style */}
   733→        <div className="relative">
   734→          <button
   735→            className={`btn btn-sm gap-2 ${hasActiveFilters() ? "btn-primary" : "btn-outline"}`}
   736→            onClick={() => setShowFiltersDropdown(!showFiltersDropdown)}
   737→          >
   738→            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   739→              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
   740→            </svg>
   741→            Filters
   742→            {hasActiveFilters() && (
   743→              <span className="badge badge-sm badge-secondary">
   744→                {Object.values(filters).filter(v => v !== "all").length}
   745→              </span>
   746→            )}
   747→          </button>
   748→
   749→          {showFiltersDropdown && (
   750→            <div className="absolute z-30 mt-2 w-72 bg-white border border-slate-200 rounded-xl shadow-lg p-4">
   751→              <div className="flex justify-between items-center mb-3">
   752→                <h4 className="font-semibold text-sm">Filters</h4>
   753→                {hasActiveFilters() && (
   754→                  <button className="btn btn-ghost btn-xs" onClick={clearFilters}>
   755→                    Clear all
   756→                  </button>
   757→                )}
   758→              </div>
   759→
   760→              <div className="space-y-3">
   761→                {/* Location Filter */}
   762→                <div className="form-control">
   763→                  <label className="label label-text text-xs py-0">Location</label>
   764→                  <select
   765→                    className="select select-bordered select-sm w-full"
   766→                    value={filters.location}
   767→                    onChange={(e) => setFilters({ ...filters, location: e.target.value })}
   768→                  >
   769→                    <option value="all">All</option>
   770→                    <option value="WITH_CUSTOMER">With customer</option>
   771→                    <option value="ON_SITE">On-site</option>
   772→                    <option value="THIRD_PARTY">Third-party</option>
   773→                  </select>
   774→                </div>
   775→
   776→                {/* Booked Filter */}
   777→                <div className="form-control">
   778→                  <label className="label label-text text-xs py-0">Booked Status</label>
   779→                  <select
   780→                    className="select select-bordered select-sm w-full"
   781→                    value={filters.booked}
   782→                    onChange={(e) => setFilters({ ...filters, booked: e.target.value })}
   783→                  >
   784→                    <option value="all">All</option>
   785→                    <option value="booked">Booked</option>
   786→                    <option value="not_booked">Not Booked</option>
   787→                  </select>
   788→                </div>
   789→
   790→                {/* Parts Required Filter */}
   791→                <div className="form-control">
   792→                  <label className="label label-text text-xs py-0">Parts Required</label>
   793→                  <select
   794→                    className="select select-bordered select-sm w-full"
   795→                    value={filters.partsRequired}
   796→                    onChange={(e) => setFilters({ ...filters, partsRequired: e.target.value })}
   797→                  >
   798→                    <option value="all">All</option>
   799→                    <option value="yes">Yes</option>
   800→                    <option value="no">No</option>
   801→                  </select>
   802→                </div>
   803→
   804→                {/* Priority Filter */}
   805→                <div className="form-control">
   806→                  <label className="label label-text text-xs py-0">Priority</label>
   807→                  <select
   808→                    className="select select-bordered select-sm w-full"
   809→                    value={filters.priority}
   810→                    onChange={(e) => setFilters({ ...filters, priority: e.target.value })}
   811→                  >
   812→                    <option value="all">All</option>
   813→                    <option value="low">Low</option>
   814→                    <option value="normal">Normal</option>
   815→                    <option value="high">High</option>
   816→                    <option value="critical">Critical</option>
   817→                  </select>
   818→                </div>
   819→              </div>
   820→
   821→              <button
   822→                className="btn btn-sm btn-block mt-4"
   823→                onClick={() => setShowFiltersDropdown(false)}
   824→              >
   825→                Apply
   826→              </button>
   827→            </div>
   828→          )}
   829→        </div>
   830→      </div>
   831→
   832→      {/* Active filters / result count summary */}
   833→      {(searchQuery || hasActiveFilters()) && (
   834→        <div className="mb-4">
   835→          <p className="text-sm text-slate-500">
   836→            Showing {getFilteredCases().length} of {cases.length} cases
   837→            {hasActiveFilters() && (
   838→              <button className="ml-2 text-primary hover:underline" onClick={clearFilters}>
   839→                Clear filters
   840→              </button>
   841→            )}
   842→          </p>
   843→        </div>
   844→      )}
   845→
   846→      {isLoading ? (
   847→        <div className="flex justify-center py-20">
   848→          <span className="loading loading-spinner loading-lg"></span>
   849→        </div>
   850→      ) : (
   851→        <>
   852→          {/* Mobile Column Tabs */}
   853→          <div className="md:hidden mb-4 overflow-x-auto">
   854→            <div className="flex gap-1 p-1 bg-slate-100 rounded-xl min-w-max">
   855→              {COLUMNS.map((col) => {
   856→                const count = getCasesByStatus(col.key).length;
   857→                return (
   858→                  <button
   859→                    key={col.key}
   860→                    onClick={() => setMobileActiveColumn(col.key)}
   861→                    className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${
   862→                      mobileActiveColumn === col.key
   863→                        ? "bg-white shadow-sm text-slate-900"
   864→                        : "text-slate-500 hover:text-slate-700"
   865→                    }`}
   866→                  >
   867→                    <span>{col.label}</span>
   868→                    <span className={`px-1.5 py-0.5 rounded text-xs font-bold ${
   869→                      mobileActiveColumn === col.key ? "bg-slate-100" : "bg-slate-200/50"
   870→                    }`}>
   871→                      {count}
   872→                    </span>
   873→                  </button>
   874→                );
   875→              })}
   876→            </div>
   877→          </div>
   878→
   879→          {/* Mobile Single Column View */}
   880→          <div className="md:hidden">
   881→            {COLUMNS.filter(col => col.key === mobileActiveColumn).map((col) => {
   882→              const columnCases = getCasesByStatus(col.key);
   883→              return (
   884→                <div key={col.key} className="space-y-3">
   885→                  {columnCases.map((caseItem) => {
   886→                    const daysOpen = daysSince(caseItem.createdAt);
   887→                    const priority = caseItem.priority || "normal";
   888→                    const priorityStyle = PRIORITIES[priority] || PRIORITIES.normal;
   889→                    const locationType = caseItem.repairLocationType || "WITH_CUSTOMER";
   890→                    const locationStyle = REPAIR_LOCATION_STYLES[locationType] || REPAIR_LOCATION_STYLES.WITH_CUSTOMER;
   891→                    const attachmentCount = (caseItem.submissionAttachmentCount || 0) + (caseItem.commentAttachmentCount || 0);
   892→                    const activityCount = (caseItem.comments?.length || 0) + (caseItem.events?.length || 0);
   893→
   894→                    return (
   895→                      <div
   896→                        key={caseItem.id || caseItem._id}
   897→                        className="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100/50 overflow-hidden active:scale-[0.98]"
   898→                        onClick={() => {
   899→                          const id = caseItem.id || caseItem._id;

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
