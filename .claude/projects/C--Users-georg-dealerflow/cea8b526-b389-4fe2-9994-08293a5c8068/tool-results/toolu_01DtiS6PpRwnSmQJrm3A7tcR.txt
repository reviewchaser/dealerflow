     1â†’import { useEffect, useState } from "react";
     2â†’import Link from "next/link";
     3â†’import { Card, CardHeader, CardContent } from "@/components/ui/Card";
     4â†’import { Badge } from "@/components/ui/Badge";
     5â†’import { PhotoGallery } from "@/components/ui/PhotoGallery";
     6â†’
     7â†’// Image lightbox component
     8â†’function ImageLightbox({ src, alt, onClose }) {
     9â†’  useEffect(() => {
    10â†’    const handleEsc = (e) => e.key === "Escape" && onClose();
    11â†’    document.addEventListener("keydown", handleEsc);
    12â†’    return () => document.removeEventListener("keydown", handleEsc);
    13â†’  }, [onClose]);
    14â†’
    15â†’  return (
    16â†’    <div className="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center" onClick={onClose}>
    17â†’      <button
    18â†’        className="absolute top-4 right-4 btn btn-circle btn-ghost text-white"
    19â†’        onClick={onClose}
    20â†’      >
    21â†’        âœ•
    22â†’      </button>
    23â†’      <img
    24â†’        src={src}
    25â†’        alt={alt}
    26â†’        className="max-w-[90vw] max-h-[90vh] object-contain"
    27â†’        onClick={(e) => e.stopPropagation()}
    28â†’      />
    29â†’      <div className="absolute bottom-4 flex gap-2">
    30â†’        <a
    31â†’          href={src}
    32â†’          download
    33â†’          className="btn btn-primary"
    34â†’          onClick={(e) => e.stopPropagation()}
    35â†’        >
    36â†’          <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    37â†’            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    38â†’          </svg>
    39â†’          Download
    40â†’        </a>
    41â†’        <a
    42â†’          href={src}
    43â†’          target="_blank"
    44â†’          rel="noopener noreferrer"
    45â†’          className="btn btn-ghost text-white"
    46â†’          onClick={(e) => e.stopPropagation()}
    47â†’        >
    48â†’          Open in new tab
    49â†’        </a>
    50â†’      </div>
    51â†’    </div>
    52â†’  );
    53â†’}
    54â†’
    55â†’// Check if a URL points to an image
    56â†’function isImageUrl(url) {
    57â†’  if (!url) return false;
    58â†’  const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
    59â†’  const lowerUrl = url.toLowerCase();
    60â†’  return imageExtensions.some(ext => lowerUrl.includes(ext)) ||
    61â†’         lowerUrl.includes('image') ||
    62â†’         lowerUrl.includes('/images/');
    63â†’}
    64â†’
    65â†’export default function SubmissionDrawer({ submissionId, onClose }) {
    66â†’  const [data, setData] = useState(null);
    67â†’  const [isLoading, setIsLoading] = useState(true);
    68â†’  const [lightboxImage, setLightboxImage] = useState(null);
    69â†’
    70â†’  useEffect(() => {
    71â†’    loadSubmission();
    72â†’  }, [submissionId]);
    73â†’
    74â†’  const loadSubmission = async () => {
    75â†’    try {
    76â†’      const res = await fetch(`/api/forms/submissions/${submissionId}`);
    77â†’      const result = await res.json();
    78â†’      setData(result);
    79â†’      setIsLoading(false);
    80â†’    } catch (error) {
    81â†’      console.error("Failed to load submission:", error);
    82â†’      setIsLoading(false);
    83â†’    }
    84â†’  };
    85â†’
    86â†’  const formatFieldValue = (value, fieldName) => {
    87â†’    if (value === null || value === undefined) return "â€”";
    88â†’    if (typeof value === "boolean") return value ? "Yes" : "No";
    89â†’    // Check if this is a signature (base64 image data)
    90â†’    if (typeof value === "string" && value.startsWith("data:image")) {
    91â†’      return (
    92â†’        <img
    93â†’          src={value}
    94â†’          alt="Signature"
    95â†’          className="max-h-24 bg-white border border-base-300 rounded p-2 cursor-pointer"
    96â†’          onClick={() => setLightboxImage({ src: value, alt: fieldName || "Signature" })}
    97â†’        />
    98â†’      );
    99â†’    }
   100â†’
   101â†’    // Handle issues - can be array or JSON string
   102â†’    const lowerName = (fieldName || '').toLowerCase();
   103â†’    if (lowerName === 'issues' || lowerName.includes('issue')) {
   104â†’      // Try to parse if string
   105â†’      let issuesArray = value;
   106â†’      if (typeof value === 'string') {
   107â†’        try {
   108â†’          issuesArray = JSON.parse(value);
   109â†’        } catch {
   110â†’          // Not valid JSON, show as-is if it looks like formatted text
   111â†’          if (value.trim()) return <pre className="whitespace-pre-wrap text-sm text-slate-700">{value}</pre>;
   112â†’          return <span className="text-slate-400 italic">No issues</span>;
   113â†’        }
   114â†’      }
   115â†’
   116â†’      if (!Array.isArray(issuesArray)) {
   117â†’        // Single issue object
   118â†’        if (typeof issuesArray === 'object' && issuesArray !== null) {
   119â†’          issuesArray = [issuesArray];
   120â†’        } else {
   121â†’          return <span className="text-slate-400 italic">Invalid issues format</span>;
   122â†’        }
   123â†’      }
   124â†’
   125â†’      // Filter out resolved/completed issues and empty objects
   126â†’      const resolvedStatuses = ['complete', 'completed', 'resolved', 'done', 'closed'];
   127â†’      const activeIssues = issuesArray.filter(issue => {
   128â†’        if (!issue || typeof issue !== 'object') return false;
   129â†’        if (Object.keys(issue).length === 0) return false; // Skip empty {}
   130â†’        const status = (issue.status || '').toLowerCase();
   131â†’        return !resolvedStatuses.includes(status);
   132â†’      });
   133â†’
   134â†’      if (activeIssues.length === 0) return <span className="text-slate-400 italic">No active issues</span>;
   135â†’
   136â†’      return (
   137â†’        <div className="space-y-3">
   138â†’          {activeIssues.map((issue, idx) => (
   139â†’            <div key={idx} className="p-4 bg-amber-50/50 border border-amber-200 rounded-xl">
   140â†’              <div className="flex items-start gap-3">
   141â†’                <div className="w-6 h-6 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0">
   142â†’                  <span className="text-xs font-bold text-amber-700">{idx + 1}</span>
   143â†’                </div>
   144â†’                <div className="flex-1 min-w-0">
   145â†’                  {/* Category / Subcategory */}
   146â†’                  <div className="flex items-center gap-2 flex-wrap">
   147â†’                    <Badge variant="warning">
   148â†’                      {issue.category || issue.type || 'Issue'}
   149â†’                    </Badge>
   150â†’                    {issue.subcategory && (
   151â†’                      <span className="text-sm text-slate-600">{issue.subcategory}</span>
   152â†’                    )}
   153â†’                  </div>
   154â†’                  {/* Description */}
   155â†’                  {issue.description && (
   156â†’                    <p className="text-sm text-slate-700 mt-2">{issue.description}</p>
   157â†’                  )}
   158â†’                  {/* Action */}
   159â†’                  {issue.actionNeeded && (
   160â†’                    <p className="text-xs text-slate-500 mt-2">
   161â†’                      <span className="font-medium text-slate-600">Action:</span> {issue.actionNeeded}
   162â†’                    </p>
   163â†’                  )}
   164â†’                  {/* Status & Severity badges */}
   165â†’                  <div className="flex items-center gap-2 mt-3 flex-wrap">
   166â†’                    {issue.status && (
   167â†’                      <Badge variant={
   168â†’                        issue.status.toLowerCase() === 'outstanding' ? 'danger' :
   169â†’                        issue.status.toLowerCase() === 'ordered' ? 'warning' :
   170â†’                        issue.status.toLowerCase() === 'in progress' ? 'info' : 'default'
   171â†’                      } size="sm">
   172â†’                        {issue.status}
   173â†’                      </Badge>
   174â†’                    )}
   175â†’                    {issue.severity && (
   176â†’                      <Badge variant={
   177â†’                        issue.severity === 'high' ? 'danger' :
   178â†’                        issue.severity === 'medium' ? 'warning' : 'info'
   179â†’                      } size="sm">
   180â†’                        {issue.severity}
   181â†’                      </Badge>
   182â†’                    )}
   183â†’                  </div>
   184â†’                </div>
   185â†’              </div>
   186â†’            </div>
   187â†’          ))}
   188â†’        </div>
   189â†’      );
   190â†’    }
   191â†’
   192â†’    // Handle photos - can be array of strings, objects, or JSON string
   193â†’    if (lowerName === 'photos' || lowerName.includes('photo') || lowerName.includes('image')) {
   194â†’      // Try to parse if string
   195â†’      let photosArray = value;
   196â†’      if (typeof value === 'string') {
   197â†’        try {
   198â†’          photosArray = JSON.parse(value);
   199â†’        } catch {
   200â†’          // Single URL string
   201â†’          if (value.startsWith('http') || value.startsWith('data:')) {
   202â†’            photosArray = [value];
   203â†’          } else {
   204â†’            return <span className="text-slate-400 italic">No photos</span>;
   205â†’          }
   206â†’        }
   207â†’      }
   208â†’
   209â†’      if (!Array.isArray(photosArray)) {
   210â†’        if (typeof photosArray === 'object' && photosArray !== null && (photosArray.url || photosArray.src)) {
   211â†’          photosArray = [photosArray];
   212â†’        } else {
   213â†’          return <span className="text-slate-400 italic">No photos</span>;
   214â†’        }
   215â†’      }
   216â†’
   217â†’      // Process and filter photos
   218â†’      const validPhotos = photosArray
   219â†’        .map(p => {
   220â†’          // Parse nested JSON strings
   221â†’          if (typeof p === 'string') {
   222â†’            try { p = JSON.parse(p); } catch { /* keep as string */ }
   223â†’          }
   224â†’          return p;
   225â†’        })
   226â†’        .filter(p => {
   227â†’          if (!p) return false;
   228â†’          if (typeof p === 'object' && Object.keys(p).length === 0) return false; // Skip empty {}
   229â†’          // Must have a URL
   230â†’          if (typeof p === 'string') return p.startsWith('http') || p.startsWith('data:');
   231â†’          return p.url || p.src || p.dataUrl;
   232â†’        })
   233â†’        .map(p => {
   234â†’          if (typeof p === 'string') return { url: p };
   235â†’          return { url: p.url || p.src || p.dataUrl, caption: p.filename || p.label || p.category };
   236â†’        });
   237â†’
   238â†’      if (validPhotos.length === 0) return <span className="text-slate-400 italic">No photos</span>;
   239â†’
   240â†’      // Use PhotoGallery component
   241â†’      return <PhotoGallery photos={validPhotos} thumbnailSize="default" showCount={false} />;
   242â†’    }
   243â†’
   244â†’    if (typeof value === "object") return JSON.stringify(value);
   245â†’    return value.toString();
   246â†’  };
   247â†’
   248â†’  return (
   249â†’    <>
   250â†’      {/* Drawer */}
   251â†’      <div className="drawer drawer-end drawer-open">
   252â†’        <input type="checkbox" className="drawer-toggle" />
   253â†’        <div className="drawer-side z-50">
   254â†’          <label className="drawer-overlay bg-black/50 backdrop-blur-sm" onClick={onClose}></label>
   255â†’          <div className="w-full max-w-2xl bg-white min-h-screen flex flex-col">
   256â†’            {/* Header - Sticky */}
   257â†’            <div className="sticky top-0 z-10 bg-white border-b border-slate-200 px-6 py-4">
   258â†’              <div className="flex items-center justify-between">
   259â†’                <h2 className="text-xl font-bold text-slate-900">Form Submission</h2>
   260â†’                <button
   261â†’                  className="p-2 rounded-lg hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition-colors"
   262â†’                  onClick={onClose}
   263â†’                >
   264â†’                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   265â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   266â†’                  </svg>
   267â†’                </button>
   268â†’              </div>
   269â†’            </div>
   270â†’
   271â†’            {/* Content - Scrollable */}
   272â†’            <div className="flex-1 overflow-y-auto p-6">
   273â†’              {isLoading ? (
   274â†’                <div className="flex justify-center py-20">
   275â†’                  <div className="w-8 h-8 border-4 border-violet-200 border-t-violet-600 rounded-full animate-spin"></div>
   276â†’                </div>
   277â†’              ) : !data ? (
   278â†’                <div className="text-center py-20 text-slate-400">
   279â†’                  Failed to load submission
   280â†’                </div>
   281â†’              ) : (
   282â†’              <>
   283â†’                {/* Form Info */}
   284â†’                <Card className="mb-4">
   285â†’                  <CardContent className="pt-4">
   286â†’                    <h3 className="font-bold text-lg text-slate-900">{data.submission.formId?.name}</h3>
   287â†’                    <div className="flex gap-2 items-center mt-2">
   288â†’                      <Badge variant="secondary">{data.submission.formId?.type}</Badge>
   289â†’                      <span className="text-sm text-slate-500">
   290â†’                        {new Date(data.submission.submittedAt).toLocaleString()}
   291â†’                      </span>
   292â†’                    </div>
   293â†’                  </CardContent>
   294â†’                </Card>
   295â†’
   296â†’                {/* Linked Records */}
   297â†’                {(data.submission.linkedVehicleId || data.submission.linkedAftercareCaseId || data.submission.linkedVehicleSaleId) && (
   298â†’                  <Card className="mb-4">
   299â†’                    <CardHeader title="Linked Records" />
   300â†’                    <CardContent>
   301â†’                      <div className="flex flex-wrap gap-2">
   302â†’                        {data.submission.linkedVehicleId && (
   303â†’                          <Link
   304â†’                            href={`/vehicles/${data.submission.linkedVehicleId._id}`}
   305â†’                            className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 hover:border-slate-300 transition-colors"
   306â†’                          >
   307â†’                            <span>ðŸš—</span> Vehicle: {data.submission.linkedVehicleId.regCurrent}
   308â†’                          </Link>
   309â†’                        )}
   310â†’                        {data.submission.linkedAftercareCaseId && (
   311â†’                          <Link
   312â†’                            href={`/warranty/${data.submission.linkedAftercareCaseId._id}`}
   313â†’                            className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 hover:border-slate-300 transition-colors"
   314â†’                          >
   315â†’                            <span>ðŸ”§</span> Aftercare Case
   316â†’                          </Link>
   317â†’                        )}
   318â†’                        {data.submission.linkedVehicleSaleId && (
   319â†’                          <Link
   320â†’                            href={`/sales/${data.submission.linkedVehicleSaleId._id}`}
   321â†’                            className="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-lg border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 hover:border-slate-300 transition-colors"
   322â†’                          >
   323â†’                            <span>ðŸ“„</span> Sale Record
   324â†’                          </Link>
   325â†’                        )}
   326â†’                      </div>
   327â†’                    </CardContent>
   328â†’                  </Card>
   329â†’                )}
   330â†’
   331â†’                {/* Answers */}
   332â†’                <Card className="mb-4">
   333â†’                  <CardHeader title="Answers" />
   334â†’                  <CardContent>
   335â†’                    <div className="space-y-4">
   336â†’                      {Object.entries(data.submission.rawAnswers || {}).map(([key, value]) => {
   337â†’                        // Find the field definition if available
   338â†’                        const field = data.fields?.find(f => f.fieldName === key);
   339â†’                        const label = field?.label || key;
   340â†’
   341â†’                        return (
   342â†’                          <div key={key}>
   343â†’                            <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1.5">
   344â†’                              {label}
   345â†’                            </label>
   346â†’                            <div className="p-3 bg-slate-50 rounded-xl border border-slate-100">
   347â†’                              {formatFieldValue(value, key)}
   348â†’                            </div>
   349â†’                          </div>
   350â†’                        );
   351â†’                      })}
   352â†’                    </div>
   353â†’                  </CardContent>
   354â†’                </Card>
   355â†’
   356â†’                {/* Files */}
   357â†’                {data.files && data.files.length > 0 && (
   358â†’                  <Card>
   359â†’                    <CardHeader title="Uploaded Files" icon="ðŸ“Ž" />
   360â†’                    <CardContent>
   361â†’                      {/* Image files using PhotoGallery */}
   362â†’                      {data.files.filter(f => isImageUrl(f.url)).length > 0 && (
   363â†’                        <div className="mb-4">
   364â†’                          <PhotoGallery
   365â†’                            photos={data.files.filter(f => isImageUrl(f.url)).map(f => ({
   366â†’                              url: f.url,
   367â†’                              caption: f.filename || f.fieldName
   368â†’                            }))}
   369â†’                            thumbnailSize="lg"
   370â†’                            showCount={false}
   371â†’                          />
   372â†’                        </div>
   373â†’                      )}
   374â†’                      {/* List for non-image files */}
   375â†’                      {data.files.filter(f => !isImageUrl(f.url)).length > 0 && (
   376â†’                        <div className="space-y-2">
   377â†’                          {data.files.filter(f => !isImageUrl(f.url)).map((file) => (
   378â†’                            <div key={file._id} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
   379â†’                              <div className="flex items-center gap-3 min-w-0">
   380â†’                                <div className="w-10 h-10 rounded-lg bg-slate-200 flex items-center justify-center flex-shrink-0">
   381â†’                                  <svg className="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   382â†’                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   383â†’                                  </svg>
   384â†’                                </div>
   385â†’                                <div className="min-w-0">
   386â†’                                  <p className="font-semibold text-slate-800 truncate">{file.filename || "File"}</p>
   387â†’                                  <p className="text-xs text-slate-500">
   388â†’                                    {file.fieldName}
   389â†’                                    {file.size && ` â€¢ ${(file.size / 1024).toFixed(1)} KB`}
   390â†’                                  </p>
   391â†’                                </div>
   392â†’                              </div>
   393â†’                              <a
   394â†’                                href={file.url}
   395â†’                                target="_blank"
   396â†’                                rel="noopener noreferrer"
   397â†’                                className="px-3 py-1.5 text-sm font-medium rounded-lg bg-violet-600 text-white hover:bg-violet-700 transition-colors flex-shrink-0"
   398â†’                              >
   399â†’                                Download
   400â†’                              </a>
   401â†’                            </div>
   402â†’                          ))}
   403â†’                        </div>
   404â†’                      )}
   405â†’                    </CardContent>
   406â†’                  </Card>
   407â†’                )}
   408â†’              </>
   409â†’            )}
   410â†’            </div>
   411â†’          </div>
   412â†’        </div>
   413â†’      </div>
   414â†’
   415â†’      {/* Image lightbox */}
   416â†’      {lightboxImage && (
   417â†’        <ImageLightbox
   418â†’          src={lightboxImage.src}
   419â†’          alt={lightboxImage.alt}
   420â†’          onClose={() => setLightboxImage(null)}
   421â†’        />
   422â†’      )}
   423â†’    </>
   424â†’  );
   425â†’}
   426â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
