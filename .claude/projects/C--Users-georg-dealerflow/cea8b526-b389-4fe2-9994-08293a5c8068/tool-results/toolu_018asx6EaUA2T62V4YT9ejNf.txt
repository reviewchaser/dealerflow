   800â†’        // Prep task filters
   801â†’        if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
   802â†’        if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
   803â†’        if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
   804â†’        if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");
   805â†’
   806â†’        // Issue filters
   807â†’        if (filter === "needs_paint") return activeIssues.some(i => {
   808â†’          const cat = (i.category || "").toLowerCase();
   809â†’          return cat === "bodywork" || cat === "cosmetic";
   810â†’        });
   811â†’        if (filter === "needs_mechanical") return activeIssues.some(i => {
   812â†’          const cat = (i.category || "").toLowerCase();
   813â†’          return cat === "mechanical";
   814â†’        });
   815â†’        if (filter === "needs_electrical") return activeIssues.some(i => {
   816â†’          const cat = (i.category || "").toLowerCase();
   817â†’          return cat === "electrical";
   818â†’        });
   819â†’
   820â†’        // Location filter
   821â†’        if (filter === "offsite") return vehicle.locationId != null;
   822â†’
   823â†’        // MOT filters
   824â†’        if (filter === "mot_due_soon") {
   825â†’          if (!vehicle.motExpiryDate) return false;
   826â†’          const expiry = new Date(vehicle.motExpiryDate);
   827â†’          const now = new Date();
   828â†’          const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
   829â†’          return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
   830â†’        }
   831â†’        if (filter === "mot_expired") {
   832â†’          if (!vehicle.motExpiryDate) return false;
   833â†’          const expiry = new Date(vehicle.motExpiryDate);
   834â†’          const now = new Date();
   835â†’          return expiry < now;
   836â†’        }
   837â†’
   838â†’        // Sale type filters
   839â†’        if (filter === "trade_only") return vehicle.saleType === "TRADE";
   840â†’        if (filter === "retail_only") return vehicle.saleType === "RETAIL" || !vehicle.saleType;
   841â†’
   842â†’        // Vehicle type filters
   843â†’        if (filter === "type_stock") return vehicle.type === "STOCK" || !vehicle.type;
   844â†’        if (filter === "type_courtesy") return vehicle.type === "COURTESY";
   845â†’        if (filter === "type_fleet") return vehicle.type === "FLEET_OTHER";
   846â†’
   847â†’        return true;
   848â†’      });
   849â†’    });
   850â†’  };
   851â†’
   852â†’  const getVehiclesByStatus = (status) => {
   853â†’    const statusVehicles = vehicles.filter(v => v.status === status);
   854â†’    const filtered = getFilteredVehicles(statusVehicles);
   855â†’
   856â†’    // Apply sorting based on columnSortOptions
   857â†’    const sortOption = columnSortOptions[status] || "oldest_first";
   858â†’
   859â†’    return [...filtered].sort((a, b) => {
   860â†’      const daysA = a.createdAt ? Math.floor((new Date() - new Date(a.createdAt)) / (1000 * 60 * 60 * 24)) : 0;
   861â†’      const daysB = b.createdAt ? Math.floor((new Date() - new Date(b.createdAt)) / (1000 * 60 * 60 * 24)) : 0;
   862â†’
   863â†’      switch (sortOption) {
   864â†’        case "oldest_first":
   865â†’          return daysB - daysA; // More days = older = first
   866â†’        case "newest_first":
   867â†’          return daysA - daysB; // Fewer days = newer = first
   868â†’        case "alphabetical":
   869â†’          const nameA = `${a.make || ""} ${a.model || ""}`.toLowerCase();
   870â†’          const nameB = `${b.make || ""} ${b.model || ""}`.toLowerCase();
   871â†’          return nameA.localeCompare(nameB);
   872â†’        default:
   873â†’          return daysB - daysA;
   874â†’      }
   875â†’    });
   876â†’  };
   877â†’
   878â†’  const getFilterCount = (filter) => {
   879â†’    const allFiltered = getFilteredVehicles(vehicles.filter(v => {
   880â†’      const tasks = v.tasks || [];
   881â†’      const issues = v.issues || [];
   882â†’      const activeIssues = issues.filter(i => {
   883â†’        const status = (i.status || "").toLowerCase();
   884â†’        return ["outstanding", "ordered", "in progress", "in_progress"].includes(status);
   885â†’      });
   886â†’
   887â†’      if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
   888â†’      if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
   889â†’      if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
   890â†’      if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");
   891â†’      if (filter === "needs_paint") return activeIssues.some(i => {
   892â†’        const cat = (i.category || "").toLowerCase();
   893â†’        return cat === "bodywork" || cat === "cosmetic";
   894â†’      });
   895â†’      if (filter === "needs_mechanical") return activeIssues.some(i => {
   896â†’        const cat = (i.category || "").toLowerCase();
   897â†’        return cat === "mechanical";
   898â†’      });
   899â†’      if (filter === "needs_electrical") return activeIssues.some(i => {
   900â†’        const cat = (i.category || "").toLowerCase();
   901â†’        return cat === "electrical";
   902â†’      });
   903â†’      if (filter === "offsite") return v.locationId != null;
   904â†’      if (filter === "mot_due_soon") {
   905â†’        if (!v.motExpiryDate) return false;
   906â†’        const expiry = new Date(v.motExpiryDate);
   907â†’        const now = new Date();
   908â†’        const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
   909â†’        return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
   910â†’      }
   911â†’      if (filter === "mot_expired") {
   912â†’        if (!v.motExpiryDate) return false;
   913â†’        const expiry = new Date(v.motExpiryDate);
   914â†’        return expiry < new Date();
   915â†’      }
   916â†’      if (filter === "trade_only") return v.saleType === "TRADE";
   917â†’      if (filter === "retail_only") return v.saleType === "RETAIL" || !v.saleType;
   918â†’      if (filter === "type_stock") return v.type === "STOCK" || !v.type;
   919â†’      if (filter === "type_courtesy") return v.type === "COURTESY";
   920â†’      if (filter === "type_fleet") return v.type === "FLEET_OTHER";
   921â†’      return false;
   922â†’    }));
   923â†’    return allFiltered.length;
   924â†’  };
   925â†’
   926â†’  // VRM Search functions
   927â†’  const getVrmSearchResults = () => {
   928â†’    if (vrmSearch.length < 2) return [];
   929â†’    const searchTerm = vrmSearch.toUpperCase().replace(/\s/g, "");
   930â†’    return vehicles.filter(v => {
   931â†’      const reg = (v.regCurrent || "").toUpperCase().replace(/\s/g, "");
   932â†’      return reg.includes(searchTerm);
   933â†’    }).slice(0, 8); // Limit to 8 results
   934â†’  };
   935â†’
   936â†’  const handleVrmSelect = (vehicle) => {
   937â†’    // Close dropdown and clear search
   938â†’    setVrmSearch("");
   939â†’    setShowVrmDropdown(false);
   940â†’
   941â†’    // Find which column this vehicle is in and scroll to it
   942â†’    const columnIndex = COLUMNS.findIndex(col => col.key === vehicle.status);
   943â†’    if (columnIndex >= 0) {
   944â†’      // Scroll the column into view
   945â†’      const columnElements = document.querySelectorAll('[data-column-key]');
   946â†’      if (columnElements[columnIndex]) {
   947â†’        columnElements[columnIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
   948â†’      }
   949â†’    }
   950â†’
   951â†’    // Open the vehicle drawer with full details
   952â†’    openVehicleDrawer(vehicle);
   953â†’  };
   954â†’
   955â†’  const getStatusLabel = (statusKey) => {
   956â†’    const col = COLUMNS.find(c => c.key === statusKey);
   957â†’    return col ? col.label : statusKey;
   958â†’  };
   959â†’
   960â†’  const handlePrintVehicle = () => {
   961â†’    if (!selectedVehicle) return;
   962â†’
   963â†’    const vehicle = selectedVehicle;
   964â†’    const tasks = vehicle.tasks || [];
   965â†’    const issues = vehicle.issues || [];
   966â†’    const documents = vehicle.documents || [];
   967â†’    const completedTasks = tasks.filter(t => t.status === "done").length;
   968â†’    const daysInStock = vehicle.createdAt
   969â†’      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
   970â†’      : 0;
   971â†’
   972â†’    // Get status label from COLUMNS
   973â†’    const statusColumn = COLUMNS.find(col => col.key === vehicle.status);
   974â†’    const statusLabel = statusColumn ? statusColumn.label : vehicle.status;
   975â†’
   976â†’    // Generate HTML for print
   977â†’    const printContent = `
   978â†’<!DOCTYPE html>
   979â†’<html>
   980â†’<head>
   981â†’  <title>${vehicle.year || ""} ${vehicle.make} ${vehicle.model} - ${vehicle.regCurrent}</title>
   982â†’  <style>
   983â†’    * { margin: 0; padding: 0; box-sizing: border-box; }
   984â†’    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }
   985â†’    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
   986â†’    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
   987â†’    .reg { font-size: 18px; font-family: monospace; color: #64748b; }
   988â†’    .section { margin-bottom: 30px; }
   989â†’    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
   990â†’    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
   991â†’    .field { margin-bottom: 12px; }
   992â†’    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
   993â†’    .field-value { font-size: 14px; color: #1e293b; }
   994â†’    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
   995â†’    .badge-status { background: #e0e7ff; color: #4338ca; }
   996â†’    .badge-days { background: ${daysInStock > 30 ? '#fef2f2' : '#f1f5f9'}; color: ${daysInStock > 30 ? '#dc2626' : '#475569'}; }
   997â†’    .task-list { list-style: none; }
   998â†’    .task-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
   999â†’    .task-status { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
  1000â†’    .task-done { background: #dcfce7; color: #16a34a; }
  1001â†’    .task-pending { background: #fef3c7; color: #d97706; }
  1002â†’    .task-progress { background: #dbeafe; color: #2563eb; }
  1003â†’    .issue-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
  1004â†’    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; }
  1005â†’    .issue-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
  1006â†’    .issue-desc { font-size: 14px; color: #1e293b; }
  1007â†’    .doc-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
  1008â†’    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }
  1009â†’    @media print {
  1010â†’      body { padding: 20px; }
  1011â†’      .no-print { display: none; }
  1012â†’    }
  1013â†’  </style>
  1014â†’</head>
  1015â†’<body>
  1016â†’  <div class="header">
  1017â†’    <div class="title">${vehicle.year || ""} ${vehicle.make} ${vehicle.model}</div>
  1018â†’    <div class="reg">${vehicle.regCurrent}</div>
  1019â†’  </div>
  1020â†’
  1021â†’  <div class="section">
  1022â†’    <div class="section-title">Overview</div>
  1023â†’    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
  1024â†’      <span class="badge badge-status">${statusLabel}</span>
  1025â†’      <span class="badge badge-days">Days in Stock: ${daysInStock}</span>
  1026â†’      ${vehicle.locationId ? `<span class="badge" style="background:#eef2ff;color:#4f46e5;">ğŸ“ ${vehicle.locationId.name || 'Offsite'}</span>` : '<span class="badge" style="background:#f0fdf4;color:#16a34a;">ğŸ“ On Site</span>'}
  1027â†’    </div>
  1028â†’  </div>
  1029â†’
  1030â†’  <div class="section">
  1031â†’    <div class="section-title">Vehicle Details</div>
  1032â†’    <div class="grid">
  1033â†’      <div class="field">
  1034â†’        <div class="field-label">Registration</div>
  1035â†’        <div class="field-value">${vehicle.regCurrent || 'â€”'}</div>
  1036â†’      </div>
  1037â†’      <div class="field">
  1038â†’        <div class="field-label">VIN</div>
  1039â†’        <div class="field-value">${vehicle.vin || 'â€”'}</div>
  1040â†’      </div>
  1041â†’      <div class="field">
  1042â†’        <div class="field-label">Make</div>
  1043â†’        <div class="field-value">${vehicle.make || 'â€”'}</div>
  1044â†’      </div>
  1045â†’      <div class="field">
  1046â†’        <div class="field-label">Model</div>
  1047â†’        <div class="field-value">${vehicle.model || 'â€”'}</div>
  1048â†’      </div>
  1049â†’      <div class="field">
  1050â†’        <div class="field-label">Year</div>
  1051â†’        <div class="field-value">${vehicle.year || 'â€”'}</div>
  1052â†’      </div>
  1053â†’      <div class="field">
  1054â†’        <div class="field-label">Mileage</div>
  1055â†’        <div class="field-value">${vehicle.mileageCurrent ? vehicle.mileageCurrent.toLocaleString() + ' miles' : 'â€”'}</div>
  1056â†’      </div>
  1057â†’      <div class="field">
  1058â†’        <div class="field-label">Colour</div>
  1059â†’        <div class="field-value">${vehicle.colour || 'â€”'}</div>
  1060â†’      </div>
  1061â†’      <div class="field">
  1062â†’        <div class="field-label">Fuel Type</div>
  1063â†’        <div class="field-value">${vehicle.fuelType || 'â€”'}</div>
  1064â†’      </div>
  1065â†’      <div class="field">
  1066â†’        <div class="field-label">MOT Expiry</div>
  1067â†’        <div class="field-value">${vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : 'â€”'}</div>
  1068â†’      </div>
  1069â†’    </div>
  1070â†’  </div>
  1071â†’
  1072â†’  <div class="section">
  1073â†’    <div class="section-title">Prep Checklist (${completedTasks}/${tasks.length} complete)</div>
  1074â†’    ${tasks.length > 0 ? `
  1075â†’    <ul class="task-list">
  1076â†’      ${tasks.map(task => `
  1077â†’        <li class="task-item">
  1078â†’          <span class="task-status ${task.status === 'done' ? 'task-done' : task.status === 'in_progress' ? 'task-progress' : 'task-pending'}">
  1079â†’            ${task.status === 'done' ? 'âœ“' : task.status === 'in_progress' ? 'â†’' : 'â—‹'}
  1080â†’          </span>
  1081â†’          <span style="${task.status === 'done' ? 'text-decoration: line-through; color: #94a3b8;' : ''}">${task.name}</span>
  1082â†’          ${task.completedAt ? `<span style="font-size: 11px; color: #94a3b8; margin-left: auto;">${new Date(task.completedAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</span>` : ''}
  1083â†’        </li>
  1084â†’      `).join('')}
  1085â†’    </ul>
  1086â†’    ` : '<p style="color: #94a3b8; font-size: 14px;">No tasks</p>'}
  1087â†’  </div>
  1088â†’
  1089â†’  <div class="section">
  1090â†’    <div class="section-title">Issues (${issues.length})</div>
  1091â†’    ${issues.length > 0 ? issues.map(issue => `
  1092â†’      <div class="issue-card">
  1093â†’        <div class="issue-header">
  1094â†’          <span class="issue-badge">${issue.category}</span>
  1095â†’          ${issue.subcategory ? `<span class="issue-badge">${issue.subcategory}</span>` : ''}
  1096â†’          <span class="issue-badge" style="margin-left: auto;">${issue.status || 'Outstanding'}</span>
  1097â†’        </div>
  1098â†’        <div class="issue-desc">${issue.description}</div>
  1099â†’        ${issue.actionNeeded ? `<div style="font-size: 12px; color: #64748b; margin-top: 6px;">Action: ${issue.actionNeeded}</div>` : ''}
  1100â†’      </div>
  1101â†’    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No issues recorded</p>'}
  1102â†’  </div>
  1103â†’
  1104â†’  <div class="section">
  1105â†’    <div class="section-title">Documents (${documents.length})</div>
  1106â†’    ${documents.length > 0 ? documents.map(doc => `
  1107â†’      <div class="doc-item">
  1108â†’        <span style="font-weight: 500;">${doc.name}</span>
  1109â†’        <span style="font-size: 12px; color: #94a3b8; margin-left: 8px;">(${doc.type.replace(/_/g, ' ')})</span>
  1110â†’      </div>
  1111â†’    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No documents uploaded</p>'}
  1112â†’    ${vehicle.v5Url ? '<div class="doc-item"><span style="font-weight: 500;">V5 Document</span> <span style="font-size: 12px; color: #16a34a;">âœ“ Uploaded</span></div>' : ''}
  1113â†’  </div>
  1114â†’
  1115â†’  ${vehicle.notes ? `
  1116â†’  <div class="section">
  1117â†’    <div class="section-title">Notes</div>
  1118â†’    <p style="font-size: 14px; white-space: pre-wrap;">${vehicle.notes}</p>
  1119â†’  </div>
  1120â†’  ` : ''}
  1121â†’
  1122â†’  <div class="footer">
  1123â†’    Printed from DealerFlow on ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
  1124â†’  </div>
  1125â†’</body>
  1126â†’</html>
  1127â†’    `;
  1128â†’
  1129â†’    // Open in new tab
  1130â†’    const printWindow = window.open('', '_blank');
  1131â†’    printWindow.document.write(printContent);
  1132â†’    printWindow.document.close();
  1133â†’  };
  1134â†’
  1135â†’  // Share utility with fallback chain: Web Share API â†’ Clipboard â†’ Manual modal
  1136â†’  // SSR-safe: only runs client-side, with guards for browser API availability
  1137â†’  const shareWithFallback = async (url, title, text) => {
  1138â†’    // Guard against SSR - this should only run client-side
  1139â†’    if (typeof window === "undefined" || typeof navigator === "undefined") {
  1140â†’      return false;
  1141â†’    }
  1142â†’
  1143â†’    // 1. Try Web Share API (native sharing on mobile/supported browsers)
  1144â†’    if (typeof navigator.share === "function") {
  1145â†’      try {
  1146â†’        await navigator.share({ title, text, url });
  1147â†’        return true;
  1148â†’      } catch (error) {
  1149â†’        // User cancelled or share failed - continue to fallback
  1150â†’        if (error.name !== "AbortError") {
  1151â†’          console.log("Web Share API failed, trying clipboard fallback");
  1152â†’        }
  1153â†’      }
  1154â†’    }
  1155â†’
  1156â†’    // 2. Try Clipboard API
  1157â†’    if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
  1158â†’      try {
  1159â†’        await navigator.clipboard.writeText(url);
  1160â†’        toast.success("Link copied to clipboard!");
  1161â†’        return true;
  1162â†’      } catch (error) {
  1163â†’        console.log("Clipboard API failed, showing manual modal");
  1164â†’      }
  1165â†’    }
  1166â†’
  1167â†’    // 3. Fallback to manual modal
  1168â†’    setManualShareUrl(url);
  1169â†’    setShowManualShareModal(true);
  1170â†’    return false;
  1171â†’  };
  1172â†’
  1173â†’  // Job sheet share handlers
  1174â†’  const handleGenerateJobSheet = async () => {
  1175â†’    if (!selectedVehicle) return;
  1176â†’    setIsGeneratingJobSheet(true);
  1177â†’    try {
  1178â†’      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/job-sheet`, {
  1179â†’        method: "POST",
  1180â†’        headers: { "Content-Type": "application/json" },
  1181â†’        body: JSON.stringify({ expiresInDays: 60 }),
  1182â†’      });
  1183â†’      if (!res.ok) throw new Error("Failed to generate share link");
  1184â†’      const data = await res.json();
  1185â†’      const fullUrl = `${window.location.origin}${data.shareUrl}`;
  1186â†’      setJobSheetLink({
  1187â†’        url: fullUrl,
  1188â†’        expiresAt: data.expiresAt,
  1189â†’      });
  1190â†’      setShowJobSheetModal(true);
  1191â†’    } catch (error) {
  1192â†’      toast.error(error.message);
  1193â†’    } finally {
  1194â†’      setIsGeneratingJobSheet(false);
  1195â†’    }
  1196â†’  };
  1197â†’
  1198â†’  const copyJobSheetLink = async () => {
  1199â†’    if (jobSheetLink?.url) {

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
