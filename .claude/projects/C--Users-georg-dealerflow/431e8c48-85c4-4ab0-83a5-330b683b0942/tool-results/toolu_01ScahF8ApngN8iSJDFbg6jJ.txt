     1â†’import { useEffect, useState } from "react";
     2â†’import Head from "next/head";
     3â†’import Link from "next/link";
     4â†’import { useRouter } from "next/router";
     5â†’import { useSession } from "next-auth/react";
     6â†’import DashboardLayout from "@/components/DashboardLayout";
     7â†’import StatsCard from "@/components/StatsCard";
     8â†’
     9â†’// Human-readable form type labels
    10â†’const FORM_TYPE_LABELS = {
    11â†’  PDI: "PDI",
    12â†’  TEST_DRIVE: "Test Drive",
    13â†’  WARRANTY_CLAIM: "Warranty Claim",
    14â†’  COURTESY_OUT: "Courtesy Out",
    15â†’  COURTESY_IN: "Courtesy In",
    16â†’  SERVICE_RECEIPT: "Service",
    17â†’  REVIEW_FEEDBACK: "Feedback",
    18â†’  OTHER: "Other",
    19â†’};
    20â†’
    21â†’// Default priority forms - PDI is always first as it's the most common daily task
    22â†’const DEFAULT_PRIORITY_FORM_TYPES = ["PDI", "TEST_DRIVE", "DELIVERY"];
    23â†’const ALWAYS_FIRST_FORM_TYPE = "PDI";
    24â†’
    25â†’// Needs Attention item configurations
    26â†’const NEEDS_ATTENTION_ITEMS = [
    27â†’  {
    28â†’    key: "soldInProgress",
    29â†’    label: "Sold in progress",
    30â†’    href: "/sales-prep",
    31â†’    color: "warning",
    32â†’    icon: (
    33â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    34â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
    35â†’      </svg>
    36â†’    ),
    37â†’    description: "vehicles awaiting delivery"
    38â†’  },
    39â†’  {
    40â†’    key: "warrantyNotBookedIn",
    41â†’    label: "Warranty not booked in",
    42â†’    href: "/warranty",
    43â†’    color: "danger",
    44â†’    icon: (
    45â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    46â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    47â†’      </svg>
    48â†’    ),
    49â†’    description: "cases need scheduling"
    50â†’  },
    51â†’  {
    52â†’    key: "eventsToday",
    53â†’    label: "Events today",
    54â†’    href: "/calendar",
    55â†’    color: "info",
    56â†’    icon: (
    57â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    58â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
    59â†’      </svg>
    60â†’    ),
    61â†’    description: "on your calendar"
    62â†’  },
    63â†’  {
    64â†’    key: "courtesyDueBack",
    65â†’    label: "Courtesy due back",
    66â†’    href: "/warranty",
    67â†’    color: "warning",
    68â†’    icon: (
    69â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    70â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
    71â†’      </svg>
    72â†’    ),
    73â†’    description: "vehicles due today or overdue"
    74â†’  },
    75â†’  {
    76â†’    key: "motExpiringSoon",
    77â†’    label: "MOT expiring soon",
    78â†’    href: "/sales-prep",
    79â†’    color: "danger",
    80â†’    icon: (
    81â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    82â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
    83â†’      </svg>
    84â†’    ),
    85â†’    description: "within 14 days"
    86â†’  }
    87â†’];
    88â†’
    89â†’// Color mappings for needs attention
    90â†’const ATTENTION_COLORS = {
    91â†’  warning: {
    92â†’    bg: "bg-gradient-to-br from-amber-50 to-orange-50",
    93â†’    border: "border-amber-200",
    94â†’    icon: "bg-amber-100 text-amber-600",
    95â†’    badge: "bg-amber-500 text-white",
    96â†’    text: "text-amber-900"
    97â†’  },
    98â†’  danger: {
    99â†’    bg: "bg-gradient-to-br from-red-50 to-rose-50",
   100â†’    border: "border-red-200",
   101â†’    icon: "bg-red-100 text-red-600",
   102â†’    badge: "bg-red-500 text-white",
   103â†’    text: "text-red-900"
   104â†’  },
   105â†’  info: {
   106â†’    bg: "bg-gradient-to-br from-blue-50 to-cyan-50",
   107â†’    border: "border-blue-200",
   108â†’    icon: "bg-blue-100 text-blue-600",
   109â†’    badge: "bg-blue-500 text-white",
   110â†’    text: "text-blue-900"
   111â†’  }
   112â†’};
   113â†’
   114â†’export default function Dashboard() {
   115â†’  const router = useRouter();
   116â†’  const { data: session } = useSession();
   117â†’  const [stats, setStats] = useState(null);
   118â†’  const [forms, setForms] = useState([]);
   119â†’  const [isLoading, setIsLoading] = useState(true);
   120â†’  const [isRedirecting, setIsRedirecting] = useState(false);
   121â†’
   122â†’  // Check if we should redirect to tenant URL (legacy route access)
   123â†’  useEffect(() => {
   124â†’    async function checkForTenantRedirect() {
   125â†’      // Skip if already on a tenant route
   126â†’      if (router.asPath.startsWith("/app/")) return;
   127â†’
   128â†’      try {
   129â†’        const res = await fetch("/api/dealers/memberships");
   130â†’        if (!res.ok) return;
   131â†’
   132â†’        const dealers = await res.json();
   133â†’
   134â†’        if (dealers.length === 0) {
   135â†’          // No dealers - redirect to create dealer
   136â†’          router.push("/onboarding/create-dealer");
   137â†’          return;
   138â†’        }
   139â†’
   140â†’        if (dealers.length === 1) {
   141â†’          // Single dealer - redirect to tenant route
   142â†’          setIsRedirecting(true);
   143â†’          router.replace(`/app/${dealers[0].slug}/dashboard`);
   144â†’          return;
   145â†’        }
   146â†’
   147â†’        if (dealers.length > 1) {
   148â†’          // Multiple dealers - show picker
   149â†’          setIsRedirecting(true);
   150â†’          router.push("/choose-dealer");
   151â†’          return;
   152â†’        }
   153â†’      } catch (err) {
   154â†’        console.error("Error checking dealer redirect:", err);
   155â†’      }
   156â†’    }
   157â†’
   158â†’    if (session) {
   159â†’      checkForTenantRedirect();
   160â†’    }
   161â†’  }, [session, router]);
   162â†’
   163â†’  const defaultStats = {
   164â†’    appraisals: { total: 0, pending: 0 },
   165â†’    vehicles: { total: 0, inStock: 0, inPrep: 0, live: 0, delivered: 0 },
   166â†’    aftercare: { total: 0, open: 0 },
   167â†’    reviews: { count: 0, avgRating: "N/A", lastReviewDays: null },
   168â†’    forms: { total: 0, submissions: 0 },
   169â†’    recent: { appraisals: [], vehicles: [], formSubmissions: [] },
   170â†’    needsAttention: { soldInProgress: 0, warrantyNotBookedIn: 0, eventsToday: 0, courtesyDueBack: 0, motExpiringSoon: 0 },
   171â†’    today: { events: 0, deliveries: 0, testDrives: 0, courtesyDueBack: 0 },
   172â†’    topForms: [],
   173â†’    oldestAppraisalDays: null,
   174â†’  };
   175â†’
   176â†’  useEffect(() => {
   177â†’    const safeJsonParse = async (res) => {
   178â†’      const contentType = res.headers.get("content-type") || "";
   179â†’      if (!contentType.includes("application/json")) {
   180â†’        console.error("[Dashboard] Non-JSON response:", res.status, contentType);
   181â†’        return null;
   182â†’      }
   183â†’      return res.json();
   184â†’    };
   185â†’
   186â†’    fetch("/api/dashboard/stats")
   187â†’      .then(async (res) => {
   188â†’        if (res.status === 403) return { error: "No dealer context" };
   189â†’        if (!res.ok) return { error: "Failed to fetch stats" };
   190â†’        return await safeJsonParse(res) || { error: "Invalid response" };
   191â†’      })
   192â†’      .then((statsData) => {
   193â†’        if (statsData?.error) {
   194â†’          console.error("Dashboard stats error:", statsData.error);
   195â†’          setStats(defaultStats);
   196â†’          setForms([]);
   197â†’        } else {
   198â†’          setStats(statsData || defaultStats);
   199â†’          setForms(Array.isArray(statsData?.formsList) ? statsData.formsList : []);
   200â†’        }
   201â†’        setIsLoading(false);
   202â†’      })
   203â†’      .catch((err) => {
   204â†’        console.error("Dashboard fetch error:", err);
   205â†’        setStats(defaultStats);
   206â†’        setForms([]);
   207â†’        setIsLoading(false);
   208â†’      });
   209â†’  }, []);
   210â†’
   211â†’  const handleFormClick = (form) => {
   212â†’    if (form.isPublic && form.publicSlug) {
   213â†’      window.open(`/public/forms/${form.publicSlug}`, '_blank');
   214â†’    } else {
   215â†’      router.push(`/forms/fill/${form.id || form._id}`);
   216â†’    }
   217â†’  };
   218â†’
   219â†’  const getTopForms = () => {
   220â†’    const pdiForm = forms.find(f => f.type === ALWAYS_FIRST_FORM_TYPE);
   221â†’    let otherTopForms = [];
   222â†’    if (stats?.topForms?.length > 0) {
   223â†’      otherTopForms = stats.topForms
   224â†’        .map(tf => forms.find(f => (f.id || f._id?.toString?.() || f._id) === (tf.formId?.toString?.() || tf.formId)))
   225â†’        .filter(f => f && f.type !== ALWAYS_FIRST_FORM_TYPE)
   226â†’        .slice(0, 2);
   227â†’    } else {
   228â†’      otherTopForms = forms.filter(f => DEFAULT_PRIORITY_FORM_TYPES.includes(f.type) && f.type !== ALWAYS_FIRST_FORM_TYPE).slice(0, 2);
   229â†’    }
   230â†’    return pdiForm ? [pdiForm, ...otherTopForms] : otherTopForms;
   231â†’  };
   232â†’
   233â†’  const topForms = getTopForms();
   234â†’  const otherForms = forms.filter(f => !topForms.find(tf => (tf.id || tf._id?.toString?.() || tf._id) === (f.id || f._id?.toString?.() || f._id)));
   235â†’
   236â†’  const activeNeedsAttention = NEEDS_ATTENTION_ITEMS.filter(item =>
   237â†’    stats?.needsAttention?.[item.key] > 0
   238â†’  );
   239â†’
   240â†’  const hasTodayData = stats?.today && (
   241â†’    stats.today.events > 0 ||
   242â†’    stats.today.deliveries > 0 ||
   243â†’    stats.today.testDrives > 0 ||
   244â†’    stats.today.courtesyDueBack > 0
   245â†’  );
   246â†’
   247â†’  return (
   248â†’    <DashboardLayout>
   249â†’      <Head><title>Dashboard | DealerFlow</title></Head>
   250â†’
   251â†’      {/* Hero Header with Rich Gradient */}
   252â†’      <div className="relative -mx-4 -mt-4 md:-mx-6 md:-mt-6 px-4 md:px-6 pt-8 pb-10 mb-8 hero-gradient border-b border-slate-200/50">
   253â†’        <div className="max-w-7xl mx-auto">
   254â†’          <div className="flex items-start justify-between">
   255â†’            <div>
   256â†’              <h1 className="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">
   257â†’                Good {new Date().getHours() < 12 ? 'morning' : new Date().getHours() < 17 ? 'afternoon' : 'evening'}
   258â†’              </h1>
   259â†’              <p className="text-slate-600 mt-1.5 text-base">Here's what's happening with your dealership today</p>
   260â†’            </div>
   261â†’            <div className="hidden md:flex items-center gap-3">
   262â†’              <div className="text-right">
   263â†’                <p className="text-sm font-bold text-slate-800">
   264â†’                  {new Date().toLocaleDateString('en-GB', { weekday: 'long' })}
   265â†’                </p>
   266â†’                <p className="text-xs text-slate-500">
   267â†’                  {new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
   268â†’                </p>
   269â†’              </div>
   270â†’              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-[#0066CC] to-[#14B8A6] flex items-center justify-center text-white shadow-lg">
   271â†’                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   272â†’                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
   273â†’                </svg>
   274â†’              </div>
   275â†’            </div>
   276â†’          </div>
   277â†’
   278â†’          {/* Today's Activity Pills */}
   279â†’          {hasTodayData && (
   280â†’            <div className="mt-6 flex items-center gap-3 flex-wrap">
   281â†’              <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Today</span>
   282â†’              <div className="h-4 w-px bg-slate-300" />
   283â†’              <div className="flex items-center gap-2 flex-wrap">
   284â†’                {(stats?.today?.events ?? 0) > 0 && (
   285â†’                  <Link href="/calendar" className="inline-flex items-center gap-2 px-4 py-2 bg-white border border-[#0066CC]/20 text-[#0066CC] rounded-xl text-sm font-semibold hover:bg-[#0066CC]/5 hover:border-[#0066CC]/40 transition-all shadow-sm">
   286â†’                    <span className="w-2.5 h-2.5 rounded-full bg-[#0066CC] animate-pulse" />
   287â†’                    {stats.today.events} event{stats.today.events !== 1 ? "s" : ""}
   288â†’                  </Link>
   289â†’                )}
   290â†’                {(stats?.today?.deliveries ?? 0) > 0 && (
   291â†’                  <Link href="/calendar" className="inline-flex items-center gap-2 px-4 py-2 bg-white border border-emerald-200 text-emerald-700 rounded-xl text-sm font-semibold hover:bg-emerald-50 transition-all shadow-sm">
   292â†’                    <span className="w-2.5 h-2.5 rounded-full bg-emerald-500" />
   293â†’                    {stats.today.deliveries} deliver{stats.today.deliveries !== 1 ? "ies" : "y"}
   294â†’                  </Link>
   295â†’                )}
   296â†’                {(stats?.today?.testDrives ?? 0) > 0 && (
   297â†’                  <Link href="/calendar" className="inline-flex items-center gap-2 px-4 py-2 bg-white border border-cyan-200 text-cyan-700 rounded-xl text-sm font-semibold hover:bg-cyan-50 transition-all shadow-sm">
   298â†’                    <span className="w-2.5 h-2.5 rounded-full bg-cyan-500" />
   299â†’                    {stats.today.testDrives} test drive{stats.today.testDrives !== 1 ? "s" : ""}
   300â†’                  </Link>
   301â†’                )}
   302â†’                {(stats?.today?.courtesyDueBack ?? 0) > 0 && (
   303â†’                  <Link href="/warranty" className="inline-flex items-center gap-2 px-4 py-2 bg-white border border-amber-200 text-amber-700 rounded-xl text-sm font-semibold hover:bg-amber-50 transition-all shadow-sm">
   304â†’                    <span className="w-2.5 h-2.5 rounded-full bg-amber-500" />
   305â†’                    {stats.today.courtesyDueBack} courtesy due
   306â†’                  </Link>
   307â†’                )}
   308â†’              </div>
   309â†’            </div>
   310â†’          )}
   311â†’        </div>
   312â†’      </div>
   313â†’
   314â†’      {isLoading ? (
   315â†’        <div className="flex justify-center py-20">
   316â†’          <div className="flex flex-col items-center gap-4">
   317â†’            <div className="w-12 h-12 border-4 border-[#0066CC]/20 border-t-[#0066CC] rounded-full animate-spin" />
   318â†’            <p className="text-sm text-slate-500 font-medium">Loading dashboard...</p>
   319â†’          </div>
   320â†’        </div>
   321â†’      ) : (
   322â†’        <div className="space-y-8">
   323â†’
   324â†’          {/* KPI Cards Row - Mixed Variants */}
   325â†’          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
   326â†’            <StatsCard
   327â†’              title="Pending Appraisals"
   328â†’              value={stats?.appraisals?.pending ?? 0}
   329â†’              trend={typeof stats?.oldestAppraisalDays === "number" ? `Oldest: ${stats.oldestAppraisalDays}d` : null}
   330â†’              icon="ðŸ“‹"
   331â†’              color="primary"
   332â†’              variant="gradient"
   333â†’            />
   334â†’            <StatsCard
   335â†’              title="Total Stock"
   336â†’              value={(stats?.vehicles?.inStock ?? 0) + (stats?.vehicles?.inPrep ?? 0)}
   337â†’              trend={stats?.vehicles?.inPrep > 0 ? `${stats.vehicles.inPrep} in prep` : null}
   338â†’              icon="ðŸš—"
   339â†’              color="secondary"
   340â†’              variant="gradient"
   341â†’            />
   342â†’            <StatsCard
   343â†’              title="Vehicles Sold"
   344â†’              value={stats?.vehicles?.live ?? 0}
   345â†’              trend={stats?.vehicles?.delivered > 0 ? `${stats.vehicles.delivered} delivered` : null}
   346â†’              icon="ðŸ†"
   347â†’              color="success"
   348â†’              variant="outlined"
   349â†’            />
   350â†’            <StatsCard
   351â†’              title="Avg Rating"
   352â†’              value={stats?.reviews?.avgRating ?? "N/A"}
   353â†’              trend={
   354â†’                typeof stats?.reviews?.lastReviewDays === "number"
   355â†’                  ? `Last: ${stats.reviews.lastReviewDays}d ago`
   356â†’                  : stats?.reviews?.count === 0
   357â†’                  ? "No reviews yet"
   358â†’                  : null
   359â†’              }
   360â†’              icon="â­"
   361â†’              color="warning"
   362â†’              variant="outlined"
   363â†’            />
   364â†’          </div>
   365â†’
   366â†’          {/* Quick Forms Section */}
   367â†’          {forms.length > 0 && (
   368â†’            <div className="bg-white rounded-2xl shadow-md border border-slate-100 p-6">
   369â†’              <div className="flex items-center justify-between mb-5">
   370â†’                <div className="flex items-center gap-3">
   371â†’                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center text-white shadow-lg">
   372â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   373â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   374â†’                    </svg>
   375â†’                  </div>
   376â†’                  <div>
   377â†’                    <h2 className="text-lg font-bold text-slate-900">Quick Forms</h2>
   378â†’                    <p className="text-xs text-slate-500">Launch frequently used forms</p>
   379â†’                  </div>
   380â†’                </div>
   381â†’                <Link href="/forms" className="text-sm text-[#0066CC] hover:text-[#0055BB] font-semibold transition-colors flex items-center gap-1">
   382â†’                  All Submissions
   383â†’                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   384â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
   385â†’                  </svg>
   386â†’                </Link>
   387â†’              </div>
   388â†’              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
   389â†’                {topForms.map((form) => (
   390â†’                  <button
   391â†’                    key={form.id || form._id}
   392â†’                    onClick={() => handleFormClick(form)}
   393â†’                    className="group bg-gradient-to-br from-slate-50 to-white border-2 border-slate-200 p-5 rounded-xl flex flex-col items-center gap-3 hover:border-[#0066CC] hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer"
   394â†’                  >
   395â†’                    <div className="w-12 h-12 rounded-xl bg-[#0066CC]/10 text-[#0066CC] flex items-center justify-center group-hover:bg-[#0066CC] group-hover:text-white transition-colors">
   396â†’                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   397â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   398â†’                      </svg>
   399â†’                    </div>
   400â†’                    <span className="font-bold text-slate-700 text-sm text-center">
   401â†’                      {FORM_TYPE_LABELS[form.type] || form.name}
   402â†’                    </span>
   403â†’                  </button>
   404â†’                ))}
   405â†’                {otherForms.length > 0 && (
   406â†’                  <div className="dropdown dropdown-end">
   407â†’                    <label
   408â†’                      tabIndex={0}
   409â†’                      className="group bg-slate-100 border-2 border-dashed border-slate-300 p-5 rounded-xl flex flex-col items-center gap-3 hover:border-slate-400 hover:bg-slate-50 transition-all cursor-pointer w-full"
   410â†’                    >
   411â†’                      <div className="w-12 h-12 rounded-xl bg-slate-200 text-slate-500 flex items-center justify-center">
   412â†’                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   413â†’                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
   414â†’                        </svg>
   415â†’                      </div>
   416â†’                      <span className="font-bold text-slate-500 text-sm">+{otherForms.length} More</span>
   417â†’                    </label>
   418â†’                    <div tabIndex={0} className="dropdown-content z-20 shadow-2xl bg-white rounded-xl w-64 border border-slate-200 mt-2 overflow-hidden">
   419â†’                      <div className="px-4 py-3 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
   420â†’                        <p className="text-xs font-bold text-slate-500 uppercase tracking-wide">All Forms</p>
   421â†’                      </div>
   422â†’                      <div className="max-h-64 overflow-y-auto">
   423â†’                        {otherForms.map((form) => (
   424â†’                          <button
   425â†’                            key={form.id || form._id}
   426â†’                            onClick={() => handleFormClick(form)}
   427â†’                            className="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-[#0066CC]/5 hover:text-[#0066CC] transition-colors border-b border-slate-50 last:border-0"
   428â†’                          >
   429â†’                            <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center flex-shrink-0">
   430â†’                              <svg className="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   431â†’                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   432â†’                              </svg>
   433â†’                            </div>
   434â†’                            <span className="truncate">{FORM_TYPE_LABELS[form.type] || form.name}</span>
   435â†’                          </button>
   436â†’                        ))}
   437â†’                      </div>
   438â†’                    </div>
   439â†’                  </div>
   440â†’                )}
   441â†’              </div>
   442â†’            </div>
   443â†’          )}
   444â†’
   445â†’          {/* Middle Row - Needs Attention + Quick Actions */}
   446â†’          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
   447â†’            {/* Needs Attention - Modern Card Layout */}
   448â†’            <div className="lg:col-span-2">
   449â†’              <div className="bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden">
   450â†’                <div className="flex items-center gap-3 px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-red-50/50 to-amber-50/50">
   451â†’                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-amber-500 flex items-center justify-center text-white shadow-lg">
   452â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   453â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
   454â†’                    </svg>
   455â†’                  </div>
   456â†’                  <div>
   457â†’                    <h2 className="text-lg font-bold text-slate-900">Needs Attention</h2>
   458â†’                    <p className="text-xs text-slate-500">Items requiring your immediate action</p>
   459â†’                  </div>
   460â†’                </div>
   461â†’                {activeNeedsAttention.length > 0 ? (
   462â†’                  <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
   463â†’                    {activeNeedsAttention.map((item) => {
   464â†’                      const colors = ATTENTION_COLORS[item.color];
   465â†’                      return (
   466â†’                        <Link
   467â†’                          key={item.key}
   468â†’                          href={item.href}
   469â†’                          className={`${colors.bg} ${colors.border} border rounded-xl p-4 hover:shadow-md transition-all group`}
   470â†’                        >
   471â†’                          <div className="flex items-start gap-3">
   472â†’                            <div className={`w-10 h-10 rounded-xl ${colors.icon} flex items-center justify-center flex-shrink-0`}>
   473â†’                              {item.icon}
   474â†’                            </div>
   475â†’                            <div className="flex-1 min-w-0">
   476â†’                              <div className="flex items-center gap-2 mb-1">
   477â†’                                <span className={`${colors.badge} px-2 py-0.5 rounded-full text-xs font-bold`}>
   478â†’                                  {stats?.needsAttention?.[item.key] ?? 0}
   479â†’                                </span>
   480â†’                                <span className={`text-sm font-bold ${colors.text}`}>{item.label}</span>
   481â†’                              </div>
   482â†’                              <p className="text-xs text-slate-600">{item.description}</p>
   483â†’                            </div>
   484â†’                            <svg className="w-5 h-5 text-slate-300 group-hover:text-slate-500 transition-colors flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   485â†’                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
   486â†’                            </svg>
   487â†’                          </div>
   488â†’                        </Link>
   489â†’                      );
   490â†’                    })}
   491â†’                  </div>
   492â†’                ) : (
   493â†’                  <div className="p-8 flex items-center justify-center">
   494â†’                    <div className="text-center">
   495â†’                      <div className="w-16 h-16 bg-gradient-to-br from-emerald-100 to-teal-100 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-inner">
   496â†’                        <svg className="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   497â†’                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   498â†’                        </svg>
   499â†’                      </div>
   500â†’                      <p className="text-lg font-bold text-emerald-700">All clear!</p>
   501â†’                      <p className="text-sm text-emerald-600/70 mt-1">Nothing needs attention right now</p>
   502â†’                    </div>
   503â†’                  </div>
   504â†’                )}
   505â†’              </div>
   506â†’            </div>
   507â†’
   508â†’            {/* Quick Actions - Command Palette Style */}
   509â†’            <div className="bg-white rounded-2xl shadow-md border border-slate-100 p-6">
   510â†’              <div className="flex items-center gap-3 mb-5">
   511â†’                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-[#0066CC] to-[#0EA5E9] flex items-center justify-center text-white shadow-lg">
   512â†’                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   513â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
   514â†’                  </svg>
   515â†’                </div>
   516â†’                <div>
   517â†’                  <h2 className="text-lg font-bold text-slate-900">Quick Actions</h2>
   518â†’                  <p className="text-xs text-slate-500">Shortcuts to common tasks</p>
   519â†’                </div>
   520â†’              </div>
   521â†’              <div className="space-y-3">
   522â†’                <Link href="/sales-prep" className="action-card">
   523â†’                  <div className="w-10 h-10 rounded-xl bg-[#0066CC]/10 text-[#0066CC] flex items-center justify-center">
   524â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   525â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
   526â†’                    </svg>
   527â†’                  </div>
   528â†’                  <div className="flex-1">
   529â†’                    <span className="font-bold text-slate-800 block">Add Vehicle</span>
   530â†’                    <span className="text-xs text-slate-500">Add to stock</span>
   531â†’                  </div>
   532â†’                </Link>
   533â†’
   534â†’                <Link href="/appraisals/new" className="action-card">
   535â†’                  <div className="w-10 h-10 rounded-xl bg-[#14B8A6]/10 text-[#14B8A6] flex items-center justify-center">
   536â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   537â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   538â†’                    </svg>
   539â†’                  </div>
   540â†’                  <div className="flex-1">
   541â†’                    <span className="font-bold text-slate-800 block">New Appraisal</span>
   542â†’                    <span className="text-xs text-slate-500">Value a vehicle</span>
   543â†’                  </div>
   544â†’                </Link>
   545â†’
   546â†’                <Link href="/forms" className="action-card">
   547â†’                  <div className="w-10 h-10 rounded-xl bg-amber-100 text-amber-600 flex items-center justify-center">
   548â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   549â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
   550â†’                    </svg>
   551â†’                  </div>
   552â†’                  <div className="flex-1">
   553â†’                    <span className="font-bold text-slate-800 block">View Submissions</span>
   554â†’                    <span className="text-xs text-slate-500">Review form data</span>
   555â†’                  </div>
   556â†’                </Link>
   557â†’
   558â†’                <Link href="/settings/team" className="action-card border-2 border-dashed border-[#0066CC]/30 bg-[#0066CC]/5 hover:bg-[#0066CC]/10 hover:border-[#0066CC]/50">
   559â†’                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-[#0066CC] to-[#14B8A6] text-white flex items-center justify-center shadow">
   560â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   561â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
   562â†’                    </svg>
   563â†’                  </div>
   564â†’                  <div className="flex-1">
   565â†’                    <span className="font-bold text-[#0066CC] block">Invite Team</span>
   566â†’                    <span className="text-xs text-[#0066CC]/70">Add staff members</span>
   567â†’                  </div>
   568â†’                </Link>
   569â†’              </div>
   570â†’            </div>
   571â†’          </div>
   572â†’
   573â†’          {/* Bottom Row - Recent Activity Cards */}
   574â†’          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
   575â†’            {/* Recent Appraisals */}
   576â†’            <div className="bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden">
   577â†’              <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100">
   578â†’                <div className="flex items-center gap-3">
   579â†’                  <div className="w-10 h-10 rounded-xl bg-[#0066CC]/10 text-[#0066CC] flex items-center justify-center">
   580â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   581â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   582â†’                    </svg>
   583â†’                  </div>
   584â†’                  <h3 className="text-lg font-bold text-slate-900">Recent Appraisals</h3>
   585â†’                </div>
   586â†’                <Link href="/appraisals" className="text-xs font-bold text-[#0066CC] uppercase tracking-wide hover:underline flex items-center gap-1">
   587â†’                  View All
   588â†’                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   589â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
   590â†’                  </svg>
   591â†’                </Link>
   592â†’              </div>
   593â†’
   594â†’              {stats?.recent?.appraisals?.length > 0 ? (
   595â†’                <div className="divide-y divide-slate-100">
   596â†’                  {stats.recent.appraisals.slice(0, 5).map((a) => (
   597â†’                    <div
   598â†’                      key={a.id}
   599â†’                      onClick={() => router.push(`/appraisals/${a.id}`)}
   600â†’                      className="flex items-center gap-4 px-6 py-4 hover:bg-slate-50 transition-colors cursor-pointer"
   601â†’                    >
   602â†’                      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-slate-100 to-slate-50 flex items-center justify-center border border-slate-200">
   603â†’                        <span className="font-mono text-xs font-bold text-slate-600">{a.vehicleReg?.slice(0, 4)}</span>
   604â†’                      </div>
   605â†’                      <div className="flex-1 min-w-0">
   606â†’                        <p className="font-bold text-slate-800 text-sm">{a.vehicleReg}</p>
   607â†’                        <p className="text-xs text-slate-500 truncate">{a.contactId?.name || "No contact"}</p>
   608â†’                      </div>
   609â†’                      <span className={`px-3 py-1 rounded-full text-xs font-bold ${
   610â†’                        a.decision === "purchased" || a.decision === "converted"
   611â†’                          ? "bg-emerald-100 text-emerald-700"
   612â†’                          : a.decision === "not_purchased" || a.decision === "declined"
   613â†’                          ? "bg-red-100 text-red-700"
   614â†’                          : "bg-amber-100 text-amber-700"
   615â†’                      }`}>
   616â†’                        {a.decision}
   617â†’                      </span>
   618â†’                    </div>
   619â†’                  ))}
   620â†’                </div>
   621â†’              ) : (
   622â†’                <div className="flex items-center justify-center py-12">
   623â†’                  <div className="text-center">
   624â†’                    <div className="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center mx-auto mb-3">
   625â†’                      <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   626â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   627â†’                      </svg>
   628â†’                    </div>
   629â†’                    <p className="text-slate-500 text-sm font-medium">No appraisals yet</p>
   630â†’                  </div>
   631â†’                </div>
   632â†’              )}
   633â†’            </div>
   634â†’
   635â†’            {/* Pending Prep */}
   636â†’            <div className="bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden">
   637â†’              <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100">
   638â†’                <div className="flex items-center gap-3">
   639â†’                  <div className="w-10 h-10 rounded-xl bg-[#14B8A6]/10 text-[#14B8A6] flex items-center justify-center">
   640â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   641â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
   642â†’                    </svg>
   643â†’                  </div>
   644â†’                  <h3 className="text-lg font-bold text-slate-900">Pending Prep</h3>
   645â†’                </div>
   646â†’                <Link href="/sales-prep" className="text-xs font-bold text-[#0066CC] uppercase tracking-wide hover:underline flex items-center gap-1">
   647â†’                  View All
   648â†’                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   649â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
   650â†’                  </svg>
   651â†’                </Link>
   652â†’              </div>
   653â†’
   654â†’              {stats?.recent?.vehicles?.length > 0 ? (
   655â†’                <div className="divide-y divide-slate-100">
   656â†’                  {stats.recent.vehicles.slice(0, 5).map((v) => (
   657â†’                    <div
   658â†’                      key={v.id}
   659â†’                      onClick={() => router.push("/sales-prep")}
   660â†’                      className="flex items-center gap-4 px-6 py-4 hover:bg-slate-50 transition-colors cursor-pointer"
   661â†’                    >
   662â†’                      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-amber-100 to-yellow-50 flex items-center justify-center border border-amber-200">
   663â†’                        <svg className="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   664â†’                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h8m-8 4h8m-8 4h4m-7 4h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
   665â†’                        </svg>
   666â†’                      </div>
   667â†’                      <div className="flex-1 min-w-0">
   668â†’                        <p className="font-bold text-slate-800 text-sm">{v.make} {v.model}</p>
   669â†’                        <p className="text-xs text-slate-500">{v.regCurrent}</p>
   670â†’                      </div>
   671â†’                      <span className={`px-3 py-1 rounded-full text-xs font-bold ${
   672â†’                        v.status === "delivered"
   673â†’                          ? "bg-slate-100 text-slate-600"
   674â†’                          : v.status === "live"
   675â†’                          ? "bg-emerald-100 text-emerald-700"
   676â†’                          : v.status === "in_prep"
   677â†’                          ? "bg-amber-100 text-amber-700"
   678â†’                          : "bg-blue-100 text-blue-700"
   679â†’                      }`}>
   680â†’                        {v.status.replace("_", " ")}
   681â†’                      </span>
   682â†’                    </div>
   683â†’                  ))}
   684â†’                </div>
   685â†’              ) : (
   686â†’                <div className="flex items-center justify-center py-12">
   687â†’                  <div className="text-center">
   688â†’                    <div className="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center mx-auto mb-3">
   689â†’                      <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   690â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h8m-8 4h8m-8 4h4m-7 4h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
   691â†’                      </svg>
   692â†’                    </div>
   693â†’                    <p className="text-slate-500 text-sm font-medium">No vehicles yet</p>
   694â†’                  </div>
   695â†’                </div>
   696â†’              )}
   697â†’            </div>
   698â†’          </div>
   699â†’        </div>
   700â†’      )}
   701â†’    </DashboardLayout>
   702â†’  );
   703â†’}
   704â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
