     1→import { useState, useEffect } from "react";
     2→import { useRouter } from "next/router";
     3→import { useSession, signIn } from "next-auth/react";
     4→import Head from "next/head";
     5→import toast from "react-hot-toast";
     6→
     7→// Step indicator component
     8→function StepIndicator({ currentStep, totalSteps }) {
     9→  return (
    10→    <div className="flex items-center justify-center gap-2 mb-8">
    11→      {Array.from({ length: totalSteps }, (_, i) => (
    12→        <div key={i} className="flex items-center">
    13→          <div
    14→            className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all ${
    15→              i + 1 === currentStep
    16→                ? "bg-primary text-primary-content"
    17→                : i + 1 < currentStep
    18→                ? "bg-success text-success-content"
    19→                : "bg-base-300 text-base-content/50"
    20→            }`}
    21→          >
    22→            {i + 1 < currentStep ? (
    23→              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    24→                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
    25→              </svg>
    26→            ) : (
    27→              i + 1
    28→            )}
    29→          </div>
    30→          {i < totalSteps - 1 && (
    31→            <div className={`w-12 h-1 mx-1 rounded ${i + 1 < currentStep ? "bg-success" : "bg-base-300"}`} />
    32→          )}
    33→        </div>
    34→      ))}
    35→    </div>
    36→  );
    37→}
    38→
    39→// Step 1: Dealership Profile
    40→function Step1Profile({ data, onChange, onNext, onSkip }) {
    41→  const [logoPreview, setLogoPreview] = useState(data.logoUrl || null);
    42→  const [uploading, setUploading] = useState(false);
    43→
    44→  const handleLogoUpload = async (e) => {
    45→    const file = e.target.files?.[0];
    46→    if (!file) return;
    47→
    48→    // Client-side validation
    49→    const allowedTypes = ["image/png", "image/jpeg", "image/jpg", "image/webp", "image/gif"];
    50→    if (!allowedTypes.includes(file.type)) {
    51→      toast.error("Please upload an image file (PNG, JPEG, WebP, or GIF)");
    52→      return;
    53→    }
    54→
    55→    const maxSize = 5 * 1024 * 1024; // 5MB
    56→    if (file.size > maxSize) {
    57→      toast.error(`File too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximum is 5MB.`);
    58→      return;
    59→    }
    60→
    61→    setUploading(true);
    62→    const formData = new FormData();
    63→    formData.append("file", file);
    64→
    65→    try {
    66→      const res = await fetch("/api/dealer/logo", { method: "POST", body: formData });
    67→
    68→      // Check content type
    69→      const contentType = res.headers.get("content-type") || "";
    70→      if (!contentType.includes("application/json")) {
    71→        if (process.env.NODE_ENV !== "production") {
    72→          console.error("[Logo Upload] Non-JSON response:", res.status);
    73→        }
    74→        toast.error("Upload failed (LOGO_UPLOAD_SERVER_ERROR)");
    75→        return;
    76→      }
    77→
    78→      const data = await res.json();
    79→
    80→      if (res.ok) {
    81→        setLogoPreview(data.url);
    82→        onChange({ ...data, logoUrl: data.url });
    83→        toast.success("Logo uploaded!");
    84→      } else {
    85→        // Show the specific error from server
    86→        const errorMsg = data.error || "Failed to upload logo";
    87→        const errorCode = data.code || "UNKNOWN";
    88→        if (process.env.NODE_ENV !== "production") {
    89→          console.error("[Logo Upload] Error:", errorCode, errorMsg, data.details);
    90→        }
    91→        toast.error(`${errorMsg} (${errorCode})`);
    92→      }
    93→    } catch (err) {
    94→      if (process.env.NODE_ENV !== "production") {
    95→        console.error("[Logo Upload] Exception:", err);
    96→      }
    97→      toast.error("Upload failed (LOGO_UPLOAD_NETWORK_ERROR)");
    98→    } finally {
    99→      setUploading(false);
   100→    }
   101→  };
   102→
   103→  return (
   104→    <div className="space-y-6">
   105→      <div className="text-center mb-8">
   106→        <h2 className="text-2xl font-bold text-base-content">Welcome to DealerFlow</h2>
   107→        <p className="text-base-content/60 mt-2">Let's get your dealership set up in just a few minutes</p>
   108→      </div>
   109→
   110→      <div className="max-w-md mx-auto space-y-4">
   111→        {/* Logo Upload */}
   112→        <div className="form-control">
   113→          <label className="label">
   114→            <span className="label-text font-medium">Dealership Logo</span>
   115→            <span className="label-text-alt text-base-content/50">Optional</span>
   116→          </label>
   117→          <div className="flex items-center gap-4">
   118→            <div className="w-20 h-20 rounded-xl bg-base-200 flex items-center justify-center overflow-hidden border-2 border-dashed border-base-300">
   119→              {logoPreview ? (
   120→                <img src={logoPreview} alt="Logo" className="w-full h-full object-contain" />
   121→              ) : (
   122→                <svg className="w-8 h-8 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   123→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
   124→                </svg>
   125→              )}
   126→            </div>
   127→            <label className="btn btn-outline btn-sm">
   128→              {uploading ? <span className="loading loading-spinner loading-xs"></span> : "Upload Logo"}
   129→              <input type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} disabled={uploading} />
   130→            </label>
   131→          </div>
   132→        </div>
   133→
   134→        {/* Dealership Name */}
   135→        <div className="form-control">
   136→          <label className="label">
   137→            <span className="label-text font-medium">Dealership Name *</span>
   138→          </label>
   139→          <input
   140→            type="text"
   141→            className="input input-bordered"
   142→            placeholder="e.g. Smith's Motor Company"
   143→            value={data.name || ""}
   144→            onChange={(e) => onChange({ ...data, name: e.target.value })}
   145→          />
   146→        </div>
   147→
   148→        {/* Timezone */}
   149→        <div className="form-control">
   150→          <label className="label">
   151→            <span className="label-text font-medium">Timezone</span>
   152→          </label>
   153→          <select
   154→            className="select select-bordered"
   155→            value={data.timezone || "Europe/London"}
   156→            onChange={(e) => onChange({ ...data, timezone: e.target.value })}
   157→          >
   158→            <option value="Europe/London">Europe/London (GMT/BST)</option>
   159→            <option value="Europe/Dublin">Europe/Dublin</option>
   160→            <option value="Europe/Paris">Europe/Paris (CET)</option>
   161→          </select>
   162→        </div>
   163→
   164→        {/* Contact Details */}
   165→        <div className="divider text-xs text-base-content/50">Contact Details (Optional)</div>
   166→
   167→        <div className="form-control">
   168→          <label className="label">
   169→            <span className="label-text font-medium">Primary Contact Email</span>
   170→          </label>
   171→          <input
   172→            type="email"
   173→            className="input input-bordered"
   174→            placeholder="contact@yourdealership.com"
   175→            value={data.primaryContactEmail || ""}
   176→            onChange={(e) => onChange({ ...data, primaryContactEmail: e.target.value })}
   177→          />
   178→        </div>
   179→
   180→        <div className="form-control">
   181→          <label className="label">
   182→            <span className="label-text font-medium">Primary Contact Phone</span>
   183→          </label>
   184→          <input
   185→            type="tel"
   186→            className="input input-bordered"
   187→            placeholder="01onal234 567890"
   188→            value={data.primaryContactPhone || ""}
   189→            onChange={(e) => onChange({ ...data, primaryContactPhone: e.target.value })}
   190→          />
   191→        </div>
   192→      </div>
   193→
   194→      <div className="flex justify-between mt-8">
   195→        <button className="btn btn-ghost" onClick={onSkip}>
   196→          Skip for now
   197→        </button>
   198→        <button
   199→          className="btn btn-primary"
   200→          onClick={onNext}
   201→          disabled={!data.name?.trim()}
   202→        >
   203→          Save & Continue
   204→        </button>
   205→      </div>
   206→    </div>
   207→  );
   208→}
   209→
   210→// Step 2: Choose Modules
   211→function Step2Modules({ data, onChange, onNext, onSkip, onBack }) {
   212→  const modules = [
   213→    {
   214→      key: "salesPrep",
   215→      name: "Stock & Sales Prep",
   216→      description: "Vehicle stock management, preparation checklists, and issue tracking",
   217→      icon: (
   218→        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   219→          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
   220→        </svg>
   221→      ),
   222→      defaultEnabled: true,
   223→      recommended: true,
   224→    },
   225→    {
   226→      key: "appraisals",
   227→      name: "Appraisals & Buying",
   228→      description: "Part-exchange and dealer buying appraisals — with shareable forms customers can complete from home.",
   229→      tooltip: "Use this for customer PX appraisals, buying stock on the road, or sending a link to a third-party buyer to complete an appraisal.",
   230→      icon: (
   231→        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   232→          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
   233→        </svg>
   234→      ),
   235→      defaultEnabled: true,
   236→      recommended: true,
   237→    },
   238→    {
   239→      key: "warranty",
   240→      name: "Warranty & Aftercare",
   241→      description: "Customer warranty claims, repair tracking, and courtesy car management",
   242→      icon: (
   243→        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   244→          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
   245→        </svg>
   246→      ),
   247→      defaultEnabled: false,
   248→    },
   249→    {
   250→      key: "reviews",
   251→      name: "Reviews & Feedback",
   252→      description: "Request and track customer reviews via email/SMS",
   253→      icon: (
   254→        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   255→          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
   256→        </svg>
   257→      ),
   258→      defaultEnabled: false,
   259→    },
   260→  ];
   261→
   262→  const [enabledModules, setEnabledModules] = useState(
   263→    data.enabledModules || {
   264→      salesPrep: true,
   265→      appraisals: true,
   266→      warranty: false,
   267→      reviews: false,
   268→    }
   269→  );
   270→
   271→  const toggleModule = (key) => {
   272→    setEnabledModules({ ...enabledModules, [key]: !enabledModules[key] });
   273→  };
   274→
   275→  const handleNext = () => {
   276→    onChange({ ...data, enabledModules });
   277→    onNext();
   278→  };
   279→
   280→  const enabledCount = Object.values(enabledModules).filter(Boolean).length;
   281→
   282→  return (
   283→    <div className="space-y-6">
   284→      <div className="text-center mb-8">
   285→        <h2 className="text-2xl font-bold text-base-content">Choose Your Modules</h2>
   286→        <p className="text-base-content/60 mt-2">Select the features you want to use. You can change these later in Settings.</p>
   287→      </div>
   288→
   289→      <div className="max-w-2xl mx-auto space-y-3">
   290→        {modules.map((module) => (
   291→          <button
   292→            key={module.key}
   293→            onClick={() => toggleModule(module.key)}
   294→            className={`w-full card border-2 transition-all text-left ${
   295→              enabledModules[module.key]
   296→                ? "border-primary bg-primary/5"
   297→                : "border-base-300 bg-base-100 hover:border-base-content/20"
   298→            }`}
   299→          >
   300→            <div className="card-body p-4">
   301→              <div className="flex items-start gap-4">
   302→                <div className={`p-2 rounded-lg ${enabledModules[module.key] ? "bg-primary/10 text-primary" : "bg-base-200 text-base-content/50"}`}>
   303→                  {module.icon}
   304→                </div>
   305→                <div className="flex-1">
   306→                  <div className="flex items-center gap-2">
   307→                    <h3 className="font-bold">{module.name}</h3>
   308→                    {module.recommended && (
   309→                      <span className="badge badge-primary badge-xs">Recommended</span>
   310→                    )}
   311→                    {module.tooltip && (
   312→                      <div className="tooltip tooltip-right" data-tip={module.tooltip}>
   313→                        <svg className="w-4 h-4 text-base-content/40 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   314→                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
   315→                        </svg>
   316→                      </div>
   317→                    )}
   318→                  </div>
   319→                  <p className="text-sm text-base-content/60 mt-1">{module.description}</p>
   320→                </div>
   321→                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${
   322→                  enabledModules[module.key]
   323→                    ? "border-primary bg-primary"
   324→                    : "border-base-300"
   325→                }`}>
   326→                  {enabledModules[module.key] && (
   327→                    <svg className="w-4 h-4 text-primary-content" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   328→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   329→                    </svg>
   330→                  )}
   331→                </div>
   332→              </div>
   333→            </div>
   334→          </button>
   335→        ))}
   336→      </div>
   337→
   338→      <div className="text-center text-sm text-base-content/50 mt-4">
   339→        {enabledCount} module{enabledCount !== 1 ? "s" : ""} selected
   340→      </div>
   341→
   342→      <div className="flex justify-between mt-8">
   343→        <button className="btn btn-ghost" onClick={onBack}>
   344→          Back
   345→        </button>
   346→        <div className="flex gap-2">
   347→          <button className="btn btn-ghost" onClick={onSkip}>
   348→            Skip
   349→          </button>
   350→          <button className="btn btn-primary" onClick={handleNext}>
   351→            Save & Continue
   352→          </button>
   353→        </div>
   354→      </div>
   355→    </div>
   356→  );
   357→}
   358→
   359→// Step 3: Choose Setup Path
   360→function Step3SetupPath({ onNext, onSkip, onBack }) {
   361→  return (
   362→    <div className="space-y-6">
   363→      <div className="text-center mb-8">
   364→        <h2 className="text-2xl font-bold text-base-content">How would you like to add vehicles?</h2>
   365→        <p className="text-base-content/60 mt-2">Choose how to get your stock into DealerFlow</p>
   366→      </div>
   367→
   368→      <div className="grid gap-4 max-w-2xl mx-auto">
   369→        {/* Quick Start - Active */}
   370→        <button
   371→          onClick={onNext}
   372→          className="card bg-base-100 border-2 border-primary shadow-lg hover:shadow-xl transition-all text-left"
   373→        >
   374→          <div className="card-body">
   375→            <div className="flex items-start gap-4">
   376→              <div className="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center flex-shrink-0">
   377→                <svg className="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   378→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
   379→                </svg>
   380→              </div>
   381→              <div className="flex-1">
   382→                <div className="flex items-center gap-2">
   383→                  <h3 className="font-bold text-lg">Quick Start (Manual)</h3>
   384→                  <span className="badge badge-primary badge-sm">Recommended</span>
   385→                </div>
   386→                <p className="text-base-content/60 text-sm mt-1">
   387→                  Add vehicles manually using VRM lookup. Perfect for getting started quickly.
   388→                </p>
   389→              </div>
   390→              <svg className="w-5 h-5 text-primary flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   391→                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
   392→              </svg>
   393→            </div>
   394→          </div>
   395→        </button>
   396→
   397→        {/* CSV Import - Coming Soon */}
   398→        <div className="card bg-base-100 border border-base-300 opacity-60 cursor-not-allowed">
   399→          <div className="card-body">
   400→            <div className="flex items-start gap-4">
   401→              <div className="w-12 h-12 rounded-xl bg-base-200 flex items-center justify-center flex-shrink-0">
   402→                <svg className="w-6 h-6 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   403→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   404→                </svg>
   405→              </div>
   406→              <div className="flex-1">
   407→                <div className="flex items-center gap-2">
   408→                  <h3 className="font-bold text-lg text-base-content/50">Import from CSV</h3>
   409→                  <span className="badge badge-ghost badge-sm">Coming Soon</span>
   410→                </div>
   411→                <p className="text-base-content/40 text-sm mt-1">
   412→                  Upload a spreadsheet export from your existing system.
   413→                </p>
   414→              </div>
   415→            </div>
   416→          </div>
   417→        </div>
   418→
   419→        {/* Stock Feed - Coming Soon */}
   420→        <div className="card bg-base-100 border border-base-300 opacity-60 cursor-not-allowed">
   421→          <div className="card-body">
   422→            <div className="flex items-start gap-4">
   423→              <div className="w-12 h-12 rounded-xl bg-base-200 flex items-center justify-center flex-shrink-0">
   424→                <svg className="w-6 h-6 text-base-content/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   425→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
   426→                </svg>
   427→              </div>
   428→              <div className="flex-1">
   429→                <div className="flex items-center gap-2">
   430→                  <h3 className="font-bold text-lg text-base-content/50">Connect Stock Feed</h3>
   431→                  <span className="badge badge-ghost badge-sm">Coming Soon</span>
   432→                </div>
   433→                <p className="text-base-content/40 text-sm mt-1">
   434→                  Paste a feed URL from your DMS or website provider for automatic sync.
   435→                </p>
   436→              </div>
   437→            </div>
   438→          </div>
   439→        </div>
   440→      </div>
   441→
   442→      <div className="flex justify-between mt-8">
   443→        <button className="btn btn-ghost" onClick={onBack}>
   444→          Back
   445→        </button>
   446→        <button className="btn btn-ghost" onClick={onSkip}>
   447→          Skip for now
   448→        </button>
   449→      </div>
   450→    </div>
   451→  );
   452→}
   453→
   454→// Step 4: Configure Workflow Templates
   455→function Step4Workflow({ data, onChange, onNext, onSkip, onBack }) {
   456→  const defaultTasks = [
   457→    "Pre-Delivery Inspection",
   458→    "MOT",
   459→    "Service / Oil & Filter",
   460→    "Valet",
   461→    "Photos",
   462→    "Advert Live",
   463→    "Delivery / Handover",
   464→  ];
   465→
   466→  const [tasks, setTasks] = useState(data.tasks || defaultTasks);
   467→  const [newTask, setNewTask] = useState("");
   468→  const [autoComplete, setAutoComplete] = useState(data.autoCompleteEnabled !== false);
   469→
   470→  const addTask = () => {
   471→    if (newTask.trim() && !tasks.includes(newTask.trim())) {
   472→      setTasks([...tasks, newTask.trim()]);
   473→      setNewTask("");
   474→    }
   475→  };
   476→
   477→  const removeTask = (index) => {
   478→    setTasks(tasks.filter((_, i) => i !== index));
   479→  };
   480→
   481→  const handleNext = () => {
   482→    onChange({ ...data, tasks, autoCompleteEnabled: autoComplete });
   483→    onNext();
   484→  };
   485→
   486→  return (
   487→    <div className="space-y-6">
   488→      <div className="text-center mb-8">
   489→        <h2 className="text-2xl font-bold text-base-content">Configure Your Workflow</h2>
   490→        <p className="text-base-content/60 mt-2">Set up your default preparation tasks for new vehicles</p>
   491→      </div>
   492→
   493→      <div className="max-w-lg mx-auto space-y-6">
   494→        {/* Task List */}
   495→        <div className="card bg-base-100 border border-base-300">
   496→          <div className="card-body">
   497→            <h3 className="font-semibold mb-3">Default Prep Tasks</h3>
   498→            <p className="text-sm text-base-content/60 mb-4">
   499→              These tasks will be automatically created for each new vehicle. Drag to reorder.
   500→            </p>
   501→
   502→            <ul className="space-y-2">
   503→              {tasks.map((task, index) => (
   504→                <li
   505→                  key={index}
   506→                  className="flex items-center gap-3 p-3 bg-base-200 rounded-lg"
   507→                >
   508→                  <svg className="w-4 h-4 text-base-content/30 cursor-move" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   509→                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 8h16M4 16h16" />
   510→                  </svg>
   511→                  <span className="flex-1 text-sm">{task}</span>
   512→                  <button
   513→                    className="btn btn-ghost btn-xs text-error"
   514→                    onClick={() => removeTask(index)}
   515→                  >
   516→                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   517→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   518→                    </svg>
   519→                  </button>
   520→                </li>
   521→              ))}
   522→            </ul>
   523→
   524→            {/* Add Task */}
   525→            <div className="flex gap-2 mt-4">
   526→              <input
   527→                type="text"
   528→                className="input input-bordered input-sm flex-1"
   529→                placeholder="Add custom task..."
   530→                value={newTask}
   531→                onChange={(e) => setNewTask(e.target.value)}
   532→                onKeyDown={(e) => e.key === "Enter" && addTask()}
   533→              />
   534→              <button className="btn btn-primary btn-sm" onClick={addTask} disabled={!newTask.trim()}>
   535→                Add
   536→              </button>
   537→            </div>
   538→          </div>
   539→        </div>
   540→
   541→        {/* Auto-complete Toggle */}
   542→        <div className="card bg-base-100 border border-base-300">
   543→          <div className="card-body">
   544→            <div className="flex items-center justify-between">
   545→              <div>
   546→                <h3 className="font-semibold">Auto-complete Tasks</h3>
   547→                <p className="text-sm text-base-content/60 mt-1">
   548→                  Automatically mark tasks complete when forms are submitted
   549→                </p>
   550→              </div>
   551→              <input
   552→                type="checkbox"
   553→                className="toggle toggle-primary"
   554→                checked={autoComplete}
   555→                onChange={(e) => setAutoComplete(e.target.checked)}
   556→              />
   557→            </div>
   558→
   559→            {autoComplete && (
   560→              <div className="mt-4 p-3 bg-base-200 rounded-lg">
   561→                <p className="text-xs text-base-content/60 mb-2">Mappings:</p>
   562→                <ul className="text-xs space-y-1">
   563→                  <li className="flex items-center gap-2">
   564→                    <span className="badge badge-ghost badge-xs">PDI Form</span>
   565→                    <span className="text-base-content/40">→</span>
   566→                    <span>Pre-Delivery Inspection</span>
   567→                  </li>
   568→                  <li className="flex items-center gap-2">
   569→                    <span className="badge badge-ghost badge-xs">Delivery Form</span>
   570→                    <span className="text-base-content/40">→</span>
   571→                    <span>Delivery / Handover</span>
   572→                  </li>
   573→                  <li className="flex items-center gap-2">
   574→                    <span className="badge badge-ghost badge-xs">Service Receipt</span>
   575→                    <span className="text-base-content/40">→</span>
   576→                    <span>Service / Oil & Filter</span>
   577→                  </li>
   578→                </ul>
   579→              </div>
   580→            )}
   581→          </div>
   582→        </div>
   583→      </div>
   584→
   585→      <div className="flex justify-between mt-8">
   586→        <button className="btn btn-ghost" onClick={onBack}>
   587→          Back
   588→        </button>
   589→        <div className="flex gap-2">
   590→          <button className="btn btn-ghost" onClick={onSkip}>
   591→            Skip
   592→          </button>
   593→          <button className="btn btn-primary" onClick={handleNext}>
   594→            Save & Continue
   595→          </button>
   596→        </div>
   597→      </div>
   598→    </div>
   599→  );
   600→}
   601→
   602→// Step 5: Add First Vehicle
   603→function Step5Vehicle({ onComplete, onSkip, onBack }) {
   604→  const [vrm, setVrm] = useState("");
   605→  const [mileage, setMileage] = useState("");
   606→  const [vehicleData, setVehicleData] = useState(null);
   607→  const [lookupError, setLookupError] = useState(null);
   608→  const [loading, setLoading] = useState(false);
   609→  const [creating, setCreating] = useState(false);
   610→  const [manualMode, setManualMode] = useState(false);
   611→  const [manualData, setManualData] = useState({ make: "", model: "", year: "", colour: "" });
   612→
   613→  const handleLookup = async () => {
   614→    if (!vrm.trim()) return;
   615→
   616→    setLoading(true);
   617→    setLookupError(null);
   618→    setVehicleData(null);
   619→    setManualMode(false);
   620→
   621→    try {
   622→      const res = await fetch("/api/dvla-lookup", {
   623→        method: "POST",
   624→        headers: { "Content-Type": "application/json" },
   625→        body: JSON.stringify({ vehicleReg: vrm.toUpperCase().replace(/\s/g, "") }),
   626→      });
   627→
   628→      if (res.ok) {
   629→        const data = await res.json();
   630→        setVehicleData(data);
   631→
   632→        // Check if model is missing from DVLA response
   633→        if (!data.model?.trim()) {
   634→          setManualMode(true);
   635→          setManualData((prev) => ({
   636→            ...prev,
   637→            make: data.make || "",
   638→            model: "", // Need manual entry
   639→            year: data.yearOfManufacture?.toString() || "",
   640→            colour: data.colour || "",
   641→          }));
   642→          setLookupError("DVLA didn't return the model. Please enter it below.");
   643→        }
   644→      } else {
   645→        setLookupError("Could not find vehicle. You can enter details manually.");
   646→        setManualMode(true);
   647→      }
   648→    } catch {
   649→      setLookupError("Lookup failed. You can enter details manually.");
   650→      setManualMode(true);
   651→    } finally {
   652→      setLoading(false);
   653→    }
   654→  };
   655→
   656→  const handleCreate = async () => {
   657→    // Build payload: prefer lookup data, but use manual data as fallback/override
   658→    const make = (vehicleData?.make || manualData.make || "").trim();
   659→    const model = (manualData.model || vehicleData?.model || "").trim(); // Manual overrides lookup for model
   660→    const year = manualData.year || vehicleData?.yearOfManufacture || "";
   661→    const colour = manualData.colour || vehicleData?.colour || "";
   662→
   663→    // Client-side validation before submit
   664→    if (!make) {
   665→      toast.error("Make is required");
   666→      return;
   667→    }
   668→    if (!model) {
   669→      toast.error("Model is required. Please enter it in the form below.");
   670→      return;
   671→    }
   672→
   673→    setCreating(true);
   674→
   675→    const payload = {
   676→      vrm: vrm.toUpperCase().replace(/\s/g, ""),
   677→      mileage: mileage ? parseInt(mileage, 10) : null,
   678→      make,
   679→      model,
   680→      year: year ? parseInt(year, 10) : null,
   681→      colour: colour || null,
   682→      fuelType: vehicleData?.fuelType || null,
   683→      transmission: vehicleData?.transmission || null,
   684→    };
   685→
   686→    // Debug logging (dev only)
   687→    if (process.env.NODE_ENV !== "production") {
   688→      console.log("[Onboarding Vehicle] Submitting payload:", payload);
   689→    }
   690→
   691→    try {
   692→      const res = await fetch("/api/onboarding/vehicle", {
   693→        method: "POST",
   694→        headers: { "Content-Type": "application/json" },
   695→        body: JSON.stringify(payload),
   696→      });
   697→
   698→      const contentType = res.headers.get("content-type") || "";
   699→      if (!contentType.includes("application/json")) {
   700→        console.error("[Onboarding Vehicle] Non-JSON response:", res.status);
   701→        toast.error("Server error (VEHICLE_CREATE_SERVER_ERROR)");
   702→        return;
   703→      }
   704→
   705→      const data = await res.json();
   706→
   707→      if (res.ok) {
   708→        toast.success("Vehicle created!");
   709→        onComplete(data.vehicleId);
   710→      } else {
   711→        const errorCode = data.code || "UNKNOWN";
   712→        if (process.env.NODE_ENV !== "production") {
   713→          console.error("[Onboarding Vehicle] Error:", errorCode, data.error);
   714→        }
   715→        toast.error(data.error || "Failed to create vehicle");
   716→      }
   717→    } catch (err) {
   718→      if (process.env.NODE_ENV !== "production") {
   719→        console.error("[Onboarding Vehicle] Exception:", err);
   720→      }
   721→      toast.error("Error creating vehicle");
   722→    } finally {
   723→      setCreating(false);
   724→    }
   725→  };
   726→
   727→  // Determine if we have valid make/model (from lookup or manual entry)
   728→  const effectiveMake = (vehicleData?.make || manualData.make || "").trim();
   729→  const effectiveModel = (manualData.model || vehicleData?.model || "").trim();
   730→  const canCreate = vrm.trim() && effectiveMake && effectiveModel;
   731→
   732→  return (
   733→    <div className="space-y-6">
   734→      <div className="text-center mb-8">
   735→        <h2 className="text-2xl font-bold text-base-content">Add Your First Vehicle</h2>
   736→        <p className="text-base-content/60 mt-2">Experience the magic of DealerFlow</p>
   737→      </div>
   738→
   739→      <div className="max-w-md mx-auto space-y-4">
   740→        {/* VRM Input */}
   741→        <div className="form-control">
   742→          <label className="label">
   743→            <span className="label-text font-medium">Vehicle Registration *</span>
   744→          </label>
   745→          <div className="flex gap-2">
   746→            <input
   747→              type="text"
   748→              className="input input-bordered flex-1 uppercase font-mono"
   749→              placeholder="AB12 CDE"
   750→              value={vrm}
   751→              onChange={(e) => setVrm(e.target.value.toUpperCase())}
   752→              onKeyDown={(e) => e.key === "Enter" && handleLookup()}
   753→            />
   754→            <button
   755→              className="btn btn-primary"
   756→              onClick={handleLookup}
   757→              disabled={!vrm.trim() || loading}
   758→            >
   759→              {loading ? <span className="loading loading-spinner loading-sm"></span> : "Lookup"}
   760→            </button>
   761→          </div>
   762→        </div>
   763→
   764→        {/* Lookup Result */}
   765→        {vehicleData && (
   766→          <div className="card bg-success/10 border border-success/30">
   767→            <div className="card-body p-4">
   768→              <div className="flex items-center gap-2 mb-2">
   769→                <svg className="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   770→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   771→                </svg>
   772→                <span className="font-semibold text-success">Vehicle Found</span>
   773→              </div>
   774→              {vehicleData.isDummy && (
   775→                <p className="text-xs text-warning mb-2">{vehicleData.message}</p>
   776→              )}
   777→              <div className="grid grid-cols-2 gap-2 text-sm">
   778→                <div><span className="text-base-content/50">Make:</span> {vehicleData.make}</div>
   779→                <div><span className="text-base-content/50">Model:</span> {vehicleData.model}</div>
   780→                <div><span className="text-base-content/50">Year:</span> {vehicleData.yearOfManufacture}</div>
   781→                <div><span className="text-base-content/50">Colour:</span> {vehicleData.colour}</div>
   782→                <div><span className="text-base-content/50">Fuel:</span> {vehicleData.fuelType}</div>
   783→                <div><span className="text-base-content/50">MOT:</span> {vehicleData.motStatus}</div>
   784→              </div>
   785→            </div>
   786→          </div>
   787→        )}
   788→
   789→        {/* Lookup Error / Manual Mode */}
   790→        {lookupError && (
   791→          <div className="alert alert-warning">
   792→            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   793→              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
   794→            </svg>
   795→            <span className="text-sm">{lookupError}</span>
   796→          </div>
   797→        )}
   798→
   799→        {/* Manual Entry Fields - Full manual entry (no lookup data) */}
   800→        {manualMode && !vehicleData && (
   801→          <div className="space-y-3 p-4 bg-base-200 rounded-lg">
   802→            <p className="text-sm font-medium">Enter vehicle details manually:</p>
   803→            <div className="grid grid-cols-2 gap-3">
   804→              <input
   805→                type="text"
   806→                className="input input-bordered input-sm"
   807→                placeholder="Make *"
   808→                value={manualData.make}
   809→                onChange={(e) => setManualData({ ...manualData, make: e.target.value })}
   810→              />
   811→              <input
   812→                type="text"
   813→                className="input input-bordered input-sm"
   814→                placeholder="Model *"
   815→                value={manualData.model}
   816→                onChange={(e) => setManualData({ ...manualData, model: e.target.value })}
   817→              />
   818→              <input
   819→                type="text"
   820→                className="input input-bordered input-sm"
   821→                placeholder="Year"
   822→                value={manualData.year}
   823→                onChange={(e) => setManualData({ ...manualData, year: e.target.value })}
   824→              />
   825→              <input
   826→                type="text"
   827→                className="input input-bordered input-sm"
   828→                placeholder="Colour"
   829→                value={manualData.colour}
   830→                onChange={(e) => setManualData({ ...manualData, colour: e.target.value })}
   831→              />
   832→            </div>
   833→          </div>
   834→        )}
   835→
   836→        {/* Model Entry - When lookup succeeded but DVLA didn't return model */}
   837→        {manualMode && vehicleData && !vehicleData.model?.trim() && (
   838→          <div className="space-y-3 p-4 bg-warning/10 border border-warning/30 rounded-lg">
   839→            <p className="text-sm font-medium">Enter model:</p>
   840→            <input
   841→              type="text"
   842→              className="input input-bordered input-sm w-full"
   843→              placeholder="Model (e.g. Focus, Golf, A3) *"
   844→              value={manualData.model}
   845→              onChange={(e) => setManualData({ ...manualData, model: e.target.value })}
   846→              autoFocus
   847→            />
   848→          </div>
   849→        )}
   850→
   851→        {/* Mileage (Optional) */}
   852→        <div className="form-control">
   853→          <label className="label">
   854→            <span className="label-text font-medium">Current Mileage</span>
   855→            <span className="label-text-alt text-base-content/50">Optional</span>
   856→          </label>
   857→          <input
   858→            type="number"
   859→            className="input input-bordered"
   860→            placeholder="e.g. 45000"
   861→            value={mileage}
   862→            onChange={(e) => setMileage(e.target.value)}
   863→          />
   864→        </div>
   865→
   866→        {/* Create Button */}
   867→        {(vehicleData || manualMode) && (
   868→          <button
   869→            className="btn btn-primary btn-block mt-4"
   870→            onClick={handleCreate}
   871→            disabled={!canCreate || creating}
   872→          >
   873→            {creating ? (
   874→              <>
   875→                <span className="loading loading-spinner loading-sm"></span>
   876→                Creating...
   877→              </>
   878→            ) : (
   879→              <>
   880→                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   881→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
   882→                </svg>
   883→                Create Vehicle & Finish Setup
   884→              </>
   885→            )}
   886→          </button>
   887→        )}
   888→
   889→        {/* Tip */}
   890→        <div className="text-center mt-6">
   891→          <p className="text-xs text-base-content/50 italic">
   892→            Tip: When you submit a PDI form, the PDI task ticks automatically.
   893→          </p>
   894→        </div>
   895→      </div>
   896→
   897→      <div className="flex justify-between mt-8">
   898→        <button className="btn btn-ghost" onClick={onBack}>
   899→          Back
   900→        </button>
   901→        <button className="btn btn-ghost" onClick={() => onComplete(null)}>
   902→          Skip & Finish Later
   903→        </button>
   904→      </div>
   905→    </div>
   906→  );
   907→}
   908→
   909→// Main Onboarding Component
   910→export default function Onboarding() {
   911→  const router = useRouter();
   912→  const { data: session, status } = useSession();
   913→  const [step, setStep] = useState(1);
   914→  const [loading, setLoading] = useState(true);
   915→  const [saving, setSaving] = useState(false);
   916→  const [dealer, setDealer] = useState(null);
   917→  const [profileData, setProfileData] = useState({});
   918→  const [modulesData, setModulesData] = useState({
   919→    enabledModules: {
   920→      salesPrep: true,
   921→      appraisals: true,
   922→      warranty: false,
   923→      reviews: false,
   924→    },
   925→  });
   926→  const [workflowData, setWorkflowData] = useState({});
   927→
   928→  // Redirect to sign-in if not authenticated
   929→  useEffect(() => {
   930→    if (status === "unauthenticated") {
   931→      signIn(undefined, { callbackUrl: "/onboarding" });
   932→    }
   933→  }, [status]);
   934→
   935→  // Check if already onboarded (only when authenticated)
   936→  useEffect(() => {
   937→    if (status !== "authenticated") return;
   938→
   939→    fetch("/api/dealer")
   940→      .then((res) => res.json())
   941→      .then((data) => {
   942→        if (data?.completedOnboarding) {
   943→          router.replace("/dashboard");
   944→        } else {
   945→          setDealer(data);
   946→          setProfileData({
   947→            name: data?.name || "",
   948→            logoUrl: data?.logoUrl || "",
   949→            timezone: data?.timezone || "Europe/London",
   950→            primaryContactEmail: data?.primaryContactEmail || data?.email || "",
   951→            primaryContactPhone: data?.primaryContactPhone || data?.phone || "",
   952→          });
   953→          setLoading(false);
   954→        }
   955→      })
   956→      .catch(() => setLoading(false));
   957→  }, [router, status]);
   958→
   959→  const handleSkip = async () => {
   960→    setSaving(true);
   961→    try {
   962→      await fetch("/api/onboarding/skip", { method: "POST" });
   963→      router.push("/dashboard");
   964→    } catch {
   965→      toast.error("Failed to skip onboarding");
   966→      setSaving(false);
   967→    }
   968→  };
   969→
   970→  const handleStep1Next = async () => {
   971→    setSaving(true);
   972→    try {
   973→      const res = await fetch("/api/onboarding/profile", {
   974→        method: "POST",
   975→        headers: { "Content-Type": "application/json" },
   976→        body: JSON.stringify(profileData),
   977→      });
   978→      if (res.ok) {
   979→        setStep(2);
   980→      } else {
   981→        toast.error("Failed to save profile");
   982→      }
   983→    } catch {
   984→      toast.error("Error saving profile");
   985→    } finally {
   986→      setSaving(false);
   987→    }
   988→  };
   989→
   990→  const handleStep2Next = async () => {
   991→    setSaving(true);
   992→    try {
   993→      const res = await fetch("/api/onboarding/modules", {
   994→        method: "POST",
   995→        headers: { "Content-Type": "application/json" },
   996→        body: JSON.stringify(modulesData),
   997→      });
   998→      if (res.ok) {
   999→        setStep(3);
  1000→      } else {
  1001→        toast.error("Failed to save modules");
  1002→      }
  1003→    } catch {
  1004→      toast.error("Error saving modules");
  1005→    } finally {
  1006→      setSaving(false);
  1007→    }
  1008→  };
  1009→
  1010→  const handleStep4Next = async () => {
  1011→    setSaving(true);
  1012→    try {
  1013→      const res = await fetch("/api/onboarding/workflow", {
  1014→        method: "POST",
  1015→        headers: { "Content-Type": "application/json" },
  1016→        body: JSON.stringify(workflowData),
  1017→      });
  1018→      if (res.ok) {
  1019→        setStep(5);
  1020→      } else {
  1021→        const data = await res.json().catch(() => ({}));
  1022→        toast.error(data.error || "Failed to save workflow");
  1023→        console.error("[onboarding] Workflow save failed:", data);
  1024→      }
  1025→    } catch (err) {
  1026→      toast.error("Error saving workflow");
  1027→      console.error("[onboarding] Workflow save error:", err);
  1028→    } finally {
  1029→      setSaving(false);
  1030→    }
  1031→  };
  1032→
  1033→  const handleComplete = async (vehicleId) => {
  1034→    setSaving(true);
  1035→    try {
  1036→      await fetch("/api/onboarding/complete", { method: "POST" });
  1037→
  1038→      if (vehicleId) {
  1039→        router.push(`/sales-prep?vehicle=${vehicleId}&drawer=open`);
  1040→      } else {
  1041→        router.push("/dashboard");
  1042→      }
  1043→    } catch {
  1044→      toast.error("Failed to complete onboarding");
  1045→      setSaving(false);
  1046→    }
  1047→  };
  1048→
  1049→  // Show loading while checking auth or loading data
  1050→  if (status === "loading" || loading) {
  1051→    return (
  1052→      <div className="min-h-screen flex items-center justify-center bg-base-200">
  1053→        <span className="loading loading-spinner loading-lg text-primary"></span>
  1054→      </div>
  1055→    );
  1056→  }
  1057→
  1058→  // Don't render if not authenticated (will redirect)
  1059→  if (status === "unauthenticated") {
  1060→    return (
  1061→      <div className="min-h-screen flex items-center justify-center bg-base-200">
  1062→        <span className="loading loading-spinner loading-lg text-primary"></span>
  1063→      </div>
  1064→    );
  1065→  }
  1066→
  1067→  return (
  1068→    <>
  1069→      <Head>
  1070→        <title>Setup | DealerFlow</title>
  1071→      </Head>
  1072→
  1073→      <div className="min-h-screen bg-base-200 py-8 px-4">
  1074→        <div className="max-w-3xl mx-auto">
  1075→          {/* Header */}
  1076→          <div className="text-center mb-6">
  1077→            <div className="flex items-center justify-center gap-2 mb-2">
  1078→              <svg className="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  1079→                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
  1080→              </svg>
  1081→              <span className="text-xl font-bold">DealerFlow</span>
  1082→            </div>
  1083→          </div>
  1084→
  1085→          {/* Step Indicator */}
  1086→          <StepIndicator currentStep={step} totalSteps={5} />
  1087→
  1088→          {/* Card */}
  1089→          <div className="card bg-base-100 shadow-xl">
  1090→            <div className="card-body p-6 md:p-8">
  1091→              {saving && (
  1092→                <div className="absolute inset-0 bg-base-100/80 flex items-center justify-center z-10 rounded-2xl">
  1093→                  <span className="loading loading-spinner loading-lg text-primary"></span>
  1094→                </div>
  1095→              )}
  1096→
  1097→              {step === 1 && (
  1098→                <Step1Profile
  1099→                  data={profileData}
  1100→                  onChange={setProfileData}
  1101→                  onNext={handleStep1Next}
  1102→                  onSkip={handleSkip}
  1103→                />
  1104→              )}
  1105→
  1106→              {step === 2 && (
  1107→                <Step2Modules
  1108→                  data={modulesData}
  1109→                  onChange={setModulesData}
  1110→                  onNext={handleStep2Next}
  1111→                  onSkip={() => setStep(3)}
  1112→                  onBack={() => setStep(1)}
  1113→                />
  1114→              )}
  1115→
  1116→              {step === 3 && (
  1117→                <Step3SetupPath
  1118→                  onNext={() => setStep(4)}
  1119→                  onSkip={handleSkip}
  1120→                  onBack={() => setStep(2)}
  1121→                />
  1122→              )}
  1123→
  1124→              {step === 4 && (
  1125→                <Step4Workflow
  1126→                  data={workflowData}
  1127→                  onChange={setWorkflowData}
  1128→                  onNext={handleStep4Next}
  1129→                  onSkip={() => setStep(5)}
  1130→                  onBack={() => setStep(3)}
  1131→                />
  1132→              )}
  1133→
  1134→              {step === 5 && (
  1135→                <Step5Vehicle
  1136→                  onComplete={handleComplete}
  1137→                  onSkip={() => handleComplete(null)}
  1138→                  onBack={() => setStep(4)}
  1139→                />
  1140→              )}
  1141→            </div>
  1142→          </div>
  1143→        </div>
  1144→      </div>
  1145→    </>
  1146→  );
  1147→}
  1148→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
