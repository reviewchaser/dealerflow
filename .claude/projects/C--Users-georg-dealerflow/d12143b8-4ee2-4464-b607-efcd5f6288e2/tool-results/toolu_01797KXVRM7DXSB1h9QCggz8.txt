  1240â†’      return false;
  1241â†’    }));
  1242â†’    return allFiltered.length;
  1243â†’  };
  1244â†’
  1245â†’  // VRM Search functions - debounced API search
  1246â†’  const searchVehiclesApi = async (query) => {
  1247â†’    if (query.length < 2) {
  1248â†’      setVrmSearchResults([]);
  1249â†’      return;
  1250â†’    }
  1251â†’
  1252â†’    setVrmSearchLoading(true);
  1253â†’    try {
  1254â†’      const res = await fetch(`/api/vehicles/search?q=${encodeURIComponent(query)}&limit=10`);
  1255â†’      if (res.ok) {
  1256â†’        const results = await res.json();
  1257â†’        // Sort by updatedAt (most recent activity first)
  1258â†’        results.sort((a, b) => {
  1259â†’          const aDate = new Date(a.updatedAt || a.createdAt || 0);
  1260â†’          const bDate = new Date(b.updatedAt || b.createdAt || 0);
  1261â†’          return bDate - aDate;
  1262â†’        });
  1263â†’        setVrmSearchResults(results);
  1264â†’      }
  1265â†’    } catch (err) {
  1266â†’      console.error("VRM search error:", err);
  1267â†’    } finally {
  1268â†’      setVrmSearchLoading(false);
  1269â†’    }
  1270â†’  };
  1271â†’
  1272â†’  const handleVrmSearchChange = (value) => {
  1273â†’    const normalized = value.toUpperCase();
  1274â†’    setVrmSearch(normalized);
  1275â†’
  1276â†’    // Clear previous timeout
  1277â†’    if (vrmSearchTimeout.current) {
  1278â†’      clearTimeout(vrmSearchTimeout.current);
  1279â†’    }
  1280â†’
  1281â†’    if (normalized.length >= 2) {
  1282â†’      setShowVrmDropdown(true);
  1283â†’      // Debounce API call by 250ms
  1284â†’      vrmSearchTimeout.current = setTimeout(() => {
  1285â†’        searchVehiclesApi(normalized);
  1286â†’      }, 250);
  1287â†’    } else {
  1288â†’      setVrmSearchResults([]);
  1289â†’      setShowVrmDropdown(false);
  1290â†’    }
  1291â†’  };
  1292â†’
  1293â†’  // Cleanup timeout on unmount
  1294â†’  useEffect(() => {
  1295â†’    return () => {
  1296â†’      if (vrmSearchTimeout.current) {
  1297â†’        clearTimeout(vrmSearchTimeout.current);
  1298â†’      }
  1299â†’    };
  1300â†’  }, []);
  1301â†’
  1302â†’  const handleVrmSelect = (vehicle) => {
  1303â†’    // Close dropdown and clear search
  1304â†’    setVrmSearch("");
  1305â†’    setShowVrmDropdown(false);
  1306â†’    setVrmSearchResults([]);
  1307â†’
  1308â†’    // Find which column this vehicle is in and scroll to it
  1309â†’    const columnIndex = COLUMNS.findIndex(col => col.key === vehicle.status);
  1310â†’    if (columnIndex >= 0) {
  1311â†’      // Scroll the column into view
  1312â†’      const columnElements = document.querySelectorAll('[data-column-key]');
  1313â†’      if (columnElements[columnIndex]) {
  1314â†’        columnElements[columnIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  1315â†’      }
  1316â†’    }
  1317â†’
  1318â†’    // Open the vehicle drawer with full details
  1319â†’    openVehicleDrawer(vehicle);
  1320â†’  };
  1321â†’
  1322â†’  const getStatusLabel = (statusKey) => {
  1323â†’    const col = COLUMNS.find(c => c.key === statusKey);
  1324â†’    return col ? col.label : statusKey;
  1325â†’  };
  1326â†’
  1327â†’  const handlePrintVehicle = () => {
  1328â†’    if (!selectedVehicle) return;
  1329â†’
  1330â†’    const vehicle = selectedVehicle;
  1331â†’    const tasks = vehicle.tasks || [];
  1332â†’    const issues = vehicle.issues || [];
  1333â†’    const documents = vehicle.documents || [];
  1334â†’    const completedTasks = tasks.filter(t => t.status === "done").length;
  1335â†’    const daysInStock = vehicle.createdAt
  1336â†’      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
  1337â†’      : 0;
  1338â†’
  1339â†’    // Get status label from COLUMNS
  1340â†’    const statusColumn = COLUMNS.find(col => col.key === vehicle.status);
  1341â†’    const statusLabel = statusColumn ? statusColumn.label : vehicle.status;
  1342â†’
  1343â†’    // Generate HTML for print
  1344â†’    const printContent = `
  1345â†’<!DOCTYPE html>
  1346â†’<html>
  1347â†’<head>
  1348â†’  <title>${vehicle.year || ""} ${vehicle.make} ${vehicle.model} - ${vehicle.regCurrent}</title>
  1349â†’  <style>
  1350â†’    * { margin: 0; padding: 0; box-sizing: border-box; }
  1351â†’    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }
  1352â†’    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
  1353â†’    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
  1354â†’    .reg { font-size: 18px; font-family: monospace; color: #64748b; }
  1355â†’    .section { margin-bottom: 30px; }
  1356â†’    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
  1357â†’    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  1358â†’    .field { margin-bottom: 12px; }
  1359â†’    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
  1360â†’    .field-value { font-size: 14px; color: #1e293b; }
  1361â†’    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
  1362â†’    .badge-status { background: #e0e7ff; color: #4338ca; }
  1363â†’    .badge-days { background: ${daysInStock > 30 ? '#fef2f2' : '#f1f5f9'}; color: ${daysInStock > 30 ? '#dc2626' : '#475569'}; }
  1364â†’    .task-list { list-style: none; }
  1365â†’    .task-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
  1366â†’    .task-status { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
  1367â†’    .task-done { background: #dcfce7; color: #16a34a; }
  1368â†’    .task-pending { background: #fef3c7; color: #d97706; }
  1369â†’    .task-progress { background: #dbeafe; color: #2563eb; }
  1370â†’    .issue-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
  1371â†’    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; }
  1372â†’    .issue-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
  1373â†’    .issue-desc { font-size: 14px; color: #1e293b; }
  1374â†’    .doc-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
  1375â†’    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }
  1376â†’    @media print {
  1377â†’      body { padding: 20px; }
  1378â†’      .no-print { display: none; }
  1379â†’    }
  1380â†’  </style>
  1381â†’</head>
  1382â†’<body>
  1383â†’  <div class="header">
  1384â†’    <div class="title">${vehicle.year || ""} ${vehicle.make} ${vehicle.model}</div>
  1385â†’    <div class="reg">${vehicle.regCurrent}</div>
  1386â†’  </div>
  1387â†’
  1388â†’  <div class="section">
  1389â†’    <div class="section-title">Overview</div>
  1390â†’    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
  1391â†’      <span class="badge badge-status">${statusLabel}</span>
  1392â†’      <span class="badge badge-days">Days in Stock: ${daysInStock}</span>
  1393â†’      ${vehicle.locationId ? `<span class="badge" style="background:#eef2ff;color:#4f46e5;">ğŸ“ ${vehicle.locationId.name || 'Offsite'}</span>` : '<span class="badge" style="background:#f0fdf4;color:#16a34a;">ğŸ“ On Site</span>'}
  1394â†’    </div>
  1395â†’  </div>
  1396â†’
  1397â†’  <div class="section">
  1398â†’    <div class="section-title">Vehicle Details</div>
  1399â†’    <div class="grid">
  1400â†’      <div class="field">
  1401â†’        <div class="field-label">Registration</div>
  1402â†’        <div class="field-value">${vehicle.regCurrent || 'â€”'}</div>
  1403â†’      </div>
  1404â†’      <div class="field">
  1405â†’        <div class="field-label">VIN</div>
  1406â†’        <div class="field-value">${vehicle.vin || 'â€”'}</div>
  1407â†’      </div>
  1408â†’      <div class="field">
  1409â†’        <div class="field-label">Make</div>
  1410â†’        <div class="field-value">${vehicle.make || 'â€”'}</div>
  1411â†’      </div>
  1412â†’      <div class="field">
  1413â†’        <div class="field-label">Model</div>
  1414â†’        <div class="field-value">${vehicle.model || 'â€”'}</div>
  1415â†’      </div>
  1416â†’      <div class="field">
  1417â†’        <div class="field-label">Year</div>
  1418â†’        <div class="field-value">${vehicle.year || 'â€”'}</div>
  1419â†’      </div>
  1420â†’      <div class="field">
  1421â†’        <div class="field-label">Mileage</div>
  1422â†’        <div class="field-value">${vehicle.mileageCurrent ? vehicle.mileageCurrent.toLocaleString() + ' miles' : 'â€”'}</div>
  1423â†’      </div>
  1424â†’      <div class="field">
  1425â†’        <div class="field-label">Colour</div>
  1426â†’        <div class="field-value">${vehicle.colour || 'â€”'}</div>
  1427â†’      </div>
  1428â†’      <div class="field">
  1429â†’        <div class="field-label">Fuel Type</div>
  1430â†’        <div class="field-value">${vehicle.fuelType || 'â€”'}</div>
  1431â†’      </div>
  1432â†’      <div class="field">
  1433â†’        <div class="field-label">MOT Expiry</div>
  1434â†’        <div class="field-value">${vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : 'â€”'}</div>
  1435â†’      </div>
  1436â†’    </div>
  1437â†’  </div>
  1438â†’
  1439â†’  <div class="section">

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
