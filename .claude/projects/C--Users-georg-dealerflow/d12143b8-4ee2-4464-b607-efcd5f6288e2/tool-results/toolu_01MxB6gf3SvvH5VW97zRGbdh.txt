     1→import connectMongo from "@/libs/mongoose";
     2→import Vehicle from "@/models/Vehicle";
     3→import { requireDealerContext } from "@/libs/authContext";
     4→
     5→// Map form-friendly status names to database status values
     6→const STATUS_MAP = {
     7→  IN_PREP: ["in_prep", "in_stock"],
     8→  IN_STOCK: ["in_stock"],
     9→  ADVERTISED: ["live"],
    10→  LIVE: ["live"],
    11→  RESERVED: ["reserved"],
    12→  SOLD: ["sold"],
    13→  DELIVERED: ["delivered"],
    14→  COURTESY: ["in_stock", "live"], // For courtesy vehicles
    15→};
    16→
    17→export default async function handler(req, res) {
    18→  if (req.method !== "GET") {
    19→    return res.status(405).json({ error: "Method not allowed" });
    20→  }
    21→
    22→  try {
    23→    await connectMongo();
    24→
    25→    // Get dealer context - tenant scoping
    26→    const ctx = await requireDealerContext(req, res);
    27→    const { dealerId } = ctx;
    28→
    29→    const { q, statuses, excludeStatuses, vehicleType, limit = 10 } = req.query;
    30→
    31→    // Build query with tenant scoping
    32→    const query = { dealerId };
    33→
    34→    // Filter by vehicle type (STOCK, COURTESY, etc.)
    35→    if (vehicleType) {
    36→      query.type = vehicleType;
    37→    }
    38→
    39→    // Filter by statuses
    40→    if (statuses) {
    41→      const statusArray = statuses.split(",");
    42→      const dbStatuses = [];
    43→      for (const status of statusArray) {
    44→        const mapped = STATUS_MAP[status.toUpperCase()];
    45→        if (mapped) {
    46→          dbStatuses.push(...mapped);
    47→        } else {
    48→          // Try using the raw status value
    49→          dbStatuses.push(status.toLowerCase());
    50→        }
    51→      }
    52→      // Remove duplicates
    53→      query.status = { $in: [...new Set(dbStatuses)] };
    54→    }
    55→
    56→    // Exclude specific statuses (e.g., exclude delivered vehicles from suggestions)
    57→    if (excludeStatuses) {
    58→      const excludeArray = excludeStatuses.split(",");
    59→      const dbExcludeStatuses = [];
    60→      for (const status of excludeArray) {
    61→        const mapped = STATUS_MAP[status.toUpperCase()];
    62→        if (mapped) {
    63→          dbExcludeStatuses.push(...mapped);
    64→        } else {
    65→          dbExcludeStatuses.push(status.toLowerCase());
    66→        }
    67→      }
    68→      // If we already have a status filter, combine with $nin
    69→      if (query.status) {
    70→        query.status.$nin = [...new Set(dbExcludeStatuses)];
    71→      } else {
    72→        query.status = { $nin: [...new Set(dbExcludeStatuses)] };
    73→      }
    74→    }
    75→
    76→    // Search by VRM, make, model if query provided
    77→    if (q && q.length >= 2) {
    78→      const searchRegex = new RegExp(q.replace(/\s/g, ""), "i");
    79→      query.$or = [
    80→        { regCurrent: searchRegex },
    81→        { make: { $regex: q, $options: "i" } },
    82→        { model: { $regex: q, $options: "i" } },
    83→      ];
    84→    }
    85→
    86→    const vehicles = await Vehicle.find(query)
    87→      .sort({ updatedAt: -1, createdAt: -1 }) // Sort by most recent activity first
    88→      .limit(parseInt(limit))
    89→      .lean();
    90→
    91→    // Transform for form use
    92→    const results = vehicles.map((v) => ({
    93→      id: v._id.toString(),
    94→      vrm: v.regCurrent,
    95→      regCurrent: v.regCurrent,
    96→      make: v.make,
    97→      model: v.model,
    98→      year: v.year,
    99→      colour: v.colour,
   100→      fuelType: v.fuelType,
   101→      transmission: v.transmission,
   102→      mileage: v.mileageCurrent,
   103→      status: v.status,
   104→      type: v.type,
   105→      updatedAt: v.updatedAt,
   106→      createdAt: v.createdAt,
   107→      displayName: `${v.regCurrent} - ${v.make} ${v.model}${v.year ? ` (${v.year})` : ""}`,
   108→    }));
   109→
   110→    return res.status(200).json(results);
   111→  } catch (error) {
   112→    console.error("Vehicle search error:", error);
   113→    return res.status(error.status || 500).json({ error: error.message || "Failed to search vehicles" });
   114→  }
   115→}
   116→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
