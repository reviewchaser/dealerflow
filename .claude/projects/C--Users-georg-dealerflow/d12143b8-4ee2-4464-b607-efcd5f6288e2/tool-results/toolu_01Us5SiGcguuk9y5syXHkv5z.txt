     1→import { useEffect, useState, useRef, useCallback } from "react";
     2→import Head from "next/head";
     3→import Link from "next/link";
     4→import { useRouter } from "next/router";
     5→import DashboardLayout from "@/components/DashboardLayout";
     6→import { toast } from "react-hot-toast";
     7→import { showDummyNotification } from "@/utils/notifications";
     8→import { BottomSheet } from "@/components/ui/BottomSheet";
     9→import { Portal } from "@/components/ui/Portal";
    10→import { MobileStageSelector } from "@/components/ui/PageShell";
    11→import useDealerRedirect from "@/hooks/useDealerRedirect";
    12→import VehicleImage from "@/components/VehicleImage";
    13→
    14→const COLUMNS = [
    15→  { key: "in_stock", label: "Not Advertised", gradient: "from-orange-100/60", accent: "border-l-orange-400", accentBg: "bg-orange-400" },
    16→  { key: "in_prep", label: "Advertised", gradient: "from-blue-100/60", accent: "border-l-blue-400", accentBg: "bg-blue-400" },
    17→  { key: "live", label: "Sold In Progress", gradient: "from-cyan-100/60", accent: "border-l-cyan-400", accentBg: "bg-cyan-400" },
    18→  { key: "reserved", label: "Completed", gradient: "from-emerald-100/60", accent: "border-l-emerald-400", accentBg: "bg-emerald-400" },
    19→  { key: "delivered", label: "Delivered", gradient: "from-teal-100/60", accent: "border-l-teal-400", accentBg: "bg-teal-400" },
    20→];
    21→
    22→const ISSUE_SUBCATEGORIES = {
    23→  mechanical: ["Engine", "Transmission", "Suspension", "Brakes", "Exhaust", "Other"],
    24→  electrical: ["Battery", "Lights", "Starter Motor", "Alternator", "Sensors", "Other"],
    25→  bodywork: ["Panel Damage", "Scratches", "Dents", "Bumper", "Windscreen", "Other"],
    26→  interior: ["Seats", "Dashboard", "Trim", "Carpet", "Controls", "Other"],
    27→  tyres: ["Tread Depth", "Puncture", "Alloys", "Alignment", "Other"],
    28→  mot: ["Advisory", "Failed Item", "Due Soon", "Other"],
    29→  service: ["Oil Change", "Filters", "Fluids", "Timing Belt", "Other"],
    30→  fault_codes: ["Engine", "Transmission", "ABS", "Airbag", "Emissions", "Other"],
    31→  other: ["General", "Misc"],
    32→};
    33→
    34→// Sold statuses - these show "Sold X days" instead of "In stock X days"
    35→const SOLD_STATUSES = ["live", "reserved", "delivered"];
    36→
    37→// Helper to compute duration label based on status
    38→const getVehicleDuration = (vehicle) => {
    39→  const isSold = SOLD_STATUSES.includes(vehicle.status);
    40→
    41→  if (isSold) {
    42→    if (vehicle.soldAt) {
    43→      const daysSold = Math.floor((Date.now() - new Date(vehicle.soldAt).getTime()) / (1000 * 60 * 60 * 24));
    44→      return { days: daysSold, label: `Sold ${daysSold}d`, isSold: true };
    45→    }
    46→    // Legacy sold vehicle without soldAt - just show "Sold"
    47→    return { days: 0, label: "Sold", isSold: true };
    48→  }
    49→
    50→  const daysInStock = vehicle.createdAt
    51→    ? Math.floor((Date.now() - new Date(vehicle.createdAt).getTime()) / (1000 * 60 * 60 * 24))
    52→    : 0;
    53→  return { days: daysInStock, label: `${daysInStock}d in stock`, isSold: false };
    54→};
    55→
    56→export default function SalesPrep() {
    57→  const router = useRouter();
    58→  const { isRedirecting } = useDealerRedirect();
    59→  const [vehicles, setVehicles] = useState([]);
    60→  const [isLoading, setIsLoading] = useState(true);
    61→  const [selectedVehicle, setSelectedVehicle] = useState(null);
    62→  const [isLookingUpDrawer, setIsLookingUpDrawer] = useState(false);
    63→  const [showAddModal, setShowAddModal] = useState(false);
    64→  const [draggedCard, setDraggedCard] = useState(null);
    65→  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });
    66→  const [newTaskName, setNewTaskName] = useState("");
    67→  const [activeTab, setActiveTab] = useState("overview");
    68→  const [editingTaskId, setEditingTaskId] = useState(null);
    69→  const [editingTaskName, setEditingTaskName] = useState("");
    70→
    71→  // Parts ordering state
    72→  const [showPartsOrderModal, setShowPartsOrderModal] = useState(false);
    73→  const [partsOrderTaskId, setPartsOrderTaskId] = useState(null);
    74→  const [partsOrderForm, setPartsOrderForm] = useState({
    75→    supplierType: "EURO_CAR_PARTS",
    76→    supplierName: "",
    77→    orderRef: "",
    78→    expectedAt: "",
    79→    notes: "",
    80→  });
    81→  const [editingPartsOrderId, setEditingPartsOrderId] = useState(null);
    82→
    83→  // Column sorting state
    84→  const [columnSortOptions, setColumnSortOptions] = useState({});
    85→
    86→  // Job sheet share state
    87→  const [showJobSheetModal, setShowJobSheetModal] = useState(false);
    88→  const [jobSheetLink, setJobSheetLink] = useState(null);
    89→  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);
    90→
    91→  // Prep summary share state
    92→  const [showPrepSummaryModal, setShowPrepSummaryModal] = useState(false);
    93→  const [prepSummaryLink, setPrepSummaryLink] = useState(null);
    94→  const [isGeneratingPrepSummary, setIsGeneratingPrepSummary] = useState(false);
    95→
    96→  // Manual share fallback modal
    97→  const [showManualShareModal, setShowManualShareModal] = useState(false);
    98→  const [manualShareUrl, setManualShareUrl] = useState("");
    99→
   100→  // Mobile move bottom sheet
   101→  const [moveVehicle, setMoveVehicle] = useState(null);
   102→  const [moveCurrentColumn, setMoveCurrentColumn] = useState(null);
   103→
   104→  // Issues state
   105→  const [showAddIssueModal, setShowAddIssueModal] = useState(false);
   106→  const [editingIssue, setEditingIssue] = useState(null); // For edit mode
   107→  const [issueForm, setIssueForm] = useState({
   108→    category: "",
   109→    subcategory: "",
   110→    description: "",
   111→    actionNeeded: "",
   112→    priority: "medium",
   113→    location: "",
   114→    status: "outstanding",
   115→    notes: "",
   116→    photos: [],
   117→    partsRequired: false,
   118→    partsDetails: "",
   119→  });
   120→  const [issueUpdateContent, setIssueUpdateContent] = useState({});
   121→  const [expandedIssues, setExpandedIssues] = useState({});
   122→
   123→  // Filters state - with localStorage persistence
   124→  const [activeFilters, setActiveFilters] = useState([]);
   125→  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);
   126→  const filterButtonRef = useRef(null);
   127→  const [filterPopoverPos, setFilterPopoverPos] = useState({ top: 0, right: 0 });
   128→
   129→  // Calculate popover position when opening
   130→  const openFiltersDropdown = useCallback(() => {
   131→    if (filterButtonRef.current) {
   132→      const rect = filterButtonRef.current.getBoundingClientRect();
   133→      const viewportHeight = window.innerHeight;
   134→      const viewportWidth = window.innerWidth;
   135→
   136→      // Position below the button, aligned to right edge
   137→      let top = rect.bottom + 8;
   138→      let right = viewportWidth - rect.right;
   139→
   140→      // Ensure popover doesn't go below viewport (max 70vh height + 16px padding)
   141→      const popoverHeight = Math.min(viewportHeight * 0.7, 600);
   142→      if (top + popoverHeight > viewportHeight - 16) {
   143→        top = Math.max(16, viewportHeight - popoverHeight - 16);
   144→      }
   145→
   146→      // Ensure popover doesn't go off right edge
   147→      right = Math.max(16, right);
   148→
   149→      setFilterPopoverPos({ top, right });
   150→    }
   151→    setShowFiltersDropdown(true);
   152→  }, []);
   153→
   154→  // Load filters from localStorage on mount
   155→  useEffect(() => {
   156→    try {
   157→      const savedFilters = localStorage.getItem("salesPrepFilters");
   158→      if (savedFilters) {
   159→        setActiveFilters(JSON.parse(savedFilters));
   160→      }
   161→    } catch (e) {
   162→      console.warn("Failed to load saved filters:", e);
   163→    }
   164→  }, []);
   165→
   166→  // Save filters to localStorage when they change
   167→  useEffect(() => {
   168→    try {
   169→      localStorage.setItem("salesPrepFilters", JSON.stringify(activeFilters));
   170→    } catch (e) {
   171→      console.warn("Failed to save filters:", e);
   172→    }
   173→  }, [activeFilters]);
   174→
   175→  // Documents state
   176→  const [showAddDocumentModal, setShowAddDocumentModal] = useState(false);
   177→  const [documentForm, setDocumentForm] = useState({
   178→    name: "",
   179→    type: "other",
   180→    file: null,
   181→  });
   182→
   183→  // Location state
   184→  const [locations, setLocations] = useState([]);
   185→  const [showAddLocationModal, setShowAddLocationModal] = useState(false);
   186→
   187→  // Vehicle Labels state
   188→  const [availableLabels, setAvailableLabels] = useState([]);
   189→  const [showLabelsDropdown, setShowLabelsDropdown] = useState(false);
   190→  const [showAddLabelModal, setShowAddLabelModal] = useState(false);
   191→  const [newLabelForm, setNewLabelForm] = useState({ name: "", colour: "#6366f1" });
   192→
   193→  // Activity log state
   194→  const [activityData, setActivityData] = useState({ activities: [], total: 0, hasMore: false });
   195→  const [activityLoading, setActivityLoading] = useState(false);
   196→
   197→  // VRM Search state
   198→  const [vrmSearch, setVrmSearch] = useState("");
   199→  const [showVrmDropdown, setShowVrmDropdown] = useState(false);
   200→  const [vrmSearchResults, setVrmSearchResults] = useState([]);
   201→  const [vrmSearchLoading, setVrmSearchLoading] = useState(false);
   202→  const vrmSearchTimeout = useRef(null);
   203→
   204→  // Mobile state
   205→  const [mobileActiveColumn, setMobileActiveColumn] = useState("in_stock");
   206→
   207→  useEffect(() => {
   208→    fetchVehicles();
   209→    fetchLocations();
   210→    fetchLabels();
   211→  }, []);
   212→
   213→  // Handle addVehicle query param (from Quick Add menu)
   214→  useEffect(() => {
   215→    if (router.query.addVehicle === "1") {
   216→      setShowAddModal(true);
   217→      // Remove the query param from URL without reload
   218→      router.replace("/sales-prep", undefined, { shallow: true });
   219→    }
   220→  }, [router.query.addVehicle]);
   221→
   222→  const fetchVehicles = async () => {
   223→    try {
   224→      const res = await fetch("/api/vehicles");
   225→      if (!res.ok) {
   226→        throw new Error(`API error: ${res.status}`);
   227→      }
   228→      const data = await res.json();
   229→      setVehicles(Array.isArray(data) ? data : []);
   230→    } catch (error) {
   231→      console.error("Failed to load vehicles:", error);
   232→      toast.error("Failed to load vehicles");
   233→      setVehicles([]);
   234→    } finally {
   235→      setIsLoading(false);
   236→    }
   237→  };
   238→
   239→  const fetchLocations = async () => {
   240→    try {
   241→      const res = await fetch("/api/locations");
   242→      const data = await res.json();
   243→      setLocations(data);
   244→    } catch (error) {
   245→      console.error("Failed to load locations:", error);
   246→    }
   247→  };
   248→
   249→  const fetchLabels = async () => {
   250→    try {
   251→      const res = await fetch("/api/labels");
   252→      const data = await res.json();
   253→      setAvailableLabels(Array.isArray(data) ? data : []);
   254→    } catch (error) {
   255→      console.error("Failed to load labels:", error);
   256→    }
   257→  };
   258→
   259→  // Fetch vehicle activity log
   260→  const fetchActivity = async (vehicleId, loadMore = false) => {
   261→    if (!vehicleId) return;
   262→    setActivityLoading(true);
   263→    try {
   264→      const offset = loadMore ? activityData.activities.length : 0;
   265→      const res = await fetch(`/api/vehicles/${vehicleId}/activity?limit=25&offset=${offset}`);
   266→      const data = await res.json();
   267→      if (loadMore) {
   268→        setActivityData(prev => ({
   269→          activities: [...prev.activities, ...data.activities],
   270→          total: data.total,
   271→          hasMore: data.hasMore,
   272→        }));
   273→      } else {
   274→        setActivityData(data);
   275→      }
   276→    } catch (error) {
   277→      console.error("Failed to load activity:", error);
   278→    } finally {
   279→      setActivityLoading(false);
   280→    }
   281→  };
   282→
   283→  // Format relative time for activity log
   284→  const formatRelativeTime = (dateStr) => {
   285→    const date = new Date(dateStr);
   286→    const now = new Date();
   287→    const diffMs = now - date;
   288→    const diffMins = Math.floor(diffMs / 60000);
   289→    const diffHours = Math.floor(diffMs / 3600000);
   290→    const diffDays = Math.floor(diffMs / 86400000);
   291→
   292→    if (diffMins < 1) return "just now";
   293→    if (diffMins < 60) return `${diffMins}m ago`;
   294→    if (diffHours < 24) return `${diffHours}h ago`;
   295→    if (diffDays < 7) return `${diffDays}d ago`;
   296→    return date.toLocaleDateString("en-GB", { day: "numeric", month: "short" });
   297→  };
   298→
   299→  // Toggle a label on/off for a vehicle
   300→  const toggleVehicleLabel = async (vehicleId, labelId) => {
   301→    try {
   302→      const res = await fetch(`/api/vehicles/${vehicleId}/labels/${labelId}`, {
   303→        method: "POST",
   304→      });
   305→      if (res.ok) {
   306→        const updatedData = await res.json();
   307→        // Update selected vehicle if it's the same one
   308→        if (selectedVehicle?.id === vehicleId) {
   309→          setSelectedVehicle(prev => ({
   310→            ...prev,
   311→            labels: updatedData.labels || [],
   312→          }));
   313→        }
   314→        fetchVehicles();
   315→      }
   316→    } catch (error) {
   317→      toast.error("Failed to update label");
   318→    }
   319→  };
   320→
   321→  // Create a new label
   322→  const createLabel = async () => {
   323→    if (!newLabelForm.name.trim()) {
   324→      toast.error("Label name is required");
   325→      return;
   326→    }
   327→    try {
   328→      const res = await fetch("/api/labels", {
   329→        method: "POST",
   330→        headers: { "Content-Type": "application/json" },
   331→        body: JSON.stringify(newLabelForm),
   332→      });
   333→      if (res.ok) {
   334→        const newLabel = await res.json();
   335→        setAvailableLabels(prev => [...prev, newLabel]);
   336→        setNewLabelForm({ name: "", colour: "#6366f1" });
   337→        setShowAddLabelModal(false);
   338→        toast.success("Label created");
   339→      }
   340→    } catch (error) {
   341→      toast.error("Failed to create label");
   342→    }
   343→  };
   344→
   345→  // Open vehicle drawer - vehicle from grid already has tasks, issues, documents
   346→  const openVehicleDrawer = (vehicle) => {
   347→    setSelectedVehicle({ ...vehicle, id: vehicle.id || vehicle._id });
   348→    setActiveTab("overview");
   349→    setShowLabelsDropdown(false); // Close labels dropdown when opening new vehicle
   350→    setActivityData({ activities: [], total: 0, hasMore: false }); // Reset activity when opening new vehicle
   351→  };
   352→
   353→  const updateVehicleStatus = async (vehicleId, newStatus) => {
   354→    try {
   355→      await fetch(`/api/vehicles/${vehicleId}`, {
   356→        method: "PUT",
   357→        headers: { "Content-Type": "application/json" },
   358→        body: JSON.stringify({ status: newStatus }),
   359→      });
   360→      fetchVehicles();
   361→      toast.success(`Moved to ${newStatus.replace("_", " ")}`);
   362→    } catch (error) {
   363→      toast.error("Failed to update");
   364→    }
   365→  };
   366→
   367→  // DVLA lookup for existing vehicle in drawer
   368→  const lookupVehicleDVLA = async () => {
   369→    if (!selectedVehicle?.regCurrent) {
   370→      toast.error("No registration to lookup");
   371→      return;
   372→    }
   373→    setIsLookingUpDrawer(true);
   374→    try {
   375→      const res = await fetch("/api/dvla-lookup", {
   376→        method: "POST",
   377→        headers: { "Content-Type": "application/json" },
   378→        body: JSON.stringify({ vehicleReg: selectedVehicle.regCurrent }),
   379→      });
   380→      const data = await res.json();
   381→
   382→      if (!res.ok || data.error) {
   383→        toast.error(data.message || data.error || "Vehicle not found");
   384→        return;
   385→      }
   386→
   387→      if (data.isDummy) showDummyNotification("DVLA API");
   388→
   389→      // Update the vehicle with DVLA data
   390→      const updatePayload = {
   391→        make: data.make || selectedVehicle.make,
   392→        model: data.model || selectedVehicle.model,
   393→        year: data.yearOfManufacture || data.year || selectedVehicle.year,
   394→        colour: data.colour || selectedVehicle.colour,
   395→        fuelType: data.fuelType || selectedVehicle.fuelType,
   396→        transmission: data.transmission || selectedVehicle.transmission,
   397→        motExpiryDate: data.motExpiryDate || selectedVehicle.motExpiryDate,
   398→        dvlaDetails: data.dvlaDetails || null,
   399→        lastDvlaFetchAt: data.lastDvlaFetchAt || new Date().toISOString(),
   400→      };
   401→
   402→      await fetch(`/api/vehicles/${selectedVehicle.id}`, {
   403→        method: "PUT",
   404→        headers: { "Content-Type": "application/json" },
   405→        body: JSON.stringify(updatePayload),
   406→      });
   407→
   408→      // Refresh vehicle data
   409→      const updatedRes = await fetch(`/api/vehicles/${selectedVehicle.id}`);
   410→      const updatedVehicle = await updatedRes.json();
   411→      setSelectedVehicle(updatedVehicle);
   412→      fetchVehicles();
   413→
   414→      toast.success(`Updated: ${data.make} ${data.model || ""} (${data.yearOfManufacture || ""})`);
   415→    } catch (error) {
   416→      toast.error("Lookup failed - please try again");
   417→    } finally {
   418→      setIsLookingUpDrawer(false);
   419→    }
   420→  };
   421→
   422→  const updateTaskStatus = async (taskId, newStatus) => {
   423→    // Optimistic update: immediately update local state
   424→    const previousVehicle = selectedVehicle;
   425→    const previousVehicles = vehicles;
   426→
   427→    // Update selectedVehicle optimistically
   428→    if (selectedVehicle) {
   429→      const updatedTasks = selectedVehicle.tasks?.map(task =>
   430→        task.id === taskId
   431→          ? {
   432→              ...task,
   433→              status: newStatus,
   434→              completedAt: newStatus === "done" ? new Date().toISOString() : task.completedAt,
   435→              progress: newStatus !== "in_progress" ? "NONE" : task.progress,
   436→              progressNote: newStatus !== "in_progress" ? "" : task.progressNote,
   437→            }
   438→          : task
   439→      );
   440→      setSelectedVehicle({ ...selectedVehicle, tasks: updatedTasks });
   441→    }
   442→
   443→    // Update vehicles list optimistically
   444→    setVehicles(vehicles.map(v =>
   445→      v.id === selectedVehicle?.id
   446→        ? {
   447→            ...v,
   448→            tasks: v.tasks?.map(task =>
   449→              task.id === taskId
   450→                ? { ...task, status: newStatus }
   451→                : task
   452→            ),
   453→          }
   454→        : v
   455→    ));
   456→
   457→    try {
   458→      const payload = { status: newStatus };
   459→      if (newStatus === "done") {
   460→        payload.completedAt = new Date().toISOString();
   461→      }
   462→      // Clear progress when changing status (optional: keep if staying in_progress)
   463→      if (newStatus !== "in_progress") {
   464→        payload.progress = "NONE";
   465→        payload.progressNote = "";
   466→      }
   467→      const res = await fetch(`/api/tasks/${taskId}`, {
   468→        method: "PUT",
   469→        headers: { "Content-Type": "application/json" },
   470→        body: JSON.stringify(payload),
   471→      });
   472→
   473→      if (!res.ok) throw new Error("Failed to update");
   474→
   475→      // Background refresh to sync any server-side changes
   476→      fetchVehicles();
   477→    } catch (error) {
   478→      // Rollback on error
   479→      toast.error("Failed to update task");
   480→      setSelectedVehicle(previousVehicle);
   481→      setVehicles(previousVehicles);
   482→    }
   483→  };
   484→
   485→  // Update task progress sub-status (for parts ordering, booking, etc.)
   486→  const updateTaskProgress = async (taskId, progress, progressNote = null) => {
   487→    // Optimistic update
   488→    const previousVehicle = selectedVehicle;
   489→
   490→    if (selectedVehicle) {
   491→      const updatedTasks = selectedVehicle.tasks?.map(task =>
   492→        task.id === taskId
   493→          ? {
   494→              ...task,
   495→              progress,
   496→              progressNote: progressNote !== null ? progressNote : task.progressNote,
   497→            }
   498→          : task
   499→      );
   500→      setSelectedVehicle({ ...selectedVehicle, tasks: updatedTasks });

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
