     1→import { useEffect, useState } from "react";
     2→import { useSession } from "next-auth/react";
     3→import { useRouter } from "next/router";
     4→import Head from "next/head";
     5→import Link from "next/link";
     6→import DashboardLayout from "@/components/DashboardLayout";
     7→import { toast } from "react-hot-toast";
     8→
     9→export default function HolidaySettings() {
    10→  const router = useRouter();
    11→  const { data: session } = useSession();
    12→  const [requests, setRequests] = useState([]);
    13→  const [loading, setLoading] = useState(true);
    14→  const [filter, setFilter] = useState("all"); // all, pending, approved, rejected
    15→  const [searchQuery, setSearchQuery] = useState(""); // Employee name search
    16→  const [userRole, setUserRole] = useState(null);
    17→
    18→  // Read filter from URL on load
    19→  useEffect(() => {
    20→    if (router.query.filter) {
    21→      setFilter(router.query.filter);
    22→    }
    23→  }, [router.query.filter]);
    24→  const [showCreateModal, setShowCreateModal] = useState(false);
    25→  const [teamMembers, setTeamMembers] = useState([]);
    26→  const [newRequest, setNewRequest] = useState({
    27→    startDate: "",
    28→    endDate: "",
    29→    startSession: "AM",
    30→    endSession: "PM",
    31→    type: "Holiday",
    32→    notes: "",
    33→    requestForUserId: "",
    34→  });
    35→  const [adminNote, setAdminNote] = useState("");
    36→  const [actionModal, setActionModal] = useState({ open: false, request: null, action: null });
    37→  const [isProcessing, setIsProcessing] = useState(false);
    38→
    39→  const isAdmin = userRole === "OWNER" || userRole === "ADMIN";
    40→
    41→  // Fetch user's role from dealer context
    42→  useEffect(() => {
    43→    const fetchRole = async () => {
    44→      try {
    45→        const res = await fetch("/api/dealer");
    46→        if (res.ok) {
    47→          const data = await res.json();
    48→          setUserRole(data.currentUserRole);
    49→          console.log("Holiday page - fetched role:", data.currentUserRole);
    50→        }
    51→      } catch (error) {
    52→        console.error("Failed to fetch user role:", error);
    53→      }
    54→    };
    55→    fetchRole();
    56→  }, []);
    57→
    58→  useEffect(() => {
    59→    fetchRequests();
    60→    if (isAdmin) {
    61→      fetchTeamMembers();
    62→    }
    63→  }, [isAdmin]);
    64→
    65→  const fetchRequests = async () => {
    66→    try {
    67→      const res = await fetch("/api/holiday-requests");
    68→      if (!res.ok) throw new Error("Failed to fetch");
    69→      const data = await res.json();
    70→      setRequests(data);
    71→    } catch (error) {
    72→      toast.error("Failed to load holiday requests");
    73→    } finally {
    74→      setLoading(false);
    75→    }
    76→  };
    77→
    78→  const fetchTeamMembers = async () => {
    79→    try {
    80→      const res = await fetch("/api/team");
    81→      if (!res.ok) throw new Error("Failed to fetch");
    82→      const data = await res.json();
    83→      setTeamMembers(data);
    84→    } catch (error) {
    85→      console.error("Failed to load team members");
    86→    }
    87→  };
    88→
    89→  const handleApprove = async (request) => {
    90→    // Defensive check for missing ID
    91→    const requestId = request?.id || request?._id;
    92→    if (!requestId) {
    93→      toast.error("Missing request ID - cannot approve");
    94→      console.error("handleApprove called with missing ID:", request);
    95→      return;
    96→    }
    97→
    98→    setIsProcessing(true);
    99→    try {
   100→      const res = await fetch(`/api/holiday-requests/${requestId}/approve`, {
   101→        method: "POST",
   102→        headers: { "Content-Type": "application/json" },
   103→        body: JSON.stringify({ adminNote: adminNote || null }),
   104→      });
   105→      if (!res.ok) {
   106→        const data = await res.json().catch(() => ({}));
   107→        throw new Error(data.error || "Failed to approve");
   108→      }
   109→      toast.success("Holiday approved");
   110→      setActionModal({ open: false, request: null, action: null });
   111→      setAdminNote("");
   112→      fetchRequests();
   113→    } catch (error) {
   114→      toast.error(error.message || "Failed to approve request");
   115→    } finally {
   116→      setIsProcessing(false);
   117→    }
   118→  };
   119→
   120→  const handleReject = async (request) => {
   121→    // Defensive check for missing ID
   122→    const requestId = request?.id || request?._id;
   123→    if (!requestId) {
   124→      toast.error("Missing request ID - cannot reject");
   125→      console.error("handleReject called with missing ID:", request);
   126→      return;
   127→    }
   128→
   129→    setIsProcessing(true);
   130→    try {
   131→      const res = await fetch(`/api/holiday-requests/${requestId}/reject`, {
   132→        method: "POST",
   133→        headers: { "Content-Type": "application/json" },
   134→        body: JSON.stringify({ adminNote: adminNote || null }),
   135→      });
   136→      if (!res.ok) {
   137→        const data = await res.json().catch(() => ({}));
   138→        throw new Error(data.error || "Failed to reject");
   139→      }
   140→      toast.success("Holiday rejected");
   141→      setActionModal({ open: false, request: null, action: null });
   142→      setAdminNote("");
   143→      fetchRequests();
   144→    } catch (error) {
   145→      toast.error(error.message || "Failed to reject request");
   146→    } finally {
   147→      setIsProcessing(false);
   148→    }
   149→  };
   150→
   151→  const handleDelete = async (requestId) => {
   152→    if (!requestId) {
   153→      toast.error("Missing request ID - cannot delete");
   154→      return;
   155→    }
   156→    if (!confirm("Delete this holiday request?")) return;
   157→    try {
   158→      const res = await fetch(`/api/holiday-requests/${requestId}`, {
   159→        method: "DELETE",
   160→      });
   161→      if (!res.ok) {
   162→        const data = await res.json().catch(() => ({}));
   163→        throw new Error(data.error || `Delete failed (${res.status})`);
   164→      }
   165→      toast.success("Holiday request deleted");
   166→      fetchRequests();
   167→    } catch (error) {
   168→      console.error("Delete error:", error);
   169→      toast.error(error.message || "Failed to delete request");
   170→    }
   171→  };
   172→
   173→  // Compute total days based on AM/PM sessions (mirrors server logic)
   174→  const computeTotalDays = (startDate, endDate, startSession, endSession) => {
   175→    const start = new Date(startDate);
   176→    const end = new Date(endDate);
   177→    start.setHours(0, 0, 0, 0);
   178→    end.setHours(0, 0, 0, 0);
   179→
   180→    const msPerDay = 1000 * 60 * 60 * 24;
   181→    const daysDiff = Math.round((end - start) / msPerDay);
   182→
   183→    if (daysDiff < 0) return null;
   184→
   185→    // Same day
   186→    if (daysDiff === 0) {
   187→      if (startSession === "PM" && endSession === "AM") return null;
   188→      if (startSession === "AM" && endSession === "PM") return 1.0;
   189→      return 0.5;
   190→    }
   191→
   192→    // Multi-day
   193→    const startDayValue = startSession === "PM" ? 0.5 : 1.0;
   194→    const endDayValue = endSession === "AM" ? 0.5 : 1.0;
   195→    const middleDays = daysDiff - 1;
   196→
   197→    return startDayValue + middleDays + endDayValue;
   198→  };
   199→
   200→  const handleCreateRequest = async (e) => {
   201→    e.preventDefault();
   202→    if (!newRequest.startDate) {
   203→      toast.error("Please select a start date");
   204→      return;
   205→    }
   206→
   207→    // Client-side validation
   208→    const start = new Date(newRequest.startDate);
   209→    // End date defaults to start date if not provided
   210→    const end = newRequest.endDate ? new Date(newRequest.endDate) : new Date(newRequest.startDate);
   211→
   212→    if (end < start) {
   213→      toast.error("End date must be on or after start date");
   214→      return;
   215→    }
   216→
   217→    // Compute total days with AM/PM
   218→    const totalDays = computeTotalDays(start, end, newRequest.startSession, newRequest.endSession);
   219→
   220→    if (totalDays === null) {
   221→      toast.error("Invalid session combination: PM to AM on the same day is not allowed");
   222→      return;
   223→    }
   224→
   225→    if (totalDays > 60) {
   226→      toast.error("Holiday request cannot exceed 60 days");
   227→      return;
   228→    }
   229→
   230→    // Check date range - start not more than 1 year ago
   231→    const oneYearAgo = new Date();
   232→    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
   233→    if (start < oneYearAgo) {
   234→      toast.error("Start date cannot be more than 1 year in the past");
   235→      return;
   236→    }
   237→
   238→    // End date not more than 2 years in future
   239→    const twoYearsFromNow = new Date();
   240→    twoYearsFromNow.setFullYear(twoYearsFromNow.getFullYear() + 2);
   241→    if (end > twoYearsFromNow) {
   242→      toast.error("End date cannot be more than 2 years in the future");
   243→      return;
   244→    }
   245→
   246→    try {
   247→      const res = await fetch("/api/holiday-requests", {
   248→        method: "POST",
   249→        headers: { "Content-Type": "application/json" },
   250→        body: JSON.stringify({
   251→          startDate: newRequest.startDate,
   252→          endDate: newRequest.endDate || newRequest.startDate, // Default to start date
   253→          startSession: newRequest.startSession,
   254→          endSession: newRequest.endSession,
   255→          type: newRequest.type,
   256→          notes: newRequest.notes,
   257→          requestForUserId: newRequest.requestForUserId,
   258→        }),
   259→      });
   260→      if (!res.ok) {
   261→        const data = await res.json();
   262→        throw new Error(data.error || "Failed to create");
   263→      }
   264→      toast.success("Holiday request created");
   265→      setShowCreateModal(false);
   266→      setNewRequest({ startDate: "", endDate: "", startSession: "AM", endSession: "PM", type: "Holiday", notes: "", requestForUserId: "" });
   267→      fetchRequests();
   268→    } catch (error) {
   269→      toast.error(error.message || "Failed to create request");
   270→    }
   271→  };
   272→
   273→  const calculateDays = (startDate, endDate) => {
   274→    const start = new Date(startDate);
   275→    const end = new Date(endDate);
   276→    const diffTime = Math.abs(end - start);
   277→    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
   278→    return diffDays;
   279→  };
   280→
   281→  const formatDate = (dateStr) => {
   282→    return new Date(dateStr).toLocaleDateString("en-GB", {
   283→      day: "numeric",
   284→      month: "short",
   285→      year: "numeric",
   286→    });
   287→  };
   288→
   289→  const timeAgo = (dateStr) => {
   290→    const now = new Date();
   291→    const date = new Date(dateStr);
   292→    const diffMs = now - date;
   293→    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
   294→
   295→    if (diffDays === 0) return "today";
   296→    if (diffDays === 1) return "1 day ago";
   297→    if (diffDays < 7) return `${diffDays} days ago`;
   298→    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
   299→    return `${Math.floor(diffDays / 30)} months ago`;
   300→  };
   301→
   302→  const getStatusBadge = (status) => {
   303→    switch (status) {
   304→      case "PENDING":
   305→        return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-200">Pending</span>;
   306→      case "APPROVED":
   307→        return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700 border border-emerald-200">Approved</span>;
   308→      case "REJECTED":
   309→        return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-red-50 text-red-700 border border-red-200">Rejected</span>;
   310→      default:
   311→        return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 border border-slate-200">{status}</span>;
   312→    }
   313→  };
   314→
   315→  const getTypeIcon = (type) => {
   316→    switch (type) {
   317→      case "Holiday":
   318→        return (
   319→          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   320→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
   321→          </svg>
   322→        );
   323→      case "Sick":
   324→        return (
   325→          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   326→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
   327→          </svg>
   328→        );
   329→      case "Unpaid":
   330→        return (
   331→          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   332→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
   333→          </svg>
   334→        );
   335→      default:
   336→        return (
   337→          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   338→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
   339→          </svg>
   340→        );
   341→    }
   342→  };
   343→
   344→  const filteredRequests = requests.filter((req) => {
   345→    // Status filter
   346→    if (filter !== "all" && req.status !== filter.toUpperCase()) {
   347→      return false;
   348→    }
   349→    // Employee name search filter
   350→    if (searchQuery.trim()) {
   351→      const query = searchQuery.toLowerCase();
   352→      const nameMatch = (req.userName || "").toLowerCase().includes(query);
   353→      const emailMatch = (req.userEmail || "").toLowerCase().includes(query);
   354→      if (!nameMatch && !emailMatch) return false;
   355→    }
   356→    return true;
   357→  });
   358→
   359→  // Calculate total approved days for the current year
   360→  const currentYear = new Date().getFullYear();
   361→  const approvedThisYear = requests.filter(
   362→    (r) => r.status === "APPROVED" && new Date(r.startDate).getFullYear() === currentYear
   363→  );
   364→  const totalApprovedDays = approvedThisYear.reduce(
   365→    (sum, r) => sum + calculateDays(r.startDate, r.endDate),
   366→    0
   367→  );
   368→  const pendingCount = requests.filter((r) => r.status === "PENDING").length;
   369→  const pendingDays = requests
   370→    .filter((r) => r.status === "PENDING")
   371→    .reduce((sum, r) => sum + calculateDays(r.startDate, r.endDate), 0);
   372→
   373→  return (
   374→    <DashboardLayout>
   375→      <Head><title>Holidays | Settings | DealerFlow</title></Head>
   376→
   377→      <div className="mb-6">
   378→        <div className="flex items-center gap-2 text-sm text-base-content/60 mb-2">
   379→          <Link href="/settings" className="hover:text-primary">Settings</Link>
   380→          <span>/</span>
   381→          <span>Holidays</span>
   382→        </div>
   383→        <div className="flex flex-col sm:flex-row justify-between items-start gap-4">
   384→          <div>
   385→            <h1 className="text-3xl font-bold">Holiday Requests</h1>
   386→            <p className="text-base-content/60 mt-1">
   387→              {isAdmin ? "Manage team holiday requests" : "View and request time off"}
   388→            </p>
   389→          </div>
   390→          <button
   391→            className="btn btn-primary w-full sm:w-auto"
   392→            onClick={() => setShowCreateModal(true)}
   393→          >
   394→            <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   395→              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
   396→            </svg>
   397→            Request Holiday
   398→          </button>
   399→        </div>
   400→      </div>
   401→
   402→      {/* Stats Cards */}
   403→      <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
   404→        <div className="card bg-base-200">
   405→          <div className="card-body p-4">
   406→            <p className="text-3xl font-bold text-success">{totalApprovedDays}</p>
   407→            <p className="text-sm text-base-content/60">Days approved ({currentYear})</p>
   408→          </div>
   409→        </div>
   410→        <div className="card bg-base-200">
   411→          <div className="card-body p-4">
   412→            <p className="text-3xl font-bold text-warning">{pendingCount}</p>
   413→            <p className="text-sm text-base-content/60">Pending requests</p>
   414→          </div>
   415→        </div>
   416→        <div className="card bg-base-200 col-span-2 md:col-span-1">
   417→          <div className="card-body p-4">
   418→            <p className="text-3xl font-bold">{pendingDays}</p>
   419→            <p className="text-sm text-base-content/60">Pending days</p>
   420→          </div>
   421→        </div>
   422→      </div>
   423→
   424→      {/* Search and Filters */}
   425→      <div className="flex flex-col sm:flex-row gap-4 mb-6">
   426→        {/* Employee Search */}
   427→        {isAdmin && (
   428→          <div className="relative">
   429→            <input
   430→              type="text"
   431→              placeholder="Search employee..."
   432→              value={searchQuery}
   433→              onChange={(e) => setSearchQuery(e.target.value)}
   434→              className="input input-sm input-bordered w-full sm:w-64 pr-8"
   435→            />
   436→            {searchQuery && (
   437→              <button
   438→                onClick={() => setSearchQuery("")}
   439→                className="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content"
   440→              >
   441→                ×
   442→              </button>
   443→            )}
   444→          </div>
   445→        )}
   446→
   447→        {/* Status Filters */}
   448→        <div className="flex gap-2">
   449→          <button
   450→            className={`btn btn-sm ${filter === "all" ? "btn-primary" : "btn-ghost"}`}
   451→            onClick={() => setFilter("all")}
   452→          >
   453→            All
   454→          </button>
   455→          <button
   456→            className={`btn btn-sm ${filter === "pending" ? "btn-warning" : "btn-ghost"}`}
   457→            onClick={() => setFilter("pending")}
   458→          >
   459→            Pending
   460→            {requests.filter((r) => r.status === "PENDING").length > 0 && (
   461→              <span className="badge badge-xs ml-1">
   462→                {requests.filter((r) => r.status === "PENDING").length}
   463→              </span>
   464→            )}
   465→          </button>
   466→          <button
   467→            className={`btn btn-sm ${filter === "approved" ? "btn-success" : "btn-ghost"}`}
   468→            onClick={() => setFilter("approved")}
   469→          >
   470→            Approved
   471→          </button>
   472→          <button
   473→            className={`btn btn-sm ${filter === "rejected" ? "btn-error" : "btn-ghost"}`}
   474→            onClick={() => setFilter("rejected")}
   475→          >
   476→            Rejected
   477→          </button>
   478→        </div>
   479→      </div>
   480→
   481→      {/* Requests List */}
   482→      {loading ? (
   483→        <div className="flex justify-center py-12">
   484→          <span className="loading loading-spinner loading-lg"></span>
   485→        </div>
   486→      ) : filteredRequests.length === 0 ? (
   487→        <div className="card bg-base-200">
   488→          <div className="card-body text-center py-12">
   489→            <p className="text-base-content/60">No holiday requests found</p>
   490→          </div>
   491→        </div>
   492→      ) : (
   493→        <div className="space-y-3">
   494→          {filteredRequests.map((request) => (
   495→            <div
   496→              key={request.id || request._id}
   497→              className="card bg-base-200 hover:bg-base-300/50 transition-colors"
   498→            >
   499→              <div className="card-body p-4">
   500→                <div className="flex items-start gap-4">
   501→                  {/* Type Icon */}
   502→                  <div className="p-2 bg-base-100 rounded-lg text-base-content/60">
   503→                    {getTypeIcon(request.type)}
   504→                  </div>
   505→
   506→                  {/* Main Content */}
   507→                  <div className="flex-1 min-w-0">
   508→                    <div className="flex items-center gap-2 flex-wrap">
   509→                      <span className="font-semibold">{request.userName}</span>
   510→                      {getStatusBadge(request.status)}
   511→                      <span className="text-sm text-base-content/50">{request.type}</span>
   512→                    </div>
   513→                    <div className="text-sm mt-1">
   514→                      <span className="font-medium">
   515→                        {formatDate(request.startDate)}
   516→                        {request.startSession && <span className="text-xs text-base-content/50 ml-1">({request.startSession})</span>}
   517→                        {" - "}
   518→                        {formatDate(request.endDate)}
   519→                        {request.endSession && <span className="text-xs text-base-content/50 ml-1">({request.endSession})</span>}
   520→                      </span>
   521→                      <span className="text-base-content/50 ml-2">
   522→                        {(() => {
   523→                          // Use server-computed days if available, otherwise calculate
   524→                          const days = request.totalDaysComputed || request.totalDays || calculateDays(request.startDate, request.endDate);
   525→                          if (days > 60) {
   526→                            return <span className="text-error font-semibold">⚠️ {days} days (invalid)</span>;
   527→                          }
   528→                          return `(${days} day${days !== 1 ? "s" : ""})`;
   529→                        })()}
   530→                      </span>
   531→                    </div>
   532→                    {request.notes && (
   533→                      <p className="text-sm text-base-content/60 mt-1 truncate">
   534→                        {request.notes}
   535→                      </p>
   536→                    )}
   537→                    <div className="flex items-center gap-4 mt-2 text-xs text-base-content/50">
   538→                      <span>Created {timeAgo(request.createdAt)}</span>
   539→                      {request.reviewedByName && (
   540→                        <span>
   541→                          {request.status === "APPROVED" ? "Approved" : "Rejected"} by {request.reviewedByName}
   542→                        </span>
   543→                      )}
   544→                    </div>
   545→                    {request.adminNote && (
   546→                      <div className="mt-2 p-2 bg-base-100 rounded text-sm">
   547→                        <span className="text-base-content/50">Note: </span>
   548→                        {request.adminNote}
   549→                      </div>
   550→                    )}
   551→                  </div>
   552→
   553→                  {/* Actions - Prominent buttons for Admin/Owner */}
   554→                  <div className="flex items-center gap-2 flex-shrink-0">
   555→                    {request.status === "PENDING" && isAdmin && (
   556→                      <>
   557→                        <button
   558→                          className="btn btn-success btn-sm gap-1 shadow-sm hover:shadow-md transition-all"
   559→                          onClick={() => setActionModal({ open: true, request, action: "approve" })}
   560→                          disabled={isProcessing}
   561→                        >
   562→                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   563→                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   564→                          </svg>
   565→                          Approve
   566→                        </button>
   567→                        <button
   568→                          className="btn btn-error btn-outline btn-sm gap-1"
   569→                          onClick={() => setActionModal({ open: true, request, action: "reject" })}
   570→                          disabled={isProcessing}
   571→                        >
   572→                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   573→                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   574→                          </svg>
   575→                          Reject
   576→                        </button>
   577→                      </>
   578→                    )}
   579→                    {(isAdmin || request.status === "PENDING") && (
   580→                      <button
   581→                        className="btn btn-sm btn-ghost text-error"
   582→                        onClick={() => handleDelete(request.id || request._id)}
   583→                        disabled={isProcessing}
   584→                        title="Delete request"
   585→                      >
   586→                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   587→                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
   588→                        </svg>
   589→                      </button>
   590→                    )}
   591→                  </div>
   592→                </div>
   593→              </div>
   594→            </div>
   595→          ))}
   596→        </div>
   597→      )}
   598→
   599→      {/* Create Request Modal */}
   600→      {showCreateModal && (
   601→        <div className="modal modal-open">
   602→          <div className="modal-box">
   603→            <h3 className="font-bold text-lg">Request Time Off</h3>
   604→            <form onSubmit={handleCreateRequest} className="mt-4 space-y-4">
   605→              {isAdmin && teamMembers.length > 0 && (
   606→                <div className="form-control">
   607→                  <label className="label">
   608→                    <span className="label-text">Request For</span>
   609→                  </label>
   610→                  <select
   611→                    className="select select-bordered"
   612→                    value={newRequest.requestForUserId}
   613→                    onChange={(e) => setNewRequest({ ...newRequest, requestForUserId: e.target.value })}
   614→                  >
   615→                    <option value="">Myself</option>
   616→                    {teamMembers.map((member) => (
   617→                      <option key={member.id} value={member.id}>
   618→                        {member.name || member.email}
   619→                      </option>
   620→                    ))}
   621→                  </select>
   622→                </div>
   623→              )}
   624→              <div className="form-control">
   625→                <label className="label">
   626→                  <span className="label-text">Type</span>
   627→                </label>
   628→                <select
   629→                  className="select select-bordered"
   630→                  value={newRequest.type}
   631→                  onChange={(e) => setNewRequest({ ...newRequest, type: e.target.value })}
   632→                >
   633→                  <option value="Holiday">Holiday</option>
   634→                  <option value="Sick">Sick Leave</option>
   635→                  <option value="Other">Other</option>
   636→                </select>
   637→              </div>
   638→              {/* Start Date and Session */}
   639→              <div className="grid grid-cols-3 gap-2">
   640→                <div className="form-control col-span-2">
   641→                  <label className="label">
   642→                    <span className="label-text">Start Date</span>
   643→                  </label>
   644→                  <input
   645→                    type="date"
   646→                    className="input input-bordered"
   647→                    value={newRequest.startDate}
   648→                    onChange={(e) => setNewRequest({ ...newRequest, startDate: e.target.value })}
   649→                    required
   650→                  />
   651→                </div>
   652→                <div className="form-control">
   653→                  <label className="label">
   654→                    <span className="label-text">Session</span>
   655→                  </label>
   656→                  <select
   657→                    className="select select-bordered"
   658→                    value={newRequest.startSession}
   659→                    onChange={(e) => setNewRequest({ ...newRequest, startSession: e.target.value })}
   660→                  >
   661→                    <option value="AM">AM</option>
   662→                    <option value="PM">PM</option>
   663→                  </select>
   664→                </div>
   665→              </div>
   666→
   667→              {/* End Date and Session */}
   668→              <div className="grid grid-cols-3 gap-2">
   669→                <div className="form-control col-span-2">
   670→                  <label className="label">
   671→                    <span className="label-text">End Date</span>
   672→                    <span className="label-text-alt text-base-content/50">Optional</span>
   673→                  </label>
   674→                  <input
   675→                    type="date"
   676→                    className="input input-bordered"
   677→                    value={newRequest.endDate}
   678→                    onChange={(e) => setNewRequest({ ...newRequest, endDate: e.target.value })}
   679→                    placeholder="Same as start"
   680→                  />
   681→                </div>
   682→                <div className="form-control">
   683→                  <label className="label">
   684→                    <span className="label-text">Session</span>
   685→                  </label>
   686→                  <select
   687→                    className="select select-bordered"
   688→                    value={newRequest.endSession}
   689→                    onChange={(e) => setNewRequest({ ...newRequest, endSession: e.target.value })}
   690→                  >
   691→                    <option value="AM">AM</option>
   692→                    <option value="PM">PM</option>
   693→                  </select>
   694→                </div>
   695→              </div>
   696→
   697→              {/* Computed Total Days Chip */}
   698→              {newRequest.startDate && (() => {
   699→                const start = new Date(newRequest.startDate);
   700→                const end = newRequest.endDate ? new Date(newRequest.endDate) : new Date(newRequest.startDate);
   701→                const totalDays = computeTotalDays(start, end, newRequest.startSession, newRequest.endSession);
   702→                const oneYearAgo = new Date();
   703→                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
   704→                const isTooOld = start < oneYearAgo;
   705→                const isInvalid = totalDays === null || totalDays > 60 || end < start;
   706→
   707→                return (
   708→                  <div className={`text-sm p-3 rounded-lg flex items-center gap-2 ${isInvalid || isTooOld ? 'bg-error/10 text-error' : 'bg-primary/10 text-primary'}`}>
   709→                    {end < start ? (
   710→                      <span>End date must be on or after start date</span>
   711→                    ) : totalDays === null ? (
   712→                      <span>Invalid: PM to AM on same day not allowed</span>
   713→                    ) : totalDays > 60 ? (
   714→                      <span>Maximum 60 days per request ({totalDays} days selected)</span>
   715→                    ) : isTooOld ? (
   716→                      <span>Start date is too far in the past</span>
   717→                    ) : (
   718→                      <>
   719→                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   720→                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
   721→                        </svg>
   722→                        <span className="font-semibold">
   723→                          Total requested: {totalDays} day{totalDays !== 1 ? 's' : ''}
   724→                        </span>
   725→                        {totalDays === 0.5 && <span className="text-xs opacity-75">(half day)</span>}
   726→                      </>
   727→                    )}
   728→                  </div>
   729→                );
   730→              })()}
   731→              <div className="form-control">
   732→                <label className="label">
   733→                  <span className="label-text">Notes (optional)</span>
   734→                </label>
   735→                <textarea
   736→                  className="textarea textarea-bordered"
   737→                  placeholder="Any additional details..."
   738→                  rows={2}
   739→                  value={newRequest.notes}
   740→                  onChange={(e) => setNewRequest({ ...newRequest, notes: e.target.value })}
   741→                />
   742→              </div>
   743→              <div className="modal-action">
   744→                <button
   745→                  type="button"
   746→                  className="btn btn-ghost"
   747→                  onClick={() => setShowCreateModal(false)}
   748→                >
   749→                  Cancel
   750→                </button>
   751→                <button type="submit" className="btn btn-primary">
   752→                  Submit Request
   753→                </button>
   754→              </div>
   755→            </form>
   756→          </div>
   757→          <div className="modal-backdrop" onClick={() => setShowCreateModal(false)}></div>
   758→        </div>
   759→      )}
   760→
   761→      {/* Approve/Reject Modal */}
   762→      {actionModal.open && actionModal.request && (
   763→        <div className="modal modal-open">
   764→          <div className="modal-box">
   765→            <h3 className="font-bold text-lg">
   766→              {actionModal.action === "approve" ? "Approve" : "Reject"} Holiday Request
   767→            </h3>
   768→            <div className="mt-4">
   769→              <div className="bg-base-200 p-3 rounded-lg">
   770→                <p className="font-semibold">{actionModal.request.userName}</p>
   771→                <p className="text-sm">
   772→                  {formatDate(actionModal.request.startDate)}
   773→                  {actionModal.request.startSession && <span className="text-xs text-base-content/50 ml-1">({actionModal.request.startSession})</span>}
   774→                  {" - "}
   775→                  {formatDate(actionModal.request.endDate)}
   776→                  {actionModal.request.endSession && <span className="text-xs text-base-content/50 ml-1">({actionModal.request.endSession})</span>}
   777→                  <span className="text-base-content/50 ml-2">
   778→                    ({actionModal.request.totalDaysComputed || actionModal.request.totalDays || calculateDays(actionModal.request.startDate, actionModal.request.endDate)} days)
   779→                  </span>
   780→                </p>
   781→                <p className="text-sm text-base-content/60">{actionModal.request.type}</p>
   782→              </div>
   783→              <div className="form-control mt-4">
   784→                <label className="label">
   785→                  <span className="label-text">Admin Note (optional)</span>
   786→                </label>
   787→                <textarea
   788→                  className="textarea textarea-bordered"
   789→                  placeholder={actionModal.action === "reject" ? "Reason for rejection..." : "Any notes..."}
   790→                  rows={2}
   791→                  value={adminNote}
   792→                  onChange={(e) => setAdminNote(e.target.value)}
   793→                />
   794→              </div>
   795→            </div>
   796→            <div className="modal-action">
   797→              <button
   798→                className="btn btn-ghost"
   799→                onClick={() => {
   800→                  setActionModal({ open: false, request: null, action: null });
   801→                  setAdminNote("");
   802→                }}
   803→                disabled={isProcessing}
   804→              >
   805→                Cancel
   806→              </button>
   807→              {actionModal.action === "approve" ? (
   808→                <button
   809→                  className="btn btn-success gap-2"
   810→                  onClick={() => handleApprove(actionModal.request)}
   811→                  disabled={isProcessing}
   812→                >
   813→                  {isProcessing ? (
   814→                    <span className="loading loading-spinner loading-sm"></span>
   815→                  ) : (
   816→                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   817→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   818→                    </svg>
   819→                  )}
   820→                  {isProcessing ? "Approving..." : "Approve"}
   821→                </button>
   822→              ) : (
   823→                <button
   824→                  className="btn btn-error gap-2"
   825→                  onClick={() => handleReject(actionModal.request)}
   826→                  disabled={isProcessing}
   827→                >
   828→                  {isProcessing ? (
   829→                    <span className="loading loading-spinner loading-sm"></span>
   830→                  ) : (
   831→                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   832→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   833→                    </svg>
   834→                  )}
   835→                  {isProcessing ? "Rejecting..." : "Confirm Reject"}
   836→                </button>
   837→              )}
   838→            </div>
   839→          </div>
   840→          <div
   841→            className="modal-backdrop"
   842→            onClick={() => {
   843→              setActionModal({ open: false, request: null, action: null });
   844→              setAdminNote("");
   845→            }}
   846→          ></div>
   847→        </div>
   848→      )}
   849→    </DashboardLayout>
   850→  );
   851→}
   852→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
