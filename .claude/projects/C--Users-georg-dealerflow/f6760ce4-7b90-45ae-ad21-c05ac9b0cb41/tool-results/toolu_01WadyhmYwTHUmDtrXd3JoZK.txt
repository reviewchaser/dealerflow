     1â†’import { useEffect, useState, useRef } from "react";
     2â†’import { useRouter } from "next/router";
     3â†’import Head from "next/head";
     4â†’import DashboardLayout from "@/components/DashboardLayout";
     5â†’import VehicleDrawer from "@/components/VehicleDrawer";
     6â†’import AISuggestionsPanel from "@/components/AISuggestionsPanel";
     7â†’import { BottomSheet } from "@/components/ui/BottomSheet";
     8â†’import { MobileStageSelector } from "@/components/ui/PageShell";
     9â†’import { toast } from "react-hot-toast";
    10â†’
    11â†’// Column config matching Sales & Prep style
    12â†’// NOTE: Internal keys are legacy names - keep stable for database compatibility
    13â†’// Display labels have been updated for clarity
    14â†’const COLUMNS = [
    15â†’  { key: "not_booked_in", label: "Not Booked In", gradient: "from-red-100/60", accent: "border-l-red-400", accentBg: "bg-red-400" },
    16â†’  { key: "on_site", label: "Booked In", gradient: "from-amber-100/60", accent: "border-l-amber-400", accentBg: "bg-amber-400" }, // Legacy key: "on_site" displays as "Booked In"
    17â†’  { key: "work_complete", label: "Work Complete", gradient: "from-blue-100/60", accent: "border-l-blue-400", accentBg: "bg-blue-400" },
    18â†’  { key: "collected", label: "Closed", gradient: "from-emerald-100/60", accent: "border-l-emerald-400", accentBg: "bg-emerald-400" }, // Legacy key: "collected" displays as "Closed"
    19â†’];
    20â†’
    21â†’const PRIORITIES = {
    22â†’  low: { bg: "bg-slate-100", text: "text-slate-600", border: "border-slate-200" },
    23â†’  normal: { bg: "bg-blue-50", text: "text-blue-700", border: "border-blue-100" },
    24â†’  high: { bg: "bg-amber-50", text: "text-amber-700", border: "border-amber-100" },
    25â†’  critical: { bg: "bg-red-50", text: "text-red-700", border: "border-red-100" },
    26â†’};
    27â†’
    28â†’const SOURCE_LABELS = {
    29â†’  warranty_claim_form: "Warranty Claim",
    30â†’  low_review: "Low Review",
    31â†’  complaint_form: "Complaint",
    32â†’  manual: "Manual",
    33â†’};
    34â†’
    35â†’// Timeline event icons
    36â†’const EVENT_ICONS = {
    37â†’  CASE_CREATED: "ðŸ“‹",
    38â†’  SUBMISSION_LINKED: "ðŸ”—",
    39â†’  COMMENT_ADDED: "ðŸ’¬",
    40â†’  STATUS_CHANGED: "ðŸ”„",
    41â†’  AI_REVIEW_GENERATED: "ðŸ¤–",
    42â†’  ATTACHMENT_ADDED: "ðŸ“Ž",
    43â†’  LOCATION_UPDATED: "ðŸ“",
    44â†’  BOOKING_UPDATED: "ðŸ“…",
    45â†’  PARTS_UPDATED: "ðŸ”§",
    46â†’  COURTESY_REQUIRED_TOGGLED: "ðŸš—",
    47â†’  COURTESY_ALLOCATED: "ðŸš—",
    48â†’  COURTESY_RETURNED: "ðŸš—",
    49â†’  COURTESY_OUT_RECORDED: "ðŸš—",
    50â†’  COURTESY_IN_RECORDED: "ðŸš—",
    51â†’  // Warranty booking auto-move events
    52â†’  WARRANTY_BOOKED_IN: "ðŸ“…",
    53â†’  WARRANTY_BOOKING_UPDATED: "ðŸ“…",
    54â†’  WARRANTY_BOOKING_CANCELLED: "âŒ",
    55â†’  WARRANTY_STAGE_MOVED: "ðŸ”€",
    56â†’};
    57â†’
    58â†’// Timeline grouping constant
    59â†’const STATUS_FLIP_GROUP_WINDOW_MS = 10 * 60 * 1000; // 10 minutes
    60â†’
    61â†’// Group consecutive STATUS_CHANGED events within the time window
    62â†’const groupTimelineEvents = (events) => {
    63â†’  if (!events || events.length === 0) return [];
    64â†’
    65â†’  const sorted = [...events].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    66â†’  const grouped = [];
    67â†’  let currentGroup = null;
    68â†’
    69â†’  for (const event of sorted) {
    70â†’    if (event.type === "STATUS_CHANGED") {
    71â†’      if (currentGroup) {
    72â†’        // Check if this event is within the time window of the last event in the group
    73â†’        const lastEventTime = new Date(currentGroup.events[currentGroup.events.length - 1].createdAt).getTime();
    74â†’        const thisEventTime = new Date(event.createdAt).getTime();
    75â†’
    76â†’        if (lastEventTime - thisEventTime <= STATUS_FLIP_GROUP_WINDOW_MS) {
    77â†’          currentGroup.events.push(event);
    78â†’          continue;
    79â†’        } else {
    80â†’          // Close current group and start new one
    81â†’          grouped.push(currentGroup);
    82â†’          currentGroup = { isGroup: true, type: "STATUS_CHANGED_GROUP", events: [event] };
    83â†’        }
    84â†’      } else {
    85â†’        currentGroup = { isGroup: true, type: "STATUS_CHANGED_GROUP", events: [event] };
    86â†’      }
    87â†’    } else {
    88â†’      // Non-status event - close any current group and add this event
    89â†’      if (currentGroup) {
    90â†’        grouped.push(currentGroup);
    91â†’        currentGroup = null;
    92â†’      }
    93â†’      grouped.push(event);
    94â†’    }
    95â†’  }
    96â†’
    97â†’  // Don't forget to add the last group if exists
    98â†’  if (currentGroup) {
    99â†’    grouped.push(currentGroup);
   100â†’  }
   101â†’
   102â†’  return grouped;
   103â†’};
   104â†’
   105â†’// Repair location type labels
   106â†’const REPAIR_LOCATION_LABELS = {
   107â†’  WITH_CUSTOMER: "With customer",
   108â†’  ON_SITE: "On-site",
   109â†’  THIRD_PARTY: "Third-party",
   110â†’};
   111â†’
   112â†’// Repair location type badge styles
   113â†’const REPAIR_LOCATION_STYLES = {
   114â†’  WITH_CUSTOMER: { bg: "bg-slate-100", text: "text-slate-600" },
   115â†’  ON_SITE: { bg: "bg-emerald-100", text: "text-emerald-700" },
   116â†’  THIRD_PARTY: { bg: "bg-[#14B8A6]/10", text: "text-[#14B8A6]" },
   117â†’};
   118â†’
   119â†’// Format booked date/time for display
   120â†’const formatBookedDate = (date) => {
   121â†’  if (!date) return null;
   122â†’  const d = new Date(date);
   123â†’  return d.toLocaleDateString("en-GB", { day: "numeric", month: "short" }) +
   124â†’    " " + d.toLocaleTimeString("en-GB", { hour: "2-digit", minute: "2-digit" });
   125â†’};
   126â†’
   127â†’// Helper to calculate days since date
   128â†’const daysSince = (date) => {
   129â†’  if (!date) return 0;
   130â†’  const diff = Date.now() - new Date(date).getTime();
   131â†’  return Math.floor(diff / (1000 * 60 * 60 * 24));
   132â†’};
   133â†’
   134â†’// Helper for relative time display
   135â†’const relativeTime = (date) => {
   136â†’  const days = daysSince(date);
   137â†’  if (days === 0) {
   138â†’    const hours = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60 * 60));
   139â†’    if (hours === 0) {
   140â†’      const mins = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60));
   141â†’      return mins <= 1 ? "Just now" : `${mins}m ago`;
   142â†’    }
   143â†’    return `${hours}h ago`;
   144â†’  }
   145â†’  if (days === 1) return "Yesterday";
   146â†’  if (days < 7) return `${days}d ago`;
   147â†’  if (days < 30) return `${Math.floor(days / 7)}w ago`;
   148â†’  return `${Math.floor(days / 30)}mo ago`;
   149â†’};
   150â†’
   151â†’export default function Warranty() {
   152â†’  const router = useRouter();
   153â†’  const [cases, setCases] = useState([]);
   154â†’  const [isLoading, setIsLoading] = useState(true);
   155â†’  const [selectedCase, setSelectedCase] = useState(null);
   156â†’  const [showAddModal, setShowAddModal] = useState(false);
   157â†’  const [newComment, setNewComment] = useState("");
   158â†’  const [commentAttachments, setCommentAttachments] = useState([]);
   159â†’  const [isUploadingCaseMedia, setIsUploadingCaseMedia] = useState(false);
   160â†’  const [isGeneratingAI, setIsGeneratingAI] = useState(false);
   161â†’  const [showRegenerateConfirm, setShowRegenerateConfirm] = useState(false);
   162â†’  const [aiDiagnostics, setAiDiagnostics] = useState(null);
   163â†’  const [isLoadingDiagnostics, setIsLoadingDiagnostics] = useState(false);
   164â†’  const [expandedTimelineGroups, setExpandedTimelineGroups] = useState({});
   165â†’  const [isVehicleDrawerOpen, setIsVehicleDrawerOpen] = useState(false);
   166â†’  const [selectedVehicleId, setSelectedVehicleId] = useState(null);
   167â†’  const fileInputRef = useRef(null);
   168â†’
   169â†’  // Drag state - matching Sales & Prep
   170â†’  const [draggedCard, setDraggedCard] = useState(null);
   171â†’  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });
   172â†’
   173â†’  // Courtesy car state
   174â†’  const [courtesyVehicles, setCourtesyVehicles] = useState([]);
   175â†’  const [isLoadingCourtesy, setIsLoadingCourtesy] = useState(false);
   176â†’
   177â†’  // Column sorting state
   178â†’  const [columnSortOptions, setColumnSortOptions] = useState({});
   179â†’
   180â†’  // Search filter state
   181â†’  const [searchQuery, setSearchQuery] = useState("");
   182â†’
   183â†’  // Filter state (matching stock board style)
   184â†’  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);
   185â†’  const [showMobileFilters, setShowMobileFilters] = useState(false);
   186â†’  const [filters, setFilters] = useState({
   187â†’    location: "all",      // "all" | "ON_SITE" | "THIRD_PARTY"
   188â†’    booked: "all",        // "all" | "booked" | "not_booked"
   189â†’    partsRequired: "all", // "all" | "yes" | "no"
   190â†’    priority: "all",      // "all" | "low" | "normal" | "high" | "critical"
   191â†’  });
   192â†’
   193â†’  // Mobile column selection
   194â†’  const [mobileActiveColumn, setMobileActiveColumn] = useState("not_booked_in");
   195â†’
   196â†’  // Job sheet share state
   197â†’  const [showJobSheetModal, setShowJobSheetModal] = useState(false);
   198â†’  const [jobSheetLink, setJobSheetLink] = useState(null);
   199â†’  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);
   200â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
