  4425â†’    }
  4426â†’    setIsCheckingAppraisal(true);
  4427â†’    try {
  4428â†’      const res = await fetch(`/api/appraisals/by-vrm?vrm=${encodeURIComponent(vrm)}`);
  4429â†’      if (res.ok) {
  4430â†’        const appraisal = await res.json();
  4431â†’        setMatchedAppraisal(appraisal);
  4432â†’        setAppraisalDismissed(false);
  4433â†’      } else {
  4434â†’        setMatchedAppraisal(null);
  4435â†’      }
  4436â†’    } catch (error) {
  4437â†’      setMatchedAppraisal(null);
  4438â†’    } finally {
  4439â†’      setIsCheckingAppraisal(false);
  4440â†’    }
  4441â†’  };
  4442â†’
  4443â†’  // Import data from matched appraisal
  4444â†’  const importFromAppraisal = () => {
  4445â†’    if (!matchedAppraisal) return;
  4446â†’    setFormData(prev => ({
  4447â†’      ...prev,
  4448â†’      regCurrent: matchedAppraisal.vehicleReg || prev.regCurrent,
  4449â†’      make: matchedAppraisal.vehicleMake || prev.make,
  4450â†’      model: matchedAppraisal.vehicleModel || prev.model,
  4451â†’      year: matchedAppraisal.vehicleYear || prev.year,
  4452â†’      mileageCurrent: matchedAppraisal.mileage || prev.mileageCurrent,
  4453â†’      notes: matchedAppraisal.conditionNotes || prev.notes,
  4454â†’    }));
  4455â†’    setAppraisalDismissed(true);
  4456â†’    toast.success("Imported data from appraisal");
  4457â†’  };
  4458â†’
  4459â†’  // Convert appraisal directly to stock (uses the convert API)
  4460â†’  const convertAppraisalToStock = async () => {
  4461â†’    if (!matchedAppraisal) return;
  4462â†’    setIsLoading(true);
  4463â†’    try {
  4464â†’      // Determine the API endpoint based on appraisal type
  4465â†’      const endpoint = matchedAppraisal.type === "customer_px"
  4466â†’        ? `/api/customer-px/${matchedAppraisal.id}/convert`
  4467â†’        : `/api/appraisals/${matchedAppraisal.id}/convert`;
  4468â†’
  4469â†’      const res = await fetch(endpoint, {
  4470â†’        method: "POST",
  4471â†’        headers: { "Content-Type": "application/json" },
  4472â†’        body: JSON.stringify({ initialStatus: "in_stock" }),
  4473â†’      });
  4474â†’
  4475â†’      if (!res.ok) {
  4476â†’        const error = await res.json();
  4477â†’        throw new Error(error.error || "Failed to convert appraisal");
  4478â†’      }
  4479â†’
  4480â†’      toast.success("Appraisal converted to stock!");
  4481â†’      onSuccess();
  4482â†’    } catch (error) {
  4483â†’      toast.error(error.message);
  4484â†’    } finally {
  4485â†’      setIsLoading(false);
  4486â†’    }
  4487â†’  };
  4488â†’
  4489â†’  const handleLookup = async () => {
  4490â†’    if (!formData.regCurrent) return toast.error("Enter registration first");
  4491â†’    setIsLookingUp(true);
  4492â†’    try {
  4493â†’      const res = await fetch("/api/dvla-lookup", {
  4494â†’        method: "POST",
  4495â†’        headers: { "Content-Type": "application/json" },
  4496â†’        body: JSON.stringify({ vehicleReg: formData.regCurrent }),
  4497â†’      });
  4498â†’      const data = await res.json();
  4499â†’
  4500â†’      // Check for error response
  4501â†’      if (!res.ok || data.error) {
  4502â†’        toast.error(data.message || data.error || "Vehicle not found");
  4503â†’        return;
  4504â†’      }
  4505â†’
  4506â†’      if (data.isDummy) showDummyNotification("DVLA API");
  4507â†’
  4508â†’      // Update form with DVLA data
  4509â†’      setFormData(prev => ({
  4510â†’        ...prev,
  4511â†’        make: data.make || prev.make,
  4512â†’        model: data.model || prev.model,
  4513â†’        year: data.yearOfManufacture || data.year || prev.year,
  4514â†’        colour: data.colour || prev.colour,
  4515â†’        fuelType: data.fuelType || prev.fuelType,
  4516â†’        transmission: data.transmission || prev.transmission,
  4517â†’        motExpiryDate: data.motExpiryDate || prev.motExpiryDate,
  4518â†’        // Engine capacity from DVLA (in cc)
  4519â†’        engineCapacity: data.engineCapacity || data.dvlaDetails?.engineCapacity || prev.engineCapacity,
  4520â†’        // Store full DVLA details for API persistence
  4521â†’        dvlaDetails: data.dvlaDetails || null,
  4522â†’        lastDvlaFetchAt: data.lastDvlaFetchAt || null,
  4523â†’      }));
  4524â†’
  4525â†’      toast.success(`Found: ${data.make} ${data.model || ""} (${data.yearOfManufacture || ""})`);
  4526â†’    } catch (error) {
  4527â†’      toast.error("Lookup failed - please try again");
  4528â†’    } finally {
  4529â†’      setIsLookingUp(false);
  4530â†’    }
  4531â†’  };
  4532â†’
  4533â†’  const uploadFile = async (file) => {
  4534â†’    if (!file) return null;
  4535â†’    const formData = new FormData();
  4536â†’    formData.append("file", file);
  4537â†’    const res = await fetch("/api/vehicles/upload", {
  4538â†’      method: "POST",
  4539â†’      body: formData,
  4540â†’    });
  4541â†’    if (!res.ok) throw new Error("Upload failed");
  4542â†’    const data = await res.json();
  4543â†’    // Store S3 key (permanent) if available, otherwise use URL (for local dev)
  4544â†’    return data.key || data.url;
  4545â†’  };
  4546â†’
  4547â†’  const handleSubmit = async (e) => {
  4548â†’    e.preventDefault();
  4549â†’    if (!formData.regCurrent || !formData.make || !formData.model) {
  4550â†’      return toast.error("Reg, make and model are required");
  4551â†’    }
  4552â†’    setIsLoading(true);
  4553â†’    try {
  4554â†’      // Create vehicle first
  4555â†’      // If "None" is selected, skip default tasks
  4556â†’      // If "default" is selected, create default tasks (don't skip)
  4557â†’      const skipDefault = selectedTemplate === "";
  4558â†’      const vehicleRes = await fetch("/api/vehicles", {
  4559â†’        method: "POST",
  4560â†’        headers: { "Content-Type": "application/json" },
  4561â†’        body: JSON.stringify({ ...formData, skipDefaultTasks: skipDefault }),
  4562â†’      });
  4563â†’      if (!vehicleRes.ok) {
  4564â†’        const errorData = await vehicleRes.json();
  4565â†’        throw new Error(errorData.error || "Failed to create vehicle");
  4566â†’      }
  4567â†’      const vehicle = await vehicleRes.json();
  4568â†’
  4569â†’      // Upload documents
  4570â†’      if (v5File) {
  4571â†’        const v5Url = await uploadFile(v5File);
  4572â†’        await fetch(`/api/vehicles/${vehicle.id}`, {
  4573â†’          method: "PUT",
  4574â†’          headers: { "Content-Type": "application/json" },
  4575â†’          body: JSON.stringify({ v5Url }),
  4576â†’        });
  4577â†’      }
  4578â†’
  4579â†’      if (serviceHistoryFile) {
  4580â†’        const url = await uploadFile(serviceHistoryFile);
  4581â†’        await fetch(`/api/vehicles/${vehicle.id}/documents`, {
  4582â†’          method: "POST",
  4583â†’          headers: { "Content-Type": "application/json" },
  4584â†’          body: JSON.stringify({ name: "Service History", type: "service_history", url }),
  4585â†’        });
  4586â†’      }
  4587â†’
  4588â†’      if (faultCodesFile) {
  4589â†’        const url = await uploadFile(faultCodesFile);
  4590â†’        await fetch(`/api/vehicles/${vehicle.id}/documents`, {
  4591â†’          method: "POST",
  4592â†’          headers: { "Content-Type": "application/json" },
  4593â†’          body: JSON.stringify({ name: "Fault Codes", type: "fault_codes", url }),
  4594â†’        });
  4595â†’      }
  4596â†’
  4597â†’      // Upload other documents
  4598â†’      for (const doc of otherDocuments) {
  4599â†’        if (doc.file) {
  4600â†’          const url = await uploadFile(doc.file);
  4601â†’          await fetch(`/api/vehicles/${vehicle.id}/documents`, {
  4602â†’            method: "POST",
  4603â†’            headers: { "Content-Type": "application/json" },
  4604â†’            body: JSON.stringify({ name: doc.name || "Document", type: "other", url }),
  4605â†’          });
  4606â†’        }
  4607â†’      }
  4608â†’
  4609â†’      // Create initial issues from the array
  4610â†’      for (const issue of initialIssues) {
  4611â†’        await fetch(`/api/vehicles/${vehicle.id}/issues`, {
  4612â†’          method: "POST",
  4613â†’          headers: { "Content-Type": "application/json" },
  4614â†’          body: JSON.stringify({
  4615â†’            category: issue.category,
  4616â†’            subcategory: issue.subcategory,
  4617â†’            description: issue.description,
  4618â†’            actionNeeded: issue.actionNeeded,
  4619â†’            status: issue.status || "Outstanding",
  4620â†’            notes: issue.notes,
  4621â†’          }),
  4622â†’        });
  4623â†’      }
  4624â†’
  4625â†’      // Create prep tasks based on template
  4626â†’      // Only create from prepTemplates if a custom template is selected (not "default" which is handled by API)
  4627â†’      if (selectedTemplate && selectedTemplate !== "default" && prepTemplates.length > 0) {
  4628â†’        for (const template of prepTemplates) {
  4629â†’          await fetch(`/api/vehicles/${vehicle.id}/tasks`, {
  4630â†’            method: "POST",
  4631â†’            headers: { "Content-Type": "application/json" },
  4632â†’            body: JSON.stringify({ name: template.name }),
  4633â†’          });
  4634â†’        }
  4635â†’      }
  4636â†’
  4637â†’      // Link appraisal to vehicle if one was matched
  4638â†’      if (matchedAppraisal && matchedAppraisal.id) {
  4639â†’        await fetch(`/api/appraisals/${matchedAppraisal.id}`, {
  4640â†’          method: "PATCH",
  4641â†’          headers: { "Content-Type": "application/json" },
  4642â†’          body: JSON.stringify({
  4643â†’            decision: "converted",
  4644â†’            vehicleId: vehicle.id,
  4645â†’            decidedAt: new Date(),
  4646â†’          }),
  4647â†’        });
  4648â†’      }
  4649â†’
  4650â†’      toast.success("Vehicle added!");
  4651â†’      onSuccess();
  4652â†’    } catch (error) {
  4653â†’      console.error("Error:", error);
  4654â†’      toast.error(error.message);
  4655â†’    } finally {
  4656â†’      setIsLoading(false);
  4657â†’    }
  4658â†’  };
  4659â†’
  4660â†’  return (
  4661â†’    <div className="modal modal-open">
  4662â†’      <div className="modal-box max-w-4xl max-h-[90vh] overflow-y-auto bg-white">
  4663â†’        <div className="flex items-center justify-between mb-6">
  4664â†’          <h3 className="text-xl font-bold text-slate-900">Add Vehicle</h3>
  4665â†’          <button
  4666â†’            type="button"
  4667â†’            onClick={onClose}
  4668â†’            className="p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200"
  4669â†’          >
  4670â†’            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  4671â†’              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
  4672â†’            </svg>
  4673â†’          </button>
  4674â†’        </div>
  4675â†’        <form onSubmit={handleSubmit}>
  4676â†’          {/* Vehicle Details Section */}
  4677â†’          <div className="mb-6 pb-6 border-b border-slate-100">
  4678â†’            <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Vehicle Details</h4>
  4679â†’            <div className="relative flex gap-2 mb-4">
  4680â†’              <div className="relative flex-1">
  4681â†’                <input
  4682â†’                  type="text"
  4683â†’                  placeholder="Registration"
  4684â†’                  className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg uppercase font-mono text-slate-900 placeholder-slate-400 focus:bg-white focus:border-transparent focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
  4685â†’                  value={formData.regCurrent}
  4686â†’                  onChange={(e) => {
  4687â†’                    const newValue = e.target.value.toUpperCase();
  4688â†’                    setFormData({ ...formData, regCurrent: newValue });
  4689â†’                    searchAppraisals(newValue);
  4690â†’                  }}
  4691â†’                  onFocus={() => {
  4692â†’                    if (appraisalSuggestions.length > 0) setShowAppraisalDropdown(true);
  4693â†’                  }}
  4694â†’                  onBlur={(e) => {
  4695â†’                    // Delay hiding dropdown so click on suggestion can register
  4696â†’                    setTimeout(() => setShowAppraisalDropdown(false), 200);
  4697â†’                    checkForAppraisal(e.target.value);
  4698â†’                  }}
  4699â†’                />
  4700â†’                {isSearchingAppraisals && (
  4701â†’                  <span className="absolute right-3 top-1/2 -translate-y-1/2 loading loading-spinner loading-sm"></span>
  4702â†’                )}
  4703â†’                {/* Appraisal Suggestions Dropdown */}
  4704â†’                {showAppraisalDropdown && appraisalSuggestions.length > 0 && (
  4705â†’                  <div className="absolute top-full left-0 right-0 z-50 mt-1 bg-base-100 border border-base-300 rounded-lg shadow-xl max-h-64 overflow-y-auto">
  4706â†’                    <div className="px-3 py-2 text-xs text-base-content/60 border-b border-base-200 bg-base-200/50">
  4707â†’                      Unconverted Appraisals
  4708â†’                    </div>
  4709â†’                    {appraisalSuggestions.map((appraisal) => (
  4710â†’                      <button
  4711â†’                        key={appraisal.id}
  4712â†’                        type="button"
  4713â†’                        className="w-full px-3 py-2 text-left hover:bg-base-200 border-b border-base-200 last:border-b-0 flex items-center gap-3"
  4714â†’                        onClick={() => handleSelectAppraisalSuggestion(appraisal)}
  4715â†’                      >
  4716â†’                        <div className="flex-1">
  4717â†’                          <div className="font-mono font-bold">{appraisal.vehicleReg}</div>
  4718â†’                          <div className="text-sm text-base-content/70">
  4719â†’                            {appraisal.vehicleMake} {appraisal.vehicleModel} {appraisal.vehicleYear ? `(${appraisal.vehicleYear})` : ""}
  4720â†’                          </div>
  4721â†’                        </div>
  4722â†’                        <span className={`badge badge-sm ${appraisal.type === "dealer" ? "badge-primary" : "badge-secondary"}`}>
  4723â†’                          {appraisal.type === "dealer" ? "Dealer" : "Customer PX"}
  4724â†’                        </span>
  4725â†’                      </button>
  4726â†’                    ))}
  4727â†’                  </div>
  4728â†’                )}
  4729â†’              </div>
  4730â†’              <button
  4731â†’                type="button"
  4732â†’                className="px-5 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-2"
  4733â†’                onClick={handleLookup}
  4734â†’                disabled={isLookingUp}
  4735â†’              >
  4736â†’                {isLookingUp ? <span className="loading loading-spinner loading-sm"></span> : <><span>ğŸ”</span><span>Lookup</span></>}
  4737â†’              </button>
  4738â†’            </div>
  4739â†’
  4740â†’            {/* Appraisal Match Alert */}
  4741â†’            {isCheckingAppraisal && (
  4742â†’              <div className="alert mb-4">
  4743â†’                <span className="loading loading-spinner loading-sm"></span>
  4744â†’                <span>Checking for existing appraisals...</span>
  4745â†’              </div>
  4746â†’            )}
  4747â†’            {matchedAppraisal && !appraisalDismissed && (
  4748â†’              <div className="alert alert-success mb-4">
  4749â†’                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
  4750â†’                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
  4751â†’                </svg>
  4752â†’                <div className="flex-1">
  4753â†’                  <p className="font-semibold">
  4754â†’                    {matchedAppraisal.type === "customer_px" ? "Customer PX" : "Dealer"} Appraisal Found: {matchedAppraisal.vehicleReg}
  4755â†’                  </p>
  4756â†’                  <p className="text-sm opacity-80">
  4757â†’                    {matchedAppraisal.vehicleMake} {matchedAppraisal.vehicleModel} {matchedAppraisal.vehicleYear ? `(${matchedAppraisal.vehicleYear})` : ""}
  4758â†’                    {matchedAppraisal.mileage ? ` â€¢ ${matchedAppraisal.mileage.toLocaleString()} miles` : ""}
  4759â†’                  </p>
  4760â†’                </div>
  4761â†’                <div className="flex flex-col sm:flex-row gap-2">
  4762â†’                  <button type="button" className="btn btn-sm btn-primary" onClick={convertAppraisalToStock} disabled={isLoading}>
  4763â†’                    {isLoading ? <span className="loading loading-spinner loading-sm"></span> : "Convert to Stock"}
  4764â†’                  </button>
  4765â†’                  <button type="button" className="btn btn-sm btn-ghost" onClick={importFromAppraisal}>
  4766â†’                    Import Data Only
  4767â†’                  </button>
  4768â†’                  <button type="button" className="btn btn-sm btn-ghost" onClick={() => setAppraisalDismissed(true)}>
  4769â†’                    Dismiss
  4770â†’                  </button>
  4771â†’                </div>
  4772â†’              </div>
  4773â†’            )}
  4774â†’
  4775â†’            <div className="grid grid-cols-2 gap-4">
  4776â†’              <div className="form-control">
  4777â†’                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Make *</label>
  4778â†’                <input type="text" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.make}
  4779â†’                  onChange={(e) => setFormData({ ...formData, make: e.target.value })} required />
  4780â†’              </div>
  4781â†’              <div className="form-control">
  4782â†’                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Model *</label>
  4783â†’                <input type="text" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.model}
  4784â†’                  onChange={(e) => setFormData({ ...formData, model: e.target.value })} required />
  4785â†’              </div>
  4786â†’              <div className="form-control">
  4787â†’                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Year</label>
  4788â†’                <input type="number" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.year}
  4789â†’                  onChange={(e) => setFormData({ ...formData, year: e.target.value })} />
  4790â†’              </div>
  4791â†’              <div className="form-control">
  4792â†’                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Mileage</label>
  4793â†’                <input type="number" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.mileageCurrent}
  4794â†’                  onChange={(e) => setFormData({ ...formData, mileageCurrent: e.target.value })} />
  4795â†’              </div>
  4796â†’              <div className="form-control">
  4797â†’                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Colour</label>
  4798â†’                <input type="text" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.colour}
  4799â†’                  onChange={(e) => setFormData({ ...formData, colour: e.target.value })} />
  4800â†’              </div>
  4801â†’              <div className="form-control">
  4802â†’                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Fuel Type</label>
  4803â†’                <select className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer" value={formData.fuelType?.toUpperCase() || ""}
  4804â†’                  onChange={(e) => setFormData({ ...formData, fuelType: e.target.value })}>
  4805â†’                  <option value="">Select...</option>
  4806â†’                  <option value="PETROL">Petrol</option>
  4807â†’                  <option value="DIESEL">Diesel</option>
  4808â†’                  <option value="HYBRID">Hybrid</option>
  4809â†’                  <option value="ELECTRIC">Electric</option>
  4810â†’                  <option value="LPG">LPG</option>
  4811â†’                  <option value="CNG">CNG</option>
  4812â†’                </select>
  4813â†’              </div>
  4814â†’              <div className="form-control">
  4815â†’                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">MOT Expiry Date</label>
  4816â†’                <input
  4817â†’                  type="date"
  4818â†’                  className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
  4819â†’                  value={formData.motExpiryDate ? formData.motExpiryDate.split("T")[0] : ""}
  4820â†’                  onChange={(e) => setFormData({ ...formData, motExpiryDate: e.target.value })}
  4821â†’                />
  4822â†’                <p className="text-xs text-slate-400 mt-1.5">
  4823â†’                  {formData.motExpiryDate ? "" : "Auto-filled by VRM lookup or enter manually"}
  4824â†’                </p>

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
