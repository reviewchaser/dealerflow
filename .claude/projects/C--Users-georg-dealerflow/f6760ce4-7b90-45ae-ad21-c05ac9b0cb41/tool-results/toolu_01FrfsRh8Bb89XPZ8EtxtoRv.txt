     1→import { useEffect, useState } from "react";
     2→import { useSession } from "next-auth/react";
     3→import { useRouter } from "next/router";
     4→import Head from "next/head";
     5→import Link from "next/link";
     6→import DashboardLayout from "@/components/DashboardLayout";
     7→import { toast } from "react-hot-toast";
     8→import useDealerRedirect from "@/hooks/useDealerRedirect";
     9→
    10→export default function HolidaySettings() {
    11→  const router = useRouter();
    12→  const { data: session } = useSession();
    13→  const { isRedirecting } = useDealerRedirect();
    14→  const [requests, setRequests] = useState([]);
    15→  const [loading, setLoading] = useState(true);
    16→  const [filter, setFilter] = useState("all"); // all, pending, approved, rejected
    17→  const [searchQuery, setSearchQuery] = useState(""); // Employee name search
    18→  const [userRole, setUserRole] = useState(null);
    19→
    20→  // Read filter from URL on load
    21→  useEffect(() => {
    22→    if (router.query.filter) {
    23→      setFilter(router.query.filter);
    24→    }
    25→  }, [router.query.filter]);
    26→  const [showCreateModal, setShowCreateModal] = useState(false);
    27→  const [teamMembers, setTeamMembers] = useState([]);
    28→  const [newRequest, setNewRequest] = useState({
    29→    startDate: "",
    30→    endDate: "",
    31→    startSession: "AM",
    32→    endSession: "PM",
    33→    type: "Holiday",
    34→    notes: "",
    35→    requestForUserId: "",
    36→  });
    37→  const [adminNote, setAdminNote] = useState("");
    38→  const [actionModal, setActionModal] = useState({ open: false, request: null, action: null });
    39→  const [isProcessing, setIsProcessing] = useState(false);
    40→
    41→  const isAdmin = userRole === "OWNER" || userRole === "ADMIN";
    42→
    43→  // Fetch user's role from dealer context
    44→  useEffect(() => {
    45→    const fetchRole = async () => {
    46→      try {
    47→        const res = await fetch("/api/dealer");
    48→        if (res.ok) {
    49→          const data = await res.json();
    50→          setUserRole(data.currentUserRole);
    51→          console.log("Holiday page - fetched role:", data.currentUserRole);
    52→        }
    53→      } catch (error) {
    54→        console.error("Failed to fetch user role:", error);
    55→      }
    56→    };
    57→    fetchRole();
    58→  }, []);
    59→
    60→  useEffect(() => {
    61→    fetchRequests();
    62→    if (isAdmin) {
    63→      fetchTeamMembers();
    64→    }
    65→  }, [isAdmin]);
    66→
    67→  const fetchRequests = async () => {
    68→    try {
    69→      const res = await fetch("/api/holiday-requests");
    70→      if (!res.ok) throw new Error("Failed to fetch");
    71→      const data = await res.json();
    72→      setRequests(data);
    73→    } catch (error) {
    74→      toast.error("Failed to load holiday requests");
    75→    } finally {
    76→      setLoading(false);
    77→    }
    78→  };
    79→
    80→  const fetchTeamMembers = async () => {
    81→    try {
    82→      const res = await fetch("/api/team");
    83→      if (!res.ok) throw new Error("Failed to fetch");
    84→      const data = await res.json();
    85→      setTeamMembers(data);
    86→    } catch (error) {
    87→      console.error("Failed to load team members");
    88→    }
    89→  };
    90→
    91→  const handleApprove = async (request) => {
    92→    // Defensive check for missing ID
    93→    const requestId = request?.id || request?._id;
    94→    if (!requestId) {
    95→      toast.error("Missing request ID - cannot approve");
    96→      console.error("handleApprove called with missing ID:", request);
    97→      return;
    98→    }
    99→
   100→    setIsProcessing(true);
   101→    try {
   102→      const res = await fetch(`/api/holiday-requests/${requestId}/approve`, {
   103→        method: "POST",
   104→        headers: { "Content-Type": "application/json" },
   105→        body: JSON.stringify({ adminNote: adminNote || null }),
   106→      });
   107→      if (!res.ok) {
   108→        const data = await res.json().catch(() => ({}));
   109→        throw new Error(data.error || "Failed to approve");
   110→      }
   111→      toast.success("Holiday approved");
   112→      setActionModal({ open: false, request: null, action: null });
   113→      setAdminNote("");
   114→      fetchRequests();
   115→    } catch (error) {
   116→      toast.error(error.message || "Failed to approve request");
   117→    } finally {
   118→      setIsProcessing(false);
   119→    }
   120→  };
   121→
   122→  const handleReject = async (request) => {
   123→    // Defensive check for missing ID
   124→    const requestId = request?.id || request?._id;
   125→    if (!requestId) {
   126→      toast.error("Missing request ID - cannot reject");
   127→      console.error("handleReject called with missing ID:", request);
   128→      return;
   129→    }
   130→
   131→    setIsProcessing(true);
   132→    try {
   133→      const res = await fetch(`/api/holiday-requests/${requestId}/reject`, {
   134→        method: "POST",
   135→        headers: { "Content-Type": "application/json" },
   136→        body: JSON.stringify({ adminNote: adminNote || null }),
   137→      });
   138→      if (!res.ok) {
   139→        const data = await res.json().catch(() => ({}));
   140→        throw new Error(data.error || "Failed to reject");
   141→      }
   142→      toast.success("Holiday rejected");
   143→      setActionModal({ open: false, request: null, action: null });
   144→      setAdminNote("");
   145→      fetchRequests();
   146→    } catch (error) {
   147→      toast.error(error.message || "Failed to reject request");
   148→    } finally {
   149→      setIsProcessing(false);
   150→    }
   151→  };
   152→
   153→  const handleDelete = async (requestId) => {
   154→    if (!requestId) {
   155→      toast.error("Missing request ID - cannot delete");
   156→      return;
   157→    }
   158→    if (!confirm("Delete this holiday request?")) return;
   159→    try {
   160→      const res = await fetch(`/api/holiday-requests/${requestId}`, {
   161→        method: "DELETE",
   162→      });
   163→      if (!res.ok) {
   164→        const data = await res.json().catch(() => ({}));
   165→        throw new Error(data.error || `Delete failed (${res.status})`);
   166→      }
   167→      toast.success("Holiday request deleted");
   168→      fetchRequests();
   169→    } catch (error) {
   170→      console.error("Delete error:", error);
   171→      toast.error(error.message || "Failed to delete request");
   172→    }
   173→  };
   174→
   175→  // Compute total days based on AM/PM sessions (mirrors server logic)
   176→  const computeTotalDays = (startDate, endDate, startSession, endSession) => {
   177→    const start = new Date(startDate);
   178→    const end = new Date(endDate);
   179→    start.setHours(0, 0, 0, 0);
   180→    end.setHours(0, 0, 0, 0);
   181→
   182→    const msPerDay = 1000 * 60 * 60 * 24;
   183→    const daysDiff = Math.round((end - start) / msPerDay);
   184→
   185→    if (daysDiff < 0) return null;
   186→
   187→    // Same day
   188→    if (daysDiff === 0) {
   189→      if (startSession === "PM" && endSession === "AM") return null;
   190→      if (startSession === "AM" && endSession === "PM") return 1.0;
   191→      return 0.5;
   192→    }
   193→
   194→    // Multi-day
   195→    const startDayValue = startSession === "PM" ? 0.5 : 1.0;
   196→    const endDayValue = endSession === "AM" ? 0.5 : 1.0;
   197→    const middleDays = daysDiff - 1;
   198→
   199→    return startDayValue + middleDays + endDayValue;
   200→  };
   201→
   202→  const handleCreateRequest = async (e) => {
   203→    e.preventDefault();
   204→    if (!newRequest.startDate) {
   205→      toast.error("Please select a start date");
   206→      return;
   207→    }
   208→
   209→    // Client-side validation
   210→    const start = new Date(newRequest.startDate);
   211→    // End date defaults to start date if not provided
   212→    const end = newRequest.endDate ? new Date(newRequest.endDate) : new Date(newRequest.startDate);
   213→
   214→    if (end < start) {
   215→      toast.error("End date must be on or after start date");
   216→      return;
   217→    }
   218→
   219→    // Compute total days with AM/PM
   220→    const totalDays = computeTotalDays(start, end, newRequest.startSession, newRequest.endSession);
   221→
   222→    if (totalDays === null) {
   223→      toast.error("Invalid session combination: PM to AM on the same day is not allowed");
   224→      return;
   225→    }
   226→
   227→    if (totalDays > 60) {
   228→      toast.error("Holiday request cannot exceed 60 days");
   229→      return;
   230→    }
   231→
   232→    // Check date range - start not more than 1 year ago
   233→    const oneYearAgo = new Date();
   234→    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
   235→    if (start < oneYearAgo) {
   236→      toast.error("Start date cannot be more than 1 year in the past");
   237→      return;
   238→    }
   239→
   240→    // End date not more than 2 years in future
   241→    const twoYearsFromNow = new Date();
   242→    twoYearsFromNow.setFullYear(twoYearsFromNow.getFullYear() + 2);
   243→    if (end > twoYearsFromNow) {
   244→      toast.error("End date cannot be more than 2 years in the future");
   245→      return;
   246→    }
   247→
   248→    try {
   249→      const res = await fetch("/api/holiday-requests", {
   250→        method: "POST",
   251→        headers: { "Content-Type": "application/json" },
   252→        body: JSON.stringify({
   253→          startDate: newRequest.startDate,
   254→          endDate: newRequest.endDate || newRequest.startDate, // Default to start date
   255→          startSession: newRequest.startSession,
   256→          endSession: newRequest.endSession,
   257→          type: newRequest.type,
   258→          notes: newRequest.notes,
   259→          requestForUserId: newRequest.requestForUserId,
   260→        }),
   261→      });
   262→      if (!res.ok) {
   263→        const data = await res.json();
   264→        throw new Error(data.error || "Failed to create");
   265→      }
   266→      toast.success("Holiday request created");
   267→      setShowCreateModal(false);
   268→      setNewRequest({ startDate: "", endDate: "", startSession: "AM", endSession: "PM", type: "Holiday", notes: "", requestForUserId: "" });
   269→      fetchRequests();
   270→    } catch (error) {
   271→      toast.error(error.message || "Failed to create request");
   272→    }
   273→  };
   274→
   275→  const calculateDays = (startDate, endDate) => {
   276→    const start = new Date(startDate);
   277→    const end = new Date(endDate);
   278→    const diffTime = Math.abs(end - start);
   279→    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
   280→    return diffDays;
   281→  };
   282→
   283→  const formatDate = (dateStr) => {
   284→    return new Date(dateStr).toLocaleDateString("en-GB", {
   285→      day: "numeric",
   286→      month: "short",
   287→      year: "numeric",
   288→    });
   289→  };
   290→
   291→  const timeAgo = (dateStr) => {
   292→    const now = new Date();
   293→    const date = new Date(dateStr);
   294→    const diffMs = now - date;
   295→    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
   296→
   297→    if (diffDays === 0) return "today";
   298→    if (diffDays === 1) return "1 day ago";
   299→    if (diffDays < 7) return `${diffDays} days ago`;
   300→    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
   301→    return `${Math.floor(diffDays / 30)} months ago`;
   302→  };
   303→
   304→  const getStatusBadge = (status) => {
   305→    switch (status) {
   306→      case "PENDING":
   307→        return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-200">Pending</span>;
   308→      case "APPROVED":
   309→        return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-emerald-50 text-emerald-700 border border-emerald-200">Approved</span>;
   310→      case "REJECTED":
   311→        return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-red-50 text-red-700 border border-red-200">Rejected</span>;
   312→      default:
   313→        return <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 border border-slate-200">{status}</span>;
   314→    }
   315→  };
   316→
   317→  const getTypeIcon = (type) => {
   318→    switch (type) {
   319→      case "Holiday":
   320→        return (
   321→          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   322→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
   323→          </svg>
   324→        );
   325→      case "Sick":
   326→        return (
   327→          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   328→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
   329→          </svg>
   330→        );
   331→      case "Unpaid":
   332→        return (
   333→          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   334→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
   335→          </svg>
   336→        );
   337→      default:
   338→        return (
   339→          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   340→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
   341→          </svg>
   342→        );
   343→    }
   344→  };
   345→
   346→  const filteredRequests = requests.filter((req) => {
   347→    // Status filter
   348→    if (filter !== "all" && req.status !== filter.toUpperCase()) {
   349→      return false;
   350→    }
   351→    // Employee name search filter
   352→    if (searchQuery.trim()) {
   353→      const query = searchQuery.toLowerCase();
   354→      const nameMatch = (req.userName || "").toLowerCase().includes(query);
   355→      const emailMatch = (req.userEmail || "").toLowerCase().includes(query);
   356→      if (!nameMatch && !emailMatch) return false;
   357→    }
   358→    return true;
   359→  });
   360→
   361→  // Calculate total approved days for the current year
   362→  const currentYear = new Date().getFullYear();
   363→  const approvedThisYear = requests.filter(
   364→    (r) => r.status === "APPROVED" && new Date(r.startDate).getFullYear() === currentYear
   365→  );
   366→  const totalApprovedDays = approvedThisYear.reduce(
   367→    (sum, r) => sum + calculateDays(r.startDate, r.endDate),
   368→    0
   369→  );
   370→  const pendingCount = requests.filter((r) => r.status === "PENDING").length;
   371→  const pendingDays = requests
   372→    .filter((r) => r.status === "PENDING")
   373→    .reduce((sum, r) => sum + calculateDays(r.startDate, r.endDate), 0);
   374→
   375→  // Show loading while checking for dealer redirect
   376→  if (isRedirecting) {
   377→    return (
   378→      <div className="min-h-screen flex items-center justify-center bg-slate-50">
   379→        <div className="flex flex-col items-center gap-4">
   380→          <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin" />
   381→          <p className="text-sm text-slate-500 font-medium">Loading...</p>
   382→        </div>
   383→      </div>
   384→    );
   385→  }
   386→
   387→  return (
   388→    <DashboardLayout>
   389→      <Head><title>Holidays | DealerFlow</title></Head>
   390→
   391→      <div className="mb-6">
   392→        <div className="flex flex-col sm:flex-row justify-between items-start gap-4">
   393→          <div>
   394→            <h1 className="text-3xl font-bold">Holiday Requests</h1>
   395→            <p className="text-base-content/60 mt-1">
   396→              {isAdmin ? "Manage team holiday requests" : "View and request time off"}
   397→            </p>
   398→          </div>
   399→          <button
   400→            className="btn btn-primary w-full sm:w-auto"
   401→            onClick={() => setShowCreateModal(true)}
   402→          >
   403→            <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   404→              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
   405→            </svg>
   406→            Request Holiday
   407→          </button>
   408→        </div>
   409→      </div>
   410→
   411→      {/* Stats Cards */}
   412→      <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
   413→        <div className="card bg-base-200">
   414→          <div className="card-body p-4">
   415→            <p className="text-3xl font-bold text-success">{totalApprovedDays}</p>
   416→            <p className="text-sm text-base-content/60">Days approved ({currentYear})</p>
   417→          </div>
   418→        </div>
   419→        <div className="card bg-base-200">
   420→          <div className="card-body p-4">
   421→            <p className="text-3xl font-bold text-warning">{pendingCount}</p>
   422→            <p className="text-sm text-base-content/60">Pending requests</p>
   423→          </div>
   424→        </div>
   425→        <div className="card bg-base-200 col-span-2 md:col-span-1">
   426→          <div className="card-body p-4">
   427→            <p className="text-3xl font-bold">{pendingDays}</p>
   428→            <p className="text-sm text-base-content/60">Pending days</p>
   429→          </div>
   430→        </div>
   431→      </div>
   432→
   433→      {/* Search and Filters */}
   434→      <div className="flex flex-col sm:flex-row gap-4 mb-6">
   435→        {/* Employee Search */}
   436→        {isAdmin && (
   437→          <div className="relative">
   438→            <input
   439→              type="text"
   440→              placeholder="Search employee..."
   441→              value={searchQuery}
   442→              onChange={(e) => setSearchQuery(e.target.value)}
   443→              className="input input-sm input-bordered w-full sm:w-64 pr-8"
   444→            />
   445→            {searchQuery && (
   446→              <button
   447→                onClick={() => setSearchQuery("")}
   448→                className="absolute right-2 top-1/2 -translate-y-1/2 text-base-content/40 hover:text-base-content"
   449→              >
   450→                ×
   451→              </button>
   452→            )}
   453→          </div>
   454→        )}
   455→
   456→        {/* Status Filters */}
   457→        <div className="flex gap-2">
   458→          <button
   459→            className={`btn btn-sm ${filter === "all" ? "btn-primary" : "btn-ghost"}`}
   460→            onClick={() => setFilter("all")}
   461→          >
   462→            All
   463→          </button>
   464→          <button
   465→            className={`btn btn-sm ${filter === "pending" ? "btn-warning" : "btn-ghost"}`}
   466→            onClick={() => setFilter("pending")}
   467→          >
   468→            Pending
   469→            {requests.filter((r) => r.status === "PENDING").length > 0 && (
   470→              <span className="badge badge-xs ml-1">
   471→                {requests.filter((r) => r.status === "PENDING").length}
   472→              </span>
   473→            )}
   474→          </button>
   475→          <button
   476→            className={`btn btn-sm ${filter === "approved" ? "btn-success" : "btn-ghost"}`}
   477→            onClick={() => setFilter("approved")}
   478→          >
   479→            Approved
   480→          </button>
   481→          <button
   482→            className={`btn btn-sm ${filter === "rejected" ? "btn-error" : "btn-ghost"}`}
   483→            onClick={() => setFilter("rejected")}
   484→          >
   485→            Rejected
   486→          </button>
   487→        </div>
   488→      </div>
   489→
   490→      {/* Requests List */}
   491→      {loading ? (
   492→        <div className="flex justify-center py-12">
   493→          <span className="loading loading-spinner loading-lg"></span>
   494→        </div>
   495→      ) : filteredRequests.length === 0 ? (
   496→        <div className="card bg-base-200">
   497→          <div className="card-body text-center py-12">
   498→            <p className="text-base-content/60">No holiday requests found</p>
   499→          </div>
   500→        </div>
   501→      ) : (
   502→        <div className="space-y-3">
   503→          {filteredRequests.map((request) => (
   504→            <div
   505→              key={request.id || request._id}
   506→              className="card bg-base-200 hover:bg-base-300/50 transition-colors"
   507→            >
   508→              <div className="card-body p-4">
   509→                <div className="flex items-start gap-4">
   510→                  {/* Type Icon */}
   511→                  <div className="p-2 bg-base-100 rounded-lg text-base-content/60">
   512→                    {getTypeIcon(request.type)}
   513→                  </div>
   514→
   515→                  {/* Main Content */}
   516→                  <div className="flex-1 min-w-0">
   517→                    <div className="flex items-center gap-2 flex-wrap">
   518→                      <span className="font-semibold">{request.userName}</span>
   519→                      {getStatusBadge(request.status)}
   520→                      <span className="text-sm text-base-content/50">{request.type}</span>
   521→                    </div>
   522→                    <div className="text-sm mt-1">
   523→                      <span className="font-medium">
   524→                        {formatDate(request.startDate)}
   525→                        {request.startSession && <span className="text-xs text-base-content/50 ml-1">({request.startSession})</span>}
   526→                        {" - "}
   527→                        {formatDate(request.endDate)}
   528→                        {request.endSession && <span className="text-xs text-base-content/50 ml-1">({request.endSession})</span>}
   529→                      </span>
   530→                      <span className="text-base-content/50 ml-2">
   531→                        {(() => {
   532→                          // Use server-computed days if available, otherwise calculate
   533→                          const days = request.totalDaysComputed || request.totalDays || calculateDays(request.startDate, request.endDate);
   534→                          if (days > 60) {
   535→                            return <span className="text-error font-semibold">⚠️ {days} days (invalid)</span>;
   536→                          }
   537→                          return `(${days} day${days !== 1 ? "s" : ""})`;
   538→                        })()}
   539→                      </span>
   540→                    </div>
   541→                    {request.notes && (
   542→                      <p className="text-sm text-base-content/60 mt-1 truncate">
   543→                        {request.notes}
   544→                      </p>
   545→                    )}
   546→                    <div className="flex items-center gap-4 mt-2 text-xs text-base-content/50">
   547→                      <span>Created {timeAgo(request.createdAt)}</span>
   548→                      {request.reviewedByName && (
   549→                        <span>
   550→                          {request.status === "APPROVED" ? "Approved" : "Rejected"} by {request.reviewedByName}
   551→                        </span>
   552→                      )}
   553→                    </div>
   554→                    {request.adminNote && (
   555→                      <div className="mt-2 p-2 bg-base-100 rounded text-sm">
   556→                        <span className="text-base-content/50">Note: </span>
   557→                        {request.adminNote}
   558→                      </div>
   559→                    )}
   560→                  </div>
   561→
   562→                  {/* Actions - Prominent buttons for Admin/Owner */}
   563→                  <div className="flex items-center gap-2 flex-shrink-0">
   564→                    {request.status === "PENDING" && isAdmin && (
   565→                      <>
   566→                        <button
   567→                          className="btn btn-success btn-sm gap-1 shadow-sm hover:shadow-md transition-all"
   568→                          onClick={() => setActionModal({ open: true, request, action: "approve" })}
   569→                          disabled={isProcessing}
   570→                        >
   571→                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   572→                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   573→                          </svg>
   574→                          Approve
   575→                        </button>
   576→                        <button
   577→                          className="btn btn-error btn-outline btn-sm gap-1"
   578→                          onClick={() => setActionModal({ open: true, request, action: "reject" })}
   579→                          disabled={isProcessing}
   580→                        >
   581→                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   582→                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   583→                          </svg>
   584→                          Reject
   585→                        </button>
   586→                      </>
   587→                    )}
   588→                    {(isAdmin || request.status === "PENDING") && (
   589→                      <button
   590→                        className="btn btn-sm btn-ghost text-error"
   591→                        onClick={() => handleDelete(request.id || request._id)}
   592→                        disabled={isProcessing}
   593→                        title="Delete request"
   594→                      >
   595→                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   596→                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
   597→                        </svg>
   598→                      </button>
   599→                    )}
   600→                  </div>
   601→                </div>
   602→              </div>
   603→            </div>
   604→          ))}
   605→        </div>
   606→      )}
   607→
   608→      {/* Create Request Modal */}
   609→      {showCreateModal && (
   610→        <div className="modal modal-open">
   611→          <div className="modal-box">
   612→            <h3 className="font-bold text-lg">Request Time Off</h3>
   613→            <form onSubmit={handleCreateRequest} className="mt-4 space-y-4">
   614→              {isAdmin && teamMembers.length > 0 && (
   615→                <div className="form-control">
   616→                  <label className="label">
   617→                    <span className="label-text">Request For</span>
   618→                  </label>
   619→                  <select
   620→                    className="select select-bordered"
   621→                    value={newRequest.requestForUserId}
   622→                    onChange={(e) => setNewRequest({ ...newRequest, requestForUserId: e.target.value })}
   623→                  >
   624→                    <option value="">Myself</option>
   625→                    {teamMembers.map((member) => (
   626→                      <option key={member.id} value={member.id}>
   627→                        {member.name || member.email}
   628→                      </option>
   629→                    ))}
   630→                  </select>
   631→                </div>
   632→              )}
   633→              <div className="form-control">
   634→                <label className="label">
   635→                  <span className="label-text">Type</span>
   636→                </label>
   637→                <select
   638→                  className="select select-bordered"
   639→                  value={newRequest.type}
   640→                  onChange={(e) => setNewRequest({ ...newRequest, type: e.target.value })}
   641→                >
   642→                  <option value="Holiday">Holiday</option>
   643→                  <option value="Sick">Sick Leave</option>
   644→                  <option value="Other">Other</option>
   645→                </select>
   646→              </div>
   647→              {/* Start Date and Session */}
   648→              <div className="grid grid-cols-3 gap-2">
   649→                <div className="form-control col-span-2">
   650→                  <label className="label">
   651→                    <span className="label-text">Start Date</span>
   652→                  </label>
   653→                  <input
   654→                    type="date"
   655→                    className="input input-bordered"
   656→                    value={newRequest.startDate}
   657→                    onChange={(e) => setNewRequest({ ...newRequest, startDate: e.target.value })}
   658→                    required
   659→                  />
   660→                </div>
   661→                <div className="form-control">
   662→                  <label className="label">
   663→                    <span className="label-text">Session</span>
   664→                  </label>
   665→                  <select
   666→                    className="select select-bordered"
   667→                    value={newRequest.startSession}
   668→                    onChange={(e) => setNewRequest({ ...newRequest, startSession: e.target.value })}
   669→                  >
   670→                    <option value="AM">AM</option>
   671→                    <option value="PM">PM</option>
   672→                  </select>
   673→                </div>
   674→              </div>
   675→
   676→              {/* End Date and Session */}
   677→              <div className="grid grid-cols-3 gap-2">
   678→                <div className="form-control col-span-2">
   679→                  <label className="label">
   680→                    <span className="label-text">End Date</span>
   681→                    <span className="label-text-alt text-base-content/50">Optional</span>
   682→                  </label>
   683→                  <input
   684→                    type="date"
   685→                    className="input input-bordered"
   686→                    value={newRequest.endDate}
   687→                    onChange={(e) => setNewRequest({ ...newRequest, endDate: e.target.value })}
   688→                    placeholder="Same as start"
   689→                  />
   690→                </div>
   691→                <div className="form-control">
   692→                  <label className="label">
   693→                    <span className="label-text">Session</span>
   694→                  </label>
   695→                  <select
   696→                    className="select select-bordered"
   697→                    value={newRequest.endSession}
   698→                    onChange={(e) => setNewRequest({ ...newRequest, endSession: e.target.value })}
   699→                  >
   700→                    <option value="AM">AM</option>
   701→                    <option value="PM">PM</option>
   702→                  </select>
   703→                </div>
   704→              </div>
   705→
   706→              {/* Computed Total Days Chip */}
   707→              {newRequest.startDate && (() => {
   708→                const start = new Date(newRequest.startDate);
   709→                const end = newRequest.endDate ? new Date(newRequest.endDate) : new Date(newRequest.startDate);
   710→                const totalDays = computeTotalDays(start, end, newRequest.startSession, newRequest.endSession);
   711→                const oneYearAgo = new Date();
   712→                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
   713→                const isTooOld = start < oneYearAgo;
   714→                const isInvalid = totalDays === null || totalDays > 60 || end < start;
   715→
   716→                return (
   717→                  <div className={`text-sm p-3 rounded-lg flex items-center gap-2 ${isInvalid || isTooOld ? 'bg-error/10 text-error' : 'bg-primary/10 text-primary'}`}>
   718→                    {end < start ? (
   719→                      <span>End date must be on or after start date</span>
   720→                    ) : totalDays === null ? (
   721→                      <span>Invalid: PM to AM on same day not allowed</span>
   722→                    ) : totalDays > 60 ? (
   723→                      <span>Maximum 60 days per request ({totalDays} days selected)</span>
   724→                    ) : isTooOld ? (
   725→                      <span>Start date is too far in the past</span>
   726→                    ) : (
   727→                      <>
   728→                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   729→                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
   730→                        </svg>
   731→                        <span className="font-semibold">
   732→                          Total requested: {totalDays} day{totalDays !== 1 ? 's' : ''}
   733→                        </span>
   734→                        {totalDays === 0.5 && <span className="text-xs opacity-75">(half day)</span>}
   735→                      </>
   736→                    )}
   737→                  </div>
   738→                );
   739→              })()}
   740→              <div className="form-control">
   741→                <label className="label">
   742→                  <span className="label-text">Notes (optional)</span>
   743→                </label>
   744→                <textarea
   745→                  className="textarea textarea-bordered"
   746→                  placeholder="Any additional details..."
   747→                  rows={2}
   748→                  value={newRequest.notes}
   749→                  onChange={(e) => setNewRequest({ ...newRequest, notes: e.target.value })}
   750→                />
   751→              </div>
   752→              <div className="modal-action">
   753→                <button
   754→                  type="button"
   755→                  className="btn btn-ghost"
   756→                  onClick={() => setShowCreateModal(false)}
   757→                >
   758→                  Cancel
   759→                </button>
   760→                <button type="submit" className="btn btn-primary">
   761→                  Submit Request
   762→                </button>
   763→              </div>
   764→            </form>
   765→          </div>
   766→          <div className="modal-backdrop" onClick={() => setShowCreateModal(false)}></div>
   767→        </div>
   768→      )}
   769→
   770→      {/* Approve/Reject Modal */}
   771→      {actionModal.open && actionModal.request && (
   772→        <div className="modal modal-open">
   773→          <div className="modal-box">
   774→            <h3 className="font-bold text-lg">
   775→              {actionModal.action === "approve" ? "Approve" : "Reject"} Holiday Request
   776→            </h3>
   777→            <div className="mt-4">
   778→              <div className="bg-base-200 p-3 rounded-lg">
   779→                <p className="font-semibold">{actionModal.request.userName}</p>
   780→                <p className="text-sm">
   781→                  {formatDate(actionModal.request.startDate)}
   782→                  {actionModal.request.startSession && <span className="text-xs text-base-content/50 ml-1">({actionModal.request.startSession})</span>}
   783→                  {" - "}
   784→                  {formatDate(actionModal.request.endDate)}
   785→                  {actionModal.request.endSession && <span className="text-xs text-base-content/50 ml-1">({actionModal.request.endSession})</span>}
   786→                  <span className="text-base-content/50 ml-2">
   787→                    ({actionModal.request.totalDaysComputed || actionModal.request.totalDays || calculateDays(actionModal.request.startDate, actionModal.request.endDate)} days)
   788→                  </span>
   789→                </p>
   790→                <p className="text-sm text-base-content/60">{actionModal.request.type}</p>
   791→              </div>
   792→              <div className="form-control mt-4">
   793→                <label className="label">
   794→                  <span className="label-text">Admin Note (optional)</span>
   795→                </label>
   796→                <textarea
   797→                  className="textarea textarea-bordered"
   798→                  placeholder={actionModal.action === "reject" ? "Reason for rejection..." : "Any notes..."}
   799→                  rows={2}
   800→                  value={adminNote}
   801→                  onChange={(e) => setAdminNote(e.target.value)}
   802→                />
   803→              </div>
   804→            </div>
   805→            <div className="modal-action">
   806→              <button
   807→                className="btn btn-ghost"
   808→                onClick={() => {
   809→                  setActionModal({ open: false, request: null, action: null });
   810→                  setAdminNote("");
   811→                }}
   812→                disabled={isProcessing}
   813→              >
   814→                Cancel
   815→              </button>
   816→              {actionModal.action === "approve" ? (
   817→                <button
   818→                  className="btn btn-success gap-2"
   819→                  onClick={() => handleApprove(actionModal.request)}
   820→                  disabled={isProcessing}
   821→                >
   822→                  {isProcessing ? (
   823→                    <span className="loading loading-spinner loading-sm"></span>
   824→                  ) : (
   825→                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   826→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   827→                    </svg>
   828→                  )}
   829→                  {isProcessing ? "Approving..." : "Approve"}
   830→                </button>
   831→              ) : (
   832→                <button
   833→                  className="btn btn-error gap-2"
   834→                  onClick={() => handleReject(actionModal.request)}
   835→                  disabled={isProcessing}
   836→                >
   837→                  {isProcessing ? (
   838→                    <span className="loading loading-spinner loading-sm"></span>
   839→                  ) : (
   840→                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   841→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   842→                    </svg>
   843→                  )}
   844→                  {isProcessing ? "Rejecting..." : "Confirm Reject"}
   845→                </button>
   846→              )}
   847→            </div>
   848→          </div>
   849→          <div
   850→            className="modal-backdrop"
   851→            onClick={() => {
   852→              setActionModal({ open: false, request: null, action: null });
   853→              setAdminNote("");
   854→            }}
   855→          ></div>
   856→        </div>
   857→      )}
   858→    </DashboardLayout>
   859→  );
   860→}
   861→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
