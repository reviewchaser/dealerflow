     1→import { useEffect, useState } from "react";
     2→import Head from "next/head";
     3→import DashboardLayout from "@/components/DashboardLayout";
     4→import toast from "react-hot-toast";
     5→
     6→const ROLES = ["OWNER", "ADMIN", "STAFF", "WORKSHOP"];
     7→
     8→const ROLE_DESCRIPTIONS = {
     9→  OWNER: "Full access, can manage team and billing",
    10→  ADMIN: "Full access, can manage team (except owners)",
    11→  STAFF: "Can manage vehicles, forms, and customers",
    12→  WORKSHOP: "Limited access to tasks and forms",
    13→};
    14→
    15→const ROLE_COLORS = {
    16→  OWNER: "badge-primary",
    17→  ADMIN: "badge-secondary",
    18→  STAFF: "badge-accent",
    19→  WORKSHOP: "badge-ghost",
    20→};
    21→
    22→export default function TeamSettings() {
    23→  const [members, setMembers] = useState([]);
    24→  const [invites, setInvites] = useState([]);
    25→  const [loading, setLoading] = useState(true);
    26→  const [currentUserRole, setCurrentUserRole] = useState(null);
    27→  const [emailStatus, setEmailStatus] = useState(null);
    28→
    29→  // Invite form
    30→  const [inviteEmail, setInviteEmail] = useState("");
    31→  const [inviteRole, setInviteRole] = useState("STAFF");
    32→  const [inviting, setInviting] = useState(false);
    33→
    34→  // Create user form (direct creation without email invite)
    35→  const [showCreateUserModal, setShowCreateUserModal] = useState(false);
    36→  const [createUserForm, setCreateUserForm] = useState({
    37→    name: "",
    38→    email: "",
    39→    password: "",
    40→    role: "STAFF",
    41→  });
    42→  const [creatingUser, setCreatingUser] = useState(false);
    43→
    44→  useEffect(() => {
    45→    fetchTeamData();
    46→  }, []);
    47→
    48→  const fetchTeamData = async () => {
    49→    setLoading(true);
    50→    try {
    51→      const [membersRes, invitesRes, emailRes] = await Promise.all([
    52→        fetch("/api/team/members"),
    53→        fetch("/api/team/invites"),
    54→        fetch("/api/team/email-status"),
    55→      ]);
    56→
    57→      if (membersRes.ok) {
    58→        const membersData = await membersRes.json();
    59→        setMembers(membersData);
    60→        // Find current user's role
    61→        const currentUser = membersData.find((m) => m.isCurrentUser);
    62→        setCurrentUserRole(currentUser?.role || null);
    63→      }
    64→
    65→      if (invitesRes.ok) {
    66→        const invitesData = await invitesRes.json();
    67→        setInvites(invitesData);
    68→      }
    69→
    70→      if (emailRes.ok) {
    71→        const emailData = await emailRes.json();
    72→        setEmailStatus(emailData);
    73→      }
    74→    } catch (error) {
    75→      toast.error("Failed to load team data");
    76→    } finally {
    77→      setLoading(false);
    78→    }
    79→  };
    80→
    81→  const canManageTeam = ["OWNER", "ADMIN"].includes(currentUserRole);
    82→  const isOwner = currentUserRole === "OWNER";
    83→
    84→  const handleInvite = async (e) => {
    85→    e.preventDefault();
    86→    if (!inviteEmail.trim()) return;
    87→
    88→    setInviting(true);
    89→    try {
    90→      const res = await fetch("/api/team/invites", {
    91→        method: "POST",
    92→        headers: { "Content-Type": "application/json" },
    93→        body: JSON.stringify({ email: inviteEmail, role: inviteRole }),
    94→      });
    95→
    96→      const data = await res.json();
    97→
    98→      if (res.ok) {
    99→        toast.success(`Invite sent to ${inviteEmail}`);
   100→        setInviteEmail("");
   101→        setInviteRole("STAFF");
   102→        fetchTeamData();
   103→
   104→        // Show invite URL in dev mode
   105→        if (data.inviteUrl) {
   106→          console.log("Invite URL (dev mode):", data.inviteUrl);
   107→        }
   108→      } else {
   109→        toast.error(data.error || "Failed to send invite");
   110→      }
   111→    } catch (error) {
   112→      toast.error("Failed to send invite");
   113→    } finally {
   114→      setInviting(false);
   115→    }
   116→  };
   117→
   118→  const handleChangeRole = async (membershipId, newRole) => {
   119→    try {
   120→      const res = await fetch("/api/team/members", {
   121→        method: "PATCH",
   122→        headers: { "Content-Type": "application/json" },
   123→        body: JSON.stringify({ membershipId, newRole }),
   124→      });
   125→
   126→      const data = await res.json();
   127→
   128→      if (res.ok) {
   129→        toast.success("Role updated");
   130→        fetchTeamData();
   131→      } else {
   132→        toast.error(data.error || "Failed to update role");
   133→      }
   134→    } catch (error) {
   135→      toast.error("Failed to update role");
   136→    }
   137→  };
   138→
   139→  const handleRemoveMember = async (membershipId, memberName) => {
   140→    if (!confirm(`Remove ${memberName} from the team?`)) return;
   141→
   142→    try {
   143→      const res = await fetch("/api/team/members", {
   144→        method: "DELETE",
   145→        headers: { "Content-Type": "application/json" },
   146→        body: JSON.stringify({ membershipId }),
   147→      });
   148→
   149→      const data = await res.json();
   150→
   151→      if (res.ok) {
   152→        toast.success("Member removed");
   153→        fetchTeamData();
   154→      } else {
   155→        toast.error(data.error || "Failed to remove member");
   156→      }
   157→    } catch (error) {
   158→      toast.error("Failed to remove member");
   159→    }
   160→  };
   161→
   162→  const handleResendInvite = async (inviteId) => {
   163→    try {
   164→      const res = await fetch("/api/team/invites", {
   165→        method: "PATCH",
   166→        headers: { "Content-Type": "application/json" },
   167→        body: JSON.stringify({ inviteId }),
   168→      });
   169→
   170→      const data = await res.json();
   171→
   172→      if (res.ok) {
   173→        toast.success("Invite resent");
   174→        fetchTeamData();
   175→      } else {
   176→        toast.error(data.error || "Failed to resend invite");
   177→      }
   178→    } catch (error) {
   179→      toast.error("Failed to resend invite");
   180→    }
   181→  };
   182→
   183→  const handleRevokeInvite = async (inviteId) => {
   184→    if (!confirm("Revoke this invite?")) return;
   185→
   186→    try {
   187→      const res = await fetch("/api/team/invites", {
   188→        method: "DELETE",
   189→        headers: { "Content-Type": "application/json" },
   190→        body: JSON.stringify({ inviteId }),
   191→      });
   192→
   193→      const data = await res.json();
   194→
   195→      if (res.ok) {
   196→        toast.success("Invite revoked");
   197→        fetchTeamData();
   198→      } else {
   199→        toast.error(data.error || "Failed to revoke invite");
   200→      }
   201→    } catch (error) {
   202→      toast.error("Failed to revoke invite");
   203→    }
   204→  };
   205→
   206→  // Create user directly (no email invite)
   207→  const handleCreateUser = async (e) => {
   208→    e.preventDefault();
   209→    if (!createUserForm.name.trim() || !createUserForm.email.trim() || !createUserForm.password) {
   210→      return toast.error("Please fill in all fields");
   211→    }
   212→    if (createUserForm.password.length < 6) {
   213→      return toast.error("Password must be at least 6 characters");
   214→    }
   215→
   216→    setCreatingUser(true);
   217→    try {
   218→      const res = await fetch("/api/team/create-user", {
   219→        method: "POST",
   220→        headers: { "Content-Type": "application/json" },
   221→        body: JSON.stringify(createUserForm),
   222→      });
   223→
   224→      const data = await res.json();
   225→
   226→      if (res.ok) {
   227→        toast.success("User created successfully");
   228→        setShowCreateUserModal(false);
   229→        setCreateUserForm({ name: "", email: "", password: "", role: "STAFF" });
   230→        fetchTeamData();
   231→      } else {
   232→        toast.error(data.error || "Failed to create user");
   233→      }
   234→    } catch (error) {
   235→      toast.error("Failed to create user");
   236→    } finally {
   237→      setCreatingUser(false);
   238→    }
   239→  };
   240→
   241→  return (
   242→    <DashboardLayout>
   243→      <Head>
   244→        <title>Team Settings | DealerFlow</title>
   245→      </Head>
   246→
   247→      <div className="mb-8">
   248→        <h1 className="text-3xl font-bold">Team</h1>
   249→        <p className="text-base-content/60 mt-2">
   250→          Manage your team members and invitations
   251→        </p>
   252→      </div>
   253→
   254→      {loading ? (
   255→        <div className="flex justify-center py-20">
   256→          <span className="loading loading-spinner loading-lg"></span>
   257→        </div>
   258→      ) : (
   259→        <div className="space-y-8">
   260→          {/* Email Not Configured Banner */}
   261→          {emailStatus && !emailStatus.configured && (
   262→            <div className="alert alert-warning">
   263→              <svg xmlns="http://www.w3.org/2000/svg" className="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
   264→                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
   265→              </svg>
   266→              <div>
   267→                <h3 className="font-bold">Email invites disabled</h3>
   268→                <p className="text-sm">
   269→                  Invite emails cannot be sent until email is configured.
   270→                  {emailStatus.missing?.length > 0 && (
   271→                    <span className="block mt-1">
   272→                      Missing: <code className="text-xs bg-base-300 px-1 rounded">{emailStatus.missing.join(", ")}</code>
   273→                    </span>
   274→                  )}
   275→                </p>
   276→                <p className="text-xs mt-1 opacity-70">
   277→                  {process.env.NODE_ENV === "development"
   278→                    ? "In development mode, invite links will be logged to the console."
   279→                    : "Contact your administrator to configure email settings."}
   280→                </p>
   281→              </div>
   282→            </div>
   283→          )}
   284→
   285→          {/* Invite Form */}
   286→          {canManageTeam && (
   287→            <div className="card bg-base-200">
   288→              <div className="card-body">
   289→                <h2 className="card-title">Invite Team Member</h2>
   290→                <form onSubmit={handleInvite} className="flex flex-wrap gap-4 mt-4">
   291→                  <div className="form-control flex-1 min-w-[200px]">
   292→                    <input
   293→                      type="email"
   294→                      className="input input-bordered"
   295→                      placeholder="colleague@dealership.com"
   296→                      value={inviteEmail}
   297→                      onChange={(e) => setInviteEmail(e.target.value)}
   298→                      required
   299→                    />
   300→                  </div>
   301→                  <div className="form-control">
   302→                    <select
   303→                      className="select select-bordered"
   304→                      value={inviteRole}
   305→                      onChange={(e) => setInviteRole(e.target.value)}
   306→                    >
   307→                      {ROLES.map((role) => (
   308→                        <option
   309→                          key={role}
   310→                          value={role}
   311→                          disabled={role === "OWNER" && !isOwner}
   312→                        >
   313→                          {role}
   314→                        </option>
   315→                      ))}
   316→                    </select>
   317→                  </div>
   318→                  <button
   319→                    type="submit"
   320→                    className="btn btn-primary"
   321→                    disabled={inviting || !inviteEmail.trim()}
   322→                  >
   323→                    {inviting ? (
   324→                      <span className="loading loading-spinner loading-sm"></span>
   325→                    ) : (
   326→                      <>
   327→                        <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   328→                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
   329→                        </svg>
   330→                        Send Invite
   331→                      </>
   332→                    )}
   333→                  </button>
   334→                  <div className="divider divider-horizontal mx-1">or</div>
   335→                  <button
   336→                    type="button"
   337→                    className="btn btn-secondary"
   338→                    onClick={() => setShowCreateUserModal(true)}
   339→                  >
   340→                    <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   341→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
   342→                    </svg>
   343→                    Create User
   344→                  </button>
   345→                </form>
   346→                <p className="text-xs text-base-content/50 mt-2">
   347→                  Invites expire after 7 days. Use "Create User" to add team members without sending an invite email.
   348→                </p>
   349→              </div>
   350→            </div>
   351→          )}
   352→
   353→          {/* Members Table */}
   354→          <div className="card bg-base-200">
   355→            <div className="card-body">
   356→              <h2 className="card-title">Team Members ({members.length})</h2>
   357→              <div className="overflow-x-auto mt-4">
   358→                <table className="table table-zebra">
   359→                  <thead>
   360→                    <tr>
   361→                      <th>Member</th>
   362→                      <th>Role</th>
   363→                      <th>Joined</th>
   364→                      {canManageTeam && <th className="w-32">Actions</th>}
   365→                    </tr>
   366→                  </thead>
   367→                  <tbody>
   368→                    {members.map((member) => (
   369→                      <tr key={member.id}>
   370→                        <td>
   371→                          <div className="flex items-center gap-3">
   372→                            <div className="avatar placeholder">
   373→                              <div className="bg-neutral text-neutral-content rounded-full w-10">
   374→                                {member.image ? (
   375→                                  <img src={member.image} alt={member.name} />
   376→                                ) : (
   377→                                  <span className="text-sm">
   378→                                    {member.name?.charAt(0)?.toUpperCase() || "?"}
   379→                                  </span>
   380→                                )}
   381→                              </div>
   382→                            </div>
   383→                            <div>
   384→                              <div className="font-semibold">
   385→                                {member.name}
   386→                                {member.isCurrentUser && (
   387→                                  <span className="ml-2 text-xs text-base-content/50">(you)</span>
   388→                                )}
   389→                              </div>
   390→                              <div className="text-sm text-base-content/60">{member.email}</div>
   391→                            </div>
   392→                          </div>
   393→                        </td>
   394→                        <td>
   395→                          {canManageTeam && !member.isCurrentUser ? (
   396→                            <select
   397→                              className={`select select-sm select-bordered ${ROLE_COLORS[member.role]}`}
   398→                              value={member.role}
   399→                              onChange={(e) => handleChangeRole(member.id, e.target.value)}
   400→                              disabled={member.role === "OWNER" && !isOwner}
   401→                            >
   402→                              {ROLES.map((role) => (
   403→                                <option
   404→                                  key={role}
   405→                                  value={role}
   406→                                  disabled={role === "OWNER" && !isOwner}
   407→                                >
   408→                                  {role}
   409→                                </option>
   410→                              ))}
   411→                            </select>
   412→                          ) : (
   413→                            <span className={`badge ${ROLE_COLORS[member.role]}`}>
   414→                              {member.role}
   415→                            </span>
   416→                          )}
   417→                        </td>
   418→                        <td className="text-sm text-base-content/60">
   419→                          {new Date(member.joinedAt).toLocaleDateString()}
   420→                        </td>
   421→                        {canManageTeam && (
   422→                          <td>
   423→                            {!member.isCurrentUser && (
   424→                              <button
   425→                                className="btn btn-ghost btn-sm text-error"
   426→                                onClick={() => handleRemoveMember(member.id, member.name)}
   427→                                disabled={member.role === "OWNER" && !isOwner}
   428→                              >
   429→                                Remove
   430→                              </button>
   431→                            )}
   432→                          </td>
   433→                        )}
   434→                      </tr>
   435→                    ))}
   436→                  </tbody>
   437→                </table>
   438→              </div>
   439→            </div>
   440→          </div>
   441→
   442→          {/* Pending Invites */}
   443→          {canManageTeam && invites.length > 0 && (
   444→            <div className="card bg-base-200">
   445→              <div className="card-body">
   446→                <h2 className="card-title">Pending Invites ({invites.length})</h2>
   447→                <div className="overflow-x-auto mt-4">
   448→                  <table className="table table-zebra">
   449→                    <thead>
   450→                      <tr>
   451→                        <th>Email</th>
   452→                        <th>Role</th>
   453→                        <th>Invited By</th>
   454→                        <th>Status</th>
   455→                        <th className="w-40">Actions</th>
   456→                      </tr>
   457→                    </thead>
   458→                    <tbody>
   459→                      {invites.map((invite) => (
   460→                        <tr key={invite.id}>
   461→                          <td className="font-medium">{invite.email}</td>
   462→                          <td>
   463→                            <span className={`badge ${ROLE_COLORS[invite.role]}`}>
   464→                              {invite.role}
   465→                            </span>
   466→                          </td>
   467→                          <td className="text-sm text-base-content/60">{invite.invitedBy}</td>
   468→                          <td>
   469→                            {invite.isExpired ? (
   470→                              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-red-50 text-red-700 border border-red-200">Expired</span>
   471→                            ) : (
   472→                              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-200">Pending</span>
   473→                            )}
   474→                            <div className="text-xs text-base-content/50 mt-1">
   475→                              Expires: {new Date(invite.expiresAt).toLocaleDateString()}
   476→                            </div>
   477→                          </td>
   478→                          <td className="space-x-1">
   479→                            <button
   480→                              className="btn btn-ghost btn-xs"
   481→                              onClick={() => handleResendInvite(invite.id)}
   482→                            >
   483→                              Resend
   484→                            </button>
   485→                            <button
   486→                              className="btn btn-ghost btn-xs text-error"
   487→                              onClick={() => handleRevokeInvite(invite.id)}
   488→                            >
   489→                              Revoke
   490→                            </button>
   491→                          </td>
   492→                        </tr>
   493→                      ))}
   494→                    </tbody>
   495→                  </table>
   496→                </div>
   497→              </div>
   498→            </div>
   499→          )}
   500→
   501→          {/* Role Permissions Guide */}
   502→          <div className="card bg-base-200">
   503→            <div className="card-body">
   504→              <h2 className="card-title">Role Permissions</h2>
   505→              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
   506→                {ROLES.map((role) => (
   507→                  <div key={role} className="p-4 bg-base-100 rounded-lg">
   508→                    <span className={`badge ${ROLE_COLORS[role]} mb-2`}>{role}</span>
   509→                    <p className="text-sm text-base-content/70">{ROLE_DESCRIPTIONS[role]}</p>
   510→                  </div>
   511→                ))}
   512→              </div>
   513→            </div>
   514→          </div>
   515→        </div>
   516→      )}
   517→
   518→      {/* Create User Modal */}
   519→      {showCreateUserModal && (
   520→        <div className="modal modal-open">
   521→          <div className="modal-box">
   522→            <div className="flex items-center justify-between mb-6">
   523→              <h3 className="text-xl font-bold">Create User</h3>
   524→              <button
   525→                type="button"
   526→                onClick={() => {
   527→                  setShowCreateUserModal(false);
   528→                  setCreateUserForm({ name: "", email: "", password: "", role: "STAFF" });
   529→                }}
   530→                className="btn btn-ghost btn-sm btn-circle"
   531→              >
   532→                ✕
   533→              </button>
   534→            </div>
   535→            <form onSubmit={handleCreateUser}>
   536→              <div className="space-y-4">
   537→                <div className="form-control">
   538→                  <label className="label">
   539→                    <span className="label-text font-medium">Name *</span>
   540→                  </label>
   541→                  <input
   542→                    type="text"
   543→                    className="input input-bordered w-full"
   544→                    placeholder="John Smith"
   545→                    value={createUserForm.name}
   546→                    onChange={(e) => setCreateUserForm({ ...createUserForm, name: e.target.value })}
   547→                    required
   548→                  />
   549→                </div>
   550→                <div className="form-control">
   551→                  <label className="label">
   552→                    <span className="label-text font-medium">Email *</span>
   553→                  </label>
   554→                  <input
   555→                    type="email"
   556→                    className="input input-bordered w-full"
   557→                    placeholder="john@example.com"
   558→                    value={createUserForm.email}
   559→                    onChange={(e) => setCreateUserForm({ ...createUserForm, email: e.target.value })}
   560→                    required
   561→                  />
   562→                </div>
   563→                <div className="form-control">
   564→                  <label className="label">
   565→                    <span className="label-text font-medium">Password *</span>
   566→                  </label>
   567→                  <input
   568→                    type="password"
   569→                    className="input input-bordered w-full"
   570→                    placeholder="Minimum 6 characters"
   571→                    value={createUserForm.password}
   572→                    onChange={(e) => setCreateUserForm({ ...createUserForm, password: e.target.value })}
   573→                    minLength={6}
   574→                    required
   575→                  />
   576→                  <label className="label">
   577→                    <span className="label-text-alt text-base-content/50">The user can log in immediately with this password</span>
   578→                  </label>
   579→                </div>
   580→                <div className="form-control">
   581→                  <label className="label">
   582→                    <span className="label-text font-medium">Role</span>
   583→                  </label>
   584→                  <select
   585→                    className="select select-bordered w-full"
   586→                    value={createUserForm.role}
   587→                    onChange={(e) => setCreateUserForm({ ...createUserForm, role: e.target.value })}
   588→                  >
   589→                    {ROLES.map((role) => (
   590→                      <option
   591→                        key={role}
   592→                        value={role}
   593→                        disabled={role === "OWNER" && !isOwner}
   594→                      >
   595→                        {role} - {ROLE_DESCRIPTIONS[role]}
   596→                      </option>
   597→                    ))}
   598→                  </select>
   599→                </div>
   600→              </div>
   601→              <div className="modal-action">
   602→                <button
   603→                  type="button"
   604→                  className="btn btn-ghost"
   605→                  onClick={() => {
   606→                    setShowCreateUserModal(false);
   607→                    setCreateUserForm({ name: "", email: "", password: "", role: "STAFF" });
   608→                  }}
   609→                >
   610→                  Cancel
   611→                </button>
   612→                <button
   613→                  type="submit"
   614→                  className="btn btn-primary"
   615→                  disabled={creatingUser}
   616→                >
   617→                  {creatingUser ? (
   618→                    <span className="loading loading-spinner loading-sm"></span>
   619→                  ) : (
   620→                    "Create User"
   621→                  )}
   622→                </button>
   623→              </div>
   624→            </form>
   625→          </div>
   626→          <div className="modal-backdrop" onClick={() => setShowCreateUserModal(false)} />
   627→        </div>
   628→      )}
   629→    </DashboardLayout>
   630→  );
   631→}
   632→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
