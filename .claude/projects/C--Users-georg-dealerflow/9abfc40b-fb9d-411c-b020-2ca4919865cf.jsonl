{"type":"summary","summary":"DealerFlow Mobile UX & OpenAI Debugging Fixes","leafUuid":"89af9f35-994d-436a-a000-f37ad0b95de1"}
{"type":"file-history-snapshot","messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","type":"user","message":{"role":"user","content":"1) Quick Add menu is being overlapped (z-index / layout bug)\n\nIssue: The Quick Add dropdown (top-right “+”) is being covered/overlapped by another element (likely header container, page scroll container, or a stacking context).\n\nFix requirements:\n\nQuick Add dropdown must render above all page content and be fully clickable.\n\nMust work on:\n\nSubmissions page (screenshot shows overlap)\n\nAny page with header + scrollable body\n\nImplementation guidance:\n\nIdentify the dropdown component (likely Dropdown, Menu, DaisyUI dropdown, or custom popover).\n\nCommon causes:\n\nParent has overflow: hidden/auto creating clipping.\n\nParent has transform creating a stacking context.\n\nDropdown z-index too low.\n\nPreferred fix:\n\nRender dropdown via a portal to document.body (e.g. HeadlessUI Popover, Radix, or custom portal).\n\nOr ensure dropdown is positioned fixed relative to viewport with high z-index.\n\nMinimum fix if staying inline:\n\nEnsure dropdown container is not inside any overflow-hidden/auto wrapper.\n\nAdd z-[9999] (Tailwind) to dropdown menu and ensure its ancestors don’t create new stacking contexts.\n\nAcceptance criteria:\n\nQuick Add dropdown is never clipped and never hides behind content.\n\nClicking any dropdown item works reliably.\n\n2) Add two new Quick Add items\n\nAdd these items to the Quick Add menu (top-right):\n\nNew Appraisal\n\nRoute: whatever your appraisal form creation route is (e.g. /appraisals/new or /app/[dealer]/appraisals/new)\n\nIf you have template-driven forms, link to the “Appraisal” form template create route.\n\nAdd Vehicle\n\nRoute: the “Add Vehicle” flow on Stock page\n\nIf stock uses a modal/drawer, route should open stock page and auto-open the add vehicle modal via query param (recommended):\n\nExample: /stock?addVehicle=1\n\nOn stock page, if router.query.addVehicle === '1', open the add vehicle modal.\n\nAcceptance criteria:\n\nBoth items appear in menu.\n\nThey open the correct screen/flow.\n\n“Add Vehicle” reliably opens the add modal/drawer without extra clicks.\n\n3) AI is still failing: full debug + fix + test + update old error styling\n\nIssue: AI Suggestions (and others) still show:\n\n“OpenAI service is not configured or unavailable. Please set OPENAI_API_KEY.”\n\nWe need an end-to-end fix (env + backend + frontend checks + auth timing) and also refresh the styling (currently old/legacy alert styling).\n\nHard requirements:\n\nAI must actually work from the UI, logged-in, on real data.\n\nThe UI must not incorrectly claim the key is missing when it isn’t.\n\nRemove any outdated “old styling” on that error message and align it with current DaisyUI/Tailwind alert patterns.\n\nDo this exactly:\n\nA) Confirm environment + where it’s failing\n\nIn server logs, confirm the API route is actually being called (not blocked before request).\n\nEnsure the AI API routes use process.env.OPENAI_API_KEY on server only.\n\nB) Stop frontend “guessing” configuration\n\nFrontend should not determine config by checking env vars directly.\n\nAdd (or keep) a lightweight server-side health route:\n\n/pages/api/ai/health.js\n\nProtected by withDealerContext (same auth expectations as other AI routes).\n\nReturns:\n\n{ ok: true, provider: \"openai\", hasKey: true, model: \"...\"}\n\nOn failure: { ok: false, provider: \"openai\", hasKey: false, error: \"...\" }\n\nIn the UI diagnostics panel, “Refresh” should call /api/ai/health and show the truth.\n\nC) Ensure AI calls only happen after auth is ready\n\nCommon cause: AI calls fire before session is authenticated, returning 401/403, but UI maps it to “not configured”.\n\nFix mapping:\n\nIf response is 401/403 → show “You must be signed in” or “Not authorised”\n\nIf response is 500 with missing key → show key error\n\nIf OpenAI returns 429/5xx → show rate limit/service error\n\nD) Centralise OpenAI client (if not already)\n\nCreate lib/ai/openaiClient.(ts|js) and have all /pages/api/ai/* routes use it.\n\nOne model choice (e.g. gpt-4o-mini) across the app for now.\n\nRemove any remaining Anthropic/Claude code paths and messages.\n\nE) Styling update for the error component\n\nReplace legacy styles with a consistent component:\n\nUse DaisyUI alert alert-error or your current app alert design.\n\nEnsure it’s readable on mobile and not semi-transparent.\n\nAcceptance criteria (must test):\n\nWarranty AI suggestions generate text successfully in UI.\n\nCase review generates successfully.\n\nAppraisal AI suggestions populate successfully.\n\n/api/ai/health shows ok:true when key exists.\n\nUI error messages differ correctly for:\n\nunauthenticated vs missing key vs OpenAI failure.\n\n4) Test Drive form: extract customer details from driving licence photo (OCR/vision) + manual fallback\n\nGoal: On the Test Drive Request form, the first step should be capturing the licence image (camera or upload). The system should then auto-fill:\n\nFull name\n\nAddress (and postcode)\n\nDate of birth (optional if you want it)\n\nDriving licence number\n\nExpiry date (optional)\n\nIssue date (optional)\n\nThen show a manual edit/fallback section below if extraction fails or is incomplete.\n\nRecommended approach (fast + reliable): OpenAI Vision extraction\n\nBecause DealerFlow already uses OpenAI, use OpenAI vision server-side for document parsing.\n\nFlow:\n\nAdd a field at top of Test Drive form: “Scan driving licence” (camera/upload)\n\nWhen image is selected:\n\nUpload it to your server endpoint /api/forms/test-drive/extract-licence (new)\n\nAPI uses OpenAI vision model (e.g. gpt-4o-mini) with a strict JSON schema response\n\nReturn extracted fields to frontend\n\nFrontend populates the corresponding form fields and displays a banner:\n\n“Details captured from licence — please verify”\n\nBackend endpoint requirements:\n\nAuth-protected with dealer context.\n\nAccept multipart/form-data image upload.\n\nCall OpenAI with:\n\nA short system prompt: “Extract fields from a UK driving licence. Return JSON only.”\n\nAsk for JSON keys: fullName, addressLine1, addressLine2, town, postcode, licenceNumber, dateOfBirth, expiryDate, issueDate, confidence and missingFields.\n\nValidate output:\n\nIf JSON parse fails or confidence low → return { ok:false } and do not autofill.\n\nFrontend requirements:\n\nStep 1: Scan licence\n\nThen show:\n\nAuto-filled inputs (editable)\n\n“Couldn’t extract X field(s)” inline\n\nManual entry fields always visible but collapsed/secondary if extraction succeeded\n\nProvide “Clear scanned data” option.\n\nPrivacy / compliance note (implementation detail)\n\nDo not store the raw licence image permanently unless required.\n\nIdeally:\n\nStore the uploaded image only temporarily for extraction\n\nOr store only if the dealer explicitly saves it (with a checkbox: “Save licence image to record”)\n\nAcceptance criteria:\n\nOn mobile, user can take a photo and it auto-fills name/address/licence number.\n\nManual editing works and overrides.\n\nIf extraction fails, user is prompted to complete manually (no blocker).\n\nForm submission includes the extracted + edited values.\n\nExtraction endpoint is secure and tenant-safe."},"uuid":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","timestamp":"2025-12-30T15:41:12.675Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"parentUuid":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NVqCTUEAtkh8Fv6E1r5RJH","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The user has given me a comprehensive set of tasks to complete. Let me break these down:\n\n1. **Quick Add menu z-index/layout bug** - The dropdown is being overlapped by other elements\n2. **Add two new Quick Add items** - New Appraisal and Add Vehicle\n3. **AI is still failing** - Full debug, fix, test, and update error styling\n4. **Test Drive form OCR** - Extract customer details from driving licence photo\n\nThis is a substantial set of tasks. Let me start by creating a todo list and then exploring the codebase to understand the current structure.\n\nFirst, I should explore the codebase to understand:\n- Where the Quick Add dropdown is located\n- The current AI implementation\n- The Test Drive form structure\n- The overall project architecture\n\nLet me start by exploring the project structure.","signature":"EroHCkYICxgCKkDfZY9oUkpno7gF9HJ8J04/Cxad8CzSU9EtZvFceJ9PRawu/a/flD89i96tKOd3yoTfHCMeIWto6qtMqOLyMcezEgycKjBwGirD7W0GMEsaDAWHpPI4p0fASVAOIyIwjDImySikz0aSKpvzQcrW3PA/iKfkHfRoFpfGZh11rdlm4a08lUdWVS3tJv7vE2Q8KqEG7PKp+ODUAD+Svn/GsMBHsEQkwNbswVMny+IKvvHsc+HG6nrvUoOg1Awo14K/1Vi/K5ONjsLyihZzex1HByEAwJwYYEM6pBhA1s/492Mpl2zPcIskM+PN23dkCC9m41QqZzJcE0+2v0PLndC0Wfr9q6GAD0eD8I5VkGRaIy42Gny24WUobVf2TEkiyINnmQ9YvjCgi/3Hc5kmwwrCMpPmPKsA1b9bgFwZiKI8L8UQ7LJjtutmZGE2wu0kUFPSWADh3xCSVUnpGaKjVrM+6zzjTegJcIOP+Hr3vu5NdOUpIQtVX1gFyCDAJl3e0sxWWSMg68XH9CNUsMLEvbD7WPso0G1Ln48VpgBaqwt4lJAy4lOvNNgKeEUACO/mpQmg0zCpKwXI8FMxgjUhiVAFbrA+KyBf84aHNJQLFOqKAuV/jGUiFSE3RyXTMlpiVGThR4q1agZwoB0a7i1g32Ui4LkEpyCoNqufmIw/tzJfg1PY7NKtgodaf2YjTifPyn5qfL2CrfLfCekn6Ez40k3liXx99PdFmakdoU2cD9WHo67OgSQRZR1aWpL7EUDhmfiTrC/OSpuzj/IJcu8oBIWB+N0Xm7u7Sr6OePa9Drj7SFkDMB5C48xuruwL9vm0NlNGneEGXT/jcGj6lZvOHGpno7oQZfY2gMvRp/xstp8Diit6T0CE0zAb0HKyFwKD73LLGQEVhfMMp/b2NlIo4LHVQ8lH+Xq2KJYFhvuAj86bVA+XRIJDqYsbQF+SqoawmR4yFEQsr1YLbKetGhXv1BPJCyjMf8niqtQGx5kh9+JFSuJiW9hZmiRl16EbCp06Q4D+atnDZ0AYED52PKXEkUpxHiBxjwqIw5wN5JZUjHCK8j9G3oaOFMjQSSK0j1q/8/36HKaKvef2gkccitlU2vCIwBH/PKVAmBA5UzuRFpeQ03tK16LVKX2X2FtdhxrIITnHtyY4IlvKYtB1esrb8GISDP1As80my7PsH6YG//fq0F8tsgvuM6vdW1RxVuGq6mhzmBOD20LcseDyZ3/LrvGGA12gWWYoCe8t03FVvOGMemwHBEXXGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":7964,"cache_read_input_tokens":12832,"cache_creation":{"ephemeral_5m_input_tokens":7964,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8DBM2KURveFnvnZaFT","type":"assistant","uuid":"84fda8fa-4a04-4e6e-9a83-5f5767e70fbc","timestamp":"2025-12-30T15:41:21.364Z"}
{"parentUuid":"84fda8fa-4a04-4e6e-9a83-5f5767e70fbc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NVqCTUEAtkh8Fv6E1r5RJH","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you with these four tasks. Let me start by creating a todo list and exploring the codebase to understand the current structure."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":7964,"cache_read_input_tokens":12832,"cache_creation":{"ephemeral_5m_input_tokens":7964,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8DBM2KURveFnvnZaFT","type":"assistant","uuid":"c9f483e0-0fa5-48be-b9f5-4f59ebe5425d","timestamp":"2025-12-30T15:41:22.120Z"}
{"parentUuid":"c9f483e0-0fa5-48be-b9f5-4f59ebe5425d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NVqCTUEAtkh8Fv6E1r5RJH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014bouyr5E6JkKXeGrNFg9sM","name":"TodoWrite","input":{"todos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"pending","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"pending","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"pending","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"pending","activeForm":"Implementing Test Drive licence OCR extraction"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":7964,"cache_read_input_tokens":12832,"cache_creation":{"ephemeral_5m_input_tokens":7964,"ephemeral_1h_input_tokens":0},"output_tokens":426,"service_tier":"standard"}},"requestId":"req_011CWd8DBM2KURveFnvnZaFT","type":"assistant","uuid":"26592622-d119-4215-9371-9a4447bee7be","timestamp":"2025-12-30T15:41:25.054Z"}
{"parentUuid":"26592622-d119-4215-9371-9a4447bee7be","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014bouyr5E6JkKXeGrNFg9sM","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"d5b9400d-2f47-4bbd-8869-39cee70f0fd8","timestamp":"2025-12-30T15:41:25.126Z","toolUseResult":{"oldTodos":[],"newTodos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"pending","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"pending","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"pending","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"pending","activeForm":"Implementing Test Drive licence OCR extraction"}]}}
{"parentUuid":"d5b9400d-2f47-4bbd-8869-39cee70f0fd8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JLBX5B3oeAXAYMQzRU6Gyt","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me explore the codebase to understand the structure and find the relevant components.","signature":"EoECCkYICxgCKkAHhiVK7kB+JVdnlegddArQsXgkH18irqGpVHguhqlMTYBewzd0Sm6pZcSbgvV04dLGExP2MgjKUnIXgwuGCCqzEgz8667M4HAXaRauLVwaDLM+yA9gmDQerV8RjyIwvLFrGjM5k2mtKUZVt/+lWt96mRGyUj6Aw2kZK8vtQVx0wwGF/KAtt3anqxbB9uESKmlJYKIzJH+cElQltTGiyNjtbdAvZah/QelvIY4aYwqy2oehJGNo54jNJQ6qRASiABokA4deogfvdsXMovx91XtHUnzTA0po/5ukaik2agRsNH1tSxe6ucmxbA+VpScaXJgJFIqM+M+J4xgYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":466,"cache_read_input_tokens":20796,"cache_creation":{"ephemeral_5m_input_tokens":466,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8E6c3tjtL3FEuQTXVu","type":"assistant","uuid":"cda063cb-b430-4c7e-a102-bd4bbb2cc313","timestamp":"2025-12-30T15:41:29.888Z"}
{"parentUuid":"cda063cb-b430-4c7e-a102-bd4bbb2cc313","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JLBX5B3oeAXAYMQzRU6Gyt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017HntpXCJmTEWhQcUWR9Wg2","name":"Task","input":{"description":"Explore codebase structure","prompt":"Explore this codebase to understand:\n1. The overall project structure (Next.js pages, components, etc.)\n2. Where the Quick Add dropdown/menu is located (look for \"Quick Add\", \"quick-add\", dropdown in header, etc.)\n3. Where the AI/OpenAI implementation is (look for openai, ai, suggestions, etc.)\n4. Where the Test Drive form is located\n5. The current routing structure for appraisals and stock\n\nBe thorough and provide file paths for all relevant components.","subagent_type":"Explore"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":466,"cache_read_input_tokens":20796,"cache_creation":{"ephemeral_5m_input_tokens":466,"ephemeral_1h_input_tokens":0},"output_tokens":235,"service_tier":"standard"}},"requestId":"req_011CWd8E6c3tjtL3FEuQTXVu","type":"assistant","uuid":"121cb271-c772-476f-96c1-7fd9b66d520a","timestamp":"2025-12-30T15:41:33.366Z"}
{"parentUuid":"121cb271-c772-476f-96c1-7fd9b66d520a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017HntpXCJmTEWhQcUWR9Wg2","type":"tool_result","content":[{"type":"text","text":"Perfect! Now I have all the information I need. Let me provide a comprehensive exploration report:\n\n## DealerFlow Codebase Exploration Report\n\nI've thoroughly explored the DealerFlow codebase. Here's a comprehensive breakdown:\n\n### 1. PROJECT STRUCTURE (Next.js Application)\n\n**Root directories:**\n- `/components` - React UI components\n- `/pages` - Next.js pages and API routes\n- `/libs` - Utility and library functions\n- `/lib` - Additional library code\n- `/models` - MongoDB Mongoose models\n- `/contexts` - React context providers\n- `/hooks` - Custom React hooks\n- `/docs` - Documentation\n\n**Key configuration files:**\n- `package.json` - Dependencies (React, Next.js, MongoDB, OpenAI, NextAuth, TailwindCSS, etc.)\n- `next.config.js` - Next.js configuration\n- `.env.local` - Environment variables\n\n---\n\n### 2. QUICK ADD DROPDOWN/MENU LOCATION\n\n**File:** `/c/Users/georg/dealerflow/components/DashboardLayout.js` (661 lines)\n\n**Implementation Details:**\n- **Line 487-507:** Quick Add Form Button\n- Uses DaisyUI dropdown component (`dropdown dropdown-end`)\n- Blue circular button with `+` icon (size `w-9 h-9`, color `bg-[#0066CC]`)\n- Located in the header next to the user menu\n- Fetches forms via `/api/forms` endpoint on component mount (line 143-150)\n- When clicked, triggers `handleFormClick(form)` function (lines 211-216)\n- Opens form in new tab if public, otherwise navigates to `/forms/fill/{formId}`\n\n**Form Loading:**\n```javascript\n// Line 143-150\nuseEffect(() => {\n  fetch(\"/api/forms\")\n    .then(res => res.json())\n    .then(data => {\n      if (Array.isArray(data)) setForms(data);\n    })\n    .catch(() => {});\n}, [router]);\n```\n\n---\n\n### 3. AI/OpenAI IMPLEMENTATION\n\n**OpenAI Integration Files:**\n\n1. **`/c/Users/georg/dealerflow/lib/openai.js`** (4 lines)\n   - Simple singleton client initialization\n   - Exposes `openai` client object\n\n2. **`/c/Users/georg/dealerflow/libs/openai.js`** (comprehensive, 100+ lines)\n   - Main OpenAI helper library\n   - Exports: `getOpenAIClient()`, `getAIConfig()`, `safeJsonParse()`, `callOpenAI()`\n   - Handles API key from `OPENAI_API_KEY` environment variable\n   - Includes dummy data generation for demo mode when API not configured\n   - Defines `AI_SUGGESTION_SCHEMA` with 5 categories:\n     - `suspected_issues`\n     - `checks_to_run`\n     - `questions_for_customer`\n     - `parts_to_consider`\n     - `safety_notes`\n\n3. **`/c/Users/georg/dealerflow/libs/gpt.js`** (legacy, ~50 lines)\n   - Old axios-based implementation using GPT-4\n   - Uses `sendOpenAi()` function\n\n**AI Endpoints:**\n\n1. **`/c/Users/georg/dealerflow/pages/api/ai/appraisal-issue-suggestions.js`**\n   - POST endpoint for vehicle appraisal issue analysis\n   - Takes vehicle data (make, model, year, mileage, fuel type, issue description)\n   - Returns structured JSON with diagnostic suggestions\n   - Used during appraisal process for diagnostic guidance\n\n2. **`/c/Users/georg/dealerflow/pages/api/ai/appraisal-summary.js`**\n3. **`/c/Users/georg/dealerflow/pages/api/ai/warranty-summary.js`**\n4. **`/c/Users/georg/dealerflow/pages/api/ai/warranty-suggestions.js`**\n5. **`/c/Users/georg/dealerflow/pages/api/ai/case-review.js`**\n6. **`/c/Users/georg/dealerflow/pages/api/ai/health.js`** - Health check endpoint\n\n**AI UI Component:**\n\n**`/c/Users/georg/dealerflow/components/AISuggestionsPanel.js`** (200+ lines)\n- Collapsible panel displaying AI suggestions\n- Shows: suspected issues with urgency badges, checks to run, customer questions, parts to consider, safety notes\n- \"Copy to notes\" functionality for integration with form data\n- Loading state with spinner\n- Demo badge when in dummy/offline mode\n\n---\n\n### 4. TEST DRIVE FORM LOCATION\n\n**Form Template Definition:** `/c/Users/georg/dealerflow/libs/formTemplates.js`\n\n**Test Drive Form (Lines ~300-350):**\n\n**Current fields:**\n- Test Drive Details section (order 1-2):\n  - Date of Test Drive (DATE field, required, order 1)\n  - Time (TIME field, required, order 2)\n- Customer Details section (order 5-9):\n  - First Name, Last Name, Email, Contact Number\n- Driving Licence section (order 15-16):\n  - Upload Driving Licence (Front) (FILE field)\n- Address section (order 20-24):\n  - Street Address, Line 2, City, Post Code\n- Vehicle Details section (order 30-35):\n  - Vehicle Registration (TEXT, with VRM lookup enabled)\n  - **Vehicle Make** (order 32, `hiddenWhenStockSelected: true`)\n  - **Vehicle Model** (order 33, `hiddenWhenStockSelected: true`)\n  - Source dropdown\n- Terms & Conditions (order 40-42):\n  - Agreement checkbox\n  - Signature field\n\n**Configuration:**\n- `type: \"TEST_DRIVE\"`\n- `visibility: \"PUBLIC\"` (customers can access)\n- `vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] }`\n- Public slug: `\"test-drive\"`\n- Intro text: \"Please complete this form to book a test drive. You must bring your valid driving licence on the day.\"\n\n**Note:** According to CLAUDE.md instructions, the following fields should be removed from the test drive form (but are NOT currently implemented):\n- License Number, License expiry Date, License type\n- Insurance details fields\n- Mileage Out field\n- Fuel Level Out field\n- Accompanied by staff member field\n- Staff Member Name field\n- Date field below signature box\n- Return details fields (including Damage Description and Damage Photos)\n\n---\n\n### 5. ROUTING STRUCTURE\n\n**Pages/Routes (with components):**\n\n**Dashboard & Main Pages:**\n- `/dashboard.js` - Main dashboard with Quick Forms and Quick Actions\n- `/sales-prep.js` - Stock & Prep board (kanban-style vehicle workflow)\n- `/forms.js` - Forms management and submissions page (1764 lines)\n- `/appraisals/index.js` - Appraisals and PX (part-exchange) management\n\n**Tenant-Aware Routes (with dealer slug):**\n- `/app/[dealerSlug]/appraisals.js` - Wrapper using TenantPage component\n- `/app/[dealerSlug]/forms.js`\n- `/app/[dealerSlug]/sales-prep.js`\n- `/app/[dealerSlug]/dashboard.js`\n- `/app/[dealerSlug]/vehicles/[id].js`\n- `/app/[dealerSlug]/vehicles/index.js`\n- `/app/[dealerSlug]/vehicles/new.js`\n\n**Appraisal Routes:**\n- `/appraisals/index.js` - Main appraisals list (40KB file)\n- `/appraisals/[id].js` - Individual appraisal detail\n- `/appraisals/new.js` - Create new appraisal\n- `/appraisals/px/[id].js` - PX (part-exchange) appraisal detail\n\n**API Routes (Key):**\n- `/api/forms/index.js` - Get all forms for dealer\n- `/api/forms/[id].js` - CRUD for individual forms\n- `/api/forms/submissions/[id].js` - Get/edit/delete form submissions\n- `/api/appraisals/index.js` - List appraisals\n- `/api/appraisals/[id].js` - CRUD appraisal\n- `/api/appraisals/[id]/convert.js` - Convert appraisal to stock vehicle\n- `/api/vehicles/stock.js` - Get stock vehicles for lookup\n- `/api/ai/*` - AI suggestion endpoints\n\n---\n\n### 6. KEY COMPONENTS & ARCHITECTURE\n\n**Layout Components:**\n- `DashboardLayout.js` (661 lines) - Main app layout with sidebar, header, mobile nav\n  - Loads forms for Quick Add dropdown\n  - Manages sidebar state, navigation, theme\n  - Features breadcrumb navigation and mobile-responsive design\n\n**Form Components:**\n- `SubmissionDrawer.js` - View/edit form submissions in side drawer\n- `ShareFormModal.js` - Share forms publicly or via link\n- `VehicleDrawer.js` (56KB) - Vehicle detail drawer with tabs\n- `AISuggestionsPanel.js` - AI diagnostic suggestions display\n\n**UI Components (in `/components/ui/`):**\n- `BottomSheet.js` - Mobile bottom sheet modal\n- `Portal.js` - React portal for modals\n- `PageShell.js` - Page wrapper with mobile stage selector\n- `PhotoGallery.js` - Image gallery component\n- `Card.js`, `Badge.js`, `KeyValue.js` - Basic UI elements\n\n---\n\n### 7. DATA MODELS\n\n**MongoDB Models (in `/models/`):**\n- `Vehicle.js` - Stock vehicles, appraisals, courtesy cars\n- `Appraisal.js` - Vehicle appraisals (buying/trade-in)\n- `Form.js` - Form templates\n- `FormSubmission.js` - Form submission data\n- `Contact.js` - Customer contacts\n- `Dealer.js` - Dealer account data\n- `User.js` - User accounts (with NextAuth)\n\n---\n\n### 8. CONTEXT & STATE MANAGEMENT\n\n**Contexts (in `/contexts/`):**\n- `DealerContext.js` - Provides dealer info and tenant slug across app\n- Used with TenantPage wrapper for multi-tenant support\n\n**Authentication:**\n- NextAuth.js for user authentication\n- Dealer context ensures data isolation per dealer\n\n---\n\n### 9. FORM TYPES AVAILABLE\n\nFrom `FORM_TYPE_LABELS` across the codebase:\n- **PDI** - Pre-Delivery Inspection\n- **TEST_DRIVE** - Test Drive Request\n- **WARRANTY_CLAIM** - Warranty Claim\n- **COURTESY_OUT** - Courtesy Car Out\n- **COURTESY_IN** - Courtesy Car In\n- **SERVICE_RECEIPT** - Service Receipt\n- **REVIEW_FEEDBACK** - Review & Feedback\n- **OTHER** - Other\n\n---\n\n### 10. STOCK & APPRAISAL FLOW\n\n**Stock Vehicles:**\n- Stored as Vehicle documents with `type: \"STOCK\"`\n- Statuses: `in_stock`, `in_prep`, `live`, `reserved`, `delivered`\n- Accessible via `/api/vehicles/stock.js` for dropdown lookups\n- Displayed on `/sales-prep` kanban board\n\n**Appraisal to Stock Conversion:**\n- Create appraisal with vehicle details\n- Review/approve appraisal\n- Convert to stock via `/api/appraisals/[id]/convert.js`\n- Creates new Vehicle document with initial status `in_stock`\n- Transfers all issues and documents\n\n**VRM Lookup:**\n- Forms support `vrmLookup: true` configuration\n- Enabled for specific vehicle statuses\n- Auto-populates make/model when stock vehicle matched\n- Hides make/model fields when `hiddenWhenStockSelected: true`\n\n---\n\n### 11. CLAUDE.MD INSTRUCTIONS ANALYSIS\n\nThe CLAUDE.md file specifies these Test Drive form modifications:\n\n**To implement:**\n1. **Hide make/model when VRM matched from stock** - Already implemented via `hiddenWhenStockSelected: true`\n2. **Remove License fields** - Currently included (need removal)\n3. **Remove Insurance fields** - Currently included (need removal)\n4. **Set date to today by default** - Need to add\n5. **Set time to current time by default** - Need to add\n6. **Remove mileage out/fuel level out** - Not in current template (OK)\n7. **Remove staff member fields** - Not in current template (OK)\n8. **Remove return details** - Not in current template (OK)\n\n---\n\n### FILE PATHS SUMMARY\n\n**Critical Files for Quick Add & Forms:**\n- `/c/Users/georg/dealerflow/components/DashboardLayout.js` - Quick Add dropdown\n- `/c/Users/georg/dealerflow/libs/formTemplates.js` - Form definitions (TEST_DRIVE)\n- `/c/Users/georg/dealerflow/pages/forms.js` - Forms management UI\n- `/c/Users/georg/dealerflow/pages/forms/fill/[id].js` - Form filler page\n- `/c/Users/georg/dealerflow/pages/api/forms/index.js` - Forms API\n\n**AI Implementation:**\n- `/c/Users/georg/dealerflow/libs/openai.js` - Main OpenAI helper\n- `/c/Users/georg/dealerflow/pages/api/ai/appraisal-issue-suggestions.js` - Issue analysis API\n- `/c/Users/georg/dealerflow/components/AISuggestionsPanel.js` - AI display component\n\n**Appraisals & Stock:**\n- `/c/Users/georg/dealerflow/pages/appraisals/index.js` - Appraisals list page\n- `/c/Users/georg/dealerflow/pages/api/appraisals/[id].js` - Appraisal CRUD\n- `/c/Users/georg/dealerflow/pages/api/appraisals/[id]/convert.js` - Convert to stock\n- `/c/Users/georg/dealerflow/pages/api/vehicles/stock.js` - Stock lookup API\n- `/c/Users/georg/dealerflow/pages/sales-prep.js` - Stock & Prep board\n\n**Test Drive Form:**\n- `/c/Users/georg/dealerflow/libs/formTemplates.js` (lines ~300-350) - TEST_DRIVE template definition\n- `/c/Users/georg/dealerflow/pages/forms/fill/[id].js` - Form rendering/submission"},{"type":"text","text":"agentId: abfd121 (for resuming to continue this agent's work if needed)"}]}]},"uuid":"46e849f0-d9a0-4d4e-a370-b21b7e4d1d1d","timestamp":"2025-12-30T15:45:23.643Z","toolUseResult":{"status":"completed","prompt":"Explore this codebase to understand:\n1. The overall project structure (Next.js pages, components, etc.)\n2. Where the Quick Add dropdown/menu is located (look for \"Quick Add\", \"quick-add\", dropdown in header, etc.)\n3. Where the AI/OpenAI implementation is (look for openai, ai, suggestions, etc.)\n4. Where the Test Drive form is located\n5. The current routing structure for appraisals and stock\n\nBe thorough and provide file paths for all relevant components.","agentId":"abfd121","content":[{"type":"text","text":"Perfect! Now I have all the information I need. Let me provide a comprehensive exploration report:\n\n## DealerFlow Codebase Exploration Report\n\nI've thoroughly explored the DealerFlow codebase. Here's a comprehensive breakdown:\n\n### 1. PROJECT STRUCTURE (Next.js Application)\n\n**Root directories:**\n- `/components` - React UI components\n- `/pages` - Next.js pages and API routes\n- `/libs` - Utility and library functions\n- `/lib` - Additional library code\n- `/models` - MongoDB Mongoose models\n- `/contexts` - React context providers\n- `/hooks` - Custom React hooks\n- `/docs` - Documentation\n\n**Key configuration files:**\n- `package.json` - Dependencies (React, Next.js, MongoDB, OpenAI, NextAuth, TailwindCSS, etc.)\n- `next.config.js` - Next.js configuration\n- `.env.local` - Environment variables\n\n---\n\n### 2. QUICK ADD DROPDOWN/MENU LOCATION\n\n**File:** `/c/Users/georg/dealerflow/components/DashboardLayout.js` (661 lines)\n\n**Implementation Details:**\n- **Line 487-507:** Quick Add Form Button\n- Uses DaisyUI dropdown component (`dropdown dropdown-end`)\n- Blue circular button with `+` icon (size `w-9 h-9`, color `bg-[#0066CC]`)\n- Located in the header next to the user menu\n- Fetches forms via `/api/forms` endpoint on component mount (line 143-150)\n- When clicked, triggers `handleFormClick(form)` function (lines 211-216)\n- Opens form in new tab if public, otherwise navigates to `/forms/fill/{formId}`\n\n**Form Loading:**\n```javascript\n// Line 143-150\nuseEffect(() => {\n  fetch(\"/api/forms\")\n    .then(res => res.json())\n    .then(data => {\n      if (Array.isArray(data)) setForms(data);\n    })\n    .catch(() => {});\n}, [router]);\n```\n\n---\n\n### 3. AI/OpenAI IMPLEMENTATION\n\n**OpenAI Integration Files:**\n\n1. **`/c/Users/georg/dealerflow/lib/openai.js`** (4 lines)\n   - Simple singleton client initialization\n   - Exposes `openai` client object\n\n2. **`/c/Users/georg/dealerflow/libs/openai.js`** (comprehensive, 100+ lines)\n   - Main OpenAI helper library\n   - Exports: `getOpenAIClient()`, `getAIConfig()`, `safeJsonParse()`, `callOpenAI()`\n   - Handles API key from `OPENAI_API_KEY` environment variable\n   - Includes dummy data generation for demo mode when API not configured\n   - Defines `AI_SUGGESTION_SCHEMA` with 5 categories:\n     - `suspected_issues`\n     - `checks_to_run`\n     - `questions_for_customer`\n     - `parts_to_consider`\n     - `safety_notes`\n\n3. **`/c/Users/georg/dealerflow/libs/gpt.js`** (legacy, ~50 lines)\n   - Old axios-based implementation using GPT-4\n   - Uses `sendOpenAi()` function\n\n**AI Endpoints:**\n\n1. **`/c/Users/georg/dealerflow/pages/api/ai/appraisal-issue-suggestions.js`**\n   - POST endpoint for vehicle appraisal issue analysis\n   - Takes vehicle data (make, model, year, mileage, fuel type, issue description)\n   - Returns structured JSON with diagnostic suggestions\n   - Used during appraisal process for diagnostic guidance\n\n2. **`/c/Users/georg/dealerflow/pages/api/ai/appraisal-summary.js`**\n3. **`/c/Users/georg/dealerflow/pages/api/ai/warranty-summary.js`**\n4. **`/c/Users/georg/dealerflow/pages/api/ai/warranty-suggestions.js`**\n5. **`/c/Users/georg/dealerflow/pages/api/ai/case-review.js`**\n6. **`/c/Users/georg/dealerflow/pages/api/ai/health.js`** - Health check endpoint\n\n**AI UI Component:**\n\n**`/c/Users/georg/dealerflow/components/AISuggestionsPanel.js`** (200+ lines)\n- Collapsible panel displaying AI suggestions\n- Shows: suspected issues with urgency badges, checks to run, customer questions, parts to consider, safety notes\n- \"Copy to notes\" functionality for integration with form data\n- Loading state with spinner\n- Demo badge when in dummy/offline mode\n\n---\n\n### 4. TEST DRIVE FORM LOCATION\n\n**Form Template Definition:** `/c/Users/georg/dealerflow/libs/formTemplates.js`\n\n**Test Drive Form (Lines ~300-350):**\n\n**Current fields:**\n- Test Drive Details section (order 1-2):\n  - Date of Test Drive (DATE field, required, order 1)\n  - Time (TIME field, required, order 2)\n- Customer Details section (order 5-9):\n  - First Name, Last Name, Email, Contact Number\n- Driving Licence section (order 15-16):\n  - Upload Driving Licence (Front) (FILE field)\n- Address section (order 20-24):\n  - Street Address, Line 2, City, Post Code\n- Vehicle Details section (order 30-35):\n  - Vehicle Registration (TEXT, with VRM lookup enabled)\n  - **Vehicle Make** (order 32, `hiddenWhenStockSelected: true`)\n  - **Vehicle Model** (order 33, `hiddenWhenStockSelected: true`)\n  - Source dropdown\n- Terms & Conditions (order 40-42):\n  - Agreement checkbox\n  - Signature field\n\n**Configuration:**\n- `type: \"TEST_DRIVE\"`\n- `visibility: \"PUBLIC\"` (customers can access)\n- `vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] }`\n- Public slug: `\"test-drive\"`\n- Intro text: \"Please complete this form to book a test drive. You must bring your valid driving licence on the day.\"\n\n**Note:** According to CLAUDE.md instructions, the following fields should be removed from the test drive form (but are NOT currently implemented):\n- License Number, License expiry Date, License type\n- Insurance details fields\n- Mileage Out field\n- Fuel Level Out field\n- Accompanied by staff member field\n- Staff Member Name field\n- Date field below signature box\n- Return details fields (including Damage Description and Damage Photos)\n\n---\n\n### 5. ROUTING STRUCTURE\n\n**Pages/Routes (with components):**\n\n**Dashboard & Main Pages:**\n- `/dashboard.js` - Main dashboard with Quick Forms and Quick Actions\n- `/sales-prep.js` - Stock & Prep board (kanban-style vehicle workflow)\n- `/forms.js` - Forms management and submissions page (1764 lines)\n- `/appraisals/index.js` - Appraisals and PX (part-exchange) management\n\n**Tenant-Aware Routes (with dealer slug):**\n- `/app/[dealerSlug]/appraisals.js` - Wrapper using TenantPage component\n- `/app/[dealerSlug]/forms.js`\n- `/app/[dealerSlug]/sales-prep.js`\n- `/app/[dealerSlug]/dashboard.js`\n- `/app/[dealerSlug]/vehicles/[id].js`\n- `/app/[dealerSlug]/vehicles/index.js`\n- `/app/[dealerSlug]/vehicles/new.js`\n\n**Appraisal Routes:**\n- `/appraisals/index.js` - Main appraisals list (40KB file)\n- `/appraisals/[id].js` - Individual appraisal detail\n- `/appraisals/new.js` - Create new appraisal\n- `/appraisals/px/[id].js` - PX (part-exchange) appraisal detail\n\n**API Routes (Key):**\n- `/api/forms/index.js` - Get all forms for dealer\n- `/api/forms/[id].js` - CRUD for individual forms\n- `/api/forms/submissions/[id].js` - Get/edit/delete form submissions\n- `/api/appraisals/index.js` - List appraisals\n- `/api/appraisals/[id].js` - CRUD appraisal\n- `/api/appraisals/[id]/convert.js` - Convert appraisal to stock vehicle\n- `/api/vehicles/stock.js` - Get stock vehicles for lookup\n- `/api/ai/*` - AI suggestion endpoints\n\n---\n\n### 6. KEY COMPONENTS & ARCHITECTURE\n\n**Layout Components:**\n- `DashboardLayout.js` (661 lines) - Main app layout with sidebar, header, mobile nav\n  - Loads forms for Quick Add dropdown\n  - Manages sidebar state, navigation, theme\n  - Features breadcrumb navigation and mobile-responsive design\n\n**Form Components:**\n- `SubmissionDrawer.js` - View/edit form submissions in side drawer\n- `ShareFormModal.js` - Share forms publicly or via link\n- `VehicleDrawer.js` (56KB) - Vehicle detail drawer with tabs\n- `AISuggestionsPanel.js` - AI diagnostic suggestions display\n\n**UI Components (in `/components/ui/`):**\n- `BottomSheet.js` - Mobile bottom sheet modal\n- `Portal.js` - React portal for modals\n- `PageShell.js` - Page wrapper with mobile stage selector\n- `PhotoGallery.js` - Image gallery component\n- `Card.js`, `Badge.js`, `KeyValue.js` - Basic UI elements\n\n---\n\n### 7. DATA MODELS\n\n**MongoDB Models (in `/models/`):**\n- `Vehicle.js` - Stock vehicles, appraisals, courtesy cars\n- `Appraisal.js` - Vehicle appraisals (buying/trade-in)\n- `Form.js` - Form templates\n- `FormSubmission.js` - Form submission data\n- `Contact.js` - Customer contacts\n- `Dealer.js` - Dealer account data\n- `User.js` - User accounts (with NextAuth)\n\n---\n\n### 8. CONTEXT & STATE MANAGEMENT\n\n**Contexts (in `/contexts/`):**\n- `DealerContext.js` - Provides dealer info and tenant slug across app\n- Used with TenantPage wrapper for multi-tenant support\n\n**Authentication:**\n- NextAuth.js for user authentication\n- Dealer context ensures data isolation per dealer\n\n---\n\n### 9. FORM TYPES AVAILABLE\n\nFrom `FORM_TYPE_LABELS` across the codebase:\n- **PDI** - Pre-Delivery Inspection\n- **TEST_DRIVE** - Test Drive Request\n- **WARRANTY_CLAIM** - Warranty Claim\n- **COURTESY_OUT** - Courtesy Car Out\n- **COURTESY_IN** - Courtesy Car In\n- **SERVICE_RECEIPT** - Service Receipt\n- **REVIEW_FEEDBACK** - Review & Feedback\n- **OTHER** - Other\n\n---\n\n### 10. STOCK & APPRAISAL FLOW\n\n**Stock Vehicles:**\n- Stored as Vehicle documents with `type: \"STOCK\"`\n- Statuses: `in_stock`, `in_prep`, `live`, `reserved`, `delivered`\n- Accessible via `/api/vehicles/stock.js` for dropdown lookups\n- Displayed on `/sales-prep` kanban board\n\n**Appraisal to Stock Conversion:**\n- Create appraisal with vehicle details\n- Review/approve appraisal\n- Convert to stock via `/api/appraisals/[id]/convert.js`\n- Creates new Vehicle document with initial status `in_stock`\n- Transfers all issues and documents\n\n**VRM Lookup:**\n- Forms support `vrmLookup: true` configuration\n- Enabled for specific vehicle statuses\n- Auto-populates make/model when stock vehicle matched\n- Hides make/model fields when `hiddenWhenStockSelected: true`\n\n---\n\n### 11. CLAUDE.MD INSTRUCTIONS ANALYSIS\n\nThe CLAUDE.md file specifies these Test Drive form modifications:\n\n**To implement:**\n1. **Hide make/model when VRM matched from stock** - Already implemented via `hiddenWhenStockSelected: true`\n2. **Remove License fields** - Currently included (need removal)\n3. **Remove Insurance fields** - Currently included (need removal)\n4. **Set date to today by default** - Need to add\n5. **Set time to current time by default** - Need to add\n6. **Remove mileage out/fuel level out** - Not in current template (OK)\n7. **Remove staff member fields** - Not in current template (OK)\n8. **Remove return details** - Not in current template (OK)\n\n---\n\n### FILE PATHS SUMMARY\n\n**Critical Files for Quick Add & Forms:**\n- `/c/Users/georg/dealerflow/components/DashboardLayout.js` - Quick Add dropdown\n- `/c/Users/georg/dealerflow/libs/formTemplates.js` - Form definitions (TEST_DRIVE)\n- `/c/Users/georg/dealerflow/pages/forms.js` - Forms management UI\n- `/c/Users/georg/dealerflow/pages/forms/fill/[id].js` - Form filler page\n- `/c/Users/georg/dealerflow/pages/api/forms/index.js` - Forms API\n\n**AI Implementation:**\n- `/c/Users/georg/dealerflow/libs/openai.js` - Main OpenAI helper\n- `/c/Users/georg/dealerflow/pages/api/ai/appraisal-issue-suggestions.js` - Issue analysis API\n- `/c/Users/georg/dealerflow/components/AISuggestionsPanel.js` - AI display component\n\n**Appraisals & Stock:**\n- `/c/Users/georg/dealerflow/pages/appraisals/index.js` - Appraisals list page\n- `/c/Users/georg/dealerflow/pages/api/appraisals/[id].js` - Appraisal CRUD\n- `/c/Users/georg/dealerflow/pages/api/appraisals/[id]/convert.js` - Convert to stock\n- `/c/Users/georg/dealerflow/pages/api/vehicles/stock.js` - Stock lookup API\n- `/c/Users/georg/dealerflow/pages/sales-prep.js` - Stock & Prep board\n\n**Test Drive Form:**\n- `/c/Users/georg/dealerflow/libs/formTemplates.js` (lines ~300-350) - TEST_DRIVE template definition\n- `/c/Users/georg/dealerflow/pages/forms/fill/[id].js` - Form rendering/submission"}],"totalDurationMs":230214,"totalTokens":74939,"totalToolUseCount":55,"usage":{"input_tokens":7,"cache_creation_input_tokens":1361,"cache_read_input_tokens":69963,"cache_creation":{"ephemeral_5m_input_tokens":1361,"ephemeral_1h_input_tokens":0},"output_tokens":3608,"service_tier":"standard"}}}
{"parentUuid":"46e849f0-d9a0-4d4e-a370-b21b7e4d1d1d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LvYF75XXkWQ2G99NBKVW6j","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Excellent! I have a comprehensive overview of the codebase. Now let me start working on the tasks. Let me first read the key files to understand the current implementation and then make the necessary changes.\n\nLet me start with:\n1. Quick Add dropdown in DashboardLayout.js - to fix z-index and add new items\n2. AI implementation - to understand the current setup and fix issues\n3. Test Drive form in formTemplates.js\n\nLet me read these files.","signature":"EtwECkYICxgCKkBsGIUEtvhy54YAzJhVrBYoabd1X6q9xSPfzMKYLXgaiyiRIdXkbL+ihF9bxcVp4ALgpHEFDfLR8zybFUvnfHi+EgyXOoKlloQzHSslluEaDItmgTw+5UyUBIiLrCIwmWKz4ddUBQat5RMJ5Oub47eJI7KN/J0OevMJxSkhE49nplajtlHXvdwlae0tmgciKsMD+ciDXe5Wba+zKn7DakPUqkVGRKysWZBB/kk905jd/lLwvnrI76pNtk1Fft1ff9+LzWbXCquTZigCbkTLsbhabgLOdeX1IZA27E/Hvb5ujSPL+g4fEAKru5vYJ8J0hKTGWUB74BZ8h7G7BD3OEzsuBSBAq7mtCs7hRBnb4PferaExl9HkJs2SZztE8korNXovxfQt+i7g9NedeKsxtt5rl0DftgAv7RC238TjMYUBKEEX701R2ccw9HwO/bKBGJw50Rh4aUE8MIIa/NENhR8iKcLXbte4QUiORtIbDw19faXaCJkV5w8ICUFAQ2yqd09f6Mqe0ylh5Z7bZBitpGoJv311gJsmWAD+uSLAHOIZe6KAfIfrndtZRU5EHUQ/hLgB75AYqZBD/9YnQgArIC/afiklkN2zQIGUFErCjg0Yb4T+38YGI5JKiLcaX2fYSjR8Im568NqtD+XC1VFawua/WkSc+0uJ9osAPvrC/UaU1CvQCWRL1Mf0r15s6hdWzqCE+C5umjpQVv4BM19ir69twHWHwdqO0MdAU85NoVRnlx/Eya6SzGtRRcjB2DVXLdTrufFIGaGo60EL1P5LJMslYWGECBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3880,"cache_read_input_tokens":21262,"cache_creation":{"ephemeral_5m_input_tokens":3880,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWd8XgHaE1T8rS7FGPVHH","type":"assistant","uuid":"9e6093d9-f92c-4cd9-99b8-25a6a97a524b","timestamp":"2025-12-30T15:45:30.017Z"}
{"parentUuid":"9e6093d9-f92c-4cd9-99b8-25a6a97a524b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LvYF75XXkWQ2G99NBKVW6j","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a good understanding of the codebase. Let me read the key files to start implementing the fixes."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3880,"cache_read_input_tokens":21262,"cache_creation":{"ephemeral_5m_input_tokens":3880,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWd8XgHaE1T8rS7FGPVHH","type":"assistant","uuid":"0071ffd2-b5f9-451f-a456-6e47c9a3e7b1","timestamp":"2025-12-30T15:45:30.546Z"}
{"parentUuid":"0071ffd2-b5f9-451f-a456-6e47c9a3e7b1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LvYF75XXkWQ2G99NBKVW6j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0157L2ynqfdqsr9RwpcvZfGK","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\components\\DashboardLayout.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3880,"cache_read_input_tokens":21262,"cache_creation":{"ephemeral_5m_input_tokens":3880,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWd8XgHaE1T8rS7FGPVHH","type":"assistant","uuid":"48a7568b-108e-4de7-b332-b3cc1511be47","timestamp":"2025-12-30T15:45:31.511Z"}
{"parentUuid":"48a7568b-108e-4de7-b332-b3cc1511be47","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LvYF75XXkWQ2G99NBKVW6j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RnetiVgYfCZAFZbS6PMudo","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\libs\\openai.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3880,"cache_read_input_tokens":21262,"cache_creation":{"ephemeral_5m_input_tokens":3880,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWd8XgHaE1T8rS7FGPVHH","type":"assistant","uuid":"f3d975e5-81a8-4853-be38-2a10ab14ae46","timestamp":"2025-12-30T15:45:31.975Z"}
{"parentUuid":"f3d975e5-81a8-4853-be38-2a10ab14ae46","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LvYF75XXkWQ2G99NBKVW6j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01ETg4A9QUUGirinmvo2RpGA","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\health.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":3880,"cache_read_input_tokens":21262,"cache_creation":{"ephemeral_5m_input_tokens":3880,"ephemeral_1h_input_tokens":0},"output_tokens":312,"service_tier":"standard"}},"requestId":"req_011CWd8XgHaE1T8rS7FGPVHH","type":"assistant","uuid":"b51e0f2b-5fbb-4ac3-b30d-ab78fa134070","timestamp":"2025-12-30T15:45:32.787Z"}
{"parentUuid":"b51e0f2b-5fbb-4ac3-b30d-ab78fa134070","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RnetiVgYfCZAFZbS6PMudo","type":"tool_result","content":"     1→/**\n     2→ * OpenAI Client Helper\n     3→ *\n     4→ * Server-side only helper for OpenAI API access.\n     5→ * Provides a singleton client and helper functions.\n     6→ */\n     7→\n     8→import OpenAI from \"openai\";\n     9→\n    10→// Singleton client - created once and reused\n    11→let _client = null;\n    12→\n    13→/**\n    14→ * Get or create the OpenAI client singleton\n    15→ * Always call this function - don't use a top-level export\n    16→ * because env vars may not be available at module load time.\n    17→ * @returns {OpenAI | null}\n    18→ */\n    19→export function getOpenAIClient() {\n    20→  const apiKey = process.env.OPENAI_API_KEY;\n    21→  if (!apiKey) {\n    22→    console.warn(\"[OpenAI] OPENAI_API_KEY not set - AI features disabled\");\n    23→    return null;\n    24→  }\n    25→  if (!_client) {\n    26→    _client = new OpenAI({\n    27→      apiKey: apiKey,\n    28→    });\n    29→  }\n    30→  return _client;\n    31→}\n    32→\n    33→/**\n    34→ * Get the OpenAI API key from environment\n    35→ * @returns {{ apiKey: string | null, isConfigured: boolean }}\n    36→ */\n    37→export function getAIConfig() {\n    38→  const apiKey = process.env.OPENAI_API_KEY;\n    39→  return {\n    40→    apiKey,\n    41→    isConfigured: !!apiKey,\n    42→  };\n    43→}\n    44→\n    45→/**\n    46→ * Safely parse JSON from AI response\n    47→ * Strips code fences if present and throws clear error if parsing fails\n    48→ * @param {string} text - Raw text from AI\n    49→ * @returns {object} Parsed JSON object\n    50→ * @throws {Error} If parsing fails\n    51→ */\n    52→export function safeJsonParse(text) {\n    53→  if (!text) {\n    54→    throw new Error(\"Empty AI response - cannot parse JSON\");\n    55→  }\n    56→\n    57→  // Strip markdown code fences if present\n    58→  const cleaned = text\n    59→    .replace(/```json\\s*/gi, \"\")\n    60→    .replace(/```\\s*/g, \"\")\n    61→    .trim();\n    62→\n    63→  try {\n    64→    return JSON.parse(cleaned);\n    65→  } catch (e) {\n    66→    throw new Error(`Failed to parse AI JSON response: ${e.message}. Raw text: ${cleaned.slice(0, 200)}...`);\n    67→  }\n    68→}\n    69→\n    70→/**\n    71→ * Standard AI suggestion response schema\n    72→ */\n    73→export const AI_SUGGESTION_SCHEMA = {\n    74→  suspected_issues: [{ title: \"\", why: \"\", urgency: \"low|med|high\" }],\n    75→  checks_to_run: [{ step: \"\", tools: \"\", time_estimate_mins: 0 }],\n    76→  questions_for_customer: [{ question: \"\", why: \"\" }],\n    77→  parts_to_consider: [{ part: \"\", notes: \"\" }],\n    78→  safety_notes: [{ note: \"\" }],\n    79→};\n    80→\n    81→/**\n    82→ * Call OpenAI API with structured JSON output\n    83→ * @param {string} systemPrompt - System message for context\n    84→ * @param {string} userPrompt - User message with the request\n    85→ * @param {object} options - Additional options\n    86→ * @returns {Promise<object>} Parsed JSON response\n    87→ */\n    88→export async function callOpenAI(systemPrompt, userPrompt, options = {}) {\n    89→  const { isConfigured } = getAIConfig();\n    90→\n    91→  if (!isConfigured) {\n    92→    return {\n    93→      success: false,\n    94→      error: \"OpenAI not configured. Please set OPENAI_API_KEY in .env.local and restart the server.\",\n    95→      errorCode: \"NOT_CONFIGURED\",\n    96→      isDummy: true,\n    97→      data: generateDummySuggestions(),\n    98→    };\n    99→  }\n   100→\n   101→  const client = getOpenAIClient();\n   102→  if (!client) {\n   103→    return {\n   104→      success: false,\n   105→      error: \"OpenAI client not available\",\n   106→      errorCode: \"CLIENT_ERROR\",\n   107→      isDummy: true,\n   108→      data: generateDummySuggestions(),\n   109→    };\n   110→  }\n   111→\n   112→  try {\n   113→    const response = await client.chat.completions.create({\n   114→      model: options.model || \"gpt-4o-mini\",\n   115→      messages: [\n   116→        { role: \"system\", content: systemPrompt },\n   117→        { role: \"user\", content: userPrompt },\n   118→      ],\n   119→      temperature: options.temperature || 0.3,\n   120→      max_tokens: options.maxTokens || 1500,\n   121→      response_format: { type: \"json_object\" },\n   122→    });\n   123→\n   124→    const content = response.choices?.[0]?.message?.content;\n   125→\n   126→    if (!content) {\n   127→      return {\n   128→        success: false,\n   129→        error: \"Empty AI response\",\n   130→        errorCode: \"EMPTY_RESPONSE\",\n   131→        isDummy: true,\n   132→        data: generateDummySuggestions(),\n   133→      };\n   134→    }\n   135→\n   136→    // Parse JSON response\n   137→    const parsed = safeJsonParse(content);\n   138→    return {\n   139→      success: true,\n   140→      isDummy: false,\n   141→      data: parsed,\n   142→    };\n   143→  } catch (error) {\n   144→    console.error(\"[OpenAI] Error:\", error.message);\n   145→\n   146→    if (error.status === 401) {\n   147→      return {\n   148→        success: false,\n   149→        error: \"OpenAI authentication failed. Check your API key.\",\n   150→        errorCode: \"AUTH_FAILED\",\n   151→        isDummy: true,\n   152→        data: generateDummySuggestions(),\n   153→      };\n   154→    }\n   155→\n   156→    return {\n   157→      success: false,\n   158→      error: \"OpenAI service unavailable\",\n   159→      errorCode: \"SERVICE_ERROR\",\n   160→      isDummy: true,\n   161→      data: generateDummySuggestions(),\n   162→    };\n   163→  }\n   164→}\n   165→\n   166→/**\n   167→ * Generate dummy suggestions when AI is not available\n   168→ */\n   169→function generateDummySuggestions() {\n   170→  return {\n   171→    suspected_issues: [\n   172→      {\n   173→        title: \"Unable to generate AI suggestions\",\n   174→        why: \"OpenAI service is not configured or unavailable. Please set OPENAI_API_KEY.\",\n   175→        urgency: \"low\",\n   176→      },\n   177→    ],\n   178→    checks_to_run: [],\n   179→    questions_for_customer: [],\n   180→    parts_to_consider: [],\n   181→    safety_notes: [],\n   182→  };\n   183→}\n   184→\n   185→/**\n   186→ * UK used car dealer context for AI prompts\n   187→ */\n   188→export const UK_DEALER_CONTEXT = `You are an expert automotive diagnostic assistant for a UK used car dealership.\n   189→Your role is to help service advisors and technicians diagnose vehicle issues.\n   190→\n   191→Important constraints:\n   192→- UK context: Use British terminology (bonnet not hood, boot not trunk, etc.)\n   193→- Used car dealer context: Practical, cost-effective advice\n   194→- Practical tone: Clear, actionable guidance\n   195→- DO NOT invent facts or make assumptions without evidence\n   196→- If information is insufficient, ask questions rather than guess\n   197→- Focus on common issues and realistic scenarios\n   198→- Always consider customer safety`;\n   199→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"dcdb5e23-7dd1-40b6-a8c6-8ef87b2189dc","timestamp":"2025-12-30T15:45:38.001Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\libs\\openai.js","content":"/**\n * OpenAI Client Helper\n *\n * Server-side only helper for OpenAI API access.\n * Provides a singleton client and helper functions.\n */\n\nimport OpenAI from \"openai\";\n\n// Singleton client - created once and reused\nlet _client = null;\n\n/**\n * Get or create the OpenAI client singleton\n * Always call this function - don't use a top-level export\n * because env vars may not be available at module load time.\n * @returns {OpenAI | null}\n */\nexport function getOpenAIClient() {\n  const apiKey = process.env.OPENAI_API_KEY;\n  if (!apiKey) {\n    console.warn(\"[OpenAI] OPENAI_API_KEY not set - AI features disabled\");\n    return null;\n  }\n  if (!_client) {\n    _client = new OpenAI({\n      apiKey: apiKey,\n    });\n  }\n  return _client;\n}\n\n/**\n * Get the OpenAI API key from environment\n * @returns {{ apiKey: string | null, isConfigured: boolean }}\n */\nexport function getAIConfig() {\n  const apiKey = process.env.OPENAI_API_KEY;\n  return {\n    apiKey,\n    isConfigured: !!apiKey,\n  };\n}\n\n/**\n * Safely parse JSON from AI response\n * Strips code fences if present and throws clear error if parsing fails\n * @param {string} text - Raw text from AI\n * @returns {object} Parsed JSON object\n * @throws {Error} If parsing fails\n */\nexport function safeJsonParse(text) {\n  if (!text) {\n    throw new Error(\"Empty AI response - cannot parse JSON\");\n  }\n\n  // Strip markdown code fences if present\n  const cleaned = text\n    .replace(/```json\\s*/gi, \"\")\n    .replace(/```\\s*/g, \"\")\n    .trim();\n\n  try {\n    return JSON.parse(cleaned);\n  } catch (e) {\n    throw new Error(`Failed to parse AI JSON response: ${e.message}. Raw text: ${cleaned.slice(0, 200)}...`);\n  }\n}\n\n/**\n * Standard AI suggestion response schema\n */\nexport const AI_SUGGESTION_SCHEMA = {\n  suspected_issues: [{ title: \"\", why: \"\", urgency: \"low|med|high\" }],\n  checks_to_run: [{ step: \"\", tools: \"\", time_estimate_mins: 0 }],\n  questions_for_customer: [{ question: \"\", why: \"\" }],\n  parts_to_consider: [{ part: \"\", notes: \"\" }],\n  safety_notes: [{ note: \"\" }],\n};\n\n/**\n * Call OpenAI API with structured JSON output\n * @param {string} systemPrompt - System message for context\n * @param {string} userPrompt - User message with the request\n * @param {object} options - Additional options\n * @returns {Promise<object>} Parsed JSON response\n */\nexport async function callOpenAI(systemPrompt, userPrompt, options = {}) {\n  const { isConfigured } = getAIConfig();\n\n  if (!isConfigured) {\n    return {\n      success: false,\n      error: \"OpenAI not configured. Please set OPENAI_API_KEY in .env.local and restart the server.\",\n      errorCode: \"NOT_CONFIGURED\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n\n  const client = getOpenAIClient();\n  if (!client) {\n    return {\n      success: false,\n      error: \"OpenAI client not available\",\n      errorCode: \"CLIENT_ERROR\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n\n  try {\n    const response = await client.chat.completions.create({\n      model: options.model || \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: options.temperature || 0.3,\n      max_tokens: options.maxTokens || 1500,\n      response_format: { type: \"json_object\" },\n    });\n\n    const content = response.choices?.[0]?.message?.content;\n\n    if (!content) {\n      return {\n        success: false,\n        error: \"Empty AI response\",\n        errorCode: \"EMPTY_RESPONSE\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    // Parse JSON response\n    const parsed = safeJsonParse(content);\n    return {\n      success: true,\n      isDummy: false,\n      data: parsed,\n    };\n  } catch (error) {\n    console.error(\"[OpenAI] Error:\", error.message);\n\n    if (error.status === 401) {\n      return {\n        success: false,\n        error: \"OpenAI authentication failed. Check your API key.\",\n        errorCode: \"AUTH_FAILED\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    return {\n      success: false,\n      error: \"OpenAI service unavailable\",\n      errorCode: \"SERVICE_ERROR\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n}\n\n/**\n * Generate dummy suggestions when AI is not available\n */\nfunction generateDummySuggestions() {\n  return {\n    suspected_issues: [\n      {\n        title: \"Unable to generate AI suggestions\",\n        why: \"OpenAI service is not configured or unavailable. Please set OPENAI_API_KEY.\",\n        urgency: \"low\",\n      },\n    ],\n    checks_to_run: [],\n    questions_for_customer: [],\n    parts_to_consider: [],\n    safety_notes: [],\n  };\n}\n\n/**\n * UK used car dealer context for AI prompts\n */\nexport const UK_DEALER_CONTEXT = `You are an expert automotive diagnostic assistant for a UK used car dealership.\nYour role is to help service advisors and technicians diagnose vehicle issues.\n\nImportant constraints:\n- UK context: Use British terminology (bonnet not hood, boot not trunk, etc.)\n- Used car dealer context: Practical, cost-effective advice\n- Practical tone: Clear, actionable guidance\n- DO NOT invent facts or make assumptions without evidence\n- If information is insufficient, ask questions rather than guess\n- Focus on common issues and realistic scenarios\n- Always consider customer safety`;\n","numLines":199,"startLine":1,"totalLines":199}}}
{"parentUuid":"dcdb5e23-7dd1-40b6-a8c6-8ef87b2189dc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01ETg4A9QUUGirinmvo2RpGA","type":"tool_result","content":"     1→/**\n     2→ * AI Health Check Endpoint\n     3→ *\n     4→ * GET /api/ai/health\n     5→ *\n     6→ * Returns the status of the OpenAI configuration.\n     7→ * Used for diagnostics and debugging.\n     8→ *\n     9→ * Response:\n    10→ * - ok: boolean - whether AI is configured and ready\n    11→ * - provider: \"openai\" - the AI provider (always OpenAI)\n    12→ * - model: string - the default model used\n    13→ * - hasOpenAIKey: boolean - whether the key is present\n    14→ * - keyPrefix: string - first 7 chars of the key for verification\n    15→ * - message: string - human-readable status message\n    16→ * - error: string - error code if not ok\n    17→ */\n    18→\n    19→export default function handler(req, res) {\n    20→  if (req.method !== \"GET\") {\n    21→    return res.status(405).json({ error: \"Method not allowed\" });\n    22→  }\n    23→\n    24→  const apiKey = process.env.OPENAI_API_KEY;\n    25→  const model = process.env.AI_MODEL || \"gpt-4o-mini\";\n    26→\n    27→  if (!apiKey) {\n    28→    return res.status(200).json({\n    29→      ok: false,\n    30→      provider: \"openai\",\n    31→      model: model,\n    32→      hasOpenAIKey: false,\n    33→      keyPrefix: null,\n    34→      error: \"missing OPENAI_API_KEY\",\n    35→      message: \"OpenAI is not configured. Set OPENAI_API_KEY in .env.local and restart the server.\",\n    36→    });\n    37→  }\n    38→\n    39→  // Check key format (should start with sk-)\n    40→  if (!apiKey.startsWith(\"sk-\")) {\n    41→    return res.status(200).json({\n    42→      ok: false,\n    43→      provider: \"openai\",\n    44→      model: model,\n    45→      hasOpenAIKey: true,\n    46→      keyPrefix: apiKey.slice(0, 7) + \"...\",\n    47→      error: \"invalid OPENAI_API_KEY format\",\n    48→      message: \"OPENAI_API_KEY should start with 'sk-'. Check your .env.local file.\",\n    49→    });\n    50→  }\n    51→\n    52→  return res.status(200).json({\n    53→    ok: true,\n    54→    provider: \"openai\",\n    55→    model: model,\n    56→    hasOpenAIKey: true,\n    57→    keyPrefix: apiKey.slice(0, 7) + \"...\",\n    58→    message: \"OpenAI is configured and ready\",\n    59→  });\n    60→}\n    61→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"6ad226ba-d3a8-4e80-99dd-5a39ff6098d9","timestamp":"2025-12-30T15:45:38.002Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\health.js","content":"/**\n * AI Health Check Endpoint\n *\n * GET /api/ai/health\n *\n * Returns the status of the OpenAI configuration.\n * Used for diagnostics and debugging.\n *\n * Response:\n * - ok: boolean - whether AI is configured and ready\n * - provider: \"openai\" - the AI provider (always OpenAI)\n * - model: string - the default model used\n * - hasOpenAIKey: boolean - whether the key is present\n * - keyPrefix: string - first 7 chars of the key for verification\n * - message: string - human-readable status message\n * - error: string - error code if not ok\n */\n\nexport default function handler(req, res) {\n  if (req.method !== \"GET\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const apiKey = process.env.OPENAI_API_KEY;\n  const model = process.env.AI_MODEL || \"gpt-4o-mini\";\n\n  if (!apiKey) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasOpenAIKey: false,\n      keyPrefix: null,\n      error: \"missing OPENAI_API_KEY\",\n      message: \"OpenAI is not configured. Set OPENAI_API_KEY in .env.local and restart the server.\",\n    });\n  }\n\n  // Check key format (should start with sk-)\n  if (!apiKey.startsWith(\"sk-\")) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasOpenAIKey: true,\n      keyPrefix: apiKey.slice(0, 7) + \"...\",\n      error: \"invalid OPENAI_API_KEY format\",\n      message: \"OPENAI_API_KEY should start with 'sk-'. Check your .env.local file.\",\n    });\n  }\n\n  return res.status(200).json({\n    ok: true,\n    provider: \"openai\",\n    model: model,\n    hasOpenAIKey: true,\n    keyPrefix: apiKey.slice(0, 7) + \"...\",\n    message: \"OpenAI is configured and ready\",\n  });\n}\n","numLines":61,"startLine":1,"totalLines":61}}}
{"parentUuid":"6ad226ba-d3a8-4e80-99dd-5a39ff6098d9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0157L2ynqfdqsr9RwpcvZfGK","type":"tool_result","content":"     1→import { useState, useEffect } from \"react\";\n     2→import Link from \"next/link\";\n     3→import { useRouter } from \"next/router\";\n     4→import { signOut } from \"next-auth/react\";\n     5→import { useDealer } from \"@/contexts/DealerContext\";\n     6→import { appPath } from \"@/libs/appPath\";\n     7→\n     8→// Human-readable form type labels\n     9→const FORM_TYPE_LABELS = {\n    10→  PDI: \"PDI\",\n    11→  TEST_DRIVE: \"Test Drive\",\n    12→  WARRANTY_CLAIM: \"Warranty\",\n    13→  COURTESY_OUT: \"Courtesy Out\",\n    14→  COURTESY_IN: \"Courtesy In\",\n    15→  SERVICE_RECEIPT: \"Service\",\n    16→  REVIEW_FEEDBACK: \"Feedback\",\n    17→  OTHER: \"Other\",\n    18→};\n    19→\n    20→// Icon components (using inline SVG as heroicons alternative)\n    21→const ChartBarIcon = ({ className }) => (\n    22→  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    23→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z\" />\n    24→  </svg>\n    25→);\n    26→\n    27→const TruckIcon = ({ className }) => (\n    28→  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    29→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12\" />\n    30→  </svg>\n    31→);\n    32→\n    33→const WrenchIcon = ({ className }) => (\n    34→  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    35→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z\" />\n    36→  </svg>\n    37→);\n    38→\n    39→const ClipboardIcon = ({ className }) => (\n    40→  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    41→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z\" />\n    42→  </svg>\n    43→);\n    44→\n    45→const DocumentTextIcon = ({ className }) => (\n    46→  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    47→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\" />\n    48→  </svg>\n    49→);\n    50→\n    51→const StarIcon = ({ className }) => (\n    52→  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    53→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z\" />\n    54→  </svg>\n    55→);\n    56→\n    57→const CalendarIcon = ({ className }) => (\n    58→  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    59→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5\" />\n    60→  </svg>\n    61→);\n    62→\n    63→const CogIcon = ({ className }) => (\n    64→  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    65→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z\" />\n    66→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n    67→  </svg>\n    68→);\n    69→\n    70→const ChevronDownIcon = ({ className }) => (\n    71→  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    72→    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M19.5 8.25l-7.5 7.5-7.5-7.5\" />\n    73→  </svg>\n    74→);\n    75→\n    76→const navigation = [\n    77→  { name: \"Dashboard\", href: \"/dashboard\", Icon: ChartBarIcon },\n    78→  { name: \"Stock & Prep\", href: \"/sales-prep\", Icon: TruckIcon },\n    79→  { name: \"Aftersales/Warranty\", href: \"/warranty\", Icon: WrenchIcon },\n    80→  { name: \"Appraisals\", href: \"/appraisals\", Icon: ClipboardIcon },\n    81→  { name: \"Submissions\", href: \"/forms\", Icon: DocumentTextIcon },\n    82→  { name: \"Reviews\", href: \"/reviews\", Icon: StarIcon },\n    83→  { name: \"Calendar\", href: \"/calendar\", Icon: CalendarIcon },\n    84→  { name: \"Settings\", href: \"/settings\", Icon: CogIcon },\n    85→];\n    86→\n    87→export default function DashboardLayout({ children }) {\n    88→  const router = useRouter();\n    89→  const { dealerSlug } = useDealer(); // Get dealer slug from tenant context (null if legacy route)\n    90→  const getPath = (path) => appPath(dealerSlug, path); // Helper to generate tenant-aware paths\n    91→  const [sidebarOpen, setSidebarOpen] = useState(false);\n    92→  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);\n    93→  const [expandedMenus, setExpandedMenus] = useState({});\n    94→  const [forms, setForms] = useState([]);\n    95→  const [dealer, setDealer] = useState(null);\n    96→  const [debugContext, setDebugContext] = useState(null);\n    97→  const [debugPanelOpen, setDebugPanelOpen] = useState(false);\n    98→\n    99→  // Load sidebar collapsed state from localStorage\n   100→  useEffect(() => {\n   101→    const saved = localStorage.getItem(\"sidebarCollapsed\");\n   102→    if (saved !== null) {\n   103→      setSidebarCollapsed(JSON.parse(saved));\n   104→    }\n   105→  }, []);\n   106→\n   107→  // Save sidebar collapsed state to localStorage\n   108→  const toggleSidebarCollapsed = () => {\n   109→    const newState = !sidebarCollapsed;\n   110→    setSidebarCollapsed(newState);\n   111→    localStorage.setItem(\"sidebarCollapsed\", JSON.stringify(newState));\n   112→  };\n   113→\n   114→  // Keyboard shortcut: [ or Ctrl+B to toggle sidebar\n   115→  useEffect(() => {\n   116→    const handleKeyDown = (e) => {\n   117→      if (e.key === \"[\" || (e.ctrlKey && e.key === \"b\")) {\n   118→        e.preventDefault();\n   119→        toggleSidebarCollapsed();\n   120→      }\n   121→    };\n   122→    window.addEventListener(\"keydown\", handleKeyDown);\n   123→    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n   124→  }, [sidebarCollapsed]);\n   125→\n   126→  // Dev-only: fetch debug context\n   127→  useEffect(() => {\n   128→    if (process.env.NODE_ENV === \"development\") {\n   129→      fetch(\"/api/debug/context\")\n   130→        .then(res => {\n   131→          const contentType = res.headers.get(\"content-type\") || \"\";\n   132→          if (!contentType.includes(\"application/json\")) return null;\n   133→          return res.json();\n   134→        })\n   135→        .then(data => {\n   136→          if (data) setDebugContext(data);\n   137→        })\n   138→        .catch(() => {});\n   139→    }\n   140→  }, []);\n   141→\n   142→  useEffect(() => {\n   143→    // Load forms for the quick add dropdown\n   144→    fetch(\"/api/forms\")\n   145→      .then(res => res.json())\n   146→      .then(data => {\n   147→        if (Array.isArray(data)) setForms(data);\n   148→      })\n   149→      .catch(() => {});\n   150→\n   151→    // Load dealer for logo and check onboarding status\n   152→    fetch(\"/api/dealer\")\n   153→      .then(async (res) => {\n   154→        // 403 = no dealer membership - redirect to create dealer\n   155→        if (res.status === 403 && !router.pathname.startsWith(\"/onboarding\")) {\n   156→          router.push(getPath(\"/onboarding/create-dealer\"));\n   157→          return null;\n   158→        }\n   159→        if (!res.ok) return null;\n   160→        return res.json();\n   161→      })\n   162→      .then(data => {\n   163→        if (!data) return;\n   164→        setDealer(data);\n   165→        // Redirect to onboarding wizard if not completed (skip if already on onboarding page)\n   166→        if (data && !data.completedOnboarding && !router.pathname.startsWith(\"/onboarding\")) {\n   167→          router.push(getPath(\"/onboarding\"));\n   168→        }\n   169→      })\n   170→      .catch(() => {});\n   171→  }, [router]);\n   172→\n   173→  const handleFormClick = (form) => {\n   174→    if (form.isPublic && form.publicSlug) {\n   175→      window.open(`/public/forms/${form.publicSlug}`, '_blank');\n   176→    } else {\n   177→      router.push(`/forms/fill/${form.id || form._id}`);\n   178→    }\n   179→  };\n   180→\n   181→  return (\n   182→    <div className=\"min-h-screen bg-[#f8fafc]\">\n   183→      {sidebarOpen && (\n   184→        <div className=\"fixed inset-0 bg-black/50 z-40 lg:hidden\" onClick={() => setSidebarOpen(false)} />\n   185→      )}\n   186→\n   187→      {/* Sidebar - Modern design with brand colors */}\n   188→      <aside className={`fixed top-0 left-0 z-50 h-full bg-white border-r border-slate-100 shadow-sm transform transition-all duration-300 ease-in-out lg:translate-x-0 flex flex-col ${sidebarOpen ? \"translate-x-0\" : \"-translate-x-full\"} ${sidebarCollapsed ? \"lg:w-16\" : \"lg:w-64\"} w-64`}>\n   189→        {/* Mobile close button */}\n   190→        <div className=\"flex items-center justify-end h-12 px-4 lg:hidden\">\n   191→          <button className=\"text-base-content/50 hover:text-base-content hover:bg-base-200 rounded-lg p-2 transition-colors\" onClick={() => setSidebarOpen(false)}>\n   192→            <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth={2}>\n   193→              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n   194→            </svg>\n   195→          </button>\n   196→        </div>\n   197→\n   198→        {/* Logo Area - Dealer's Logo takes prominence */}\n   199→        <div className={`flex flex-col items-center transition-all duration-300 ${sidebarCollapsed ? \"p-3\" : \"p-6\"}`}>\n   200→          <Link href={getPath(\"/dashboard\")} className=\"block\">\n   201→            {dealer?.logoUrl ? (\n   202→              <img\n   203→                src={dealer.logoUrl}\n   204→                alt={dealer?.name || \"Logo\"}\n   205→                className={`object-contain transition-all duration-300 ${sidebarCollapsed ? \"max-h-8 w-8\" : \"max-h-16 w-auto mx-auto\"}`}\n   206→              />\n   207→            ) : (\n   208→              <div className={`flex items-center ${sidebarCollapsed ? \"justify-center\" : \"gap-2\"}`}>\n   209→                <TruckIcon className={`text-primary transition-all duration-300 ${sidebarCollapsed ? \"w-6 h-6\" : \"w-8 h-8\"}`} />\n   210→                {!sidebarCollapsed && <span className=\"text-xl font-bold text-base-content\">{dealer?.name || \"DealerFlow\"}</span>}\n   211→              </div>\n   212→            )}\n   213→          </Link>\n   214→        </div>\n   215→\n   216→        {/* Navigation */}\n   217→        <nav className={`flex-1 mt-2 ${sidebarCollapsed ? \"px-2\" : \"px-3\"} overflow-y-auto`}>\n   218→          {/* Main Section */}\n   219→          {!sidebarCollapsed && (\n   220→            <p className=\"px-3 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\n   221→              Main\n   222→            </p>\n   223→          )}\n   224→          <ul className=\"space-y-1\">\n   225→            {navigation.slice(0, 3).map((item) => {\n   226→              const { Icon } = item;\n   227→              const itemPath = getPath(item.href);\n   228→              const isActive = router.pathname.startsWith(item.href) || router.asPath.includes(item.href);\n   229→              return (\n   230→                <li key={item.name} className=\"relative group\">\n   231→                  <Link\n   232→                    href={itemPath}\n   233→                    className={`relative flex items-center rounded-xl transition-all duration-200 ${\n   234→                      sidebarCollapsed ? \"justify-center p-2\" : \"gap-3 px-3 py-2.5\"\n   235→                    } ${\n   236→                      isActive\n   237→                        ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n   238→                        : \"hover:bg-slate-50\"\n   239→                    }`}\n   240→                    title={sidebarCollapsed ? item.name : undefined}\n   241→                  >\n   242→                    {/* Active indicator bar */}\n   243→                    {isActive && !sidebarCollapsed && (\n   244→                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-7 bg-gradient-to-b from-[#0066CC] to-[#0EA5E9] rounded-r-full\" />\n   245→                    )}\n   246→                    {/* Icon with colored container */}\n   247→                    <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n   248→                      sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n   249→                    } ${\n   250→                      isActive\n   251→                        ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n   252→                        : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n   253→                    }`}>\n   254→                      <Icon className=\"w-[18px] h-[18px]\" />\n   255→                    </div>\n   256→                    {!sidebarCollapsed && (\n   257→                      <span className={`text-sm transition-colors ${\n   258→                        isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n   259→                      }`}>{item.name}</span>\n   260→                    )}\n   261→                  </Link>\n   262→                  {/* Tooltip for collapsed state */}\n   263→                  {sidebarCollapsed && (\n   264→                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl\">\n   265→                      {item.name}\n   266→                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-slate-900 rotate-45\" />\n   267→                    </div>\n   268→                  )}\n   269→                </li>\n   270→              );\n   271→            })}\n   272→          </ul>\n   273→\n   274→          {/* Management Section */}\n   275→          {!sidebarCollapsed && (\n   276→            <p className=\"px-3 mt-6 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\n   277→              Management\n   278→            </p>\n   279→          )}\n   280→          {sidebarCollapsed && <div className=\"my-4 border-t border-slate-100\" />}\n   281→          <ul className=\"space-y-1\">\n   282→            {navigation.slice(3, 7).map((item) => {\n   283→              const { Icon } = item;\n   284→\n   285→              if (item.children) {\n   286→                const isExpanded = expandedMenus[item.name];\n   287→                const isActive = router.pathname.startsWith(\"/forms\");\n   288→\n   289→                return (\n   290→                  <li key={item.name}>\n   291→                    <button\n   292→                      onClick={() => setExpandedMenus(prev => ({ ...prev, [item.name]: !prev[item.name] }))}\n   293→                      className={`flex items-center w-full rounded-xl transition-all duration-200 group ${\n   294→                        sidebarCollapsed ? \"justify-center p-2\" : \"justify-between gap-3 px-3 py-2.5\"\n   295→                      } ${\n   296→                        isActive\n   297→                          ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n   298→                          : \"hover:bg-slate-50\"\n   299→                      }`}\n   300→                      title={sidebarCollapsed ? item.name : undefined}\n   301→                    >\n   302→                      <div className={`flex items-center ${sidebarCollapsed ? \"\" : \"gap-3\"}`}>\n   303→                        <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n   304→                          sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n   305→                        } ${\n   306→                          isActive\n   307→                            ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n   308→                            : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n   309→                        }`}>\n   310→                          <Icon className=\"w-[18px] h-[18px]\" />\n   311→                        </div>\n   312→                        {!sidebarCollapsed && (\n   313→                          <span className={`text-sm transition-colors ${\n   314→                            isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n   315→                          }`}>{item.name}</span>\n   316→                        )}\n   317→                      </div>\n   318→                      {!sidebarCollapsed && (\n   319→                        <ChevronDownIcon className={`w-4 h-4 transition-transform duration-200 ${isExpanded ? \"rotate-180\" : \"\"} ${isActive ? \"text-[#0066CC]\" : \"text-slate-400\"}`} />\n   320→                      )}\n   321→                    </button>\n   322→                    {!sidebarCollapsed && isExpanded && (\n   323→                      <ul className=\"mt-1.5 ml-11 space-y-0.5 border-l-2 border-[#0066CC]/20 pl-3\">\n   324→                        {item.children.map((child) => {\n   325→                          const childPath = getPath(child.href);\n   326→                          const isChildActive = router.pathname === child.href || router.asPath === child.href || router.asPath.includes(child.href);\n   327→                          return (\n   328→                            <li key={child.name}>\n   329→                              <Link\n   330→                                href={childPath}\n   331→                                className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-all text-sm ${\n   332→                                  isChildActive\n   333→                                    ? \"bg-[#0066CC]/10 text-[#0066CC] font-semibold\"\n   334→                                    : \"text-slate-500 hover:bg-slate-50 hover:text-slate-700\"\n   335→                                }`}\n   336→                              >\n   337→                                {isChildActive && <span className=\"w-1.5 h-1.5 rounded-full bg-[#0066CC]\" />}\n   338→                                <span>{child.name}</span>\n   339→                              </Link>\n   340→                            </li>\n   341→                          );\n   342→                        })}\n   343→                      </ul>\n   344→                    )}\n   345→                  </li>\n   346→                );\n   347→              }\n   348→\n   349→              const itemPath = getPath(item.href);\n   350→              const isActive = router.pathname.startsWith(item.href) || router.asPath.includes(item.href);\n   351→              return (\n   352→                <li key={item.name} className=\"relative group\">\n   353→                  <Link\n   354→                    href={itemPath}\n   355→                    className={`relative flex items-center rounded-xl transition-all duration-200 ${\n   356→                      sidebarCollapsed ? \"justify-center p-2\" : \"gap-3 px-3 py-2.5\"\n   357→                    } ${\n   358→                      isActive\n   359→                        ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n   360→                        : \"hover:bg-slate-50\"\n   361→                    }`}\n   362→                    title={sidebarCollapsed ? item.name : undefined}\n   363→                  >\n   364→                    {/* Active indicator bar */}\n   365→                    {isActive && !sidebarCollapsed && (\n   366→                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-7 bg-gradient-to-b from-[#0066CC] to-[#0EA5E9] rounded-r-full\" />\n   367→                    )}\n   368→                    {/* Icon with colored container */}\n   369→                    <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n   370→                      sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n   371→                    } ${\n   372→                      isActive\n   373→                        ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n   374→                        : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n   375→                    }`}>\n   376→                      <Icon className=\"w-[18px] h-[18px]\" />\n   377→                    </div>\n   378→                    {!sidebarCollapsed && (\n   379→                      <span className={`text-sm transition-colors ${\n   380→                        isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n   381→                      }`}>{item.name}</span>\n   382→                    )}\n   383→                  </Link>\n   384→                  {/* Tooltip for collapsed state */}\n   385→                  {sidebarCollapsed && (\n   386→                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl\">\n   387→                      {item.name}\n   388→                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-slate-900 rotate-45\" />\n   389→                    </div>\n   390→                  )}\n   391→                </li>\n   392→              );\n   393→            })}\n   394→          </ul>\n   395→\n   396→          {/* Settings Section */}\n   397→          {!sidebarCollapsed && (\n   398→            <p className=\"px-3 mt-6 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\n   399→              System\n   400→            </p>\n   401→          )}\n   402→          {sidebarCollapsed && <div className=\"my-4 border-t border-slate-100\" />}\n   403→          <ul className=\"space-y-1\">\n   404→            {navigation.slice(7).map((item) => {\n   405→              const { Icon } = item;\n   406→              const itemPath = getPath(item.href);\n   407→              const isActive = router.pathname.startsWith(item.href) || router.asPath.includes(item.href);\n   408→              return (\n   409→                <li key={item.name} className=\"relative group\">\n   410→                  <Link\n   411→                    href={itemPath}\n   412→                    className={`relative flex items-center rounded-xl transition-all duration-200 ${\n   413→                      sidebarCollapsed ? \"justify-center p-2\" : \"gap-3 px-3 py-2.5\"\n   414→                    } ${\n   415→                      isActive\n   416→                        ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n   417→                        : \"hover:bg-slate-50\"\n   418→                    }`}\n   419→                    title={sidebarCollapsed ? item.name : undefined}\n   420→                  >\n   421→                    {/* Active indicator bar */}\n   422→                    {isActive && !sidebarCollapsed && (\n   423→                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-7 bg-gradient-to-b from-[#0066CC] to-[#0EA5E9] rounded-r-full\" />\n   424→                    )}\n   425→                    {/* Icon with colored container */}\n   426→                    <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n   427→                      sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n   428→                    } ${\n   429→                      isActive\n   430→                        ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n   431→                        : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n   432→                    }`}>\n   433→                      <Icon className=\"w-[18px] h-[18px]\" />\n   434→                    </div>\n   435→                    {!sidebarCollapsed && (\n   436→                      <span className={`text-sm transition-colors ${\n   437→                        isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n   438→                      }`}>{item.name}</span>\n   439→                    )}\n   440→                  </Link>\n   441→                  {/* Tooltip for collapsed state */}\n   442→                  {sidebarCollapsed && (\n   443→                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl\">\n   444→                      {item.name}\n   445→                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-slate-900 rotate-45\" />\n   446→                    </div>\n   447→                  )}\n   448→                </li>\n   449→              );\n   450→            })}\n   451→          </ul>\n   452→        </nav>\n   453→\n   454→        {/* Footer - Collapse Toggle + SaaS Branding */}\n   455→        <div className={`mt-auto border-t border-slate-100 ${sidebarCollapsed ? \"p-2\" : \"p-4\"}`}>\n   456→          {/* Collapse Toggle Button */}\n   457→          <button\n   458→            onClick={toggleSidebarCollapsed}\n   459→            className={`hidden lg:flex items-center w-full rounded-xl text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition-all duration-200 ${\n   460→              sidebarCollapsed ? \"justify-center p-2\" : \"gap-2 px-3 py-2\"\n   461→            }`}\n   462→            title={sidebarCollapsed ? \"Expand sidebar ([ or Ctrl+B)\" : \"Collapse sidebar ([ or Ctrl+B)\"}\n   463→          >\n   464→            <svg className={`w-5 h-5 transition-transform duration-300 ${sidebarCollapsed ? \"rotate-180\" : \"\"}`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   465→              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11 19l-7-7 7-7m8 14l-7-7 7-7\" />\n   466→            </svg>\n   467→            {!sidebarCollapsed && <span className=\"text-sm\">Collapse</span>}\n   468→          </button>\n   469→          {!sidebarCollapsed && (\n   470→            <p className=\"text-[11px] text-slate-300 text-center mt-3\">\n   471→              Powered by <span className=\"font-semibold text-slate-400\">DealerFlow</span>\n   472→            </p>\n   473→          )}\n   474→        </div>\n   475→      </aside>\n   476→\n   477→      {/* Main content */}\n   478→      <div className={`transition-all duration-300 ${sidebarCollapsed ? \"lg:pl-16\" : \"lg:pl-64\"}`}>\n   479→        <header className=\"sticky top-0 z-30 flex items-center justify-between h-16 px-4 md:px-6 bg-white/95 backdrop-blur-md border-b border-slate-100\">\n   480→          <button className=\"lg:hidden btn btn-ghost btn-sm\" onClick={() => setSidebarOpen(true)}>\n   481→            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   482→              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 6h16M4 12h16M4 18h16\" />\n   483→            </svg>\n   484→          </button>\n   485→          <div className=\"flex-1 lg:flex-none\" />\n   486→          <div className=\"flex items-center gap-3\">\n   487→            {/* Quick Add Form Button */}\n   488→            <div className=\"dropdown dropdown-end\">\n   489→              <label tabIndex={0} className=\"flex items-center justify-center w-9 h-9 rounded-xl bg-[#0066CC] hover:bg-[#0055AA] text-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md\">\n   490→                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n   491→                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n   492→                </svg>\n   493→              </label>\n   494→              <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100\">\n   495→                {forms.length === 0 ? (\n   496→                  <li><span className=\"text-base-content/60 text-sm\">No forms available</span></li>\n   497→                ) : (\n   498→                  forms.map((form) => (\n   499→                    <li key={form.id || form._id}>\n   500→                      <button\n   501→                        onClick={() => handleFormClick(form)}\n   502→                        className=\"text-sm text-left\"\n   503→                      >\n   504→                        <span className=\"truncate\">{form.name}</span>\n   505→                      </button>\n   506→                    </li>\n   507→                  ))\n   508→                )}\n   509→              </ul>\n   510→            </div>\n   511→\n   512→            {/* User Menu */}\n   513→            <div className=\"dropdown dropdown-end\">\n   514→              <label tabIndex={0} className=\"btn btn-ghost btn-circle avatar placeholder cursor-pointer\">\n   515→                <div className=\"bg-neutral text-neutral-content rounded-full w-8\">\n   516→                  <span className=\"text-xs\">U</span>\n   517→                </div>\n   518→              </label>\n   519→              <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-lg bg-base-100 rounded-box w-52\">\n   520→                <li>\n   521→                  <Link href={getPath(\"/settings\")} className=\"text-sm\">\n   522→                    <CogIcon className=\"w-4 h-4\" />\n   523→                    Settings\n   524→                  </Link>\n   525→                </li>\n   526→                <div className=\"divider my-1\"></div>\n   527→                <li>\n   528→                  <button\n   529→                    onClick={() => signOut({ callbackUrl: \"/auth/signin\" })}\n   530→                    className=\"text-sm text-error\"\n   531→                  >\n   532→                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   533→                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9\" />\n   534→                    </svg>\n   535→                    Sign out\n   536→                  </button>\n   537→                </li>\n   538→              </ul>\n   539→            </div>\n   540→          </div>\n   541→        </header>\n   542→        <main className=\"p-4 md:p-6 lg:p-8 pb-24 md:pb-8 min-w-0 max-w-full overflow-x-hidden\">{children}</main>\n   543→      </div>\n   544→\n   545→      {/* Mobile Bottom Navigation - Safe area aware with modern styling */}\n   546→      <nav className=\"fixed bottom-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-md border-t border-slate-100 md:hidden shadow-lg shadow-slate-200/50\" style={{ paddingBottom: 'env(safe-area-inset-bottom, 0px)' }}>\n   547→        <div className=\"flex items-center justify-around h-16\">\n   548→          {[\n   549→            { name: \"Home\", href: \"/dashboard\", Icon: ChartBarIcon },\n   550→            { name: \"Stock\", href: \"/sales-prep\", Icon: TruckIcon },\n   551→            { name: \"Warranty\", href: \"/warranty\", Icon: WrenchIcon },\n   552→            { name: \"Forms\", href: \"/forms\", Icon: DocumentTextIcon },\n   553→            { name: \"More\", href: null, Icon: CogIcon, isMore: true },\n   554→          ].map((item) => {\n   555→            const itemPath = item.href ? getPath(item.href) : null;\n   556→            const isActive = item.href && (router.pathname.startsWith(item.href) || router.asPath.includes(item.href));\n   557→\n   558→            if (item.isMore) {\n   559→              return (\n   560→                <div key={item.name} className=\"dropdown dropdown-top dropdown-end\">\n   561→                  <label tabIndex={0} className=\"flex flex-col items-center justify-center h-full px-2 py-1.5 cursor-pointer group\">\n   562→                    <div className=\"flex items-center justify-center w-10 h-10 rounded-xl bg-slate-100 text-slate-400 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC] transition-all\">\n   563→                      <item.Icon className=\"w-5 h-5\" />\n   564→                    </div>\n   565→                    <span className=\"text-[10px] mt-0.5 text-slate-400 group-hover:text-[#0066CC] transition-colors\">{item.name}</span>\n   566→                  </label>\n   567→                  <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-xl bg-white rounded-2xl w-52 mb-3 border border-slate-100\">\n   568→                    <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">More Options</li>\n   569→                    <li><Link href={getPath(\"/appraisals\")} className=\"text-sm py-2.5 rounded-xl\">Appraisals</Link></li>\n   570→                    <li><Link href={getPath(\"/reviews\")} className=\"text-sm py-2.5 rounded-xl\">Reviews</Link></li>\n   571→                    <li><Link href={getPath(\"/calendar\")} className=\"text-sm py-2.5 rounded-xl\">Calendar</Link></li>\n   572→                    <div className=\"divider my-1 px-3\"></div>\n   573→                    <li><Link href={getPath(\"/settings\")} className=\"text-sm py-2.5 rounded-xl\">Settings</Link></li>\n   574→                  </ul>\n   575→                </div>\n   576→              );\n   577→            }\n   578→\n   579→            return (\n   580→              <Link\n   581→                key={item.name}\n   582→                href={itemPath}\n   583→                className=\"flex flex-col items-center justify-center h-full px-2 py-1.5 group\"\n   584→              >\n   585→                <div className={`flex items-center justify-center w-10 h-10 rounded-xl transition-all ${\n   586→                  isActive\n   587→                    ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/30\"\n   588→                    : \"bg-slate-100 text-slate-400 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n   589→                }`}>\n   590→                  <item.Icon className=\"w-5 h-5\" />\n   591→                </div>\n   592→                <span className={`text-[10px] mt-0.5 transition-colors ${\n   593→                  isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-400 group-hover:text-[#0066CC]\"\n   594→                }`}>{item.name}</span>\n   595→              </Link>\n   596→            );\n   597→          })}\n   598→        </div>\n   599→      </nav>\n   600→\n   601→      {/* Dev-only Tenant Debug Panel */}\n   602→      {process.env.NODE_ENV === \"development\" && debugContext && (\n   603→        <div className=\"fixed bottom-20 md:bottom-4 right-4 z-[60]\">\n   604→          <button\n   605→            onClick={() => setDebugPanelOpen(!debugPanelOpen)}\n   606→            className=\"btn btn-xs btn-warning shadow-lg\"\n   607→            title=\"Toggle debug panel\"\n   608→          >\n   609→            {debugPanelOpen ? \"Hide Debug\" : \"Debug\"}\n   610→          </button>\n   611→          {debugPanelOpen && (\n   612→            <div className=\"absolute bottom-8 right-0 bg-warning/10 border border-warning rounded-lg p-3 shadow-xl min-w-64 text-xs font-mono\">\n   613→              <div className=\"font-bold text-warning mb-2 text-sm\">Tenant Context</div>\n   614→              <div className=\"space-y-1 text-base-content\">\n   615→                <div className=\"flex justify-between gap-4\">\n   616→                  <span className=\"text-base-content/60\">Auth:</span>\n   617→                  <span className={debugContext.authenticated ? \"text-success\" : \"text-error\"}>\n   618→                    {debugContext.authenticated ? \"Yes\" : \"No\"}\n   619→                  </span>\n   620→                </div>\n   621→                <div className=\"flex justify-between gap-4\">\n   622→                  <span className=\"text-base-content/60\">User ID:</span>\n   623→                  <span className=\"truncate max-w-32\" title={debugContext.userId}>\n   624→                    {debugContext.userId || \"-\"}\n   625→                  </span>\n   626→                </div>\n   627→                <div className=\"flex justify-between gap-4\">\n   628→                  <span className=\"text-base-content/60\">Email:</span>\n   629→                  <span className=\"truncate max-w-32\" title={debugContext.userEmail}>\n   630→                    {debugContext.userEmail || \"-\"}\n   631→                  </span>\n   632→                </div>\n   633→                <div className=\"flex justify-between gap-4\">\n   634→                  <span className=\"text-base-content/60\">User Role:</span>\n   635→                  <span>{debugContext.userRole || \"-\"}</span>\n   636→                </div>\n   637→                <hr className=\"border-base-300 my-1\" />\n   638→                <div className=\"flex justify-between gap-4\">\n   639→                  <span className=\"text-base-content/60\">Dealer ID:</span>\n   640→                  <span className=\"truncate max-w-32\" title={debugContext.dealerId}>\n   641→                    {debugContext.dealerId || \"-\"}\n   642→                  </span>\n   643→                </div>\n   644→                <div className=\"flex justify-between gap-4\">\n   645→                  <span className=\"text-base-content/60\">Dealer:</span>\n   646→                  <span className=\"truncate max-w-32\" title={debugContext.dealerName}>\n   647→                    {debugContext.dealerName || \"-\"}\n   648→                  </span>\n   649→                </div>\n   650→                <div className=\"flex justify-between gap-4\">\n   651→                  <span className=\"text-base-content/60\">Membership:</span>\n   652→                  <span>{debugContext.membershipRole || \"-\"}</span>\n   653→                </div>\n   654→              </div>\n   655→            </div>\n   656→          )}\n   657→        </div>\n   658→      )}\n   659→    </div>\n   660→  );\n   661→}\n   662→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"51c64639-de5e-4082-9fda-53ee2dd40729","timestamp":"2025-12-30T15:45:38.469Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\components\\DashboardLayout.js","content":"import { useState, useEffect } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";\nimport { signOut } from \"next-auth/react\";\nimport { useDealer } from \"@/contexts/DealerContext\";\nimport { appPath } from \"@/libs/appPath\";\n\n// Human-readable form type labels\nconst FORM_TYPE_LABELS = {\n  PDI: \"PDI\",\n  TEST_DRIVE: \"Test Drive\",\n  WARRANTY_CLAIM: \"Warranty\",\n  COURTESY_OUT: \"Courtesy Out\",\n  COURTESY_IN: \"Courtesy In\",\n  SERVICE_RECEIPT: \"Service\",\n  REVIEW_FEEDBACK: \"Feedback\",\n  OTHER: \"Other\",\n};\n\n// Icon components (using inline SVG as heroicons alternative)\nconst ChartBarIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z\" />\n  </svg>\n);\n\nconst TruckIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12\" />\n  </svg>\n);\n\nconst WrenchIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z\" />\n  </svg>\n);\n\nconst ClipboardIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z\" />\n  </svg>\n);\n\nconst DocumentTextIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\" />\n  </svg>\n);\n\nconst StarIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z\" />\n  </svg>\n);\n\nconst CalendarIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5\" />\n  </svg>\n);\n\nconst CogIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z\" />\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n  </svg>\n);\n\nconst ChevronDownIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M19.5 8.25l-7.5 7.5-7.5-7.5\" />\n  </svg>\n);\n\nconst navigation = [\n  { name: \"Dashboard\", href: \"/dashboard\", Icon: ChartBarIcon },\n  { name: \"Stock & Prep\", href: \"/sales-prep\", Icon: TruckIcon },\n  { name: \"Aftersales/Warranty\", href: \"/warranty\", Icon: WrenchIcon },\n  { name: \"Appraisals\", href: \"/appraisals\", Icon: ClipboardIcon },\n  { name: \"Submissions\", href: \"/forms\", Icon: DocumentTextIcon },\n  { name: \"Reviews\", href: \"/reviews\", Icon: StarIcon },\n  { name: \"Calendar\", href: \"/calendar\", Icon: CalendarIcon },\n  { name: \"Settings\", href: \"/settings\", Icon: CogIcon },\n];\n\nexport default function DashboardLayout({ children }) {\n  const router = useRouter();\n  const { dealerSlug } = useDealer(); // Get dealer slug from tenant context (null if legacy route)\n  const getPath = (path) => appPath(dealerSlug, path); // Helper to generate tenant-aware paths\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);\n  const [expandedMenus, setExpandedMenus] = useState({});\n  const [forms, setForms] = useState([]);\n  const [dealer, setDealer] = useState(null);\n  const [debugContext, setDebugContext] = useState(null);\n  const [debugPanelOpen, setDebugPanelOpen] = useState(false);\n\n  // Load sidebar collapsed state from localStorage\n  useEffect(() => {\n    const saved = localStorage.getItem(\"sidebarCollapsed\");\n    if (saved !== null) {\n      setSidebarCollapsed(JSON.parse(saved));\n    }\n  }, []);\n\n  // Save sidebar collapsed state to localStorage\n  const toggleSidebarCollapsed = () => {\n    const newState = !sidebarCollapsed;\n    setSidebarCollapsed(newState);\n    localStorage.setItem(\"sidebarCollapsed\", JSON.stringify(newState));\n  };\n\n  // Keyboard shortcut: [ or Ctrl+B to toggle sidebar\n  useEffect(() => {\n    const handleKeyDown = (e) => {\n      if (e.key === \"[\" || (e.ctrlKey && e.key === \"b\")) {\n        e.preventDefault();\n        toggleSidebarCollapsed();\n      }\n    };\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [sidebarCollapsed]);\n\n  // Dev-only: fetch debug context\n  useEffect(() => {\n    if (process.env.NODE_ENV === \"development\") {\n      fetch(\"/api/debug/context\")\n        .then(res => {\n          const contentType = res.headers.get(\"content-type\") || \"\";\n          if (!contentType.includes(\"application/json\")) return null;\n          return res.json();\n        })\n        .then(data => {\n          if (data) setDebugContext(data);\n        })\n        .catch(() => {});\n    }\n  }, []);\n\n  useEffect(() => {\n    // Load forms for the quick add dropdown\n    fetch(\"/api/forms\")\n      .then(res => res.json())\n      .then(data => {\n        if (Array.isArray(data)) setForms(data);\n      })\n      .catch(() => {});\n\n    // Load dealer for logo and check onboarding status\n    fetch(\"/api/dealer\")\n      .then(async (res) => {\n        // 403 = no dealer membership - redirect to create dealer\n        if (res.status === 403 && !router.pathname.startsWith(\"/onboarding\")) {\n          router.push(getPath(\"/onboarding/create-dealer\"));\n          return null;\n        }\n        if (!res.ok) return null;\n        return res.json();\n      })\n      .then(data => {\n        if (!data) return;\n        setDealer(data);\n        // Redirect to onboarding wizard if not completed (skip if already on onboarding page)\n        if (data && !data.completedOnboarding && !router.pathname.startsWith(\"/onboarding\")) {\n          router.push(getPath(\"/onboarding\"));\n        }\n      })\n      .catch(() => {});\n  }, [router]);\n\n  const handleFormClick = (form) => {\n    if (form.isPublic && form.publicSlug) {\n      window.open(`/public/forms/${form.publicSlug}`, '_blank');\n    } else {\n      router.push(`/forms/fill/${form.id || form._id}`);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-[#f8fafc]\">\n      {sidebarOpen && (\n        <div className=\"fixed inset-0 bg-black/50 z-40 lg:hidden\" onClick={() => setSidebarOpen(false)} />\n      )}\n\n      {/* Sidebar - Modern design with brand colors */}\n      <aside className={`fixed top-0 left-0 z-50 h-full bg-white border-r border-slate-100 shadow-sm transform transition-all duration-300 ease-in-out lg:translate-x-0 flex flex-col ${sidebarOpen ? \"translate-x-0\" : \"-translate-x-full\"} ${sidebarCollapsed ? \"lg:w-16\" : \"lg:w-64\"} w-64`}>\n        {/* Mobile close button */}\n        <div className=\"flex items-center justify-end h-12 px-4 lg:hidden\">\n          <button className=\"text-base-content/50 hover:text-base-content hover:bg-base-200 rounded-lg p-2 transition-colors\" onClick={() => setSidebarOpen(false)}>\n            <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth={2}>\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Logo Area - Dealer's Logo takes prominence */}\n        <div className={`flex flex-col items-center transition-all duration-300 ${sidebarCollapsed ? \"p-3\" : \"p-6\"}`}>\n          <Link href={getPath(\"/dashboard\")} className=\"block\">\n            {dealer?.logoUrl ? (\n              <img\n                src={dealer.logoUrl}\n                alt={dealer?.name || \"Logo\"}\n                className={`object-contain transition-all duration-300 ${sidebarCollapsed ? \"max-h-8 w-8\" : \"max-h-16 w-auto mx-auto\"}`}\n              />\n            ) : (\n              <div className={`flex items-center ${sidebarCollapsed ? \"justify-center\" : \"gap-2\"}`}>\n                <TruckIcon className={`text-primary transition-all duration-300 ${sidebarCollapsed ? \"w-6 h-6\" : \"w-8 h-8\"}`} />\n                {!sidebarCollapsed && <span className=\"text-xl font-bold text-base-content\">{dealer?.name || \"DealerFlow\"}</span>}\n              </div>\n            )}\n          </Link>\n        </div>\n\n        {/* Navigation */}\n        <nav className={`flex-1 mt-2 ${sidebarCollapsed ? \"px-2\" : \"px-3\"} overflow-y-auto`}>\n          {/* Main Section */}\n          {!sidebarCollapsed && (\n            <p className=\"px-3 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\n              Main\n            </p>\n          )}\n          <ul className=\"space-y-1\">\n            {navigation.slice(0, 3).map((item) => {\n              const { Icon } = item;\n              const itemPath = getPath(item.href);\n              const isActive = router.pathname.startsWith(item.href) || router.asPath.includes(item.href);\n              return (\n                <li key={item.name} className=\"relative group\">\n                  <Link\n                    href={itemPath}\n                    className={`relative flex items-center rounded-xl transition-all duration-200 ${\n                      sidebarCollapsed ? \"justify-center p-2\" : \"gap-3 px-3 py-2.5\"\n                    } ${\n                      isActive\n                        ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n                        : \"hover:bg-slate-50\"\n                    }`}\n                    title={sidebarCollapsed ? item.name : undefined}\n                  >\n                    {/* Active indicator bar */}\n                    {isActive && !sidebarCollapsed && (\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-7 bg-gradient-to-b from-[#0066CC] to-[#0EA5E9] rounded-r-full\" />\n                    )}\n                    {/* Icon with colored container */}\n                    <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n                      sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n                    } ${\n                      isActive\n                        ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                        : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                    }`}>\n                      <Icon className=\"w-[18px] h-[18px]\" />\n                    </div>\n                    {!sidebarCollapsed && (\n                      <span className={`text-sm transition-colors ${\n                        isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n                      }`}>{item.name}</span>\n                    )}\n                  </Link>\n                  {/* Tooltip for collapsed state */}\n                  {sidebarCollapsed && (\n                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl\">\n                      {item.name}\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-slate-900 rotate-45\" />\n                    </div>\n                  )}\n                </li>\n              );\n            })}\n          </ul>\n\n          {/* Management Section */}\n          {!sidebarCollapsed && (\n            <p className=\"px-3 mt-6 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\n              Management\n            </p>\n          )}\n          {sidebarCollapsed && <div className=\"my-4 border-t border-slate-100\" />}\n          <ul className=\"space-y-1\">\n            {navigation.slice(3, 7).map((item) => {\n              const { Icon } = item;\n\n              if (item.children) {\n                const isExpanded = expandedMenus[item.name];\n                const isActive = router.pathname.startsWith(\"/forms\");\n\n                return (\n                  <li key={item.name}>\n                    <button\n                      onClick={() => setExpandedMenus(prev => ({ ...prev, [item.name]: !prev[item.name] }))}\n                      className={`flex items-center w-full rounded-xl transition-all duration-200 group ${\n                        sidebarCollapsed ? \"justify-center p-2\" : \"justify-between gap-3 px-3 py-2.5\"\n                      } ${\n                        isActive\n                          ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n                          : \"hover:bg-slate-50\"\n                      }`}\n                      title={sidebarCollapsed ? item.name : undefined}\n                    >\n                      <div className={`flex items-center ${sidebarCollapsed ? \"\" : \"gap-3\"}`}>\n                        <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n                          sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n                        } ${\n                          isActive\n                            ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                            : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                        }`}>\n                          <Icon className=\"w-[18px] h-[18px]\" />\n                        </div>\n                        {!sidebarCollapsed && (\n                          <span className={`text-sm transition-colors ${\n                            isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n                          }`}>{item.name}</span>\n                        )}\n                      </div>\n                      {!sidebarCollapsed && (\n                        <ChevronDownIcon className={`w-4 h-4 transition-transform duration-200 ${isExpanded ? \"rotate-180\" : \"\"} ${isActive ? \"text-[#0066CC]\" : \"text-slate-400\"}`} />\n                      )}\n                    </button>\n                    {!sidebarCollapsed && isExpanded && (\n                      <ul className=\"mt-1.5 ml-11 space-y-0.5 border-l-2 border-[#0066CC]/20 pl-3\">\n                        {item.children.map((child) => {\n                          const childPath = getPath(child.href);\n                          const isChildActive = router.pathname === child.href || router.asPath === child.href || router.asPath.includes(child.href);\n                          return (\n                            <li key={child.name}>\n                              <Link\n                                href={childPath}\n                                className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-all text-sm ${\n                                  isChildActive\n                                    ? \"bg-[#0066CC]/10 text-[#0066CC] font-semibold\"\n                                    : \"text-slate-500 hover:bg-slate-50 hover:text-slate-700\"\n                                }`}\n                              >\n                                {isChildActive && <span className=\"w-1.5 h-1.5 rounded-full bg-[#0066CC]\" />}\n                                <span>{child.name}</span>\n                              </Link>\n                            </li>\n                          );\n                        })}\n                      </ul>\n                    )}\n                  </li>\n                );\n              }\n\n              const itemPath = getPath(item.href);\n              const isActive = router.pathname.startsWith(item.href) || router.asPath.includes(item.href);\n              return (\n                <li key={item.name} className=\"relative group\">\n                  <Link\n                    href={itemPath}\n                    className={`relative flex items-center rounded-xl transition-all duration-200 ${\n                      sidebarCollapsed ? \"justify-center p-2\" : \"gap-3 px-3 py-2.5\"\n                    } ${\n                      isActive\n                        ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n                        : \"hover:bg-slate-50\"\n                    }`}\n                    title={sidebarCollapsed ? item.name : undefined}\n                  >\n                    {/* Active indicator bar */}\n                    {isActive && !sidebarCollapsed && (\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-7 bg-gradient-to-b from-[#0066CC] to-[#0EA5E9] rounded-r-full\" />\n                    )}\n                    {/* Icon with colored container */}\n                    <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n                      sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n                    } ${\n                      isActive\n                        ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                        : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                    }`}>\n                      <Icon className=\"w-[18px] h-[18px]\" />\n                    </div>\n                    {!sidebarCollapsed && (\n                      <span className={`text-sm transition-colors ${\n                        isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n                      }`}>{item.name}</span>\n                    )}\n                  </Link>\n                  {/* Tooltip for collapsed state */}\n                  {sidebarCollapsed && (\n                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl\">\n                      {item.name}\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-slate-900 rotate-45\" />\n                    </div>\n                  )}\n                </li>\n              );\n            })}\n          </ul>\n\n          {/* Settings Section */}\n          {!sidebarCollapsed && (\n            <p className=\"px-3 mt-6 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\n              System\n            </p>\n          )}\n          {sidebarCollapsed && <div className=\"my-4 border-t border-slate-100\" />}\n          <ul className=\"space-y-1\">\n            {navigation.slice(7).map((item) => {\n              const { Icon } = item;\n              const itemPath = getPath(item.href);\n              const isActive = router.pathname.startsWith(item.href) || router.asPath.includes(item.href);\n              return (\n                <li key={item.name} className=\"relative group\">\n                  <Link\n                    href={itemPath}\n                    className={`relative flex items-center rounded-xl transition-all duration-200 ${\n                      sidebarCollapsed ? \"justify-center p-2\" : \"gap-3 px-3 py-2.5\"\n                    } ${\n                      isActive\n                        ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n                        : \"hover:bg-slate-50\"\n                    }`}\n                    title={sidebarCollapsed ? item.name : undefined}\n                  >\n                    {/* Active indicator bar */}\n                    {isActive && !sidebarCollapsed && (\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-7 bg-gradient-to-b from-[#0066CC] to-[#0EA5E9] rounded-r-full\" />\n                    )}\n                    {/* Icon with colored container */}\n                    <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n                      sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n                    } ${\n                      isActive\n                        ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                        : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                    }`}>\n                      <Icon className=\"w-[18px] h-[18px]\" />\n                    </div>\n                    {!sidebarCollapsed && (\n                      <span className={`text-sm transition-colors ${\n                        isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n                      }`}>{item.name}</span>\n                    )}\n                  </Link>\n                  {/* Tooltip for collapsed state */}\n                  {sidebarCollapsed && (\n                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl\">\n                      {item.name}\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-slate-900 rotate-45\" />\n                    </div>\n                  )}\n                </li>\n              );\n            })}\n          </ul>\n        </nav>\n\n        {/* Footer - Collapse Toggle + SaaS Branding */}\n        <div className={`mt-auto border-t border-slate-100 ${sidebarCollapsed ? \"p-2\" : \"p-4\"}`}>\n          {/* Collapse Toggle Button */}\n          <button\n            onClick={toggleSidebarCollapsed}\n            className={`hidden lg:flex items-center w-full rounded-xl text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition-all duration-200 ${\n              sidebarCollapsed ? \"justify-center p-2\" : \"gap-2 px-3 py-2\"\n            }`}\n            title={sidebarCollapsed ? \"Expand sidebar ([ or Ctrl+B)\" : \"Collapse sidebar ([ or Ctrl+B)\"}\n          >\n            <svg className={`w-5 h-5 transition-transform duration-300 ${sidebarCollapsed ? \"rotate-180\" : \"\"}`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11 19l-7-7 7-7m8 14l-7-7 7-7\" />\n            </svg>\n            {!sidebarCollapsed && <span className=\"text-sm\">Collapse</span>}\n          </button>\n          {!sidebarCollapsed && (\n            <p className=\"text-[11px] text-slate-300 text-center mt-3\">\n              Powered by <span className=\"font-semibold text-slate-400\">DealerFlow</span>\n            </p>\n          )}\n        </div>\n      </aside>\n\n      {/* Main content */}\n      <div className={`transition-all duration-300 ${sidebarCollapsed ? \"lg:pl-16\" : \"lg:pl-64\"}`}>\n        <header className=\"sticky top-0 z-30 flex items-center justify-between h-16 px-4 md:px-6 bg-white/95 backdrop-blur-md border-b border-slate-100\">\n          <button className=\"lg:hidden btn btn-ghost btn-sm\" onClick={() => setSidebarOpen(true)}>\n            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 6h16M4 12h16M4 18h16\" />\n            </svg>\n          </button>\n          <div className=\"flex-1 lg:flex-none\" />\n          <div className=\"flex items-center gap-3\">\n            {/* Quick Add Form Button */}\n            <div className=\"dropdown dropdown-end\">\n              <label tabIndex={0} className=\"flex items-center justify-center w-9 h-9 rounded-xl bg-[#0066CC] hover:bg-[#0055AA] text-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                </svg>\n              </label>\n              <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100\">\n                {forms.length === 0 ? (\n                  <li><span className=\"text-base-content/60 text-sm\">No forms available</span></li>\n                ) : (\n                  forms.map((form) => (\n                    <li key={form.id || form._id}>\n                      <button\n                        onClick={() => handleFormClick(form)}\n                        className=\"text-sm text-left\"\n                      >\n                        <span className=\"truncate\">{form.name}</span>\n                      </button>\n                    </li>\n                  ))\n                )}\n              </ul>\n            </div>\n\n            {/* User Menu */}\n            <div className=\"dropdown dropdown-end\">\n              <label tabIndex={0} className=\"btn btn-ghost btn-circle avatar placeholder cursor-pointer\">\n                <div className=\"bg-neutral text-neutral-content rounded-full w-8\">\n                  <span className=\"text-xs\">U</span>\n                </div>\n              </label>\n              <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-lg bg-base-100 rounded-box w-52\">\n                <li>\n                  <Link href={getPath(\"/settings\")} className=\"text-sm\">\n                    <CogIcon className=\"w-4 h-4\" />\n                    Settings\n                  </Link>\n                </li>\n                <div className=\"divider my-1\"></div>\n                <li>\n                  <button\n                    onClick={() => signOut({ callbackUrl: \"/auth/signin\" })}\n                    className=\"text-sm text-error\"\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9\" />\n                    </svg>\n                    Sign out\n                  </button>\n                </li>\n              </ul>\n            </div>\n          </div>\n        </header>\n        <main className=\"p-4 md:p-6 lg:p-8 pb-24 md:pb-8 min-w-0 max-w-full overflow-x-hidden\">{children}</main>\n      </div>\n\n      {/* Mobile Bottom Navigation - Safe area aware with modern styling */}\n      <nav className=\"fixed bottom-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-md border-t border-slate-100 md:hidden shadow-lg shadow-slate-200/50\" style={{ paddingBottom: 'env(safe-area-inset-bottom, 0px)' }}>\n        <div className=\"flex items-center justify-around h-16\">\n          {[\n            { name: \"Home\", href: \"/dashboard\", Icon: ChartBarIcon },\n            { name: \"Stock\", href: \"/sales-prep\", Icon: TruckIcon },\n            { name: \"Warranty\", href: \"/warranty\", Icon: WrenchIcon },\n            { name: \"Forms\", href: \"/forms\", Icon: DocumentTextIcon },\n            { name: \"More\", href: null, Icon: CogIcon, isMore: true },\n          ].map((item) => {\n            const itemPath = item.href ? getPath(item.href) : null;\n            const isActive = item.href && (router.pathname.startsWith(item.href) || router.asPath.includes(item.href));\n\n            if (item.isMore) {\n              return (\n                <div key={item.name} className=\"dropdown dropdown-top dropdown-end\">\n                  <label tabIndex={0} className=\"flex flex-col items-center justify-center h-full px-2 py-1.5 cursor-pointer group\">\n                    <div className=\"flex items-center justify-center w-10 h-10 rounded-xl bg-slate-100 text-slate-400 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC] transition-all\">\n                      <item.Icon className=\"w-5 h-5\" />\n                    </div>\n                    <span className=\"text-[10px] mt-0.5 text-slate-400 group-hover:text-[#0066CC] transition-colors\">{item.name}</span>\n                  </label>\n                  <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-xl bg-white rounded-2xl w-52 mb-3 border border-slate-100\">\n                    <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">More Options</li>\n                    <li><Link href={getPath(\"/appraisals\")} className=\"text-sm py-2.5 rounded-xl\">Appraisals</Link></li>\n                    <li><Link href={getPath(\"/reviews\")} className=\"text-sm py-2.5 rounded-xl\">Reviews</Link></li>\n                    <li><Link href={getPath(\"/calendar\")} className=\"text-sm py-2.5 rounded-xl\">Calendar</Link></li>\n                    <div className=\"divider my-1 px-3\"></div>\n                    <li><Link href={getPath(\"/settings\")} className=\"text-sm py-2.5 rounded-xl\">Settings</Link></li>\n                  </ul>\n                </div>\n              );\n            }\n\n            return (\n              <Link\n                key={item.name}\n                href={itemPath}\n                className=\"flex flex-col items-center justify-center h-full px-2 py-1.5 group\"\n              >\n                <div className={`flex items-center justify-center w-10 h-10 rounded-xl transition-all ${\n                  isActive\n                    ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/30\"\n                    : \"bg-slate-100 text-slate-400 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                }`}>\n                  <item.Icon className=\"w-5 h-5\" />\n                </div>\n                <span className={`text-[10px] mt-0.5 transition-colors ${\n                  isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-400 group-hover:text-[#0066CC]\"\n                }`}>{item.name}</span>\n              </Link>\n            );\n          })}\n        </div>\n      </nav>\n\n      {/* Dev-only Tenant Debug Panel */}\n      {process.env.NODE_ENV === \"development\" && debugContext && (\n        <div className=\"fixed bottom-20 md:bottom-4 right-4 z-[60]\">\n          <button\n            onClick={() => setDebugPanelOpen(!debugPanelOpen)}\n            className=\"btn btn-xs btn-warning shadow-lg\"\n            title=\"Toggle debug panel\"\n          >\n            {debugPanelOpen ? \"Hide Debug\" : \"Debug\"}\n          </button>\n          {debugPanelOpen && (\n            <div className=\"absolute bottom-8 right-0 bg-warning/10 border border-warning rounded-lg p-3 shadow-xl min-w-64 text-xs font-mono\">\n              <div className=\"font-bold text-warning mb-2 text-sm\">Tenant Context</div>\n              <div className=\"space-y-1 text-base-content\">\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Auth:</span>\n                  <span className={debugContext.authenticated ? \"text-success\" : \"text-error\"}>\n                    {debugContext.authenticated ? \"Yes\" : \"No\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">User ID:</span>\n                  <span className=\"truncate max-w-32\" title={debugContext.userId}>\n                    {debugContext.userId || \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Email:</span>\n                  <span className=\"truncate max-w-32\" title={debugContext.userEmail}>\n                    {debugContext.userEmail || \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">User Role:</span>\n                  <span>{debugContext.userRole || \"-\"}</span>\n                </div>\n                <hr className=\"border-base-300 my-1\" />\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Dealer ID:</span>\n                  <span className=\"truncate max-w-32\" title={debugContext.dealerId}>\n                    {debugContext.dealerId || \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Dealer:</span>\n                  <span className=\"truncate max-w-32\" title={debugContext.dealerName}>\n                    {debugContext.dealerName || \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Membership:</span>\n                  <span>{debugContext.membershipRole || \"-\"}</span>\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","numLines":662,"startLine":1,"totalLines":662}}}
{"parentUuid":"51c64639-de5e-4082-9fda-53ee2dd40729","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Leorxfk6HkzW3hLh52zgvx","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a good understanding of the key files. Let me also read the AI suggestions panel and the test drive form template. I also need to check the sales-prep page for how vehicles are added, and the appraisals pages.","signature":"EoUDCkYICxgCKkALd3m6zombL+phLIA1VRIW7VMYOvj/UskayGvZK/pTvZFBOBgzQ6a1dYawCV2WfP6fJXYIpnC8xPFFV5He2hR+EgyhAXQ5rhgBX9+D00QaDPgcGGs3EQbmmRvEhyIwTDyBK/TaKLKjF7HmJJdKdMZsPh7OGMCByFXrq1lUQQ/wRxUGJoHVmgudo8fLa2rVKuwBzr97+jeWBQD7n8e+xoDhJ0tU3JmiJVtr9HU8TVnDihOXdmyHOlv3qulm0SL2FSqTgh3Rj95OrnjY3vTAd51fQIB3QTosuyWz5x4K2g5wKdNh/G7vusD/N0GgFIhR2i/e5MkLII4yCqWXvX7mtPt9EUpWBcrpWa7ghk3CA92S5DZd5ryi2mMBXesM2wXpCouP5sIbzlJSpcf1WTEEbh7W7ZvTSz8xg41ODvKehqZ8C3XTX1N8ptGAN3GguaA8+CzllMRVQxGVvNvVZiqWazu3fPsRi2dQ/cE/TCGZjCD6yX5Vcb59b6pXQ+GA73cYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3222,"cache_creation_input_tokens":14979,"cache_read_input_tokens":25142,"cache_creation":{"ephemeral_5m_input_tokens":14979,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWd8Yoqma27U5LRnVdwTk","type":"assistant","uuid":"0e31a7af-bea0-458c-a0cd-1f55c799e54b","timestamp":"2025-12-30T15:45:45.730Z"}
{"parentUuid":"0e31a7af-bea0-458c-a0cd-1f55c799e54b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Leorxfk6HkzW3hLh52zgvx","type":"message","role":"assistant","content":[{"type":"text","text":"Let me also read the AI suggestions panel, test drive form template, and stock-related pages:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3222,"cache_creation_input_tokens":14979,"cache_read_input_tokens":25142,"cache_creation":{"ephemeral_5m_input_tokens":14979,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWd8Yoqma27U5LRnVdwTk","type":"assistant","uuid":"1eb11bfb-1ef6-4ee3-9bbc-ea0f32106f94","timestamp":"2025-12-30T15:45:46.364Z"}
{"parentUuid":"1eb11bfb-1ef6-4ee3-9bbc-ea0f32106f94","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Leorxfk6HkzW3hLh52zgvx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015sWnH5R8Cxob9zVkjkZJq7","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3222,"cache_creation_input_tokens":14979,"cache_read_input_tokens":25142,"cache_creation":{"ephemeral_5m_input_tokens":14979,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWd8Yoqma27U5LRnVdwTk","type":"assistant","uuid":"b822d60b-ae0f-4625-a4cc-15bc74a1edac","timestamp":"2025-12-30T15:45:47.466Z"}
{"parentUuid":"b822d60b-ae0f-4625-a4cc-15bc74a1edac","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Leorxfk6HkzW3hLh52zgvx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KfGMnwUWUhrj8DyYLVyFhm","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\libs\\formTemplates.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3222,"cache_creation_input_tokens":14979,"cache_read_input_tokens":25142,"cache_creation":{"ephemeral_5m_input_tokens":14979,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWd8Yoqma27U5LRnVdwTk","type":"assistant","uuid":"131f49a5-32c9-4949-b5d6-9f5056f0c42f","timestamp":"2025-12-30T15:45:48.198Z"}
{"parentUuid":"131f49a5-32c9-4949-b5d6-9f5056f0c42f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Leorxfk6HkzW3hLh52zgvx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BqiYRQwCPhxKekXt9jy2wF","name":"Grep","input":{"pattern":"addVehicle|add vehicle|AddVehicle","-i":true,"output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3222,"cache_creation_input_tokens":14979,"cache_read_input_tokens":25142,"cache_creation":{"ephemeral_5m_input_tokens":14979,"ephemeral_1h_input_tokens":0},"output_tokens":290,"service_tier":"standard"}},"requestId":"req_011CWd8Yoqma27U5LRnVdwTk","type":"assistant","uuid":"45ca82db-a4d4-4546-be09-4192f9c74aa6","timestamp":"2025-12-30T15:45:49.442Z"}
{"parentUuid":"45ca82db-a4d4-4546-be09-4192f9c74aa6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015sWnH5R8Cxob9zVkjkZJq7","type":"tool_result","content":"     1→/**\n     2→ * AI Suggestions Panel Component\n     3→ *\n     4→ * Displays AI-generated diagnostic suggestions in a collapsible panel.\n     5→ * Shows: suspected issues, checks to run, customer questions, parts, safety notes.\n     6→ * Includes \"Copy to notes\" functionality.\n     7→ */\n     8→\n     9→import { useState } from \"react\";\n    10→import { toast } from \"react-hot-toast\";\n    11→\n    12→// Urgency badge colors\n    13→const URGENCY_COLORS = {\n    14→  low: \"badge-success\",\n    15→  med: \"badge-warning\",\n    16→  high: \"badge-error\",\n    17→};\n    18→\n    19→const URGENCY_LABELS = {\n    20→  low: \"Low\",\n    21→  med: \"Medium\",\n    22→  high: \"High\",\n    23→};\n    24→\n    25→export default function AISuggestionsPanel({\n    26→  suggestions,\n    27→  isLoading,\n    28→  isDummy,\n    29→  onCopyToNotes,\n    30→  className = \"\",\n    31→}) {\n    32→  const [isExpanded, setIsExpanded] = useState(true);\n    33→\n    34→  if (!suggestions && !isLoading) {\n    35→    return null;\n    36→  }\n    37→\n    38→  const handleCopyToNotes = () => {\n    39→    if (!suggestions) return;\n    40→\n    41→    // Format suggestions as text\n    42→    const lines = [];\n    43→    lines.push(\"=== AI SUGGESTIONS ===\\n\");\n    44→\n    45→    if (suggestions.suspected_issues?.length > 0) {\n    46→      lines.push(\"SUSPECTED ISSUES:\");\n    47→      suggestions.suspected_issues.forEach((issue, i) => {\n    48→        lines.push(`${i + 1}. ${issue.title} [${issue.urgency?.toUpperCase()}]`);\n    49→        if (issue.why) lines.push(`   Why: ${issue.why}`);\n    50→      });\n    51→      lines.push(\"\");\n    52→    }\n    53→\n    54→    if (suggestions.checks_to_run?.length > 0) {\n    55→      lines.push(\"CHECKS TO RUN:\");\n    56→      suggestions.checks_to_run.forEach((check, i) => {\n    57→        lines.push(`${i + 1}. ${check.step}`);\n    58→        if (check.tools) lines.push(`   Tools: ${check.tools}`);\n    59→        if (check.time_estimate_mins) lines.push(`   Est. time: ${check.time_estimate_mins} mins`);\n    60→      });\n    61→      lines.push(\"\");\n    62→    }\n    63→\n    64→    if (suggestions.questions_for_customer?.length > 0) {\n    65→      lines.push(\"QUESTIONS FOR CUSTOMER:\");\n    66→      suggestions.questions_for_customer.forEach((q, i) => {\n    67→        lines.push(`${i + 1}. ${q.question}`);\n    68→        if (q.why) lines.push(`   Reason: ${q.why}`);\n    69→      });\n    70→      lines.push(\"\");\n    71→    }\n    72→\n    73→    if (suggestions.parts_to_consider?.length > 0) {\n    74→      lines.push(\"PARTS TO CONSIDER:\");\n    75→      suggestions.parts_to_consider.forEach((part, i) => {\n    76→        lines.push(`${i + 1}. ${part.part}`);\n    77→        if (part.notes) lines.push(`   Notes: ${part.notes}`);\n    78→      });\n    79→      lines.push(\"\");\n    80→    }\n    81→\n    82→    if (suggestions.safety_notes?.length > 0) {\n    83→      lines.push(\"SAFETY NOTES:\");\n    84→      suggestions.safety_notes.forEach((note, i) => {\n    85→        lines.push(`- ${note.note}`);\n    86→      });\n    87→    }\n    88→\n    89→    const text = lines.join(\"\\n\");\n    90→\n    91→    // If callback provided, use it\n    92→    if (onCopyToNotes) {\n    93→      onCopyToNotes(text);\n    94→      toast.success(\"Added to notes\");\n    95→    } else {\n    96→      // Otherwise copy to clipboard\n    97→      navigator.clipboard.writeText(text).then(() => {\n    98→        toast.success(\"Copied to clipboard\");\n    99→      }).catch(() => {\n   100→        toast.error(\"Failed to copy\");\n   101→      });\n   102→    }\n   103→  };\n   104→\n   105→  return (\n   106→    <div className={`bg-base-200 rounded-lg border border-base-300 ${className}`}>\n   107→      {/* Header */}\n   108→      <div\n   109→        className=\"flex items-center justify-between p-3 cursor-pointer hover:bg-base-300/50 rounded-t-lg\"\n   110→        onClick={() => setIsExpanded(!isExpanded)}\n   111→      >\n   112→        <div className=\"flex items-center gap-2\">\n   113→          <svg\n   114→            xmlns=\"http://www.w3.org/2000/svg\"\n   115→            className=\"h-5 w-5 text-primary\"\n   116→            viewBox=\"0 0 24 24\"\n   117→            fill=\"none\"\n   118→            stroke=\"currentColor\"\n   119→            strokeWidth=\"2\"\n   120→          >\n   121→            <path d=\"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5\" />\n   122→          </svg>\n   123→          <span className=\"font-medium\">AI Suggestions</span>\n   124→          {isDummy && (\n   125→            <span className=\"badge badge-sm badge-ghost\">Demo</span>\n   126→          )}\n   127→        </div>\n   128→        <div className=\"flex items-center gap-2\">\n   129→          {isLoading && (\n   130→            <span className=\"loading loading-spinner loading-sm\"></span>\n   131→          )}\n   132→          <svg\n   133→            xmlns=\"http://www.w3.org/2000/svg\"\n   134→            className={`h-4 w-4 transition-transform ${isExpanded ? \"rotate-180\" : \"\"}`}\n   135→            fill=\"none\"\n   136→            viewBox=\"0 0 24 24\"\n   137→            stroke=\"currentColor\"\n   138→          >\n   139→            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n   140→          </svg>\n   141→        </div>\n   142→      </div>\n   143→\n   144→      {/* Content */}\n   145→      {isExpanded && (\n   146→        <div className=\"p-3 pt-0 space-y-4\">\n   147→          {isLoading ? (\n   148→            <div className=\"text-center py-4 text-base-content/60\">\n   149→              <span className=\"loading loading-dots loading-md\"></span>\n   150→              <p className=\"mt-2 text-sm\">Analysing...</p>\n   151→            </div>\n   152→          ) : suggestions ? (\n   153→            <>\n   154→              {/* Suspected Issues */}\n   155→              {suggestions.suspected_issues?.length > 0 && (\n   156→                <div>\n   157→                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n   158→                    <span className=\"text-warning\">!</span> Suspected Issues\n   159→                  </h4>\n   160→                  <div className=\"space-y-2\">\n   161→                    {suggestions.suspected_issues.map((issue, i) => (\n   162→                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n   163→                        <div className=\"flex items-start justify-between gap-2\">\n   164→                          <span className=\"font-medium\">{issue.title}</span>\n   165→                          {issue.urgency && (\n   166→                            <span className={`badge badge-xs ${URGENCY_COLORS[issue.urgency] || \"badge-ghost\"}`}>\n   167→                              {URGENCY_LABELS[issue.urgency] || issue.urgency}\n   168→                            </span>\n   169→                          )}\n   170→                        </div>\n   171→                        {issue.why && (\n   172→                          <p className=\"text-base-content/70 mt-1\">{issue.why}</p>\n   173→                        )}\n   174→                      </div>\n   175→                    ))}\n   176→                  </div>\n   177→                </div>\n   178→              )}\n   179→\n   180→              {/* Checks to Run */}\n   181→              {suggestions.checks_to_run?.length > 0 && (\n   182→                <div>\n   183→                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n   184→                    <span className=\"text-info\">&#10003;</span> Checks to Run\n   185→                  </h4>\n   186→                  <div className=\"space-y-2\">\n   187→                    {suggestions.checks_to_run.map((check, i) => (\n   188→                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n   189→                        <p className=\"font-medium\">{check.step}</p>\n   190→                        <div className=\"flex gap-4 mt-1 text-xs text-base-content/60\">\n   191→                          {check.tools && <span>Tools: {check.tools}</span>}\n   192→                          {check.time_estimate_mins > 0 && (\n   193→                            <span>~{check.time_estimate_mins} mins</span>\n   194→                          )}\n   195→                        </div>\n   196→                      </div>\n   197→                    ))}\n   198→                  </div>\n   199→                </div>\n   200→              )}\n   201→\n   202→              {/* Questions for Customer */}\n   203→              {suggestions.questions_for_customer?.length > 0 && (\n   204→                <div>\n   205→                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n   206→                    <span className=\"text-secondary\">?</span> Questions for Customer\n   207→                  </h4>\n   208→                  <div className=\"space-y-2\">\n   209→                    {suggestions.questions_for_customer.map((q, i) => (\n   210→                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n   211→                        <p className=\"font-medium\">{q.question}</p>\n   212→                        {q.why && (\n   213→                          <p className=\"text-base-content/60 text-xs mt-1\">\n   214→                            Why: {q.why}\n   215→                          </p>\n   216→                        )}\n   217→                      </div>\n   218→                    ))}\n   219→                  </div>\n   220→                </div>\n   221→              )}\n   222→\n   223→              {/* Parts to Consider */}\n   224→              {suggestions.parts_to_consider?.length > 0 && (\n   225→                <div>\n   226→                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n   227→                    <span className=\"text-accent\">&#9881;</span> Parts to Consider\n   228→                  </h4>\n   229→                  <div className=\"space-y-1\">\n   230→                    {suggestions.parts_to_consider.map((part, i) => (\n   231→                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n   232→                        <span className=\"font-medium\">{part.part}</span>\n   233→                        {part.notes && (\n   234→                          <span className=\"text-base-content/60\"> - {part.notes}</span>\n   235→                        )}\n   236→                      </div>\n   237→                    ))}\n   238→                  </div>\n   239→                </div>\n   240→              )}\n   241→\n   242→              {/* Safety Notes */}\n   243→              {suggestions.safety_notes?.length > 0 && (\n   244→                <div>\n   245→                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n   246→                    <span className=\"text-error\">&#9888;</span> Safety Notes\n   247→                  </h4>\n   248→                  <div className=\"bg-error/10 border border-error/20 rounded p-2\">\n   249→                    <ul className=\"text-sm space-y-1\">\n   250→                      {suggestions.safety_notes.map((note, i) => (\n   251→                        <li key={i} className=\"flex items-start gap-2\">\n   252→                          <span className=\"text-error\">&#8226;</span>\n   253→                          <span>{note.note}</span>\n   254→                        </li>\n   255→                      ))}\n   256→                    </ul>\n   257→                  </div>\n   258→                </div>\n   259→              )}\n   260→\n   261→              {/* Copy to Notes Button */}\n   262→              <div className=\"pt-2 border-t border-base-300\">\n   263→                <button\n   264→                  type=\"button\"\n   265→                  className=\"btn btn-sm btn-ghost gap-2\"\n   266→                  onClick={handleCopyToNotes}\n   267→                >\n   268→                  <svg\n   269→                    xmlns=\"http://www.w3.org/2000/svg\"\n   270→                    className=\"h-4 w-4\"\n   271→                    fill=\"none\"\n   272→                    viewBox=\"0 0 24 24\"\n   273→                    stroke=\"currentColor\"\n   274→                  >\n   275→                    <path\n   276→                      strokeLinecap=\"round\"\n   277→                      strokeLinejoin=\"round\"\n   278→                      strokeWidth={2}\n   279→                      d=\"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\"\n   280→                    />\n   281→                  </svg>\n   282→                  Copy to notes\n   283→                </button>\n   284→              </div>\n   285→            </>\n   286→          ) : (\n   287→            <p className=\"text-sm text-base-content/60 text-center py-4\">\n   288→              No suggestions available\n   289→            </p>\n   290→          )}\n   291→        </div>\n   292→      )}\n   293→    </div>\n   294→  );\n   295→}\n   296→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"5236b6e9-5a77-4486-99cc-155ea91f53cb","timestamp":"2025-12-30T15:45:54.530Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js","content":"/**\n * AI Suggestions Panel Component\n *\n * Displays AI-generated diagnostic suggestions in a collapsible panel.\n * Shows: suspected issues, checks to run, customer questions, parts, safety notes.\n * Includes \"Copy to notes\" functionality.\n */\n\nimport { useState } from \"react\";\nimport { toast } from \"react-hot-toast\";\n\n// Urgency badge colors\nconst URGENCY_COLORS = {\n  low: \"badge-success\",\n  med: \"badge-warning\",\n  high: \"badge-error\",\n};\n\nconst URGENCY_LABELS = {\n  low: \"Low\",\n  med: \"Medium\",\n  high: \"High\",\n};\n\nexport default function AISuggestionsPanel({\n  suggestions,\n  isLoading,\n  isDummy,\n  onCopyToNotes,\n  className = \"\",\n}) {\n  const [isExpanded, setIsExpanded] = useState(true);\n\n  if (!suggestions && !isLoading) {\n    return null;\n  }\n\n  const handleCopyToNotes = () => {\n    if (!suggestions) return;\n\n    // Format suggestions as text\n    const lines = [];\n    lines.push(\"=== AI SUGGESTIONS ===\\n\");\n\n    if (suggestions.suspected_issues?.length > 0) {\n      lines.push(\"SUSPECTED ISSUES:\");\n      suggestions.suspected_issues.forEach((issue, i) => {\n        lines.push(`${i + 1}. ${issue.title} [${issue.urgency?.toUpperCase()}]`);\n        if (issue.why) lines.push(`   Why: ${issue.why}`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.checks_to_run?.length > 0) {\n      lines.push(\"CHECKS TO RUN:\");\n      suggestions.checks_to_run.forEach((check, i) => {\n        lines.push(`${i + 1}. ${check.step}`);\n        if (check.tools) lines.push(`   Tools: ${check.tools}`);\n        if (check.time_estimate_mins) lines.push(`   Est. time: ${check.time_estimate_mins} mins`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.questions_for_customer?.length > 0) {\n      lines.push(\"QUESTIONS FOR CUSTOMER:\");\n      suggestions.questions_for_customer.forEach((q, i) => {\n        lines.push(`${i + 1}. ${q.question}`);\n        if (q.why) lines.push(`   Reason: ${q.why}`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.parts_to_consider?.length > 0) {\n      lines.push(\"PARTS TO CONSIDER:\");\n      suggestions.parts_to_consider.forEach((part, i) => {\n        lines.push(`${i + 1}. ${part.part}`);\n        if (part.notes) lines.push(`   Notes: ${part.notes}`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.safety_notes?.length > 0) {\n      lines.push(\"SAFETY NOTES:\");\n      suggestions.safety_notes.forEach((note, i) => {\n        lines.push(`- ${note.note}`);\n      });\n    }\n\n    const text = lines.join(\"\\n\");\n\n    // If callback provided, use it\n    if (onCopyToNotes) {\n      onCopyToNotes(text);\n      toast.success(\"Added to notes\");\n    } else {\n      // Otherwise copy to clipboard\n      navigator.clipboard.writeText(text).then(() => {\n        toast.success(\"Copied to clipboard\");\n      }).catch(() => {\n        toast.error(\"Failed to copy\");\n      });\n    }\n  };\n\n  return (\n    <div className={`bg-base-200 rounded-lg border border-base-300 ${className}`}>\n      {/* Header */}\n      <div\n        className=\"flex items-center justify-between p-3 cursor-pointer hover:bg-base-300/50 rounded-t-lg\"\n        onClick={() => setIsExpanded(!isExpanded)}\n      >\n        <div className=\"flex items-center gap-2\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            className=\"h-5 w-5 text-primary\"\n            viewBox=\"0 0 24 24\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth=\"2\"\n          >\n            <path d=\"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5\" />\n          </svg>\n          <span className=\"font-medium\">AI Suggestions</span>\n          {isDummy && (\n            <span className=\"badge badge-sm badge-ghost\">Demo</span>\n          )}\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {isLoading && (\n            <span className=\"loading loading-spinner loading-sm\"></span>\n          )}\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            className={`h-4 w-4 transition-transform ${isExpanded ? \"rotate-180\" : \"\"}`}\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n          </svg>\n        </div>\n      </div>\n\n      {/* Content */}\n      {isExpanded && (\n        <div className=\"p-3 pt-0 space-y-4\">\n          {isLoading ? (\n            <div className=\"text-center py-4 text-base-content/60\">\n              <span className=\"loading loading-dots loading-md\"></span>\n              <p className=\"mt-2 text-sm\">Analysing...</p>\n            </div>\n          ) : suggestions ? (\n            <>\n              {/* Suspected Issues */}\n              {suggestions.suspected_issues?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-warning\">!</span> Suspected Issues\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {suggestions.suspected_issues.map((issue, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <span className=\"font-medium\">{issue.title}</span>\n                          {issue.urgency && (\n                            <span className={`badge badge-xs ${URGENCY_COLORS[issue.urgency] || \"badge-ghost\"}`}>\n                              {URGENCY_LABELS[issue.urgency] || issue.urgency}\n                            </span>\n                          )}\n                        </div>\n                        {issue.why && (\n                          <p className=\"text-base-content/70 mt-1\">{issue.why}</p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Checks to Run */}\n              {suggestions.checks_to_run?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-info\">&#10003;</span> Checks to Run\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {suggestions.checks_to_run.map((check, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <p className=\"font-medium\">{check.step}</p>\n                        <div className=\"flex gap-4 mt-1 text-xs text-base-content/60\">\n                          {check.tools && <span>Tools: {check.tools}</span>}\n                          {check.time_estimate_mins > 0 && (\n                            <span>~{check.time_estimate_mins} mins</span>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Questions for Customer */}\n              {suggestions.questions_for_customer?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-secondary\">?</span> Questions for Customer\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {suggestions.questions_for_customer.map((q, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <p className=\"font-medium\">{q.question}</p>\n                        {q.why && (\n                          <p className=\"text-base-content/60 text-xs mt-1\">\n                            Why: {q.why}\n                          </p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Parts to Consider */}\n              {suggestions.parts_to_consider?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-accent\">&#9881;</span> Parts to Consider\n                  </h4>\n                  <div className=\"space-y-1\">\n                    {suggestions.parts_to_consider.map((part, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <span className=\"font-medium\">{part.part}</span>\n                        {part.notes && (\n                          <span className=\"text-base-content/60\"> - {part.notes}</span>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Safety Notes */}\n              {suggestions.safety_notes?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-error\">&#9888;</span> Safety Notes\n                  </h4>\n                  <div className=\"bg-error/10 border border-error/20 rounded p-2\">\n                    <ul className=\"text-sm space-y-1\">\n                      {suggestions.safety_notes.map((note, i) => (\n                        <li key={i} className=\"flex items-start gap-2\">\n                          <span className=\"text-error\">&#8226;</span>\n                          <span>{note.note}</span>\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              )}\n\n              {/* Copy to Notes Button */}\n              <div className=\"pt-2 border-t border-base-300\">\n                <button\n                  type=\"button\"\n                  className=\"btn btn-sm btn-ghost gap-2\"\n                  onClick={handleCopyToNotes}\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    className=\"h-4 w-4\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    stroke=\"currentColor\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={2}\n                      d=\"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\"\n                    />\n                  </svg>\n                  Copy to notes\n                </button>\n              </div>\n            </>\n          ) : (\n            <p className=\"text-sm text-base-content/60 text-center py-4\">\n              No suggestions available\n            </p>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","numLines":296,"startLine":1,"totalLines":296}}}
{"parentUuid":"5236b6e9-5a77-4486-99cc-155ea91f53cb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BqiYRQwCPhxKekXt9jy2wF","type":"tool_result","content":"Found 6 files\npages\\vehicles\\new.js\npages\\sales-prep.js\npages\\dashboard.js\npages\\vehicles\\index.js\npages\\onboarding.js\npages\\index.js"}]},"uuid":"8650854e-a463-4757-bf35-17c00e4061f9","timestamp":"2025-12-30T15:45:54.596Z","toolUseResult":{"mode":"files_with_matches","filenames":["pages\\vehicles\\new.js","pages\\sales-prep.js","pages\\dashboard.js","pages\\vehicles\\index.js","pages\\onboarding.js","pages\\index.js"],"numFiles":6}}
{"parentUuid":"8650854e-a463-4757-bf35-17c00e4061f9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KfGMnwUWUhrj8DyYLVyFhm","type":"tool_result","content":"     1→// Default form templates for new dealers\n     2→// Note: Appraisal forms are handled separately in the Appraisals section\n     3→\n     4→// Field types available:\n     5→// TEXT, TEXTAREA, NUMBER, DATE, TIME, DATETIME, BOOLEAN, DROPDOWN, RADIO, FILE, SIGNATURE, RATING\n     6→// SECTION_HEADER (display only), PARAGRAPH (display only), CHECKLIST (multiple checkboxes)\n     7→\n     8→export const FORM_TEMPLATES = [\n     9→  // ═══════════════════════════════════════════════════════════════════════════════\n    10→  // PDI (Pre-Delivery Inspection) - Comprehensive 8-section form\n    11→  // ═══════════════════════════════════════════════════════════════════════════════\n    12→  {\n    13→    name: \"PDI (Pre-Delivery Inspection)\",\n    14→    type: \"PDI\",\n    15→    visibility: \"SHARE_LINK\", // Accessible via share link for 3rd parties (workshops, MOT centres)\n    16→    isPublic: false, // Deprecated - kept for backward compat\n    17→    publicSlug: \"pdi\",\n    18→    introText: \"Complete all sections of this Pre-Delivery Inspection before vehicle handover.\",\n    19→    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\"] },\n    20→    fields: [\n    21→      // Section 1: Vehicle Info\n    22→      { label: \"Vehicle Information\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n    23→      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n    24→      { label: \"Make\", fieldName: \"make\", type: \"TEXT\", required: true, order: 3 },\n    25→      { label: \"Model\", fieldName: \"model\", type: \"TEXT\", required: true, order: 4 },\n    26→      { label: \"Mileage\", fieldName: \"mileage\", type: \"NUMBER\", required: true, order: 5 },\n    27→      { label: \"Colour\", fieldName: \"colour\", type: \"TEXT\", required: true, order: 6 },\n    28→      { label: \"Number of Keys\", fieldName: \"num_keys\", type: \"RADIO\", required: true, order: 7, options: { choices: [\"1\", \"2\", \"3+\"] } },\n    29→\n    30→      // Section 2: Interior Checks\n    31→      { label: \"Interior Checks\", fieldName: \"_section_interior\", type: \"SECTION_HEADER\", order: 10 },\n    32→      { label: \"Seat Adjustment\", fieldName: \"seat_adjustment\", type: \"RADIO\", required: true, order: 11, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    33→      { label: \"Seat Belts\", fieldName: \"seat_belts\", type: \"RADIO\", required: true, order: 12, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    34→      { label: \"Sun Visor/Sunroof\", fieldName: \"sun_visor\", type: \"RADIO\", required: true, order: 13, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    35→      { label: \"Glove Box\", fieldName: \"glove_box\", type: \"RADIO\", required: true, order: 14, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    36→      { label: \"Windows Front/Rear\", fieldName: \"windows\", type: \"RADIO\", required: true, order: 15, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    37→      { label: \"Wipers\", fieldName: \"wipers\", type: \"RADIO\", required: true, order: 16, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    38→      { label: \"Washer System\", fieldName: \"washer\", type: \"RADIO\", required: true, order: 17, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    39→      { label: \"Sat Nav\", fieldName: \"sat_nav\", type: \"RADIO\", required: true, order: 18, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    40→      { label: \"Horn\", fieldName: \"horn\", type: \"RADIO\", required: true, order: 19, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    41→      { label: \"Fuel Gauge\", fieldName: \"fuel_gauge\", type: \"RADIO\", required: true, order: 20, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    42→      { label: \"Temp Gauge\", fieldName: \"temp_gauge\", type: \"RADIO\", required: true, order: 21, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    43→      { label: \"Dash Lights\", fieldName: \"dash_lights\", type: \"RADIO\", required: true, order: 22, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    44→      { label: \"Audio System\", fieldName: \"audio_system\", type: \"RADIO\", required: true, order: 23, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    45→      { label: \"Steering Wheel Controls\", fieldName: \"steering_controls\", type: \"RADIO\", required: true, order: 24, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    46→      { label: \"Rear Camera\", fieldName: \"rear_camera\", type: \"RADIO\", required: true, order: 25, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    47→      { label: \"Parking Sensors Front\", fieldName: \"parking_sensors_front\", type: \"RADIO\", required: true, order: 26, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    48→      { label: \"Parking Sensors Rear\", fieldName: \"parking_sensors_rear\", type: \"RADIO\", required: true, order: 27, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    49→      { label: \"Clock\", fieldName: \"clock\", type: \"RADIO\", required: true, order: 28, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    50→      { label: \"Steering Tilt/Lock\", fieldName: \"steering_tilt\", type: \"RADIO\", required: true, order: 29, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    51→      { label: \"12V Outlet\", fieldName: \"outlet_12v\", type: \"RADIO\", required: true, order: 30, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    52→      { label: \"Mirrors\", fieldName: \"mirrors\", type: \"RADIO\", required: true, order: 31, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    53→      { label: \"Heated Seats\", fieldName: \"heated_seats\", type: \"RADIO\", required: true, order: 32, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    54→      { label: \"Air Conditioning\", fieldName: \"air_con\", type: \"RADIO\", required: true, order: 33, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    55→      { label: \"Key Fobs Working\", fieldName: \"key_fobs\", type: \"RADIO\", required: true, order: 34, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n    56→\n    57→      // Section 3: Equipment\n    58→      { label: \"Equipment Checks\", fieldName: \"_section_equipment\", type: \"SECTION_HEADER\", order: 40 },\n    59→      { label: \"Jack & Wrench\", fieldName: \"jack_wrench\", type: \"RADIO\", required: true, order: 41, options: { choices: [\"Present\", \"Missing\", \"N/A\"] } },\n    60→      { label: \"Locking Wheel Nut Location\", fieldName: \"locking_nut_location\", type: \"TEXT\", required: false, order: 42 },\n    61→      { label: \"Parcel Shelf\", fieldName: \"parcel_shelf\", type: \"RADIO\", required: true, order: 43, options: { choices: [\"Present\", \"Missing\", \"N/A\"] } },\n    62→\n    63→      // Section 4: Exterior\n    64→      { label: \"Exterior Checks\", fieldName: \"_section_exterior\", type: \"SECTION_HEADER\", order: 50 },\n    65→      { label: \"Wiper Blades\", fieldName: \"wiper_blades\", type: \"RADIO\", required: true, order: 51, options: { choices: [\"Okay\", \"Replace\", \"N/A\"] } },\n    66→      { label: \"Bonnet\", fieldName: \"bonnet\", type: \"RADIO\", required: true, order: 52, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n    67→      { label: \"Boot\", fieldName: \"boot\", type: \"RADIO\", required: true, order: 53, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n    68→      { label: \"Door Locks\", fieldName: \"door_locks\", type: \"RADIO\", required: true, order: 54, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n    69→      { label: \"Central Locking\", fieldName: \"central_locking\", type: \"RADIO\", required: true, order: 55, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n    70→      { label: \"Exhaust\", fieldName: \"exhaust\", type: \"RADIO\", required: true, order: 56, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n    71→      { label: \"Fuel Cap\", fieldName: \"fuel_cap\", type: \"RADIO\", required: true, order: 57, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n    72→      { label: \"Aerial\", fieldName: \"aerial\", type: \"RADIO\", required: true, order: 58, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n    73→      { label: \"Wing Mirrors\", fieldName: \"wing_mirrors\", type: \"RADIO\", required: true, order: 59, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n    74→      { label: \"Windscreen Condition\", fieldName: \"windscreen\", type: \"RADIO\", required: true, order: 60, options: { choices: [\"Okay\", \"Chip\", \"Crack\", \"Replace\"] } },\n    75→\n    76→      // Tyres\n    77→      { label: \"Tyres & Wheels\", fieldName: \"_section_tyres\", type: \"SECTION_HEADER\", order: 70 },\n    78→      { label: \"Tyre Size Front\", fieldName: \"tyre_size_front\", type: \"TEXT\", required: true, order: 71 },\n    79→      { label: \"Tyre Size Rear\", fieldName: \"tyre_size_rear\", type: \"TEXT\", required: true, order: 72 },\n    80→      { label: \"Runflat Tyres\", fieldName: \"runflat\", type: \"RADIO\", required: true, order: 73, options: { choices: [\"Yes\", \"No\"] } },\n    81→      { label: \"Tyre Depth - Front Left (mm)\", fieldName: \"tyre_depth_fl\", type: \"NUMBER\", required: true, order: 74 },\n    82→      { label: \"Tyre Depth - Front Right (mm)\", fieldName: \"tyre_depth_fr\", type: \"NUMBER\", required: true, order: 75 },\n    83→      { label: \"Tyre Depth - Rear Left (mm)\", fieldName: \"tyre_depth_rl\", type: \"NUMBER\", required: true, order: 76 },\n    84→      { label: \"Tyre Depth - Rear Right (mm)\", fieldName: \"tyre_depth_rr\", type: \"NUMBER\", required: true, order: 77 },\n    85→      { label: \"Brake Pad Depth - Front Left (mm)\", fieldName: \"brake_pad_fl\", type: \"NUMBER\", required: true, order: 78 },\n    86→      { label: \"Brake Pad Depth - Front Right (mm)\", fieldName: \"brake_pad_fr\", type: \"NUMBER\", required: true, order: 79 },\n    87→      { label: \"Brake Pad Depth - Rear Left (mm)\", fieldName: \"brake_pad_rl\", type: \"NUMBER\", required: true, order: 80 },\n    88→      { label: \"Brake Pad Depth - Rear Right (mm)\", fieldName: \"brake_pad_rr\", type: \"NUMBER\", required: true, order: 81 },\n    89→      { label: \"Wheels Condition\", fieldName: \"wheels_condition\", type: \"RADIO\", required: true, order: 82, options: { choices: [\"Good\", \"Minor Damage\", \"Needs Refurb\"] } },\n    90→      { label: \"Tyre Pressure/Valves\", fieldName: \"tyre_pressure\", type: \"RADIO\", required: true, order: 83, options: { choices: [\"Okay\", \"Adjusted\", \"Issue\"] } },\n    91→      { label: \"Brake Discs\", fieldName: \"brake_discs\", type: \"RADIO\", required: true, order: 84, options: { choices: [\"Okay\", \"Worn\", \"Replace\"] } },\n    92→\n    93→      // Section 5: Lights\n    94→      { label: \"Light Checks\", fieldName: \"_section_lights\", type: \"SECTION_HEADER\", order: 90 },\n    95→      { label: \"Headlights\", fieldName: \"headlights\", type: \"RADIO\", required: true, order: 91, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n    96→      { label: \"Brake Lights\", fieldName: \"brake_lights\", type: \"RADIO\", required: true, order: 92, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n    97→      { label: \"Fog Lights\", fieldName: \"fog_lights\", type: \"RADIO\", required: true, order: 93, options: { choices: [\"Okay\", \"Replace Bulb\", \"N/A\"] } },\n    98→      { label: \"Reverse Lights\", fieldName: \"reverse_lights\", type: \"RADIO\", required: true, order: 94, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n    99→      { label: \"Indicators\", fieldName: \"indicators\", type: \"RADIO\", required: true, order: 95, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n   100→      { label: \"Number Plate Lights\", fieldName: \"number_plate_lights\", type: \"RADIO\", required: true, order: 96, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n   101→      { label: \"Hazard Lights\", fieldName: \"hazard_lights\", type: \"RADIO\", required: true, order: 97, options: { choices: [\"Okay\", \"Repair\"] } },\n   102→      { label: \"Interior Lights\", fieldName: \"interior_lights\", type: \"RADIO\", required: true, order: 98, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n   103→\n   104→      // Section 6: Road Test\n   105→      { label: \"Road Test\", fieldName: \"_section_road_test\", type: \"SECTION_HEADER\", order: 100 },\n   106→      { label: \"Parking Brake\", fieldName: \"parking_brake\", type: \"RADIO\", required: true, order: 101, options: { choices: [\"Okay\", \"Adjust\", \"Repair\"] } },\n   107→      { label: \"Steering Effort\", fieldName: \"steering_effort\", type: \"RADIO\", required: true, order: 102, options: { choices: [\"Normal\", \"Heavy\", \"Light\"] } },\n   108→      { label: \"Tracking\", fieldName: \"tracking\", type: \"RADIO\", required: true, order: 103, options: { choices: [\"Okay\", \"Needs Alignment\"] } },\n   109→      { label: \"Cruise Control\", fieldName: \"cruise_control\", type: \"RADIO\", required: true, order: 104, options: { choices: [\"Okay\", \"Not Working\", \"N/A\"] } },\n   110→      { label: \"Odometer Matches\", fieldName: \"odometer_matches\", type: \"RADIO\", required: true, order: 105, options: { choices: [\"Yes\", \"No\"] } },\n   111→      { label: \"Heaters Working\", fieldName: \"heaters\", type: \"RADIO\", required: true, order: 106, options: { choices: [\"Okay\", \"Not Working\"] } },\n   112→      { label: \"Steering Vibration\", fieldName: \"steering_vibration\", type: \"RADIO\", required: true, order: 107, options: { choices: [\"None\", \"Minor\", \"Significant\"] } },\n   113→      { label: \"Brake Wobble\", fieldName: \"brake_wobble\", type: \"RADIO\", required: true, order: 108, options: { choices: [\"None\", \"Minor\", \"Significant\"] } },\n   114→      { label: \"Suspension\", fieldName: \"suspension\", type: \"RADIO\", required: true, order: 109, options: { choices: [\"Okay\", \"Noisy\", \"Repair\"] } },\n   115→      { label: \"CV Joints\", fieldName: \"cv_joints\", type: \"RADIO\", required: true, order: 110, options: { choices: [\"Okay\", \"Clicking\", \"Replace\"] } },\n   116→      { label: \"Clutch\", fieldName: \"clutch\", type: \"RADIO\", required: true, order: 111, options: { choices: [\"Okay\", \"Slipping\", \"N/A (Auto)\"] } },\n   117→      { label: \"Gear Change\", fieldName: \"gear_change\", type: \"RADIO\", required: true, order: 112, options: { choices: [\"OK\", \"Repair\"] } },\n   118→\n   119→      // Section 7: Engine\n   120→      { label: \"Engine Checks\", fieldName: \"_section_engine\", type: \"SECTION_HEADER\", order: 120 },\n   121→      { label: \"Oil Level\", fieldName: \"oil_level\", type: \"RADIO\", required: true, order: 121, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n   122→      { label: \"Brake Fluid\", fieldName: \"brake_fluid\", type: \"RADIO\", required: true, order: 122, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n   123→      { label: \"Screen Wash\", fieldName: \"screen_wash\", type: \"RADIO\", required: true, order: 123, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n   124→      { label: \"Coolant Level\", fieldName: \"coolant_level\", type: \"RADIO\", required: true, order: 124, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n   125→      { label: \"Power Steering Fluid\", fieldName: \"power_steering\", type: \"RADIO\", required: true, order: 125, options: { choices: [\"Okay\", \"Low\", \"N/A (Electric)\"] } },\n   126→      { label: \"Battery Condition\", fieldName: \"battery\", type: \"RADIO\", required: true, order: 126, options: { choices: [\"Good\", \"Weak\", \"Replace\"] } },\n   127→      { label: \"Ignition\", fieldName: \"ignition\", type: \"RADIO\", required: true, order: 127, options: { choices: [\"Okay\", \"Issue\"] } },\n   128→      { label: \"Fuel System\", fieldName: \"fuel_system\", type: \"RADIO\", required: true, order: 128, options: { choices: [\"Okay\", \"Leak\", \"Issue\"] } },\n   129→      { label: \"Radiator\", fieldName: \"radiator\", type: \"RADIO\", required: true, order: 129, options: { choices: [\"Okay\", \"Leak\", \"Damage\"] } },\n   130→      { label: \"Cooling Fan\", fieldName: \"cooling_fan\", type: \"RADIO\", required: true, order: 130, options: { choices: [\"Working\", \"Not Working\"] } },\n   131→      { label: \"DPF Soot Level\", fieldName: \"dpf_soot\", type: \"RADIO\", required: false, order: 131, options: { choices: [\"OK\", \"Repair/Replace\"] } },\n   132→\n   133→      // Section 8: Issues Found (structured for automation)\n   134→      { label: \"Issues Found\", fieldName: \"_section_issues\", type: \"SECTION_HEADER\", order: 133 },\n   135→      { label: \"Add issues that need attention. These will be automatically added to the vehicle's issue list.\", fieldName: \"_issues_help\", type: \"PARAGRAPH\", order: 134 },\n   136→      { label: \"Issues\", fieldName: \"pdi_issues\", type: \"PDI_ISSUES\", required: false, order: 135 },\n   137→\n   138→      // Section 9: Sign-off\n   139→      { label: \"Sign-off\", fieldName: \"_section_signoff\", type: \"SECTION_HEADER\", order: 140 },\n   140→      { label: \"Notes / Recommendations\", fieldName: \"notes\", type: \"TEXTAREA\", required: false, order: 141 },\n   141→      { label: \"Photos\", fieldName: \"photos\", type: \"FILE\", required: false, order: 142 },\n   142→      { label: \"PDI Carried Out By\", fieldName: \"inspector_name\", type: \"TEXT\", required: true, order: 143 },\n   143→      { label: \"Date\", fieldName: \"pdi_date\", type: \"DATE\", required: true, order: 144 },\n   144→      { label: \"Inspector Signature\", fieldName: \"inspector_signature\", type: \"SIGNATURE\", required: true, order: 145 },\n   145→    ],\n   146→  },\n   147→\n   148→  // ═══════════════════════════════════════════════════════════════════════════════\n   149→  // Test Drive Request\n   150→  // ═══════════════════════════════════════════════════════════════════════════════\n   151→  {\n   152→    name: \"Test Drive Request\",\n   153→    type: \"TEST_DRIVE\",\n   154→    visibility: \"PUBLIC\", // Fully public - customers can access\n   155→    isPublic: true, // Deprecated - kept for backward compat\n   156→    publicSlug: \"test-drive\",\n   157→    introText: \"Please complete this form to book a test drive. You must bring your valid driving licence on the day.\",\n   158→    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] },\n   159→    termsText: `By signing this form, I confirm that:\n   160→- I hold a valid UK driving licence\n   161→- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n   162→- I will follow all road traffic laws\n   163→- I am responsible for any parking or speeding fines incurred during the test drive\n   164→- I will not allow any other person to drive the vehicle`,\n   165→    fields: [\n   166→      // Test Drive Details - date defaults to today, time defaults to current time (handled in frontend)\n   167→      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 1 },\n   168→      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 2 },\n   169→      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 5 },\n   170→      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 6 },\n   171→      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 7 },\n   172→      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 8 },\n   173→      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 9 },\n   174→      { label: \"Driving Licence\", fieldName: \"_section_licence\", type: \"SECTION_HEADER\", order: 15 },\n   175→      { label: \"Upload Driving Licence (Front)\", fieldName: \"licence_photo\", type: \"FILE\", required: true, order: 16 },\n   176→      { label: \"Address (if different from licence)\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },\n   177→      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: false, order: 21 },\n   178→      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22 },\n   179→      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: false, order: 23 },\n   180→      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: false, order: 24 },\n   181→      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 30 },\n   182→      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 31, vrmLookup: true },\n   183→      // Make and Model are hidden when vehicle is selected from stock (handled in frontend)\n   184→      { label: \"Vehicle Make\", fieldName: \"vehicle_make\", type: \"TEXT\", required: false, order: 32, hiddenWhenStockSelected: true },\n   185→      { label: \"Vehicle Model\", fieldName: \"vehicle_model\", type: \"TEXT\", required: false, order: 33, hiddenWhenStockSelected: true },\n   186→      { label: \"Where did you find this vehicle?\", fieldName: \"source\", type: \"DROPDOWN\", required: true, order: 35, options: { choices: [\"AutoTrader\", \"eBay\", \"Facebook\", \"Google\", \"Referral\", \"Walk-in\", \"Other\"] } },\n   187→      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n   188→      { label: \"I agree to the Terms & Conditions\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n   189→      { label: \"Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 42 },\n   190→    ],\n   191→  },\n   192→\n   193→  // ═══════════════════════════════════════════════════════════════════════════════\n   194→  // Courtesy Car Out\n   195→  // ═══════════════════════════════════════════════════════════════════════════════\n   196→  {\n   197→    name: \"Courtesy Car Out\",\n   198→    type: \"COURTESY_OUT\",\n   199→    visibility: \"INTERNAL\", // Staff only - requires login\n   200→    isPublic: false, // Deprecated - kept for backward compat\n   201→    publicSlug: \"courtesy-out\",\n   202→    introText: \"Complete this form when issuing a courtesy vehicle to a customer.\",\n   203→    vrmLookup: { enabled: true, statuses: [\"COURTESY\"], vehicleType: \"COURTESY\" },\n   204→    termsText: `TERMS OF USE - COURTESY VEHICLE\n   205→\n   206→1. The vehicle must be returned with the same fuel level as when collected.\n   207→2. The driver is responsible for any parking fines, speeding tickets, or congestion charges.\n   208→3. The vehicle must not be driven outside the UK.\n   209→4. Only named drivers on this form may drive the vehicle.\n   210→5. Any damage must be reported immediately to {dealer.companyName}.\n   211→6. The vehicle is covered by our insurance policy. Excess of £500 applies for any claims.\n   212→7. The vehicle must be returned on the agreed date unless prior arrangement is made.\n   213→\n   214→For emergencies, contact: {dealer.companyPhone}`,\n   215→    fields: [\n   216→      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n   217→      { label: \"Courtesy Vehicle Registration\", fieldName: \"courtesy_vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n   218→      { label: \"Current Mileage\", fieldName: \"mileage_out\", type: \"NUMBER\", required: true, order: 3 },\n   219→      { label: \"Date/Time Out\", fieldName: \"datetime_out\", type: \"DATETIME\", required: true, order: 4 },\n   220→      { label: \"Expected Return Date\", fieldName: \"date_due_back\", type: \"DATE\", required: true, order: 5 },\n   221→      { label: \"Fuel Level\", fieldName: \"fuel_out\", type: \"RADIO\", required: true, order: 6, options: { choices: [\"Empty\", \"1/4\", \"1/2\", \"3/4\", \"Full\"] } },\n   222→      { label: \"Customer Vehicle Registration\", fieldName: \"customer_vehicle_reg\", type: \"TEXT\", required: false, order: 7, placeholder: \"Customer's vehicle being repaired (if applicable)\" },\n   223→\n   224→      { label: \"Driver Information\", fieldName: \"_section_driver\", type: \"SECTION_HEADER\", order: 10 },\n   225→      { label: \"First Name\", fieldName: \"driver_first_name\", type: \"TEXT\", required: true, order: 11 },\n   226→      { label: \"Last Name\", fieldName: \"driver_last_name\", type: \"TEXT\", required: true, order: 12 },\n   227→      { label: \"Mobile Number\", fieldName: \"driver_phone\", type: \"TEXT\", required: true, order: 13 },\n   228→      { label: \"Date of Birth\", fieldName: \"driver_dob\", type: \"DATE\", required: true, order: 14 },\n   229→      { label: \"Street Address\", fieldName: \"driver_address_street\", type: \"TEXT\", required: true, order: 15 },\n   230→      { label: \"City\", fieldName: \"driver_address_city\", type: \"TEXT\", required: true, order: 16 },\n   231→      { label: \"County\", fieldName: \"driver_address_county\", type: \"TEXT\", required: false, order: 17 },\n   232→      { label: \"Post Code\", fieldName: \"driver_address_postcode\", type: \"TEXT\", required: true, order: 18 },\n   233→\n   234→      { label: \"Additional Driver (Optional)\", fieldName: \"_section_additional\", type: \"SECTION_HEADER\", order: 25 },\n   235→      { label: \"Additional Driver Name\", fieldName: \"additional_driver_name\", type: \"TEXT\", required: false, order: 26 },\n   236→      { label: \"Additional Driver Mobile\", fieldName: \"additional_driver_phone\", type: \"TEXT\", required: false, order: 27 },\n   237→      { label: \"Additional Driver DOB\", fieldName: \"additional_driver_dob\", type: \"DATE\", required: false, order: 28 },\n   238→\n   239→      { label: \"Documents\", fieldName: \"_section_docs\", type: \"SECTION_HEADER\", order: 35 },\n   240→      { label: \"Upload Driving Licence (Front & Back)\", fieldName: \"licence_photos\", type: \"FILE\", required: true, order: 36 },\n   241→\n   242→      { label: \"Condition Report\", fieldName: \"_section_condition\", type: \"SECTION_HEADER\", order: 40 },\n   243→      { label: \"Existing Damage Notes\", fieldName: \"existing_damage\", type: \"TEXTAREA\", required: false, order: 41, placeholder: \"Note any existing scratches, dents, etc.\" },\n   244→      { label: \"Condition Photos\", fieldName: \"condition_photos\", type: \"FILE\", required: false, order: 42 },\n   245→\n   246→      { label: \"Agreement\", fieldName: \"_section_agreement\", type: \"SECTION_HEADER\", order: 50 },\n   247→      { label: \"I have read and agree to the terms of use\", fieldName: \"terms_accepted\", type: \"BOOLEAN\", required: true, order: 51 },\n   248→      { label: \"I confirm the fuel level and mileage are correct\", fieldName: \"confirm_details\", type: \"BOOLEAN\", required: true, order: 52 },\n   249→      { label: \"Driver Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 53 },\n   250→    ],\n   251→  },\n   252→\n   253→  // ═══════════════════════════════════════════════════════════════════════════════\n   254→  // Courtesy Car Return\n   255→  // ═══════════════════════════════════════════════════════════════════════════════\n   256→  {\n   257→    name: \"Courtesy Car Return\",\n   258→    type: \"COURTESY_IN\",\n   259→    visibility: \"INTERNAL\", // Staff only - requires login\n   260→    isPublic: false, // Deprecated - kept for backward compat\n   261→    publicSlug: \"courtesy-in\",\n   262→    introText: \"Complete this form when a courtesy vehicle is returned.\",\n   263→    vrmLookup: { enabled: true, statuses: [\"COURTESY\"], vehicleType: \"COURTESY\" },\n   264→    fields: [\n   265→      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n   266→      { label: \"Courtesy Vehicle Registration\", fieldName: \"courtesy_vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n   267→      { label: \"Date/Time Returned\", fieldName: \"datetime_returned\", type: \"DATETIME\", required: true, order: 3 },\n   268→      { label: \"Mileage In\", fieldName: \"mileage_in\", type: \"NUMBER\", required: true, order: 4 },\n   269→      { label: \"Fuel Level\", fieldName: \"fuel_in\", type: \"RADIO\", required: true, order: 5, options: { choices: [\"Empty\", \"1/4\", \"1/2\", \"3/4\", \"Full\"] } },\n   270→      { label: \"Customer Vehicle Registration\", fieldName: \"customer_vehicle_reg\", type: \"TEXT\", required: false, order: 6, placeholder: \"Customer's vehicle being repaired (if applicable)\" },\n   271→\n   272→      { label: \"Driver Information\", fieldName: \"_section_driver\", type: \"SECTION_HEADER\", order: 10 },\n   273→      { label: \"Driver Name\", fieldName: \"driver_name\", type: \"TEXT\", required: true, order: 11 },\n   274→\n   275→      { label: \"Return Condition\", fieldName: \"_section_condition\", type: \"SECTION_HEADER\", order: 20 },\n   276→      { label: \"Vehicle returned clean\", fieldName: \"returned_clean\", type: \"BOOLEAN\", required: true, order: 21 },\n   277→      { label: \"No new damage\", fieldName: \"no_new_damage\", type: \"BOOLEAN\", required: true, order: 22 },\n   278→      { label: \"All belongings removed\", fieldName: \"belongings_removed\", type: \"BOOLEAN\", required: true, order: 23 },\n   279→      { label: \"Fuel level acceptable\", fieldName: \"fuel_acceptable\", type: \"BOOLEAN\", required: true, order: 24 },\n   280→\n   281→      { label: \"Issues / Disclosure\", fieldName: \"_section_issues\", type: \"SECTION_HEADER\", order: 30 },\n   282→      { label: \"Any damage or issues to report?\", fieldName: \"issues_notes\", type: \"TEXTAREA\", required: false, order: 31 },\n   283→      { label: \"Damage Photos\", fieldName: \"damage_photos\", type: \"FILE\", required: false, order: 32 },\n   284→\n   285→      { label: \"Sign-off\", fieldName: \"_section_signoff\", type: \"SECTION_HEADER\", order: 40 },\n   286→      { label: \"Driver Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 41 },\n   287→      { label: \"Staff Member Name\", fieldName: \"staff_name\", type: \"TEXT\", required: true, order: 42 },\n   288→    ],\n   289→  },\n   290→\n   291→  // ═══════════════════════════════════════════════════════════════════════════════\n   292→  // Delivery Form\n   293→  // ═══════════════════════════════════════════════════════════════════════════════\n   294→  {\n   295→    name: \"Vehicle Delivery\",\n   296→    type: \"DELIVERY\",\n   297→    visibility: \"SHARE_LINK\", // Accessible via share link for 3rd parties (delivery drivers)\n   298→    isPublic: false, // Deprecated - kept for backward compat\n   299→    publicSlug: \"delivery\",\n   300→    introText: \"Complete this form when handing over a vehicle to the customer.\",\n   301→    vrmLookup: { enabled: true, statuses: [\"SOLD\", \"ADVERTISED\"] },\n   302→    autoStatusChange: { newStatus: \"DELIVERED\" },\n   303→    fields: [\n   304→      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n   305→      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n   306→      { label: \"Date\", fieldName: \"delivery_date\", type: \"DATE\", required: true, order: 3 },\n   307→      { label: \"Time\", fieldName: \"delivery_time\", type: \"TIME\", required: true, order: 4 },\n   308→\n   309→      { label: \"Customer Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },\n   310→      { label: \"Customer First Name\", fieldName: \"customer_first_name\", type: \"TEXT\", required: true, order: 11 },\n   311→      { label: \"Customer Last Name\", fieldName: \"customer_last_name\", type: \"TEXT\", required: true, order: 12 },\n   312→\n   313→      { label: \"Documentation\", fieldName: \"_section_docs\", type: \"SECTION_HEADER\", order: 20 },\n   314→      { label: \"Photo of Invoice with ID\", fieldName: \"invoice_id_photo\", type: \"FILE\", required: true, order: 21 },\n   315→      { label: \"Photo of Customer with Vehicle\", fieldName: \"customer_vehicle_photo\", type: \"FILE\", required: true, order: 22 },\n   316→\n   317→      { label: \"Consent\", fieldName: \"_section_consent\", type: \"SECTION_HEADER\", order: 30 },\n   318→      { label: \"Do you consent for the delivery photo to be used on our website/social media?\", fieldName: \"photo_consent\", type: \"RADIO\", required: true, order: 31, options: { choices: [\"Yes\", \"No\"] } },\n   319→\n   320→      { label: \"Sign-off\", fieldName: \"_section_signoff\", type: \"SECTION_HEADER\", order: 40 },\n   321→      { label: \"Customer Signature\", fieldName: \"customer_signature\", type: \"SIGNATURE\", required: true, order: 41 },\n   322→      { label: \"Staff Member Name\", fieldName: \"staff_name\", type: \"TEXT\", required: true, order: 42 },\n   323→    ],\n   324→  },\n   325→\n   326→  // ═══════════════════════════════════════════════════════════════════════════════\n   327→  // Service Receipt - Simplified layout matching PDF\n   328→  // ═══════════════════════════════════════════════════════════════════════════════\n   329→  {\n   330→    name: \"Service Receipt\",\n   331→    type: \"SERVICE_RECEIPT\",\n   332→    visibility: \"INTERNAL\", // Staff only - requires login\n   333→    isPublic: false, // Deprecated - kept for backward compat\n   334→    publicSlug: \"service-receipt\",\n   335→    introText: null, // No intro text - clean header with dealer info\n   336→    showDealerHeader: true, // Show dealer logo + address/phone in header\n   337→    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"SOLD\", \"DELIVERED\"] },\n   338→    fields: [\n   339→      // Row 1: Registration and Mileage side by side\n   340→      { label: \"REGISTRATION\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 1, vrmLookup: true, gridGroup: \"row1\", uppercase: true },\n   341→      { label: \"MILEAGE\", fieldName: \"mileage\", type: \"NUMBER\", required: true, order: 2, gridGroup: \"row1\", uppercase: true },\n   342→\n   343→      // Row 2: Make and Model side by side (auto-fill from VRM lookup)\n   344→      { label: \"MAKE\", fieldName: \"make\", type: \"TEXT\", required: false, order: 3, gridGroup: \"row2\", uppercase: true },\n   345→      { label: \"MODEL\", fieldName: \"model\", type: \"TEXT\", required: false, order: 4, gridGroup: \"row2\", uppercase: true },\n   346→\n   347→      // Work Carried Out section with checkboxes\n   348→      { label: \"WORK CARRIED OUT\", fieldName: \"_section_work\", type: \"SECTION_HEADER\", order: 10, uppercase: true },\n   349→      { label: \"OIL FILTER\", fieldName: \"oil_filter\", type: \"BOOLEAN\", required: false, order: 11, uppercase: true },\n   350→      { label: \"AIR FILTER\", fieldName: \"air_filter\", type: \"BOOLEAN\", required: false, order: 12, uppercase: true },\n   351→      { label: \"CABIN FILTER\", fieldName: \"cabin_filter\", type: \"BOOLEAN\", required: false, order: 13, uppercase: true },\n   352→      { label: \"SPARK PLUGS\", fieldName: \"spark_plugs\", type: \"BOOLEAN\", required: false, order: 14, uppercase: true },\n   353→      { label: \"PRE-DELIVERY INSPECTION\", fieldName: \"pdi_done\", type: \"BOOLEAN\", required: false, order: 15, uppercase: true },\n   354→\n   355→      // Additional Works section\n   356→      { label: \"ADDITIONAL WORKS\", fieldName: \"_section_additional\", type: \"SECTION_HEADER\", order: 20, uppercase: true },\n   357→      { label: \"ADDITIONAL WORKS\", fieldName: \"additional_works\", type: \"TEXTAREA\", required: false, order: 21, uppercase: true },\n   358→\n   359→      // Date Carried Out at the end\n   360→      { label: \"DATE CARRIED OUT\", fieldName: \"service_date\", type: \"DATE\", required: true, order: 30, uppercase: true },\n   361→    ],\n   362→  },\n   363→\n   364→  // ═══════════════════════════════════════════════════════════════════════════════\n   365→  // Warranty Claim\n   366→  // ═══════════════════════════════════════════════════════════════════════════════\n   367→  {\n   368→    name: \"Warranty Claim\",\n   369→    type: \"WARRANTY_CLAIM\",\n   370→    visibility: \"PUBLIC\", // Fully public - customers can access\n   371→    isPublic: true, // Deprecated - kept for backward compat\n   372→    publicSlug: \"warranty-claim\",\n   373→    introText: `Please fill out the form below in as much detail as possible. For more information about what is and isn't covered under your warranty please refer to page 5 of your warranty booklet.\n   374→\n   375→We will only accept one claim per submission, submitting more than once may delay your claim being processed.\n   376→\n   377→Please allow up to 48 hours for a response.\n   378→\n   379→PLEASE NOTE: ONLY THE PURCHASER OF THE VEHICLE CAN SUBMIT A CLAIM AND MUST HAVE REGISTERED THEIR WARRANTY.`,\n   380→    vrmLookup: { enabled: true, statuses: [\"SOLD\", \"DELIVERED\"] },\n   381→    termsText: `• I understand that I can use this form to report an issue however, it may not be a claimable issue.\n   382→• I understand it may take up to 48 hours to receive a response to this claim form, and not to report the issue again as this may delay the claim further.\n   383→• I understand that if I go ahead and undertake work without authorisation I am liable for the costs.`,\n   384→    fields: [\n   385→      // Section: Purchase Information\n   386→      { label: \"Purchase Information\", fieldName: \"_section_purchase\", type: \"SECTION_HEADER\", order: 1 },\n   387→      { label: \"Registration at time of purchase\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n   388→      { label: \"Purchase Date\", fieldName: \"purchase_date\", type: \"DATE\", required: true, order: 3 },\n   389→      { label: \"Vehicle Make and Model\", fieldName: \"vehicle_make_model\", type: \"TEXT\", required: false, order: 4 },\n   390→      { label: \"Exact Mileage\", fieldName: \"exact_mileage\", type: \"TEXT\", required: true, order: 5, placeholder: \"e.g. 23456\" },\n   391→\n   392→      // Section: Customer Details\n   393→      { label: \"Customer Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },\n   394→      { label: \"Customer Name\", fieldName: \"customer_name\", type: \"TEXT\", required: true, order: 11 },\n   395→      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 12 },\n   396→      { label: \"Phone Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 13, helpText: \"Please enter a valid phone number\" },\n   397→      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: true, order: 14 },\n   398→      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 15 },\n   399→      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: true, order: 16 },\n   400→      { label: \"County / State\", fieldName: \"address_county\", type: \"TEXT\", required: false, order: 17 },\n   401→      { label: \"Postcode\", fieldName: \"address_postcode\", type: \"TEXT\", required: true, order: 18 },\n   402→\n   403→      // Section: Issue Description\n   404→      { label: \"Issue Description\", fieldName: \"_section_issue\", type: \"SECTION_HEADER\", order: 20 },\n   405→      { label: \"Please describe the issue in as much detail as possible\", fieldName: \"issue_description\", type: \"TEXTAREA\", required: true, order: 21, helpText: \"Include any warning lights on the dashboard, noises, symptoms, when the issue occurs, etc.\" },\n   406→      { label: \"Upload Pictures / Videos\", fieldName: \"issue_media\", type: \"FILE\", required: false, order: 22, helpText: \"You can upload multiple files. Drag and drop or click to select.\" },\n   407→\n   408→      // Section: Warranty Type\n   409→      { label: \"Warranty Information\", fieldName: \"_section_warranty\", type: \"SECTION_HEADER\", order: 30 },\n   410→      { label: \"Warranty Type\", fieldName: \"warranty_type\", type: \"DROPDOWN\", required: true, order: 31, options: { choices: [\"Dealer Warranty\", \"External Warranty\"] }, placeholder: \"Please Select\" },\n   411→\n   412→      // Section: Terms & Conditions\n   413→      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n   414→      { label: \"I agree and I have read the terms and condition details above.\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n   415→    ],\n   416→  },\n   417→\n   418→  // ═══════════════════════════════════════════════════════════════════════════════\n   419→  // Review & Feedback\n   420→  // ═══════════════════════════════════════════════════════════════════════════════\n   421→  {\n   422→    name: \"Review & Feedback\",\n   423→    type: \"REVIEW_FEEDBACK\",\n   424→    visibility: \"PUBLIC\", // Fully public - customers can access\n   425→    isPublic: true, // Deprecated - kept for backward compat\n   426→    publicSlug: \"review\",\n   427→    introText: \"We'd love to hear about your experience! Your feedback helps us improve our service.\",\n   428→    fields: [\n   429→      { label: \"Your Name\", fieldName: \"name\", type: \"TEXT\", required: true, order: 1 },\n   430→      { label: \"Email (optional)\", fieldName: \"email\", type: \"TEXT\", required: false, order: 2 },\n   431→      { label: \"Overall Rating\", fieldName: \"rating\", type: \"RATING\", required: true, order: 3 },\n   432→      { label: \"What did we do well?\", fieldName: \"positive_feedback\", type: \"TEXTAREA\", required: false, order: 4 },\n   433→      { label: \"What could we improve?\", fieldName: \"improvement_feedback\", type: \"TEXTAREA\", required: false, order: 5 },\n   434→      { label: \"Would you recommend us to friends and family?\", fieldName: \"would_recommend\", type: \"RADIO\", required: true, order: 6, options: { choices: [\"Definitely\", \"Probably\", \"Not Sure\", \"Probably Not\", \"Definitely Not\"] } },\n   435→    ],\n   436→  },\n   437→];\n   438→\n   439→// List of form types that have been deprecated and should be removed\n   440→export const DEPRECATED_FORM_TYPES = [\"CAR_PREP\", \"BUYING_APPRAISAL\", \"CUSTOMER_PX_APPRAISAL\"];\n   441→\n   442→// Valid form types (for model enum)\n   443→export const VALID_FORM_TYPES = [\"PDI\", \"TEST_DRIVE\", \"WARRANTY_CLAIM\", \"COURTESY_OUT\", \"COURTESY_IN\", \"DELIVERY\", \"SERVICE_RECEIPT\", \"REVIEW_FEEDBACK\", \"OTHER\"];\n   444→\n   445→// Default intro/terms text that can be customized per dealer\n   446→export const DEFAULT_FORM_TEXT = {\n   447→  WARRANTY_CLAIM: {\n   448→    introText: `Please fill out the form below in as much detail as possible. We will only accept one claim per submission, submitting more than once may delay your claim being processed.\n   449→\n   450→Please allow up to 48 hours for a response.`,\n   451→  },\n   452→  TEST_DRIVE: {\n   453→    termsText: `By signing this form, I confirm that:\n   454→- I hold a valid UK driving licence\n   455→- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n   456→- I will follow all road traffic laws\n   457→- I am responsible for any parking or speeding fines incurred during the test drive\n   458→- I will not allow any other person to drive the vehicle`,\n   459→  },\n   460→  COURTESY_OUT: {\n   461→    termsText: `TERMS OF USE - COURTESY VEHICLE\n   462→\n   463→1. The vehicle must be returned with the same fuel level as when collected.\n   464→2. The driver is responsible for any parking fines, speeding tickets, or congestion charges.\n   465→3. The vehicle must not be driven outside the UK.\n   466→4. Only named drivers on this form may drive the vehicle.\n   467→5. Any damage must be reported immediately.\n   468→6. The vehicle is covered by our insurance policy. Excess of £500 applies for any claims.\n   469→7. The vehicle must be returned on the agreed date unless prior arrangement is made.`,\n   470→  },\n   471→};\n   472→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"afa244da-90cc-4e22-9297-399efc0d9023","timestamp":"2025-12-30T15:45:55.057Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\libs\\formTemplates.js","content":"// Default form templates for new dealers\n// Note: Appraisal forms are handled separately in the Appraisals section\n\n// Field types available:\n// TEXT, TEXTAREA, NUMBER, DATE, TIME, DATETIME, BOOLEAN, DROPDOWN, RADIO, FILE, SIGNATURE, RATING\n// SECTION_HEADER (display only), PARAGRAPH (display only), CHECKLIST (multiple checkboxes)\n\nexport const FORM_TEMPLATES = [\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // PDI (Pre-Delivery Inspection) - Comprehensive 8-section form\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"PDI (Pre-Delivery Inspection)\",\n    type: \"PDI\",\n    visibility: \"SHARE_LINK\", // Accessible via share link for 3rd parties (workshops, MOT centres)\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"pdi\",\n    introText: \"Complete all sections of this Pre-Delivery Inspection before vehicle handover.\",\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\"] },\n    fields: [\n      // Section 1: Vehicle Info\n      { label: \"Vehicle Information\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Make\", fieldName: \"make\", type: \"TEXT\", required: true, order: 3 },\n      { label: \"Model\", fieldName: \"model\", type: \"TEXT\", required: true, order: 4 },\n      { label: \"Mileage\", fieldName: \"mileage\", type: \"NUMBER\", required: true, order: 5 },\n      { label: \"Colour\", fieldName: \"colour\", type: \"TEXT\", required: true, order: 6 },\n      { label: \"Number of Keys\", fieldName: \"num_keys\", type: \"RADIO\", required: true, order: 7, options: { choices: [\"1\", \"2\", \"3+\"] } },\n\n      // Section 2: Interior Checks\n      { label: \"Interior Checks\", fieldName: \"_section_interior\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"Seat Adjustment\", fieldName: \"seat_adjustment\", type: \"RADIO\", required: true, order: 11, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Seat Belts\", fieldName: \"seat_belts\", type: \"RADIO\", required: true, order: 12, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Sun Visor/Sunroof\", fieldName: \"sun_visor\", type: \"RADIO\", required: true, order: 13, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Glove Box\", fieldName: \"glove_box\", type: \"RADIO\", required: true, order: 14, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Windows Front/Rear\", fieldName: \"windows\", type: \"RADIO\", required: true, order: 15, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Wipers\", fieldName: \"wipers\", type: \"RADIO\", required: true, order: 16, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Washer System\", fieldName: \"washer\", type: \"RADIO\", required: true, order: 17, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Sat Nav\", fieldName: \"sat_nav\", type: \"RADIO\", required: true, order: 18, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Horn\", fieldName: \"horn\", type: \"RADIO\", required: true, order: 19, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Fuel Gauge\", fieldName: \"fuel_gauge\", type: \"RADIO\", required: true, order: 20, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Temp Gauge\", fieldName: \"temp_gauge\", type: \"RADIO\", required: true, order: 21, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Dash Lights\", fieldName: \"dash_lights\", type: \"RADIO\", required: true, order: 22, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Audio System\", fieldName: \"audio_system\", type: \"RADIO\", required: true, order: 23, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Steering Wheel Controls\", fieldName: \"steering_controls\", type: \"RADIO\", required: true, order: 24, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Rear Camera\", fieldName: \"rear_camera\", type: \"RADIO\", required: true, order: 25, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Parking Sensors Front\", fieldName: \"parking_sensors_front\", type: \"RADIO\", required: true, order: 26, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Parking Sensors Rear\", fieldName: \"parking_sensors_rear\", type: \"RADIO\", required: true, order: 27, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Clock\", fieldName: \"clock\", type: \"RADIO\", required: true, order: 28, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Steering Tilt/Lock\", fieldName: \"steering_tilt\", type: \"RADIO\", required: true, order: 29, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"12V Outlet\", fieldName: \"outlet_12v\", type: \"RADIO\", required: true, order: 30, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Mirrors\", fieldName: \"mirrors\", type: \"RADIO\", required: true, order: 31, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Heated Seats\", fieldName: \"heated_seats\", type: \"RADIO\", required: true, order: 32, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Air Conditioning\", fieldName: \"air_con\", type: \"RADIO\", required: true, order: 33, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Key Fobs Working\", fieldName: \"key_fobs\", type: \"RADIO\", required: true, order: 34, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n\n      // Section 3: Equipment\n      { label: \"Equipment Checks\", fieldName: \"_section_equipment\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"Jack & Wrench\", fieldName: \"jack_wrench\", type: \"RADIO\", required: true, order: 41, options: { choices: [\"Present\", \"Missing\", \"N/A\"] } },\n      { label: \"Locking Wheel Nut Location\", fieldName: \"locking_nut_location\", type: \"TEXT\", required: false, order: 42 },\n      { label: \"Parcel Shelf\", fieldName: \"parcel_shelf\", type: \"RADIO\", required: true, order: 43, options: { choices: [\"Present\", \"Missing\", \"N/A\"] } },\n\n      // Section 4: Exterior\n      { label: \"Exterior Checks\", fieldName: \"_section_exterior\", type: \"SECTION_HEADER\", order: 50 },\n      { label: \"Wiper Blades\", fieldName: \"wiper_blades\", type: \"RADIO\", required: true, order: 51, options: { choices: [\"Okay\", \"Replace\", \"N/A\"] } },\n      { label: \"Bonnet\", fieldName: \"bonnet\", type: \"RADIO\", required: true, order: 52, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Boot\", fieldName: \"boot\", type: \"RADIO\", required: true, order: 53, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Door Locks\", fieldName: \"door_locks\", type: \"RADIO\", required: true, order: 54, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Central Locking\", fieldName: \"central_locking\", type: \"RADIO\", required: true, order: 55, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Exhaust\", fieldName: \"exhaust\", type: \"RADIO\", required: true, order: 56, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Fuel Cap\", fieldName: \"fuel_cap\", type: \"RADIO\", required: true, order: 57, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Aerial\", fieldName: \"aerial\", type: \"RADIO\", required: true, order: 58, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Wing Mirrors\", fieldName: \"wing_mirrors\", type: \"RADIO\", required: true, order: 59, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Windscreen Condition\", fieldName: \"windscreen\", type: \"RADIO\", required: true, order: 60, options: { choices: [\"Okay\", \"Chip\", \"Crack\", \"Replace\"] } },\n\n      // Tyres\n      { label: \"Tyres & Wheels\", fieldName: \"_section_tyres\", type: \"SECTION_HEADER\", order: 70 },\n      { label: \"Tyre Size Front\", fieldName: \"tyre_size_front\", type: \"TEXT\", required: true, order: 71 },\n      { label: \"Tyre Size Rear\", fieldName: \"tyre_size_rear\", type: \"TEXT\", required: true, order: 72 },\n      { label: \"Runflat Tyres\", fieldName: \"runflat\", type: \"RADIO\", required: true, order: 73, options: { choices: [\"Yes\", \"No\"] } },\n      { label: \"Tyre Depth - Front Left (mm)\", fieldName: \"tyre_depth_fl\", type: \"NUMBER\", required: true, order: 74 },\n      { label: \"Tyre Depth - Front Right (mm)\", fieldName: \"tyre_depth_fr\", type: \"NUMBER\", required: true, order: 75 },\n      { label: \"Tyre Depth - Rear Left (mm)\", fieldName: \"tyre_depth_rl\", type: \"NUMBER\", required: true, order: 76 },\n      { label: \"Tyre Depth - Rear Right (mm)\", fieldName: \"tyre_depth_rr\", type: \"NUMBER\", required: true, order: 77 },\n      { label: \"Brake Pad Depth - Front Left (mm)\", fieldName: \"brake_pad_fl\", type: \"NUMBER\", required: true, order: 78 },\n      { label: \"Brake Pad Depth - Front Right (mm)\", fieldName: \"brake_pad_fr\", type: \"NUMBER\", required: true, order: 79 },\n      { label: \"Brake Pad Depth - Rear Left (mm)\", fieldName: \"brake_pad_rl\", type: \"NUMBER\", required: true, order: 80 },\n      { label: \"Brake Pad Depth - Rear Right (mm)\", fieldName: \"brake_pad_rr\", type: \"NUMBER\", required: true, order: 81 },\n      { label: \"Wheels Condition\", fieldName: \"wheels_condition\", type: \"RADIO\", required: true, order: 82, options: { choices: [\"Good\", \"Minor Damage\", \"Needs Refurb\"] } },\n      { label: \"Tyre Pressure/Valves\", fieldName: \"tyre_pressure\", type: \"RADIO\", required: true, order: 83, options: { choices: [\"Okay\", \"Adjusted\", \"Issue\"] } },\n      { label: \"Brake Discs\", fieldName: \"brake_discs\", type: \"RADIO\", required: true, order: 84, options: { choices: [\"Okay\", \"Worn\", \"Replace\"] } },\n\n      // Section 5: Lights\n      { label: \"Light Checks\", fieldName: \"_section_lights\", type: \"SECTION_HEADER\", order: 90 },\n      { label: \"Headlights\", fieldName: \"headlights\", type: \"RADIO\", required: true, order: 91, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Brake Lights\", fieldName: \"brake_lights\", type: \"RADIO\", required: true, order: 92, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Fog Lights\", fieldName: \"fog_lights\", type: \"RADIO\", required: true, order: 93, options: { choices: [\"Okay\", \"Replace Bulb\", \"N/A\"] } },\n      { label: \"Reverse Lights\", fieldName: \"reverse_lights\", type: \"RADIO\", required: true, order: 94, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Indicators\", fieldName: \"indicators\", type: \"RADIO\", required: true, order: 95, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Number Plate Lights\", fieldName: \"number_plate_lights\", type: \"RADIO\", required: true, order: 96, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Hazard Lights\", fieldName: \"hazard_lights\", type: \"RADIO\", required: true, order: 97, options: { choices: [\"Okay\", \"Repair\"] } },\n      { label: \"Interior Lights\", fieldName: \"interior_lights\", type: \"RADIO\", required: true, order: 98, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n\n      // Section 6: Road Test\n      { label: \"Road Test\", fieldName: \"_section_road_test\", type: \"SECTION_HEADER\", order: 100 },\n      { label: \"Parking Brake\", fieldName: \"parking_brake\", type: \"RADIO\", required: true, order: 101, options: { choices: [\"Okay\", \"Adjust\", \"Repair\"] } },\n      { label: \"Steering Effort\", fieldName: \"steering_effort\", type: \"RADIO\", required: true, order: 102, options: { choices: [\"Normal\", \"Heavy\", \"Light\"] } },\n      { label: \"Tracking\", fieldName: \"tracking\", type: \"RADIO\", required: true, order: 103, options: { choices: [\"Okay\", \"Needs Alignment\"] } },\n      { label: \"Cruise Control\", fieldName: \"cruise_control\", type: \"RADIO\", required: true, order: 104, options: { choices: [\"Okay\", \"Not Working\", \"N/A\"] } },\n      { label: \"Odometer Matches\", fieldName: \"odometer_matches\", type: \"RADIO\", required: true, order: 105, options: { choices: [\"Yes\", \"No\"] } },\n      { label: \"Heaters Working\", fieldName: \"heaters\", type: \"RADIO\", required: true, order: 106, options: { choices: [\"Okay\", \"Not Working\"] } },\n      { label: \"Steering Vibration\", fieldName: \"steering_vibration\", type: \"RADIO\", required: true, order: 107, options: { choices: [\"None\", \"Minor\", \"Significant\"] } },\n      { label: \"Brake Wobble\", fieldName: \"brake_wobble\", type: \"RADIO\", required: true, order: 108, options: { choices: [\"None\", \"Minor\", \"Significant\"] } },\n      { label: \"Suspension\", fieldName: \"suspension\", type: \"RADIO\", required: true, order: 109, options: { choices: [\"Okay\", \"Noisy\", \"Repair\"] } },\n      { label: \"CV Joints\", fieldName: \"cv_joints\", type: \"RADIO\", required: true, order: 110, options: { choices: [\"Okay\", \"Clicking\", \"Replace\"] } },\n      { label: \"Clutch\", fieldName: \"clutch\", type: \"RADIO\", required: true, order: 111, options: { choices: [\"Okay\", \"Slipping\", \"N/A (Auto)\"] } },\n      { label: \"Gear Change\", fieldName: \"gear_change\", type: \"RADIO\", required: true, order: 112, options: { choices: [\"OK\", \"Repair\"] } },\n\n      // Section 7: Engine\n      { label: \"Engine Checks\", fieldName: \"_section_engine\", type: \"SECTION_HEADER\", order: 120 },\n      { label: \"Oil Level\", fieldName: \"oil_level\", type: \"RADIO\", required: true, order: 121, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n      { label: \"Brake Fluid\", fieldName: \"brake_fluid\", type: \"RADIO\", required: true, order: 122, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n      { label: \"Screen Wash\", fieldName: \"screen_wash\", type: \"RADIO\", required: true, order: 123, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n      { label: \"Coolant Level\", fieldName: \"coolant_level\", type: \"RADIO\", required: true, order: 124, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n      { label: \"Power Steering Fluid\", fieldName: \"power_steering\", type: \"RADIO\", required: true, order: 125, options: { choices: [\"Okay\", \"Low\", \"N/A (Electric)\"] } },\n      { label: \"Battery Condition\", fieldName: \"battery\", type: \"RADIO\", required: true, order: 126, options: { choices: [\"Good\", \"Weak\", \"Replace\"] } },\n      { label: \"Ignition\", fieldName: \"ignition\", type: \"RADIO\", required: true, order: 127, options: { choices: [\"Okay\", \"Issue\"] } },\n      { label: \"Fuel System\", fieldName: \"fuel_system\", type: \"RADIO\", required: true, order: 128, options: { choices: [\"Okay\", \"Leak\", \"Issue\"] } },\n      { label: \"Radiator\", fieldName: \"radiator\", type: \"RADIO\", required: true, order: 129, options: { choices: [\"Okay\", \"Leak\", \"Damage\"] } },\n      { label: \"Cooling Fan\", fieldName: \"cooling_fan\", type: \"RADIO\", required: true, order: 130, options: { choices: [\"Working\", \"Not Working\"] } },\n      { label: \"DPF Soot Level\", fieldName: \"dpf_soot\", type: \"RADIO\", required: false, order: 131, options: { choices: [\"OK\", \"Repair/Replace\"] } },\n\n      // Section 8: Issues Found (structured for automation)\n      { label: \"Issues Found\", fieldName: \"_section_issues\", type: \"SECTION_HEADER\", order: 133 },\n      { label: \"Add issues that need attention. These will be automatically added to the vehicle's issue list.\", fieldName: \"_issues_help\", type: \"PARAGRAPH\", order: 134 },\n      { label: \"Issues\", fieldName: \"pdi_issues\", type: \"PDI_ISSUES\", required: false, order: 135 },\n\n      // Section 9: Sign-off\n      { label: \"Sign-off\", fieldName: \"_section_signoff\", type: \"SECTION_HEADER\", order: 140 },\n      { label: \"Notes / Recommendations\", fieldName: \"notes\", type: \"TEXTAREA\", required: false, order: 141 },\n      { label: \"Photos\", fieldName: \"photos\", type: \"FILE\", required: false, order: 142 },\n      { label: \"PDI Carried Out By\", fieldName: \"inspector_name\", type: \"TEXT\", required: true, order: 143 },\n      { label: \"Date\", fieldName: \"pdi_date\", type: \"DATE\", required: true, order: 144 },\n      { label: \"Inspector Signature\", fieldName: \"inspector_signature\", type: \"SIGNATURE\", required: true, order: 145 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Test Drive Request\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Test Drive Request\",\n    type: \"TEST_DRIVE\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"test-drive\",\n    introText: \"Please complete this form to book a test drive. You must bring your valid driving licence on the day.\",\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] },\n    termsText: `By signing this form, I confirm that:\n- I hold a valid UK driving licence\n- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n- I will follow all road traffic laws\n- I am responsible for any parking or speeding fines incurred during the test drive\n- I will not allow any other person to drive the vehicle`,\n    fields: [\n      // Test Drive Details - date defaults to today, time defaults to current time (handled in frontend)\n      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 1 },\n      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 2 },\n      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 5 },\n      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 6 },\n      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 7 },\n      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 8 },\n      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 9 },\n      { label: \"Driving Licence\", fieldName: \"_section_licence\", type: \"SECTION_HEADER\", order: 15 },\n      { label: \"Upload Driving Licence (Front)\", fieldName: \"licence_photo\", type: \"FILE\", required: true, order: 16 },\n      { label: \"Address (if different from licence)\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: false, order: 21 },\n      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22 },\n      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: false, order: 23 },\n      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: false, order: 24 },\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 31, vrmLookup: true },\n      // Make and Model are hidden when vehicle is selected from stock (handled in frontend)\n      { label: \"Vehicle Make\", fieldName: \"vehicle_make\", type: \"TEXT\", required: false, order: 32, hiddenWhenStockSelected: true },\n      { label: \"Vehicle Model\", fieldName: \"vehicle_model\", type: \"TEXT\", required: false, order: 33, hiddenWhenStockSelected: true },\n      { label: \"Where did you find this vehicle?\", fieldName: \"source\", type: \"DROPDOWN\", required: true, order: 35, options: { choices: [\"AutoTrader\", \"eBay\", \"Facebook\", \"Google\", \"Referral\", \"Walk-in\", \"Other\"] } },\n      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"I agree to the Terms & Conditions\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n      { label: \"Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 42 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Courtesy Car Out\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Courtesy Car Out\",\n    type: \"COURTESY_OUT\",\n    visibility: \"INTERNAL\", // Staff only - requires login\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"courtesy-out\",\n    introText: \"Complete this form when issuing a courtesy vehicle to a customer.\",\n    vrmLookup: { enabled: true, statuses: [\"COURTESY\"], vehicleType: \"COURTESY\" },\n    termsText: `TERMS OF USE - COURTESY VEHICLE\n\n1. The vehicle must be returned with the same fuel level as when collected.\n2. The driver is responsible for any parking fines, speeding tickets, or congestion charges.\n3. The vehicle must not be driven outside the UK.\n4. Only named drivers on this form may drive the vehicle.\n5. Any damage must be reported immediately to {dealer.companyName}.\n6. The vehicle is covered by our insurance policy. Excess of £500 applies for any claims.\n7. The vehicle must be returned on the agreed date unless prior arrangement is made.\n\nFor emergencies, contact: {dealer.companyPhone}`,\n    fields: [\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Courtesy Vehicle Registration\", fieldName: \"courtesy_vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Current Mileage\", fieldName: \"mileage_out\", type: \"NUMBER\", required: true, order: 3 },\n      { label: \"Date/Time Out\", fieldName: \"datetime_out\", type: \"DATETIME\", required: true, order: 4 },\n      { label: \"Expected Return Date\", fieldName: \"date_due_back\", type: \"DATE\", required: true, order: 5 },\n      { label: \"Fuel Level\", fieldName: \"fuel_out\", type: \"RADIO\", required: true, order: 6, options: { choices: [\"Empty\", \"1/4\", \"1/2\", \"3/4\", \"Full\"] } },\n      { label: \"Customer Vehicle Registration\", fieldName: \"customer_vehicle_reg\", type: \"TEXT\", required: false, order: 7, placeholder: \"Customer's vehicle being repaired (if applicable)\" },\n\n      { label: \"Driver Information\", fieldName: \"_section_driver\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"First Name\", fieldName: \"driver_first_name\", type: \"TEXT\", required: true, order: 11 },\n      { label: \"Last Name\", fieldName: \"driver_last_name\", type: \"TEXT\", required: true, order: 12 },\n      { label: \"Mobile Number\", fieldName: \"driver_phone\", type: \"TEXT\", required: true, order: 13 },\n      { label: \"Date of Birth\", fieldName: \"driver_dob\", type: \"DATE\", required: true, order: 14 },\n      { label: \"Street Address\", fieldName: \"driver_address_street\", type: \"TEXT\", required: true, order: 15 },\n      { label: \"City\", fieldName: \"driver_address_city\", type: \"TEXT\", required: true, order: 16 },\n      { label: \"County\", fieldName: \"driver_address_county\", type: \"TEXT\", required: false, order: 17 },\n      { label: \"Post Code\", fieldName: \"driver_address_postcode\", type: \"TEXT\", required: true, order: 18 },\n\n      { label: \"Additional Driver (Optional)\", fieldName: \"_section_additional\", type: \"SECTION_HEADER\", order: 25 },\n      { label: \"Additional Driver Name\", fieldName: \"additional_driver_name\", type: \"TEXT\", required: false, order: 26 },\n      { label: \"Additional Driver Mobile\", fieldName: \"additional_driver_phone\", type: \"TEXT\", required: false, order: 27 },\n      { label: \"Additional Driver DOB\", fieldName: \"additional_driver_dob\", type: \"DATE\", required: false, order: 28 },\n\n      { label: \"Documents\", fieldName: \"_section_docs\", type: \"SECTION_HEADER\", order: 35 },\n      { label: \"Upload Driving Licence (Front & Back)\", fieldName: \"licence_photos\", type: \"FILE\", required: true, order: 36 },\n\n      { label: \"Condition Report\", fieldName: \"_section_condition\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"Existing Damage Notes\", fieldName: \"existing_damage\", type: \"TEXTAREA\", required: false, order: 41, placeholder: \"Note any existing scratches, dents, etc.\" },\n      { label: \"Condition Photos\", fieldName: \"condition_photos\", type: \"FILE\", required: false, order: 42 },\n\n      { label: \"Agreement\", fieldName: \"_section_agreement\", type: \"SECTION_HEADER\", order: 50 },\n      { label: \"I have read and agree to the terms of use\", fieldName: \"terms_accepted\", type: \"BOOLEAN\", required: true, order: 51 },\n      { label: \"I confirm the fuel level and mileage are correct\", fieldName: \"confirm_details\", type: \"BOOLEAN\", required: true, order: 52 },\n      { label: \"Driver Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 53 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Courtesy Car Return\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Courtesy Car Return\",\n    type: \"COURTESY_IN\",\n    visibility: \"INTERNAL\", // Staff only - requires login\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"courtesy-in\",\n    introText: \"Complete this form when a courtesy vehicle is returned.\",\n    vrmLookup: { enabled: true, statuses: [\"COURTESY\"], vehicleType: \"COURTESY\" },\n    fields: [\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Courtesy Vehicle Registration\", fieldName: \"courtesy_vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Date/Time Returned\", fieldName: \"datetime_returned\", type: \"DATETIME\", required: true, order: 3 },\n      { label: \"Mileage In\", fieldName: \"mileage_in\", type: \"NUMBER\", required: true, order: 4 },\n      { label: \"Fuel Level\", fieldName: \"fuel_in\", type: \"RADIO\", required: true, order: 5, options: { choices: [\"Empty\", \"1/4\", \"1/2\", \"3/4\", \"Full\"] } },\n      { label: \"Customer Vehicle Registration\", fieldName: \"customer_vehicle_reg\", type: \"TEXT\", required: false, order: 6, placeholder: \"Customer's vehicle being repaired (if applicable)\" },\n\n      { label: \"Driver Information\", fieldName: \"_section_driver\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"Driver Name\", fieldName: \"driver_name\", type: \"TEXT\", required: true, order: 11 },\n\n      { label: \"Return Condition\", fieldName: \"_section_condition\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Vehicle returned clean\", fieldName: \"returned_clean\", type: \"BOOLEAN\", required: true, order: 21 },\n      { label: \"No new damage\", fieldName: \"no_new_damage\", type: \"BOOLEAN\", required: true, order: 22 },\n      { label: \"All belongings removed\", fieldName: \"belongings_removed\", type: \"BOOLEAN\", required: true, order: 23 },\n      { label: \"Fuel level acceptable\", fieldName: \"fuel_acceptable\", type: \"BOOLEAN\", required: true, order: 24 },\n\n      { label: \"Issues / Disclosure\", fieldName: \"_section_issues\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Any damage or issues to report?\", fieldName: \"issues_notes\", type: \"TEXTAREA\", required: false, order: 31 },\n      { label: \"Damage Photos\", fieldName: \"damage_photos\", type: \"FILE\", required: false, order: 32 },\n\n      { label: \"Sign-off\", fieldName: \"_section_signoff\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"Driver Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 41 },\n      { label: \"Staff Member Name\", fieldName: \"staff_name\", type: \"TEXT\", required: true, order: 42 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Delivery Form\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Vehicle Delivery\",\n    type: \"DELIVERY\",\n    visibility: \"SHARE_LINK\", // Accessible via share link for 3rd parties (delivery drivers)\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"delivery\",\n    introText: \"Complete this form when handing over a vehicle to the customer.\",\n    vrmLookup: { enabled: true, statuses: [\"SOLD\", \"ADVERTISED\"] },\n    autoStatusChange: { newStatus: \"DELIVERED\" },\n    fields: [\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Date\", fieldName: \"delivery_date\", type: \"DATE\", required: true, order: 3 },\n      { label: \"Time\", fieldName: \"delivery_time\", type: \"TIME\", required: true, order: 4 },\n\n      { label: \"Customer Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"Customer First Name\", fieldName: \"customer_first_name\", type: \"TEXT\", required: true, order: 11 },\n      { label: \"Customer Last Name\", fieldName: \"customer_last_name\", type: \"TEXT\", required: true, order: 12 },\n\n      { label: \"Documentation\", fieldName: \"_section_docs\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Photo of Invoice with ID\", fieldName: \"invoice_id_photo\", type: \"FILE\", required: true, order: 21 },\n      { label: \"Photo of Customer with Vehicle\", fieldName: \"customer_vehicle_photo\", type: \"FILE\", required: true, order: 22 },\n\n      { label: \"Consent\", fieldName: \"_section_consent\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Do you consent for the delivery photo to be used on our website/social media?\", fieldName: \"photo_consent\", type: \"RADIO\", required: true, order: 31, options: { choices: [\"Yes\", \"No\"] } },\n\n      { label: \"Sign-off\", fieldName: \"_section_signoff\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"Customer Signature\", fieldName: \"customer_signature\", type: \"SIGNATURE\", required: true, order: 41 },\n      { label: \"Staff Member Name\", fieldName: \"staff_name\", type: \"TEXT\", required: true, order: 42 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Service Receipt - Simplified layout matching PDF\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Service Receipt\",\n    type: \"SERVICE_RECEIPT\",\n    visibility: \"INTERNAL\", // Staff only - requires login\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"service-receipt\",\n    introText: null, // No intro text - clean header with dealer info\n    showDealerHeader: true, // Show dealer logo + address/phone in header\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"SOLD\", \"DELIVERED\"] },\n    fields: [\n      // Row 1: Registration and Mileage side by side\n      { label: \"REGISTRATION\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 1, vrmLookup: true, gridGroup: \"row1\", uppercase: true },\n      { label: \"MILEAGE\", fieldName: \"mileage\", type: \"NUMBER\", required: true, order: 2, gridGroup: \"row1\", uppercase: true },\n\n      // Row 2: Make and Model side by side (auto-fill from VRM lookup)\n      { label: \"MAKE\", fieldName: \"make\", type: \"TEXT\", required: false, order: 3, gridGroup: \"row2\", uppercase: true },\n      { label: \"MODEL\", fieldName: \"model\", type: \"TEXT\", required: false, order: 4, gridGroup: \"row2\", uppercase: true },\n\n      // Work Carried Out section with checkboxes\n      { label: \"WORK CARRIED OUT\", fieldName: \"_section_work\", type: \"SECTION_HEADER\", order: 10, uppercase: true },\n      { label: \"OIL FILTER\", fieldName: \"oil_filter\", type: \"BOOLEAN\", required: false, order: 11, uppercase: true },\n      { label: \"AIR FILTER\", fieldName: \"air_filter\", type: \"BOOLEAN\", required: false, order: 12, uppercase: true },\n      { label: \"CABIN FILTER\", fieldName: \"cabin_filter\", type: \"BOOLEAN\", required: false, order: 13, uppercase: true },\n      { label: \"SPARK PLUGS\", fieldName: \"spark_plugs\", type: \"BOOLEAN\", required: false, order: 14, uppercase: true },\n      { label: \"PRE-DELIVERY INSPECTION\", fieldName: \"pdi_done\", type: \"BOOLEAN\", required: false, order: 15, uppercase: true },\n\n      // Additional Works section\n      { label: \"ADDITIONAL WORKS\", fieldName: \"_section_additional\", type: \"SECTION_HEADER\", order: 20, uppercase: true },\n      { label: \"ADDITIONAL WORKS\", fieldName: \"additional_works\", type: \"TEXTAREA\", required: false, order: 21, uppercase: true },\n\n      // Date Carried Out at the end\n      { label: \"DATE CARRIED OUT\", fieldName: \"service_date\", type: \"DATE\", required: true, order: 30, uppercase: true },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Warranty Claim\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Warranty Claim\",\n    type: \"WARRANTY_CLAIM\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"warranty-claim\",\n    introText: `Please fill out the form below in as much detail as possible. For more information about what is and isn't covered under your warranty please refer to page 5 of your warranty booklet.\n\nWe will only accept one claim per submission, submitting more than once may delay your claim being processed.\n\nPlease allow up to 48 hours for a response.\n\nPLEASE NOTE: ONLY THE PURCHASER OF THE VEHICLE CAN SUBMIT A CLAIM AND MUST HAVE REGISTERED THEIR WARRANTY.`,\n    vrmLookup: { enabled: true, statuses: [\"SOLD\", \"DELIVERED\"] },\n    termsText: `• I understand that I can use this form to report an issue however, it may not be a claimable issue.\n• I understand it may take up to 48 hours to receive a response to this claim form, and not to report the issue again as this may delay the claim further.\n• I understand that if I go ahead and undertake work without authorisation I am liable for the costs.`,\n    fields: [\n      // Section: Purchase Information\n      { label: \"Purchase Information\", fieldName: \"_section_purchase\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Registration at time of purchase\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Purchase Date\", fieldName: \"purchase_date\", type: \"DATE\", required: true, order: 3 },\n      { label: \"Vehicle Make and Model\", fieldName: \"vehicle_make_model\", type: \"TEXT\", required: false, order: 4 },\n      { label: \"Exact Mileage\", fieldName: \"exact_mileage\", type: \"TEXT\", required: true, order: 5, placeholder: \"e.g. 23456\" },\n\n      // Section: Customer Details\n      { label: \"Customer Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"Customer Name\", fieldName: \"customer_name\", type: \"TEXT\", required: true, order: 11 },\n      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 12 },\n      { label: \"Phone Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 13, helpText: \"Please enter a valid phone number\" },\n      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: true, order: 14 },\n      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 15 },\n      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: true, order: 16 },\n      { label: \"County / State\", fieldName: \"address_county\", type: \"TEXT\", required: false, order: 17 },\n      { label: \"Postcode\", fieldName: \"address_postcode\", type: \"TEXT\", required: true, order: 18 },\n\n      // Section: Issue Description\n      { label: \"Issue Description\", fieldName: \"_section_issue\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Please describe the issue in as much detail as possible\", fieldName: \"issue_description\", type: \"TEXTAREA\", required: true, order: 21, helpText: \"Include any warning lights on the dashboard, noises, symptoms, when the issue occurs, etc.\" },\n      { label: \"Upload Pictures / Videos\", fieldName: \"issue_media\", type: \"FILE\", required: false, order: 22, helpText: \"You can upload multiple files. Drag and drop or click to select.\" },\n\n      // Section: Warranty Type\n      { label: \"Warranty Information\", fieldName: \"_section_warranty\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Warranty Type\", fieldName: \"warranty_type\", type: \"DROPDOWN\", required: true, order: 31, options: { choices: [\"Dealer Warranty\", \"External Warranty\"] }, placeholder: \"Please Select\" },\n\n      // Section: Terms & Conditions\n      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"I agree and I have read the terms and condition details above.\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Review & Feedback\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Review & Feedback\",\n    type: \"REVIEW_FEEDBACK\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"review\",\n    introText: \"We'd love to hear about your experience! Your feedback helps us improve our service.\",\n    fields: [\n      { label: \"Your Name\", fieldName: \"name\", type: \"TEXT\", required: true, order: 1 },\n      { label: \"Email (optional)\", fieldName: \"email\", type: \"TEXT\", required: false, order: 2 },\n      { label: \"Overall Rating\", fieldName: \"rating\", type: \"RATING\", required: true, order: 3 },\n      { label: \"What did we do well?\", fieldName: \"positive_feedback\", type: \"TEXTAREA\", required: false, order: 4 },\n      { label: \"What could we improve?\", fieldName: \"improvement_feedback\", type: \"TEXTAREA\", required: false, order: 5 },\n      { label: \"Would you recommend us to friends and family?\", fieldName: \"would_recommend\", type: \"RADIO\", required: true, order: 6, options: { choices: [\"Definitely\", \"Probably\", \"Not Sure\", \"Probably Not\", \"Definitely Not\"] } },\n    ],\n  },\n];\n\n// List of form types that have been deprecated and should be removed\nexport const DEPRECATED_FORM_TYPES = [\"CAR_PREP\", \"BUYING_APPRAISAL\", \"CUSTOMER_PX_APPRAISAL\"];\n\n// Valid form types (for model enum)\nexport const VALID_FORM_TYPES = [\"PDI\", \"TEST_DRIVE\", \"WARRANTY_CLAIM\", \"COURTESY_OUT\", \"COURTESY_IN\", \"DELIVERY\", \"SERVICE_RECEIPT\", \"REVIEW_FEEDBACK\", \"OTHER\"];\n\n// Default intro/terms text that can be customized per dealer\nexport const DEFAULT_FORM_TEXT = {\n  WARRANTY_CLAIM: {\n    introText: `Please fill out the form below in as much detail as possible. We will only accept one claim per submission, submitting more than once may delay your claim being processed.\n\nPlease allow up to 48 hours for a response.`,\n  },\n  TEST_DRIVE: {\n    termsText: `By signing this form, I confirm that:\n- I hold a valid UK driving licence\n- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n- I will follow all road traffic laws\n- I am responsible for any parking or speeding fines incurred during the test drive\n- I will not allow any other person to drive the vehicle`,\n  },\n  COURTESY_OUT: {\n    termsText: `TERMS OF USE - COURTESY VEHICLE\n\n1. The vehicle must be returned with the same fuel level as when collected.\n2. The driver is responsible for any parking fines, speeding tickets, or congestion charges.\n3. The vehicle must not be driven outside the UK.\n4. Only named drivers on this form may drive the vehicle.\n5. Any damage must be reported immediately.\n6. The vehicle is covered by our insurance policy. Excess of £500 applies for any claims.\n7. The vehicle must be returned on the agreed date unless prior arrangement is made.`,\n  },\n};\n","numLines":472,"startLine":1,"totalLines":472}}}
{"parentUuid":"afa244da-90cc-4e22-9297-399efc0d9023","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XUj4ucMKGPWQP6KW2UtoQz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a good understanding of the codebase. Let me look at the sales-prep page to see how vehicles are added, and look at a couple AI API endpoints to understand the error handling:","signature":"EuMCCkYICxgCKkBvmjBwHuRdtLYtkDGTQMVaAjkzrGkGPeJDTaa+TLDuteFTa5zUWZIlDNQ5tBhROj76j6v+lyIvAwXm9gPSTB71Egwr6YWdGwP2l/10hBUaDIQeMHRKNh3/vgCRbiIwCyk1AUrgL2ElF+/WqzqRUug1w8QtVqk/e729KI3LydSQbi7ndJ49imyHz9+ZHHpJKsoB6Dtdcf3v1/LHHaQyAgz7XXPCxJJXRBhYpKoS3ytNS8lj4U9KPgr+W/9sWU8BxHlIXm2QrsQ+hcEyHnBpGjVptwlDpdszIlMeeBe4CNULTm+OvjzN0luHAOqIEkqhYMpGn3L1pS7yJaWZi4nde/qnUawsayz5YBQpV6ZBmKAPE163wq5tSFqI3spiEE25DTxdOhQgpOB2ALwEnDEqD/u+VjJQ77CNpxs4DhjEUHy1WNozTTUM9n5TnvgVcOM8R/4T5BnIBTiw8vuWYBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":87,"cache_creation_input_tokens":21927,"cache_read_input_tokens":40121,"cache_creation":{"ephemeral_5m_input_tokens":21927,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8a29y1QMbvHhNmtgMN","type":"assistant","uuid":"19bb55b9-7335-48d4-a1e4-0b757febfe46","timestamp":"2025-12-30T15:46:01.286Z"}
{"parentUuid":"19bb55b9-7335-48d4-a1e4-0b757febfe46","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XUj4ucMKGPWQP6KW2UtoQz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_017PJSM6D63fovUuimShMrWF","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":87,"cache_creation_input_tokens":21927,"cache_read_input_tokens":40121,"cache_creation":{"ephemeral_5m_input_tokens":21927,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8a29y1QMbvHhNmtgMN","type":"assistant","uuid":"a0d1c630-ba96-42d9-b9d7-572b96eace97","timestamp":"2025-12-30T15:46:02.348Z"}
{"parentUuid":"a0d1c630-ba96-42d9-b9d7-572b96eace97","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XUj4ucMKGPWQP6KW2UtoQz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0113fSupCyYxw3q21GP6bLeN","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-suggestions.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":87,"cache_creation_input_tokens":21927,"cache_read_input_tokens":40121,"cache_creation":{"ephemeral_5m_input_tokens":21927,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8a29y1QMbvHhNmtgMN","type":"assistant","uuid":"105760e5-60b2-4c2a-a93d-df97ee82411f","timestamp":"2025-12-30T15:46:03.407Z"}
{"parentUuid":"105760e5-60b2-4c2a-a93d-df97ee82411f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XUj4ucMKGPWQP6KW2UtoQz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JEx5sNGUz8Jibn1utLgWHt","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\appraisals\\index.js","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":87,"cache_creation_input_tokens":21927,"cache_read_input_tokens":40121,"cache_creation":{"ephemeral_5m_input_tokens":21927,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8a29y1QMbvHhNmtgMN","type":"assistant","uuid":"2dc8ee32-d083-4cde-b376-05b3f091b30c","timestamp":"2025-12-30T15:46:04.028Z"}
{"parentUuid":"2dc8ee32-d083-4cde-b376-05b3f091b30c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_017PJSM6D63fovUuimShMrWF","type":"tool_result","content":"     1→import { useEffect, useState, useRef, useCallback } from \"react\";\n     2→import Head from \"next/head\";\n     3→import Link from \"next/link\";\n     4→import DashboardLayout from \"@/components/DashboardLayout\";\n     5→import { toast } from \"react-hot-toast\";\n     6→import { showDummyNotification } from \"@/utils/notifications\";\n     7→import { BottomSheet } from \"@/components/ui/BottomSheet\";\n     8→import { Portal } from \"@/components/ui/Portal\";\n     9→import { MobileStageSelector } from \"@/components/ui/PageShell\";\n    10→\n    11→const COLUMNS = [\n    12→  { key: \"in_stock\", label: \"In Stock\", gradient: \"from-orange-100/60\", accent: \"border-l-orange-400\", accentBg: \"bg-orange-400\" },\n    13→  { key: \"in_prep\", label: \"Advertised\", gradient: \"from-blue-100/60\", accent: \"border-l-blue-400\", accentBg: \"bg-blue-400\" },\n    14→  { key: \"live\", label: \"Sold In Progress\", gradient: \"from-cyan-100/60\", accent: \"border-l-cyan-400\", accentBg: \"bg-cyan-400\" },\n    15→  { key: \"reserved\", label: \"Completed\", gradient: \"from-emerald-100/60\", accent: \"border-l-emerald-400\", accentBg: \"bg-emerald-400\" },\n    16→  { key: \"delivered\", label: \"Delivered\", gradient: \"from-teal-100/60\", accent: \"border-l-teal-400\", accentBg: \"bg-teal-400\" },\n    17→];\n    18→\n    19→const ISSUE_SUBCATEGORIES = {\n    20→  mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n    21→  electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n    22→  bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n    23→  interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n    24→  tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n    25→  mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n    26→  service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n    27→  fault_codes: [\"Engine\", \"Transmission\", \"ABS\", \"Airbag\", \"Emissions\", \"Other\"],\n    28→  other: [\"General\", \"Misc\"],\n    29→};\n    30→\n    31→// Sold statuses - these show \"Sold X days\" instead of \"In stock X days\"\n    32→const SOLD_STATUSES = [\"live\", \"reserved\", \"delivered\"];\n    33→\n    34→// Helper to compute duration label based on status\n    35→const getVehicleDuration = (vehicle) => {\n    36→  const isSold = SOLD_STATUSES.includes(vehicle.status);\n    37→\n    38→  if (isSold) {\n    39→    if (vehicle.soldAt) {\n    40→      const daysSold = Math.floor((Date.now() - new Date(vehicle.soldAt).getTime()) / (1000 * 60 * 60 * 24));\n    41→      return { days: daysSold, label: `Sold ${daysSold}d`, isSold: true };\n    42→    }\n    43→    // Legacy sold vehicle without soldAt - just show \"Sold\"\n    44→    return { days: 0, label: \"Sold\", isSold: true };\n    45→  }\n    46→\n    47→  const daysInStock = vehicle.createdAt\n    48→    ? Math.floor((Date.now() - new Date(vehicle.createdAt).getTime()) / (1000 * 60 * 60 * 24))\n    49→    : 0;\n    50→  return { days: daysInStock, label: `${daysInStock}d in stock`, isSold: false };\n    51→};\n    52→\n    53→export default function SalesPrep() {\n    54→  const [vehicles, setVehicles] = useState([]);\n    55→  const [isLoading, setIsLoading] = useState(true);\n    56→  const [selectedVehicle, setSelectedVehicle] = useState(null);\n    57→  const [isLookingUpDrawer, setIsLookingUpDrawer] = useState(false);\n    58→  const [showAddModal, setShowAddModal] = useState(false);\n    59→  const [draggedCard, setDraggedCard] = useState(null);\n    60→  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });\n    61→  const [newTaskName, setNewTaskName] = useState(\"\");\n    62→  const [activeTab, setActiveTab] = useState(\"overview\");\n    63→  const [editingTaskId, setEditingTaskId] = useState(null);\n    64→  const [editingTaskName, setEditingTaskName] = useState(\"\");\n    65→\n    66→  // Parts ordering state\n    67→  const [showPartsOrderModal, setShowPartsOrderModal] = useState(false);\n    68→  const [partsOrderTaskId, setPartsOrderTaskId] = useState(null);\n    69→  const [partsOrderForm, setPartsOrderForm] = useState({\n    70→    supplierType: \"EURO_CAR_PARTS\",\n    71→    supplierName: \"\",\n    72→    orderRef: \"\",\n    73→    expectedAt: \"\",\n    74→    notes: \"\",\n    75→  });\n    76→  const [editingPartsOrderId, setEditingPartsOrderId] = useState(null);\n    77→\n    78→  // Column sorting state\n    79→  const [columnSortOptions, setColumnSortOptions] = useState({});\n    80→\n    81→  // Job sheet share state\n    82→  const [showJobSheetModal, setShowJobSheetModal] = useState(false);\n    83→  const [jobSheetLink, setJobSheetLink] = useState(null);\n    84→  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);\n    85→\n    86→  // Prep summary share state\n    87→  const [showPrepSummaryModal, setShowPrepSummaryModal] = useState(false);\n    88→  const [prepSummaryLink, setPrepSummaryLink] = useState(null);\n    89→  const [isGeneratingPrepSummary, setIsGeneratingPrepSummary] = useState(false);\n    90→\n    91→  // Manual share fallback modal\n    92→  const [showManualShareModal, setShowManualShareModal] = useState(false);\n    93→  const [manualShareUrl, setManualShareUrl] = useState(\"\");\n    94→\n    95→  // Issues state\n    96→  const [showAddIssueModal, setShowAddIssueModal] = useState(false);\n    97→  const [editingIssue, setEditingIssue] = useState(null); // For edit mode\n    98→  const [issueForm, setIssueForm] = useState({\n    99→    category: \"\",\n   100→    subcategory: \"\",\n   101→    description: \"\",\n   102→    actionNeeded: \"\",\n   103→    priority: \"medium\",\n   104→    location: \"\",\n   105→    status: \"outstanding\",\n   106→    notes: \"\",\n   107→    photos: [],\n   108→    partsRequired: false,\n   109→    partsDetails: \"\",\n   110→  });\n   111→  const [issueUpdateContent, setIssueUpdateContent] = useState({});\n   112→  const [expandedIssues, setExpandedIssues] = useState({});\n   113→\n   114→  // Filters state - with localStorage persistence\n   115→  const [activeFilters, setActiveFilters] = useState([]);\n   116→  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);\n   117→  const filterButtonRef = useRef(null);\n   118→  const [filterPopoverPos, setFilterPopoverPos] = useState({ top: 0, right: 0 });\n   119→\n   120→  // Calculate popover position when opening\n   121→  const openFiltersDropdown = useCallback(() => {\n   122→    if (filterButtonRef.current) {\n   123→      const rect = filterButtonRef.current.getBoundingClientRect();\n   124→      const viewportHeight = window.innerHeight;\n   125→      const viewportWidth = window.innerWidth;\n   126→\n   127→      // Position below the button, aligned to right edge\n   128→      let top = rect.bottom + 8;\n   129→      let right = viewportWidth - rect.right;\n   130→\n   131→      // Ensure popover doesn't go below viewport (max 70vh height + 16px padding)\n   132→      const popoverHeight = Math.min(viewportHeight * 0.7, 600);\n   133→      if (top + popoverHeight > viewportHeight - 16) {\n   134→        top = Math.max(16, viewportHeight - popoverHeight - 16);\n   135→      }\n   136→\n   137→      // Ensure popover doesn't go off right edge\n   138→      right = Math.max(16, right);\n   139→\n   140→      setFilterPopoverPos({ top, right });\n   141→    }\n   142→    setShowFiltersDropdown(true);\n   143→  }, []);\n   144→\n   145→  // Load filters from localStorage on mount\n   146→  useEffect(() => {\n   147→    try {\n   148→      const savedFilters = localStorage.getItem(\"salesPrepFilters\");\n   149→      if (savedFilters) {\n   150→        setActiveFilters(JSON.parse(savedFilters));\n   151→      }\n   152→    } catch (e) {\n   153→      console.warn(\"Failed to load saved filters:\", e);\n   154→    }\n   155→  }, []);\n   156→\n   157→  // Save filters to localStorage when they change\n   158→  useEffect(() => {\n   159→    try {\n   160→      localStorage.setItem(\"salesPrepFilters\", JSON.stringify(activeFilters));\n   161→    } catch (e) {\n   162→      console.warn(\"Failed to save filters:\", e);\n   163→    }\n   164→  }, [activeFilters]);\n   165→\n   166→  // Documents state\n   167→  const [showAddDocumentModal, setShowAddDocumentModal] = useState(false);\n   168→  const [documentForm, setDocumentForm] = useState({\n   169→    name: \"\",\n   170→    type: \"other\",\n   171→    file: null,\n   172→  });\n   173→\n   174→  // Location state\n   175→  const [locations, setLocations] = useState([]);\n   176→  const [showAddLocationModal, setShowAddLocationModal] = useState(false);\n   177→\n   178→  // Vehicle Labels state\n   179→  const [availableLabels, setAvailableLabels] = useState([]);\n   180→  const [showLabelsDropdown, setShowLabelsDropdown] = useState(false);\n   181→  const [showAddLabelModal, setShowAddLabelModal] = useState(false);\n   182→  const [newLabelForm, setNewLabelForm] = useState({ name: \"\", colour: \"#6366f1\" });\n   183→\n   184→  // Activity log state\n   185→  const [activityData, setActivityData] = useState({ activities: [], total: 0, hasMore: false });\n   186→  const [activityLoading, setActivityLoading] = useState(false);\n   187→\n   188→  // VRM Search state\n   189→  const [vrmSearch, setVrmSearch] = useState(\"\");\n   190→  const [showVrmDropdown, setShowVrmDropdown] = useState(false);\n   191→\n   192→  // Mobile state\n   193→  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"in_stock\");\n   194→\n   195→  useEffect(() => {\n   196→    fetchVehicles();\n   197→    fetchLocations();\n   198→    fetchLabels();\n   199→  }, []);\n   200→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"cbecdb88-e0bc-4e40-9e6b-e03f6ff565e7","timestamp":"2025-12-30T15:46:09.514Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","content":"import { useEffect, useState, useRef, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport { toast } from \"react-hot-toast\";\nimport { showDummyNotification } from \"@/utils/notifications\";\nimport { BottomSheet } from \"@/components/ui/BottomSheet\";\nimport { Portal } from \"@/components/ui/Portal\";\nimport { MobileStageSelector } from \"@/components/ui/PageShell\";\n\nconst COLUMNS = [\n  { key: \"in_stock\", label: \"In Stock\", gradient: \"from-orange-100/60\", accent: \"border-l-orange-400\", accentBg: \"bg-orange-400\" },\n  { key: \"in_prep\", label: \"Advertised\", gradient: \"from-blue-100/60\", accent: \"border-l-blue-400\", accentBg: \"bg-blue-400\" },\n  { key: \"live\", label: \"Sold In Progress\", gradient: \"from-cyan-100/60\", accent: \"border-l-cyan-400\", accentBg: \"bg-cyan-400\" },\n  { key: \"reserved\", label: \"Completed\", gradient: \"from-emerald-100/60\", accent: \"border-l-emerald-400\", accentBg: \"bg-emerald-400\" },\n  { key: \"delivered\", label: \"Delivered\", gradient: \"from-teal-100/60\", accent: \"border-l-teal-400\", accentBg: \"bg-teal-400\" },\n];\n\nconst ISSUE_SUBCATEGORIES = {\n  mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n  electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n  bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n  interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n  tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n  mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n  service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n  fault_codes: [\"Engine\", \"Transmission\", \"ABS\", \"Airbag\", \"Emissions\", \"Other\"],\n  other: [\"General\", \"Misc\"],\n};\n\n// Sold statuses - these show \"Sold X days\" instead of \"In stock X days\"\nconst SOLD_STATUSES = [\"live\", \"reserved\", \"delivered\"];\n\n// Helper to compute duration label based on status\nconst getVehicleDuration = (vehicle) => {\n  const isSold = SOLD_STATUSES.includes(vehicle.status);\n\n  if (isSold) {\n    if (vehicle.soldAt) {\n      const daysSold = Math.floor((Date.now() - new Date(vehicle.soldAt).getTime()) / (1000 * 60 * 60 * 24));\n      return { days: daysSold, label: `Sold ${daysSold}d`, isSold: true };\n    }\n    // Legacy sold vehicle without soldAt - just show \"Sold\"\n    return { days: 0, label: \"Sold\", isSold: true };\n  }\n\n  const daysInStock = vehicle.createdAt\n    ? Math.floor((Date.now() - new Date(vehicle.createdAt).getTime()) / (1000 * 60 * 60 * 24))\n    : 0;\n  return { days: daysInStock, label: `${daysInStock}d in stock`, isSold: false };\n};\n\nexport default function SalesPrep() {\n  const [vehicles, setVehicles] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedVehicle, setSelectedVehicle] = useState(null);\n  const [isLookingUpDrawer, setIsLookingUpDrawer] = useState(false);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [draggedCard, setDraggedCard] = useState(null);\n  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });\n  const [newTaskName, setNewTaskName] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [editingTaskId, setEditingTaskId] = useState(null);\n  const [editingTaskName, setEditingTaskName] = useState(\"\");\n\n  // Parts ordering state\n  const [showPartsOrderModal, setShowPartsOrderModal] = useState(false);\n  const [partsOrderTaskId, setPartsOrderTaskId] = useState(null);\n  const [partsOrderForm, setPartsOrderForm] = useState({\n    supplierType: \"EURO_CAR_PARTS\",\n    supplierName: \"\",\n    orderRef: \"\",\n    expectedAt: \"\",\n    notes: \"\",\n  });\n  const [editingPartsOrderId, setEditingPartsOrderId] = useState(null);\n\n  // Column sorting state\n  const [columnSortOptions, setColumnSortOptions] = useState({});\n\n  // Job sheet share state\n  const [showJobSheetModal, setShowJobSheetModal] = useState(false);\n  const [jobSheetLink, setJobSheetLink] = useState(null);\n  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);\n\n  // Prep summary share state\n  const [showPrepSummaryModal, setShowPrepSummaryModal] = useState(false);\n  const [prepSummaryLink, setPrepSummaryLink] = useState(null);\n  const [isGeneratingPrepSummary, setIsGeneratingPrepSummary] = useState(false);\n\n  // Manual share fallback modal\n  const [showManualShareModal, setShowManualShareModal] = useState(false);\n  const [manualShareUrl, setManualShareUrl] = useState(\"\");\n\n  // Issues state\n  const [showAddIssueModal, setShowAddIssueModal] = useState(false);\n  const [editingIssue, setEditingIssue] = useState(null); // For edit mode\n  const [issueForm, setIssueForm] = useState({\n    category: \"\",\n    subcategory: \"\",\n    description: \"\",\n    actionNeeded: \"\",\n    priority: \"medium\",\n    location: \"\",\n    status: \"outstanding\",\n    notes: \"\",\n    photos: [],\n    partsRequired: false,\n    partsDetails: \"\",\n  });\n  const [issueUpdateContent, setIssueUpdateContent] = useState({});\n  const [expandedIssues, setExpandedIssues] = useState({});\n\n  // Filters state - with localStorage persistence\n  const [activeFilters, setActiveFilters] = useState([]);\n  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);\n  const filterButtonRef = useRef(null);\n  const [filterPopoverPos, setFilterPopoverPos] = useState({ top: 0, right: 0 });\n\n  // Calculate popover position when opening\n  const openFiltersDropdown = useCallback(() => {\n    if (filterButtonRef.current) {\n      const rect = filterButtonRef.current.getBoundingClientRect();\n      const viewportHeight = window.innerHeight;\n      const viewportWidth = window.innerWidth;\n\n      // Position below the button, aligned to right edge\n      let top = rect.bottom + 8;\n      let right = viewportWidth - rect.right;\n\n      // Ensure popover doesn't go below viewport (max 70vh height + 16px padding)\n      const popoverHeight = Math.min(viewportHeight * 0.7, 600);\n      if (top + popoverHeight > viewportHeight - 16) {\n        top = Math.max(16, viewportHeight - popoverHeight - 16);\n      }\n\n      // Ensure popover doesn't go off right edge\n      right = Math.max(16, right);\n\n      setFilterPopoverPos({ top, right });\n    }\n    setShowFiltersDropdown(true);\n  }, []);\n\n  // Load filters from localStorage on mount\n  useEffect(() => {\n    try {\n      const savedFilters = localStorage.getItem(\"salesPrepFilters\");\n      if (savedFilters) {\n        setActiveFilters(JSON.parse(savedFilters));\n      }\n    } catch (e) {\n      console.warn(\"Failed to load saved filters:\", e);\n    }\n  }, []);\n\n  // Save filters to localStorage when they change\n  useEffect(() => {\n    try {\n      localStorage.setItem(\"salesPrepFilters\", JSON.stringify(activeFilters));\n    } catch (e) {\n      console.warn(\"Failed to save filters:\", e);\n    }\n  }, [activeFilters]);\n\n  // Documents state\n  const [showAddDocumentModal, setShowAddDocumentModal] = useState(false);\n  const [documentForm, setDocumentForm] = useState({\n    name: \"\",\n    type: \"other\",\n    file: null,\n  });\n\n  // Location state\n  const [locations, setLocations] = useState([]);\n  const [showAddLocationModal, setShowAddLocationModal] = useState(false);\n\n  // Vehicle Labels state\n  const [availableLabels, setAvailableLabels] = useState([]);\n  const [showLabelsDropdown, setShowLabelsDropdown] = useState(false);\n  const [showAddLabelModal, setShowAddLabelModal] = useState(false);\n  const [newLabelForm, setNewLabelForm] = useState({ name: \"\", colour: \"#6366f1\" });\n\n  // Activity log state\n  const [activityData, setActivityData] = useState({ activities: [], total: 0, hasMore: false });\n  const [activityLoading, setActivityLoading] = useState(false);\n\n  // VRM Search state\n  const [vrmSearch, setVrmSearch] = useState(\"\");\n  const [showVrmDropdown, setShowVrmDropdown] = useState(false);\n\n  // Mobile state\n  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"in_stock\");\n\n  useEffect(() => {\n    fetchVehicles();\n    fetchLocations();\n    fetchLabels();\n  }, []);\n","numLines":200,"startLine":1,"totalLines":5497}}}
{"parentUuid":"cbecdb88-e0bc-4e40-9e6b-e03f6ff565e7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0113fSupCyYxw3q21GP6bLeN","type":"tool_result","content":"     1→/**\n     2→ * AI Warranty Suggestions API\n     3→ *\n     4→ * POST - Generate AI suggestions for warranty/aftercare cases\n     5→ * Returns structured JSON with diagnostic guidance\n     6→ */\n     7→\n     8→import { withDealerContext } from \"@/libs/authContext\";\n     9→import { callOpenAI, UK_DEALER_CONTEXT } from \"@/libs/openai\";\n    10→\n    11→const SYSTEM_PROMPT = `${UK_DEALER_CONTEXT}\n    12→\n    13→You are helping diagnose a warranty claim or aftercare issue. Based on the information provided, generate practical diagnostic suggestions.\n    14→\n    15→CRITICAL: You must respond with ONLY valid JSON. No markdown, no code fences, no prose outside the JSON.\n    16→The JSON must have exactly these 5 keys:\n    17→- suspected_issues: array of {title, why, urgency} where urgency is \"low\", \"med\", or \"high\"\n    18→- checks_to_run: array of {step, tools, time_estimate_mins}\n    19→- questions_for_customer: array of {question, why}\n    20→- parts_to_consider: array of {part, notes}\n    21→- safety_notes: array of {note}\n    22→\n    23→Rules:\n    24→- If you don't have enough information, populate questions_for_customer instead of guessing\n    25→- Be practical and cost-conscious (used car dealer context)\n    26→- Time estimates should be realistic workshop times\n    27→- Always include relevant safety considerations\n    28→- Maximum 5 items per array`;\n    29→\n    30→async function handler(req, res, ctx) {\n    31→  if (req.method !== \"POST\") {\n    32→    return res.status(405).json({ error: \"Method not allowed\" });\n    33→  }\n    34→\n    35→  const {\n    36→    vehicleMake,\n    37→    vehicleModel,\n    38→    vehicleYear,\n    39→    mileage,\n    40→    fuelType,\n    41→    symptomDescription,\n    42→    faultCodes,\n    43→    warrantyType,\n    44→    additionalContext,\n    45→  } = req.body;\n    46→\n    47→  if (!symptomDescription) {\n    48→    return res.status(400).json({ error: \"Symptom description is required\" });\n    49→  }\n    50→\n    51→  // Build context for AI\n    52→  const contextParts = [];\n    53→\n    54→  if (vehicleMake || vehicleModel) {\n    55→    contextParts.push(`Vehicle: ${[vehicleYear, vehicleMake, vehicleModel].filter(Boolean).join(\" \")}`);\n    56→  }\n    57→  if (mileage) {\n    58→    contextParts.push(`Mileage: ${mileage}`);\n    59→  }\n    60→  if (fuelType) {\n    61→    contextParts.push(`Fuel type: ${fuelType}`);\n    62→  }\n    63→  if (warrantyType) {\n    64→    contextParts.push(`Warranty: ${warrantyType}`);\n    65→  }\n    66→  if (faultCodes) {\n    67→    contextParts.push(`Fault codes: ${faultCodes}`);\n    68→  }\n    69→  if (additionalContext) {\n    70→    contextParts.push(`Additional info: ${additionalContext}`);\n    71→  }\n    72→\n    73→  const userPrompt = `Please analyse this warranty/aftercare issue and provide diagnostic suggestions.\n    74→\n    75→${contextParts.length > 0 ? \"VEHICLE & CONTEXT:\\n\" + contextParts.join(\"\\n\") + \"\\n\\n\" : \"\"}REPORTED SYMPTOMS:\n    76→${symptomDescription}\n    77→\n    78→Generate your response as valid JSON with the exact schema specified.`;\n    79→\n    80→  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n    81→\n    82→  if (result.isDummy) {\n    83→    return res.status(200).json({\n    84→      success: true,\n    85→      isDummy: true,\n    86→      message: result.error || \"AI not configured - showing placeholder\",\n    87→      suggestions: result.data,\n    88→    });\n    89→  }\n    90→\n    91→  return res.status(200).json({\n    92→    success: true,\n    93→    isDummy: false,\n    94→    suggestions: result.data,\n    95→  });\n    96→}\n    97→\n    98→export default withDealerContext(handler);\n    99→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"30629d08-87e5-4458-9de0-e12a120210eb","timestamp":"2025-12-30T15:46:09.515Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-suggestions.js","content":"/**\n * AI Warranty Suggestions API\n *\n * POST - Generate AI suggestions for warranty/aftercare cases\n * Returns structured JSON with diagnostic guidance\n */\n\nimport { withDealerContext } from \"@/libs/authContext\";\nimport { callOpenAI, UK_DEALER_CONTEXT } from \"@/libs/openai\";\n\nconst SYSTEM_PROMPT = `${UK_DEALER_CONTEXT}\n\nYou are helping diagnose a warranty claim or aftercare issue. Based on the information provided, generate practical diagnostic suggestions.\n\nCRITICAL: You must respond with ONLY valid JSON. No markdown, no code fences, no prose outside the JSON.\nThe JSON must have exactly these 5 keys:\n- suspected_issues: array of {title, why, urgency} where urgency is \"low\", \"med\", or \"high\"\n- checks_to_run: array of {step, tools, time_estimate_mins}\n- questions_for_customer: array of {question, why}\n- parts_to_consider: array of {part, notes}\n- safety_notes: array of {note}\n\nRules:\n- If you don't have enough information, populate questions_for_customer instead of guessing\n- Be practical and cost-conscious (used car dealer context)\n- Time estimates should be realistic workshop times\n- Always include relevant safety considerations\n- Maximum 5 items per array`;\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const {\n    vehicleMake,\n    vehicleModel,\n    vehicleYear,\n    mileage,\n    fuelType,\n    symptomDescription,\n    faultCodes,\n    warrantyType,\n    additionalContext,\n  } = req.body;\n\n  if (!symptomDescription) {\n    return res.status(400).json({ error: \"Symptom description is required\" });\n  }\n\n  // Build context for AI\n  const contextParts = [];\n\n  if (vehicleMake || vehicleModel) {\n    contextParts.push(`Vehicle: ${[vehicleYear, vehicleMake, vehicleModel].filter(Boolean).join(\" \")}`);\n  }\n  if (mileage) {\n    contextParts.push(`Mileage: ${mileage}`);\n  }\n  if (fuelType) {\n    contextParts.push(`Fuel type: ${fuelType}`);\n  }\n  if (warrantyType) {\n    contextParts.push(`Warranty: ${warrantyType}`);\n  }\n  if (faultCodes) {\n    contextParts.push(`Fault codes: ${faultCodes}`);\n  }\n  if (additionalContext) {\n    contextParts.push(`Additional info: ${additionalContext}`);\n  }\n\n  const userPrompt = `Please analyse this warranty/aftercare issue and provide diagnostic suggestions.\n\n${contextParts.length > 0 ? \"VEHICLE & CONTEXT:\\n\" + contextParts.join(\"\\n\") + \"\\n\\n\" : \"\"}REPORTED SYMPTOMS:\n${symptomDescription}\n\nGenerate your response as valid JSON with the exact schema specified.`;\n\n  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}\n\nexport default withDealerContext(handler);\n","numLines":99,"startLine":1,"totalLines":99}}}
{"parentUuid":"30629d08-87e5-4458-9de0-e12a120210eb","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JEx5sNGUz8Jibn1utLgWHt","type":"tool_result","content":"     1→import { useEffect, useState, useRef } from \"react\";\n     2→import Head from \"next/head\";\n     3→import Link from \"next/link\";\n     4→import { useRouter } from \"next/router\";\n     5→import DashboardLayout from \"@/components/DashboardLayout\";\n     6→import { MobileStageSelector } from \"@/components/ui/PageShell\";\n     7→import { toast } from \"react-hot-toast\";\n     8→\n     9→const STATUS_LABELS = {\n    10→  pending: \"New\",\n    11→  reviewed: \"Reviewed\",\n    12→  converted: \"Converted\",\n    13→  declined: \"Declined\",\n    14→};\n    15→\n    16→const STATUS_STYLES = {\n    17→  pending: \"bg-blue-50 text-blue-700 border-blue-100\",\n    18→  reviewed: \"bg-amber-50 text-amber-700 border-amber-100\",\n    19→  converted: \"bg-emerald-50 text-emerald-700 border-emerald-100\",\n    20→  declined: \"bg-slate-100 text-slate-500 border-slate-200\",\n    21→};\n    22→\n    23→export default function Appraisals() {\n    24→  const router = useRouter();\n    25→  const [activeTab, setActiveTab] = useState(\"all\");\n    26→  const [appraisals, setAppraisals] = useState([]);\n    27→  const [pxAppraisals, setPxAppraisals] = useState([]);\n    28→  const [isLoading, setIsLoading] = useState(true);\n    29→  const [filter, setFilter] = useState(\"all\");\n    30→  const [isConverting, setIsConverting] = useState(null);\n    31→  const [openMenuId, setOpenMenuId] = useState(null);\n    32→  const [showNewDropdown, setShowNewDropdown] = useState(false);\n    33→  const [showShareModal, setShowShareModal] = useState(false);\n    34→  const [dealerSlug, setDealerSlug] = useState(\"\");\n    35→  const [vrmSearch, setVrmSearch] = useState(\"\");\n    36→  const [showVrmSuggestions, setShowVrmSuggestions] = useState(false);\n    37→  const menuRef = useRef(null);\n    38→  const newDropdownRef = useRef(null);\n    39→  const vrmSearchRef = useRef(null);\n    40→\n    41→  useEffect(() => {\n    42→    fetchAppraisals();\n    43→    fetchPxAppraisals();\n    44→    fetchDealerInfo();\n    45→  }, [filter]);\n    46→\n    47→  // Close menus when clicking outside\n    48→  useEffect(() => {\n    49→    const handleClickOutside = (event) => {\n    50→      if (menuRef.current && !menuRef.current.contains(event.target)) {\n    51→        setOpenMenuId(null);\n    52→      }\n    53→      if (newDropdownRef.current && !newDropdownRef.current.contains(event.target)) {\n    54→        setShowNewDropdown(false);\n    55→      }\n    56→      if (vrmSearchRef.current && !vrmSearchRef.current.contains(event.target)) {\n    57→        setShowVrmSuggestions(false);\n    58→      }\n    59→    };\n    60→    document.addEventListener(\"mousedown\", handleClickOutside);\n    61→    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n    62→  }, []);\n    63→\n    64→  const fetchDealerInfo = async () => {\n    65→    try {\n    66→      const res = await fetch(\"/api/dealer\");\n    67→      if (res.ok) {\n    68→        const data = await res.json();\n    69→        setDealerSlug(data.slug || data._id || data.id);\n    70→      }\n    71→    } catch (error) {\n    72→      console.error(\"Failed to fetch dealer info\");\n    73→    }\n    74→  };\n    75→\n    76→  const fetchAppraisals = async () => {\n    77→    try {\n    78→      const res = await fetch(`/api/appraisals?decision=${filter}`);\n    79→      // Check for JSON response\n    80→      const contentType = res.headers.get(\"content-type\") || \"\";\n    81→      if (!contentType.includes(\"application/json\")) {\n    82→        console.error(\"[Appraisals] Non-JSON response:\", res.status);\n    83→        toast.error(res.status === 401 || res.status === 403 ? \"Session expired - please sign in\" : \"Failed to load appraisals\");\n    84→        setAppraisals([]);\n    85→        return;\n    86→      }\n    87→      if (!res.ok) {\n    88→        const err = await res.json();\n    89→        toast.error(err.error || \"Failed to load appraisals\");\n    90→        setAppraisals([]);\n    91→        return;\n    92→      }\n    93→      const data = await res.json();\n    94→      setAppraisals(Array.isArray(data) ? data : []);\n    95→    } catch (error) {\n    96→      console.error(\"[Appraisals] Fetch error:\", error);\n    97→      toast.error(\"Failed to load buying appraisals\");\n    98→      setAppraisals([]);\n    99→    }\n   100→  };\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0d7a20cb-5ebd-456a-9d99-0b0ae25096d8","timestamp":"2025-12-30T15:46:09.516Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\appraisals\\index.js","content":"import { useEffect, useState, useRef } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport { MobileStageSelector } from \"@/components/ui/PageShell\";\nimport { toast } from \"react-hot-toast\";\n\nconst STATUS_LABELS = {\n  pending: \"New\",\n  reviewed: \"Reviewed\",\n  converted: \"Converted\",\n  declined: \"Declined\",\n};\n\nconst STATUS_STYLES = {\n  pending: \"bg-blue-50 text-blue-700 border-blue-100\",\n  reviewed: \"bg-amber-50 text-amber-700 border-amber-100\",\n  converted: \"bg-emerald-50 text-emerald-700 border-emerald-100\",\n  declined: \"bg-slate-100 text-slate-500 border-slate-200\",\n};\n\nexport default function Appraisals() {\n  const router = useRouter();\n  const [activeTab, setActiveTab] = useState(\"all\");\n  const [appraisals, setAppraisals] = useState([]);\n  const [pxAppraisals, setPxAppraisals] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [filter, setFilter] = useState(\"all\");\n  const [isConverting, setIsConverting] = useState(null);\n  const [openMenuId, setOpenMenuId] = useState(null);\n  const [showNewDropdown, setShowNewDropdown] = useState(false);\n  const [showShareModal, setShowShareModal] = useState(false);\n  const [dealerSlug, setDealerSlug] = useState(\"\");\n  const [vrmSearch, setVrmSearch] = useState(\"\");\n  const [showVrmSuggestions, setShowVrmSuggestions] = useState(false);\n  const menuRef = useRef(null);\n  const newDropdownRef = useRef(null);\n  const vrmSearchRef = useRef(null);\n\n  useEffect(() => {\n    fetchAppraisals();\n    fetchPxAppraisals();\n    fetchDealerInfo();\n  }, [filter]);\n\n  // Close menus when clicking outside\n  useEffect(() => {\n    const handleClickOutside = (event) => {\n      if (menuRef.current && !menuRef.current.contains(event.target)) {\n        setOpenMenuId(null);\n      }\n      if (newDropdownRef.current && !newDropdownRef.current.contains(event.target)) {\n        setShowNewDropdown(false);\n      }\n      if (vrmSearchRef.current && !vrmSearchRef.current.contains(event.target)) {\n        setShowVrmSuggestions(false);\n      }\n    };\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, []);\n\n  const fetchDealerInfo = async () => {\n    try {\n      const res = await fetch(\"/api/dealer\");\n      if (res.ok) {\n        const data = await res.json();\n        setDealerSlug(data.slug || data._id || data.id);\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch dealer info\");\n    }\n  };\n\n  const fetchAppraisals = async () => {\n    try {\n      const res = await fetch(`/api/appraisals?decision=${filter}`);\n      // Check for JSON response\n      const contentType = res.headers.get(\"content-type\") || \"\";\n      if (!contentType.includes(\"application/json\")) {\n        console.error(\"[Appraisals] Non-JSON response:\", res.status);\n        toast.error(res.status === 401 || res.status === 403 ? \"Session expired - please sign in\" : \"Failed to load appraisals\");\n        setAppraisals([]);\n        return;\n      }\n      if (!res.ok) {\n        const err = await res.json();\n        toast.error(err.error || \"Failed to load appraisals\");\n        setAppraisals([]);\n        return;\n      }\n      const data = await res.json();\n      setAppraisals(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"[Appraisals] Fetch error:\", error);\n      toast.error(\"Failed to load buying appraisals\");\n      setAppraisals([]);\n    }\n  };","numLines":100,"startLine":1,"totalLines":782}}}
{"parentUuid":"0d7a20cb-5ebd-456a-9d99-0b0ae25096d8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SbgrY1eZXx9RX2zkvf8uKa","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a comprehensive understanding of the codebase. Let me also check if there's a VehicleDrawer component that handles the add vehicle modal, and look at how it's triggered in sales-prep.js. Let me search for show add modal in sales-prep.","signature":"Ep4DCkYICxgCKkA7DXaA0wWam6rnWexhDm9eyt2NPuNfX079wrzx+xavQG2348tlOsY2ycjednu4cpHnQisgfFIEk15VM1n+vQS1Egw8xNYfZbIbdQE9Tp4aDJ+wlfVhm/41pNudmSIwcZvn2hirPXBtAnz3eydhB27ioKv2u1Lrq6z1J6RImj7bFmkQ09iQcEb4DiOVbJm+KoUCH+eCdIYcQ+giKpaYfapAbwyAQyrIo8eY6d7XFh2Fx1yfqoKQJulKUn5q9KU8Tk0Hxw6Wsn56ZDH3D6TZQsNRcJ44vn4bcABEx8OfxjDbC/53NjZ2lGqDYdcQNzET4daVrl+8kirFCF0n1QkqwN3Yppy6KIvAbXqJZv69CH7OjD3n08J/4f2+Pm8rAy1Rm0mVe5l6vuur4zK5D8Xy9uyldaFa7m+eubE86LVYdIav9VGf9nYNJmApuE4TkVQSHvkzvWC+dUVDofyxK/r62sSOnNL4Ddxr/1b/R/irzWNRrhuvtYHaYsSmxn9DLlVA3VptCXdWOy8Nb20k7r+MCMRo6Tu7IyiKGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":6733,"cache_read_input_tokens":62048,"cache_creation":{"ephemeral_5m_input_tokens":6733,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8b6gbfZm6nRnfcu6Wi","type":"assistant","uuid":"c4dfa97d-4f70-4b18-abf4-9b961ded9742","timestamp":"2025-12-30T15:46:16.681Z"}
{"parentUuid":"c4dfa97d-4f70-4b18-abf4-9b961ded9742","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SbgrY1eZXx9RX2zkvf8uKa","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check where the Add Vehicle modal is triggered in sales-prep.js and look at the UI:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":6733,"cache_read_input_tokens":62048,"cache_creation":{"ephemeral_5m_input_tokens":6733,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8b6gbfZm6nRnfcu6Wi","type":"assistant","uuid":"183450b0-2ff8-4f25-9519-3b19c32ea297","timestamp":"2025-12-30T15:46:17.236Z"}
{"parentUuid":"183450b0-2ff8-4f25-9519-3b19c32ea297","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SbgrY1eZXx9RX2zkvf8uKa","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LdVixgcEiL5fqxFuf53hC9","name":"Grep","input":{"pattern":"setShowAddModal|showAddModal","path":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":6733,"cache_read_input_tokens":62048,"cache_creation":{"ephemeral_5m_input_tokens":6733,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8b6gbfZm6nRnfcu6Wi","type":"assistant","uuid":"d16b6346-b531-47d2-b2f5-f78516aab4ef","timestamp":"2025-12-30T15:46:19.112Z"}
{"parentUuid":"d16b6346-b531-47d2-b2f5-f78516aab4ef","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SbgrY1eZXx9RX2zkvf8uKa","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LvHa4EJxvRnVzNbuDhPVjm","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-issue-suggestions.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":6733,"cache_read_input_tokens":62048,"cache_creation":{"ephemeral_5m_input_tokens":6733,"ephemeral_1h_input_tokens":0},"output_tokens":280,"service_tier":"standard"}},"requestId":"req_011CWd8b6gbfZm6nRnfcu6Wi","type":"assistant","uuid":"4ff10a6c-4bf4-461d-a1f2-78d67f21478e","timestamp":"2025-12-30T15:46:20.153Z"}
{"parentUuid":"4ff10a6c-4bf4-461d-a1f2-78d67f21478e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LvHa4EJxvRnVzNbuDhPVjm","type":"tool_result","content":"     1→/**\n     2→ * AI Appraisal Issue Suggestions API\n     3→ *\n     4→ * POST - Generate AI suggestions for vehicle appraisal issues\n     5→ * Returns structured JSON with diagnostic guidance\n     6→ */\n     7→\n     8→import { withDealerContext } from \"@/libs/authContext\";\n     9→import { callOpenAI, UK_DEALER_CONTEXT } from \"@/libs/openai\";\n    10→\n    11→const SYSTEM_PROMPT = `${UK_DEALER_CONTEXT}\n    12→\n    13→You are helping assess an issue found during a vehicle appraisal (trade-in or part-exchange). Based on the information provided, generate practical investigation suggestions to help the dealer understand the scope and cost of repairs.\n    14→\n    15→CRITICAL: You must respond with ONLY valid JSON. No markdown, no code fences, no prose outside the JSON.\n    16→The JSON must have exactly these 5 keys:\n    17→- suspected_issues: array of {title, why, urgency} where urgency is \"low\", \"med\", or \"high\"\n    18→- checks_to_run: array of {step, tools, time_estimate_mins}\n    19→- questions_for_customer: array of {question, why}\n    20→- parts_to_consider: array of {part, notes}\n    21→- safety_notes: array of {note}\n    22→\n    23→Rules:\n    24→- Focus on helping the dealer make an informed purchase decision\n    25→- If you don't have enough information, populate questions_for_customer instead of guessing\n    26→- Be practical and cost-conscious (used car dealer context)\n    27→- Time estimates should be realistic workshop times\n    28→- Consider resale implications when assessing urgency\n    29→- Maximum 5 items per array`;\n    30→\n    31→async function handler(req, res, ctx) {\n    32→  if (req.method !== \"POST\") {\n    33→    return res.status(405).json({ error: \"Method not allowed\" });\n    34→  }\n    35→\n    36→  const {\n    37→    vehicleMake,\n    38→    vehicleModel,\n    39→    vehicleYear,\n    40→    mileage,\n    41→    fuelType,\n    42→    issueCategory,\n    43→    issueSubcategory,\n    44→    issueDescription,\n    45→    faultCodes,\n    46→    additionalContext,\n    47→  } = req.body;\n    48→\n    49→  if (!issueDescription) {\n    50→    return res.status(400).json({ error: \"Issue description is required\" });\n    51→  }\n    52→\n    53→  // Build context for AI\n    54→  const contextParts = [];\n    55→\n    56→  if (vehicleMake || vehicleModel) {\n    57→    contextParts.push(`Vehicle: ${[vehicleYear, vehicleMake, vehicleModel].filter(Boolean).join(\" \")}`);\n    58→  }\n    59→  if (mileage) {\n    60→    contextParts.push(`Mileage: ${mileage}`);\n    61→  }\n    62→  if (fuelType) {\n    63→    contextParts.push(`Fuel type: ${fuelType}`);\n    64→  }\n    65→  if (issueCategory) {\n    66→    const categoryInfo = issueSubcategory\n    67→      ? `${issueCategory} > ${issueSubcategory}`\n    68→      : issueCategory;\n    69→    contextParts.push(`Issue category: ${categoryInfo}`);\n    70→  }\n    71→  if (faultCodes) {\n    72→    contextParts.push(`Fault codes: ${faultCodes}`);\n    73→  }\n    74→  if (additionalContext) {\n    75→    contextParts.push(`Additional info: ${additionalContext}`);\n    76→  }\n    77→\n    78→  const userPrompt = `Please analyse this appraisal issue and provide investigation suggestions to help with the purchase decision.\n    79→\n    80→${contextParts.length > 0 ? \"VEHICLE & CONTEXT:\\n\" + contextParts.join(\"\\n\") + \"\\n\\n\" : \"\"}ISSUE FOUND:\n    81→${issueDescription}\n    82→\n    83→Generate your response as valid JSON with the exact schema specified.`;\n    84→\n    85→  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n    86→\n    87→  if (result.isDummy) {\n    88→    return res.status(200).json({\n    89→      success: true,\n    90→      isDummy: true,\n    91→      message: result.error || \"AI not configured - showing placeholder\",\n    92→      suggestions: result.data,\n    93→    });\n    94→  }\n    95→\n    96→  return res.status(200).json({\n    97→    success: true,\n    98→    isDummy: false,\n    99→    suggestions: result.data,\n   100→  });\n   101→}\n   102→\n   103→export default withDealerContext(handler);\n   104→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ec57a38a-6525-4274-975f-8a32478f90e7","timestamp":"2025-12-30T15:46:23.614Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-issue-suggestions.js","content":"/**\n * AI Appraisal Issue Suggestions API\n *\n * POST - Generate AI suggestions for vehicle appraisal issues\n * Returns structured JSON with diagnostic guidance\n */\n\nimport { withDealerContext } from \"@/libs/authContext\";\nimport { callOpenAI, UK_DEALER_CONTEXT } from \"@/libs/openai\";\n\nconst SYSTEM_PROMPT = `${UK_DEALER_CONTEXT}\n\nYou are helping assess an issue found during a vehicle appraisal (trade-in or part-exchange). Based on the information provided, generate practical investigation suggestions to help the dealer understand the scope and cost of repairs.\n\nCRITICAL: You must respond with ONLY valid JSON. No markdown, no code fences, no prose outside the JSON.\nThe JSON must have exactly these 5 keys:\n- suspected_issues: array of {title, why, urgency} where urgency is \"low\", \"med\", or \"high\"\n- checks_to_run: array of {step, tools, time_estimate_mins}\n- questions_for_customer: array of {question, why}\n- parts_to_consider: array of {part, notes}\n- safety_notes: array of {note}\n\nRules:\n- Focus on helping the dealer make an informed purchase decision\n- If you don't have enough information, populate questions_for_customer instead of guessing\n- Be practical and cost-conscious (used car dealer context)\n- Time estimates should be realistic workshop times\n- Consider resale implications when assessing urgency\n- Maximum 5 items per array`;\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const {\n    vehicleMake,\n    vehicleModel,\n    vehicleYear,\n    mileage,\n    fuelType,\n    issueCategory,\n    issueSubcategory,\n    issueDescription,\n    faultCodes,\n    additionalContext,\n  } = req.body;\n\n  if (!issueDescription) {\n    return res.status(400).json({ error: \"Issue description is required\" });\n  }\n\n  // Build context for AI\n  const contextParts = [];\n\n  if (vehicleMake || vehicleModel) {\n    contextParts.push(`Vehicle: ${[vehicleYear, vehicleMake, vehicleModel].filter(Boolean).join(\" \")}`);\n  }\n  if (mileage) {\n    contextParts.push(`Mileage: ${mileage}`);\n  }\n  if (fuelType) {\n    contextParts.push(`Fuel type: ${fuelType}`);\n  }\n  if (issueCategory) {\n    const categoryInfo = issueSubcategory\n      ? `${issueCategory} > ${issueSubcategory}`\n      : issueCategory;\n    contextParts.push(`Issue category: ${categoryInfo}`);\n  }\n  if (faultCodes) {\n    contextParts.push(`Fault codes: ${faultCodes}`);\n  }\n  if (additionalContext) {\n    contextParts.push(`Additional info: ${additionalContext}`);\n  }\n\n  const userPrompt = `Please analyse this appraisal issue and provide investigation suggestions to help with the purchase decision.\n\n${contextParts.length > 0 ? \"VEHICLE & CONTEXT:\\n\" + contextParts.join(\"\\n\") + \"\\n\\n\" : \"\"}ISSUE FOUND:\n${issueDescription}\n\nGenerate your response as valid JSON with the exact schema specified.`;\n\n  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}\n\nexport default withDealerContext(handler);\n","numLines":104,"startLine":1,"totalLines":104}}}
{"parentUuid":"ec57a38a-6525-4274-975f-8a32478f90e7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LdVixgcEiL5fqxFuf53hC9","type":"tool_result","content":"58:  const [showAddModal, setShowAddModal] = useState(false);\r\n1436:        <button className=\"btn btn-primary\" onClick={() => setShowAddModal(true)}>\r\n2183:            onClick={() => setShowAddModal(true)}\r\n3710:      {showAddModal && (\r\n3711:        <AddVehicleModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchVehicles(); }} />"}]},"uuid":"7e72cbd3-7723-41ce-9f72-b68d07d5bdfa","timestamp":"2025-12-30T15:46:23.638Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"58:  const [showAddModal, setShowAddModal] = useState(false);\r\n1436:        <button className=\"btn btn-primary\" onClick={() => setShowAddModal(true)}>\r\n2183:            onClick={() => setShowAddModal(true)}\r\n3710:      {showAddModal && (\r\n3711:        <AddVehicleModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchVehicles(); }} />","numLines":5}}
{"parentUuid":"7e72cbd3-7723-41ce-9f72-b68d07d5bdfa","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MT9r2mKveKvRsSF3YF8e7V","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a good understanding of the codebase. Let me also check the router usage to see how we can pass query params to the sales-prep page to open the add modal. Let me also check where warranty suggestions are used in the UI to understand the error handling patterns.","signature":"ErkDCkYICxgCKkCpx3botOQlL7mguvN/wqsGd88xSzhlzL/YEADq4Hq/EUEXCdCgJv0N90zQ7G20bdWANSkKdHLhyNWNfk05qCFAEgwVEaYSmAcjY7+0dTQaDGItyRMPeDHCglHSdiIwkfWj4Cqu4V1v1QH7OvBDBtHl+6HkJ8JQ3nslj9DYh9PbzpjHim7PljCV8Y7TNW6dKqACjhRriWAivEwuxiP8bjVdvRbgtcnSeefBoIwFYcQ9kq6TiLOJwXsYrm+ovTkxTEdWJRffMyIrtInAU5I+D6Yw0IzHKkkiCebXLML1/iotCaHwkCH6g2PQM/e1VVOqaoNq6gUfjUejjIa99b5ql8hmnk3Oqolu3t0SNBxX62YBL+qbwr2EjMKTzmegJdWDNHmZloDVHGTM4H2N8N9g3OtCwvhLlkICXe7Kkr6yYzELCZFWJCIx5gesxnSJwaTalZKqHHTKeIrECtDEvG9IVmJHFegGgoDC/7pfS4kShs05tgl2Xax6aA0133HNhXiv6SMRhSyskZIkAUBrtDl+6iiqVXp/ur0AFfTtGoNaqP9LaUz/2QbD+KSqOq5R8p7NSE25GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1438,"cache_creation_input_tokens":611,"cache_read_input_tokens":68781,"cache_creation":{"ephemeral_5m_input_tokens":611,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8c7SmBwtqZ94e2fRBP","type":"assistant","uuid":"184f0bfe-df37-4d1b-a8db-718a04473d89","timestamp":"2025-12-30T15:46:30.631Z"}
{"parentUuid":"184f0bfe-df37-4d1b-a8db-718a04473d89","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MT9r2mKveKvRsSF3YF8e7V","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check how query params are handled in sales-prep.js and find where the AI suggestions are displayed:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1438,"cache_creation_input_tokens":611,"cache_read_input_tokens":68781,"cache_creation":{"ephemeral_5m_input_tokens":611,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8c7SmBwtqZ94e2fRBP","type":"assistant","uuid":"a37f7cce-ccfe-49ef-b797-3afdaa0ea851","timestamp":"2025-12-30T15:46:31.456Z"}
{"parentUuid":"a37f7cce-ccfe-49ef-b797-3afdaa0ea851","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MT9r2mKveKvRsSF3YF8e7V","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FhiqFVdvXdsNwfvoGLWXEj","name":"Grep","input":{"pattern":"router\\.query|useRouter","path":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","output_mode":"content","-n":true,"-C":2}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1438,"cache_creation_input_tokens":611,"cache_read_input_tokens":68781,"cache_creation":{"ephemeral_5m_input_tokens":611,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8c7SmBwtqZ94e2fRBP","type":"assistant","uuid":"5efdf0ac-d50b-4cd1-93f4-f5f73ba2375c","timestamp":"2025-12-30T15:46:33.583Z"}
{"parentUuid":"5efdf0ac-d50b-4cd1-93f4-f5f73ba2375c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MT9r2mKveKvRsSF3YF8e7V","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FcY5iYbg1N95SQCPLzjB2X","name":"Grep","input":{"pattern":"AISuggestionsPanel|warranty-suggestions|appraisal-issue-suggestions","output_mode":"files_with_matches"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1438,"cache_creation_input_tokens":611,"cache_read_input_tokens":68781,"cache_creation":{"ephemeral_5m_input_tokens":611,"ephemeral_1h_input_tokens":0},"output_tokens":311,"service_tier":"standard"}},"requestId":"req_011CWd8c7SmBwtqZ94e2fRBP","type":"assistant","uuid":"fd66bff2-0e86-41f3-b1b6-1430a9a12a71","timestamp":"2025-12-30T15:46:34.908Z"}
{"parentUuid":"fd66bff2-0e86-41f3-b1b6-1430a9a12a71","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FhiqFVdvXdsNwfvoGLWXEj","type":"tool_result","content":"No matches found"}]},"uuid":"4803a8d5-41f9-485f-83ca-2ae56dafa197","timestamp":"2025-12-30T15:46:38.181Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0}}
{"parentUuid":"4803a8d5-41f9-485f-83ca-2ae56dafa197","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FcY5iYbg1N95SQCPLzjB2X","type":"tool_result","content":"Found 2 files\npages\\warranty.js\ncomponents\\AISuggestionsPanel.js"}]},"uuid":"6c4967bb-c188-4b69-b653-595c44607810","timestamp":"2025-12-30T15:46:38.221Z","toolUseResult":{"mode":"files_with_matches","filenames":["pages\\warranty.js","components\\AISuggestionsPanel.js"],"numFiles":2}}
{"parentUuid":"6c4967bb-c188-4b69-b653-595c44607810","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_012VSpfRKGnLzuGHn5yJUwax","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good. Now let me read the warranty.js to see how AI suggestions are used in the UI and how errors are displayed. Then I'll start implementing the fixes.","signature":"EsECCkYICxgCKkDDUDWm84nkEH2k1vh/pq5MD/UTM93CrTqQKi/QrBouqmJTifa7gZATM0fiBDt+omXdh7LFzy/zTGgnC+xBYs1uEgyWotduM4bE4YwESbIaDIAYCy40qcU+wTDEbSIw18QuQWl0o88HLUIKcB0jeuAulsR/5APhuKkYI36TIDXakyadELTiN7mb5tIItva2KqgBUd0AyFmQhFDEdVaN68uKCahKEoWe04bYQ68dJ64Cz3tbG9o7o593gZlmJ/XmMOAciaEcLaBJi0CrBma49Guy9lMLD957aC4OotGzNzR9pM7lFgqmj9Y1RGBCTzhJIdd5F8fwFuDXFB0SnZ26RrMh9Njjcih4+5BaKO82CmGfHca9113R1HJg03nQFtnKQJKroXL3N3o9cU2CygB5Knx2Yup2v9i1kaw1GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2016,"cache_read_input_tokens":69392,"cache_creation":{"ephemeral_5m_input_tokens":2016,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd8dB26nEBqfjweBnAna","type":"assistant","uuid":"08a6e50c-6157-4933-b958-74af5f728796","timestamp":"2025-12-30T15:46:43.275Z"}
{"parentUuid":"08a6e50c-6157-4933-b958-74af5f728796","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_012VSpfRKGnLzuGHn5yJUwax","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DdMCkynxzcrs9AzA1f8KiT","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2016,"cache_read_input_tokens":69392,"cache_creation":{"ephemeral_5m_input_tokens":2016,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd8dB26nEBqfjweBnAna","type":"assistant","uuid":"6ce836a6-1a8c-46eb-b27f-1946b8a79061","timestamp":"2025-12-30T15:46:44.151Z"}
{"parentUuid":"6ce836a6-1a8c-46eb-b27f-1946b8a79061","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_012VSpfRKGnLzuGHn5yJUwax","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NzHZVtibtxd6kgq9XqLAjQ","name":"Grep","input":{"pattern":"isDummy|AI|suggestions","path":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","output_mode":"content","-n":true,"-C":3}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2016,"cache_read_input_tokens":69392,"cache_creation":{"ephemeral_5m_input_tokens":2016,"ephemeral_1h_input_tokens":0},"output_tokens":252,"service_tier":"standard"}},"requestId":"req_011CWd8dB26nEBqfjweBnAna","type":"assistant","uuid":"3570d734-b3d1-408d-a899-080f59884fca","timestamp":"2025-12-30T15:46:45.638Z"}
{"parentUuid":"3570d734-b3d1-408d-a899-080f59884fca","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DdMCkynxzcrs9AzA1f8KiT","type":"tool_result","content":"     1→import { useEffect, useState, useRef } from \"react\";\n     2→import { useRouter } from \"next/router\";\n     3→import Head from \"next/head\";\n     4→import DashboardLayout from \"@/components/DashboardLayout\";\n     5→import VehicleDrawer from \"@/components/VehicleDrawer\";\n     6→import AISuggestionsPanel from \"@/components/AISuggestionsPanel\";\n     7→import { BottomSheet } from \"@/components/ui/BottomSheet\";\n     8→import { MobileStageSelector } from \"@/components/ui/PageShell\";\n     9→import { toast } from \"react-hot-toast\";\n    10→\n    11→// Column config matching Sales & Prep style\n    12→// NOTE: Internal keys are legacy names - keep stable for database compatibility\n    13→// Display labels have been updated for clarity\n    14→const COLUMNS = [\n    15→  { key: \"not_booked_in\", label: \"Not Booked In\", gradient: \"from-red-100/60\", accent: \"border-l-red-400\", accentBg: \"bg-red-400\" },\n    16→  { key: \"on_site\", label: \"Booked In\", gradient: \"from-amber-100/60\", accent: \"border-l-amber-400\", accentBg: \"bg-amber-400\" }, // Legacy key: \"on_site\" displays as \"Booked In\"\n    17→  { key: \"work_complete\", label: \"Work Complete\", gradient: \"from-blue-100/60\", accent: \"border-l-blue-400\", accentBg: \"bg-blue-400\" },\n    18→  { key: \"collected\", label: \"Closed\", gradient: \"from-emerald-100/60\", accent: \"border-l-emerald-400\", accentBg: \"bg-emerald-400\" }, // Legacy key: \"collected\" displays as \"Closed\"\n    19→];\n    20→\n    21→const PRIORITIES = {\n    22→  low: { bg: \"bg-slate-100\", text: \"text-slate-600\", border: \"border-slate-200\" },\n    23→  normal: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\" },\n    24→  high: { bg: \"bg-amber-50\", text: \"text-amber-700\", border: \"border-amber-100\" },\n    25→  critical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\" },\n    26→};\n    27→\n    28→const SOURCE_LABELS = {\n    29→  warranty_claim_form: \"Warranty Claim\",\n    30→  low_review: \"Low Review\",\n    31→  complaint_form: \"Complaint\",\n    32→  manual: \"Manual\",\n    33→};\n    34→\n    35→// Timeline event icons\n    36→const EVENT_ICONS = {\n    37→  CASE_CREATED: \"📋\",\n    38→  SUBMISSION_LINKED: \"🔗\",\n    39→  COMMENT_ADDED: \"💬\",\n    40→  STATUS_CHANGED: \"🔄\",\n    41→  AI_REVIEW_GENERATED: \"🤖\",\n    42→  ATTACHMENT_ADDED: \"📎\",\n    43→  LOCATION_UPDATED: \"📍\",\n    44→  BOOKING_UPDATED: \"📅\",\n    45→  PARTS_UPDATED: \"🔧\",\n    46→  COURTESY_REQUIRED_TOGGLED: \"🚗\",\n    47→  COURTESY_ALLOCATED: \"🚗\",\n    48→  COURTESY_RETURNED: \"🚗\",\n    49→  COURTESY_OUT_RECORDED: \"🚗\",\n    50→  COURTESY_IN_RECORDED: \"🚗\",\n    51→  // Warranty booking auto-move events\n    52→  WARRANTY_BOOKED_IN: \"📅\",\n    53→  WARRANTY_BOOKING_UPDATED: \"📅\",\n    54→  WARRANTY_BOOKING_CANCELLED: \"❌\",\n    55→  WARRANTY_STAGE_MOVED: \"🔀\",\n    56→};\n    57→\n    58→// Timeline grouping constant\n    59→const STATUS_FLIP_GROUP_WINDOW_MS = 10 * 60 * 1000; // 10 minutes\n    60→\n    61→// Group consecutive STATUS_CHANGED events within the time window\n    62→const groupTimelineEvents = (events) => {\n    63→  if (!events || events.length === 0) return [];\n    64→\n    65→  const sorted = [...events].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n    66→  const grouped = [];\n    67→  let currentGroup = null;\n    68→\n    69→  for (const event of sorted) {\n    70→    if (event.type === \"STATUS_CHANGED\") {\n    71→      if (currentGroup) {\n    72→        // Check if this event is within the time window of the last event in the group\n    73→        const lastEventTime = new Date(currentGroup.events[currentGroup.events.length - 1].createdAt).getTime();\n    74→        const thisEventTime = new Date(event.createdAt).getTime();\n    75→\n    76→        if (lastEventTime - thisEventTime <= STATUS_FLIP_GROUP_WINDOW_MS) {\n    77→          currentGroup.events.push(event);\n    78→          continue;\n    79→        } else {\n    80→          // Close current group and start new one\n    81→          grouped.push(currentGroup);\n    82→          currentGroup = { isGroup: true, type: \"STATUS_CHANGED_GROUP\", events: [event] };\n    83→        }\n    84→      } else {\n    85→        currentGroup = { isGroup: true, type: \"STATUS_CHANGED_GROUP\", events: [event] };\n    86→      }\n    87→    } else {\n    88→      // Non-status event - close any current group and add this event\n    89→      if (currentGroup) {\n    90→        grouped.push(currentGroup);\n    91→        currentGroup = null;\n    92→      }\n    93→      grouped.push(event);\n    94→    }\n    95→  }\n    96→\n    97→  // Don't forget to add the last group if exists\n    98→  if (currentGroup) {\n    99→    grouped.push(currentGroup);\n   100→  }\n   101→\n   102→  return grouped;\n   103→};\n   104→\n   105→// Repair location type labels\n   106→const REPAIR_LOCATION_LABELS = {\n   107→  WITH_CUSTOMER: \"With customer\",\n   108→  ON_SITE: \"On-site\",\n   109→  THIRD_PARTY: \"Third-party\",\n   110→};\n   111→\n   112→// Repair location type badge styles\n   113→const REPAIR_LOCATION_STYLES = {\n   114→  WITH_CUSTOMER: { bg: \"bg-slate-100\", text: \"text-slate-600\" },\n   115→  ON_SITE: { bg: \"bg-emerald-100\", text: \"text-emerald-700\" },\n   116→  THIRD_PARTY: { bg: \"bg-[#14B8A6]/10\", text: \"text-[#14B8A6]\" },\n   117→};\n   118→\n   119→// Format booked date/time for display\n   120→const formatBookedDate = (date) => {\n   121→  if (!date) return null;\n   122→  const d = new Date(date);\n   123→  return d.toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\" }) +\n   124→    \" \" + d.toLocaleTimeString(\"en-GB\", { hour: \"2-digit\", minute: \"2-digit\" });\n   125→};\n   126→\n   127→// Helper to calculate days since date\n   128→const daysSince = (date) => {\n   129→  if (!date) return 0;\n   130→  const diff = Date.now() - new Date(date).getTime();\n   131→  return Math.floor(diff / (1000 * 60 * 60 * 24));\n   132→};\n   133→\n   134→// Helper for relative time display\n   135→const relativeTime = (date) => {\n   136→  const days = daysSince(date);\n   137→  if (days === 0) {\n   138→    const hours = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60 * 60));\n   139→    if (hours === 0) {\n   140→      const mins = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60));\n   141→      return mins <= 1 ? \"Just now\" : `${mins}m ago`;\n   142→    }\n   143→    return `${hours}h ago`;\n   144→  }\n   145→  if (days === 1) return \"Yesterday\";\n   146→  if (days < 7) return `${days}d ago`;\n   147→  if (days < 30) return `${Math.floor(days / 7)}w ago`;\n   148→  return `${Math.floor(days / 30)}mo ago`;\n   149→};\n   150→\n   151→export default function Warranty() {\n   152→  const router = useRouter();\n   153→  const [cases, setCases] = useState([]);\n   154→  const [isLoading, setIsLoading] = useState(true);\n   155→  const [selectedCase, setSelectedCase] = useState(null);\n   156→  const [showAddModal, setShowAddModal] = useState(false);\n   157→  const [newComment, setNewComment] = useState(\"\");\n   158→  const [commentAttachments, setCommentAttachments] = useState([]);\n   159→  const [isUploadingCaseMedia, setIsUploadingCaseMedia] = useState(false);\n   160→  const [isGeneratingAI, setIsGeneratingAI] = useState(false);\n   161→  const [showRegenerateConfirm, setShowRegenerateConfirm] = useState(false);\n   162→  const [aiDiagnostics, setAiDiagnostics] = useState(null);\n   163→  const [isLoadingDiagnostics, setIsLoadingDiagnostics] = useState(false);\n   164→  const [expandedTimelineGroups, setExpandedTimelineGroups] = useState({});\n   165→  const [isVehicleDrawerOpen, setIsVehicleDrawerOpen] = useState(false);\n   166→  const [selectedVehicleId, setSelectedVehicleId] = useState(null);\n   167→  const fileInputRef = useRef(null);\n   168→\n   169→  // Drag state - matching Sales & Prep\n   170→  const [draggedCard, setDraggedCard] = useState(null);\n   171→  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });\n   172→\n   173→  // Courtesy car state\n   174→  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n   175→  const [isLoadingCourtesy, setIsLoadingCourtesy] = useState(false);\n   176→\n   177→  // Column sorting state\n   178→  const [columnSortOptions, setColumnSortOptions] = useState({});\n   179→\n   180→  // Search filter state\n   181→  const [searchQuery, setSearchQuery] = useState(\"\");\n   182→\n   183→  // Filter state (matching stock board style)\n   184→  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);\n   185→  const [showMobileFilters, setShowMobileFilters] = useState(false);\n   186→  const [filters, setFilters] = useState({\n   187→    location: \"all\",      // \"all\" | \"ON_SITE\" | \"THIRD_PARTY\"\n   188→    booked: \"all\",        // \"all\" | \"booked\" | \"not_booked\"\n   189→    partsRequired: \"all\", // \"all\" | \"yes\" | \"no\"\n   190→    priority: \"all\",      // \"all\" | \"low\" | \"normal\" | \"high\" | \"critical\"\n   191→  });\n   192→\n   193→  // Mobile column selection\n   194→  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"not_booked_in\");\n   195→\n   196→  // Job sheet share state\n   197→  const [showJobSheetModal, setShowJobSheetModal] = useState(false);\n   198→  const [jobSheetLink, setJobSheetLink] = useState(null);\n   199→  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);\n   200→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ee428119-8269-4adf-94f1-57bc16ba26c3","timestamp":"2025-12-30T15:46:49.102Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","content":"import { useEffect, useState, useRef } from \"react\";\nimport { useRouter } from \"next/router\";\nimport Head from \"next/head\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport VehicleDrawer from \"@/components/VehicleDrawer\";\nimport AISuggestionsPanel from \"@/components/AISuggestionsPanel\";\nimport { BottomSheet } from \"@/components/ui/BottomSheet\";\nimport { MobileStageSelector } from \"@/components/ui/PageShell\";\nimport { toast } from \"react-hot-toast\";\n\n// Column config matching Sales & Prep style\n// NOTE: Internal keys are legacy names - keep stable for database compatibility\n// Display labels have been updated for clarity\nconst COLUMNS = [\n  { key: \"not_booked_in\", label: \"Not Booked In\", gradient: \"from-red-100/60\", accent: \"border-l-red-400\", accentBg: \"bg-red-400\" },\n  { key: \"on_site\", label: \"Booked In\", gradient: \"from-amber-100/60\", accent: \"border-l-amber-400\", accentBg: \"bg-amber-400\" }, // Legacy key: \"on_site\" displays as \"Booked In\"\n  { key: \"work_complete\", label: \"Work Complete\", gradient: \"from-blue-100/60\", accent: \"border-l-blue-400\", accentBg: \"bg-blue-400\" },\n  { key: \"collected\", label: \"Closed\", gradient: \"from-emerald-100/60\", accent: \"border-l-emerald-400\", accentBg: \"bg-emerald-400\" }, // Legacy key: \"collected\" displays as \"Closed\"\n];\n\nconst PRIORITIES = {\n  low: { bg: \"bg-slate-100\", text: \"text-slate-600\", border: \"border-slate-200\" },\n  normal: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\" },\n  high: { bg: \"bg-amber-50\", text: \"text-amber-700\", border: \"border-amber-100\" },\n  critical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\" },\n};\n\nconst SOURCE_LABELS = {\n  warranty_claim_form: \"Warranty Claim\",\n  low_review: \"Low Review\",\n  complaint_form: \"Complaint\",\n  manual: \"Manual\",\n};\n\n// Timeline event icons\nconst EVENT_ICONS = {\n  CASE_CREATED: \"📋\",\n  SUBMISSION_LINKED: \"🔗\",\n  COMMENT_ADDED: \"💬\",\n  STATUS_CHANGED: \"🔄\",\n  AI_REVIEW_GENERATED: \"🤖\",\n  ATTACHMENT_ADDED: \"📎\",\n  LOCATION_UPDATED: \"📍\",\n  BOOKING_UPDATED: \"📅\",\n  PARTS_UPDATED: \"🔧\",\n  COURTESY_REQUIRED_TOGGLED: \"🚗\",\n  COURTESY_ALLOCATED: \"🚗\",\n  COURTESY_RETURNED: \"🚗\",\n  COURTESY_OUT_RECORDED: \"🚗\",\n  COURTESY_IN_RECORDED: \"🚗\",\n  // Warranty booking auto-move events\n  WARRANTY_BOOKED_IN: \"📅\",\n  WARRANTY_BOOKING_UPDATED: \"📅\",\n  WARRANTY_BOOKING_CANCELLED: \"❌\",\n  WARRANTY_STAGE_MOVED: \"🔀\",\n};\n\n// Timeline grouping constant\nconst STATUS_FLIP_GROUP_WINDOW_MS = 10 * 60 * 1000; // 10 minutes\n\n// Group consecutive STATUS_CHANGED events within the time window\nconst groupTimelineEvents = (events) => {\n  if (!events || events.length === 0) return [];\n\n  const sorted = [...events].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n  const grouped = [];\n  let currentGroup = null;\n\n  for (const event of sorted) {\n    if (event.type === \"STATUS_CHANGED\") {\n      if (currentGroup) {\n        // Check if this event is within the time window of the last event in the group\n        const lastEventTime = new Date(currentGroup.events[currentGroup.events.length - 1].createdAt).getTime();\n        const thisEventTime = new Date(event.createdAt).getTime();\n\n        if (lastEventTime - thisEventTime <= STATUS_FLIP_GROUP_WINDOW_MS) {\n          currentGroup.events.push(event);\n          continue;\n        } else {\n          // Close current group and start new one\n          grouped.push(currentGroup);\n          currentGroup = { isGroup: true, type: \"STATUS_CHANGED_GROUP\", events: [event] };\n        }\n      } else {\n        currentGroup = { isGroup: true, type: \"STATUS_CHANGED_GROUP\", events: [event] };\n      }\n    } else {\n      // Non-status event - close any current group and add this event\n      if (currentGroup) {\n        grouped.push(currentGroup);\n        currentGroup = null;\n      }\n      grouped.push(event);\n    }\n  }\n\n  // Don't forget to add the last group if exists\n  if (currentGroup) {\n    grouped.push(currentGroup);\n  }\n\n  return grouped;\n};\n\n// Repair location type labels\nconst REPAIR_LOCATION_LABELS = {\n  WITH_CUSTOMER: \"With customer\",\n  ON_SITE: \"On-site\",\n  THIRD_PARTY: \"Third-party\",\n};\n\n// Repair location type badge styles\nconst REPAIR_LOCATION_STYLES = {\n  WITH_CUSTOMER: { bg: \"bg-slate-100\", text: \"text-slate-600\" },\n  ON_SITE: { bg: \"bg-emerald-100\", text: \"text-emerald-700\" },\n  THIRD_PARTY: { bg: \"bg-[#14B8A6]/10\", text: \"text-[#14B8A6]\" },\n};\n\n// Format booked date/time for display\nconst formatBookedDate = (date) => {\n  if (!date) return null;\n  const d = new Date(date);\n  return d.toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\" }) +\n    \" \" + d.toLocaleTimeString(\"en-GB\", { hour: \"2-digit\", minute: \"2-digit\" });\n};\n\n// Helper to calculate days since date\nconst daysSince = (date) => {\n  if (!date) return 0;\n  const diff = Date.now() - new Date(date).getTime();\n  return Math.floor(diff / (1000 * 60 * 60 * 24));\n};\n\n// Helper for relative time display\nconst relativeTime = (date) => {\n  const days = daysSince(date);\n  if (days === 0) {\n    const hours = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60 * 60));\n    if (hours === 0) {\n      const mins = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60));\n      return mins <= 1 ? \"Just now\" : `${mins}m ago`;\n    }\n    return `${hours}h ago`;\n  }\n  if (days === 1) return \"Yesterday\";\n  if (days < 7) return `${days}d ago`;\n  if (days < 30) return `${Math.floor(days / 7)}w ago`;\n  return `${Math.floor(days / 30)}mo ago`;\n};\n\nexport default function Warranty() {\n  const router = useRouter();\n  const [cases, setCases] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedCase, setSelectedCase] = useState(null);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [newComment, setNewComment] = useState(\"\");\n  const [commentAttachments, setCommentAttachments] = useState([]);\n  const [isUploadingCaseMedia, setIsUploadingCaseMedia] = useState(false);\n  const [isGeneratingAI, setIsGeneratingAI] = useState(false);\n  const [showRegenerateConfirm, setShowRegenerateConfirm] = useState(false);\n  const [aiDiagnostics, setAiDiagnostics] = useState(null);\n  const [isLoadingDiagnostics, setIsLoadingDiagnostics] = useState(false);\n  const [expandedTimelineGroups, setExpandedTimelineGroups] = useState({});\n  const [isVehicleDrawerOpen, setIsVehicleDrawerOpen] = useState(false);\n  const [selectedVehicleId, setSelectedVehicleId] = useState(null);\n  const fileInputRef = useRef(null);\n\n  // Drag state - matching Sales & Prep\n  const [draggedCard, setDraggedCard] = useState(null);\n  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });\n\n  // Courtesy car state\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [isLoadingCourtesy, setIsLoadingCourtesy] = useState(false);\n\n  // Column sorting state\n  const [columnSortOptions, setColumnSortOptions] = useState({});\n\n  // Search filter state\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  // Filter state (matching stock board style)\n  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);\n  const [showMobileFilters, setShowMobileFilters] = useState(false);\n  const [filters, setFilters] = useState({\n    location: \"all\",      // \"all\" | \"ON_SITE\" | \"THIRD_PARTY\"\n    booked: \"all\",        // \"all\" | \"booked\" | \"not_booked\"\n    partsRequired: \"all\", // \"all\" | \"yes\" | \"no\"\n    priority: \"all\",      // \"all\" | \"low\" | \"normal\" | \"high\" | \"critical\"\n  });\n\n  // Mobile column selection\n  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"not_booked_in\");\n\n  // Job sheet share state\n  const [showJobSheetModal, setShowJobSheetModal] = useState(false);\n  const [jobSheetLink, setJobSheetLink] = useState(null);\n  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);\n","numLines":200,"startLine":1,"totalLines":2718}}}
{"parentUuid":"ee428119-8269-4adf-94f1-57bc16ba26c3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NzHZVtibtxd6kgq9XqLAjQ","type":"tool_result","content":"3-import Head from \"next/head\";\r\n4-import DashboardLayout from \"@/components/DashboardLayout\";\r\n5-import VehicleDrawer from \"@/components/VehicleDrawer\";\r\n6:import AISuggestionsPanel from \"@/components/AISuggestionsPanel\";\r\n7-import { BottomSheet } from \"@/components/ui/BottomSheet\";\r\n8-import { MobileStageSelector } from \"@/components/ui/PageShell\";\r\n9-import { toast } from \"react-hot-toast\";\r\n--\n38-  SUBMISSION_LINKED: \"🔗\",\r\n39-  COMMENT_ADDED: \"💬\",\r\n40-  STATUS_CHANGED: \"🔄\",\r\n41:  AI_REVIEW_GENERATED: \"🤖\",\r\n42-  ATTACHMENT_ADDED: \"📎\",\r\n43-  LOCATION_UPDATED: \"📍\",\r\n44-  BOOKING_UPDATED: \"📅\",\r\n--\n103-};\r\n104-\r\n105-// Repair location type labels\r\n106:const REPAIR_LOCATION_LABELS = {\r\n107-  WITH_CUSTOMER: \"With customer\",\r\n108-  ON_SITE: \"On-site\",\r\n109-  THIRD_PARTY: \"Third-party\",\r\n110-};\r\n111-\r\n112-// Repair location type badge styles\r\n113:const REPAIR_LOCATION_STYLES = {\r\n114-  WITH_CUSTOMER: { bg: \"bg-slate-100\", text: \"text-slate-600\" },\r\n115-  ON_SITE: { bg: \"bg-emerald-100\", text: \"text-emerald-700\" },\r\n116-  THIRD_PARTY: { bg: \"bg-[#14B8A6]/10\", text: \"text-[#14B8A6]\" },\r\n--\n157-  const [newComment, setNewComment] = useState(\"\");\r\n158-  const [commentAttachments, setCommentAttachments] = useState([]);\r\n159-  const [isUploadingCaseMedia, setIsUploadingCaseMedia] = useState(false);\r\n160:  const [isGeneratingAI, setIsGeneratingAI] = useState(false);\r\n161-  const [showRegenerateConfirm, setShowRegenerateConfirm] = useState(false);\r\n162-  const [aiDiagnostics, setAiDiagnostics] = useState(null);\r\n163-  const [isLoadingDiagnostics, setIsLoadingDiagnostics] = useState(false);\r\n--\n237-\r\n238-  const fetchCaseDetail = async (caseId) => {\r\n239-    if (!caseId) return; // Guard against undefined/null caseId\r\n240:    // Clear AI diagnostics when switching cases\r\n241-    setAiDiagnostics(null);\r\n242-    try {\r\n243-      const res = await fetch(`/api/aftercare/${caseId}`);\r\n--\n426-    e.dataTransfer.effectAllowed = \"move\";\r\n427-    // Create invisible drag image (we render our own preview)\r\n428-    const emptyImg = new Image();\r\n429:    emptyImg.src = \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\";\r\n430-    e.dataTransfer.setDragImage(emptyImg, 0, 0);\r\n431-  };\r\n432-\r\n--\n572-    }\r\n573-  };\r\n574-\r\n575:  const generateAIReview = async (regenerate = false) => {\r\n576-    if (regenerate) {\r\n577-      setShowRegenerateConfirm(false);\r\n578-    }\r\n579:    setIsGeneratingAI(true);\r\n580-    try {\r\n581-      const res = await fetch(\"/api/ai/case-review\", {\r\n582-        method: \"POST\",\r\n--\n586-      const data = await res.json();\r\n587-      if (!res.ok) throw new Error(data.error || \"Failed to generate\");\r\n588-      fetchCaseDetail(selectedCase.id);\r\n589:      toast.success(\"AI review generated\");\r\n590-    } catch (error) {\r\n591-      toast.error(error.message);\r\n592-    } finally {\r\n593:      setIsGeneratingAI(false);\r\n594-    }\r\n595-  };\r\n596-\r\n597:  // Fetch AI diagnostic suggestions\r\n598:  const fetchAIDiagnostics = async () => {\r\n599-    if (!selectedCase) return;\r\n600-    setIsLoadingDiagnostics(true);\r\n601-    setAiDiagnostics(null);\r\n602-    try {\r\n603-      const vehicle = selectedCase.vehicleId;\r\n604:      const res = await fetch(\"/api/ai/warranty-suggestions\", {\r\n605-        method: \"POST\",\r\n606-        headers: { \"Content-Type\": \"application/json\" },\r\n607-        body: JSON.stringify({\r\n--\n619-      const data = await res.json();\r\n620-      if (data.success) {\r\n621-        setAiDiagnostics({\r\n622:          suggestions: data.suggestions,\r\n623:          isDummy: data.isDummy,\r\n624-        });\r\n625-      } else {\r\n626:        toast.error(data.error || \"Failed to get AI suggestions\");\r\n627-      }\r\n628-    } catch (error) {\r\n629:      console.error(\"AI diagnostics error:\", error);\r\n630:      toast.error(\"Failed to get AI suggestions\");\r\n631-    } finally {\r\n632-      setIsLoadingDiagnostics(false);\r\n633-    }\r\n--\n1060-                    const priority = caseItem.priority || \"normal\";\r\n1061-                    const priorityStyle = PRIORITIES[priority] || PRIORITIES.normal;\r\n1062-                    const locationType = caseItem.repairLocationType || \"WITH_CUSTOMER\";\r\n1063:                    const locationStyle = REPAIR_LOCATION_STYLES[locationType] || REPAIR_LOCATION_STYLES.WITH_CUSTOMER;\r\n1064-                    const attachmentCount = (caseItem.submissionAttachmentCount || 0) + (caseItem.commentAttachmentCount || 0);\r\n1065-                    const activityCount = (caseItem.comments?.length || 0) + (caseItem.events?.length || 0);\r\n1066-\r\n--\n1083-                                    {caseItem.regAtPurchase || caseItem.details?.vehicleReg || \"NO REG\"}\r\n1084-                                  </span>\r\n1085-                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold ${locationStyle.bg} ${locationStyle.text}`}>\r\n1086:                                    {REPAIR_LOCATION_LABELS[locationType]}\r\n1087-                                  </span>\r\n1088-                                  <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${priorityStyle.bg} ${priorityStyle.text} border ${priorityStyle.border}`}>\r\n1089-                                    {priority.charAt(0).toUpperCase() + priority.slice(1)}\r\n--\n1257-                      const priorityStyle = PRIORITIES[priority] || PRIORITIES.normal;\r\n1258-                      // Default location to WITH_CUSTOMER if missing (vehicle starts with customer)\r\n1259-                      const locationType = caseItem.repairLocationType || \"WITH_CUSTOMER\";\r\n1260:                      const locationStyle = REPAIR_LOCATION_STYLES[locationType] || REPAIR_LOCATION_STYLES.WITH_CUSTOMER;\r\n1261-\r\n1262-                      return (\r\n1263-                        <div\r\n--\n1279-                                  </span>\r\n1280-                                  {/* Location badge - always shown */}\r\n1281-                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold ${locationStyle.bg} ${locationStyle.text}`}>\r\n1282:                                    {REPAIR_LOCATION_LABELS[locationType]}\r\n1283-                                  </span>\r\n1284-                                  {/* Warranty type badge */}\r\n1285-                                  {caseItem.warrantyType && (\r\n--\n1577-              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\r\n1578-                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\r\n1579-                  <h3 className=\"text-sm font-semibold text-slate-900\">Repair Location</h3>\r\n1580:                  <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${REPAIR_LOCATION_STYLES[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]?.bg} ${REPAIR_LOCATION_STYLES[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]?.text}`}>\r\n1581:                    {REPAIR_LOCATION_LABELS[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]}\r\n1582-                  </span>\r\n1583-                </div>\r\n1584-                <div className=\"p-4 space-y-4\">\r\n--\n1605-                          }}\r\n1606-                          className={`flex-1 px-2 py-2 text-xs font-medium rounded-md transition-all flex items-center justify-center gap-1 ${\r\n1607-                            (selectedCase.repairLocationType || \"WITH_CUSTOMER\") === loc.key\r\n1608:                              ? `${REPAIR_LOCATION_STYLES[loc.key]?.bg} ${REPAIR_LOCATION_STYLES[loc.key]?.text} shadow-sm`\r\n1609-                              : \"text-slate-500 hover:text-slate-700\"\r\n1610-                          }`}\r\n1611-                        >\r\n--\n1889-                  <button\r\n1890-                    className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors\"\r\n1891-                    onClick={() => setShowRegenerateConfirm(true)}\r\n1892:                    disabled={isGeneratingAI}\r\n1893-                  >\r\n1894:                    {isGeneratingAI ? (\r\n1895-                      <span className=\"w-4 h-4 border-2 border-slate-300 border-t-slate-600 rounded-full animate-spin\"></span>\r\n1896-                    ) : (\r\n1897-                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n1898-                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\r\n1899-                      </svg>\r\n1900-                    )}\r\n1901:                    Regenerate AI\r\n1902-                  </button>\r\n1903-                ) : (\r\n1904-                  <button\r\n1905-                    className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-[#0066CC] hover:bg-[#0055BB] rounded-lg transition-colors shadow-sm\"\r\n1906:                    onClick={() => generateAIReview()}\r\n1907:                    disabled={isGeneratingAI}\r\n1908-                  >\r\n1909:                    {isGeneratingAI ? (\r\n1910-                      <span className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\"></span>\r\n1911-                    ) : (\r\n1912-                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n1913-                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" />\r\n1914-                      </svg>\r\n1915-                    )}\r\n1916:                    Generate AI Review\r\n1917-                  </button>\r\n1918-                )}\r\n1919-                <button\r\n--\n1938-                </button>\r\n1939-              </div>\r\n1940-\r\n1941:              {/* AI Case Review Panel */}\r\n1942-              {selectedCase.aiReview?.payload ? (\r\n1943-                <div className=\"bg-[#0066CC]/5/50 rounded-xl border border-[#0066CC]/20 overflow-hidden\">\r\n1944-                  <div className=\"px-4 py-3 border-b border-[#0066CC]/10 flex justify-between items-center bg-[#0066CC]/8\">\r\n1945-                    <h3 className=\"text-sm font-semibold text-[#0055BB] flex items-center gap-2\">\r\n1946:                      <span>🤖</span> AI Case Review\r\n1947-                    </h3>\r\n1948-                    <span className=\"text-xs text-[#0066CC]\">\r\n1949-                      Generated {relativeTime(selectedCase.aiReview.generatedAt)}\r\n--\n2041-                    🤖\r\n2042-                  </div>\r\n2043-                  <p className=\"text-sm text-slate-500\">\r\n2044:                    Click \"Generate AI Review\" to get AI-powered analysis of this case.\r\n2045-                  </p>\r\n2046-                </div>\r\n2047-              )}\r\n2048-\r\n2049:              {/* AI Diagnostics Panel */}\r\n2050-              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\r\n2051-                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\r\n2052:                  <h3 className=\"text-sm font-semibold text-slate-900\">AI Diagnostics</h3>\r\n2053-                  <button\r\n2054-                    className=\"inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-md transition-colors\"\r\n2055:                    onClick={fetchAIDiagnostics}\r\n2056-                    disabled={isLoadingDiagnostics}\r\n2057-                  >\r\n2058-                    {isLoadingDiagnostics ? (\r\n--\n2075-                  </button>\r\n2076-                </div>\r\n2077-                {(aiDiagnostics || isLoadingDiagnostics) && (\r\n2078:                  <AISuggestionsPanel\r\n2079:                    suggestions={aiDiagnostics?.suggestions}\r\n2080-                    isLoading={isLoadingDiagnostics}\r\n2081:                    isDummy={aiDiagnostics?.isDummy}\r\n2082-                    onCopyToNotes={(text) => {\r\n2083-                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);\r\n2084-                      toast.success(\"Added to comment draft\");\r\n--\n2242-\r\n2243-                      // Handle individual events\r\n2244-                      const event = item;\r\n2245:                      const isProminent = event.type === \"COMMENT_ADDED\" || event.type === \"AI_REVIEW_GENERATED\";\r\n2246-                      const isMinimal = event.type === \"CASE_CREATED\";\r\n2247-                      const isStatusChange = event.type === \"STATUS_CHANGED\";\r\n2248-\r\n--\n2258-                            {EVENT_ICONS[event.type] || \"📌\"}\r\n2259-                          </div>\r\n2260-                          <div className=\"flex-1 min-w-0\">\r\n2261:                            {/* Prominent events (comments, AI reviews) get larger text and preview */}\r\n2262-                            {isProminent ? (\r\n2263-                              <>\r\n2264-                                <p className=\"text-sm font-medium text-slate-900\">{event.summary || event.type.replace(/_/g, \" \")}</p>\r\n--\n2388-      {showRegenerateConfirm && (\r\n2389-        <div className=\"modal modal-open\">\r\n2390-          <div className=\"modal-box\">\r\n2391:            <h3 className=\"font-bold text-lg\">Regenerate AI Review?</h3>\r\n2392:            <p className=\"py-4\">This will replace the existing AI review with a new one. This action cannot be undone.</p>\r\n2393-            <div className=\"modal-action\">\r\n2394-              <button className=\"btn btn-ghost\" onClick={() => setShowRegenerateConfirm(false)}>Cancel</button>\r\n2395:              <button className=\"btn btn-primary\" onClick={() => generateAIReview(true)}>Regenerate</button>\r\n2396-            </div>\r\n2397-          </div>\r\n2398-          <div className=\"modal-backdrop\" onClick={() => setShowRegenerateConfirm(false)}></div>"}]},"uuid":"8957a8e9-b4ff-4304-a113-1ea7c5c63031","timestamp":"2025-12-30T15:46:49.128Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"3-import Head from \"next/head\";\r\n4-import DashboardLayout from \"@/components/DashboardLayout\";\r\n5-import VehicleDrawer from \"@/components/VehicleDrawer\";\r\n6:import AISuggestionsPanel from \"@/components/AISuggestionsPanel\";\r\n7-import { BottomSheet } from \"@/components/ui/BottomSheet\";\r\n8-import { MobileStageSelector } from \"@/components/ui/PageShell\";\r\n9-import { toast } from \"react-hot-toast\";\r\n--\n38-  SUBMISSION_LINKED: \"🔗\",\r\n39-  COMMENT_ADDED: \"💬\",\r\n40-  STATUS_CHANGED: \"🔄\",\r\n41:  AI_REVIEW_GENERATED: \"🤖\",\r\n42-  ATTACHMENT_ADDED: \"📎\",\r\n43-  LOCATION_UPDATED: \"📍\",\r\n44-  BOOKING_UPDATED: \"📅\",\r\n--\n103-};\r\n104-\r\n105-// Repair location type labels\r\n106:const REPAIR_LOCATION_LABELS = {\r\n107-  WITH_CUSTOMER: \"With customer\",\r\n108-  ON_SITE: \"On-site\",\r\n109-  THIRD_PARTY: \"Third-party\",\r\n110-};\r\n111-\r\n112-// Repair location type badge styles\r\n113:const REPAIR_LOCATION_STYLES = {\r\n114-  WITH_CUSTOMER: { bg: \"bg-slate-100\", text: \"text-slate-600\" },\r\n115-  ON_SITE: { bg: \"bg-emerald-100\", text: \"text-emerald-700\" },\r\n116-  THIRD_PARTY: { bg: \"bg-[#14B8A6]/10\", text: \"text-[#14B8A6]\" },\r\n--\n157-  const [newComment, setNewComment] = useState(\"\");\r\n158-  const [commentAttachments, setCommentAttachments] = useState([]);\r\n159-  const [isUploadingCaseMedia, setIsUploadingCaseMedia] = useState(false);\r\n160:  const [isGeneratingAI, setIsGeneratingAI] = useState(false);\r\n161-  const [showRegenerateConfirm, setShowRegenerateConfirm] = useState(false);\r\n162-  const [aiDiagnostics, setAiDiagnostics] = useState(null);\r\n163-  const [isLoadingDiagnostics, setIsLoadingDiagnostics] = useState(false);\r\n--\n237-\r\n238-  const fetchCaseDetail = async (caseId) => {\r\n239-    if (!caseId) return; // Guard against undefined/null caseId\r\n240:    // Clear AI diagnostics when switching cases\r\n241-    setAiDiagnostics(null);\r\n242-    try {\r\n243-      const res = await fetch(`/api/aftercare/${caseId}`);\r\n--\n426-    e.dataTransfer.effectAllowed = \"move\";\r\n427-    // Create invisible drag image (we render our own preview)\r\n428-    const emptyImg = new Image();\r\n429:    emptyImg.src = \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\";\r\n430-    e.dataTransfer.setDragImage(emptyImg, 0, 0);\r\n431-  };\r\n432-\r\n--\n572-    }\r\n573-  };\r\n574-\r\n575:  const generateAIReview = async (regenerate = false) => {\r\n576-    if (regenerate) {\r\n577-      setShowRegenerateConfirm(false);\r\n578-    }\r\n579:    setIsGeneratingAI(true);\r\n580-    try {\r\n581-      const res = await fetch(\"/api/ai/case-review\", {\r\n582-        method: \"POST\",\r\n--\n586-      const data = await res.json();\r\n587-      if (!res.ok) throw new Error(data.error || \"Failed to generate\");\r\n588-      fetchCaseDetail(selectedCase.id);\r\n589:      toast.success(\"AI review generated\");\r\n590-    } catch (error) {\r\n591-      toast.error(error.message);\r\n592-    } finally {\r\n593:      setIsGeneratingAI(false);\r\n594-    }\r\n595-  };\r\n596-\r\n597:  // Fetch AI diagnostic suggestions\r\n598:  const fetchAIDiagnostics = async () => {\r\n599-    if (!selectedCase) return;\r\n600-    setIsLoadingDiagnostics(true);\r\n601-    setAiDiagnostics(null);\r\n602-    try {\r\n603-      const vehicle = selectedCase.vehicleId;\r\n604:      const res = await fetch(\"/api/ai/warranty-suggestions\", {\r\n605-        method: \"POST\",\r\n606-        headers: { \"Content-Type\": \"application/json\" },\r\n607-        body: JSON.stringify({\r\n--\n619-      const data = await res.json();\r\n620-      if (data.success) {\r\n621-        setAiDiagnostics({\r\n622:          suggestions: data.suggestions,\r\n623:          isDummy: data.isDummy,\r\n624-        });\r\n625-      } else {\r\n626:        toast.error(data.error || \"Failed to get AI suggestions\");\r\n627-      }\r\n628-    } catch (error) {\r\n629:      console.error(\"AI diagnostics error:\", error);\r\n630:      toast.error(\"Failed to get AI suggestions\");\r\n631-    } finally {\r\n632-      setIsLoadingDiagnostics(false);\r\n633-    }\r\n--\n1060-                    const priority = caseItem.priority || \"normal\";\r\n1061-                    const priorityStyle = PRIORITIES[priority] || PRIORITIES.normal;\r\n1062-                    const locationType = caseItem.repairLocationType || \"WITH_CUSTOMER\";\r\n1063:                    const locationStyle = REPAIR_LOCATION_STYLES[locationType] || REPAIR_LOCATION_STYLES.WITH_CUSTOMER;\r\n1064-                    const attachmentCount = (caseItem.submissionAttachmentCount || 0) + (caseItem.commentAttachmentCount || 0);\r\n1065-                    const activityCount = (caseItem.comments?.length || 0) + (caseItem.events?.length || 0);\r\n1066-\r\n--\n1083-                                    {caseItem.regAtPurchase || caseItem.details?.vehicleReg || \"NO REG\"}\r\n1084-                                  </span>\r\n1085-                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold ${locationStyle.bg} ${locationStyle.text}`}>\r\n1086:                                    {REPAIR_LOCATION_LABELS[locationType]}\r\n1087-                                  </span>\r\n1088-                                  <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${priorityStyle.bg} ${priorityStyle.text} border ${priorityStyle.border}`}>\r\n1089-                                    {priority.charAt(0).toUpperCase() + priority.slice(1)}\r\n--\n1257-                      const priorityStyle = PRIORITIES[priority] || PRIORITIES.normal;\r\n1258-                      // Default location to WITH_CUSTOMER if missing (vehicle starts with customer)\r\n1259-                      const locationType = caseItem.repairLocationType || \"WITH_CUSTOMER\";\r\n1260:                      const locationStyle = REPAIR_LOCATION_STYLES[locationType] || REPAIR_LOCATION_STYLES.WITH_CUSTOMER;\r\n1261-\r\n1262-                      return (\r\n1263-                        <div\r\n--\n1279-                                  </span>\r\n1280-                                  {/* Location badge - always shown */}\r\n1281-                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold ${locationStyle.bg} ${locationStyle.text}`}>\r\n1282:                                    {REPAIR_LOCATION_LABELS[locationType]}\r\n1283-                                  </span>\r\n1284-                                  {/* Warranty type badge */}\r\n1285-                                  {caseItem.warrantyType && (\r\n--\n1577-              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\r\n1578-                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\r\n1579-                  <h3 className=\"text-sm font-semibold text-slate-900\">Repair Location</h3>\r\n1580:                  <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${REPAIR_LOCATION_STYLES[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]?.bg} ${REPAIR_LOCATION_STYLES[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]?.text}`}>\r\n1581:                    {REPAIR_LOCATION_LABELS[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]}\r\n1582-                  </span>\r\n1583-                </div>\r\n1584-                <div className=\"p-4 space-y-4\">\r\n--\n1605-                          }}\r\n1606-                          className={`flex-1 px-2 py-2 text-xs font-medium rounded-md transition-all flex items-center justify-center gap-1 ${\r\n1607-                            (selectedCase.repairLocationType || \"WITH_CUSTOMER\") === loc.key\r\n1608:                              ? `${REPAIR_LOCATION_STYLES[loc.key]?.bg} ${REPAIR_LOCATION_STYLES[loc.key]?.text} shadow-sm`\r\n1609-                              : \"text-slate-500 hover:text-slate-700\"\r\n1610-                          }`}\r\n1611-                        >\r\n--\n1889-                  <button\r\n1890-                    className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors\"\r\n1891-                    onClick={() => setShowRegenerateConfirm(true)}\r\n1892:                    disabled={isGeneratingAI}\r\n1893-                  >\r\n1894:                    {isGeneratingAI ? (\r\n1895-                      <span className=\"w-4 h-4 border-2 border-slate-300 border-t-slate-600 rounded-full animate-spin\"></span>\r\n1896-                    ) : (\r\n1897-                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n1898-                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\r\n1899-                      </svg>\r\n1900-                    )}\r\n1901:                    Regenerate AI\r\n1902-                  </button>\r\n1903-                ) : (\r\n1904-                  <button\r\n1905-                    className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-[#0066CC] hover:bg-[#0055BB] rounded-lg transition-colors shadow-sm\"\r\n1906:                    onClick={() => generateAIReview()}\r\n1907:                    disabled={isGeneratingAI}\r\n1908-                  >\r\n1909:                    {isGeneratingAI ? (\r\n1910-                      <span className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\"></span>\r\n1911-                    ) : (\r\n1912-                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n1913-                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" />\r\n1914-                      </svg>\r\n1915-                    )}\r\n1916:                    Generate AI Review\r\n1917-                  </button>\r\n1918-                )}\r\n1919-                <button\r\n--\n1938-                </button>\r\n1939-              </div>\r\n1940-\r\n1941:              {/* AI Case Review Panel */}\r\n1942-              {selectedCase.aiReview?.payload ? (\r\n1943-                <div className=\"bg-[#0066CC]/5/50 rounded-xl border border-[#0066CC]/20 overflow-hidden\">\r\n1944-                  <div className=\"px-4 py-3 border-b border-[#0066CC]/10 flex justify-between items-center bg-[#0066CC]/8\">\r\n1945-                    <h3 className=\"text-sm font-semibold text-[#0055BB] flex items-center gap-2\">\r\n1946:                      <span>🤖</span> AI Case Review\r\n1947-                    </h3>\r\n1948-                    <span className=\"text-xs text-[#0066CC]\">\r\n1949-                      Generated {relativeTime(selectedCase.aiReview.generatedAt)}\r\n--\n2041-                    🤖\r\n2042-                  </div>\r\n2043-                  <p className=\"text-sm text-slate-500\">\r\n2044:                    Click \"Generate AI Review\" to get AI-powered analysis of this case.\r\n2045-                  </p>\r\n2046-                </div>\r\n2047-              )}\r\n2048-\r\n2049:              {/* AI Diagnostics Panel */}\r\n2050-              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\r\n2051-                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\r\n2052:                  <h3 className=\"text-sm font-semibold text-slate-900\">AI Diagnostics</h3>\r\n2053-                  <button\r\n2054-                    className=\"inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-md transition-colors\"\r\n2055:                    onClick={fetchAIDiagnostics}\r\n2056-                    disabled={isLoadingDiagnostics}\r\n2057-                  >\r\n2058-                    {isLoadingDiagnostics ? (\r\n--\n2075-                  </button>\r\n2076-                </div>\r\n2077-                {(aiDiagnostics || isLoadingDiagnostics) && (\r\n2078:                  <AISuggestionsPanel\r\n2079:                    suggestions={aiDiagnostics?.suggestions}\r\n2080-                    isLoading={isLoadingDiagnostics}\r\n2081:                    isDummy={aiDiagnostics?.isDummy}\r\n2082-                    onCopyToNotes={(text) => {\r\n2083-                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);\r\n2084-                      toast.success(\"Added to comment draft\");\r\n--\n2242-\r\n2243-                      // Handle individual events\r\n2244-                      const event = item;\r\n2245:                      const isProminent = event.type === \"COMMENT_ADDED\" || event.type === \"AI_REVIEW_GENERATED\";\r\n2246-                      const isMinimal = event.type === \"CASE_CREATED\";\r\n2247-                      const isStatusChange = event.type === \"STATUS_CHANGED\";\r\n2248-\r\n--\n2258-                            {EVENT_ICONS[event.type] || \"📌\"}\r\n2259-                          </div>\r\n2260-                          <div className=\"flex-1 min-w-0\">\r\n2261:                            {/* Prominent events (comments, AI reviews) get larger text and preview */}\r\n2262-                            {isProminent ? (\r\n2263-                              <>\r\n2264-                                <p className=\"text-sm font-medium text-slate-900\">{event.summary || event.type.replace(/_/g, \" \")}</p>\r\n--\n2388-      {showRegenerateConfirm && (\r\n2389-        <div className=\"modal modal-open\">\r\n2390-          <div className=\"modal-box\">\r\n2391:            <h3 className=\"font-bold text-lg\">Regenerate AI Review?</h3>\r\n2392:            <p className=\"py-4\">This will replace the existing AI review with a new one. This action cannot be undone.</p>\r\n2393-            <div className=\"modal-action\">\r\n2394-              <button className=\"btn btn-ghost\" onClick={() => setShowRegenerateConfirm(false)}>Cancel</button>\r\n2395:              <button className=\"btn btn-primary\" onClick={() => generateAIReview(true)}>Regenerate</button>\r\n2396-            </div>\r\n2397-          </div>\r\n2398-          <div className=\"modal-backdrop\" onClick={() => setShowRegenerateConfirm(false)}></div>","numLines":257}}
{"parentUuid":"8957a8e9-b4ff-4304-a113-1ea7c5c63031","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FGCrTibPGfE1BnWGVWXpKn","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I have a comprehensive understanding of the codebase. Let me now start implementing the fixes in order. I'll update the todo list to mark the first task as in_progress and start working on the fixes.Let me summarize what needs to be done:\n\n1. **Quick Add menu z-index/layout bug** - The dropdown at line 488-510 in DashboardLayout.js uses `dropdown dropdown-end` with a z-50 class. But the header has `z-30`. The dropdown content has `z-50` which should work, but it might be clipped by overflow settings. I need to:\n   - Make sure the dropdown is rendered with a high z-index\n   - Add the necessary Quick Add items (New Appraisal and Add Vehicle)\n\n2. **Add two new Quick Add items** - Add \"New Appraisal\" and \"Add Vehicle\" to the Quick Add menu\n\n3. **AI service issues** - Need to:\n   - Add auth protection to the health endpoint\n   - Improve error handling in the UI\n   - Update error styling\n\n4. **Test Drive licence OCR extraction** - Create a new API endpoint and update the form\n\nLet me start working on Task 1: Fix Quick Add menu z-index.","signature":"EroJCkYICxgCKkC7uoYwwO4HGM67OTp6fs/6qFPZ8Jr+ySjjiXUAXb4JbH6GFfIcU3ovBT08sqS6TPhkE+x3Y5uG8mA/LQjEKwfuEgxlUyUV4/vp0cAmchUaDLClGXw4PE/jvzhjBSIw+py6knrpyVcpRs2UaTWEx0JMwr0RRNxF1qS5vjsJ70wNsHvX50aVrFMvExpJ4AA3KqEI8GxhX7QBtC6ohVo4cH35qwHUSKefbNIy4h6F5u4qoMDi6MkpP3m3aOmQ6So/SMmANszu2DHw350LJ5zec1CGZ1G0keLIfPgVXarEalyfSRoF7ns4PGoKf5otUSRdekIU6fBPubhqXBaObYvD67QPugEknsca0jrDAh0bFHJgcq57NrYZcHGzX6e+SbgSM4O/XehxMnKNIlqYF05agxbR8jkNVJ/TzFbDVPpUrTE2KeYy02oyQNdxfBsccyY4t5klXX0KtXWKTU9N1NksdbmSlLY2N/OrCgBZu+HJ5hKf6VGU0yoJXC+xVTQPb0NzrfiOBSgvxo1NMYC9IoRJyIpwlgjo1+FzcJnnVYRvuQRjCocn5jchOO41odZmuwS88fYscu0f0P3bqVAqKBEKJFBWBz6g344D5bG6lhlhrxIIU9G9JMUfLQd+YzsOHTgghz810L3BsoKLgp+hWnGAiLamCjbRh1pWaDqyjnpt8LYpltwKFkYJzkbQeTikWNKZqCl3zUf9xnCDPEM5r2pSSgDDL9451Q+j423onRFIgqlOEb5AkF582AI3pErB47kw4KF2UQXXwv/1K+ulzob3qrhtXp3m/6DtwgSwiiC7s5renVauiJAEVdhp2IxD5HjaPD2ndz5BooDCh/2DxpAlCtRgX1fhrHlDNyJBXhF0yiKqjYEXG5V5Epp9HNBR28nbYIow3mm0vN6mJ7WNuIt71E0FO9dQ3mCEFo3VoJcGlMJe6XIvUP3GaCSTskU34usQg9/wNFuk19Wu5xAW/Z5JZL+20BT9hoaJ9519WDBXqdikxv7ZvqEtqreLhU1Nyayo4vwfrluYr23JmUVHr1Ao6WNsy6MPzepZmGtwOQthZD9LE3XmqJof8ST8o3PT62GY0+dCK8CNzOYnAU2WrDp9F59KPPrtiQIXE0asMnkqZRpkgvtpbr/9o83sGrWk2nbOflJlnF5xtAEXb6eI4cy8Noi5n2kMtuQfB3MKz4E0EmYMN3v3jV+GB8Itq9mYxx6wOp5oCfBe+9CDnuTtTBCjEiTL3b0SKn8Qz7rFblU9UdQXbtt0AXoMZN/j8BcjAj6ZbYyZByDC7kzDqgqWctS5+9J+gQw0nWrr4k2+b3Ob5CWU+MhhnMVTDSVTQN+6fTO0cJ5XTEMheP+Qu2mRwGFix5PDh5A+KuqT9KEqpXsZQXblmP6fhZQaFOmUQvrLYAwOJ6KpxNe3wOuthSvRJOitzaP8SYjtiL7a0DC8zgauaQs8sX0eyNJqxeG2Wosul9CTNgnNsuY8L9qnQVhs07ol4cTIdZcQQR6sImnNzjbQT9xbciDF/FaTk7aRJKkUE7CnaiVi3gD5RxYlVTVDBD0YcToCmcOLtOYx334yIPI90KYAxdCCNXuLxSIcnD1Ns79i5S2d0BgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8212,"cache_read_input_tokens":71408,"cache_creation":{"ephemeral_5m_input_tokens":8212,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8dzgXJuVJPwv5GSGce","type":"assistant","uuid":"fbec5b9a-f5c4-4b14-8c22-503f9823eba0","timestamp":"2025-12-30T15:47:00.559Z"}
{"parentUuid":"fbec5b9a-f5c4-4b14-8c22-503f9823eba0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FGCrTibPGfE1BnWGVWXpKn","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a complete understanding of the codebase. Let me start implementing the fixes. I'll update my todo list and begin with the first task."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8212,"cache_read_input_tokens":71408,"cache_creation":{"ephemeral_5m_input_tokens":8212,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8dzgXJuVJPwv5GSGce","type":"assistant","uuid":"ba62ba56-4938-40d5-bc4b-2ee6a77b6578","timestamp":"2025-12-30T15:47:01.498Z"}
{"parentUuid":"ba62ba56-4938-40d5-bc4b-2ee6a77b6578","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FGCrTibPGfE1BnWGVWXpKn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LTg59UAdm5GfJ4iKFTEvoP","name":"TodoWrite","input":{"todos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"in_progress","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"pending","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"pending","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"pending","activeForm":"Implementing Test Drive licence OCR extraction"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":8212,"cache_read_input_tokens":71408,"cache_creation":{"ephemeral_5m_input_tokens":8212,"ephemeral_1h_input_tokens":0},"output_tokens":520,"service_tier":"standard"}},"requestId":"req_011CWd8dzgXJuVJPwv5GSGce","type":"assistant","uuid":"0e5ef752-f092-4a4d-ad90-cf0981320234","timestamp":"2025-12-30T15:47:04.623Z"}
{"parentUuid":"0e5ef752-f092-4a4d-ad90-cf0981320234","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LTg59UAdm5GfJ4iKFTEvoP","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"b3829d09-cec9-481b-8f2c-198690cfa4d7","timestamp":"2025-12-30T15:47:04.685Z","toolUseResult":{"oldTodos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"pending","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"pending","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"pending","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"pending","activeForm":"Implementing Test Drive licence OCR extraction"}],"newTodos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"in_progress","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"pending","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"pending","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"pending","activeForm":"Implementing Test Drive licence OCR extraction"}]}}
{"parentUuid":"b3829d09-cec9-481b-8f2c-198690cfa4d7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FWQxS6pR3kD9eiNEbg7NY3","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me fix the Quick Add dropdown z-index issue. Looking at the code:\n\n1. The header is `z-30` (line 479)\n2. The dropdown uses DaisyUI's dropdown classes which should work, but it has `z-50` on the dropdown content\n3. The main content area has `overflow-x-hidden` (line 542)\n\nThe problem is likely that the dropdown content is inside the header which creates a stacking context. I need to:\n1. Increase the z-index of the dropdown content to be above everything\n2. Maybe use a portal to render the dropdown outside the header hierarchy\n\nActually, looking more carefully:\n- The header has `z-30` \n- The dropdown content has `z-50` which should be above z-30\n- But the issue might be that the page content itself has some stacking context issues\n\nThe best fix is to make the dropdown content use a higher z-index like `z-[9999]`. This is a simple and effective fix. I'll also need to add the new menu items.\n\nLet me edit the DashboardLayout.js file.","signature":"EtQICkYICxgCKkAsdnoLsVXh9Hds+INmTJNM0bvtNqmKTGOTKfAvdCv6wE+gzhG1mgp7QGiQna3/AYVRmppmviKAEm172hv8xTUTEgwH9/L9K/bOU/lwj8oaDMFahzkhqPFAsjdhfiIw4ymVIZ0JRsLWG28+LIubEWE3ER5Zyxk6az2GFTSP21LQteuBKg8Xlbb/8NDGpbmBKrsHJgv2JAok+zE1ilCTjoeaWHJC6ObtCHTWalE5S8WqFNvxVvVwLG7ZOPdx7kNZdAwvn+ZvCJOF94ErqPHKDsCIE8VwMY9Q4eVfncthgnLdu+S7RfctnbVfTNJAUZg6LqR7FWX+ZMfJAcc/lzK83gMlG/In+BdAOQbZMxA++DR3Rn4h1NlwnEnKMk3pfH8X1Qd+Awml3LmzpxtkiExtVYPfDEvdLOKkwyYFd3H689YDA3j6KTuJGYbXdONY+f5Y+9ZICU64rARotZPAxgEkirj/k0MZgf62Wuj8bHTv4Hpt3sTjGbrlMrJ1RNJBhf+ceLxyNuji2tYq8Uvmwy4zqd0VfCXfqKWFaqMDDz7IixifQxaql71r8gMMKsUWzud5jnbt7SHktBgXERmm+31jZhjVyOEFWWQvt45c9udcLPWuCnI/xpNhcz9ehec0gK14m/I9YX2mDg/1OlFEmC8qnMpTvjIar63MWVrK8sHRIOW0GSjgVZo1zkT5Zq/1IiHmoqdH3Wc1uaNdIXYkbLdkO9z8e0GLnxS6RWisul/iCK+2xxnBu4prTTf5LBK4iTpAK749YxZ+PUiPyllyLO41hzI/woqlkWI29hMDojmET/y79o56s8in1CtNFJZog9iL6ymSc7UMP2M+WO6HPyoS9tIgGwWQ4BS+IFltRNmaJAfjTEi8ZR7ek8IQCv9RpZbgQphFMU2ymSfYtI37U3wCR7bNgTLPxBIwXU5TQ6rZMApNMsa/pw8rWj8zqCTroaq7RpMFPoXZiZlcPbYiwlWg7/Xe4JAytHJ8BtoSyX59Jpo3JMAGgl3rkaHDA+0zeaRq5okERYy8X9wKlpCEM5Ea85qF6WaKxXVwMXn2IgGh/rdm3nwXgAgrzmJjZA8Wuhvv55vEVnA8eJVNugO3ZuWG9d9RruGerJ0EPwHMboxkts/7wjkic6T99Id/SMQfQZiMkcv3xJ67h58uTjYJB7Z2spNFmMP7J7+lZKBMap40n6Talp7/0pXpQ5/AjeSFEnsHXQjPOYhgOKl1UvQvmKJQHvbCU6C8PsWMscOCEWBArA+/PIisqXCmeBFS+TIh3CEv6QdzDOdcP8DfL+Ue8yuET3M3lYvRiJOQmljSZAAWkrEq1A6ZJEd8YW17b2XNjqtxEIyO1nxNrizszzpN/ffnWfuY3dVAIII1myCCeZ26OZzB6q1xqhjkXa9aQnWvCuVMC9VT+gySatU7D7CpiFo6u4dXZ0r8Pcu8XtYLZT4ARrwmd/eNgUjco4cPyctVsRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":564,"cache_read_input_tokens":79620,"cache_creation":{"ephemeral_5m_input_tokens":564,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8f8WqtTWdBZHfHgnk2","type":"assistant","uuid":"862034eb-379d-43d0-b239-64edacaa28c1","timestamp":"2025-12-30T15:47:14.028Z"}
{"parentUuid":"862034eb-379d-43d0-b239-64edacaa28c1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FWQxS6pR3kD9eiNEbg7NY3","type":"message","role":"assistant","content":[{"type":"text","text":"## Task 1: Fix Quick Add menu z-index + Add new items\n\nLooking at the code, the Quick Add dropdown has `z-50` on the content, but the issue is that the parent header has `z-30`, and other elements might be creating stacking context issues. I'll fix this by using a much higher z-index and also add the new menu items."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":564,"cache_read_input_tokens":79620,"cache_creation":{"ephemeral_5m_input_tokens":564,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8f8WqtTWdBZHfHgnk2","type":"assistant","uuid":"b1ff600a-01bf-4e7c-871a-7661ded0b84f","timestamp":"2025-12-30T15:47:15.880Z"}
{"parentUuid":"b1ff600a-01bf-4e7c-871a-7661ded0b84f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FWQxS6pR3kD9eiNEbg7NY3","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Si472uZHHtYYNZPRvaPLuQ","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\components\\DashboardLayout.js","old_string":"          <div className=\"flex items-center gap-3\">\n            {/* Quick Add Form Button */}\n            <div className=\"dropdown dropdown-end\">\n              <label tabIndex={0} className=\"flex items-center justify-center w-9 h-9 rounded-xl bg-[#0066CC] hover:bg-[#0055AA] text-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                </svg>\n              </label>\n              <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100\">\n                {forms.length === 0 ? (\n                  <li><span className=\"text-base-content/60 text-sm\">No forms available</span></li>\n                ) : (\n                  forms.map((form) => (\n                    <li key={form.id || form._id}>\n                      <button\n                        onClick={() => handleFormClick(form)}\n                        className=\"text-sm text-left\"\n                      >\n                        <span className=\"truncate\">{form.name}</span>\n                      </button>\n                    </li>\n                  ))\n                )}\n              </ul>\n            </div>","new_string":"          <div className=\"flex items-center gap-3\">\n            {/* Quick Add Button */}\n            <div className=\"dropdown dropdown-end\">\n              <label tabIndex={0} className=\"flex items-center justify-center w-9 h-9 rounded-xl bg-[#0066CC] hover:bg-[#0055AA] text-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                </svg>\n              </label>\n              <ul tabIndex={0} className=\"dropdown-content z-[9999] menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100 mt-1\">\n                {/* Quick Actions Section */}\n                <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">Quick Actions</li>\n                <li>\n                  <Link href={getPath(\"/appraisals/new\")} className=\"text-sm flex items-center gap-2\">\n                    <ClipboardIcon className=\"w-4 h-4 text-slate-500\" />\n                    <span>New Appraisal</span>\n                  </Link>\n                </li>\n                <li>\n                  <Link href={getPath(\"/sales-prep?addVehicle=1\")} className=\"text-sm flex items-center gap-2\">\n                    <TruckIcon className=\"w-4 h-4 text-slate-500\" />\n                    <span>Add Vehicle</span>\n                  </Link>\n                </li>\n\n                {/* Forms Section */}\n                {forms.length > 0 && (\n                  <>\n                    <div className=\"divider my-1 px-2\"></div>\n                    <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">Forms</li>\n                    {forms.map((form) => (\n                      <li key={form.id || form._id}>\n                        <button\n                          onClick={() => handleFormClick(form)}\n                          className=\"text-sm text-left flex items-center gap-2\"\n                        >\n                          <DocumentTextIcon className=\"w-4 h-4 text-slate-400\" />\n                          <span className=\"truncate\">{form.name}</span>\n                        </button>\n                      </li>\n                    ))}\n                  </>\n                )}\n              </ul>\n            </div>"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":564,"cache_read_input_tokens":79620,"cache_creation":{"ephemeral_5m_input_tokens":564,"ephemeral_1h_input_tokens":0},"output_tokens":1567,"service_tier":"standard"}},"requestId":"req_011CWd8f8WqtTWdBZHfHgnk2","type":"assistant","uuid":"2ceadd57-cbe6-46ab-a9cb-a5ba02437197","timestamp":"2025-12-30T15:47:33.271Z"}
{"type":"file-history-snapshot","messageId":"2ceadd57-cbe6-46ab-a9cb-a5ba02437197","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"2ceadd57-cbe6-46ab-a9cb-a5ba02437197","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Si472uZHHtYYNZPRvaPLuQ","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\components\\DashboardLayout.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   482→              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 6h16M4 12h16M4 18h16\" />\n   483→            </svg>\n   484→          </button>\n   485→          <div className=\"flex-1 lg:flex-none\" />\n   486→          <div className=\"flex items-center gap-3\">\n   487→            {/* Quick Add Button */}\n   488→            <div className=\"dropdown dropdown-end\">\n   489→              <label tabIndex={0} className=\"flex items-center justify-center w-9 h-9 rounded-xl bg-[#0066CC] hover:bg-[#0055AA] text-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md\">\n   490→                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n   491→                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n   492→                </svg>\n   493→              </label>\n   494→              <ul tabIndex={0} className=\"dropdown-content z-[9999] menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100 mt-1\">\n   495→                {/* Quick Actions Section */}\n   496→                <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">Quick Actions</li>\n   497→                <li>\n   498→                  <Link href={getPath(\"/appraisals/new\")} className=\"text-sm flex items-center gap-2\">\n   499→                    <ClipboardIcon className=\"w-4 h-4 text-slate-500\" />\n   500→                    <span>New Appraisal</span>\n   501→                  </Link>\n   502→                </li>\n   503→                <li>\n   504→                  <Link href={getPath(\"/sales-prep?addVehicle=1\")} className=\"text-sm flex items-center gap-2\">\n   505→                    <TruckIcon className=\"w-4 h-4 text-slate-500\" />\n   506→                    <span>Add Vehicle</span>\n   507→                  </Link>\n   508→                </li>\n   509→\n   510→                {/* Forms Section */}\n   511→                {forms.length > 0 && (\n   512→                  <>\n   513→                    <div className=\"divider my-1 px-2\"></div>\n   514→                    <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">Forms</li>\n   515→                    {forms.map((form) => (\n   516→                      <li key={form.id || form._id}>\n   517→                        <button\n   518→                          onClick={() => handleFormClick(form)}\n   519→                          className=\"text-sm text-left flex items-center gap-2\"\n   520→                        >\n   521→                          <DocumentTextIcon className=\"w-4 h-4 text-slate-400\" />\n   522→                          <span className=\"truncate\">{form.name}</span>\n   523→                        </button>\n   524→                      </li>\n   525→                    ))}\n   526→                  </>\n   527→                )}\n   528→              </ul>\n   529→            </div>\n   530→\n   531→            {/* User Menu */}\n   532→            <div className=\"dropdown dropdown-end\">\n   533→              <label tabIndex={0} className=\"btn btn-ghost btn-circle avatar placeholder cursor-pointer\">"}]},"uuid":"60db2524-087e-4379-bac8-38063c8c9157","timestamp":"2025-12-30T15:48:23.394Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\components\\DashboardLayout.js","oldString":"          <div className=\"flex items-center gap-3\">\n            {/* Quick Add Form Button */}\n            <div className=\"dropdown dropdown-end\">\n              <label tabIndex={0} className=\"flex items-center justify-center w-9 h-9 rounded-xl bg-[#0066CC] hover:bg-[#0055AA] text-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                </svg>\n              </label>\n              <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100\">\n                {forms.length === 0 ? (\n                  <li><span className=\"text-base-content/60 text-sm\">No forms available</span></li>\n                ) : (\n                  forms.map((form) => (\n                    <li key={form.id || form._id}>\n                      <button\n                        onClick={() => handleFormClick(form)}\n                        className=\"text-sm text-left\"\n                      >\n                        <span className=\"truncate\">{form.name}</span>\n                      </button>\n                    </li>\n                  ))\n                )}\n              </ul>\n            </div>","newString":"          <div className=\"flex items-center gap-3\">\n            {/* Quick Add Button */}\n            <div className=\"dropdown dropdown-end\">\n              <label tabIndex={0} className=\"flex items-center justify-center w-9 h-9 rounded-xl bg-[#0066CC] hover:bg-[#0055AA] text-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                </svg>\n              </label>\n              <ul tabIndex={0} className=\"dropdown-content z-[9999] menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100 mt-1\">\n                {/* Quick Actions Section */}\n                <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">Quick Actions</li>\n                <li>\n                  <Link href={getPath(\"/appraisals/new\")} className=\"text-sm flex items-center gap-2\">\n                    <ClipboardIcon className=\"w-4 h-4 text-slate-500\" />\n                    <span>New Appraisal</span>\n                  </Link>\n                </li>\n                <li>\n                  <Link href={getPath(\"/sales-prep?addVehicle=1\")} className=\"text-sm flex items-center gap-2\">\n                    <TruckIcon className=\"w-4 h-4 text-slate-500\" />\n                    <span>Add Vehicle</span>\n                  </Link>\n                </li>\n\n                {/* Forms Section */}\n                {forms.length > 0 && (\n                  <>\n                    <div className=\"divider my-1 px-2\"></div>\n                    <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">Forms</li>\n                    {forms.map((form) => (\n                      <li key={form.id || form._id}>\n                        <button\n                          onClick={() => handleFormClick(form)}\n                          className=\"text-sm text-left flex items-center gap-2\"\n                        >\n                          <DocumentTextIcon className=\"w-4 h-4 text-slate-400\" />\n                          <span className=\"truncate\">{form.name}</span>\n                        </button>\n                      </li>\n                    ))}\n                  </>\n                )}\n              </ul>\n            </div>","originalFile":"import { useState, useEffect } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";\nimport { signOut } from \"next-auth/react\";\nimport { useDealer } from \"@/contexts/DealerContext\";\nimport { appPath } from \"@/libs/appPath\";\n\n// Human-readable form type labels\nconst FORM_TYPE_LABELS = {\n  PDI: \"PDI\",\n  TEST_DRIVE: \"Test Drive\",\n  WARRANTY_CLAIM: \"Warranty\",\n  COURTESY_OUT: \"Courtesy Out\",\n  COURTESY_IN: \"Courtesy In\",\n  SERVICE_RECEIPT: \"Service\",\n  REVIEW_FEEDBACK: \"Feedback\",\n  OTHER: \"Other\",\n};\n\n// Icon components (using inline SVG as heroicons alternative)\nconst ChartBarIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z\" />\n  </svg>\n);\n\nconst TruckIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12\" />\n  </svg>\n);\n\nconst WrenchIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z\" />\n  </svg>\n);\n\nconst ClipboardIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z\" />\n  </svg>\n);\n\nconst DocumentTextIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z\" />\n  </svg>\n);\n\nconst StarIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z\" />\n  </svg>\n);\n\nconst CalendarIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5\" />\n  </svg>\n);\n\nconst CogIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z\" />\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n  </svg>\n);\n\nconst ChevronDownIcon = ({ className }) => (\n  <svg className={className} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M19.5 8.25l-7.5 7.5-7.5-7.5\" />\n  </svg>\n);\n\nconst navigation = [\n  { name: \"Dashboard\", href: \"/dashboard\", Icon: ChartBarIcon },\n  { name: \"Stock & Prep\", href: \"/sales-prep\", Icon: TruckIcon },\n  { name: \"Aftersales/Warranty\", href: \"/warranty\", Icon: WrenchIcon },\n  { name: \"Appraisals\", href: \"/appraisals\", Icon: ClipboardIcon },\n  { name: \"Submissions\", href: \"/forms\", Icon: DocumentTextIcon },\n  { name: \"Reviews\", href: \"/reviews\", Icon: StarIcon },\n  { name: \"Calendar\", href: \"/calendar\", Icon: CalendarIcon },\n  { name: \"Settings\", href: \"/settings\", Icon: CogIcon },\n];\n\nexport default function DashboardLayout({ children }) {\n  const router = useRouter();\n  const { dealerSlug } = useDealer(); // Get dealer slug from tenant context (null if legacy route)\n  const getPath = (path) => appPath(dealerSlug, path); // Helper to generate tenant-aware paths\n  const [sidebarOpen, setSidebarOpen] = useState(false);\n  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);\n  const [expandedMenus, setExpandedMenus] = useState({});\n  const [forms, setForms] = useState([]);\n  const [dealer, setDealer] = useState(null);\n  const [debugContext, setDebugContext] = useState(null);\n  const [debugPanelOpen, setDebugPanelOpen] = useState(false);\n\n  // Load sidebar collapsed state from localStorage\n  useEffect(() => {\n    const saved = localStorage.getItem(\"sidebarCollapsed\");\n    if (saved !== null) {\n      setSidebarCollapsed(JSON.parse(saved));\n    }\n  }, []);\n\n  // Save sidebar collapsed state to localStorage\n  const toggleSidebarCollapsed = () => {\n    const newState = !sidebarCollapsed;\n    setSidebarCollapsed(newState);\n    localStorage.setItem(\"sidebarCollapsed\", JSON.stringify(newState));\n  };\n\n  // Keyboard shortcut: [ or Ctrl+B to toggle sidebar\n  useEffect(() => {\n    const handleKeyDown = (e) => {\n      if (e.key === \"[\" || (e.ctrlKey && e.key === \"b\")) {\n        e.preventDefault();\n        toggleSidebarCollapsed();\n      }\n    };\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [sidebarCollapsed]);\n\n  // Dev-only: fetch debug context\n  useEffect(() => {\n    if (process.env.NODE_ENV === \"development\") {\n      fetch(\"/api/debug/context\")\n        .then(res => {\n          const contentType = res.headers.get(\"content-type\") || \"\";\n          if (!contentType.includes(\"application/json\")) return null;\n          return res.json();\n        })\n        .then(data => {\n          if (data) setDebugContext(data);\n        })\n        .catch(() => {});\n    }\n  }, []);\n\n  useEffect(() => {\n    // Load forms for the quick add dropdown\n    fetch(\"/api/forms\")\n      .then(res => res.json())\n      .then(data => {\n        if (Array.isArray(data)) setForms(data);\n      })\n      .catch(() => {});\n\n    // Load dealer for logo and check onboarding status\n    fetch(\"/api/dealer\")\n      .then(async (res) => {\n        // 403 = no dealer membership - redirect to create dealer\n        if (res.status === 403 && !router.pathname.startsWith(\"/onboarding\")) {\n          router.push(getPath(\"/onboarding/create-dealer\"));\n          return null;\n        }\n        if (!res.ok) return null;\n        return res.json();\n      })\n      .then(data => {\n        if (!data) return;\n        setDealer(data);\n        // Redirect to onboarding wizard if not completed (skip if already on onboarding page)\n        if (data && !data.completedOnboarding && !router.pathname.startsWith(\"/onboarding\")) {\n          router.push(getPath(\"/onboarding\"));\n        }\n      })\n      .catch(() => {});\n  }, [router]);\n\n  const handleFormClick = (form) => {\n    if (form.isPublic && form.publicSlug) {\n      window.open(`/public/forms/${form.publicSlug}`, '_blank');\n    } else {\n      router.push(`/forms/fill/${form.id || form._id}`);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-[#f8fafc]\">\n      {sidebarOpen && (\n        <div className=\"fixed inset-0 bg-black/50 z-40 lg:hidden\" onClick={() => setSidebarOpen(false)} />\n      )}\n\n      {/* Sidebar - Modern design with brand colors */}\n      <aside className={`fixed top-0 left-0 z-50 h-full bg-white border-r border-slate-100 shadow-sm transform transition-all duration-300 ease-in-out lg:translate-x-0 flex flex-col ${sidebarOpen ? \"translate-x-0\" : \"-translate-x-full\"} ${sidebarCollapsed ? \"lg:w-16\" : \"lg:w-64\"} w-64`}>\n        {/* Mobile close button */}\n        <div className=\"flex items-center justify-end h-12 px-4 lg:hidden\">\n          <button className=\"text-base-content/50 hover:text-base-content hover:bg-base-200 rounded-lg p-2 transition-colors\" onClick={() => setSidebarOpen(false)}>\n            <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\" strokeWidth={2}>\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" d=\"M6 18L18 6M6 6l12 12\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Logo Area - Dealer's Logo takes prominence */}\n        <div className={`flex flex-col items-center transition-all duration-300 ${sidebarCollapsed ? \"p-3\" : \"p-6\"}`}>\n          <Link href={getPath(\"/dashboard\")} className=\"block\">\n            {dealer?.logoUrl ? (\n              <img\n                src={dealer.logoUrl}\n                alt={dealer?.name || \"Logo\"}\n                className={`object-contain transition-all duration-300 ${sidebarCollapsed ? \"max-h-8 w-8\" : \"max-h-16 w-auto mx-auto\"}`}\n              />\n            ) : (\n              <div className={`flex items-center ${sidebarCollapsed ? \"justify-center\" : \"gap-2\"}`}>\n                <TruckIcon className={`text-primary transition-all duration-300 ${sidebarCollapsed ? \"w-6 h-6\" : \"w-8 h-8\"}`} />\n                {!sidebarCollapsed && <span className=\"text-xl font-bold text-base-content\">{dealer?.name || \"DealerFlow\"}</span>}\n              </div>\n            )}\n          </Link>\n        </div>\n\n        {/* Navigation */}\n        <nav className={`flex-1 mt-2 ${sidebarCollapsed ? \"px-2\" : \"px-3\"} overflow-y-auto`}>\n          {/* Main Section */}\n          {!sidebarCollapsed && (\n            <p className=\"px-3 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\n              Main\n            </p>\n          )}\n          <ul className=\"space-y-1\">\n            {navigation.slice(0, 3).map((item) => {\n              const { Icon } = item;\n              const itemPath = getPath(item.href);\n              const isActive = router.pathname.startsWith(item.href) || router.asPath.includes(item.href);\n              return (\n                <li key={item.name} className=\"relative group\">\n                  <Link\n                    href={itemPath}\n                    className={`relative flex items-center rounded-xl transition-all duration-200 ${\n                      sidebarCollapsed ? \"justify-center p-2\" : \"gap-3 px-3 py-2.5\"\n                    } ${\n                      isActive\n                        ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n                        : \"hover:bg-slate-50\"\n                    }`}\n                    title={sidebarCollapsed ? item.name : undefined}\n                  >\n                    {/* Active indicator bar */}\n                    {isActive && !sidebarCollapsed && (\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-7 bg-gradient-to-b from-[#0066CC] to-[#0EA5E9] rounded-r-full\" />\n                    )}\n                    {/* Icon with colored container */}\n                    <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n                      sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n                    } ${\n                      isActive\n                        ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                        : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                    }`}>\n                      <Icon className=\"w-[18px] h-[18px]\" />\n                    </div>\n                    {!sidebarCollapsed && (\n                      <span className={`text-sm transition-colors ${\n                        isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n                      }`}>{item.name}</span>\n                    )}\n                  </Link>\n                  {/* Tooltip for collapsed state */}\n                  {sidebarCollapsed && (\n                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl\">\n                      {item.name}\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-slate-900 rotate-45\" />\n                    </div>\n                  )}\n                </li>\n              );\n            })}\n          </ul>\n\n          {/* Management Section */}\n          {!sidebarCollapsed && (\n            <p className=\"px-3 mt-6 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\n              Management\n            </p>\n          )}\n          {sidebarCollapsed && <div className=\"my-4 border-t border-slate-100\" />}\n          <ul className=\"space-y-1\">\n            {navigation.slice(3, 7).map((item) => {\n              const { Icon } = item;\n\n              if (item.children) {\n                const isExpanded = expandedMenus[item.name];\n                const isActive = router.pathname.startsWith(\"/forms\");\n\n                return (\n                  <li key={item.name}>\n                    <button\n                      onClick={() => setExpandedMenus(prev => ({ ...prev, [item.name]: !prev[item.name] }))}\n                      className={`flex items-center w-full rounded-xl transition-all duration-200 group ${\n                        sidebarCollapsed ? \"justify-center p-2\" : \"justify-between gap-3 px-3 py-2.5\"\n                      } ${\n                        isActive\n                          ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n                          : \"hover:bg-slate-50\"\n                      }`}\n                      title={sidebarCollapsed ? item.name : undefined}\n                    >\n                      <div className={`flex items-center ${sidebarCollapsed ? \"\" : \"gap-3\"}`}>\n                        <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n                          sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n                        } ${\n                          isActive\n                            ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                            : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                        }`}>\n                          <Icon className=\"w-[18px] h-[18px]\" />\n                        </div>\n                        {!sidebarCollapsed && (\n                          <span className={`text-sm transition-colors ${\n                            isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n                          }`}>{item.name}</span>\n                        )}\n                      </div>\n                      {!sidebarCollapsed && (\n                        <ChevronDownIcon className={`w-4 h-4 transition-transform duration-200 ${isExpanded ? \"rotate-180\" : \"\"} ${isActive ? \"text-[#0066CC]\" : \"text-slate-400\"}`} />\n                      )}\n                    </button>\n                    {!sidebarCollapsed && isExpanded && (\n                      <ul className=\"mt-1.5 ml-11 space-y-0.5 border-l-2 border-[#0066CC]/20 pl-3\">\n                        {item.children.map((child) => {\n                          const childPath = getPath(child.href);\n                          const isChildActive = router.pathname === child.href || router.asPath === child.href || router.asPath.includes(child.href);\n                          return (\n                            <li key={child.name}>\n                              <Link\n                                href={childPath}\n                                className={`flex items-center gap-2 px-3 py-2 rounded-lg transition-all text-sm ${\n                                  isChildActive\n                                    ? \"bg-[#0066CC]/10 text-[#0066CC] font-semibold\"\n                                    : \"text-slate-500 hover:bg-slate-50 hover:text-slate-700\"\n                                }`}\n                              >\n                                {isChildActive && <span className=\"w-1.5 h-1.5 rounded-full bg-[#0066CC]\" />}\n                                <span>{child.name}</span>\n                              </Link>\n                            </li>\n                          );\n                        })}\n                      </ul>\n                    )}\n                  </li>\n                );\n              }\n\n              const itemPath = getPath(item.href);\n              const isActive = router.pathname.startsWith(item.href) || router.asPath.includes(item.href);\n              return (\n                <li key={item.name} className=\"relative group\">\n                  <Link\n                    href={itemPath}\n                    className={`relative flex items-center rounded-xl transition-all duration-200 ${\n                      sidebarCollapsed ? \"justify-center p-2\" : \"gap-3 px-3 py-2.5\"\n                    } ${\n                      isActive\n                        ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n                        : \"hover:bg-slate-50\"\n                    }`}\n                    title={sidebarCollapsed ? item.name : undefined}\n                  >\n                    {/* Active indicator bar */}\n                    {isActive && !sidebarCollapsed && (\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-7 bg-gradient-to-b from-[#0066CC] to-[#0EA5E9] rounded-r-full\" />\n                    )}\n                    {/* Icon with colored container */}\n                    <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n                      sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n                    } ${\n                      isActive\n                        ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                        : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                    }`}>\n                      <Icon className=\"w-[18px] h-[18px]\" />\n                    </div>\n                    {!sidebarCollapsed && (\n                      <span className={`text-sm transition-colors ${\n                        isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n                      }`}>{item.name}</span>\n                    )}\n                  </Link>\n                  {/* Tooltip for collapsed state */}\n                  {sidebarCollapsed && (\n                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl\">\n                      {item.name}\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-slate-900 rotate-45\" />\n                    </div>\n                  )}\n                </li>\n              );\n            })}\n          </ul>\n\n          {/* Settings Section */}\n          {!sidebarCollapsed && (\n            <p className=\"px-3 mt-6 mb-3 text-[10px] font-bold text-slate-400 uppercase tracking-widest\">\n              System\n            </p>\n          )}\n          {sidebarCollapsed && <div className=\"my-4 border-t border-slate-100\" />}\n          <ul className=\"space-y-1\">\n            {navigation.slice(7).map((item) => {\n              const { Icon } = item;\n              const itemPath = getPath(item.href);\n              const isActive = router.pathname.startsWith(item.href) || router.asPath.includes(item.href);\n              return (\n                <li key={item.name} className=\"relative group\">\n                  <Link\n                    href={itemPath}\n                    className={`relative flex items-center rounded-xl transition-all duration-200 ${\n                      sidebarCollapsed ? \"justify-center p-2\" : \"gap-3 px-3 py-2.5\"\n                    } ${\n                      isActive\n                        ? \"bg-gradient-to-r from-[#0066CC]/10 to-[#0066CC]/5\"\n                        : \"hover:bg-slate-50\"\n                    }`}\n                    title={sidebarCollapsed ? item.name : undefined}\n                  >\n                    {/* Active indicator bar */}\n                    {isActive && !sidebarCollapsed && (\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 w-1 h-7 bg-gradient-to-b from-[#0066CC] to-[#0EA5E9] rounded-r-full\" />\n                    )}\n                    {/* Icon with colored container */}\n                    <div className={`flex items-center justify-center rounded-lg transition-all duration-200 ${\n                      sidebarCollapsed ? \"w-9 h-9\" : \"w-8 h-8\"\n                    } ${\n                      isActive\n                        ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                        : \"bg-slate-100 text-slate-500 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                    }`}>\n                      <Icon className=\"w-[18px] h-[18px]\" />\n                    </div>\n                    {!sidebarCollapsed && (\n                      <span className={`text-sm transition-colors ${\n                        isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-600 group-hover:text-slate-900\"\n                      }`}>{item.name}</span>\n                    )}\n                  </Link>\n                  {/* Tooltip for collapsed state */}\n                  {sidebarCollapsed && (\n                    <div className=\"absolute left-full top-1/2 -translate-y-1/2 ml-3 px-3 py-1.5 bg-slate-900 text-white text-xs font-medium rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 shadow-xl\">\n                      {item.name}\n                      <span className=\"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-slate-900 rotate-45\" />\n                    </div>\n                  )}\n                </li>\n              );\n            })}\n          </ul>\n        </nav>\n\n        {/* Footer - Collapse Toggle + SaaS Branding */}\n        <div className={`mt-auto border-t border-slate-100 ${sidebarCollapsed ? \"p-2\" : \"p-4\"}`}>\n          {/* Collapse Toggle Button */}\n          <button\n            onClick={toggleSidebarCollapsed}\n            className={`hidden lg:flex items-center w-full rounded-xl text-slate-400 hover:text-slate-600 hover:bg-slate-50 transition-all duration-200 ${\n              sidebarCollapsed ? \"justify-center p-2\" : \"gap-2 px-3 py-2\"\n            }`}\n            title={sidebarCollapsed ? \"Expand sidebar ([ or Ctrl+B)\" : \"Collapse sidebar ([ or Ctrl+B)\"}\n          >\n            <svg className={`w-5 h-5 transition-transform duration-300 ${sidebarCollapsed ? \"rotate-180\" : \"\"}`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M11 19l-7-7 7-7m8 14l-7-7 7-7\" />\n            </svg>\n            {!sidebarCollapsed && <span className=\"text-sm\">Collapse</span>}\n          </button>\n          {!sidebarCollapsed && (\n            <p className=\"text-[11px] text-slate-300 text-center mt-3\">\n              Powered by <span className=\"font-semibold text-slate-400\">DealerFlow</span>\n            </p>\n          )}\n        </div>\n      </aside>\n\n      {/* Main content */}\n      <div className={`transition-all duration-300 ${sidebarCollapsed ? \"lg:pl-16\" : \"lg:pl-64\"}`}>\n        <header className=\"sticky top-0 z-30 flex items-center justify-between h-16 px-4 md:px-6 bg-white/95 backdrop-blur-md border-b border-slate-100\">\n          <button className=\"lg:hidden btn btn-ghost btn-sm\" onClick={() => setSidebarOpen(true)}>\n            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 6h16M4 12h16M4 18h16\" />\n            </svg>\n          </button>\n          <div className=\"flex-1 lg:flex-none\" />\n          <div className=\"flex items-center gap-3\">\n            {/* Quick Add Form Button */}\n            <div className=\"dropdown dropdown-end\">\n              <label tabIndex={0} className=\"flex items-center justify-center w-9 h-9 rounded-xl bg-[#0066CC] hover:bg-[#0055AA] text-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                </svg>\n              </label>\n              <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100\">\n                {forms.length === 0 ? (\n                  <li><span className=\"text-base-content/60 text-sm\">No forms available</span></li>\n                ) : (\n                  forms.map((form) => (\n                    <li key={form.id || form._id}>\n                      <button\n                        onClick={() => handleFormClick(form)}\n                        className=\"text-sm text-left\"\n                      >\n                        <span className=\"truncate\">{form.name}</span>\n                      </button>\n                    </li>\n                  ))\n                )}\n              </ul>\n            </div>\n\n            {/* User Menu */}\n            <div className=\"dropdown dropdown-end\">\n              <label tabIndex={0} className=\"btn btn-ghost btn-circle avatar placeholder cursor-pointer\">\n                <div className=\"bg-neutral text-neutral-content rounded-full w-8\">\n                  <span className=\"text-xs\">U</span>\n                </div>\n              </label>\n              <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-lg bg-base-100 rounded-box w-52\">\n                <li>\n                  <Link href={getPath(\"/settings\")} className=\"text-sm\">\n                    <CogIcon className=\"w-4 h-4\" />\n                    Settings\n                  </Link>\n                </li>\n                <div className=\"divider my-1\"></div>\n                <li>\n                  <button\n                    onClick={() => signOut({ callbackUrl: \"/auth/signin\" })}\n                    className=\"text-sm text-error\"\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9\" />\n                    </svg>\n                    Sign out\n                  </button>\n                </li>\n              </ul>\n            </div>\n          </div>\n        </header>\n        <main className=\"p-4 md:p-6 lg:p-8 pb-24 md:pb-8 min-w-0 max-w-full overflow-x-hidden\">{children}</main>\n      </div>\n\n      {/* Mobile Bottom Navigation - Safe area aware with modern styling */}\n      <nav className=\"fixed bottom-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-md border-t border-slate-100 md:hidden shadow-lg shadow-slate-200/50\" style={{ paddingBottom: 'env(safe-area-inset-bottom, 0px)' }}>\n        <div className=\"flex items-center justify-around h-16\">\n          {[\n            { name: \"Home\", href: \"/dashboard\", Icon: ChartBarIcon },\n            { name: \"Stock\", href: \"/sales-prep\", Icon: TruckIcon },\n            { name: \"Warranty\", href: \"/warranty\", Icon: WrenchIcon },\n            { name: \"Forms\", href: \"/forms\", Icon: DocumentTextIcon },\n            { name: \"More\", href: null, Icon: CogIcon, isMore: true },\n          ].map((item) => {\n            const itemPath = item.href ? getPath(item.href) : null;\n            const isActive = item.href && (router.pathname.startsWith(item.href) || router.asPath.includes(item.href));\n\n            if (item.isMore) {\n              return (\n                <div key={item.name} className=\"dropdown dropdown-top dropdown-end\">\n                  <label tabIndex={0} className=\"flex flex-col items-center justify-center h-full px-2 py-1.5 cursor-pointer group\">\n                    <div className=\"flex items-center justify-center w-10 h-10 rounded-xl bg-slate-100 text-slate-400 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC] transition-all\">\n                      <item.Icon className=\"w-5 h-5\" />\n                    </div>\n                    <span className=\"text-[10px] mt-0.5 text-slate-400 group-hover:text-[#0066CC] transition-colors\">{item.name}</span>\n                  </label>\n                  <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-xl bg-white rounded-2xl w-52 mb-3 border border-slate-100\">\n                    <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">More Options</li>\n                    <li><Link href={getPath(\"/appraisals\")} className=\"text-sm py-2.5 rounded-xl\">Appraisals</Link></li>\n                    <li><Link href={getPath(\"/reviews\")} className=\"text-sm py-2.5 rounded-xl\">Reviews</Link></li>\n                    <li><Link href={getPath(\"/calendar\")} className=\"text-sm py-2.5 rounded-xl\">Calendar</Link></li>\n                    <div className=\"divider my-1 px-3\"></div>\n                    <li><Link href={getPath(\"/settings\")} className=\"text-sm py-2.5 rounded-xl\">Settings</Link></li>\n                  </ul>\n                </div>\n              );\n            }\n\n            return (\n              <Link\n                key={item.name}\n                href={itemPath}\n                className=\"flex flex-col items-center justify-center h-full px-2 py-1.5 group\"\n              >\n                <div className={`flex items-center justify-center w-10 h-10 rounded-xl transition-all ${\n                  isActive\n                    ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/30\"\n                    : \"bg-slate-100 text-slate-400 group-hover:bg-[#0066CC]/10 group-hover:text-[#0066CC]\"\n                }`}>\n                  <item.Icon className=\"w-5 h-5\" />\n                </div>\n                <span className={`text-[10px] mt-0.5 transition-colors ${\n                  isActive ? \"font-semibold text-[#0066CC]\" : \"text-slate-400 group-hover:text-[#0066CC]\"\n                }`}>{item.name}</span>\n              </Link>\n            );\n          })}\n        </div>\n      </nav>\n\n      {/* Dev-only Tenant Debug Panel */}\n      {process.env.NODE_ENV === \"development\" && debugContext && (\n        <div className=\"fixed bottom-20 md:bottom-4 right-4 z-[60]\">\n          <button\n            onClick={() => setDebugPanelOpen(!debugPanelOpen)}\n            className=\"btn btn-xs btn-warning shadow-lg\"\n            title=\"Toggle debug panel\"\n          >\n            {debugPanelOpen ? \"Hide Debug\" : \"Debug\"}\n          </button>\n          {debugPanelOpen && (\n            <div className=\"absolute bottom-8 right-0 bg-warning/10 border border-warning rounded-lg p-3 shadow-xl min-w-64 text-xs font-mono\">\n              <div className=\"font-bold text-warning mb-2 text-sm\">Tenant Context</div>\n              <div className=\"space-y-1 text-base-content\">\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Auth:</span>\n                  <span className={debugContext.authenticated ? \"text-success\" : \"text-error\"}>\n                    {debugContext.authenticated ? \"Yes\" : \"No\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">User ID:</span>\n                  <span className=\"truncate max-w-32\" title={debugContext.userId}>\n                    {debugContext.userId || \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Email:</span>\n                  <span className=\"truncate max-w-32\" title={debugContext.userEmail}>\n                    {debugContext.userEmail || \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">User Role:</span>\n                  <span>{debugContext.userRole || \"-\"}</span>\n                </div>\n                <hr className=\"border-base-300 my-1\" />\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Dealer ID:</span>\n                  <span className=\"truncate max-w-32\" title={debugContext.dealerId}>\n                    {debugContext.dealerId || \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Dealer:</span>\n                  <span className=\"truncate max-w-32\" title={debugContext.dealerName}>\n                    {debugContext.dealerName || \"-\"}\n                  </span>\n                </div>\n                <div className=\"flex justify-between gap-4\">\n                  <span className=\"text-base-content/60\">Membership:</span>\n                  <span>{debugContext.membershipRole || \"-\"}</span>\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","structuredPatch":[{"oldStart":484,"oldLines":27,"newStart":484,"newLines":46,"lines":["           </button>","           <div className=\"flex-1 lg:flex-none\" />","           <div className=\"flex items-center gap-3\">","-            {/* Quick Add Form Button */}","+            {/* Quick Add Button */}","             <div className=\"dropdown dropdown-end\">","               <label tabIndex={0} className=\"flex items-center justify-center w-9 h-9 rounded-xl bg-[#0066CC] hover:bg-[#0055AA] text-white cursor-pointer transition-all duration-200 shadow-sm hover:shadow-md\">","                 <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">","                   <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />","                 </svg>","               </label>","-              <ul tabIndex={0} className=\"dropdown-content z-50 menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100\">","-                {forms.length === 0 ? (","-                  <li><span className=\"text-base-content/60 text-sm\">No forms available</span></li>","-                ) : (","-                  forms.map((form) => (","-                    <li key={form.id || form._id}>","-                      <button","-                        onClick={() => handleFormClick(form)}","-                        className=\"text-sm text-left\"","-                      >","-                        <span className=\"truncate\">{form.name}</span>","-                      </button>","-                    </li>","-                  ))","+              <ul tabIndex={0} className=\"dropdown-content z-[9999] menu p-2 shadow-xl bg-white rounded-xl w-56 max-h-80 overflow-y-auto border border-slate-100 mt-1\">","+                {/* Quick Actions Section */}","+                <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">Quick Actions</li>","+                <li>","+                  <Link href={getPath(\"/appraisals/new\")} className=\"text-sm flex items-center gap-2\">","+                    <ClipboardIcon className=\"w-4 h-4 text-slate-500\" />","+                    <span>New Appraisal</span>","+                  </Link>","+                </li>","+                <li>","+                  <Link href={getPath(\"/sales-prep?addVehicle=1\")} className=\"text-sm flex items-center gap-2\">","+                    <TruckIcon className=\"w-4 h-4 text-slate-500\" />","+                    <span>Add Vehicle</span>","+                  </Link>","+                </li>","+","+                {/* Forms Section */}","+                {forms.length > 0 && (","+                  <>","+                    <div className=\"divider my-1 px-2\"></div>","+                    <li className=\"menu-title text-[10px] font-bold text-slate-400 uppercase tracking-wider px-3 py-2\">Forms</li>","+                    {forms.map((form) => (","+                      <li key={form.id || form._id}>","+                        <button","+                          onClick={() => handleFormClick(form)}","+                          className=\"text-sm text-left flex items-center gap-2\"","+                        >","+                          <DocumentTextIcon className=\"w-4 h-4 text-slate-400\" />","+                          <span className=\"truncate\">{form.name}</span>","+                        </button>","+                      </li>","+                    ))}","+                  </>","                 )}","               </ul>","             </div>"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"60db2524-087e-4379-bac8-38063c8c9157","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WKVtaUSVVA1qsKSZTW5Xdi","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to update the sales-prep.js page to handle the `addVehicle` query parameter so that the \"Add Vehicle\" link from the Quick Add menu opens the modal automatically. Let me search for how the page handles query params and add the necessary useEffect.","signature":"EqoDCkYICxgCKkAAejQvxawST8qzLignunq81ZhFvGXp0hpPQRypRJlxbk75HeqsgtpytgEmKMLt9Z11zJGFiBkJy8kJ4O61nuSBEgxNgSkJFTCQ3FLAdqAaDGIodeSqQyjzvpg2NiIwLiDvpMtGSHjnmsuNqDoFE24X1ovBB+YwEQlc7mQ/EVALzLWpeS6wPhU6Owf9cBCFKpECea2zUZtF5+LnCmg7lTfbBYGRH5HsA33Q60CL/6Yp6arW5csCPyYXixc614WfaKHyKjPOM6yZgcGOKfRkfT56OwN3AaXcojfL9cPVk2daefDDYP46CSMi4OuPnP8ghh0R1cUaMsfCitAo7iugkTBfIAWZMyLA8zS/dGb7rl65gJxhcL2IUF8IvJcmxq3i9zPzqnqhgJTD4MiFO2Kx7qWqUi/cwqott7kMZk/pkSFBlDgKQ1pjVOe7wszwOikKU9G7kPoCimvXGZ+Y0M5uoZvVbOX9qEA3SNZ9jGqiKhxtJ5PZUWvkJmhIX4ggFj/euZY2P+uk0JVSR33nIM2T6m8T+qzqbCgOKfDtjZXPj4PEQ4LCGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2609,"cache_read_input_tokens":80184,"cache_creation":{"ephemeral_5m_input_tokens":2609,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8kxSHSCaJV7anEjiEy","type":"assistant","uuid":"c6f0db69-bf95-4018-b79e-339df7b895a1","timestamp":"2025-12-30T15:48:29.987Z"}
{"parentUuid":"c6f0db69-bf95-4018-b79e-339df7b895a1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WKVtaUSVVA1qsKSZTW5Xdi","type":"message","role":"assistant","content":[{"type":"text","text":"Now I need to update the sales-prep.js page to handle the `addVehicle` query parameter so that clicking \"Add Vehicle\" from the Quick Add menu automatically opens the modal:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2609,"cache_read_input_tokens":80184,"cache_creation":{"ephemeral_5m_input_tokens":2609,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8kxSHSCaJV7anEjiEy","type":"assistant","uuid":"0974994e-07d2-4bdf-ae1a-b5b4dcb2a8d0","timestamp":"2025-12-30T15:48:30.698Z"}
{"parentUuid":"0974994e-07d2-4bdf-ae1a-b5b4dcb2a8d0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WKVtaUSVVA1qsKSZTW5Xdi","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JVHGVJytey8cGv5HqcuRZJ","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","offset":195,"limit":30}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2609,"cache_read_input_tokens":80184,"cache_creation":{"ephemeral_5m_input_tokens":2609,"ephemeral_1h_input_tokens":0},"output_tokens":210,"service_tier":"standard"}},"requestId":"req_011CWd8kxSHSCaJV7anEjiEy","type":"assistant","uuid":"540a9010-8e2e-4184-b89f-85e13c7765bc","timestamp":"2025-12-30T15:48:32.046Z"}
{"parentUuid":"540a9010-8e2e-4184-b89f-85e13c7765bc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JVHGVJytey8cGv5HqcuRZJ","type":"tool_result","content":"   195→  useEffect(() => {\n   196→    fetchVehicles();\n   197→    fetchLocations();\n   198→    fetchLabels();\n   199→  }, []);\n   200→\n   201→  const fetchVehicles = async () => {\n   202→    try {\n   203→      const res = await fetch(\"/api/vehicles\");\n   204→      if (!res.ok) {\n   205→        throw new Error(`API error: ${res.status}`);\n   206→      }\n   207→      const data = await res.json();\n   208→      setVehicles(Array.isArray(data) ? data : []);\n   209→    } catch (error) {\n   210→      console.error(\"Failed to load vehicles:\", error);\n   211→      toast.error(\"Failed to load vehicles\");\n   212→      setVehicles([]);\n   213→    } finally {\n   214→      setIsLoading(false);\n   215→    }\n   216→  };\n   217→\n   218→  const fetchLocations = async () => {\n   219→    try {\n   220→      const res = await fetch(\"/api/locations\");\n   221→      const data = await res.json();\n   222→      setLocations(data);\n   223→    } catch (error) {\n   224→      console.error(\"Failed to load locations:\", error);\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"d10ee113-d40c-43ff-a104-d7ec506f844e","timestamp":"2025-12-30T15:48:33.378Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","content":"  useEffect(() => {\n    fetchVehicles();\n    fetchLocations();\n    fetchLabels();\n  }, []);\n\n  const fetchVehicles = async () => {\n    try {\n      const res = await fetch(\"/api/vehicles\");\n      if (!res.ok) {\n        throw new Error(`API error: ${res.status}`);\n      }\n      const data = await res.json();\n      setVehicles(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"Failed to load vehicles:\", error);\n      toast.error(\"Failed to load vehicles\");\n      setVehicles([]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const fetchLocations = async () => {\n    try {\n      const res = await fetch(\"/api/locations\");\n      const data = await res.json();\n      setLocations(data);\n    } catch (error) {\n      console.error(\"Failed to load locations:\", error);","numLines":30,"startLine":195,"totalLines":5497}}}
{"parentUuid":"d10ee113-d40c-43ff-a104-d7ec506f844e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01E43JjKfYEQPSp8bvXZfxWo","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to add useRouter and handle the addVehicle query parameter. Let me check if the page already imports useRouter or not.","signature":"EqYCCkYICxgCKkBN5hVDX3i9cNa4tKIXUg6/8OyUswGWzM6/m2cFsFIBF6aB6KEiJO9OrpCzrKQ6TB9baZgZxIVd+htajLQBcblREgyxtQ0Y46U6lXjJHFkaDAl36laiCr0JLtaRoiIwP1YfFF5G2PlFDLW6yQf1VFPDkKPMxHnct5BmfiMLGi8vSh2gHkL+gaEu/43moj/yKo0B6nrCqllPJYvg02y/5wIw8/2WfXmgWX7BPDG79M3whMu+MfntjFO6bgPwLNOysMBZscB3sugG4/Ud6C29jh2CJRICa/MfpNejBrKan7T3XItqjl8VBjBaAkheYPoKHjDw37PlI3gKZ+hIxcO0hW8BOzRuMH+5Om53QWwc5Y339gQiwcDyOCvfix+gKG36GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":641,"cache_read_input_tokens":82793,"cache_creation":{"ephemeral_5m_input_tokens":641,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWd8mgcoVkgk8P7wYMLav","type":"assistant","uuid":"0d49ff38-97b7-462a-8156-fe25075ff05f","timestamp":"2025-12-30T15:48:39.425Z"}
{"parentUuid":"0d49ff38-97b7-462a-8156-fe25075ff05f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01E43JjKfYEQPSp8bvXZfxWo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TEDemfdpBuArzmXMEZtW87","name":"Grep","input":{"pattern":"import.*useRouter|from \"next/router\"","path":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":641,"cache_read_input_tokens":82793,"cache_creation":{"ephemeral_5m_input_tokens":641,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWd8mgcoVkgk8P7wYMLav","type":"assistant","uuid":"6cba0c95-7348-4d92-9b09-eb70a44c057e","timestamp":"2025-12-30T15:48:41.236Z"}
{"parentUuid":"6cba0c95-7348-4d92-9b09-eb70a44c057e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TEDemfdpBuArzmXMEZtW87","type":"tool_result","content":"No matches found"}]},"uuid":"08cb249b-982c-477d-b6ad-86d4aa221ff4","timestamp":"2025-12-30T15:48:42.552Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"","numLines":0}}
{"parentUuid":"08cb249b-982c-477d-b6ad-86d4aa221ff4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LBoim7JHiivsByZoAqbFff","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The sales-prep.js page doesn't import useRouter. I need to add it and then add a useEffect to handle the query parameter. Let me add the import and the effect.","signature":"EsgCCkYICxgCKkDy49V9FVW7tu52g8ogqF25Jl5LXupPTu4dZS+8xvx+NqNHPwrW5F9HZlZ75oJL+DyS+kOEAeFN5KjWWbW+7el2EgzDmrVVUMS6H7AvNI8aDHxkzRQnIt4KBK2KiSIwFiOr26otboKQq1tjj3WCCDMYeYNi0bZF2wAQ8ZAzgKNMxuL/iOClamKyH1Pw62nCKq8BR8chxfXeLR52DsJWmbBhisB+i69RUa74h3MEZp9FtmifOvUQ6PqHPJGI8Omxz99sYWNdW3O96J8CaGywMV58UGRVsEOeh9h0FCXmVG+3bFDD48f7g3i595oYD/6Q3OS3iAMZSv1E2K//cx72CVwBRcC6KZ/Clpchle2Ya29wt2KFnHEqrXCAH7acaQEjLb0tnL/cfeUnlavpayXpktSSPRYmkQDoBBq1Dmro92PfJhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":191,"cache_read_input_tokens":83434,"cache_creation":{"ephemeral_5m_input_tokens":191,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8nM9Jde2SSdpcSthPK","type":"assistant","uuid":"4ae86475-a718-4a33-88fb-db0a6d9e1d65","timestamp":"2025-12-30T15:48:48.116Z"}
{"parentUuid":"4ae86475-a718-4a33-88fb-db0a6d9e1d65","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LBoim7JHiivsByZoAqbFff","type":"message","role":"assistant","content":[{"type":"text","text":"The sales-prep.js page doesn't use useRouter yet. I need to add the import and the effect to handle the query parameter:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":191,"cache_read_input_tokens":83434,"cache_creation":{"ephemeral_5m_input_tokens":191,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8nM9Jde2SSdpcSthPK","type":"assistant","uuid":"0c6a251c-97a7-4f45-9a7c-57f02d1a9bd7","timestamp":"2025-12-30T15:48:48.707Z"}
{"parentUuid":"0c6a251c-97a7-4f45-9a7c-57f02d1a9bd7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LBoim7JHiivsByZoAqbFff","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018xTX2HgNQ98HmXLec1QgS1","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","old_string":"import { useEffect, useState, useRef, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";","new_string":"import { useEffect, useState, useRef, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":191,"cache_read_input_tokens":83434,"cache_creation":{"ephemeral_5m_input_tokens":191,"ephemeral_1h_input_tokens":0},"output_tokens":264,"service_tier":"standard"}},"requestId":"req_011CWd8nM9Jde2SSdpcSthPK","type":"assistant","uuid":"2867e97a-d3c5-4aca-aaa6-6a9f5e61d79f","timestamp":"2025-12-30T15:48:51.047Z"}
{"type":"file-history-snapshot","messageId":"2867e97a-d3c5-4aca-aaa6-6a9f5e61d79f","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"2867e97a-d3c5-4aca-aaa6-6a9f5e61d79f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018xTX2HgNQ98HmXLec1QgS1","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→import { useEffect, useState, useRef, useCallback } from \"react\";\n     2→import Head from \"next/head\";\n     3→import Link from \"next/link\";\n     4→import { useRouter } from \"next/router\";\n     5→import DashboardLayout from \"@/components/DashboardLayout\";\n     6→import { toast } from \"react-hot-toast\";\n     7→import { showDummyNotification } from \"@/utils/notifications\";\n     8→import { BottomSheet } from \"@/components/ui/BottomSheet\";"}]},"uuid":"d7e92d50-83c5-4ca0-b74e-6eaab3f99a08","timestamp":"2025-12-30T15:48:52.375Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","oldString":"import { useEffect, useState, useRef, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";","newString":"import { useEffect, useState, useRef, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";","originalFile":"import { useEffect, useState, useRef, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport { toast } from \"react-hot-toast\";\nimport { showDummyNotification } from \"@/utils/notifications\";\nimport { BottomSheet } from \"@/components/ui/BottomSheet\";\nimport { Portal } from \"@/components/ui/Portal\";\nimport { MobileStageSelector } from \"@/components/ui/PageShell\";\n\nconst COLUMNS = [\n  { key: \"in_stock\", label: \"In Stock\", gradient: \"from-orange-100/60\", accent: \"border-l-orange-400\", accentBg: \"bg-orange-400\" },\n  { key: \"in_prep\", label: \"Advertised\", gradient: \"from-blue-100/60\", accent: \"border-l-blue-400\", accentBg: \"bg-blue-400\" },\n  { key: \"live\", label: \"Sold In Progress\", gradient: \"from-cyan-100/60\", accent: \"border-l-cyan-400\", accentBg: \"bg-cyan-400\" },\n  { key: \"reserved\", label: \"Completed\", gradient: \"from-emerald-100/60\", accent: \"border-l-emerald-400\", accentBg: \"bg-emerald-400\" },\n  { key: \"delivered\", label: \"Delivered\", gradient: \"from-teal-100/60\", accent: \"border-l-teal-400\", accentBg: \"bg-teal-400\" },\n];\n\nconst ISSUE_SUBCATEGORIES = {\n  mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n  electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n  bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n  interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n  tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n  mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n  service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n  fault_codes: [\"Engine\", \"Transmission\", \"ABS\", \"Airbag\", \"Emissions\", \"Other\"],\n  other: [\"General\", \"Misc\"],\n};\n\n// Sold statuses - these show \"Sold X days\" instead of \"In stock X days\"\nconst SOLD_STATUSES = [\"live\", \"reserved\", \"delivered\"];\n\n// Helper to compute duration label based on status\nconst getVehicleDuration = (vehicle) => {\n  const isSold = SOLD_STATUSES.includes(vehicle.status);\n\n  if (isSold) {\n    if (vehicle.soldAt) {\n      const daysSold = Math.floor((Date.now() - new Date(vehicle.soldAt).getTime()) / (1000 * 60 * 60 * 24));\n      return { days: daysSold, label: `Sold ${daysSold}d`, isSold: true };\n    }\n    // Legacy sold vehicle without soldAt - just show \"Sold\"\n    return { days: 0, label: \"Sold\", isSold: true };\n  }\n\n  const daysInStock = vehicle.createdAt\n    ? Math.floor((Date.now() - new Date(vehicle.createdAt).getTime()) / (1000 * 60 * 60 * 24))\n    : 0;\n  return { days: daysInStock, label: `${daysInStock}d in stock`, isSold: false };\n};\n\nexport default function SalesPrep() {\n  const [vehicles, setVehicles] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedVehicle, setSelectedVehicle] = useState(null);\n  const [isLookingUpDrawer, setIsLookingUpDrawer] = useState(false);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [draggedCard, setDraggedCard] = useState(null);\n  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });\n  const [newTaskName, setNewTaskName] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [editingTaskId, setEditingTaskId] = useState(null);\n  const [editingTaskName, setEditingTaskName] = useState(\"\");\n\n  // Parts ordering state\n  const [showPartsOrderModal, setShowPartsOrderModal] = useState(false);\n  const [partsOrderTaskId, setPartsOrderTaskId] = useState(null);\n  const [partsOrderForm, setPartsOrderForm] = useState({\n    supplierType: \"EURO_CAR_PARTS\",\n    supplierName: \"\",\n    orderRef: \"\",\n    expectedAt: \"\",\n    notes: \"\",\n  });\n  const [editingPartsOrderId, setEditingPartsOrderId] = useState(null);\n\n  // Column sorting state\n  const [columnSortOptions, setColumnSortOptions] = useState({});\n\n  // Job sheet share state\n  const [showJobSheetModal, setShowJobSheetModal] = useState(false);\n  const [jobSheetLink, setJobSheetLink] = useState(null);\n  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);\n\n  // Prep summary share state\n  const [showPrepSummaryModal, setShowPrepSummaryModal] = useState(false);\n  const [prepSummaryLink, setPrepSummaryLink] = useState(null);\n  const [isGeneratingPrepSummary, setIsGeneratingPrepSummary] = useState(false);\n\n  // Manual share fallback modal\n  const [showManualShareModal, setShowManualShareModal] = useState(false);\n  const [manualShareUrl, setManualShareUrl] = useState(\"\");\n\n  // Issues state\n  const [showAddIssueModal, setShowAddIssueModal] = useState(false);\n  const [editingIssue, setEditingIssue] = useState(null); // For edit mode\n  const [issueForm, setIssueForm] = useState({\n    category: \"\",\n    subcategory: \"\",\n    description: \"\",\n    actionNeeded: \"\",\n    priority: \"medium\",\n    location: \"\",\n    status: \"outstanding\",\n    notes: \"\",\n    photos: [],\n    partsRequired: false,\n    partsDetails: \"\",\n  });\n  const [issueUpdateContent, setIssueUpdateContent] = useState({});\n  const [expandedIssues, setExpandedIssues] = useState({});\n\n  // Filters state - with localStorage persistence\n  const [activeFilters, setActiveFilters] = useState([]);\n  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);\n  const filterButtonRef = useRef(null);\n  const [filterPopoverPos, setFilterPopoverPos] = useState({ top: 0, right: 0 });\n\n  // Calculate popover position when opening\n  const openFiltersDropdown = useCallback(() => {\n    if (filterButtonRef.current) {\n      const rect = filterButtonRef.current.getBoundingClientRect();\n      const viewportHeight = window.innerHeight;\n      const viewportWidth = window.innerWidth;\n\n      // Position below the button, aligned to right edge\n      let top = rect.bottom + 8;\n      let right = viewportWidth - rect.right;\n\n      // Ensure popover doesn't go below viewport (max 70vh height + 16px padding)\n      const popoverHeight = Math.min(viewportHeight * 0.7, 600);\n      if (top + popoverHeight > viewportHeight - 16) {\n        top = Math.max(16, viewportHeight - popoverHeight - 16);\n      }\n\n      // Ensure popover doesn't go off right edge\n      right = Math.max(16, right);\n\n      setFilterPopoverPos({ top, right });\n    }\n    setShowFiltersDropdown(true);\n  }, []);\n\n  // Load filters from localStorage on mount\n  useEffect(() => {\n    try {\n      const savedFilters = localStorage.getItem(\"salesPrepFilters\");\n      if (savedFilters) {\n        setActiveFilters(JSON.parse(savedFilters));\n      }\n    } catch (e) {\n      console.warn(\"Failed to load saved filters:\", e);\n    }\n  }, []);\n\n  // Save filters to localStorage when they change\n  useEffect(() => {\n    try {\n      localStorage.setItem(\"salesPrepFilters\", JSON.stringify(activeFilters));\n    } catch (e) {\n      console.warn(\"Failed to save filters:\", e);\n    }\n  }, [activeFilters]);\n\n  // Documents state\n  const [showAddDocumentModal, setShowAddDocumentModal] = useState(false);\n  const [documentForm, setDocumentForm] = useState({\n    name: \"\",\n    type: \"other\",\n    file: null,\n  });\n\n  // Location state\n  const [locations, setLocations] = useState([]);\n  const [showAddLocationModal, setShowAddLocationModal] = useState(false);\n\n  // Vehicle Labels state\n  const [availableLabels, setAvailableLabels] = useState([]);\n  const [showLabelsDropdown, setShowLabelsDropdown] = useState(false);\n  const [showAddLabelModal, setShowAddLabelModal] = useState(false);\n  const [newLabelForm, setNewLabelForm] = useState({ name: \"\", colour: \"#6366f1\" });\n\n  // Activity log state\n  const [activityData, setActivityData] = useState({ activities: [], total: 0, hasMore: false });\n  const [activityLoading, setActivityLoading] = useState(false);\n\n  // VRM Search state\n  const [vrmSearch, setVrmSearch] = useState(\"\");\n  const [showVrmDropdown, setShowVrmDropdown] = useState(false);\n\n  // Mobile state\n  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"in_stock\");\n\n  useEffect(() => {\n    fetchVehicles();\n    fetchLocations();\n    fetchLabels();\n  }, []);\n\n  const fetchVehicles = async () => {\n    try {\n      const res = await fetch(\"/api/vehicles\");\n      if (!res.ok) {\n        throw new Error(`API error: ${res.status}`);\n      }\n      const data = await res.json();\n      setVehicles(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"Failed to load vehicles:\", error);\n      toast.error(\"Failed to load vehicles\");\n      setVehicles([]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const fetchLocations = async () => {\n    try {\n      const res = await fetch(\"/api/locations\");\n      const data = await res.json();\n      setLocations(data);\n    } catch (error) {\n      console.error(\"Failed to load locations:\", error);\n    }\n  };\n\n  const fetchLabels = async () => {\n    try {\n      const res = await fetch(\"/api/labels\");\n      const data = await res.json();\n      setAvailableLabels(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"Failed to load labels:\", error);\n    }\n  };\n\n  // Fetch vehicle activity log\n  const fetchActivity = async (vehicleId, loadMore = false) => {\n    if (!vehicleId) return;\n    setActivityLoading(true);\n    try {\n      const offset = loadMore ? activityData.activities.length : 0;\n      const res = await fetch(`/api/vehicles/${vehicleId}/activity?limit=25&offset=${offset}`);\n      const data = await res.json();\n      if (loadMore) {\n        setActivityData(prev => ({\n          activities: [...prev.activities, ...data.activities],\n          total: data.total,\n          hasMore: data.hasMore,\n        }));\n      } else {\n        setActivityData(data);\n      }\n    } catch (error) {\n      console.error(\"Failed to load activity:\", error);\n    } finally {\n      setActivityLoading(false);\n    }\n  };\n\n  // Format relative time for activity log\n  const formatRelativeTime = (dateStr) => {\n    const date = new Date(dateStr);\n    const now = new Date();\n    const diffMs = now - date;\n    const diffMins = Math.floor(diffMs / 60000);\n    const diffHours = Math.floor(diffMs / 3600000);\n    const diffDays = Math.floor(diffMs / 86400000);\n\n    if (diffMins < 1) return \"just now\";\n    if (diffMins < 60) return `${diffMins}m ago`;\n    if (diffHours < 24) return `${diffHours}h ago`;\n    if (diffDays < 7) return `${diffDays}d ago`;\n    return date.toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\" });\n  };\n\n  // Toggle a label on/off for a vehicle\n  const toggleVehicleLabel = async (vehicleId, labelId) => {\n    try {\n      const res = await fetch(`/api/vehicles/${vehicleId}/labels/${labelId}`, {\n        method: \"POST\",\n      });\n      if (res.ok) {\n        const updatedData = await res.json();\n        // Update selected vehicle if it's the same one\n        if (selectedVehicle?.id === vehicleId) {\n          setSelectedVehicle(prev => ({\n            ...prev,\n            labels: updatedData.labels || [],\n          }));\n        }\n        fetchVehicles();\n      }\n    } catch (error) {\n      toast.error(\"Failed to update label\");\n    }\n  };\n\n  // Create a new label\n  const createLabel = async () => {\n    if (!newLabelForm.name.trim()) {\n      toast.error(\"Label name is required\");\n      return;\n    }\n    try {\n      const res = await fetch(\"/api/labels\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(newLabelForm),\n      });\n      if (res.ok) {\n        const newLabel = await res.json();\n        setAvailableLabels(prev => [...prev, newLabel]);\n        setNewLabelForm({ name: \"\", colour: \"#6366f1\" });\n        setShowAddLabelModal(false);\n        toast.success(\"Label created\");\n      }\n    } catch (error) {\n      toast.error(\"Failed to create label\");\n    }\n  };\n\n  // Open vehicle drawer - vehicle from grid already has tasks, issues, documents\n  const openVehicleDrawer = (vehicle) => {\n    setSelectedVehicle({ ...vehicle, id: vehicle.id || vehicle._id });\n    setActiveTab(\"overview\");\n    setShowLabelsDropdown(false); // Close labels dropdown when opening new vehicle\n    setActivityData({ activities: [], total: 0, hasMore: false }); // Reset activity when opening new vehicle\n  };\n\n  const updateVehicleStatus = async (vehicleId, newStatus) => {\n    try {\n      await fetch(`/api/vehicles/${vehicleId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      });\n      fetchVehicles();\n      toast.success(`Moved to ${newStatus.replace(\"_\", \" \")}`);\n    } catch (error) {\n      toast.error(\"Failed to update\");\n    }\n  };\n\n  // DVLA lookup for existing vehicle in drawer\n  const lookupVehicleDVLA = async () => {\n    if (!selectedVehicle?.regCurrent) {\n      toast.error(\"No registration to lookup\");\n      return;\n    }\n    setIsLookingUpDrawer(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: selectedVehicle.regCurrent }),\n      });\n      const data = await res.json();\n\n      if (!res.ok || data.error) {\n        toast.error(data.message || data.error || \"Vehicle not found\");\n        return;\n      }\n\n      if (data.isDummy) showDummyNotification(\"DVLA API\");\n\n      // Update the vehicle with DVLA data\n      const updatePayload = {\n        make: data.make || selectedVehicle.make,\n        model: data.model || selectedVehicle.model,\n        year: data.yearOfManufacture || data.year || selectedVehicle.year,\n        colour: data.colour || selectedVehicle.colour,\n        fuelType: data.fuelType || selectedVehicle.fuelType,\n        transmission: data.transmission || selectedVehicle.transmission,\n        motExpiryDate: data.motExpiryDate || selectedVehicle.motExpiryDate,\n        dvlaDetails: data.dvlaDetails || null,\n        lastDvlaFetchAt: data.lastDvlaFetchAt || new Date().toISOString(),\n      };\n\n      await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updatePayload),\n      });\n\n      // Refresh vehicle data\n      const updatedRes = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const updatedVehicle = await updatedRes.json();\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n\n      toast.success(`Updated: ${data.make} ${data.model || \"\"} (${data.yearOfManufacture || \"\"})`);\n    } catch (error) {\n      toast.error(\"Lookup failed - please try again\");\n    } finally {\n      setIsLookingUpDrawer(false);\n    }\n  };\n\n  const updateTaskStatus = async (taskId, newStatus) => {\n    try {\n      const payload = { status: newStatus };\n      if (newStatus === \"done\") {\n        payload.completedAt = new Date().toISOString();\n      }\n      // Clear progress when changing status (optional: keep if staying in_progress)\n      if (newStatus !== \"in_progress\") {\n        payload.progress = \"NONE\";\n        payload.progressNote = \"\";\n      }\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n    } catch (error) {\n      toast.error(\"Failed to update task\");\n    }\n  };\n\n  // Update task progress sub-status (for parts ordering, booking, etc.)\n  const updateTaskProgress = async (taskId, progress, progressNote = null) => {\n    try {\n      const payload = { progress };\n      if (progressNote !== null) {\n        payload.progressNote = progressNote;\n      }\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n    } catch (error) {\n      toast.error(\"Failed to update task progress\");\n    }\n  };\n\n  // Parts order management functions\n  const openPartsOrderModal = (taskId, existingOrder = null) => {\n    setPartsOrderTaskId(taskId);\n    if (existingOrder) {\n      setEditingPartsOrderId(existingOrder._id || existingOrder.id);\n      setPartsOrderForm({\n        supplierType: existingOrder.supplierType || \"EURO_CAR_PARTS\",\n        supplierName: existingOrder.supplierName || \"\",\n        orderRef: existingOrder.orderRef || \"\",\n        expectedAt: existingOrder.expectedAt ? existingOrder.expectedAt.split(\"T\")[0] : \"\",\n        notes: existingOrder.notes || \"\",\n      });\n    } else {\n      setEditingPartsOrderId(null);\n      setPartsOrderForm({\n        supplierType: \"EURO_CAR_PARTS\",\n        supplierName: \"\",\n        orderRef: \"\",\n        expectedAt: \"\",\n        notes: \"\",\n      });\n    }\n    setShowPartsOrderModal(true);\n  };\n\n  const closePartsOrderModal = () => {\n    setShowPartsOrderModal(false);\n    setPartsOrderTaskId(null);\n    setEditingPartsOrderId(null);\n    setPartsOrderForm({\n      supplierType: \"EURO_CAR_PARTS\",\n      supplierName: \"\",\n      orderRef: \"\",\n      expectedAt: \"\",\n      notes: \"\",\n    });\n  };\n\n  const addPartsOrder = async () => {\n    if (!partsOrderTaskId) return;\n    try {\n      const orderData = {\n        supplierType: partsOrderForm.supplierType,\n        ...(partsOrderForm.supplierType === \"OTHER\" && partsOrderForm.supplierName && { supplierName: partsOrderForm.supplierName }),\n        ...(partsOrderForm.orderRef && { orderRef: partsOrderForm.orderRef }),\n        ...(partsOrderForm.expectedAt && { expectedAt: partsOrderForm.expectedAt }),\n        ...(partsOrderForm.notes && { notes: partsOrderForm.notes }),\n      };\n\n      await fetch(`/api/tasks/${partsOrderTaskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ addPartsOrder: orderData }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      closePartsOrderModal();\n      toast.success(\"Parts order added\");\n    } catch (error) {\n      toast.error(\"Failed to add parts order\");\n    }\n  };\n\n  const updatePartsOrder = async () => {\n    if (!partsOrderTaskId || !editingPartsOrderId) return;\n    try {\n      const orderData = {\n        orderId: editingPartsOrderId,\n        supplierType: partsOrderForm.supplierType,\n        supplierName: partsOrderForm.supplierType === \"OTHER\" ? partsOrderForm.supplierName : null,\n        orderRef: partsOrderForm.orderRef || null,\n        expectedAt: partsOrderForm.expectedAt || null,\n        notes: partsOrderForm.notes || null,\n      };\n\n      await fetch(`/api/tasks/${partsOrderTaskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ updatePartsOrder: orderData }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      closePartsOrderModal();\n      toast.success(\"Parts order updated\");\n    } catch (error) {\n      toast.error(\"Failed to update parts order\");\n    }\n  };\n\n  const removePartsOrder = async (taskId, orderId) => {\n    if (!confirm(\"Remove this parts order?\")) return;\n    try {\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ removePartsOrderId: orderId }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      toast.success(\"Parts order removed\");\n    } catch (error) {\n      toast.error(\"Failed to remove parts order\");\n    }\n  };\n\n  const markPartsReceived = async (taskId, orderId) => {\n    try {\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          updatePartsOrder: {\n            orderId,\n            status: \"RECEIVED\",\n            receivedAt: new Date().toISOString(),\n          },\n        }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      toast.success(\"Parts marked as received\");\n    } catch (error) {\n      toast.error(\"Failed to update parts order\");\n    }\n  };\n\n  // Helper to get supplier display name\n  const getSupplierDisplay = (order) => {\n    const labels = {\n      EURO_CAR_PARTS: \"Euro Car Parts\",\n      TPS: \"TPS\",\n      MAIN_DEALER: \"Main Dealer\",\n      LOCAL_FACTOR: \"Local Factor\",\n      ONLINE: \"Online\",\n      OTHER: order.supplierName || \"Other\",\n    };\n    return labels[order.supplierType] || order.supplierType;\n  };\n\n  const updateTaskName = async (taskId, newName) => {\n    if (!newName.trim()) {\n      toast.error(\"Task name cannot be empty\");\n      return;\n    }\n    try {\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: newName }),\n      });\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      setEditingTaskId(null);\n      setEditingTaskName(\"\");\n      toast.success(\"Task updated\");\n    } catch (error) {\n      toast.error(\"Failed to update task\");\n    }\n  };\n\n  const addTask = async () => {\n    if (!newTaskName.trim()) return toast.error(\"Task name is required\");\n    try {\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/tasks`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: newTaskName }),\n      });\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.error || \"Failed to add task\");\n      }\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      setNewTaskName(\"\");\n      fetchVehicles();\n      toast.success(\"Task added\");\n    } catch (error) {\n      console.error(\"Add task error:\", error);\n      toast.error(error.message || \"Failed to add task\");\n    }\n  };\n\n  const deleteTask = async (taskId) => {\n    try {\n      await fetch(`/api/tasks/${taskId}`, { method: \"DELETE\" });\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Task removed\");\n    } catch (error) {\n      toast.error(\"Failed to delete task\");\n    }\n  };\n\n  // Issue functions\n  const addIssue = async (photoUrls = []) => {\n    if (!issueForm.category || !issueForm.subcategory || !issueForm.description) {\n      return toast.error(\"Category, subcategory, and description are required\");\n    }\n    try {\n      const issueData = {\n        ...issueForm,\n        photos: [...(issueForm.photos || []), ...photoUrls],\n      };\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/issues`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(issueData),\n      });\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.error || \"Failed to add issue\");\n      }\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      setShowAddIssueModal(false);\n      setIssueForm({\n        category: \"\",\n        subcategory: \"\",\n        description: \"\",\n        actionNeeded: \"\",\n        status: \"outstanding\",\n        notes: \"\",\n        photos: [],\n      });\n      toast.success(\"Issue added\");\n    } catch (error) {\n      console.error(\"Add issue error:\", error);\n      toast.error(error.message || \"Failed to add issue\");\n    }\n  };\n\n  const updateIssue = async (issueId, updates) => {\n    try {\n      const res = await fetch(`/api/issues/${issueId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) throw new Error(\"Failed to update issue\");\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Issue updated\");\n    } catch (error) {\n      toast.error(\"Failed to update issue\");\n    }\n  };\n\n  // Open edit issue modal with prefilled data\n  const openEditIssue = (issue) => {\n    setEditingIssue(issue);\n    setIssueForm({\n      category: issue.category?.toLowerCase() || \"\",\n      subcategory: issue.subcategory || \"\",\n      description: issue.description || \"\",\n      actionNeeded: issue.actionNeeded || \"\",\n      priority: issue.priority || \"medium\",\n      location: issue.location || \"\",\n      status: issue.status?.toLowerCase().replace(\" \", \"_\") || \"outstanding\",\n      notes: issue.notes || \"\",\n      photos: issue.photos || [],\n      partsRequired: issue.partsRequired || false,\n      partsDetails: issue.partsDetails || \"\",\n    });\n    setShowAddIssueModal(true);\n  };\n\n  // Save edited issue\n  const saveEditedIssue = async (photoUrls = []) => {\n    if (!editingIssue) return;\n    try {\n      const updates = {\n        ...issueForm,\n        photos: [...(issueForm.photos || []), ...photoUrls],\n      };\n      await updateIssue(editingIssue.id, updates);\n      setShowAddIssueModal(false);\n      setEditingIssue(null);\n      setIssueForm({\n        category: \"\",\n        subcategory: \"\",\n        description: \"\",\n        actionNeeded: \"\",\n        priority: \"medium\",\n        location: \"\",\n        status: \"outstanding\",\n        notes: \"\",\n        photos: [],\n        partsRequired: false,\n        partsDetails: \"\",\n      });\n    } catch (error) {\n      toast.error(\"Failed to save issue\");\n    }\n  };\n\n  const deleteIssue = async (issueId) => {\n    try {\n      await fetch(`/api/issues/${issueId}`, { method: \"DELETE\" });\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Issue removed\");\n    } catch (error) {\n      toast.error(\"Failed to delete issue\");\n    }\n  };\n\n  const addIssueUpdate = async (issueId, content) => {\n    if (!content?.trim()) {\n      return toast.error(\"Update content cannot be empty\");\n    }\n\n    try {\n      await fetch(`/api/issues/${issueId}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          content: content.trim(),\n          userName: \"Current User\" // TODO: Replace with actual user name from auth\n        }),\n      });\n\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      setIssueUpdateContent(prev => ({ ...prev, [issueId]: \"\" }));\n      toast.success(\"Update added\");\n    } catch (error) {\n      toast.error(\"Failed to add update\");\n    }\n  };\n\n  // Document functions\n  const uploadDocument = async (file, name, type) => {\n    if (!file) return;\n\n    try {\n      // First upload the file\n      const uploadFormData = new FormData();\n      uploadFormData.append(\"file\", file);\n\n      const uploadRes = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: uploadFormData,\n      });\n      if (!uploadRes.ok) throw new Error(\"File upload failed\");\n      const uploadData = await uploadRes.json();\n\n      // Then create the document record with the URL\n      const docRes = await fetch(`/api/vehicles/${selectedVehicle.id}/documents`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name, type, url: uploadData.url }),\n      });\n      if (!docRes.ok) throw new Error(\"Document creation failed\");\n\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      setShowAddDocumentModal(false);\n      setDocumentForm({ name: \"\", type: \"other\", file: null });\n      toast.success(\"Document uploaded\");\n    } catch (error) {\n      console.error(\"Upload error:\", error);\n      toast.error(\"Failed to upload document\");\n    }\n  };\n\n  const deleteDocument = async (documentId) => {\n    try {\n      await fetch(`/api/documents/${documentId}`, { method: \"DELETE\" });\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Document removed\");\n    } catch (error) {\n      toast.error(\"Failed to delete document\");\n    }\n  };\n\n  const handleDragStart = (e, vehicle) => {\n    setDraggedCard(vehicle);\n    setDragPosition({ x: e.clientX, y: e.clientY });\n    e.dataTransfer.effectAllowed = \"move\";\n    // Create invisible drag image (we'll render our own preview)\n    const emptyImg = new Image();\n    emptyImg.src = \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\";\n    e.dataTransfer.setDragImage(emptyImg, 0, 0);\n  };\n\n  const handleDrag = (e) => {\n    if (e.clientX !== 0 && e.clientY !== 0) {\n      setDragPosition({ x: e.clientX, y: e.clientY });\n    }\n  };\n\n  const handleDragOver = (e) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDragEnd = () => {\n    setDraggedCard(null);\n  };\n\n  const handleDrop = async (e, newStatus) => {\n    e.preventDefault();\n    if (!draggedCard || draggedCard.status === newStatus) {\n      setDraggedCard(null);\n      return;\n    }\n    const vehicleId = draggedCard.id || draggedCard._id;\n    await updateVehicleStatus(vehicleId, newStatus);\n    setDraggedCard(null);\n  };\n\n  const uploadV5 = async (file) => {\n    if (!file) return;\n\n    try {\n      // First upload the file\n      const formData = new FormData();\n      formData.append(\"file\", file);\n\n      const uploadRes = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: formData,\n      });\n      if (!uploadRes.ok) throw new Error(\"Upload failed\");\n      const uploadData = await uploadRes.json();\n\n      // Then update the vehicle with the V5 URL\n      await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ v5Url: uploadData.url }),\n      });\n\n      const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updated);\n      fetchVehicles();\n      toast.success(\"V5 uploaded\");\n    } catch (error) {\n      console.error(\"V5 upload error:\", error);\n      toast.error(\"Failed to upload V5\");\n    }\n  };\n\n  const formatDate = (date) => {\n    if (!date) return \"—\";\n    return new Date(date).toLocaleDateString(\"en-GB\", { day: \"2-digit\", month: \"short\", year: \"numeric\" });\n  };\n\n  const toggleFilter = (filter) => {\n    setActiveFilters(prev =>\n      prev.includes(filter)\n        ? prev.filter(f => f !== filter)\n        : [...prev, filter]\n    );\n  };\n\n  const getFilteredVehicles = (vehicleList) => {\n    if (activeFilters.length === 0) return vehicleList;\n\n    return vehicleList.filter(vehicle => {\n      return activeFilters.every(filter => {\n        const tasks = vehicle.tasks || [];\n        const issues = vehicle.issues || [];\n        const activeIssues = issues.filter(i => {\n          const status = (i.status || \"\").toLowerCase();\n          return [\"outstanding\", \"ordered\", \"in progress\", \"in_progress\"].includes(status);\n        });\n\n        // Prep task filters\n        if (filter === \"awaiting_pdi\") return !tasks.find(t => t.name.toLowerCase().includes(\"pdi\") && t.status === \"done\");\n        if (filter === \"awaiting_valet\") return !tasks.find(t => t.name.toLowerCase().includes(\"valet\") && t.status === \"done\");\n        if (filter === \"awaiting_photos\") return !tasks.find(t => t.name.toLowerCase().includes(\"photo\") && t.status === \"done\");\n        if (filter === \"awaiting_mot\") return !tasks.find(t => t.name.toLowerCase().includes(\"mot\") && t.status === \"done\");\n\n        // Issue filters\n        if (filter === \"needs_paint\") return activeIssues.some(i => {\n          const cat = (i.category || \"\").toLowerCase();\n          return cat === \"bodywork\" || cat === \"cosmetic\";\n        });\n        if (filter === \"needs_mechanical\") return activeIssues.some(i => {\n          const cat = (i.category || \"\").toLowerCase();\n          return cat === \"mechanical\";\n        });\n        if (filter === \"needs_electrical\") return activeIssues.some(i => {\n          const cat = (i.category || \"\").toLowerCase();\n          return cat === \"electrical\";\n        });\n\n        // Location filter\n        if (filter === \"offsite\") return vehicle.locationId != null;\n\n        // MOT filters\n        if (filter === \"mot_due_soon\") {\n          if (!vehicle.motExpiryDate) return false;\n          const expiry = new Date(vehicle.motExpiryDate);\n          const now = new Date();\n          const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));\n          return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;\n        }\n        if (filter === \"mot_expired\") {\n          if (!vehicle.motExpiryDate) return false;\n          const expiry = new Date(vehicle.motExpiryDate);\n          const now = new Date();\n          return expiry < now;\n        }\n\n        // Sale type filters\n        if (filter === \"trade_only\") return vehicle.saleType === \"TRADE\";\n        if (filter === \"retail_only\") return vehicle.saleType === \"RETAIL\" || !vehicle.saleType;\n\n        // Vehicle type filters\n        if (filter === \"type_stock\") return vehicle.type === \"STOCK\" || !vehicle.type;\n        if (filter === \"type_courtesy\") return vehicle.type === \"COURTESY\";\n        if (filter === \"type_fleet\") return vehicle.type === \"FLEET_OTHER\";\n\n        return true;\n      });\n    });\n  };\n\n  const getVehiclesByStatus = (status) => {\n    const statusVehicles = vehicles.filter(v => v.status === status);\n    const filtered = getFilteredVehicles(statusVehicles);\n\n    // Apply sorting based on columnSortOptions\n    const sortOption = columnSortOptions[status] || \"oldest_first\";\n\n    return [...filtered].sort((a, b) => {\n      const daysA = a.createdAt ? Math.floor((new Date() - new Date(a.createdAt)) / (1000 * 60 * 60 * 24)) : 0;\n      const daysB = b.createdAt ? Math.floor((new Date() - new Date(b.createdAt)) / (1000 * 60 * 60 * 24)) : 0;\n\n      switch (sortOption) {\n        case \"oldest_first\":\n          return daysB - daysA; // More days = older = first\n        case \"newest_first\":\n          return daysA - daysB; // Fewer days = newer = first\n        case \"alphabetical\":\n          const nameA = `${a.make || \"\"} ${a.model || \"\"}`.toLowerCase();\n          const nameB = `${b.make || \"\"} ${b.model || \"\"}`.toLowerCase();\n          return nameA.localeCompare(nameB);\n        default:\n          return daysB - daysA;\n      }\n    });\n  };\n\n  const getFilterCount = (filter) => {\n    const allFiltered = getFilteredVehicles(vehicles.filter(v => {\n      const tasks = v.tasks || [];\n      const issues = v.issues || [];\n      const activeIssues = issues.filter(i => {\n        const status = (i.status || \"\").toLowerCase();\n        return [\"outstanding\", \"ordered\", \"in progress\", \"in_progress\"].includes(status);\n      });\n\n      if (filter === \"awaiting_pdi\") return !tasks.find(t => t.name.toLowerCase().includes(\"pdi\") && t.status === \"done\");\n      if (filter === \"awaiting_valet\") return !tasks.find(t => t.name.toLowerCase().includes(\"valet\") && t.status === \"done\");\n      if (filter === \"awaiting_photos\") return !tasks.find(t => t.name.toLowerCase().includes(\"photo\") && t.status === \"done\");\n      if (filter === \"awaiting_mot\") return !tasks.find(t => t.name.toLowerCase().includes(\"mot\") && t.status === \"done\");\n      if (filter === \"needs_paint\") return activeIssues.some(i => {\n        const cat = (i.category || \"\").toLowerCase();\n        return cat === \"bodywork\" || cat === \"cosmetic\";\n      });\n      if (filter === \"needs_mechanical\") return activeIssues.some(i => {\n        const cat = (i.category || \"\").toLowerCase();\n        return cat === \"mechanical\";\n      });\n      if (filter === \"needs_electrical\") return activeIssues.some(i => {\n        const cat = (i.category || \"\").toLowerCase();\n        return cat === \"electrical\";\n      });\n      if (filter === \"offsite\") return v.locationId != null;\n      if (filter === \"mot_due_soon\") {\n        if (!v.motExpiryDate) return false;\n        const expiry = new Date(v.motExpiryDate);\n        const now = new Date();\n        const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));\n        return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;\n      }\n      if (filter === \"mot_expired\") {\n        if (!v.motExpiryDate) return false;\n        const expiry = new Date(v.motExpiryDate);\n        return expiry < new Date();\n      }\n      if (filter === \"trade_only\") return v.saleType === \"TRADE\";\n      if (filter === \"retail_only\") return v.saleType === \"RETAIL\" || !v.saleType;\n      if (filter === \"type_stock\") return v.type === \"STOCK\" || !v.type;\n      if (filter === \"type_courtesy\") return v.type === \"COURTESY\";\n      if (filter === \"type_fleet\") return v.type === \"FLEET_OTHER\";\n      return false;\n    }));\n    return allFiltered.length;\n  };\n\n  // VRM Search functions\n  const getVrmSearchResults = () => {\n    if (vrmSearch.length < 2) return [];\n    const searchTerm = vrmSearch.toUpperCase().replace(/\\s/g, \"\");\n    return vehicles.filter(v => {\n      const reg = (v.regCurrent || \"\").toUpperCase().replace(/\\s/g, \"\");\n      return reg.includes(searchTerm);\n    }).slice(0, 8); // Limit to 8 results\n  };\n\n  const handleVrmSelect = (vehicle) => {\n    // Close dropdown and clear search\n    setVrmSearch(\"\");\n    setShowVrmDropdown(false);\n\n    // Find which column this vehicle is in and scroll to it\n    const columnIndex = COLUMNS.findIndex(col => col.key === vehicle.status);\n    if (columnIndex >= 0) {\n      // Scroll the column into view\n      const columnElements = document.querySelectorAll('[data-column-key]');\n      if (columnElements[columnIndex]) {\n        columnElements[columnIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });\n      }\n    }\n\n    // Open the vehicle drawer with full details\n    openVehicleDrawer(vehicle);\n  };\n\n  const getStatusLabel = (statusKey) => {\n    const col = COLUMNS.find(c => c.key === statusKey);\n    return col ? col.label : statusKey;\n  };\n\n  const handlePrintVehicle = () => {\n    if (!selectedVehicle) return;\n\n    const vehicle = selectedVehicle;\n    const tasks = vehicle.tasks || [];\n    const issues = vehicle.issues || [];\n    const documents = vehicle.documents || [];\n    const completedTasks = tasks.filter(t => t.status === \"done\").length;\n    const daysInStock = vehicle.createdAt\n      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))\n      : 0;\n\n    // Get status label from COLUMNS\n    const statusColumn = COLUMNS.find(col => col.key === vehicle.status);\n    const statusLabel = statusColumn ? statusColumn.label : vehicle.status;\n\n    // Generate HTML for print\n    const printContent = `\n<!DOCTYPE html>\n<html>\n<head>\n  <title>${vehicle.year || \"\"} ${vehicle.make} ${vehicle.model} - ${vehicle.regCurrent}</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }\n    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }\n    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }\n    .reg { font-size: 18px; font-family: monospace; color: #64748b; }\n    .section { margin-bottom: 30px; }\n    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }\n    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }\n    .field { margin-bottom: 12px; }\n    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }\n    .field-value { font-size: 14px; color: #1e293b; }\n    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }\n    .badge-status { background: #e0e7ff; color: #4338ca; }\n    .badge-days { background: ${daysInStock > 30 ? '#fef2f2' : '#f1f5f9'}; color: ${daysInStock > 30 ? '#dc2626' : '#475569'}; }\n    .task-list { list-style: none; }\n    .task-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }\n    .task-status { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }\n    .task-done { background: #dcfce7; color: #16a34a; }\n    .task-pending { background: #fef3c7; color: #d97706; }\n    .task-progress { background: #dbeafe; color: #2563eb; }\n    .issue-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }\n    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; }\n    .issue-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; }\n    .issue-desc { font-size: 14px; color: #1e293b; }\n    .doc-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }\n    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }\n    @media print {\n      body { padding: 20px; }\n      .no-print { display: none; }\n    }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <div class=\"title\">${vehicle.year || \"\"} ${vehicle.make} ${vehicle.model}</div>\n    <div class=\"reg\">${vehicle.regCurrent}</div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Overview</div>\n    <div style=\"display: flex; gap: 12px; margin-bottom: 16px;\">\n      <span class=\"badge badge-status\">${statusLabel}</span>\n      <span class=\"badge badge-days\">Days in Stock: ${daysInStock}</span>\n      ${vehicle.locationId ? `<span class=\"badge\" style=\"background:#eef2ff;color:#4f46e5;\">📍 ${vehicle.locationId.name || 'Offsite'}</span>` : '<span class=\"badge\" style=\"background:#f0fdf4;color:#16a34a;\">📍 On Site</span>'}\n    </div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Vehicle Details</div>\n    <div class=\"grid\">\n      <div class=\"field\">\n        <div class=\"field-label\">Registration</div>\n        <div class=\"field-value\">${vehicle.regCurrent || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">VIN</div>\n        <div class=\"field-value\">${vehicle.vin || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Make</div>\n        <div class=\"field-value\">${vehicle.make || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Model</div>\n        <div class=\"field-value\">${vehicle.model || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Year</div>\n        <div class=\"field-value\">${vehicle.year || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Mileage</div>\n        <div class=\"field-value\">${vehicle.mileageCurrent ? vehicle.mileageCurrent.toLocaleString() + ' miles' : '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Colour</div>\n        <div class=\"field-value\">${vehicle.colour || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Fuel Type</div>\n        <div class=\"field-value\">${vehicle.fuelType || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">MOT Expiry</div>\n        <div class=\"field-value\">${vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : '—'}</div>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Prep Checklist (${completedTasks}/${tasks.length} complete)</div>\n    ${tasks.length > 0 ? `\n    <ul class=\"task-list\">\n      ${tasks.map(task => `\n        <li class=\"task-item\">\n          <span class=\"task-status ${task.status === 'done' ? 'task-done' : task.status === 'in_progress' ? 'task-progress' : 'task-pending'}\">\n            ${task.status === 'done' ? '✓' : task.status === 'in_progress' ? '→' : '○'}\n          </span>\n          <span style=\"${task.status === 'done' ? 'text-decoration: line-through; color: #94a3b8;' : ''}\">${task.name}</span>\n          ${task.completedAt ? `<span style=\"font-size: 11px; color: #94a3b8; margin-left: auto;\">${new Date(task.completedAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</span>` : ''}\n        </li>\n      `).join('')}\n    </ul>\n    ` : '<p style=\"color: #94a3b8; font-size: 14px;\">No tasks</p>'}\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Issues (${issues.length})</div>\n    ${issues.length > 0 ? issues.map(issue => `\n      <div class=\"issue-card\">\n        <div class=\"issue-header\">\n          <span class=\"issue-badge\">${issue.category}</span>\n          ${issue.subcategory ? `<span class=\"issue-badge\">${issue.subcategory}</span>` : ''}\n          <span class=\"issue-badge\" style=\"margin-left: auto;\">${issue.status || 'Outstanding'}</span>\n        </div>\n        <div class=\"issue-desc\">${issue.description}</div>\n        ${issue.actionNeeded ? `<div style=\"font-size: 12px; color: #64748b; margin-top: 6px;\">Action: ${issue.actionNeeded}</div>` : ''}\n      </div>\n    `).join('') : '<p style=\"color: #94a3b8; font-size: 14px;\">No issues recorded</p>'}\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Documents (${documents.length})</div>\n    ${documents.length > 0 ? documents.map(doc => `\n      <div class=\"doc-item\">\n        <span style=\"font-weight: 500;\">${doc.name}</span>\n        <span style=\"font-size: 12px; color: #94a3b8; margin-left: 8px;\">(${doc.type.replace(/_/g, ' ')})</span>\n      </div>\n    `).join('') : '<p style=\"color: #94a3b8; font-size: 14px;\">No documents uploaded</p>'}\n    ${vehicle.v5Url ? '<div class=\"doc-item\"><span style=\"font-weight: 500;\">V5 Document</span> <span style=\"font-size: 12px; color: #16a34a;\">✓ Uploaded</span></div>' : ''}\n  </div>\n\n  ${vehicle.notes ? `\n  <div class=\"section\">\n    <div class=\"section-title\">Notes</div>\n    <p style=\"font-size: 14px; white-space: pre-wrap;\">${vehicle.notes}</p>\n  </div>\n  ` : ''}\n\n  <div class=\"footer\">\n    Printed from DealerFlow on ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}\n  </div>\n</body>\n</html>\n    `;\n\n    // Open in new tab\n    const printWindow = window.open('', '_blank');\n    printWindow.document.write(printContent);\n    printWindow.document.close();\n  };\n\n  // Share utility with fallback chain: Web Share API → Clipboard → Manual modal\n  // SSR-safe: only runs client-side, with guards for browser API availability\n  const shareWithFallback = async (url, title, text) => {\n    // Guard against SSR - this should only run client-side\n    if (typeof window === \"undefined\" || typeof navigator === \"undefined\") {\n      return false;\n    }\n\n    // 1. Try Web Share API (native sharing on mobile/supported browsers)\n    if (typeof navigator.share === \"function\") {\n      try {\n        await navigator.share({ title, text, url });\n        return true;\n      } catch (error) {\n        // User cancelled or share failed - continue to fallback\n        if (error.name !== \"AbortError\") {\n          console.log(\"Web Share API failed, trying clipboard fallback\");\n        }\n      }\n    }\n\n    // 2. Try Clipboard API\n    if (navigator.clipboard && typeof navigator.clipboard.writeText === \"function\") {\n      try {\n        await navigator.clipboard.writeText(url);\n        toast.success(\"Link copied to clipboard!\");\n        return true;\n      } catch (error) {\n        console.log(\"Clipboard API failed, showing manual modal\");\n      }\n    }\n\n    // 3. Fallback to manual modal\n    setManualShareUrl(url);\n    setShowManualShareModal(true);\n    return false;\n  };\n\n  // Job sheet share handlers\n  const handleGenerateJobSheet = async () => {\n    if (!selectedVehicle) return;\n    setIsGeneratingJobSheet(true);\n    try {\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/job-sheet`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ expiresInDays: 60 }),\n      });\n      if (!res.ok) throw new Error(\"Failed to generate share link\");\n      const data = await res.json();\n      const fullUrl = `${window.location.origin}${data.shareUrl}`;\n      setJobSheetLink({\n        url: fullUrl,\n        expiresAt: data.expiresAt,\n      });\n      setShowJobSheetModal(true);\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsGeneratingJobSheet(false);\n    }\n  };\n\n  const copyJobSheetLink = async () => {\n    if (jobSheetLink?.url) {\n      await shareWithFallback(\n        jobSheetLink.url,\n        `Job Sheet - ${selectedVehicle?.regCurrent || \"Vehicle\"}`,\n        `Job sheet for ${selectedVehicle?.regCurrent}: ${jobSheetLink.url}`\n      );\n    }\n  };\n\n  const shareViaWhatsApp = () => {\n    if (typeof window === \"undefined\") return;\n    if (jobSheetLink?.url) {\n      const text = `Job sheet for ${selectedVehicle?.regCurrent || \"Vehicle\"}: ${jobSheetLink.url}`;\n      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, \"_blank\");\n    }\n  };\n\n  // Prep summary share handlers\n  const handleGeneratePrepSummary = async () => {\n    if (!selectedVehicle) return;\n    setIsGeneratingPrepSummary(true);\n    try {\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/prep-summary`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ expiresInDays: 60 }),\n      });\n      if (!res.ok) throw new Error(\"Failed to generate share link\");\n      const data = await res.json();\n      const fullUrl = `${window.location.origin}${data.shareUrl}`;\n      setPrepSummaryLink({\n        url: fullUrl,\n        expiresAt: data.expiresAt,\n      });\n      setShowPrepSummaryModal(true);\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsGeneratingPrepSummary(false);\n    }\n  };\n\n  const copyPrepSummaryLink = async () => {\n    if (prepSummaryLink?.url) {\n      await shareWithFallback(\n        prepSummaryLink.url,\n        `Prep Summary - ${selectedVehicle?.regCurrent || \"Vehicle\"}`,\n        `Prep summary for ${selectedVehicle?.regCurrent}: ${prepSummaryLink.url}`\n      );\n    }\n  };\n\n  const sharePrepSummaryViaWhatsApp = () => {\n    if (typeof window === \"undefined\") return;\n    if (prepSummaryLink?.url) {\n      const text = `Prep summary for ${selectedVehicle?.regCurrent || \"Vehicle\"}: ${prepSummaryLink.url}`;\n      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, \"_blank\");\n    }\n  };\n\n  const getMOTStatus = (motExpiryDate) => {\n    if (!motExpiryDate) {\n      return { type: \"unknown\", label: \"Unknown\", days: null, class: \"bg-slate-100 text-slate-500 border border-slate-200\" };\n    }\n    const expiry = new Date(motExpiryDate);\n    const now = new Date();\n    const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));\n\n    if (daysUntilExpiry < 0) {\n      const daysOverdue = Math.abs(daysUntilExpiry);\n      return { type: \"expired\", label: `Expired ${daysOverdue}d`, days: daysOverdue, class: \"bg-red-50 text-red-700 border border-red-200\" };\n    }\n    if (daysUntilExpiry <= 30) {\n      return { type: \"due_soon\", label: `${daysUntilExpiry}d`, days: daysUntilExpiry, class: \"bg-amber-50 text-amber-700 border border-amber-200\" };\n    }\n    return { type: \"valid\", label: `${daysUntilExpiry}d`, days: daysUntilExpiry, class: null };\n  };\n\n  const getActiveIssuesByCategory = (issues = []) => {\n    const activeIssues = issues.filter(i => {\n      const status = (i.status || \"\").toLowerCase();\n      return [\"outstanding\", \"ordered\", \"in_progress\", \"in progress\"].includes(status);\n    });\n    const categoryCounts = {};\n    activeIssues.forEach(issue => {\n      categoryCounts[issue.category] = (categoryCounts[issue.category] || 0) + 1;\n    });\n    return categoryCounts;\n  };\n\n  return (\n    <DashboardLayout>\n      <Head><title>Stock & Prep | DealerFlow</title></Head>\n\n      <div className=\"flex justify-between items-center mb-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Stock & Prep Board</h1>\n          <p className=\"text-base-content/60 mt-1\">Manage vehicle prep and sales pipeline &bull; Drag cards to move between stages</p>\n        </div>\n        <button className=\"btn btn-primary\" onClick={() => setShowAddModal(true)}>\n          + Add Vehicle\n        </button>\n      </div>\n\n      {/* Consolidated Filters */}\n      <div className=\"sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-slate-200 mb-4 -mx-6 px-6 py-4\">\n        <div className=\"flex gap-2 items-center\">\n            {/* VRM Search */}\n            <div className=\"relative\">\n              <div className=\"relative\">\n                <svg className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n                </svg>\n                <input\n                  type=\"text\"\n                  placeholder=\"Search VRM...\"\n                  className=\"input input-sm input-bordered pl-9 pr-8 w-44 font-mono uppercase\"\n                  value={vrmSearch}\n                  onChange={(e) => {\n                    setVrmSearch(e.target.value.toUpperCase());\n                    setShowVrmDropdown(e.target.value.length >= 2);\n                  }}\n                  onFocus={() => vrmSearch.length >= 2 && setShowVrmDropdown(true)}\n                  onKeyDown={(e) => {\n                    if (e.key === \"Escape\") {\n                      setShowVrmDropdown(false);\n                      e.target.blur();\n                    }\n                  }}\n                />\n                {vrmSearch && (\n                  <button\n                    className=\"absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600\"\n                    onClick={() => {\n                      setVrmSearch(\"\");\n                      setShowVrmDropdown(false);\n                    }}\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                    </svg>\n                  </button>\n                )}\n              </div>\n\n              {/* VRM Search Dropdown */}\n              {showVrmDropdown && (\n                <>\n                  <div className=\"fixed inset-0 z-10\" onClick={() => setShowVrmDropdown(false)}></div>\n                  <div className=\"absolute top-full left-0 mt-1 w-72 bg-white rounded-xl shadow-xl border border-slate-200 z-20 overflow-hidden\">\n                    {getVrmSearchResults().length > 0 ? (\n                      <ul className=\"py-1 max-h-64 overflow-y-auto\">\n                        {getVrmSearchResults().map((vehicle) => (\n                          <li key={vehicle.id || vehicle._id}>\n                            <button\n                              className=\"w-full px-4 py-2.5 text-left hover:bg-slate-50 flex items-center justify-between gap-2 transition-colors\"\n                              onClick={() => handleVrmSelect(vehicle)}\n                            >\n                              <div className=\"flex items-center gap-3\">\n                                <span className=\"font-mono font-bold text-slate-900\">{vehicle.regCurrent}</span>\n                                <span className=\"text-sm text-slate-500\">{vehicle.make} {vehicle.model}</span>\n                              </div>\n                              <span className=\"text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600\">\n                                {getStatusLabel(vehicle.status)}\n                              </span>\n                            </button>\n                          </li>\n                        ))}\n                      </ul>\n                    ) : (\n                      <div className=\"px-4 py-6 text-center\">\n                        <svg className=\"w-8 h-8 mx-auto text-slate-300 mb-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                        </svg>\n                        <p className=\"text-sm text-slate-500\">No vehicles found</p>\n                        <p className=\"text-xs text-slate-400 mt-1\">Try a different registration</p>\n                      </div>\n                    )}\n                  </div>\n                </>\n              )}\n            </div>\n\n            <div className=\"divider divider-horizontal mx-1\"></div>\n\n            {/* All Vehicles Button */}\n            <button\n              className={`btn btn-sm ${activeFilters.length === 0 ? \"btn-primary\" : \"btn-outline\"}`}\n              onClick={() => setActiveFilters([])}\n            >\n              All Vehicles ({vehicles.length})\n            </button>\n\n            <div className=\"divider divider-horizontal mx-1\"></div>\n\n            {/* Consolidated Filters - Strictly Separated Desktop/Mobile */}\n            <div className=\"shrink-0\">\n              {/* Trigger Button */}\n              <button\n                ref={filterButtonRef}\n                className={`flex items-center gap-2 px-3 py-2 rounded-lg shrink-0 whitespace-nowrap text-sm font-medium transition-all ${\n                  activeFilters.length > 0\n                    ? \"bg-blue-600 text-white\"\n                    : \"bg-white border border-slate-200 text-slate-700 hover:border-slate-300\"\n                }`}\n                onClick={() => showFiltersDropdown ? setShowFiltersDropdown(false) : openFiltersDropdown()}\n              >\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\" />\n                </svg>\n                <span className=\"hidden sm:inline\">Filters</span>\n                {activeFilters.length > 0 && (\n                  <span className={`text-xs px-1.5 py-0.5 rounded-full ${\n                    activeFilters.length > 0 ? \"bg-white/20 text-white\" : \"bg-slate-100 text-slate-600\"\n                  }`}>{activeFilters.length}</span>\n                )}\n              </button>\n\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              {/* DESKTOP: Fixed Popover via Portal (lg: and up) */}\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              {showFiltersDropdown && (\n                <Portal>\n                  <div className=\"hidden lg:block fixed inset-0 z-[9998]\">\n                    {/* Backdrop */}\n                    <div\n                      className=\"fixed inset-0\"\n                      onClick={() => setShowFiltersDropdown(false)}\n                    />\n\n                    {/* Desktop Filter Panel - Fixed position, viewport-clamped */}\n                    <div\n                      className=\"fixed w-[360px] max-h-[70vh] bg-white rounded-xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden\"\n                      style={{ top: filterPopoverPos.top, right: filterPopoverPos.right }}\n                    >\n                      {/* Sticky Header */}\n                      <div className=\"flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-white shrink-0\">\n                        <h3 className=\"font-semibold text-slate-900\">Filters</h3>\n                        <button\n                          onClick={() => setShowFiltersDropdown(false)}\n                          className=\"p-1 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors\"\n                        >\n                          <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                          </svg>\n                        </button>\n                      </div>\n\n                      {/* Scrollable Content */}\n                      <div className=\"flex-1 overflow-y-auto p-4 space-y-5\">\n                        {/* Prep Tasks Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Prep Tasks</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"awaiting_pdi\", label: \"Awaiting PDI\" },\n                              { key: \"awaiting_valet\", label: \"Awaiting Valet\" },\n                              { key: \"awaiting_photos\", label: \"Awaiting Photos\" },\n                              { key: \"awaiting_mot\", label: \"Awaiting MOT\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* Issues Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Issues</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"needs_paint\", label: \"Needs Paint\" },\n                              { key: \"needs_mechanical\", label: \"Needs Mechanical\" },\n                              { key: \"needs_electrical\", label: \"Needs Electrical\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* Location Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Location</h5>\n                          <div className=\"space-y-1.5\">\n                            {(() => {\n                              const isActive = activeFilters.includes(\"offsite\");\n                              const count = getFilterCount(\"offsite\");\n                              return (\n                                <button\n                                  onClick={() => toggleFilter(\"offsite\")}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>Offsite Only</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })()}\n                          </div>\n                        </div>\n\n                        {/* Vehicle Type Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Vehicle Type</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"type_stock\", label: \"Stock Vehicles\" },\n                              { key: \"type_courtesy\", label: \"Courtesy Vehicles\" },\n                              { key: \"type_fleet\", label: \"Fleet Vehicles\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* Sale Type Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Sale Type</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"trade_only\", label: \"Trade Only\" },\n                              { key: \"retail_only\", label: \"Retail Only\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* MOT Status Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">MOT Status</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"mot_expired\", label: \"MOT Expired\" },\n                              { key: \"mot_due_soon\", label: \"MOT Due Soon\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Sticky Footer */}\n                      <div className=\"border-t border-slate-200 p-3 bg-white flex gap-2 shrink-0\">\n                        <button\n                          onClick={() => setActiveFilters([])}\n                          className=\"flex-1 px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors\"\n                        >\n                          Clear\n                        </button>\n                        <button\n                          onClick={() => setShowFiltersDropdown(false)}\n                          className=\"flex-1 bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-800 transition-colors\"\n                        >\n                          Apply\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                </Portal>\n              )}\n\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              {/* MOBILE/TABLET: Bottom Sheet (< lg screens) */}\n              {/* Uses its own internal Portal for correct positioning */}\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              <BottomSheet\n                    isOpen={showFiltersDropdown}\n                    onClose={() => setShowFiltersDropdown(false)}\n                    hideAbove=\"lg\"\n                    title=\"Filters\"\n                    footer={\n                      <div className=\"flex gap-3\">\n                        <button\n                          onClick={() => setActiveFilters([])}\n                          className=\"flex-1 px-4 py-3 text-base font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors\"\n                        >\n                          Clear\n                        </button>\n                        <button\n                          onClick={() => setShowFiltersDropdown(false)}\n                          className=\"flex-1 bg-slate-900 text-white py-3 rounded-xl text-base font-bold hover:bg-slate-800 transition-colors\"\n                        >\n                          Apply {activeFilters.length > 0 && `(${activeFilters.length})`}\n                        </button>\n                      </div>\n                    }\n                  >\n                    {/* Prep Tasks */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3\">Prep Tasks</h5>\n                    {[\n                      { key: \"awaiting_pdi\", label: \"Awaiting PDI\" },\n                      { key: \"awaiting_valet\", label: \"Awaiting Valet\" },\n                      { key: \"awaiting_photos\", label: \"Awaiting Photos\" },\n                      { key: \"awaiting_mot\", label: \"Awaiting MOT\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* Issues */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Issues</h5>\n                    {[\n                      { key: \"needs_paint\", label: \"Needs Paint\" },\n                      { key: \"needs_mechanical\", label: \"Needs Mechanical\" },\n                      { key: \"needs_electrical\", label: \"Needs Electrical\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* Location */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Location</h5>\n                    {(() => {\n                      const isActive = activeFilters.includes(\"offsite\");\n                      const count = getFilterCount(\"offsite\");\n                      return (\n                        <button\n                          onClick={() => toggleFilter(\"offsite\")}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>Offsite Only</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })()}\n\n                    {/* Vehicle Type */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Vehicle Type</h5>\n                    {[\n                      { key: \"type_stock\", label: \"Stock Vehicles\" },\n                      { key: \"type_courtesy\", label: \"Courtesy Vehicles\" },\n                      { key: \"type_fleet\", label: \"Fleet Vehicles\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* Sale Type */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Sale Type</h5>\n                    {[\n                      { key: \"trade_only\", label: \"Trade Only\" },\n                      { key: \"retail_only\", label: \"Retail Only\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* MOT Status */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">MOT Status</h5>\n                    {[\n                      { key: \"mot_expired\", label: \"MOT Expired\" },\n                      { key: \"mot_due_soon\", label: \"MOT Due Soon\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n                  </BottomSheet>\n            </div>\n          </div>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex justify-center py-20\">\n          <span className=\"loading loading-spinner loading-lg\"></span>\n        </div>\n      ) : (\n        <>\n          {/* Mobile Column Tabs - Dropdown for clearer UX */}\n          <div className=\"md:hidden mb-4\">\n            <MobileStageSelector\n              stages={COLUMNS.map((col) => ({\n                value: col.key,\n                label: col.label,\n                count: getVehiclesByStatus(col.key).length,\n              }))}\n              activeStage={mobileActiveColumn}\n              onStageChange={setMobileActiveColumn}\n            />\n          </div>\n\n          {/* Mobile Single Column View */}\n          <div className=\"md:hidden\">\n            {COLUMNS.filter(col => col.key === mobileActiveColumn).map((col) => {\n              const columnVehicles = getVehiclesByStatus(col.key);\n\n              // Issue category styling with icons (mobile)\n              const issueCategoryStyles = {\n                Mechanical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                  </svg>\n                )},\n                Cosmetic: { bg: \"bg-teal-50\", text: \"text-teal-700\", border: \"border-teal-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01\" />\n                  </svg>\n                )},\n                Electrical: { bg: \"bg-yellow-50\", text: \"text-yellow-800\", border: \"border-yellow-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\n                  </svg>\n                )},\n                Other: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                  </svg>\n                )},\n              };\n\n              return (\n                <div key={col.key} className=\"space-y-3\">\n                  {columnVehicles.map((vehicle) => {\n                    const tasks = vehicle.tasks || [];\n                    const completedTasks = tasks.filter(t => t.status === \"done\").length;\n                    const motStatus = getMOTStatus(vehicle.motExpiryDate);\n                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);\n                    const duration = getVehicleDuration(vehicle);\n\n                    return (\n                      <div\n                        key={vehicle.id}\n                        className=\"bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100/50 overflow-hidden active:scale-[0.98]\"\n                        onClick={() => openVehicleDrawer(vehicle)}\n                      >\n                        <div className=\"p-4\">\n                          {/* Title with Registration Badge */}\n                          <div className=\"flex justify-between items-start mb-2\">\n                            <div className=\"flex-1\">\n                              <div className=\"flex items-center gap-2 flex-wrap mb-1\">\n                                <p className=\"font-bold text-slate-900 text-base\">\n                                  {vehicle.year || \"\"} {vehicle.make} {vehicle.model}\n                                </p>\n                                <span className=\"font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md\">\n                                  {vehicle.regCurrent}\n                                </span>\n                              </div>\n                            </div>\n                            {/* Duration badge - Sold or In Stock */}\n                            <span className={`inline-flex items-center gap-1 text-xs ${\n                              duration.isSold ? \"text-emerald-600\" : duration.days > 30 ? \"text-red-500\" : \"text-slate-400\"\n                            }`}>\n                              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                              {duration.label}\n                            </span>\n                          </div>\n\n                          {/* Tags - Modern Pill Style */}\n                          <div className=\"flex gap-1.5 flex-wrap mb-3\">\n                            {vehicle.locationId && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-[#0066CC]/10 text-[#0066CC] border border-[#0066CC]/20\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                </svg>\n                                {vehicle.locationId.name || \"Offsite\"}\n                              </span>\n                            )}\n                            {vehicle.saleType === \"TRADE\" && (\n                              <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase\">\n                                Trade\n                              </span>\n                            )}\n                            {vehicle.type === \"COURTESY\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-cyan-600 text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                Courtesy\n                              </span>\n                            )}\n                            {vehicle.type === \"FLEET_OTHER\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-[#0066CC] text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                                </svg>\n                                Fleet\n                              </span>\n                            )}\n                            {motStatus?.type === \"expired\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"due_soon\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"valid\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"unknown\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-slate-100 text-slate-500 border border-slate-200\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT ?\n                              </span>\n                            )}\n                            {/* Issue Pills with Icons */}\n                            {Object.entries(issueCounts).map(([category, count]) => {\n                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;\n                              return (\n                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>\n                                  {style.icon}\n                                  {count} {category}\n                                </span>\n                              );\n                            })}\n                            {/* Custom Labels */}\n                            {vehicle.labels?.map((label) => (\n                              <span\n                                key={label.id}\n                                className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border\"\n                                style={{\n                                  backgroundColor: `${label.colour}10`,\n                                  color: label.colour,\n                                  borderColor: `${label.colour}30`,\n                                }}\n                              >\n                                <span className=\"w-1.5 h-1.5 rounded-full\" style={{ backgroundColor: label.colour }}></span>\n                                {label.name}\n                              </span>\n                            ))}\n                          </div>\n\n                          {/* Slick Progress Bar */}\n                          {tasks.length > 0 && (\n                            <div>\n                              <span className=\"text-xs text-slate-400 mb-1 block\">\n                                {completedTasks}/{tasks.length} tasks\n                              </span>\n                              <div className=\"w-full bg-slate-100 rounded-full h-2\">\n                                <div\n                                  className=\"h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400\"\n                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}\n                                ></div>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                  {columnVehicles.length === 0 && (\n                    <div className=\"text-center py-12 text-slate-400\">\n                      <p className=\"text-sm\">No vehicles in {col.label}</p>\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Mobile Floating Action Button */}\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"md:hidden fixed fab-safe right-4 z-40 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all active:scale-95\"\n          >\n            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n            </svg>\n          </button>\n\n          {/* Desktop Multi-Column View */}\n          <div className=\"hidden md:flex gap-4 overflow-x-auto pb-6\">\n            {COLUMNS.map((col) => {\n              const columnVehicles = getVehiclesByStatus(col.key);\n              return (\n                <div\n                  key={col.key}\n                  data-column-key={col.key}\n                  className={`flex-shrink-0 w-64 bg-gradient-to-b ${col.gradient} to-transparent rounded-2xl p-3 min-h-[400px]`}\n                  onDragOver={handleDragOver}\n                onDrop={(e) => handleDrop(e, col.key)}\n              >\n                {/* Integrated Header */}\n                <div className=\"flex items-center justify-between mb-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <h3 className=\"font-semibold text-slate-700 text-sm\">\n                      {col.label}\n                    </h3>\n                    <span className=\"bg-slate-900/10 text-slate-700 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center\">\n                      {columnVehicles.length}\n                    </span>\n                  </div>\n                  <div className=\"dropdown dropdown-end\">\n                    <label tabIndex={0} className=\"btn btn-ghost btn-xs gap-1 bg-white/30 backdrop-blur-sm hover:bg-white/50 rounded-full\">\n                      <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12\" />\n                      </svg>\n                      <span className=\"text-xs\">\n                        {columnSortOptions[col.key] === \"newest_first\" ? \"Newest\" :\n                         columnSortOptions[col.key] === \"alphabetical\" ? \"A-Z\" : \"Oldest\"}\n                      </span>\n                    </label>\n                    <ul tabIndex={0} className=\"dropdown-content z-30 menu p-2 shadow-lg bg-white rounded-xl w-44 mt-2\">\n                      <li>\n                        <button\n                          className={`rounded-lg ${columnSortOptions[col.key] === \"oldest_first\" || !columnSortOptions[col.key] ? \"active bg-slate-100\" : \"\"}`}\n                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"oldest_first\" }))}\n                        >\n                          Oldest First\n                        </button>\n                      </li>\n                      <li>\n                        <button\n                          className={`rounded-lg ${columnSortOptions[col.key] === \"newest_first\" ? \"active bg-slate-100\" : \"\"}`}\n                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"newest_first\" }))}\n                        >\n                          Newest First\n                        </button>\n                      </li>\n                      <li>\n                        <button\n                          className={`rounded-lg ${columnSortOptions[col.key] === \"alphabetical\" ? \"active bg-slate-100\" : \"\"}`}\n                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"alphabetical\" }))}\n                        >\n                          Alphabetical (Make/Model)\n                        </button>\n                      </li>\n                    </ul>\n                  </div>\n                </div>\n\n                {/* Cards Container */}\n                <div className=\"space-y-3\">\n                  {columnVehicles.map((vehicle) => {\n                    const tasks = vehicle.tasks || [];\n                    const completedTasks = tasks.filter(t => t.status === \"done\").length;\n                    const motStatus = getMOTStatus(vehicle.motExpiryDate);\n                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);\n                    const duration = getVehicleDuration(vehicle);\n\n                    // Issue category styling with icons\n                    const issueCategoryStyles = {\n                      Mechanical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                        </svg>\n                      )},\n                      Cosmetic: { bg: \"bg-teal-50\", text: \"text-teal-700\", border: \"border-teal-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01\" />\n                        </svg>\n                      )},\n                      Electrical: { bg: \"bg-yellow-50\", text: \"text-yellow-800\", border: \"border-yellow-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\n                        </svg>\n                      )},\n                      Other: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                        </svg>\n                      )},\n                    };\n\n                    return (\n                      <div\n                        key={vehicle.id}\n                        draggable\n                        onDragStart={(e) => handleDragStart(e, vehicle)}\n                        onDrag={handleDrag}\n                        onDragEnd={handleDragEnd}\n                        className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all cursor-grab active:cursor-grabbing border border-slate-100/50 overflow-hidden ${draggedCard?.id === vehicle.id ? \"opacity-40 scale-95\" : \"\"}`}\n                        onClick={() => openVehicleDrawer(vehicle)}\n                      >\n                        <div className=\"p-3\">\n                          {/* Title with Registration Badge */}\n                          <div className=\"flex justify-between items-start mb-2\">\n                            <div className=\"flex-1 min-w-0\">\n                              <div className=\"flex items-center gap-2 flex-wrap\">\n                                <p className=\"font-bold text-slate-900 text-sm leading-tight\">\n                                  {vehicle.year || \"\"} {vehicle.make} {vehicle.model}\n                                </p>\n                                <span className=\"font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md\">\n                                  {vehicle.regCurrent}\n                                </span>\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Tags - Modern Pill Style */}\n                          <div className=\"flex gap-1.5 flex-wrap mb-2\">\n                            {/* Trade badge */}\n                            {vehicle.saleType === \"TRADE\" && (\n                              <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase\">\n                                Trade\n                              </span>\n                            )}\n                            {/* Courtesy/Fleet badges */}\n                            {vehicle.type === \"COURTESY\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-cyan-600 text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                Courtesy\n                              </span>\n                            )}\n                            {vehicle.type === \"FLEET_OTHER\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-[#0066CC] text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                                </svg>\n                                Fleet\n                              </span>\n                            )}\n                            {motStatus?.type === \"expired\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"due_soon\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"valid\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"unknown\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-slate-100 text-slate-500 border border-slate-200\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT ?\n                              </span>\n                            )}\n                            {/* Issue Pills with Icons */}\n                            {Object.entries(issueCounts).map(([category, count]) => {\n                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;\n                              return (\n                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>\n                                  {style.icon}\n                                  {count} {category}\n                                </span>\n                              );\n                            })}\n                            {vehicle.locationId && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-[#0066CC]/10 text-[#0066CC] border border-[#0066CC]/20\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                </svg>\n                                {vehicle.locationId.name}\n                              </span>\n                            )}\n                            {/* Custom Labels */}\n                            {vehicle.labels?.map((label) => (\n                              <span\n                                key={label.id}\n                                className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border\"\n                                style={{\n                                  backgroundColor: `${label.colour}10`,\n                                  color: label.colour,\n                                  borderColor: `${label.colour}30`,\n                                }}\n                              >\n                                <span className=\"w-1.5 h-1.5 rounded-full\" style={{ backgroundColor: label.colour }}></span>\n                                {label.name}\n                              </span>\n                            ))}\n                          </div>\n\n                          {/* Slick Progress Bar */}\n                          {tasks.length > 0 && (\n                            <div className=\"mb-2\">\n                              <span className=\"text-xs text-slate-400 mb-1 block\">\n                                {completedTasks}/{tasks.length} tasks\n                              </span>\n                              <div className=\"w-full bg-slate-100 rounded-full h-2\">\n                                <div\n                                  className=\"h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400\"\n                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}\n                                ></div>\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Footer - Duration (Sold or In Stock) */}\n                          <div className=\"pt-2 border-t border-slate-100 flex items-center justify-between\">\n                            <span className={`inline-flex items-center gap-1 text-[10px] font-medium ${\n                              duration.isSold ? \"text-emerald-600\" : duration.days > 30 ? \"text-red-500\" : \"text-slate-400\"\n                            }`}>\n                              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                              {duration.label}\n                            </span>\n                            {!duration.isSold && duration.days > 30 && (\n                              <span className=\"inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-500 border border-red-100\">\n                                Aging\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n\n                  {/* Empty State */}\n                  {columnVehicles.length === 0 && (\n                    <div className=\"text-center py-8 px-4\">\n                      <div className=\"w-12 h-12 mx-auto mb-3 rounded-full bg-white/50 flex items-center justify-center\">\n                        <svg className=\"w-6 h-6 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                        </svg>\n                      </div>\n                      <p className=\"text-sm text-slate-500 font-medium\">No vehicles</p>\n                      <p className=\"text-xs text-slate-400 mt-1\">Drag cards here to move</p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            );\n          })}\n          </div>\n        </>\n      )}\n\n      {/* Vehicle Detail Drawer - Full Screen on Mobile */}\n      {selectedVehicle && (\n        <div className=\"fixed inset-0 z-50 flex justify-end\">\n          <div className=\"bg-black/50 absolute inset-0 hidden md:block\" onClick={() => setSelectedVehicle(null)}></div>\n          <div className=\"relative bg-white w-full md:max-w-3xl h-full overflow-y-auto flex flex-col\">\n            {/* Sticky Header */}\n            <div className=\"sticky top-0 bg-white border-b border-slate-200 px-4 md:px-6 py-3 md:py-4 flex justify-between items-center z-10\">\n              <div className=\"flex items-center gap-3\">\n                {/* Back button on mobile */}\n                <button className=\"md:hidden btn btn-ghost btn-sm btn-circle\" onClick={() => setSelectedVehicle(null)}>\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <div>\n                  <h2 className=\"text-lg md:text-xl font-bold text-slate-900\">\n                    {selectedVehicle.year || \"\"} {selectedVehicle.make} {selectedVehicle.model}\n                  </h2>\n                  <p className=\"text-xs md:text-sm text-slate-500 font-mono mt-0.5\">{selectedVehicle.regCurrent}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-1 md:gap-2\">\n                <button\n                  className=\"hidden md:flex btn btn-outline btn-sm\"\n                  onClick={handleGenerateJobSheet}\n                  disabled={isGeneratingJobSheet}\n                  title=\"Share job sheet with mechanic\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z\" />\n                  </svg>\n                  {isGeneratingJobSheet ? \"...\" : \"Share\"}\n                </button>\n                <button\n                  className=\"hidden md:flex btn btn-outline btn-sm\"\n                  onClick={handleGeneratePrepSummary}\n                  disabled={isGeneratingPrepSummary}\n                  title=\"Export prep summary PDF\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                  </svg>\n                  {isGeneratingPrepSummary ? \"...\" : \"Prep PDF\"}\n                </button>\n                <button className=\"hidden md:flex btn btn-outline btn-sm\" onClick={handlePrintVehicle} title=\"Print vehicle details\">\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                  </svg>\n                  Print\n                </button>\n                <button\n                  className=\"btn btn-ghost btn-sm text-error\"\n                  onClick={async () => {\n                    if (confirm(\"Delete this vehicle?\")) {\n                      await fetch(`/api/vehicles/${selectedVehicle.id}`, { method: \"DELETE\" });\n                      setSelectedVehicle(null);\n                      fetchVehicles();\n                      toast.success(\"Vehicle deleted\");\n                    }\n                  }}\n                  title=\"Delete vehicle\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                  </svg>\n                </button>\n                <button className=\"hidden md:flex btn btn-ghost btn-sm\" onClick={() => setSelectedVehicle(null)}>\n                  ✕\n                </button>\n              </div>\n            </div>\n\n            {/* Tabs - Using DaisyUI tabs */}\n            <div className=\"bg-base-100 border-b border-base-300 px-4\">\n              <div className=\"tabs tabs-bordered\">\n                <button\n                  className={`tab ${activeTab === \"overview\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"overview\")}\n                >\n                  Overview\n                </button>\n                <button\n                  className={`tab ${activeTab === \"checklist\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"checklist\")}\n                >\n                  Checklist {selectedVehicle.tasks?.length > 0 && `(${selectedVehicle.tasks.length})`}\n                </button>\n                <button\n                  className={`tab ${activeTab === \"issues\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"issues\")}\n                >\n                  Issues {selectedVehicle.issues?.length > 0 && `(${selectedVehicle.issues.length})`}\n                </button>\n                <button\n                  className={`tab ${activeTab === \"documents\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"documents\")}\n                >\n                  Documents {selectedVehicle.documents?.length > 0 && `(${selectedVehicle.documents.length})`}\n                </button>\n                <button\n                  className={`tab ${activeTab === \"activity\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => {\n                    setActiveTab(\"activity\");\n                    if (selectedVehicle?.id) {\n                      fetchActivity(selectedVehicle.id);\n                    }\n                  }}\n                >\n                  Activity\n                </button>\n              </div>\n            </div>\n\n            <div className=\"p-6 space-y-6\">\n              {/* Overview Tab */}\n              {activeTab === \"overview\" && (\n                <div className=\"space-y-6\">\n                  {/* Identity Section */}\n                  <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                    <h3 className=\"text-sm font-semibold text-slate-900 mb-4\">Identity</h3>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Registration</label>\n                        <div className=\"flex gap-2\">\n                          <input\n                            type=\"text\"\n                            className=\"input input-sm bg-slate-50 border-slate-200 text-slate-900 flex-1 font-mono uppercase\"\n                            value={selectedVehicle.regCurrent || \"\"}\n                            onChange={(e) => setSelectedVehicle({ ...selectedVehicle, regCurrent: e.target.value.toUpperCase() })}\n                            onBlur={async () => {\n                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                method: \"PUT\",\n                                headers: { \"Content-Type\": \"application/json\" },\n                                body: JSON.stringify({ regCurrent: selectedVehicle.regCurrent }),\n                              });\n                              fetchVehicles();\n                            }}\n                          />\n                          <button\n                            type=\"button\"\n                            className=\"btn btn-sm btn-primary\"\n                            onClick={lookupVehicleDVLA}\n                            disabled={isLookingUpDrawer}\n                            title=\"Lookup DVLA data for this registration\"\n                          >\n                            {isLookingUpDrawer ? (\n                              <span className=\"loading loading-spinner loading-xs\"></span>\n                            ) : (\n                              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n                              </svg>\n                            )}\n                          </button>\n                        </div>\n                        <p className=\"text-xs text-slate-400 mt-1\">Click lookup to refresh DVLA data</p>\n                      </div>\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">VIN</label>\n                        <input\n                          type=\"text\"\n                          className=\"input input-sm bg-slate-50 border-slate-200 text-slate-900\"\n                          value={selectedVehicle.vin || \"\"}\n                          onChange={(e) => setSelectedVehicle({ ...selectedVehicle, vin: e.target.value })}\n                          onBlur={async () => {\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify({ vin: selectedVehicle.vin }),\n                            });\n                            fetchVehicles();\n                          }}\n                        />\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Custom Labels Section */}\n                  <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                    <h3 className=\"text-sm font-semibold text-slate-900 mb-3\">Custom Labels</h3>\n\n                    {/* Applied Labels Display */}\n                    {selectedVehicle.labels?.length > 0 && (\n                      <div className=\"flex flex-wrap gap-2 mb-3\">\n                        {selectedVehicle.labels.map((label) => (\n                          <span\n                            key={label.id}\n                            className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold\"\n                            style={{\n                              backgroundColor: `${label.colour}20`,\n                              color: label.colour,\n                            }}\n                          >\n                            <span className=\"w-2 h-2 rounded-full\" style={{ backgroundColor: label.colour }}></span>\n                            {label.name}\n                            <button\n                              type=\"button\"\n                              onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}\n                              className=\"ml-0.5 hover:opacity-70\"\n                            >\n                              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                              </svg>\n                            </button>\n                          </span>\n                        ))}\n                      </div>\n                    )}\n\n                    {/* Labels Dropdown */}\n                    <div className=\"relative\">\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowLabelsDropdown(!showLabelsDropdown)}\n                        className=\"w-full flex items-center justify-between px-3 py-2 border border-slate-300 rounded-lg bg-white text-sm hover:border-slate-400 transition-colors\"\n                      >\n                        <span className=\"text-slate-600\">\n                          {selectedVehicle.labels?.length > 0\n                            ? `${selectedVehicle.labels.length} label${selectedVehicle.labels.length > 1 ? 's' : ''} selected`\n                            : \"Select labels...\"\n                          }\n                        </span>\n                        <svg className={`w-4 h-4 text-slate-400 transition-transform ${showLabelsDropdown ? 'rotate-180' : ''}`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                        </svg>\n                      </button>\n\n                      {showLabelsDropdown && (\n                        <div className=\"absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-auto\">\n                          {availableLabels.map((label) => {\n                            const isApplied = selectedVehicle.labels?.some(l => l.id === label.id);\n                            return (\n                              <button\n                                key={label.id}\n                                type=\"button\"\n                                onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}\n                                className=\"w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left\"\n                              >\n                                <span\n                                  className=\"w-3 h-3 rounded-full flex-shrink-0\"\n                                  style={{ backgroundColor: label.colour }}\n                                ></span>\n                                <span className=\"flex-1 text-sm text-slate-700\">{label.name}</span>\n                                {isApplied && (\n                                  <svg className=\"w-4 h-4 text-green-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                                    <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                                  </svg>\n                                )}\n                              </button>\n                            );\n                          })}\n\n                          {/* Add New Label Option */}\n                          <div className=\"border-t border-slate-100\">\n                            <button\n                              type=\"button\"\n                              onClick={() => {\n                                setShowLabelsDropdown(false);\n                                setShowAddLabelModal(true);\n                              }}\n                              className=\"w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left text-[#0066CC]\"\n                            >\n                              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                              </svg>\n                              <span className=\"text-sm font-medium\">Add new label</span>\n                            </button>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n\n                    {availableLabels.length === 0 && (\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowAddLabelModal(true)}\n                        className=\"w-full flex items-center justify-center gap-2 px-3 py-2 border border-dashed border-slate-300 rounded-lg text-sm text-slate-500 hover:border-slate-400 hover:text-slate-600 transition-colors\"\n                      >\n                        <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                        </svg>\n                        Create your first label\n                      </button>\n                    )}\n                  </div>\n\n                  {/* Status & Location Section - Now below Identity */}\n                  <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                    <h3 className=\"text-sm font-semibold text-slate-900 mb-4\">Status & Location</h3>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Vehicle Type</label>\n                        <select\n                          className=\"select select-sm select-bordered w-full\"\n                          value={selectedVehicle.type || \"STOCK\"}\n                          onChange={async (e) => {\n                            const newType = e.target.value;\n                            const updates = { type: newType };\n                            // Clear saleType if not Stock\n                            if (newType !== \"STOCK\") {\n                              updates.saleType = null;\n                            }\n                            setSelectedVehicle({ ...selectedVehicle, ...updates });\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify(updates),\n                            });\n                            fetchVehicles();\n                            toast.success(\"Vehicle type updated\");\n                          }}\n                        >\n                          <option value=\"STOCK\">Stock</option>\n                          <option value=\"COURTESY\">Courtesy</option>\n                          <option value=\"FLEET_OTHER\">Fleet</option>\n                        </select>\n                      </div>\n                      {/* Sale Type - Only show for Stock vehicles */}\n                      {(selectedVehicle.type === \"STOCK\" || !selectedVehicle.type) && (\n                        <div className=\"form-control\">\n                          <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Sale Type</label>\n                          <select\n                            className=\"select select-sm select-bordered w-full\"\n                            value={selectedVehicle.saleType || \"RETAIL\"}\n                            onChange={async (e) => {\n                              const newSaleType = e.target.value;\n                              setSelectedVehicle({ ...selectedVehicle, saleType: newSaleType });\n                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                method: \"PUT\",\n                                headers: { \"Content-Type\": \"application/json\" },\n                                body: JSON.stringify({ saleType: newSaleType }),\n                              });\n                              fetchVehicles();\n                              toast.success(\"Sale type updated\");\n                            }}\n                          >\n                            <option value=\"RETAIL\">Retail</option>\n                            <option value=\"TRADE\">Trade</option>\n                          </select>\n                        </div>\n                      )}\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Status</label>\n                        <select\n                          className=\"select select-sm select-bordered w-full\"\n                          value={selectedVehicle.status || \"in_stock\"}\n                          onChange={async (e) => {\n                            const newStatus = e.target.value;\n                            setSelectedVehicle({ ...selectedVehicle, status: newStatus });\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify({ status: newStatus }),\n                            });\n                            fetchVehicles();\n                            toast.success(`Status updated to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);\n                          }}\n                        >\n                          {COLUMNS.map(col => (\n                            <option key={col.key} value={col.key}>{col.label}</option>\n                          ))}\n                        </select>\n                      </div>\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Location</label>\n                        <select\n                          className=\"select select-sm select-bordered w-full\"\n                          value={selectedVehicle.locationId?.id || selectedVehicle.locationId?._id || selectedVehicle.locationId || \"\"}\n                          onChange={async (e) => {\n                            const value = e.target.value;\n                            if (value === \"__add_new__\") {\n                              setShowAddLocationModal(true);\n                              return;\n                            }\n                            const locationId = value || null;\n                            setSelectedVehicle({ ...selectedVehicle, locationId: locationId });\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify({ locationId }),\n                            });\n                            const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n                            setSelectedVehicle(updated);\n                            fetchVehicles();\n                            toast.success(\"Location updated\");\n                          }}\n                        >\n                          <option value=\"\">On Site</option>\n                          {locations.map(loc => (\n                            <option key={loc.id || loc._id} value={loc.id || loc._id}>{loc.name}</option>\n                          ))}\n                          <option value=\"__add_new__\">+ Add Location</option>\n                        </select>\n                      </div>\n                    </div>\n                  </div>\n\n                    <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                      <h3 className=\"text-sm font-semibold text-slate-900 mb-4\">Specs</h3>\n                      <div className=\"space-y-3\">\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Make</label>\n                            <input\n                              type=\"text\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.make || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, make: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ make: selectedVehicle.make }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Model</label>\n                            <input\n                              type=\"text\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.model || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, model: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ model: selectedVehicle.model }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Year</label>\n                            <input\n                              type=\"number\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.year || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, year: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ year: selectedVehicle.year }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Mileage</label>\n                            <input\n                              type=\"number\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.mileageCurrent || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, mileageCurrent: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ mileageCurrent: selectedVehicle.mileageCurrent }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Colour</label>\n                            <input\n                              type=\"text\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.colour || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, colour: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ colour: selectedVehicle.colour }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Fuel Type</label>\n                            <select\n                              className=\"select select-sm select-bordered\"\n                              value={selectedVehicle.fuelType || \"\"}\n                              onChange={async (e) => {\n                                const newValue = e.target.value;\n                                setSelectedVehicle({ ...selectedVehicle, fuelType: newValue });\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ fuelType: newValue }),\n                                });\n                                fetchVehicles();\n                              }}\n                            >\n                              <option value=\"\">Select...</option>\n                              <option value=\"Petrol\">Petrol</option>\n                              <option value=\"Diesel\">Diesel</option>\n                              <option value=\"Hybrid\">Hybrid</option>\n                              <option value=\"Electric\">Electric</option>\n                            </select>\n                          </div>\n                        </div>\n\n                        <div className=\"form-control\">\n                          <label className=\"label label-text text-xs\">MOT Expiry Date</label>\n                          <input\n                            type=\"date\"\n                            className=\"input input-sm input-bordered\"\n                            value={selectedVehicle.motExpiryDate ? new Date(selectedVehicle.motExpiryDate).toISOString().split('T')[0] : \"\"}\n                            onChange={async (e) => {\n                              const newValue = e.target.value;\n                              setSelectedVehicle({ ...selectedVehicle, motExpiryDate: newValue });\n                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                method: \"PUT\",\n                                headers: { \"Content-Type\": \"application/json\" },\n                                body: JSON.stringify({ motExpiryDate: newValue }),\n                              });\n                              fetchVehicles();\n                            }}\n                          />\n                        </div>\n                      </div>\n                    </div>\n\n                  <div className=\"card bg-base-200\">\n                    <div className=\"card-body p-4\">\n                      <h3 className=\"font-semibold mb-2\">V5 Document</h3>\n                      {selectedVehicle.v5Url ? (\n                        <div>\n                          <a href={selectedVehicle.v5Url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"btn btn-sm btn-outline w-full mb-2\">\n                            View V5 Document\n                          </a>\n                          <label className=\"btn btn-sm btn-ghost w-full\">\n                            Replace V5\n                            <input type=\"file\" accept=\"image/*,.pdf\" className=\"hidden\" onChange={(e) => uploadV5(e.target.files[0])} />\n                          </label>\n                        </div>\n                      ) : (\n                        <label className=\"btn btn-primary btn-sm w-full\">\n                          Upload V5\n                          <input type=\"file\" accept=\"image/*,.pdf\" className=\"hidden\" onChange={(e) => uploadV5(e.target.files[0])} />\n                        </label>\n                      )}\n                    </div>\n                  </div>\n\n                  {selectedVehicle.notes && (\n                    <div className=\"card bg-base-200\">\n                      <div className=\"card-body p-4\">\n                        <h3 className=\"font-semibold mb-2\">Notes</h3>\n                        <p className=\"text-sm whitespace-pre-wrap\">{selectedVehicle.notes}</p>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              )}\n\n\n              {/* Prep Checklist Tab */}\n              {activeTab === \"checklist\" && (\n                <div className=\"card bg-base-200\">\n                  <div className=\"card-body p-4\">\n                    <h3 className=\"font-semibold mb-3\">Prep Checklist</h3>\n                    <div className=\"space-y-2\">\n                      {selectedVehicle.tasks?.map((task) => (\n                        <div key={task.id} className=\"p-2 rounded hover:bg-base-300 group\">\n                          <div className=\"flex items-center gap-2\">\n                            <select\n                              className=\"select select-bordered select-xs\"\n                              value={task.status || \"pending\"}\n                              onChange={(e) => updateTaskStatus(task.id, e.target.value)}\n                              onClick={(e) => e.stopPropagation()}\n                            >\n                              <option value=\"pending\">Pending</option>\n                              <option value=\"in_progress\">In Progress</option>\n                              <option value=\"done\">Done</option>\n                              <option value=\"not_required\">Not Required</option>\n                            </select>\n                            {editingTaskId === task.id ? (\n                              <input\n                                type=\"text\"\n                                className=\"input input-bordered input-xs flex-1\"\n                                value={editingTaskName}\n                                onChange={(e) => setEditingTaskName(e.target.value)}\n                                onBlur={() => {\n                                  if (editingTaskName.trim() && editingTaskName !== task.name) {\n                                    updateTaskName(task.id, editingTaskName);\n                                  } else {\n                                    setEditingTaskId(null);\n                                    setEditingTaskName(\"\");\n                                  }\n                                }}\n                                onKeyPress={(e) => {\n                                  if (e.key === \"Enter\") {\n                                    if (editingTaskName.trim() && editingTaskName !== task.name) {\n                                      updateTaskName(task.id, editingTaskName);\n                                    } else {\n                                      setEditingTaskId(null);\n                                      setEditingTaskName(\"\");\n                                    }\n                                  }\n                                }}\n                                onKeyDown={(e) => {\n                                  if (e.key === \"Escape\") {\n                                    setEditingTaskId(null);\n                                    setEditingTaskName(\"\");\n                                  }\n                                }}\n                                autoFocus\n                              />\n                            ) : (\n                              <span\n                                className={`flex-1 text-sm cursor-pointer ${task.status === \"done\" ? \"line-through text-base-content/50\" : \"\"}`}\n                                onClick={() => {\n                                  setEditingTaskId(task.id);\n                                  setEditingTaskName(task.name);\n                                }}\n                                title=\"Click to edit\"\n                              >\n                                {task.name}\n                                {/* Show parts status chip next to task name */}\n                                {task.partsOrders?.length > 0 && (\n                                  <span className={`ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${\n                                    task.partsOrders.every(o => o.status === \"RECEIVED\")\n                                      ? \"bg-green-100 text-green-800 border border-green-200\"\n                                      : task.partsOrders.some(o => o.status === \"RECEIVED\")\n                                        ? \"bg-blue-100 text-blue-800 border border-blue-200\"\n                                        : \"bg-amber-100 text-amber-800 border border-amber-200\"\n                                  }`}>\n                                    {task.partsOrders.every(o => o.status === \"RECEIVED\")\n                                      ? `✓ Parts Received (${task.partsOrders.length})`\n                                      : task.partsOrders.some(o => o.status === \"RECEIVED\")\n                                        ? `Parts: ${task.partsOrders.filter(o => o.status === \"RECEIVED\").length}/${task.partsOrders.length} Received`\n                                        : `Parts Ordered (${task.partsOrders.length})`\n                                    }\n                                  </span>\n                                )}\n                              </span>\n                            )}\n                            {task.completedAt && !editingTaskId && (\n                              <span className=\"text-xs text-base-content/50\">\n                                {formatDate(task.completedAt)}\n                              </span>\n                            )}\n                            {/* Order Parts button - show for pending/in_progress tasks */}\n                            {task.status !== \"done\" && task.status !== \"not_required\" && (\n                              <button\n                                className=\"btn btn-ghost btn-xs text-amber-600 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  openPartsOrderModal(task.id);\n                                }}\n                                title=\"Order Parts\"\n                              >\n                                + Parts\n                              </button>\n                            )}\n                            <button\n                              className=\"btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity\"\n                              onClick={() => deleteTask(task.id)}\n                            >\n                              ✕\n                            </button>\n                          </div>\n                          {/* Parts orders section - show if task has parts orders */}\n                          {task.partsOrders?.length > 0 && (\n                            <div className=\"mt-2 ml-6 pl-2 border-l-2 border-amber-300 space-y-1\">\n                              {task.partsOrders.map((order) => (\n                                <div key={order._id || order.id} className=\"flex items-center gap-2 text-xs\">\n                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium ${\n                                    order.status === \"RECEIVED\"\n                                      ? \"bg-green-100 text-green-700\"\n                                      : \"bg-amber-100 text-amber-700\"\n                                  }`}>\n                                    {order.status === \"RECEIVED\" ? \"✓\" : \"⏳\"}\n                                  </span>\n                                  <span className=\"text-base-content/80\">{getSupplierDisplay(order)}</span>\n                                  {order.orderRef && (\n                                    <span className=\"text-base-content/50\">Ref: {order.orderRef}</span>\n                                  )}\n                                  {order.expectedAt && order.status !== \"RECEIVED\" && (\n                                    <span className=\"text-base-content/50\">\n                                      ETA: {formatDate(order.expectedAt)}\n                                    </span>\n                                  )}\n                                  {order.status !== \"RECEIVED\" && (\n                                    <button\n                                      className=\"btn btn-ghost btn-xs text-green-600\"\n                                      onClick={(e) => {\n                                        e.stopPropagation();\n                                        markPartsReceived(task.id, order._id || order.id);\n                                      }}\n                                      title=\"Mark as Received\"\n                                    >\n                                      ✓ Received\n                                    </button>\n                                  )}\n                                  <button\n                                    className=\"btn btn-ghost btn-xs\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      openPartsOrderModal(task.id, order);\n                                    }}\n                                    title=\"Edit\"\n                                  >\n                                    ✎\n                                  </button>\n                                  <button\n                                    className=\"btn btn-ghost btn-xs text-error\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      removePartsOrder(task.id, order._id || order.id);\n                                    }}\n                                    title=\"Remove\"\n                                  >\n                                    ✕\n                                  </button>\n                                </div>\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      ))}\n                    </div>\n                    <div className=\"flex gap-2 mt-3\">\n                      <input\n                        type=\"text\"\n                        className=\"input input-bordered input-sm flex-1\"\n                        placeholder=\"Add new task...\"\n                        value={newTaskName}\n                        onChange={(e) => setNewTaskName(e.target.value)}\n                        onKeyPress={(e) => e.key === \"Enter\" && addTask()}\n                      />\n                      <button className=\"btn btn-primary btn-sm\" onClick={addTask}>\n                        Add\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Issues Tab */}\n              {activeTab === \"issues\" && (\n                <div className=\"space-y-4\">\n                  <button\n                    className=\"flex items-center justify-center gap-2 w-full px-4 py-2.5 bg-[#0066CC] hover:bg-[#0055AA] text-white text-sm font-medium rounded-xl shadow-sm shadow-[#0066CC]/25 hover:shadow-md transition-all\"\n                    onClick={() => setShowAddIssueModal(true)}\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    Add Issue\n                  </button>\n\n                  {selectedVehicle.issues && selectedVehicle.issues.length > 0 ? (\n                    <div className=\"space-y-3\">\n                      {selectedVehicle.issues.map((issue) => (\n                        <div key={issue.id} className=\"bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden hover:shadow-md transition-shadow\">\n                          {/* Issue Header with Status Bar */}\n                          <div className={`px-4 py-3 border-b border-slate-100 ${\n                            issue.status === \"Complete\" ? \"bg-emerald-50/50\" :\n                            issue.status === \"In Progress\" ? \"bg-amber-50/50\" :\n                            issue.status === \"Ordered\" ? \"bg-blue-50/50\" :\n                            \"bg-red-50/50\"\n                          }`}>\n                            <div className=\"flex items-center justify-between gap-3\">\n                              <div className=\"flex items-center gap-2 flex-wrap min-w-0\">\n                                <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-[#0066CC]/10 text-[#0066CC]\">\n                                  {issue.category}\n                                </span>\n                                {issue.subcategory && (\n                                  <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600\">\n                                    {issue.subcategory}\n                                  </span>\n                                )}\n                              </div>\n                              <select\n                                className={`text-xs font-semibold px-2.5 py-1.5 rounded-lg border-0 cursor-pointer transition-colors ${\n                                  issue.status === \"Complete\" ? \"bg-emerald-100 text-emerald-700\" :\n                                  issue.status === \"In Progress\" ? \"bg-amber-100 text-amber-700\" :\n                                  issue.status === \"Ordered\" ? \"bg-blue-100 text-blue-700\" :\n                                  \"bg-red-100 text-red-700\"\n                                }`}\n                                value={issue.status || \"Outstanding\"}\n                                onChange={(e) => updateIssue(issue.id, { status: e.target.value })}\n                              >\n                                <option value=\"Outstanding\">Outstanding</option>\n                                <option value=\"Ordered\">Ordered</option>\n                                <option value=\"In Progress\">In Progress</option>\n                                <option value=\"Complete\">Complete</option>\n                              </select>\n                            </div>\n                          </div>\n\n                          {/* Issue Body */}\n                          <div className=\"p-4 space-y-3\">\n                            {/* Description */}\n                            <p className=\"text-sm font-medium text-slate-800\">{issue.description}</p>\n\n                            {/* Details Grid */}\n                            <div className=\"space-y-2\">\n                              {issue.actionNeeded && (\n                                <div className=\"flex items-start gap-2\">\n                                  <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pt-0.5 w-14\">Action</span>\n                                  <p className=\"text-sm text-slate-600\">{issue.actionNeeded}</p>\n                                </div>\n                              )}\n                              {issue.notes && (\n                                <div className=\"flex items-start gap-2\">\n                                  <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pt-0.5 w-14\">Notes</span>\n                                  <p className=\"text-sm text-slate-600\">{issue.notes}</p>\n                                </div>\n                              )}\n                            </div>\n\n                            {/* Parts Details */}\n                            {issue.partsRequired && (\n                              <div className=\"flex items-start gap-2 p-3 bg-[#0066CC]/5 rounded-xl border border-[#0066CC]/10\">\n                                <div className=\"w-7 h-7 rounded-lg bg-[#0066CC]/10 flex items-center justify-center shrink-0\">\n                                  <svg className=\"w-4 h-4 text-[#0066CC]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z\" />\n                                  </svg>\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <span className=\"inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-[#0066CC]/10 text-[#0066CC]\">\n                                    Parts Required\n                                  </span>\n                                  {issue.partsDetails && (\n                                    <p className=\"text-sm text-slate-600 mt-1\">{issue.partsDetails}</p>\n                                  )}\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Photos */}\n                            {issue.photos && issue.photos.length > 0 && (\n                              <div className=\"pt-2\">\n                                <p className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2\">\n                                  Photos ({issue.photos.length})\n                                </p>\n                                <div className=\"flex flex-wrap gap-2\">\n                                  {issue.photos.map((photo, idx) => (\n                                    <a key={idx} href={photo} target=\"_blank\" rel=\"noopener noreferrer\" className=\"group\">\n                                      <img\n                                        src={photo}\n                                        alt={`Issue photo ${idx + 1}`}\n                                        className=\"w-16 h-16 object-cover rounded-xl border-2 border-slate-200 group-hover:border-[#0066CC] group-hover:scale-105 transition-all\"\n                                      />\n                                    </a>\n                                  ))}\n                                </div>\n                              </div>\n                            )}\n                          </div>\n\n                          {/* Updates Accordion */}\n                          <div className=\"border-t border-slate-100\">\n                            <button\n                              className=\"w-full flex items-center justify-between px-4 py-2.5 text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors\"\n                              onClick={() => setExpandedIssues(prev => ({\n                                ...prev,\n                                [issue.id]: !prev[issue.id]\n                              }))}\n                            >\n                              <span className=\"flex items-center gap-2\">\n                                <svg className=\"w-4 h-4 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\n                                </svg>\n                                Updates {issue.updates?.length > 0 && `(${issue.updates.length})`}\n                              </span>\n                              <svg\n                                className={`w-4 h-4 text-slate-400 transition-transform duration-200 ${expandedIssues[issue.id] ? \"rotate-180\" : \"\"}`}\n                                fill=\"none\"\n                                stroke=\"currentColor\"\n                                viewBox=\"0 0 24 24\"\n                              >\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                              </svg>\n                            </button>\n\n                            {expandedIssues[issue.id] && (\n                              <div className=\"px-4 pb-4 space-y-3 bg-slate-50/50\">\n                                {/* Creation timestamp */}\n                                <div className=\"flex gap-3 text-xs\">\n                                  <div className=\"w-1 bg-slate-200 rounded-full\"></div>\n                                  <p className=\"text-slate-500\">\n                                    Created {formatDate(issue.createdAt)}\n                                  </p>\n                                </div>\n\n                                {/* Updates timeline */}\n                                {issue.updates && issue.updates.length > 0 ? (\n                                  issue.updates.map((update, idx) => (\n                                    <div key={idx} className=\"flex gap-3\">\n                                      <div className=\"w-1 bg-[#0066CC]/30 rounded-full\"></div>\n                                      <div className=\"flex-1 min-w-0\">\n                                        <div className=\"flex items-center gap-2 mb-1\">\n                                          <p className=\"text-sm font-semibold text-slate-700\">{update.userName || \"User\"}</p>\n                                          <span className=\"text-xs text-slate-400\">{formatDate(update.createdAt)}</span>\n                                        </div>\n                                        <p className=\"text-sm text-slate-600\">{update.content}</p>\n                                      </div>\n                                    </div>\n                                  ))\n                                ) : (\n                                  <p className=\"text-xs text-slate-400 text-center py-2\">No updates yet</p>\n                                )}\n\n                                {/* Add update input */}\n                                <div className=\"flex gap-2 pt-2\">\n                                  <input\n                                    type=\"text\"\n                                    className=\"flex-1 px-3 py-2 text-sm bg-white border border-slate-200 rounded-xl focus:border-[#0066CC] focus:ring-1 focus:ring-[#0066CC]/20 outline-none transition-all\"\n                                    placeholder=\"Add an update...\"\n                                    value={issueUpdateContent[issue.id] || \"\"}\n                                    onChange={(e) => setIssueUpdateContent(prev => ({\n                                      ...prev,\n                                      [issue.id]: e.target.value\n                                    }))}\n                                    onKeyPress={(e) => {\n                                      if (e.key === \"Enter\") {\n                                        addIssueUpdate(issue.id, issueUpdateContent[issue.id]);\n                                      }\n                                    }}\n                                  />\n                                  <button\n                                    className=\"px-4 py-2 bg-[#0066CC] hover:bg-[#0055AA] text-white text-sm font-medium rounded-xl transition-colors\"\n                                    onClick={() => addIssueUpdate(issue.id, issueUpdateContent[issue.id])}\n                                  >\n                                    Add\n                                  </button>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n\n                          {/* Actions Footer */}\n                          <div className=\"flex items-center justify-end gap-2 px-4 py-3 bg-slate-50/50 border-t border-slate-100\">\n                            <button\n                              className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-slate-600 hover:text-[#0066CC] hover:bg-[#0066CC]/5 rounded-lg transition-colors\"\n                              onClick={() => openEditIssue(issue)}\n                            >\n                              <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\n                              </svg>\n                              Edit\n                            </button>\n                            <button\n                              className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\n                              onClick={() => {\n                                if (confirm(\"Delete this issue?\")) deleteIssue(issue.id);\n                              }}\n                            >\n                              <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                              Delete\n                            </button>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center\">\n                      <div className=\"w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3\">\n                        <svg className=\"w-6 h-6 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                        </svg>\n                      </div>\n                      <p className=\"text-sm font-medium text-slate-600\">No issues recorded</p>\n                      <p className=\"text-xs text-slate-400 mt-1\">Add an issue to track problems with this vehicle</p>\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Documents Tab */}\n              {activeTab === \"documents\" && (\n                <div className=\"space-y-4\">\n                  <button\n                    className=\"btn btn-primary btn-sm w-full\"\n                    onClick={() => setShowAddDocumentModal(true)}\n                  >\n                    + Add Document/Image\n                  </button>\n\n                  {selectedVehicle.documents && selectedVehicle.documents.length > 0 ? (\n                    <div className=\"space-y-3\">\n                      {selectedVehicle.documents.map((doc) => (\n                        <div key={doc.id} className=\"card bg-base-200\">\n                          <div className=\"card-body p-4\">\n                            <div className=\"flex justify-between items-start\">\n                              <div className=\"flex-1\">\n                                <p className=\"text-sm font-medium\">{doc.name}</p>\n                                <span className=\"badge badge-sm mt-1\">\n                                  {doc.type === \"v5\" && \"V5\"}\n                                  {doc.type === \"service_history\" && \"Service History\"}\n                                  {doc.type === \"fault_codes\" && \"Fault Codes\"}\n                                  {doc.type === \"other\" && \"Other\"}\n                                </span>\n                              </div>\n                              <div className=\"flex gap-1\">\n                                <a\n                                  href={doc.url}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"btn btn-ghost btn-xs\"\n                                  onClick={(e) => e.stopPropagation()}\n                                >\n                                  View\n                                </a>\n                                <button\n                                  className=\"btn btn-ghost btn-xs text-error\"\n                                  onClick={() => {\n                                    if (confirm(\"Delete this document?\")) deleteDocument(doc.id);\n                                  }}\n                                >\n                                  Delete\n                                </button>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-8 text-base-content/60\">\n                      No documents uploaded\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Activity Tab */}\n              {activeTab === \"activity\" && (\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Activity Log</h3>\n\n                  {activityLoading && activityData.activities.length === 0 ? (\n                    <div className=\"flex justify-center py-8\">\n                      <div className=\"w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\n                    </div>\n                  ) : activityData.activities.length === 0 ? (\n                    <div className=\"text-center py-8 text-base-content/60\">\n                      No activity recorded yet\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {activityData.activities.map((activity) => (\n                        <div\n                          key={activity._id || activity.id}\n                          className=\"flex items-start gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100\"\n                        >\n                          <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${\n                            activity.type === \"VEHICLE_CREATED\" ? \"bg-green-100\" :\n                            activity.type === \"STATUS_CHANGED\" ? \"bg-blue-100\" :\n                            activity.type === \"TYPE_CHANGED\" ? \"bg-[#0066CC]/10\" :\n                            activity.type === \"LOCATION_CHANGED\" ? \"bg-[#0066CC]/10\" :\n                            activity.type === \"TASK_COMPLETED\" ? \"bg-emerald-100\" :\n                            activity.type === \"TASK_STATUS_UPDATED\" ? \"bg-amber-100\" :\n                            activity.type === \"TASK_PROGRESS_UPDATED\" ? \"bg-orange-100\" :\n                            activity.type === \"TASK_PARTS_STATUS_CHANGED\" || activity.type === \"TASK_PARTS_ORDER_ADDED\" ? \"bg-amber-100\" :\n                            activity.type === \"TASK_PARTS_ORDER_UPDATED\" ? \"bg-blue-100\" :\n                            activity.type === \"TASK_PARTS_ORDER_REMOVED\" ? \"bg-red-100\" :\n                            activity.type === \"TASK_ADDED\" || activity.type === \"TASK_DELETED\" ? \"bg-slate-100\" :\n                            activity.type === \"ISSUE_ADDED\" ? \"bg-red-100\" :\n                            activity.type === \"ISSUE_RESOLVED\" ? \"bg-green-100\" :\n                            activity.type === \"ISSUE_UPDATED\" || activity.type === \"ISSUE_COMMENT_ADDED\" ? \"bg-yellow-100\" :\n                            \"bg-slate-100\"\n                          }`}>\n                            {/* Vehicle lifecycle */}\n                            {activity.type === \"VEHICLE_CREATED\" && (\n                              <svg className=\"w-4 h-4 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"STATUS_CHANGED\" && (\n                              <svg className=\"w-4 h-4 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TYPE_CHANGED\" && (\n                              <svg className=\"w-4 h-4 text-[#0066CC]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                              </svg>\n                            )}\n                            {activity.type === \"LOCATION_CHANGED\" && (\n                              <svg className=\"w-4 h-4 text-[#0066CC]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"DETAILS_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-[#14B8A6]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\n                              </svg>\n                            )}\n                            {/* Task events */}\n                            {activity.type === \"TASK_COMPLETED\" && (\n                              <svg className=\"w-4 h-4 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_STATUS_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_PROGRESS_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-orange-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                              </svg>\n                            )}\n                            {(activity.type === \"TASK_ADDED\" || activity.type === \"TASK_UPDATED\") && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_DELETED\" && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                            )}\n                            {/* Parts ordering events */}\n                            {(activity.type === \"TASK_PARTS_STATUS_CHANGED\" || activity.type === \"TASK_PARTS_ORDER_ADDED\") && (\n                              <svg className=\"w-4 h-4 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_PARTS_ORDER_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_PARTS_ORDER_REMOVED\" && (\n                              <svg className=\"w-4 h-4 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                            )}\n                            {/* Issue events */}\n                            {activity.type === \"ISSUE_ADDED\" && (\n                              <svg className=\"w-4 h-4 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"ISSUE_RESOLVED\" && (\n                              <svg className=\"w-4 h-4 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                              </svg>\n                            )}\n                            {(activity.type === \"ISSUE_UPDATED\" || activity.type === \"ISSUE_COMMENT_ADDED\") && (\n                              <svg className=\"w-4 h-4 text-yellow-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"ISSUE_DELETED\" && (\n                              <svg className=\"w-4 h-4 text-red-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                            )}\n                            {/* Document events */}\n                            {(activity.type === \"DOC_UPLOADED\" || activity.type === \"DOC_DELETED\") && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                              </svg>\n                            )}\n                            {/* Fallback for any unhandled types */}\n                            {![\"VEHICLE_CREATED\", \"STATUS_CHANGED\", \"TYPE_CHANGED\", \"LOCATION_CHANGED\", \"DETAILS_UPDATED\",\n                               \"TASK_COMPLETED\", \"TASK_STATUS_UPDATED\", \"TASK_PROGRESS_UPDATED\", \"TASK_ADDED\", \"TASK_UPDATED\", \"TASK_DELETED\",\n                               \"TASK_PARTS_STATUS_CHANGED\", \"TASK_PARTS_ORDER_ADDED\", \"TASK_PARTS_ORDER_UPDATED\", \"TASK_PARTS_ORDER_REMOVED\",\n                               \"ISSUE_ADDED\", \"ISSUE_RESOLVED\", \"ISSUE_UPDATED\", \"ISSUE_COMMENT_ADDED\", \"ISSUE_DELETED\",\n                               \"DOC_UPLOADED\", \"DOC_DELETED\"].includes(activity.type) && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            )}\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm text-slate-900\">{activity.message}</p>\n                            <p className=\"text-xs text-slate-500 mt-0.5\">\n                              by {activity.actorName || \"Unknown\"} &middot; {formatRelativeTime(activity.createdAt)}\n                            </p>\n                          </div>\n                        </div>\n                      ))}\n\n                      {activityData.hasMore && (\n                        <button\n                          onClick={() => fetchActivity(selectedVehicle.id, true)}\n                          disabled={activityLoading}\n                          className=\"w-full btn btn-ghost btn-sm text-slate-600\"\n                        >\n                          {activityLoading ? (\n                            <span className=\"flex items-center gap-2\">\n                              <div className=\"w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin\"></div>\n                              Loading...\n                            </span>\n                          ) : (\n                            \"Load more\"\n                          )}\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Drag Preview - floating card that follows cursor */}\n      {draggedCard && (\n        <div\n          className=\"fixed pointer-events-none z-50\"\n          style={{\n            left: dragPosition.x - 120,\n            top: dragPosition.y - 30,\n            transform: \"rotate(3deg)\",\n          }}\n        >\n          <div className=\"bg-white rounded-xl shadow-2xl border-2 border-blue-400 w-60 p-3 opacity-90\">\n            <div className=\"flex items-center gap-2\">\n              <p className=\"font-bold text-slate-900 text-sm truncate\">\n                {draggedCard.year} {draggedCard.make} {draggedCard.model}\n              </p>\n            </div>\n            <span className=\"font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md inline-block mt-1\">\n              {draggedCard.regCurrent}\n            </span>\n          </div>\n        </div>\n      )}\n\n      {showAddModal && (\n        <AddVehicleModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchVehicles(); }} />\n      )}\n\n      {showAddIssueModal && (\n        <AddIssueModal\n          issueForm={issueForm}\n          setIssueForm={setIssueForm}\n          isEditing={!!editingIssue}\n          onClose={() => {\n            setShowAddIssueModal(false);\n            setEditingIssue(null);\n            setIssueForm({\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              priority: \"medium\",\n              location: \"\",\n              status: \"outstanding\",\n              notes: \"\",\n              photos: [],\n              partsRequired: false,\n              partsDetails: \"\",\n            });\n          }}\n          onSubmit={editingIssue ? saveEditedIssue : addIssue}\n        />\n      )}\n\n      {showAddDocumentModal && (\n        <AddDocumentModal\n          documentForm={documentForm}\n          setDocumentForm={setDocumentForm}\n          onClose={() => {\n            setShowAddDocumentModal(false);\n            setDocumentForm({ name: \"\", type: \"other\", file: null });\n          }}\n          onSubmit={() => {\n            if (!documentForm.file) {\n              return toast.error(\"File is required\");\n            }\n            if (documentForm.type === \"other\" && !documentForm.name) {\n              return toast.error(\"Document name is required for 'Other' type\");\n            }\n            // Generate default name based on type if not \"other\"\n            const docName = documentForm.type === \"other\"\n              ? documentForm.name\n              : documentForm.type.replace(/_/g, \" \").replace(/\\b\\w/g, l => l.toUpperCase());\n            uploadDocument(documentForm.file, docName, documentForm.type);\n          }}\n        />\n      )}\n\n      {showAddLocationModal && (\n        <AddLocationModal\n          onClose={() => setShowAddLocationModal(false)}\n          onSuccess={(newLocation) => {\n            setLocations([...locations, newLocation]);\n            setSelectedVehicle({ ...selectedVehicle, locationId: newLocation.id || newLocation._id });\n            fetch(`/api/vehicles/${selectedVehicle.id}`, {\n              method: \"PUT\",\n              headers: { \"Content-Type\": \"application/json\" },\n              body: JSON.stringify({ locationId: newLocation.id || newLocation._id }),\n            }).then(() => {\n              fetchVehicles();\n              setShowAddLocationModal(false);\n            });\n          }}\n        />\n      )}\n\n      {/* Parts Order Modal */}\n      {showPartsOrderModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">\n                {editingPartsOrderId ? \"Edit Parts Order\" : \"Add Parts Order\"}\n              </h3>\n              <button\n                onClick={closePartsOrderModal}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Supplier</span>\n                </label>\n                <select\n                  className=\"select select-bordered w-full\"\n                  value={partsOrderForm.supplierType}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, supplierType: e.target.value })}\n                >\n                  <option value=\"EURO_CAR_PARTS\">Euro Car Parts</option>\n                  <option value=\"TPS\">TPS</option>\n                  <option value=\"MAIN_DEALER\">Main Dealer</option>\n                  <option value=\"LOCAL_FACTOR\">Local Factor</option>\n                  <option value=\"ONLINE\">Online</option>\n                  <option value=\"OTHER\">Other</option>\n                </select>\n              </div>\n              {partsOrderForm.supplierType === \"OTHER\" && (\n                <div className=\"form-control\">\n                  <label className=\"label\">\n                    <span className=\"label-text font-medium\">Supplier Name</span>\n                  </label>\n                  <input\n                    type=\"text\"\n                    placeholder=\"Enter supplier name\"\n                    className=\"input input-bordered w-full\"\n                    value={partsOrderForm.supplierName}\n                    onChange={(e) => setPartsOrderForm({ ...partsOrderForm, supplierName: e.target.value })}\n                  />\n                </div>\n              )}\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Order Reference (Optional)</span>\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"e.g., ORD-123456\"\n                  className=\"input input-bordered w-full\"\n                  value={partsOrderForm.orderRef}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, orderRef: e.target.value })}\n                />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Expected Delivery (Optional)</span>\n                </label>\n                <input\n                  type=\"date\"\n                  className=\"input input-bordered w-full\"\n                  value={partsOrderForm.expectedAt}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, expectedAt: e.target.value })}\n                />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Notes (Optional)</span>\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"e.g., Oil filter + air filter\"\n                  className=\"input input-bordered w-full\"\n                  value={partsOrderForm.notes}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, notes: e.target.value })}\n                />\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2 p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={closePartsOrderModal}\n              >\n                Cancel\n              </button>\n              <button\n                className=\"btn btn-primary\"\n                onClick={editingPartsOrderId ? updatePartsOrder : addPartsOrder}\n              >\n                {editingPartsOrderId ? \"Update\" : \"Add Order\"}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Add Label Modal */}\n      {showAddLabelModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Create New Label</h3>\n              <button\n                onClick={() => {\n                  setShowAddLabelModal(false);\n                  setNewLabelForm({ name: \"\", colour: \"#6366f1\" });\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Label Name</span>\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"e.g., Hot Lead, Awaiting Finance\"\n                  className=\"input input-bordered w-full\"\n                  value={newLabelForm.name}\n                  onChange={(e) => setNewLabelForm({ ...newLabelForm, name: e.target.value })}\n                  autoFocus\n                />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Colour</span>\n                </label>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"color\"\n                    className=\"w-12 h-10 rounded cursor-pointer border border-slate-300\"\n                    value={newLabelForm.colour}\n                    onChange={(e) => setNewLabelForm({ ...newLabelForm, colour: e.target.value })}\n                  />\n                  <div className=\"flex gap-2\">\n                    {[\"#ef4444\", \"#f59e0b\", \"#22c55e\", \"#3b82f6\", \"#8b5cf6\", \"#ec4899\", \"#6b7280\"].map(color => (\n                      <button\n                        key={color}\n                        type=\"button\"\n                        onClick={() => setNewLabelForm({ ...newLabelForm, colour: color })}\n                        className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${newLabelForm.colour === color ? 'border-slate-900 scale-110' : 'border-transparent'}`}\n                        style={{ backgroundColor: color }}\n                      />\n                    ))}\n                  </div>\n                </div>\n              </div>\n              {/* Preview */}\n              {newLabelForm.name && (\n                <div className=\"pt-2\">\n                  <label className=\"label\">\n                    <span className=\"label-text font-medium\">Preview</span>\n                  </label>\n                  <span\n                    className=\"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold\"\n                    style={{\n                      backgroundColor: `${newLabelForm.colour}20`,\n                      color: newLabelForm.colour,\n                    }}\n                  >\n                    <span className=\"w-2 h-2 rounded-full\" style={{ backgroundColor: newLabelForm.colour }}></span>\n                    {newLabelForm.name}\n                  </span>\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end gap-2 p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowAddLabelModal(false);\n                  setNewLabelForm({ name: \"\", colour: \"#6366f1\" });\n                }}\n              >\n                Cancel\n              </button>\n              <button\n                className=\"btn btn-primary\"\n                onClick={createLabel}\n                disabled={!newLabelForm.name.trim()}\n              >\n                Create Label\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Job Sheet Share Modal */}\n      {showJobSheetModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Share Job Sheet</h3>\n              <button\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4\">\n              {isGeneratingJobSheet ? (\n                <div className=\"flex flex-col items-center py-8\">\n                  <div className=\"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3\"></div>\n                  <p className=\"text-slate-600\">Generating share link...</p>\n                </div>\n              ) : jobSheetLink ? (\n                <div className=\"space-y-4\">\n                  <div className=\"bg-slate-50 rounded-lg p-3\">\n                    <p className=\"text-xs text-slate-500 mb-1\">Shareable Link</p>\n                    <p className=\"text-sm font-mono text-slate-900 break-all\">{jobSheetLink}</p>\n                  </div>\n                  <p className=\"text-xs text-slate-500\">\n                    This link expires in 60 days. Anyone with this link can view the job sheet.\n                  </p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      onClick={copyJobSheetLink}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      Copy Link\n                    </button>\n                    <button\n                      onClick={shareViaWhatsApp}\n                      className=\"btn btn-success btn-sm gap-2 text-white\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\n                      </svg>\n                      WhatsApp\n                    </button>\n                    <button\n                      onClick={() => {\n                        const subject = `Job Sheet - ${selectedVehicle?.regCurrent || 'Vehicle'}`;\n                        const body = `Here is the job sheet for ${selectedVehicle?.regCurrent || 'the vehicle'}:\\n\\n${jobSheetLink}`;\n                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);\n                      }}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n                      </svg>\n                      Email\n                    </button>\n                    <button\n                      onClick={() => window.open(jobSheetLink, '_blank')}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                      </svg>\n                      Print / PDF\n                    </button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  No link generated yet\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Prep Summary Share Modal */}\n      {showPrepSummaryModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Prep Summary PDF</h3>\n              <button\n                onClick={() => {\n                  setShowPrepSummaryModal(false);\n                  setPrepSummaryLink(null);\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4\">\n              {isGeneratingPrepSummary ? (\n                <div className=\"flex flex-col items-center py-8\">\n                  <div className=\"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3\"></div>\n                  <p className=\"text-slate-600\">Generating prep summary...</p>\n                </div>\n              ) : prepSummaryLink ? (\n                <div className=\"space-y-4\">\n                  <div className=\"bg-slate-50 rounded-lg p-3\">\n                    <p className=\"text-xs text-slate-500 mb-1\">Shareable Link</p>\n                    <p className=\"text-sm font-mono text-slate-900 break-all\">{prepSummaryLink.url}</p>\n                  </div>\n                  <p className=\"text-xs text-slate-500\">\n                    This link expires in 60 days. Click Print/PDF to save a PDF of the prep summary.\n                  </p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      onClick={copyPrepSummaryLink}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      Copy Link\n                    </button>\n                    <button\n                      onClick={sharePrepSummaryViaWhatsApp}\n                      className=\"btn btn-success btn-sm gap-2 text-white\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\n                      </svg>\n                      WhatsApp\n                    </button>\n                    <button\n                      onClick={() => {\n                        const subject = `Prep Summary - ${selectedVehicle?.regCurrent || 'Vehicle'}`;\n                        const body = `Here is the prep summary for ${selectedVehicle?.regCurrent || 'the vehicle'}:\\n\\n${prepSummaryLink.url}`;\n                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);\n                      }}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n                      </svg>\n                      Email\n                    </button>\n                    <button\n                      onClick={() => window.open(prepSummaryLink.url, '_blank')}\n                      className=\"btn btn-primary btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                      </svg>\n                      Print / PDF\n                    </button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  No link generated yet\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowPrepSummaryModal(false);\n                  setPrepSummaryLink(null);\n                }}\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Manual Share Fallback Modal */}\n      {showManualShareModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\n          <div className=\"bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Share Link</h3>\n              <button\n                onClick={() => {\n                  setShowManualShareModal(false);\n                  setManualShareUrl(\"\");\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <p className=\"text-sm text-slate-600\">\n                Copy the link below to share:\n              </p>\n              <div className=\"bg-slate-50 rounded-lg p-3 relative\">\n                <input\n                  type=\"text\"\n                  value={manualShareUrl}\n                  readOnly\n                  className=\"w-full bg-transparent text-sm font-mono text-slate-900 border-none focus:outline-none pr-10\"\n                  onClick={(e) => e.target.select()}\n                />\n                <button\n                  onClick={async () => {\n                    try {\n                      await navigator.clipboard.writeText(manualShareUrl);\n                      toast.success(\"Link copied!\");\n                    } catch {\n                      // If clipboard still fails, user can manually copy\n                      toast.info(\"Select and copy the link manually\");\n                    }\n                  }}\n                  className=\"absolute right-2 top-1/2 -translate-y-1/2 p-2 hover:bg-slate-200 rounded transition-colors\"\n                  title=\"Copy to clipboard\"\n                >\n                  <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                  </svg>\n                </button>\n              </div>\n              <p className=\"text-xs text-slate-500\">\n                Click the link to select it, then use Ctrl+C (or Cmd+C on Mac) to copy.\n              </p>\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-primary\"\n                onClick={() => {\n                  setShowManualShareModal(false);\n                  setManualShareUrl(\"\");\n                }}\n              >\n                Done\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </DashboardLayout>\n  );\n}\n\nfunction AddVehicleModal({ onClose, onSuccess }) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [locations, setLocations] = useState([]);\n  const [prepTemplates, setPrepTemplates] = useState([]);\n  const [formData, setFormData] = useState({\n    regCurrent: \"\", make: \"\", model: \"\", year: \"\", mileageCurrent: \"\",\n    fuelType: \"\", transmission: \"\", colour: \"\", notes: \"\", locationId: \"\",\n    motExpiryDate: \"\", // MOT expiry date (autofilled from lookup or manual entry)\n    engineCapacity: \"\", // Engine capacity in cc (autofilled from lookup or manual entry)\n    type: \"STOCK\", // STOCK, COURTESY, FLEET_OTHER\n    saleType: \"RETAIL\", // RETAIL, TRADE - only used when type is STOCK\n    dvlaDetails: null, // DVLA VES extended details\n    lastDvlaFetchAt: null, // When DVLA lookup was performed\n  });\n\n  // Appraisal lookup state\n  const [matchedAppraisal, setMatchedAppraisal] = useState(null);\n  const [isCheckingAppraisal, setIsCheckingAppraisal] = useState(false);\n  const [appraisalDismissed, setAppraisalDismissed] = useState(false);\n\n  // VRM appraisal suggestions\n  const [appraisalSuggestions, setAppraisalSuggestions] = useState([]);\n  const [showAppraisalDropdown, setShowAppraisalDropdown] = useState(false);\n  const [isSearchingAppraisals, setIsSearchingAppraisals] = useState(false);\n\n  // Document uploads\n  const [v5File, setV5File] = useState(null);\n  const [serviceHistoryFile, setServiceHistoryFile] = useState(null);\n  const [faultCodesFile, setFaultCodesFile] = useState(null);\n  const [otherDocuments, setOtherDocuments] = useState([]);\n\n  // Initial issues (array of issues to create with the vehicle)\n  const [initialIssues, setInitialIssues] = useState([]);\n  const [showAddIssueInVehicleModal, setShowAddIssueInVehicleModal] = useState(false);\n  const [newIssueForm, setNewIssueForm] = useState({\n    category: \"\",\n    subcategory: \"\",\n    description: \"\",\n    actionNeeded: \"\",\n    status: \"Outstanding\",\n    notes: \"\",\n    photos: [],\n  });\n\n  // Prep checklist template\n  const [selectedTemplate, setSelectedTemplate] = useState(\"default\");\n\n  useEffect(() => {\n    fetchLocations();\n    fetchPrepTemplates();\n  }, []);\n\n  const fetchLocations = async () => {\n    try {\n      const res = await fetch(\"/api/locations\");\n      const data = await res.json();\n      setLocations(data);\n    } catch (error) {\n      console.error(\"Failed to fetch locations\");\n    }\n  };\n\n  const fetchPrepTemplates = async () => {\n    try {\n      const res = await fetch(\"/api/prep-tasks\");\n      const data = await res.json();\n      setPrepTemplates(data);\n      // Auto-select first template if available\n      if (data.length > 0) setSelectedTemplate(\"default\");\n    } catch (error) {\n      console.error(\"Failed to fetch prep templates\");\n    }\n  };\n\n  // Search unconverted appraisals as user types VRM\n  const searchAppraisals = async (vrm) => {\n    if (!vrm || vrm.length < 2) {\n      setAppraisalSuggestions([]);\n      setShowAppraisalDropdown(false);\n      return;\n    }\n    setIsSearchingAppraisals(true);\n    try {\n      const res = await fetch(`/api/appraisals/search-unconverted?q=${encodeURIComponent(vrm)}`);\n      if (res.ok) {\n        const results = await res.json();\n        setAppraisalSuggestions(results);\n        setShowAppraisalDropdown(results.length > 0);\n      } else {\n        setAppraisalSuggestions([]);\n        setShowAppraisalDropdown(false);\n      }\n    } catch (error) {\n      setAppraisalSuggestions([]);\n      setShowAppraisalDropdown(false);\n    } finally {\n      setIsSearchingAppraisals(false);\n    }\n  };\n\n  // Handle selecting an appraisal from suggestions\n  const handleSelectAppraisalSuggestion = (appraisal) => {\n    setFormData(prev => ({\n      ...prev,\n      regCurrent: appraisal.vehicleReg || prev.regCurrent,\n      make: appraisal.vehicleMake || prev.make,\n      model: appraisal.vehicleModel || prev.model,\n      year: appraisal.vehicleYear || prev.year,\n      mileageCurrent: appraisal.mileage || prev.mileageCurrent,\n    }));\n    setMatchedAppraisal(appraisal);\n    setAppraisalDismissed(false);\n    setShowAppraisalDropdown(false);\n    setAppraisalSuggestions([]);\n    toast.success(`Loaded appraisal for ${appraisal.vehicleReg}`);\n  };\n\n  // Check for existing appraisal when VRM changes\n  const checkForAppraisal = async (vrm) => {\n    if (!vrm || vrm.length < 2) {\n      setMatchedAppraisal(null);\n      return;\n    }\n    setIsCheckingAppraisal(true);\n    try {\n      const res = await fetch(`/api/appraisals/by-vrm?vrm=${encodeURIComponent(vrm)}`);\n      if (res.ok) {\n        const appraisal = await res.json();\n        setMatchedAppraisal(appraisal);\n        setAppraisalDismissed(false);\n      } else {\n        setMatchedAppraisal(null);\n      }\n    } catch (error) {\n      setMatchedAppraisal(null);\n    } finally {\n      setIsCheckingAppraisal(false);\n    }\n  };\n\n  // Import data from matched appraisal\n  const importFromAppraisal = () => {\n    if (!matchedAppraisal) return;\n    setFormData(prev => ({\n      ...prev,\n      regCurrent: matchedAppraisal.vehicleReg || prev.regCurrent,\n      make: matchedAppraisal.vehicleMake || prev.make,\n      model: matchedAppraisal.vehicleModel || prev.model,\n      year: matchedAppraisal.vehicleYear || prev.year,\n      mileageCurrent: matchedAppraisal.mileage || prev.mileageCurrent,\n      notes: matchedAppraisal.conditionNotes || prev.notes,\n    }));\n    setAppraisalDismissed(true);\n    toast.success(\"Imported data from appraisal\");\n  };\n\n  // Convert appraisal directly to stock (uses the convert API)\n  const convertAppraisalToStock = async () => {\n    if (!matchedAppraisal) return;\n    setIsLoading(true);\n    try {\n      // Determine the API endpoint based on appraisal type\n      const endpoint = matchedAppraisal.type === \"customer_px\"\n        ? `/api/customer-px/${matchedAppraisal.id}/convert`\n        : `/api/appraisals/${matchedAppraisal.id}/convert`;\n\n      const res = await fetch(endpoint, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ initialStatus: \"in_stock\" }),\n      });\n\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to convert appraisal\");\n      }\n\n      toast.success(\"Appraisal converted to stock!\");\n      onSuccess();\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleLookup = async () => {\n    if (!formData.regCurrent) return toast.error(\"Enter registration first\");\n    setIsLookingUp(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: formData.regCurrent }),\n      });\n      const data = await res.json();\n\n      // Check for error response\n      if (!res.ok || data.error) {\n        toast.error(data.message || data.error || \"Vehicle not found\");\n        return;\n      }\n\n      if (data.isDummy) showDummyNotification(\"DVLA API\");\n\n      // Update form with DVLA data\n      setFormData(prev => ({\n        ...prev,\n        make: data.make || prev.make,\n        model: data.model || prev.model,\n        year: data.yearOfManufacture || data.year || prev.year,\n        colour: data.colour || prev.colour,\n        fuelType: data.fuelType || prev.fuelType,\n        transmission: data.transmission || prev.transmission,\n        motExpiryDate: data.motExpiryDate || prev.motExpiryDate,\n        // Engine capacity from DVLA (in cc)\n        engineCapacity: data.engineCapacity || data.dvlaDetails?.engineCapacity || prev.engineCapacity,\n        // Store full DVLA details for API persistence\n        dvlaDetails: data.dvlaDetails || null,\n        lastDvlaFetchAt: data.lastDvlaFetchAt || null,\n      }));\n\n      toast.success(`Found: ${data.make} ${data.model || \"\"} (${data.yearOfManufacture || \"\"})`);\n    } catch (error) {\n      toast.error(\"Lookup failed - please try again\");\n    } finally {\n      setIsLookingUp(false);\n    }\n  };\n\n  const uploadFile = async (file) => {\n    if (!file) return null;\n    const formData = new FormData();\n    formData.append(\"file\", file);\n    const res = await fetch(\"/api/vehicles/upload\", {\n      method: \"POST\",\n      body: formData,\n    });\n    if (!res.ok) throw new Error(\"Upload failed\");\n    const data = await res.json();\n    // Store S3 key (permanent) if available, otherwise use URL (for local dev)\n    return data.key || data.url;\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    if (!formData.regCurrent || !formData.make || !formData.model) {\n      return toast.error(\"Reg, make and model are required\");\n    }\n    setIsLoading(true);\n    try {\n      // Create vehicle first\n      // If \"None\" is selected, skip default tasks\n      // If \"default\" is selected, create default tasks (don't skip)\n      const skipDefault = selectedTemplate === \"\";\n      const vehicleRes = await fetch(\"/api/vehicles\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ ...formData, skipDefaultTasks: skipDefault }),\n      });\n      if (!vehicleRes.ok) {\n        const errorData = await vehicleRes.json();\n        throw new Error(errorData.error || \"Failed to create vehicle\");\n      }\n      const vehicle = await vehicleRes.json();\n\n      // Upload documents\n      if (v5File) {\n        const v5Url = await uploadFile(v5File);\n        await fetch(`/api/vehicles/${vehicle.id}`, {\n          method: \"PUT\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ v5Url }),\n        });\n      }\n\n      if (serviceHistoryFile) {\n        const url = await uploadFile(serviceHistoryFile);\n        await fetch(`/api/vehicles/${vehicle.id}/documents`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ name: \"Service History\", type: \"service_history\", url }),\n        });\n      }\n\n      if (faultCodesFile) {\n        const url = await uploadFile(faultCodesFile);\n        await fetch(`/api/vehicles/${vehicle.id}/documents`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ name: \"Fault Codes\", type: \"fault_codes\", url }),\n        });\n      }\n\n      // Upload other documents\n      for (const doc of otherDocuments) {\n        if (doc.file) {\n          const url = await uploadFile(doc.file);\n          await fetch(`/api/vehicles/${vehicle.id}/documents`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ name: doc.name || \"Document\", type: \"other\", url }),\n          });\n        }\n      }\n\n      // Create initial issues from the array\n      for (const issue of initialIssues) {\n        await fetch(`/api/vehicles/${vehicle.id}/issues`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            category: issue.category,\n            subcategory: issue.subcategory,\n            description: issue.description,\n            actionNeeded: issue.actionNeeded,\n            status: issue.status || \"Outstanding\",\n            notes: issue.notes,\n          }),\n        });\n      }\n\n      // Create prep tasks based on template\n      // Only create from prepTemplates if a custom template is selected (not \"default\" which is handled by API)\n      if (selectedTemplate && selectedTemplate !== \"default\" && prepTemplates.length > 0) {\n        for (const template of prepTemplates) {\n          await fetch(`/api/vehicles/${vehicle.id}/tasks`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ name: template.name }),\n          });\n        }\n      }\n\n      // Link appraisal to vehicle if one was matched\n      if (matchedAppraisal && matchedAppraisal.id) {\n        await fetch(`/api/appraisals/${matchedAppraisal.id}`, {\n          method: \"PATCH\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            decision: \"converted\",\n            vehicleId: vehicle.id,\n            decidedAt: new Date(),\n          }),\n        });\n      }\n\n      toast.success(\"Vehicle added!\");\n      onSuccess();\n    } catch (error) {\n      console.error(\"Error:\", error);\n      toast.error(error.message);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box max-w-4xl max-h-[90vh] overflow-y-auto bg-white\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h3 className=\"text-xl font-bold text-slate-900\">Add Vehicle</h3>\n          <button\n            type=\"button\"\n            onClick={onClose}\n            className=\"p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200\"\n          >\n            <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n            </svg>\n          </button>\n        </div>\n        <form onSubmit={handleSubmit}>\n          {/* Vehicle Details Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Vehicle Details</h4>\n            <div className=\"relative flex gap-2 mb-4\">\n              <div className=\"relative flex-1\">\n                <input\n                  type=\"text\"\n                  placeholder=\"Registration\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg uppercase font-mono text-slate-900 placeholder-slate-400 focus:bg-white focus:border-transparent focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  value={formData.regCurrent}\n                  onChange={(e) => {\n                    const newValue = e.target.value.toUpperCase();\n                    setFormData({ ...formData, regCurrent: newValue });\n                    searchAppraisals(newValue);\n                  }}\n                  onFocus={() => {\n                    if (appraisalSuggestions.length > 0) setShowAppraisalDropdown(true);\n                  }}\n                  onBlur={(e) => {\n                    // Delay hiding dropdown so click on suggestion can register\n                    setTimeout(() => setShowAppraisalDropdown(false), 200);\n                    checkForAppraisal(e.target.value);\n                  }}\n                />\n                {isSearchingAppraisals && (\n                  <span className=\"absolute right-3 top-1/2 -translate-y-1/2 loading loading-spinner loading-sm\"></span>\n                )}\n                {/* Appraisal Suggestions Dropdown */}\n                {showAppraisalDropdown && appraisalSuggestions.length > 0 && (\n                  <div className=\"absolute top-full left-0 right-0 z-50 mt-1 bg-base-100 border border-base-300 rounded-lg shadow-xl max-h-64 overflow-y-auto\">\n                    <div className=\"px-3 py-2 text-xs text-base-content/60 border-b border-base-200 bg-base-200/50\">\n                      Unconverted Appraisals\n                    </div>\n                    {appraisalSuggestions.map((appraisal) => (\n                      <button\n                        key={appraisal.id}\n                        type=\"button\"\n                        className=\"w-full px-3 py-2 text-left hover:bg-base-200 border-b border-base-200 last:border-b-0 flex items-center gap-3\"\n                        onClick={() => handleSelectAppraisalSuggestion(appraisal)}\n                      >\n                        <div className=\"flex-1\">\n                          <div className=\"font-mono font-bold\">{appraisal.vehicleReg}</div>\n                          <div className=\"text-sm text-base-content/70\">\n                            {appraisal.vehicleMake} {appraisal.vehicleModel} {appraisal.vehicleYear ? `(${appraisal.vehicleYear})` : \"\"}\n                          </div>\n                        </div>\n                        <span className={`badge badge-sm ${appraisal.type === \"dealer\" ? \"badge-primary\" : \"badge-secondary\"}`}>\n                          {appraisal.type === \"dealer\" ? \"Dealer\" : \"Customer PX\"}\n                        </span>\n                      </button>\n                    ))}\n                  </div>\n                )}\n              </div>\n              <button\n                type=\"button\"\n                className=\"px-5 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-2\"\n                onClick={handleLookup}\n                disabled={isLookingUp}\n              >\n                {isLookingUp ? <span className=\"loading loading-spinner loading-sm\"></span> : <><span>🔍</span><span>Lookup</span></>}\n              </button>\n            </div>\n\n            {/* Appraisal Match Alert */}\n            {isCheckingAppraisal && (\n              <div className=\"alert mb-4\">\n                <span className=\"loading loading-spinner loading-sm\"></span>\n                <span>Checking for existing appraisals...</span>\n              </div>\n            )}\n            {matchedAppraisal && !appraisalDismissed && (\n              <div className=\"alert alert-success mb-4\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5 shrink-0\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n                <div className=\"flex-1\">\n                  <p className=\"font-semibold\">\n                    {matchedAppraisal.type === \"customer_px\" ? \"Customer PX\" : \"Dealer\"} Appraisal Found: {matchedAppraisal.vehicleReg}\n                  </p>\n                  <p className=\"text-sm opacity-80\">\n                    {matchedAppraisal.vehicleMake} {matchedAppraisal.vehicleModel} {matchedAppraisal.vehicleYear ? `(${matchedAppraisal.vehicleYear})` : \"\"}\n                    {matchedAppraisal.mileage ? ` • ${matchedAppraisal.mileage.toLocaleString()} miles` : \"\"}\n                  </p>\n                </div>\n                <div className=\"flex flex-col sm:flex-row gap-2\">\n                  <button type=\"button\" className=\"btn btn-sm btn-primary\" onClick={convertAppraisalToStock} disabled={isLoading}>\n                    {isLoading ? <span className=\"loading loading-spinner loading-sm\"></span> : \"Convert to Stock\"}\n                  </button>\n                  <button type=\"button\" className=\"btn btn-sm btn-ghost\" onClick={importFromAppraisal}>\n                    Import Data Only\n                  </button>\n                  <button type=\"button\" className=\"btn btn-sm btn-ghost\" onClick={() => setAppraisalDismissed(true)}>\n                    Dismiss\n                  </button>\n                </div>\n              </div>\n            )}\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Make *</label>\n                <input type=\"text\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.make}\n                  onChange={(e) => setFormData({ ...formData, make: e.target.value })} required />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Model *</label>\n                <input type=\"text\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.model}\n                  onChange={(e) => setFormData({ ...formData, model: e.target.value })} required />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Year</label>\n                <input type=\"number\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.year}\n                  onChange={(e) => setFormData({ ...formData, year: e.target.value })} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Mileage</label>\n                <input type=\"number\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.mileageCurrent}\n                  onChange={(e) => setFormData({ ...formData, mileageCurrent: e.target.value })} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Colour</label>\n                <input type=\"text\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.colour}\n                  onChange={(e) => setFormData({ ...formData, colour: e.target.value })} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Fuel Type</label>\n                <select className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\" value={formData.fuelType?.toUpperCase() || \"\"}\n                  onChange={(e) => setFormData({ ...formData, fuelType: e.target.value })}>\n                  <option value=\"\">Select...</option>\n                  <option value=\"PETROL\">Petrol</option>\n                  <option value=\"DIESEL\">Diesel</option>\n                  <option value=\"HYBRID\">Hybrid</option>\n                  <option value=\"ELECTRIC\">Electric</option>\n                  <option value=\"LPG\">LPG</option>\n                  <option value=\"CNG\">CNG</option>\n                </select>\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">MOT Expiry Date</label>\n                <input\n                  type=\"date\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  value={formData.motExpiryDate ? formData.motExpiryDate.split(\"T\")[0] : \"\"}\n                  onChange={(e) => setFormData({ ...formData, motExpiryDate: e.target.value })}\n                />\n                <p className=\"text-xs text-slate-400 mt-1.5\">\n                  {formData.motExpiryDate ? \"\" : \"Auto-filled by VRM lookup or enter manually\"}\n                </p>\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Transmission</label>\n                <select className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\" value={formData.transmission?.toUpperCase() || \"\"}\n                  onChange={(e) => setFormData({ ...formData, transmission: e.target.value })}>\n                  <option value=\"\">Select...</option>\n                  <option value=\"MANUAL\">Manual</option>\n                  <option value=\"AUTOMATIC\">Automatic</option>\n                  <option value=\"SEMI-AUTO\">Semi-Auto</option>\n                  <option value=\"CVT\">CVT</option>\n                </select>\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Engine Capacity (cc)</label>\n                <input\n                  type=\"number\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  placeholder=\"e.g., 1500\"\n                  value={formData.engineCapacity || \"\"}\n                  onChange={(e) => setFormData({ ...formData, engineCapacity: e.target.value })}\n                />\n                <p className=\"text-xs text-slate-400 mt-1.5\">\n                  {formData.engineCapacity ? \"\" : \"Auto-filled by VRM lookup\"}\n                </p>\n              </div>\n            </div>\n          </div>\n\n          {/* Vehicle Type Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Vehicle Type</h4>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Vehicle Type</label>\n                <select\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                  value={formData.type}\n                  onChange={(e) => {\n                    const newType = e.target.value;\n                    setFormData({\n                      ...formData,\n                      type: newType,\n                      // Clear saleType if not Stock\n                      saleType: newType === \"STOCK\" ? (formData.saleType || \"RETAIL\") : undefined\n                    });\n                  }}\n                >\n                  <option value=\"STOCK\">Stock - For sale</option>\n                  <option value=\"COURTESY\">Courtesy - Loan vehicle</option>\n                  <option value=\"FLEET_OTHER\">Fleet/Other - Company vehicle</option>\n                </select>\n              </div>\n              {/* Sale Type - Only show for Stock vehicles */}\n              {formData.type === \"STOCK\" && (\n                <div className=\"form-control\">\n                  <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Sale Type</label>\n                  <select\n                    className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                    value={formData.saleType || \"RETAIL\"}\n                    onChange={(e) => setFormData({ ...formData, saleType: e.target.value })}\n                  >\n                    <option value=\"RETAIL\">Retail - Customer sale</option>\n                    <option value=\"TRADE\">Trade - Dealer sale</option>\n                  </select>\n                </div>\n              )}\n            </div>\n            <p className=\"text-xs text-slate-400 mt-3\">\n              {formData.type === \"COURTESY\" && \"This vehicle will be available in courtesy car forms\"}\n              {formData.type === \"FLEET_OTHER\" && \"This vehicle will not appear in sales board\"}\n              {formData.type === \"STOCK\" && formData.saleType === \"TRADE\" && \"Trade vehicles are marked separately and can be filtered\"}\n              {formData.type === \"STOCK\" && formData.saleType !== \"TRADE\" && \"This vehicle will go through the normal sales prep flow\"}\n            </p>\n          </div>\n\n          {/* Location Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Location</h4>\n            <div className=\"form-control\">\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={formData.locationId}\n                onChange={(e) => setFormData({ ...formData, locationId: e.target.value })}\n              >\n                <option value=\"\">On Site</option>\n                {locations.map(loc => (\n                  <option key={loc.id} value={loc.id}>{loc.name}</option>\n                ))}\n              </select>\n            </div>\n          </div>\n\n          {/* Document Uploads Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Document Uploads (Optional)</h4>\n            <div className=\"space-y-4\">\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">V5 Document</label>\n                <input type=\"file\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" accept=\"image/*,.pdf\"\n                  onChange={(e) => setV5File(e.target.files[0])} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Service History</label>\n                <input type=\"file\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" accept=\"image/*,.pdf\"\n                  onChange={(e) => setServiceHistoryFile(e.target.files[0])} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Fault Codes</label>\n                <input type=\"file\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" accept=\"image/*,.pdf\"\n                  onChange={(e) => setFaultCodesFile(e.target.files[0])} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Other Documents</label>\n                <button\n                  type=\"button\"\n                  className=\"px-4 py-2.5 bg-slate-50 border border-slate-200 hover:border-slate-300 hover:bg-slate-100 text-slate-700 text-sm font-medium rounded-lg transition-all duration-200\"\n                  onClick={() => setOtherDocuments([...otherDocuments, { name: \"\", file: null }])}\n                >\n                  + Add Document/Image\n                </button>\n                {otherDocuments.map((doc, idx) => (\n                  <div key={idx} className=\"flex gap-2 mt-3\">\n                    <input\n                      type=\"text\"\n                      placeholder=\"Document name\"\n                      className=\"flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 text-sm placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                      value={doc.name}\n                      onChange={(e) => {\n                        const updated = [...otherDocuments];\n                        updated[idx].name = e.target.value;\n                        setOtherDocuments(updated);\n                      }}\n                    />\n                    <input\n                      type=\"file\"\n                      className=\"flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 text-sm file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium file:text-xs hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] transition-all duration-200 outline-none\"\n                      onChange={(e) => {\n                        const updated = [...otherDocuments];\n                        updated[idx].file = e.target.files[0];\n                        setOtherDocuments(updated);\n                      }}\n                    />\n                    <button\n                      type=\"button\"\n                      className=\"p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all duration-200\"\n                      onClick={() => setOtherDocuments(otherDocuments.filter((_, i) => i !== idx))}\n                    >\n                      ✕\n                    </button>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {/* Initial Issues Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Initial Issues (Optional)</h4>\n\n            {/* Add Issue Button */}\n            <button\n              type=\"button\"\n              className=\"w-full px-4 py-2.5 bg-slate-50 border border-slate-200 hover:border-slate-300 hover:bg-slate-100 text-slate-700 text-sm font-medium rounded-lg transition-all duration-200 mb-3\"\n              onClick={() => setShowAddIssueInVehicleModal(true)}\n            >\n              + Add Issue\n            </button>\n\n            {/* Issue Summary Cards */}\n            {initialIssues.length > 0 && (\n              <div className=\"space-y-2\">\n                {initialIssues.map((issue, index) => (\n                  <div key={index} className=\"card bg-base-200\">\n                    <div className=\"card-body p-3\">\n                      <div className=\"flex justify-between items-start gap-2\">\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            <span className=\"badge badge-sm\">{issue.category}</span>\n                            {issue.subcategory && (\n                              <span className=\"badge badge-sm badge-ghost\">{issue.subcategory}</span>\n                            )}\n                          </div>\n                          <p className=\"text-sm font-medium truncate\">{issue.description}</p>\n                          {issue.actionNeeded && (\n                            <p className=\"text-xs text-base-content/60 mt-1\">Action: {issue.actionNeeded}</p>\n                          )}\n                        </div>\n                        <button\n                          type=\"button\"\n                          className=\"btn btn-ghost btn-xs text-error\"\n                          onClick={() => {\n                            setInitialIssues(initialIssues.filter((_, i) => i !== index));\n                          }}\n                        >\n                          ✕\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* Prep Checklist Template Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Prep Checklist Template</h4>\n            <div className=\"form-control\">\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={selectedTemplate}\n                onChange={(e) => setSelectedTemplate(e.target.value)}\n              >\n                <option value=\"\">None - add tasks manually</option>\n                <option value=\"default\">Standard Prep (5 tasks)</option>\n              </select>\n            </div>\n\n            {/* Task Preview for Standard Prep */}\n            {selectedTemplate === \"default\" && (\n              <div className=\"mt-3 p-4 bg-slate-50 rounded-lg border border-slate-100\">\n                <p className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-3\">Tasks included:</p>\n                <div className=\"text-sm text-slate-600 space-y-2\">\n                  {[\"PDI\", \"Valet\", \"Photos\", \"MOT Check\", \"Advert\"].map((task, idx) => (\n                    <div key={idx} className=\"flex items-center gap-2\">\n                      <span className=\"text-[#0066CC]\">✓</span>\n                      <span>{task}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n\n          {/* Notes Section */}\n          <div className=\"mb-8\">\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Additional Notes</label>\n              <textarea\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                rows={4}\n                value={formData.notes}\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n              ></textarea>\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-end gap-3 pt-4 border-t border-slate-100\">\n            <button\n              type=\"button\"\n              className=\"px-5 py-2.5 border border-slate-200 text-slate-600 hover:text-slate-800 hover:border-slate-300 hover:bg-slate-50 font-medium rounded-lg transition-all duration-200\"\n              onClick={onClose}\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-2.5 bg-[#0066CC] hover:bg-[#0055BB] text-white font-medium rounded-lg shadow-sm hover:shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n              disabled={isLoading}\n            >\n              {isLoading ? <><span className=\"loading loading-spinner loading-sm\"></span><span>Saving...</span></> : \"Add Vehicle\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n\n      {/* Nested Add Issue Modal */}\n      {showAddIssueInVehicleModal && (\n        <AddIssueModal\n          issueForm={newIssueForm}\n          setIssueForm={setNewIssueForm}\n          onClose={() => {\n            setShowAddIssueInVehicleModal(false);\n            setNewIssueForm({\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              status: \"Outstanding\",\n              notes: \"\",\n              photos: [],\n            });\n          }}\n          onSubmit={() => {\n            // Validate required fields\n            if (!newIssueForm.category || !newIssueForm.subcategory || !newIssueForm.description) {\n              return toast.error(\"Category, subcategory, and description are required\");\n            }\n\n            // Add issue to the array\n            setInitialIssues([...initialIssues, { ...newIssueForm }]);\n\n            // Close modal and reset form\n            setShowAddIssueInVehicleModal(false);\n            setNewIssueForm({\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              status: \"Outstanding\",\n              notes: \"\",\n              photos: [],\n            });\n            toast.success(\"Issue added\");\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\nfunction AddIssueModal({ issueForm, setIssueForm, onClose, onSubmit, isEditing = false }) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [photoFiles, setPhotoFiles] = useState([]);\n  const [photoPreviews, setPhotoPreviews] = useState([]);\n  const [isUploadingPhotos, setIsUploadingPhotos] = useState(false);\n\n  const handlePhotoChange = (e) => {\n    const files = Array.from(e.target.files);\n    setPhotoFiles(prev => [...prev, ...files]);\n\n    // Create previews\n    files.forEach(file => {\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setPhotoPreviews(prev => [...prev, reader.result]);\n      };\n      reader.readAsDataURL(file);\n    });\n  };\n\n  const removePhoto = (index) => {\n    setPhotoFiles(prev => prev.filter((_, i) => i !== index));\n    setPhotoPreviews(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const uploadPhotos = async () => {\n    const uploadedUrls = [];\n    for (const file of photoFiles) {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      const res = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: formData,\n      });\n      if (res.ok) {\n        const data = await res.json();\n        // Store S3 key (permanent) if available, otherwise use URL (for local dev)\n        uploadedUrls.push(data.key || data.url);\n      }\n    }\n    return uploadedUrls;\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsLoading(true);\n    try {\n      // Upload photos first if any\n      let photoUrls = [];\n      if (photoFiles.length > 0) {\n        setIsUploadingPhotos(true);\n        photoUrls = await uploadPhotos();\n        setIsUploadingPhotos(false);\n      }\n      // Pass photo URLs/keys to onSubmit\n      await onSubmit(photoUrls);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box max-w-2xl bg-white\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h3 className=\"text-xl font-bold text-slate-900\">{isEditing ? \"Edit Issue\" : \"Add Issue\"}</h3>\n          <button\n            type=\"button\"\n            onClick={onClose}\n            className=\"p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200\"\n          >\n            <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n            </svg>\n          </button>\n        </div>\n        <form onSubmit={handleSubmit}>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Category *</label>\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={issueForm.category}\n                onChange={(e) => {\n                  setIssueForm({ ...issueForm, category: e.target.value, subcategory: \"\" });\n                }}\n                required\n              >\n                <option value=\"\">Select category...</option>\n                <option value=\"mechanical\">Mechanical</option>\n                <option value=\"electrical\">Electrical</option>\n                <option value=\"bodywork\">Bodywork</option>\n                <option value=\"interior\">Interior</option>\n                <option value=\"tyres\">Tyres</option>\n                <option value=\"mot\">MOT</option>\n                <option value=\"service\">Service</option>\n                <option value=\"fault_codes\">Fault Codes</option>\n                <option value=\"other\">Other</option>\n              </select>\n            </div>\n\n            {issueForm.category && (\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Subcategory</label>\n                <select\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                  value={issueForm.subcategory}\n                  onChange={(e) => setIssueForm({ ...issueForm, subcategory: e.target.value })}\n                >\n                  <option value=\"\">Select subcategory...</option>\n                  {ISSUE_SUBCATEGORIES[issueForm.category]?.map((sub) => (\n                    <option key={sub} value={sub}>{sub}</option>\n                  ))}\n                </select>\n              </div>\n            )}\n\n            {/* Fault Codes field - only show for fault_codes category */}\n            {issueForm.category === \"fault_codes\" && (\n              <div className=\"form-control col-span-2\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Fault Codes</label>\n                <input\n                  type=\"text\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 font-mono placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  value={issueForm.faultCodes || \"\"}\n                  onChange={(e) => setIssueForm({ ...issueForm, faultCodes: e.target.value })}\n                  placeholder=\"e.g. P0301, P0420, C1234\"\n                />\n                <p className=\"text-xs text-slate-400 mt-1.5\">Enter codes separated by commas</p>\n              </div>\n            )}\n\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Description *</label>\n              <textarea\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                value={issueForm.description}\n                onChange={(e) => setIssueForm({ ...issueForm, description: e.target.value })}\n                placeholder={issueForm.category === \"fault_codes\" ? \"Describe what the fault codes indicate...\" : \"Describe the issue...\"}\n                required\n                rows=\"3\"\n              ></textarea>\n            </div>\n\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Action Needed</label>\n              <input\n                type=\"text\"\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                value={issueForm.actionNeeded}\n                onChange={(e) => setIssueForm({ ...issueForm, actionNeeded: e.target.value })}\n                placeholder=\"What needs to be done?\"\n              />\n            </div>\n\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Priority</label>\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={issueForm.priority || \"medium\"}\n                onChange={(e) => setIssueForm({ ...issueForm, priority: e.target.value })}\n              >\n                <option value=\"low\">Low</option>\n                <option value=\"medium\">Medium</option>\n                <option value=\"high\">High</option>\n              </select>\n            </div>\n\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Location</label>\n              <input\n                type=\"text\"\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                value={issueForm.location || \"\"}\n                onChange={(e) => setIssueForm({ ...issueForm, location: e.target.value })}\n                placeholder=\"e.g., Front Left, Rear Bumper\"\n              />\n            </div>\n\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Status</label>\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={issueForm.status}\n                onChange={(e) => setIssueForm({ ...issueForm, status: e.target.value })}\n              >\n                <option value=\"outstanding\">Outstanding</option>\n                <option value=\"ordered\">Ordered</option>\n                <option value=\"in_progress\">In Progress</option>\n                <option value=\"resolved\">Resolved</option>\n              </select>\n            </div>\n\n            {/* Parts Required Section */}\n            <div className=\"form-control flex items-center\">\n              <label className=\"flex items-center gap-3 cursor-pointer mt-6\">\n                <div className=\"relative\">\n                  <input\n                    type=\"checkbox\"\n                    className=\"sr-only peer\"\n                    checked={issueForm.partsRequired || false}\n                    onChange={(e) => setIssueForm({ ...issueForm, partsRequired: e.target.checked })}\n                  />\n                  <div className=\"w-5 h-5 rounded border-2 border-slate-300 peer-checked:border-[#0066CC] peer-checked:bg-[#0066CC] transition-all duration-200 flex items-center justify-center\">\n                    <svg className=\"w-3 h-3 text-white opacity-0 peer-checked:opacity-100\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={3} d=\"M5 13l4 4L19 7\" />\n                    </svg>\n                  </div>\n                </div>\n                <span className=\"text-sm font-medium text-slate-700\">Parts Required</span>\n              </label>\n            </div>\n\n            {issueForm.partsRequired && (\n              <div className=\"form-control col-span-2\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Parts Details</label>\n                <textarea\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                  value={issueForm.partsDetails || \"\"}\n                  onChange={(e) => setIssueForm({ ...issueForm, partsDetails: e.target.value })}\n                  placeholder=\"Supplier, part numbers, who ordered, ETA...\"\n                  rows=\"2\"\n                ></textarea>\n              </div>\n            )}\n\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Notes</label>\n              <textarea\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                value={issueForm.notes}\n                onChange={(e) => setIssueForm({ ...issueForm, notes: e.target.value })}\n                placeholder=\"Additional notes...\"\n                rows=\"2\"\n              ></textarea>\n            </div>\n\n            {/* Photo Upload */}\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Photos</label>\n              <input\n                type=\"file\"\n                accept=\"image/*\"\n                multiple\n                onChange={handlePhotoChange}\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n              />\n              {photoPreviews.length > 0 && (\n                <div className=\"flex flex-wrap gap-2 mt-3\">\n                  {photoPreviews.map((preview, idx) => (\n                    <div key={idx} className=\"relative\">\n                      <img src={preview} alt={`Preview ${idx + 1}`} className=\"w-20 h-20 object-cover rounded-lg\" />\n                      <button\n                        type=\"button\"\n                        onClick={() => removePhoto(idx)}\n                        className=\"absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs flex items-center justify-center transition-colors\"\n                      >\n                        ✕\n                      </button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-end gap-3 pt-6 mt-6 border-t border-slate-100\">\n            <button\n              type=\"button\"\n              className=\"px-5 py-2.5 border border-slate-200 text-slate-600 hover:text-slate-800 hover:border-slate-300 hover:bg-slate-50 font-medium rounded-lg transition-all duration-200\"\n              onClick={onClose}\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-2.5 bg-[#0066CC] hover:bg-[#0055BB] text-white font-medium rounded-lg shadow-sm hover:shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n              disabled={isLoading || isUploadingPhotos}\n            >\n              {isLoading || isUploadingPhotos ? (\n                <>\n                  <span className=\"loading loading-spinner loading-sm\"></span>\n                  <span>{isUploadingPhotos ? \"Uploading photos...\" : \"Saving...\"}</span>\n                </>\n              ) : \"Add Issue\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n\nfunction AddDocumentModal({ documentForm, setDocumentForm, onClose, onSubmit }) {\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsLoading(true);\n    try {\n      await onSubmit();\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box\">\n        <h3 className=\"font-bold text-lg mb-4\">Add Document/Image</h3>\n        <form onSubmit={handleSubmit}>\n          <div className=\"space-y-4\">\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Document Type</span></label>\n              <select\n                className=\"select select-bordered\"\n                value={documentForm.type}\n                onChange={(e) => setDocumentForm({ ...documentForm, type: e.target.value })}\n              >\n                <option value=\"v5\">V5</option>\n                <option value=\"service_history\">Service History</option>\n                <option value=\"fault_codes\">Fault Codes</option>\n                <option value=\"other\">Other</option>\n              </select>\n            </div>\n\n            {/* Only show Document Name field when \"Other\" is selected */}\n            {documentForm.type === \"other\" && (\n              <div className=\"form-control\">\n                <label className=\"label\"><span className=\"label-text\">Document Name *</span></label>\n                <input\n                  type=\"text\"\n                  className=\"input input-bordered\"\n                  value={documentForm.name}\n                  onChange={(e) => setDocumentForm({ ...documentForm, name: e.target.value })}\n                  placeholder=\"e.g., MOT Certificate, Insurance\"\n                  required\n                />\n              </div>\n            )}\n\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">File *</span></label>\n              <input\n                type=\"file\"\n                className=\"file-input file-input-bordered w-full\"\n                onChange={(e) => setDocumentForm({ ...documentForm, file: e.target.files[0] })}\n                accept=\"image/*,.pdf,.doc,.docx\"\n                required\n              />\n            </div>\n          </div>\n\n          <div className=\"modal-action\">\n            <button type=\"button\" className=\"btn btn-ghost\" onClick={onClose}>Cancel</button>\n            <button type=\"submit\" className=\"btn btn-primary\" disabled={isLoading}>\n              {isLoading ? <span className=\"loading loading-spinner\"></span> : \"Upload Document/Image\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n\nfunction AddLocationModal({ onClose, onSuccess }) {\n  const [name, setName] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    if (!name.trim()) return toast.error(\"Location name is required\");\n\n    setIsLoading(true);\n    try {\n      const res = await fetch(\"/api/locations\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: name.trim(), type: \"offsite\" }),\n      });\n      if (!res.ok) throw new Error(\"Failed to create location\");\n      const newLocation = await res.json();\n      toast.success(\"Location added\");\n      onSuccess(newLocation);\n    } catch (error) {\n      toast.error(\"Failed to add location\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box\">\n        <h3 className=\"font-bold text-lg mb-4\">Add New Location</h3>\n        <form onSubmit={handleSubmit}>\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text\">Location Name *</span>\n            </label>\n            <input\n              type=\"text\"\n              className=\"input input-bordered w-full\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              placeholder=\"e.g., ABC Body Shop, Paint Centre\"\n              required\n              autoFocus\n            />\n          </div>\n          <div className=\"modal-action\">\n            <button type=\"button\" className=\"btn btn-ghost\" onClick={onClose}>\n              Cancel\n            </button>\n            <button type=\"submit\" className=\"btn btn-primary\" disabled={isLoading}>\n              {isLoading ? <span className=\"loading loading-spinner\"></span> : \"Add Location\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n","structuredPatch":[{"oldStart":1,"oldLines":6,"newStart":1,"newLines":7,"lines":[" import { useEffect, useState, useRef, useCallback } from \"react\";"," import Head from \"next/head\";"," import Link from \"next/link\";","+import { useRouter } from \"next/router\";"," import DashboardLayout from \"@/components/DashboardLayout\";"," import { toast } from \"react-hot-toast\";"," import { showDummyNotification } from \"@/utils/notifications\";"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"d7e92d50-83c5-4ca0-b74e-6eaab3f99a08","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GdJfutHuQYd447nRiCMMqk","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the useRouter hook and a useEffect to handle the addVehicle query parameter. Let me find where the component function starts and add the router hook.","signature":"EtACCkYICxgCKkA/9txma6oTMDcpslPkQbYEm+1CwIBEaumHCVbe/5rGzSbiD+axcg+KwtuhkATSzfpczeKB3+Gk37Fwg9Fv85EiEgwPlQertZJ2Jv5yVIkaDP1Ecvfs1rCwXnJkZyIwPDGaMsw78qVS582v9vEDg48ABPDvpjyA29n0SPVB3b6ofJaSmWWYRoSZ/1eGRw3gKrcBYLjYTLySQ2xXjwlmVE7Fzl39eaiymdjcnMITl844278vpn1BD1f2v19qTHg2Ej5sdpmLbJiuv7rThUAF3CC25VGcc0pZ+QLzDZnYTPodweUpYBAc9nLoKIdAB+jI6C5zvK5bPWXin89vhps45XSpPcvtgcu2VjLxcWEBA0j3Bb+4mbrqiJ1BbhtRwt4Zh1WEurgthej6aRFuHPVJ7tqImp8hx3bfVhXh0Q5TOAIMNbyCFUlNPCiEGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":647,"cache_read_input_tokens":83625,"cache_creation":{"ephemeral_5m_input_tokens":647,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd8o6D9rQXhEKaR14E3v","type":"assistant","uuid":"0437a07a-d044-4a5e-812b-1a76e2c492e3","timestamp":"2025-12-30T15:48:57.333Z"}
{"parentUuid":"0437a07a-d044-4a5e-812b-1a76e2c492e3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GdJfutHuQYd447nRiCMMqk","type":"message","role":"assistant","content":[{"type":"text","text":"Now I need to add the router hook and a useEffect to handle the query parameter:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":647,"cache_read_input_tokens":83625,"cache_creation":{"ephemeral_5m_input_tokens":647,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd8o6D9rQXhEKaR14E3v","type":"assistant","uuid":"b083fa11-b7ca-492e-8c22-099b6aec1365","timestamp":"2025-12-30T15:48:57.850Z"}
{"parentUuid":"b083fa11-b7ca-492e-8c22-099b6aec1365","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GdJfutHuQYd447nRiCMMqk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FV9o95FV8W1uXm52hE9yKG","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","old_string":"export default function SalesPrep() {\n  const [vehicles, setVehicles] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedVehicle, setSelectedVehicle] = useState(null);","new_string":"export default function SalesPrep() {\n  const router = useRouter();\n  const [vehicles, setVehicles] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedVehicle, setSelectedVehicle] = useState(null);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":647,"cache_read_input_tokens":83625,"cache_creation":{"ephemeral_5m_input_tokens":647,"ephemeral_1h_input_tokens":0},"output_tokens":301,"service_tier":"standard"}},"requestId":"req_011CWd8o6D9rQXhEKaR14E3v","type":"assistant","uuid":"b89cd907-e3da-4645-acb1-c722649ce1d3","timestamp":"2025-12-30T15:49:00.385Z"}
{"parentUuid":"b89cd907-e3da-4645-acb1-c722649ce1d3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FV9o95FV8W1uXm52hE9yKG","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    50→    : 0;\n    51→  return { days: daysInStock, label: `${daysInStock}d in stock`, isSold: false };\n    52→};\n    53→\n    54→export default function SalesPrep() {\n    55→  const router = useRouter();\n    56→  const [vehicles, setVehicles] = useState([]);\n    57→  const [isLoading, setIsLoading] = useState(true);\n    58→  const [selectedVehicle, setSelectedVehicle] = useState(null);\n    59→  const [isLookingUpDrawer, setIsLookingUpDrawer] = useState(false);\n    60→  const [showAddModal, setShowAddModal] = useState(false);\n    61→  const [draggedCard, setDraggedCard] = useState(null);\n    62→  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });"}]},"uuid":"a237fb77-2e07-4da1-9734-1853088b9682","timestamp":"2025-12-30T15:49:01.582Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","oldString":"export default function SalesPrep() {\n  const [vehicles, setVehicles] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedVehicle, setSelectedVehicle] = useState(null);","newString":"export default function SalesPrep() {\n  const router = useRouter();\n  const [vehicles, setVehicles] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedVehicle, setSelectedVehicle] = useState(null);","originalFile":"import { useEffect, useState, useRef, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport { toast } from \"react-hot-toast\";\nimport { showDummyNotification } from \"@/utils/notifications\";\nimport { BottomSheet } from \"@/components/ui/BottomSheet\";\nimport { Portal } from \"@/components/ui/Portal\";\nimport { MobileStageSelector } from \"@/components/ui/PageShell\";\n\nconst COLUMNS = [\n  { key: \"in_stock\", label: \"In Stock\", gradient: \"from-orange-100/60\", accent: \"border-l-orange-400\", accentBg: \"bg-orange-400\" },\n  { key: \"in_prep\", label: \"Advertised\", gradient: \"from-blue-100/60\", accent: \"border-l-blue-400\", accentBg: \"bg-blue-400\" },\n  { key: \"live\", label: \"Sold In Progress\", gradient: \"from-cyan-100/60\", accent: \"border-l-cyan-400\", accentBg: \"bg-cyan-400\" },\n  { key: \"reserved\", label: \"Completed\", gradient: \"from-emerald-100/60\", accent: \"border-l-emerald-400\", accentBg: \"bg-emerald-400\" },\n  { key: \"delivered\", label: \"Delivered\", gradient: \"from-teal-100/60\", accent: \"border-l-teal-400\", accentBg: \"bg-teal-400\" },\n];\n\nconst ISSUE_SUBCATEGORIES = {\n  mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n  electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n  bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n  interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n  tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n  mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n  service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n  fault_codes: [\"Engine\", \"Transmission\", \"ABS\", \"Airbag\", \"Emissions\", \"Other\"],\n  other: [\"General\", \"Misc\"],\n};\n\n// Sold statuses - these show \"Sold X days\" instead of \"In stock X days\"\nconst SOLD_STATUSES = [\"live\", \"reserved\", \"delivered\"];\n\n// Helper to compute duration label based on status\nconst getVehicleDuration = (vehicle) => {\n  const isSold = SOLD_STATUSES.includes(vehicle.status);\n\n  if (isSold) {\n    if (vehicle.soldAt) {\n      const daysSold = Math.floor((Date.now() - new Date(vehicle.soldAt).getTime()) / (1000 * 60 * 60 * 24));\n      return { days: daysSold, label: `Sold ${daysSold}d`, isSold: true };\n    }\n    // Legacy sold vehicle without soldAt - just show \"Sold\"\n    return { days: 0, label: \"Sold\", isSold: true };\n  }\n\n  const daysInStock = vehicle.createdAt\n    ? Math.floor((Date.now() - new Date(vehicle.createdAt).getTime()) / (1000 * 60 * 60 * 24))\n    : 0;\n  return { days: daysInStock, label: `${daysInStock}d in stock`, isSold: false };\n};\n\nexport default function SalesPrep() {\n  const [vehicles, setVehicles] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedVehicle, setSelectedVehicle] = useState(null);\n  const [isLookingUpDrawer, setIsLookingUpDrawer] = useState(false);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [draggedCard, setDraggedCard] = useState(null);\n  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });\n  const [newTaskName, setNewTaskName] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [editingTaskId, setEditingTaskId] = useState(null);\n  const [editingTaskName, setEditingTaskName] = useState(\"\");\n\n  // Parts ordering state\n  const [showPartsOrderModal, setShowPartsOrderModal] = useState(false);\n  const [partsOrderTaskId, setPartsOrderTaskId] = useState(null);\n  const [partsOrderForm, setPartsOrderForm] = useState({\n    supplierType: \"EURO_CAR_PARTS\",\n    supplierName: \"\",\n    orderRef: \"\",\n    expectedAt: \"\",\n    notes: \"\",\n  });\n  const [editingPartsOrderId, setEditingPartsOrderId] = useState(null);\n\n  // Column sorting state\n  const [columnSortOptions, setColumnSortOptions] = useState({});\n\n  // Job sheet share state\n  const [showJobSheetModal, setShowJobSheetModal] = useState(false);\n  const [jobSheetLink, setJobSheetLink] = useState(null);\n  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);\n\n  // Prep summary share state\n  const [showPrepSummaryModal, setShowPrepSummaryModal] = useState(false);\n  const [prepSummaryLink, setPrepSummaryLink] = useState(null);\n  const [isGeneratingPrepSummary, setIsGeneratingPrepSummary] = useState(false);\n\n  // Manual share fallback modal\n  const [showManualShareModal, setShowManualShareModal] = useState(false);\n  const [manualShareUrl, setManualShareUrl] = useState(\"\");\n\n  // Issues state\n  const [showAddIssueModal, setShowAddIssueModal] = useState(false);\n  const [editingIssue, setEditingIssue] = useState(null); // For edit mode\n  const [issueForm, setIssueForm] = useState({\n    category: \"\",\n    subcategory: \"\",\n    description: \"\",\n    actionNeeded: \"\",\n    priority: \"medium\",\n    location: \"\",\n    status: \"outstanding\",\n    notes: \"\",\n    photos: [],\n    partsRequired: false,\n    partsDetails: \"\",\n  });\n  const [issueUpdateContent, setIssueUpdateContent] = useState({});\n  const [expandedIssues, setExpandedIssues] = useState({});\n\n  // Filters state - with localStorage persistence\n  const [activeFilters, setActiveFilters] = useState([]);\n  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);\n  const filterButtonRef = useRef(null);\n  const [filterPopoverPos, setFilterPopoverPos] = useState({ top: 0, right: 0 });\n\n  // Calculate popover position when opening\n  const openFiltersDropdown = useCallback(() => {\n    if (filterButtonRef.current) {\n      const rect = filterButtonRef.current.getBoundingClientRect();\n      const viewportHeight = window.innerHeight;\n      const viewportWidth = window.innerWidth;\n\n      // Position below the button, aligned to right edge\n      let top = rect.bottom + 8;\n      let right = viewportWidth - rect.right;\n\n      // Ensure popover doesn't go below viewport (max 70vh height + 16px padding)\n      const popoverHeight = Math.min(viewportHeight * 0.7, 600);\n      if (top + popoverHeight > viewportHeight - 16) {\n        top = Math.max(16, viewportHeight - popoverHeight - 16);\n      }\n\n      // Ensure popover doesn't go off right edge\n      right = Math.max(16, right);\n\n      setFilterPopoverPos({ top, right });\n    }\n    setShowFiltersDropdown(true);\n  }, []);\n\n  // Load filters from localStorage on mount\n  useEffect(() => {\n    try {\n      const savedFilters = localStorage.getItem(\"salesPrepFilters\");\n      if (savedFilters) {\n        setActiveFilters(JSON.parse(savedFilters));\n      }\n    } catch (e) {\n      console.warn(\"Failed to load saved filters:\", e);\n    }\n  }, []);\n\n  // Save filters to localStorage when they change\n  useEffect(() => {\n    try {\n      localStorage.setItem(\"salesPrepFilters\", JSON.stringify(activeFilters));\n    } catch (e) {\n      console.warn(\"Failed to save filters:\", e);\n    }\n  }, [activeFilters]);\n\n  // Documents state\n  const [showAddDocumentModal, setShowAddDocumentModal] = useState(false);\n  const [documentForm, setDocumentForm] = useState({\n    name: \"\",\n    type: \"other\",\n    file: null,\n  });\n\n  // Location state\n  const [locations, setLocations] = useState([]);\n  const [showAddLocationModal, setShowAddLocationModal] = useState(false);\n\n  // Vehicle Labels state\n  const [availableLabels, setAvailableLabels] = useState([]);\n  const [showLabelsDropdown, setShowLabelsDropdown] = useState(false);\n  const [showAddLabelModal, setShowAddLabelModal] = useState(false);\n  const [newLabelForm, setNewLabelForm] = useState({ name: \"\", colour: \"#6366f1\" });\n\n  // Activity log state\n  const [activityData, setActivityData] = useState({ activities: [], total: 0, hasMore: false });\n  const [activityLoading, setActivityLoading] = useState(false);\n\n  // VRM Search state\n  const [vrmSearch, setVrmSearch] = useState(\"\");\n  const [showVrmDropdown, setShowVrmDropdown] = useState(false);\n\n  // Mobile state\n  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"in_stock\");\n\n  useEffect(() => {\n    fetchVehicles();\n    fetchLocations();\n    fetchLabels();\n  }, []);\n\n  const fetchVehicles = async () => {\n    try {\n      const res = await fetch(\"/api/vehicles\");\n      if (!res.ok) {\n        throw new Error(`API error: ${res.status}`);\n      }\n      const data = await res.json();\n      setVehicles(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"Failed to load vehicles:\", error);\n      toast.error(\"Failed to load vehicles\");\n      setVehicles([]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const fetchLocations = async () => {\n    try {\n      const res = await fetch(\"/api/locations\");\n      const data = await res.json();\n      setLocations(data);\n    } catch (error) {\n      console.error(\"Failed to load locations:\", error);\n    }\n  };\n\n  const fetchLabels = async () => {\n    try {\n      const res = await fetch(\"/api/labels\");\n      const data = await res.json();\n      setAvailableLabels(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"Failed to load labels:\", error);\n    }\n  };\n\n  // Fetch vehicle activity log\n  const fetchActivity = async (vehicleId, loadMore = false) => {\n    if (!vehicleId) return;\n    setActivityLoading(true);\n    try {\n      const offset = loadMore ? activityData.activities.length : 0;\n      const res = await fetch(`/api/vehicles/${vehicleId}/activity?limit=25&offset=${offset}`);\n      const data = await res.json();\n      if (loadMore) {\n        setActivityData(prev => ({\n          activities: [...prev.activities, ...data.activities],\n          total: data.total,\n          hasMore: data.hasMore,\n        }));\n      } else {\n        setActivityData(data);\n      }\n    } catch (error) {\n      console.error(\"Failed to load activity:\", error);\n    } finally {\n      setActivityLoading(false);\n    }\n  };\n\n  // Format relative time for activity log\n  const formatRelativeTime = (dateStr) => {\n    const date = new Date(dateStr);\n    const now = new Date();\n    const diffMs = now - date;\n    const diffMins = Math.floor(diffMs / 60000);\n    const diffHours = Math.floor(diffMs / 3600000);\n    const diffDays = Math.floor(diffMs / 86400000);\n\n    if (diffMins < 1) return \"just now\";\n    if (diffMins < 60) return `${diffMins}m ago`;\n    if (diffHours < 24) return `${diffHours}h ago`;\n    if (diffDays < 7) return `${diffDays}d ago`;\n    return date.toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\" });\n  };\n\n  // Toggle a label on/off for a vehicle\n  const toggleVehicleLabel = async (vehicleId, labelId) => {\n    try {\n      const res = await fetch(`/api/vehicles/${vehicleId}/labels/${labelId}`, {\n        method: \"POST\",\n      });\n      if (res.ok) {\n        const updatedData = await res.json();\n        // Update selected vehicle if it's the same one\n        if (selectedVehicle?.id === vehicleId) {\n          setSelectedVehicle(prev => ({\n            ...prev,\n            labels: updatedData.labels || [],\n          }));\n        }\n        fetchVehicles();\n      }\n    } catch (error) {\n      toast.error(\"Failed to update label\");\n    }\n  };\n\n  // Create a new label\n  const createLabel = async () => {\n    if (!newLabelForm.name.trim()) {\n      toast.error(\"Label name is required\");\n      return;\n    }\n    try {\n      const res = await fetch(\"/api/labels\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(newLabelForm),\n      });\n      if (res.ok) {\n        const newLabel = await res.json();\n        setAvailableLabels(prev => [...prev, newLabel]);\n        setNewLabelForm({ name: \"\", colour: \"#6366f1\" });\n        setShowAddLabelModal(false);\n        toast.success(\"Label created\");\n      }\n    } catch (error) {\n      toast.error(\"Failed to create label\");\n    }\n  };\n\n  // Open vehicle drawer - vehicle from grid already has tasks, issues, documents\n  const openVehicleDrawer = (vehicle) => {\n    setSelectedVehicle({ ...vehicle, id: vehicle.id || vehicle._id });\n    setActiveTab(\"overview\");\n    setShowLabelsDropdown(false); // Close labels dropdown when opening new vehicle\n    setActivityData({ activities: [], total: 0, hasMore: false }); // Reset activity when opening new vehicle\n  };\n\n  const updateVehicleStatus = async (vehicleId, newStatus) => {\n    try {\n      await fetch(`/api/vehicles/${vehicleId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      });\n      fetchVehicles();\n      toast.success(`Moved to ${newStatus.replace(\"_\", \" \")}`);\n    } catch (error) {\n      toast.error(\"Failed to update\");\n    }\n  };\n\n  // DVLA lookup for existing vehicle in drawer\n  const lookupVehicleDVLA = async () => {\n    if (!selectedVehicle?.regCurrent) {\n      toast.error(\"No registration to lookup\");\n      return;\n    }\n    setIsLookingUpDrawer(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: selectedVehicle.regCurrent }),\n      });\n      const data = await res.json();\n\n      if (!res.ok || data.error) {\n        toast.error(data.message || data.error || \"Vehicle not found\");\n        return;\n      }\n\n      if (data.isDummy) showDummyNotification(\"DVLA API\");\n\n      // Update the vehicle with DVLA data\n      const updatePayload = {\n        make: data.make || selectedVehicle.make,\n        model: data.model || selectedVehicle.model,\n        year: data.yearOfManufacture || data.year || selectedVehicle.year,\n        colour: data.colour || selectedVehicle.colour,\n        fuelType: data.fuelType || selectedVehicle.fuelType,\n        transmission: data.transmission || selectedVehicle.transmission,\n        motExpiryDate: data.motExpiryDate || selectedVehicle.motExpiryDate,\n        dvlaDetails: data.dvlaDetails || null,\n        lastDvlaFetchAt: data.lastDvlaFetchAt || new Date().toISOString(),\n      };\n\n      await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updatePayload),\n      });\n\n      // Refresh vehicle data\n      const updatedRes = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const updatedVehicle = await updatedRes.json();\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n\n      toast.success(`Updated: ${data.make} ${data.model || \"\"} (${data.yearOfManufacture || \"\"})`);\n    } catch (error) {\n      toast.error(\"Lookup failed - please try again\");\n    } finally {\n      setIsLookingUpDrawer(false);\n    }\n  };\n\n  const updateTaskStatus = async (taskId, newStatus) => {\n    try {\n      const payload = { status: newStatus };\n      if (newStatus === \"done\") {\n        payload.completedAt = new Date().toISOString();\n      }\n      // Clear progress when changing status (optional: keep if staying in_progress)\n      if (newStatus !== \"in_progress\") {\n        payload.progress = \"NONE\";\n        payload.progressNote = \"\";\n      }\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n    } catch (error) {\n      toast.error(\"Failed to update task\");\n    }\n  };\n\n  // Update task progress sub-status (for parts ordering, booking, etc.)\n  const updateTaskProgress = async (taskId, progress, progressNote = null) => {\n    try {\n      const payload = { progress };\n      if (progressNote !== null) {\n        payload.progressNote = progressNote;\n      }\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n    } catch (error) {\n      toast.error(\"Failed to update task progress\");\n    }\n  };\n\n  // Parts order management functions\n  const openPartsOrderModal = (taskId, existingOrder = null) => {\n    setPartsOrderTaskId(taskId);\n    if (existingOrder) {\n      setEditingPartsOrderId(existingOrder._id || existingOrder.id);\n      setPartsOrderForm({\n        supplierType: existingOrder.supplierType || \"EURO_CAR_PARTS\",\n        supplierName: existingOrder.supplierName || \"\",\n        orderRef: existingOrder.orderRef || \"\",\n        expectedAt: existingOrder.expectedAt ? existingOrder.expectedAt.split(\"T\")[0] : \"\",\n        notes: existingOrder.notes || \"\",\n      });\n    } else {\n      setEditingPartsOrderId(null);\n      setPartsOrderForm({\n        supplierType: \"EURO_CAR_PARTS\",\n        supplierName: \"\",\n        orderRef: \"\",\n        expectedAt: \"\",\n        notes: \"\",\n      });\n    }\n    setShowPartsOrderModal(true);\n  };\n\n  const closePartsOrderModal = () => {\n    setShowPartsOrderModal(false);\n    setPartsOrderTaskId(null);\n    setEditingPartsOrderId(null);\n    setPartsOrderForm({\n      supplierType: \"EURO_CAR_PARTS\",\n      supplierName: \"\",\n      orderRef: \"\",\n      expectedAt: \"\",\n      notes: \"\",\n    });\n  };\n\n  const addPartsOrder = async () => {\n    if (!partsOrderTaskId) return;\n    try {\n      const orderData = {\n        supplierType: partsOrderForm.supplierType,\n        ...(partsOrderForm.supplierType === \"OTHER\" && partsOrderForm.supplierName && { supplierName: partsOrderForm.supplierName }),\n        ...(partsOrderForm.orderRef && { orderRef: partsOrderForm.orderRef }),\n        ...(partsOrderForm.expectedAt && { expectedAt: partsOrderForm.expectedAt }),\n        ...(partsOrderForm.notes && { notes: partsOrderForm.notes }),\n      };\n\n      await fetch(`/api/tasks/${partsOrderTaskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ addPartsOrder: orderData }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      closePartsOrderModal();\n      toast.success(\"Parts order added\");\n    } catch (error) {\n      toast.error(\"Failed to add parts order\");\n    }\n  };\n\n  const updatePartsOrder = async () => {\n    if (!partsOrderTaskId || !editingPartsOrderId) return;\n    try {\n      const orderData = {\n        orderId: editingPartsOrderId,\n        supplierType: partsOrderForm.supplierType,\n        supplierName: partsOrderForm.supplierType === \"OTHER\" ? partsOrderForm.supplierName : null,\n        orderRef: partsOrderForm.orderRef || null,\n        expectedAt: partsOrderForm.expectedAt || null,\n        notes: partsOrderForm.notes || null,\n      };\n\n      await fetch(`/api/tasks/${partsOrderTaskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ updatePartsOrder: orderData }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      closePartsOrderModal();\n      toast.success(\"Parts order updated\");\n    } catch (error) {\n      toast.error(\"Failed to update parts order\");\n    }\n  };\n\n  const removePartsOrder = async (taskId, orderId) => {\n    if (!confirm(\"Remove this parts order?\")) return;\n    try {\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ removePartsOrderId: orderId }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      toast.success(\"Parts order removed\");\n    } catch (error) {\n      toast.error(\"Failed to remove parts order\");\n    }\n  };\n\n  const markPartsReceived = async (taskId, orderId) => {\n    try {\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          updatePartsOrder: {\n            orderId,\n            status: \"RECEIVED\",\n            receivedAt: new Date().toISOString(),\n          },\n        }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      toast.success(\"Parts marked as received\");\n    } catch (error) {\n      toast.error(\"Failed to update parts order\");\n    }\n  };\n\n  // Helper to get supplier display name\n  const getSupplierDisplay = (order) => {\n    const labels = {\n      EURO_CAR_PARTS: \"Euro Car Parts\",\n      TPS: \"TPS\",\n      MAIN_DEALER: \"Main Dealer\",\n      LOCAL_FACTOR: \"Local Factor\",\n      ONLINE: \"Online\",\n      OTHER: order.supplierName || \"Other\",\n    };\n    return labels[order.supplierType] || order.supplierType;\n  };\n\n  const updateTaskName = async (taskId, newName) => {\n    if (!newName.trim()) {\n      toast.error(\"Task name cannot be empty\");\n      return;\n    }\n    try {\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: newName }),\n      });\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      setEditingTaskId(null);\n      setEditingTaskName(\"\");\n      toast.success(\"Task updated\");\n    } catch (error) {\n      toast.error(\"Failed to update task\");\n    }\n  };\n\n  const addTask = async () => {\n    if (!newTaskName.trim()) return toast.error(\"Task name is required\");\n    try {\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/tasks`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: newTaskName }),\n      });\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.error || \"Failed to add task\");\n      }\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      setNewTaskName(\"\");\n      fetchVehicles();\n      toast.success(\"Task added\");\n    } catch (error) {\n      console.error(\"Add task error:\", error);\n      toast.error(error.message || \"Failed to add task\");\n    }\n  };\n\n  const deleteTask = async (taskId) => {\n    try {\n      await fetch(`/api/tasks/${taskId}`, { method: \"DELETE\" });\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Task removed\");\n    } catch (error) {\n      toast.error(\"Failed to delete task\");\n    }\n  };\n\n  // Issue functions\n  const addIssue = async (photoUrls = []) => {\n    if (!issueForm.category || !issueForm.subcategory || !issueForm.description) {\n      return toast.error(\"Category, subcategory, and description are required\");\n    }\n    try {\n      const issueData = {\n        ...issueForm,\n        photos: [...(issueForm.photos || []), ...photoUrls],\n      };\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/issues`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(issueData),\n      });\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.error || \"Failed to add issue\");\n      }\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      setShowAddIssueModal(false);\n      setIssueForm({\n        category: \"\",\n        subcategory: \"\",\n        description: \"\",\n        actionNeeded: \"\",\n        status: \"outstanding\",\n        notes: \"\",\n        photos: [],\n      });\n      toast.success(\"Issue added\");\n    } catch (error) {\n      console.error(\"Add issue error:\", error);\n      toast.error(error.message || \"Failed to add issue\");\n    }\n  };\n\n  const updateIssue = async (issueId, updates) => {\n    try {\n      const res = await fetch(`/api/issues/${issueId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) throw new Error(\"Failed to update issue\");\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Issue updated\");\n    } catch (error) {\n      toast.error(\"Failed to update issue\");\n    }\n  };\n\n  // Open edit issue modal with prefilled data\n  const openEditIssue = (issue) => {\n    setEditingIssue(issue);\n    setIssueForm({\n      category: issue.category?.toLowerCase() || \"\",\n      subcategory: issue.subcategory || \"\",\n      description: issue.description || \"\",\n      actionNeeded: issue.actionNeeded || \"\",\n      priority: issue.priority || \"medium\",\n      location: issue.location || \"\",\n      status: issue.status?.toLowerCase().replace(\" \", \"_\") || \"outstanding\",\n      notes: issue.notes || \"\",\n      photos: issue.photos || [],\n      partsRequired: issue.partsRequired || false,\n      partsDetails: issue.partsDetails || \"\",\n    });\n    setShowAddIssueModal(true);\n  };\n\n  // Save edited issue\n  const saveEditedIssue = async (photoUrls = []) => {\n    if (!editingIssue) return;\n    try {\n      const updates = {\n        ...issueForm,\n        photos: [...(issueForm.photos || []), ...photoUrls],\n      };\n      await updateIssue(editingIssue.id, updates);\n      setShowAddIssueModal(false);\n      setEditingIssue(null);\n      setIssueForm({\n        category: \"\",\n        subcategory: \"\",\n        description: \"\",\n        actionNeeded: \"\",\n        priority: \"medium\",\n        location: \"\",\n        status: \"outstanding\",\n        notes: \"\",\n        photos: [],\n        partsRequired: false,\n        partsDetails: \"\",\n      });\n    } catch (error) {\n      toast.error(\"Failed to save issue\");\n    }\n  };\n\n  const deleteIssue = async (issueId) => {\n    try {\n      await fetch(`/api/issues/${issueId}`, { method: \"DELETE\" });\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Issue removed\");\n    } catch (error) {\n      toast.error(\"Failed to delete issue\");\n    }\n  };\n\n  const addIssueUpdate = async (issueId, content) => {\n    if (!content?.trim()) {\n      return toast.error(\"Update content cannot be empty\");\n    }\n\n    try {\n      await fetch(`/api/issues/${issueId}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          content: content.trim(),\n          userName: \"Current User\" // TODO: Replace with actual user name from auth\n        }),\n      });\n\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      setIssueUpdateContent(prev => ({ ...prev, [issueId]: \"\" }));\n      toast.success(\"Update added\");\n    } catch (error) {\n      toast.error(\"Failed to add update\");\n    }\n  };\n\n  // Document functions\n  const uploadDocument = async (file, name, type) => {\n    if (!file) return;\n\n    try {\n      // First upload the file\n      const uploadFormData = new FormData();\n      uploadFormData.append(\"file\", file);\n\n      const uploadRes = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: uploadFormData,\n      });\n      if (!uploadRes.ok) throw new Error(\"File upload failed\");\n      const uploadData = await uploadRes.json();\n\n      // Then create the document record with the URL\n      const docRes = await fetch(`/api/vehicles/${selectedVehicle.id}/documents`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name, type, url: uploadData.url }),\n      });\n      if (!docRes.ok) throw new Error(\"Document creation failed\");\n\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      setShowAddDocumentModal(false);\n      setDocumentForm({ name: \"\", type: \"other\", file: null });\n      toast.success(\"Document uploaded\");\n    } catch (error) {\n      console.error(\"Upload error:\", error);\n      toast.error(\"Failed to upload document\");\n    }\n  };\n\n  const deleteDocument = async (documentId) => {\n    try {\n      await fetch(`/api/documents/${documentId}`, { method: \"DELETE\" });\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Document removed\");\n    } catch (error) {\n      toast.error(\"Failed to delete document\");\n    }\n  };\n\n  const handleDragStart = (e, vehicle) => {\n    setDraggedCard(vehicle);\n    setDragPosition({ x: e.clientX, y: e.clientY });\n    e.dataTransfer.effectAllowed = \"move\";\n    // Create invisible drag image (we'll render our own preview)\n    const emptyImg = new Image();\n    emptyImg.src = \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\";\n    e.dataTransfer.setDragImage(emptyImg, 0, 0);\n  };\n\n  const handleDrag = (e) => {\n    if (e.clientX !== 0 && e.clientY !== 0) {\n      setDragPosition({ x: e.clientX, y: e.clientY });\n    }\n  };\n\n  const handleDragOver = (e) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDragEnd = () => {\n    setDraggedCard(null);\n  };\n\n  const handleDrop = async (e, newStatus) => {\n    e.preventDefault();\n    if (!draggedCard || draggedCard.status === newStatus) {\n      setDraggedCard(null);\n      return;\n    }\n    const vehicleId = draggedCard.id || draggedCard._id;\n    await updateVehicleStatus(vehicleId, newStatus);\n    setDraggedCard(null);\n  };\n\n  const uploadV5 = async (file) => {\n    if (!file) return;\n\n    try {\n      // First upload the file\n      const formData = new FormData();\n      formData.append(\"file\", file);\n\n      const uploadRes = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: formData,\n      });\n      if (!uploadRes.ok) throw new Error(\"Upload failed\");\n      const uploadData = await uploadRes.json();\n\n      // Then update the vehicle with the V5 URL\n      await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ v5Url: uploadData.url }),\n      });\n\n      const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updated);\n      fetchVehicles();\n      toast.success(\"V5 uploaded\");\n    } catch (error) {\n      console.error(\"V5 upload error:\", error);\n      toast.error(\"Failed to upload V5\");\n    }\n  };\n\n  const formatDate = (date) => {\n    if (!date) return \"—\";\n    return new Date(date).toLocaleDateString(\"en-GB\", { day: \"2-digit\", month: \"short\", year: \"numeric\" });\n  };\n\n  const toggleFilter = (filter) => {\n    setActiveFilters(prev =>\n      prev.includes(filter)\n        ? prev.filter(f => f !== filter)\n        : [...prev, filter]\n    );\n  };\n\n  const getFilteredVehicles = (vehicleList) => {\n    if (activeFilters.length === 0) return vehicleList;\n\n    return vehicleList.filter(vehicle => {\n      return activeFilters.every(filter => {\n        const tasks = vehicle.tasks || [];\n        const issues = vehicle.issues || [];\n        const activeIssues = issues.filter(i => {\n          const status = (i.status || \"\").toLowerCase();\n          return [\"outstanding\", \"ordered\", \"in progress\", \"in_progress\"].includes(status);\n        });\n\n        // Prep task filters\n        if (filter === \"awaiting_pdi\") return !tasks.find(t => t.name.toLowerCase().includes(\"pdi\") && t.status === \"done\");\n        if (filter === \"awaiting_valet\") return !tasks.find(t => t.name.toLowerCase().includes(\"valet\") && t.status === \"done\");\n        if (filter === \"awaiting_photos\") return !tasks.find(t => t.name.toLowerCase().includes(\"photo\") && t.status === \"done\");\n        if (filter === \"awaiting_mot\") return !tasks.find(t => t.name.toLowerCase().includes(\"mot\") && t.status === \"done\");\n\n        // Issue filters\n        if (filter === \"needs_paint\") return activeIssues.some(i => {\n          const cat = (i.category || \"\").toLowerCase();\n          return cat === \"bodywork\" || cat === \"cosmetic\";\n        });\n        if (filter === \"needs_mechanical\") return activeIssues.some(i => {\n          const cat = (i.category || \"\").toLowerCase();\n          return cat === \"mechanical\";\n        });\n        if (filter === \"needs_electrical\") return activeIssues.some(i => {\n          const cat = (i.category || \"\").toLowerCase();\n          return cat === \"electrical\";\n        });\n\n        // Location filter\n        if (filter === \"offsite\") return vehicle.locationId != null;\n\n        // MOT filters\n        if (filter === \"mot_due_soon\") {\n          if (!vehicle.motExpiryDate) return false;\n          const expiry = new Date(vehicle.motExpiryDate);\n          const now = new Date();\n          const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));\n          return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;\n        }\n        if (filter === \"mot_expired\") {\n          if (!vehicle.motExpiryDate) return false;\n          const expiry = new Date(vehicle.motExpiryDate);\n          const now = new Date();\n          return expiry < now;\n        }\n\n        // Sale type filters\n        if (filter === \"trade_only\") return vehicle.saleType === \"TRADE\";\n        if (filter === \"retail_only\") return vehicle.saleType === \"RETAIL\" || !vehicle.saleType;\n\n        // Vehicle type filters\n        if (filter === \"type_stock\") return vehicle.type === \"STOCK\" || !vehicle.type;\n        if (filter === \"type_courtesy\") return vehicle.type === \"COURTESY\";\n        if (filter === \"type_fleet\") return vehicle.type === \"FLEET_OTHER\";\n\n        return true;\n      });\n    });\n  };\n\n  const getVehiclesByStatus = (status) => {\n    const statusVehicles = vehicles.filter(v => v.status === status);\n    const filtered = getFilteredVehicles(statusVehicles);\n\n    // Apply sorting based on columnSortOptions\n    const sortOption = columnSortOptions[status] || \"oldest_first\";\n\n    return [...filtered].sort((a, b) => {\n      const daysA = a.createdAt ? Math.floor((new Date() - new Date(a.createdAt)) / (1000 * 60 * 60 * 24)) : 0;\n      const daysB = b.createdAt ? Math.floor((new Date() - new Date(b.createdAt)) / (1000 * 60 * 60 * 24)) : 0;\n\n      switch (sortOption) {\n        case \"oldest_first\":\n          return daysB - daysA; // More days = older = first\n        case \"newest_first\":\n          return daysA - daysB; // Fewer days = newer = first\n        case \"alphabetical\":\n          const nameA = `${a.make || \"\"} ${a.model || \"\"}`.toLowerCase();\n          const nameB = `${b.make || \"\"} ${b.model || \"\"}`.toLowerCase();\n          return nameA.localeCompare(nameB);\n        default:\n          return daysB - daysA;\n      }\n    });\n  };\n\n  const getFilterCount = (filter) => {\n    const allFiltered = getFilteredVehicles(vehicles.filter(v => {\n      const tasks = v.tasks || [];\n      const issues = v.issues || [];\n      const activeIssues = issues.filter(i => {\n        const status = (i.status || \"\").toLowerCase();\n        return [\"outstanding\", \"ordered\", \"in progress\", \"in_progress\"].includes(status);\n      });\n\n      if (filter === \"awaiting_pdi\") return !tasks.find(t => t.name.toLowerCase().includes(\"pdi\") && t.status === \"done\");\n      if (filter === \"awaiting_valet\") return !tasks.find(t => t.name.toLowerCase().includes(\"valet\") && t.status === \"done\");\n      if (filter === \"awaiting_photos\") return !tasks.find(t => t.name.toLowerCase().includes(\"photo\") && t.status === \"done\");\n      if (filter === \"awaiting_mot\") return !tasks.find(t => t.name.toLowerCase().includes(\"mot\") && t.status === \"done\");\n      if (filter === \"needs_paint\") return activeIssues.some(i => {\n        const cat = (i.category || \"\").toLowerCase();\n        return cat === \"bodywork\" || cat === \"cosmetic\";\n      });\n      if (filter === \"needs_mechanical\") return activeIssues.some(i => {\n        const cat = (i.category || \"\").toLowerCase();\n        return cat === \"mechanical\";\n      });\n      if (filter === \"needs_electrical\") return activeIssues.some(i => {\n        const cat = (i.category || \"\").toLowerCase();\n        return cat === \"electrical\";\n      });\n      if (filter === \"offsite\") return v.locationId != null;\n      if (filter === \"mot_due_soon\") {\n        if (!v.motExpiryDate) return false;\n        const expiry = new Date(v.motExpiryDate);\n        const now = new Date();\n        const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));\n        return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;\n      }\n      if (filter === \"mot_expired\") {\n        if (!v.motExpiryDate) return false;\n        const expiry = new Date(v.motExpiryDate);\n        return expiry < new Date();\n      }\n      if (filter === \"trade_only\") return v.saleType === \"TRADE\";\n      if (filter === \"retail_only\") return v.saleType === \"RETAIL\" || !v.saleType;\n      if (filter === \"type_stock\") return v.type === \"STOCK\" || !v.type;\n      if (filter === \"type_courtesy\") return v.type === \"COURTESY\";\n      if (filter === \"type_fleet\") return v.type === \"FLEET_OTHER\";\n      return false;\n    }));\n    return allFiltered.length;\n  };\n\n  // VRM Search functions\n  const getVrmSearchResults = () => {\n    if (vrmSearch.length < 2) return [];\n    const searchTerm = vrmSearch.toUpperCase().replace(/\\s/g, \"\");\n    return vehicles.filter(v => {\n      const reg = (v.regCurrent || \"\").toUpperCase().replace(/\\s/g, \"\");\n      return reg.includes(searchTerm);\n    }).slice(0, 8); // Limit to 8 results\n  };\n\n  const handleVrmSelect = (vehicle) => {\n    // Close dropdown and clear search\n    setVrmSearch(\"\");\n    setShowVrmDropdown(false);\n\n    // Find which column this vehicle is in and scroll to it\n    const columnIndex = COLUMNS.findIndex(col => col.key === vehicle.status);\n    if (columnIndex >= 0) {\n      // Scroll the column into view\n      const columnElements = document.querySelectorAll('[data-column-key]');\n      if (columnElements[columnIndex]) {\n        columnElements[columnIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });\n      }\n    }\n\n    // Open the vehicle drawer with full details\n    openVehicleDrawer(vehicle);\n  };\n\n  const getStatusLabel = (statusKey) => {\n    const col = COLUMNS.find(c => c.key === statusKey);\n    return col ? col.label : statusKey;\n  };\n\n  const handlePrintVehicle = () => {\n    if (!selectedVehicle) return;\n\n    const vehicle = selectedVehicle;\n    const tasks = vehicle.tasks || [];\n    const issues = vehicle.issues || [];\n    const documents = vehicle.documents || [];\n    const completedTasks = tasks.filter(t => t.status === \"done\").length;\n    const daysInStock = vehicle.createdAt\n      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))\n      : 0;\n\n    // Get status label from COLUMNS\n    const statusColumn = COLUMNS.find(col => col.key === vehicle.status);\n    const statusLabel = statusColumn ? statusColumn.label : vehicle.status;\n\n    // Generate HTML for print\n    const printContent = `\n<!DOCTYPE html>\n<html>\n<head>\n  <title>${vehicle.year || \"\"} ${vehicle.make} ${vehicle.model} - ${vehicle.regCurrent}</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }\n    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }\n    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }\n    .reg { font-size: 18px; font-family: monospace; color: #64748b; }\n    .section { margin-bottom: 30px; }\n    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }\n    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }\n    .field { margin-bottom: 12px; }\n    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }\n    .field-value { font-size: 14px; color: #1e293b; }\n    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }\n    .badge-status { background: #e0e7ff; color: #4338ca; }\n    .badge-days { background: ${daysInStock > 30 ? '#fef2f2' : '#f1f5f9'}; color: ${daysInStock > 30 ? '#dc2626' : '#475569'}; }\n    .task-list { list-style: none; }\n    .task-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }\n    .task-status { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }\n    .task-done { background: #dcfce7; color: #16a34a; }\n    .task-pending { background: #fef3c7; color: #d97706; }\n    .task-progress { background: #dbeafe; color: #2563eb; }\n    .issue-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }\n    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; }\n    .issue-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; }\n    .issue-desc { font-size: 14px; color: #1e293b; }\n    .doc-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }\n    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }\n    @media print {\n      body { padding: 20px; }\n      .no-print { display: none; }\n    }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <div class=\"title\">${vehicle.year || \"\"} ${vehicle.make} ${vehicle.model}</div>\n    <div class=\"reg\">${vehicle.regCurrent}</div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Overview</div>\n    <div style=\"display: flex; gap: 12px; margin-bottom: 16px;\">\n      <span class=\"badge badge-status\">${statusLabel}</span>\n      <span class=\"badge badge-days\">Days in Stock: ${daysInStock}</span>\n      ${vehicle.locationId ? `<span class=\"badge\" style=\"background:#eef2ff;color:#4f46e5;\">📍 ${vehicle.locationId.name || 'Offsite'}</span>` : '<span class=\"badge\" style=\"background:#f0fdf4;color:#16a34a;\">📍 On Site</span>'}\n    </div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Vehicle Details</div>\n    <div class=\"grid\">\n      <div class=\"field\">\n        <div class=\"field-label\">Registration</div>\n        <div class=\"field-value\">${vehicle.regCurrent || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">VIN</div>\n        <div class=\"field-value\">${vehicle.vin || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Make</div>\n        <div class=\"field-value\">${vehicle.make || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Model</div>\n        <div class=\"field-value\">${vehicle.model || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Year</div>\n        <div class=\"field-value\">${vehicle.year || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Mileage</div>\n        <div class=\"field-value\">${vehicle.mileageCurrent ? vehicle.mileageCurrent.toLocaleString() + ' miles' : '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Colour</div>\n        <div class=\"field-value\">${vehicle.colour || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Fuel Type</div>\n        <div class=\"field-value\">${vehicle.fuelType || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">MOT Expiry</div>\n        <div class=\"field-value\">${vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : '—'}</div>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Prep Checklist (${completedTasks}/${tasks.length} complete)</div>\n    ${tasks.length > 0 ? `\n    <ul class=\"task-list\">\n      ${tasks.map(task => `\n        <li class=\"task-item\">\n          <span class=\"task-status ${task.status === 'done' ? 'task-done' : task.status === 'in_progress' ? 'task-progress' : 'task-pending'}\">\n            ${task.status === 'done' ? '✓' : task.status === 'in_progress' ? '→' : '○'}\n          </span>\n          <span style=\"${task.status === 'done' ? 'text-decoration: line-through; color: #94a3b8;' : ''}\">${task.name}</span>\n          ${task.completedAt ? `<span style=\"font-size: 11px; color: #94a3b8; margin-left: auto;\">${new Date(task.completedAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</span>` : ''}\n        </li>\n      `).join('')}\n    </ul>\n    ` : '<p style=\"color: #94a3b8; font-size: 14px;\">No tasks</p>'}\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Issues (${issues.length})</div>\n    ${issues.length > 0 ? issues.map(issue => `\n      <div class=\"issue-card\">\n        <div class=\"issue-header\">\n          <span class=\"issue-badge\">${issue.category}</span>\n          ${issue.subcategory ? `<span class=\"issue-badge\">${issue.subcategory}</span>` : ''}\n          <span class=\"issue-badge\" style=\"margin-left: auto;\">${issue.status || 'Outstanding'}</span>\n        </div>\n        <div class=\"issue-desc\">${issue.description}</div>\n        ${issue.actionNeeded ? `<div style=\"font-size: 12px; color: #64748b; margin-top: 6px;\">Action: ${issue.actionNeeded}</div>` : ''}\n      </div>\n    `).join('') : '<p style=\"color: #94a3b8; font-size: 14px;\">No issues recorded</p>'}\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Documents (${documents.length})</div>\n    ${documents.length > 0 ? documents.map(doc => `\n      <div class=\"doc-item\">\n        <span style=\"font-weight: 500;\">${doc.name}</span>\n        <span style=\"font-size: 12px; color: #94a3b8; margin-left: 8px;\">(${doc.type.replace(/_/g, ' ')})</span>\n      </div>\n    `).join('') : '<p style=\"color: #94a3b8; font-size: 14px;\">No documents uploaded</p>'}\n    ${vehicle.v5Url ? '<div class=\"doc-item\"><span style=\"font-weight: 500;\">V5 Document</span> <span style=\"font-size: 12px; color: #16a34a;\">✓ Uploaded</span></div>' : ''}\n  </div>\n\n  ${vehicle.notes ? `\n  <div class=\"section\">\n    <div class=\"section-title\">Notes</div>\n    <p style=\"font-size: 14px; white-space: pre-wrap;\">${vehicle.notes}</p>\n  </div>\n  ` : ''}\n\n  <div class=\"footer\">\n    Printed from DealerFlow on ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}\n  </div>\n</body>\n</html>\n    `;\n\n    // Open in new tab\n    const printWindow = window.open('', '_blank');\n    printWindow.document.write(printContent);\n    printWindow.document.close();\n  };\n\n  // Share utility with fallback chain: Web Share API → Clipboard → Manual modal\n  // SSR-safe: only runs client-side, with guards for browser API availability\n  const shareWithFallback = async (url, title, text) => {\n    // Guard against SSR - this should only run client-side\n    if (typeof window === \"undefined\" || typeof navigator === \"undefined\") {\n      return false;\n    }\n\n    // 1. Try Web Share API (native sharing on mobile/supported browsers)\n    if (typeof navigator.share === \"function\") {\n      try {\n        await navigator.share({ title, text, url });\n        return true;\n      } catch (error) {\n        // User cancelled or share failed - continue to fallback\n        if (error.name !== \"AbortError\") {\n          console.log(\"Web Share API failed, trying clipboard fallback\");\n        }\n      }\n    }\n\n    // 2. Try Clipboard API\n    if (navigator.clipboard && typeof navigator.clipboard.writeText === \"function\") {\n      try {\n        await navigator.clipboard.writeText(url);\n        toast.success(\"Link copied to clipboard!\");\n        return true;\n      } catch (error) {\n        console.log(\"Clipboard API failed, showing manual modal\");\n      }\n    }\n\n    // 3. Fallback to manual modal\n    setManualShareUrl(url);\n    setShowManualShareModal(true);\n    return false;\n  };\n\n  // Job sheet share handlers\n  const handleGenerateJobSheet = async () => {\n    if (!selectedVehicle) return;\n    setIsGeneratingJobSheet(true);\n    try {\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/job-sheet`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ expiresInDays: 60 }),\n      });\n      if (!res.ok) throw new Error(\"Failed to generate share link\");\n      const data = await res.json();\n      const fullUrl = `${window.location.origin}${data.shareUrl}`;\n      setJobSheetLink({\n        url: fullUrl,\n        expiresAt: data.expiresAt,\n      });\n      setShowJobSheetModal(true);\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsGeneratingJobSheet(false);\n    }\n  };\n\n  const copyJobSheetLink = async () => {\n    if (jobSheetLink?.url) {\n      await shareWithFallback(\n        jobSheetLink.url,\n        `Job Sheet - ${selectedVehicle?.regCurrent || \"Vehicle\"}`,\n        `Job sheet for ${selectedVehicle?.regCurrent}: ${jobSheetLink.url}`\n      );\n    }\n  };\n\n  const shareViaWhatsApp = () => {\n    if (typeof window === \"undefined\") return;\n    if (jobSheetLink?.url) {\n      const text = `Job sheet for ${selectedVehicle?.regCurrent || \"Vehicle\"}: ${jobSheetLink.url}`;\n      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, \"_blank\");\n    }\n  };\n\n  // Prep summary share handlers\n  const handleGeneratePrepSummary = async () => {\n    if (!selectedVehicle) return;\n    setIsGeneratingPrepSummary(true);\n    try {\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/prep-summary`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ expiresInDays: 60 }),\n      });\n      if (!res.ok) throw new Error(\"Failed to generate share link\");\n      const data = await res.json();\n      const fullUrl = `${window.location.origin}${data.shareUrl}`;\n      setPrepSummaryLink({\n        url: fullUrl,\n        expiresAt: data.expiresAt,\n      });\n      setShowPrepSummaryModal(true);\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsGeneratingPrepSummary(false);\n    }\n  };\n\n  const copyPrepSummaryLink = async () => {\n    if (prepSummaryLink?.url) {\n      await shareWithFallback(\n        prepSummaryLink.url,\n        `Prep Summary - ${selectedVehicle?.regCurrent || \"Vehicle\"}`,\n        `Prep summary for ${selectedVehicle?.regCurrent}: ${prepSummaryLink.url}`\n      );\n    }\n  };\n\n  const sharePrepSummaryViaWhatsApp = () => {\n    if (typeof window === \"undefined\") return;\n    if (prepSummaryLink?.url) {\n      const text = `Prep summary for ${selectedVehicle?.regCurrent || \"Vehicle\"}: ${prepSummaryLink.url}`;\n      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, \"_blank\");\n    }\n  };\n\n  const getMOTStatus = (motExpiryDate) => {\n    if (!motExpiryDate) {\n      return { type: \"unknown\", label: \"Unknown\", days: null, class: \"bg-slate-100 text-slate-500 border border-slate-200\" };\n    }\n    const expiry = new Date(motExpiryDate);\n    const now = new Date();\n    const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));\n\n    if (daysUntilExpiry < 0) {\n      const daysOverdue = Math.abs(daysUntilExpiry);\n      return { type: \"expired\", label: `Expired ${daysOverdue}d`, days: daysOverdue, class: \"bg-red-50 text-red-700 border border-red-200\" };\n    }\n    if (daysUntilExpiry <= 30) {\n      return { type: \"due_soon\", label: `${daysUntilExpiry}d`, days: daysUntilExpiry, class: \"bg-amber-50 text-amber-700 border border-amber-200\" };\n    }\n    return { type: \"valid\", label: `${daysUntilExpiry}d`, days: daysUntilExpiry, class: null };\n  };\n\n  const getActiveIssuesByCategory = (issues = []) => {\n    const activeIssues = issues.filter(i => {\n      const status = (i.status || \"\").toLowerCase();\n      return [\"outstanding\", \"ordered\", \"in_progress\", \"in progress\"].includes(status);\n    });\n    const categoryCounts = {};\n    activeIssues.forEach(issue => {\n      categoryCounts[issue.category] = (categoryCounts[issue.category] || 0) + 1;\n    });\n    return categoryCounts;\n  };\n\n  return (\n    <DashboardLayout>\n      <Head><title>Stock & Prep | DealerFlow</title></Head>\n\n      <div className=\"flex justify-between items-center mb-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Stock & Prep Board</h1>\n          <p className=\"text-base-content/60 mt-1\">Manage vehicle prep and sales pipeline &bull; Drag cards to move between stages</p>\n        </div>\n        <button className=\"btn btn-primary\" onClick={() => setShowAddModal(true)}>\n          + Add Vehicle\n        </button>\n      </div>\n\n      {/* Consolidated Filters */}\n      <div className=\"sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-slate-200 mb-4 -mx-6 px-6 py-4\">\n        <div className=\"flex gap-2 items-center\">\n            {/* VRM Search */}\n            <div className=\"relative\">\n              <div className=\"relative\">\n                <svg className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n                </svg>\n                <input\n                  type=\"text\"\n                  placeholder=\"Search VRM...\"\n                  className=\"input input-sm input-bordered pl-9 pr-8 w-44 font-mono uppercase\"\n                  value={vrmSearch}\n                  onChange={(e) => {\n                    setVrmSearch(e.target.value.toUpperCase());\n                    setShowVrmDropdown(e.target.value.length >= 2);\n                  }}\n                  onFocus={() => vrmSearch.length >= 2 && setShowVrmDropdown(true)}\n                  onKeyDown={(e) => {\n                    if (e.key === \"Escape\") {\n                      setShowVrmDropdown(false);\n                      e.target.blur();\n                    }\n                  }}\n                />\n                {vrmSearch && (\n                  <button\n                    className=\"absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600\"\n                    onClick={() => {\n                      setVrmSearch(\"\");\n                      setShowVrmDropdown(false);\n                    }}\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                    </svg>\n                  </button>\n                )}\n              </div>\n\n              {/* VRM Search Dropdown */}\n              {showVrmDropdown && (\n                <>\n                  <div className=\"fixed inset-0 z-10\" onClick={() => setShowVrmDropdown(false)}></div>\n                  <div className=\"absolute top-full left-0 mt-1 w-72 bg-white rounded-xl shadow-xl border border-slate-200 z-20 overflow-hidden\">\n                    {getVrmSearchResults().length > 0 ? (\n                      <ul className=\"py-1 max-h-64 overflow-y-auto\">\n                        {getVrmSearchResults().map((vehicle) => (\n                          <li key={vehicle.id || vehicle._id}>\n                            <button\n                              className=\"w-full px-4 py-2.5 text-left hover:bg-slate-50 flex items-center justify-between gap-2 transition-colors\"\n                              onClick={() => handleVrmSelect(vehicle)}\n                            >\n                              <div className=\"flex items-center gap-3\">\n                                <span className=\"font-mono font-bold text-slate-900\">{vehicle.regCurrent}</span>\n                                <span className=\"text-sm text-slate-500\">{vehicle.make} {vehicle.model}</span>\n                              </div>\n                              <span className=\"text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600\">\n                                {getStatusLabel(vehicle.status)}\n                              </span>\n                            </button>\n                          </li>\n                        ))}\n                      </ul>\n                    ) : (\n                      <div className=\"px-4 py-6 text-center\">\n                        <svg className=\"w-8 h-8 mx-auto text-slate-300 mb-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                        </svg>\n                        <p className=\"text-sm text-slate-500\">No vehicles found</p>\n                        <p className=\"text-xs text-slate-400 mt-1\">Try a different registration</p>\n                      </div>\n                    )}\n                  </div>\n                </>\n              )}\n            </div>\n\n            <div className=\"divider divider-horizontal mx-1\"></div>\n\n            {/* All Vehicles Button */}\n            <button\n              className={`btn btn-sm ${activeFilters.length === 0 ? \"btn-primary\" : \"btn-outline\"}`}\n              onClick={() => setActiveFilters([])}\n            >\n              All Vehicles ({vehicles.length})\n            </button>\n\n            <div className=\"divider divider-horizontal mx-1\"></div>\n\n            {/* Consolidated Filters - Strictly Separated Desktop/Mobile */}\n            <div className=\"shrink-0\">\n              {/* Trigger Button */}\n              <button\n                ref={filterButtonRef}\n                className={`flex items-center gap-2 px-3 py-2 rounded-lg shrink-0 whitespace-nowrap text-sm font-medium transition-all ${\n                  activeFilters.length > 0\n                    ? \"bg-blue-600 text-white\"\n                    : \"bg-white border border-slate-200 text-slate-700 hover:border-slate-300\"\n                }`}\n                onClick={() => showFiltersDropdown ? setShowFiltersDropdown(false) : openFiltersDropdown()}\n              >\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\" />\n                </svg>\n                <span className=\"hidden sm:inline\">Filters</span>\n                {activeFilters.length > 0 && (\n                  <span className={`text-xs px-1.5 py-0.5 rounded-full ${\n                    activeFilters.length > 0 ? \"bg-white/20 text-white\" : \"bg-slate-100 text-slate-600\"\n                  }`}>{activeFilters.length}</span>\n                )}\n              </button>\n\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              {/* DESKTOP: Fixed Popover via Portal (lg: and up) */}\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              {showFiltersDropdown && (\n                <Portal>\n                  <div className=\"hidden lg:block fixed inset-0 z-[9998]\">\n                    {/* Backdrop */}\n                    <div\n                      className=\"fixed inset-0\"\n                      onClick={() => setShowFiltersDropdown(false)}\n                    />\n\n                    {/* Desktop Filter Panel - Fixed position, viewport-clamped */}\n                    <div\n                      className=\"fixed w-[360px] max-h-[70vh] bg-white rounded-xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden\"\n                      style={{ top: filterPopoverPos.top, right: filterPopoverPos.right }}\n                    >\n                      {/* Sticky Header */}\n                      <div className=\"flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-white shrink-0\">\n                        <h3 className=\"font-semibold text-slate-900\">Filters</h3>\n                        <button\n                          onClick={() => setShowFiltersDropdown(false)}\n                          className=\"p-1 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors\"\n                        >\n                          <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                          </svg>\n                        </button>\n                      </div>\n\n                      {/* Scrollable Content */}\n                      <div className=\"flex-1 overflow-y-auto p-4 space-y-5\">\n                        {/* Prep Tasks Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Prep Tasks</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"awaiting_pdi\", label: \"Awaiting PDI\" },\n                              { key: \"awaiting_valet\", label: \"Awaiting Valet\" },\n                              { key: \"awaiting_photos\", label: \"Awaiting Photos\" },\n                              { key: \"awaiting_mot\", label: \"Awaiting MOT\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* Issues Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Issues</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"needs_paint\", label: \"Needs Paint\" },\n                              { key: \"needs_mechanical\", label: \"Needs Mechanical\" },\n                              { key: \"needs_electrical\", label: \"Needs Electrical\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* Location Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Location</h5>\n                          <div className=\"space-y-1.5\">\n                            {(() => {\n                              const isActive = activeFilters.includes(\"offsite\");\n                              const count = getFilterCount(\"offsite\");\n                              return (\n                                <button\n                                  onClick={() => toggleFilter(\"offsite\")}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>Offsite Only</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })()}\n                          </div>\n                        </div>\n\n                        {/* Vehicle Type Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Vehicle Type</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"type_stock\", label: \"Stock Vehicles\" },\n                              { key: \"type_courtesy\", label: \"Courtesy Vehicles\" },\n                              { key: \"type_fleet\", label: \"Fleet Vehicles\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* Sale Type Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Sale Type</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"trade_only\", label: \"Trade Only\" },\n                              { key: \"retail_only\", label: \"Retail Only\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* MOT Status Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">MOT Status</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"mot_expired\", label: \"MOT Expired\" },\n                              { key: \"mot_due_soon\", label: \"MOT Due Soon\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Sticky Footer */}\n                      <div className=\"border-t border-slate-200 p-3 bg-white flex gap-2 shrink-0\">\n                        <button\n                          onClick={() => setActiveFilters([])}\n                          className=\"flex-1 px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors\"\n                        >\n                          Clear\n                        </button>\n                        <button\n                          onClick={() => setShowFiltersDropdown(false)}\n                          className=\"flex-1 bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-800 transition-colors\"\n                        >\n                          Apply\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                </Portal>\n              )}\n\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              {/* MOBILE/TABLET: Bottom Sheet (< lg screens) */}\n              {/* Uses its own internal Portal for correct positioning */}\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              <BottomSheet\n                    isOpen={showFiltersDropdown}\n                    onClose={() => setShowFiltersDropdown(false)}\n                    hideAbove=\"lg\"\n                    title=\"Filters\"\n                    footer={\n                      <div className=\"flex gap-3\">\n                        <button\n                          onClick={() => setActiveFilters([])}\n                          className=\"flex-1 px-4 py-3 text-base font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors\"\n                        >\n                          Clear\n                        </button>\n                        <button\n                          onClick={() => setShowFiltersDropdown(false)}\n                          className=\"flex-1 bg-slate-900 text-white py-3 rounded-xl text-base font-bold hover:bg-slate-800 transition-colors\"\n                        >\n                          Apply {activeFilters.length > 0 && `(${activeFilters.length})`}\n                        </button>\n                      </div>\n                    }\n                  >\n                    {/* Prep Tasks */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3\">Prep Tasks</h5>\n                    {[\n                      { key: \"awaiting_pdi\", label: \"Awaiting PDI\" },\n                      { key: \"awaiting_valet\", label: \"Awaiting Valet\" },\n                      { key: \"awaiting_photos\", label: \"Awaiting Photos\" },\n                      { key: \"awaiting_mot\", label: \"Awaiting MOT\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* Issues */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Issues</h5>\n                    {[\n                      { key: \"needs_paint\", label: \"Needs Paint\" },\n                      { key: \"needs_mechanical\", label: \"Needs Mechanical\" },\n                      { key: \"needs_electrical\", label: \"Needs Electrical\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* Location */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Location</h5>\n                    {(() => {\n                      const isActive = activeFilters.includes(\"offsite\");\n                      const count = getFilterCount(\"offsite\");\n                      return (\n                        <button\n                          onClick={() => toggleFilter(\"offsite\")}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>Offsite Only</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })()}\n\n                    {/* Vehicle Type */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Vehicle Type</h5>\n                    {[\n                      { key: \"type_stock\", label: \"Stock Vehicles\" },\n                      { key: \"type_courtesy\", label: \"Courtesy Vehicles\" },\n                      { key: \"type_fleet\", label: \"Fleet Vehicles\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* Sale Type */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Sale Type</h5>\n                    {[\n                      { key: \"trade_only\", label: \"Trade Only\" },\n                      { key: \"retail_only\", label: \"Retail Only\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* MOT Status */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">MOT Status</h5>\n                    {[\n                      { key: \"mot_expired\", label: \"MOT Expired\" },\n                      { key: \"mot_due_soon\", label: \"MOT Due Soon\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n                  </BottomSheet>\n            </div>\n          </div>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex justify-center py-20\">\n          <span className=\"loading loading-spinner loading-lg\"></span>\n        </div>\n      ) : (\n        <>\n          {/* Mobile Column Tabs - Dropdown for clearer UX */}\n          <div className=\"md:hidden mb-4\">\n            <MobileStageSelector\n              stages={COLUMNS.map((col) => ({\n                value: col.key,\n                label: col.label,\n                count: getVehiclesByStatus(col.key).length,\n              }))}\n              activeStage={mobileActiveColumn}\n              onStageChange={setMobileActiveColumn}\n            />\n          </div>\n\n          {/* Mobile Single Column View */}\n          <div className=\"md:hidden\">\n            {COLUMNS.filter(col => col.key === mobileActiveColumn).map((col) => {\n              const columnVehicles = getVehiclesByStatus(col.key);\n\n              // Issue category styling with icons (mobile)\n              const issueCategoryStyles = {\n                Mechanical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                  </svg>\n                )},\n                Cosmetic: { bg: \"bg-teal-50\", text: \"text-teal-700\", border: \"border-teal-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01\" />\n                  </svg>\n                )},\n                Electrical: { bg: \"bg-yellow-50\", text: \"text-yellow-800\", border: \"border-yellow-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\n                  </svg>\n                )},\n                Other: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                  </svg>\n                )},\n              };\n\n              return (\n                <div key={col.key} className=\"space-y-3\">\n                  {columnVehicles.map((vehicle) => {\n                    const tasks = vehicle.tasks || [];\n                    const completedTasks = tasks.filter(t => t.status === \"done\").length;\n                    const motStatus = getMOTStatus(vehicle.motExpiryDate);\n                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);\n                    const duration = getVehicleDuration(vehicle);\n\n                    return (\n                      <div\n                        key={vehicle.id}\n                        className=\"bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100/50 overflow-hidden active:scale-[0.98]\"\n                        onClick={() => openVehicleDrawer(vehicle)}\n                      >\n                        <div className=\"p-4\">\n                          {/* Title with Registration Badge */}\n                          <div className=\"flex justify-between items-start mb-2\">\n                            <div className=\"flex-1\">\n                              <div className=\"flex items-center gap-2 flex-wrap mb-1\">\n                                <p className=\"font-bold text-slate-900 text-base\">\n                                  {vehicle.year || \"\"} {vehicle.make} {vehicle.model}\n                                </p>\n                                <span className=\"font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md\">\n                                  {vehicle.regCurrent}\n                                </span>\n                              </div>\n                            </div>\n                            {/* Duration badge - Sold or In Stock */}\n                            <span className={`inline-flex items-center gap-1 text-xs ${\n                              duration.isSold ? \"text-emerald-600\" : duration.days > 30 ? \"text-red-500\" : \"text-slate-400\"\n                            }`}>\n                              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                              {duration.label}\n                            </span>\n                          </div>\n\n                          {/* Tags - Modern Pill Style */}\n                          <div className=\"flex gap-1.5 flex-wrap mb-3\">\n                            {vehicle.locationId && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-[#0066CC]/10 text-[#0066CC] border border-[#0066CC]/20\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                </svg>\n                                {vehicle.locationId.name || \"Offsite\"}\n                              </span>\n                            )}\n                            {vehicle.saleType === \"TRADE\" && (\n                              <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase\">\n                                Trade\n                              </span>\n                            )}\n                            {vehicle.type === \"COURTESY\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-cyan-600 text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                Courtesy\n                              </span>\n                            )}\n                            {vehicle.type === \"FLEET_OTHER\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-[#0066CC] text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                                </svg>\n                                Fleet\n                              </span>\n                            )}\n                            {motStatus?.type === \"expired\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"due_soon\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"valid\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"unknown\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-slate-100 text-slate-500 border border-slate-200\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT ?\n                              </span>\n                            )}\n                            {/* Issue Pills with Icons */}\n                            {Object.entries(issueCounts).map(([category, count]) => {\n                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;\n                              return (\n                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>\n                                  {style.icon}\n                                  {count} {category}\n                                </span>\n                              );\n                            })}\n                            {/* Custom Labels */}\n                            {vehicle.labels?.map((label) => (\n                              <span\n                                key={label.id}\n                                className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border\"\n                                style={{\n                                  backgroundColor: `${label.colour}10`,\n                                  color: label.colour,\n                                  borderColor: `${label.colour}30`,\n                                }}\n                              >\n                                <span className=\"w-1.5 h-1.5 rounded-full\" style={{ backgroundColor: label.colour }}></span>\n                                {label.name}\n                              </span>\n                            ))}\n                          </div>\n\n                          {/* Slick Progress Bar */}\n                          {tasks.length > 0 && (\n                            <div>\n                              <span className=\"text-xs text-slate-400 mb-1 block\">\n                                {completedTasks}/{tasks.length} tasks\n                              </span>\n                              <div className=\"w-full bg-slate-100 rounded-full h-2\">\n                                <div\n                                  className=\"h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400\"\n                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}\n                                ></div>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                  {columnVehicles.length === 0 && (\n                    <div className=\"text-center py-12 text-slate-400\">\n                      <p className=\"text-sm\">No vehicles in {col.label}</p>\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Mobile Floating Action Button */}\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"md:hidden fixed fab-safe right-4 z-40 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all active:scale-95\"\n          >\n            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n            </svg>\n          </button>\n\n          {/* Desktop Multi-Column View */}\n          <div className=\"hidden md:flex gap-4 overflow-x-auto pb-6\">\n            {COLUMNS.map((col) => {\n              const columnVehicles = getVehiclesByStatus(col.key);\n              return (\n                <div\n                  key={col.key}\n                  data-column-key={col.key}\n                  className={`flex-shrink-0 w-64 bg-gradient-to-b ${col.gradient} to-transparent rounded-2xl p-3 min-h-[400px]`}\n                  onDragOver={handleDragOver}\n                onDrop={(e) => handleDrop(e, col.key)}\n              >\n                {/* Integrated Header */}\n                <div className=\"flex items-center justify-between mb-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <h3 className=\"font-semibold text-slate-700 text-sm\">\n                      {col.label}\n                    </h3>\n                    <span className=\"bg-slate-900/10 text-slate-700 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center\">\n                      {columnVehicles.length}\n                    </span>\n                  </div>\n                  <div className=\"dropdown dropdown-end\">\n                    <label tabIndex={0} className=\"btn btn-ghost btn-xs gap-1 bg-white/30 backdrop-blur-sm hover:bg-white/50 rounded-full\">\n                      <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12\" />\n                      </svg>\n                      <span className=\"text-xs\">\n                        {columnSortOptions[col.key] === \"newest_first\" ? \"Newest\" :\n                         columnSortOptions[col.key] === \"alphabetical\" ? \"A-Z\" : \"Oldest\"}\n                      </span>\n                    </label>\n                    <ul tabIndex={0} className=\"dropdown-content z-30 menu p-2 shadow-lg bg-white rounded-xl w-44 mt-2\">\n                      <li>\n                        <button\n                          className={`rounded-lg ${columnSortOptions[col.key] === \"oldest_first\" || !columnSortOptions[col.key] ? \"active bg-slate-100\" : \"\"}`}\n                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"oldest_first\" }))}\n                        >\n                          Oldest First\n                        </button>\n                      </li>\n                      <li>\n                        <button\n                          className={`rounded-lg ${columnSortOptions[col.key] === \"newest_first\" ? \"active bg-slate-100\" : \"\"}`}\n                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"newest_first\" }))}\n                        >\n                          Newest First\n                        </button>\n                      </li>\n                      <li>\n                        <button\n                          className={`rounded-lg ${columnSortOptions[col.key] === \"alphabetical\" ? \"active bg-slate-100\" : \"\"}`}\n                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"alphabetical\" }))}\n                        >\n                          Alphabetical (Make/Model)\n                        </button>\n                      </li>\n                    </ul>\n                  </div>\n                </div>\n\n                {/* Cards Container */}\n                <div className=\"space-y-3\">\n                  {columnVehicles.map((vehicle) => {\n                    const tasks = vehicle.tasks || [];\n                    const completedTasks = tasks.filter(t => t.status === \"done\").length;\n                    const motStatus = getMOTStatus(vehicle.motExpiryDate);\n                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);\n                    const duration = getVehicleDuration(vehicle);\n\n                    // Issue category styling with icons\n                    const issueCategoryStyles = {\n                      Mechanical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                        </svg>\n                      )},\n                      Cosmetic: { bg: \"bg-teal-50\", text: \"text-teal-700\", border: \"border-teal-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01\" />\n                        </svg>\n                      )},\n                      Electrical: { bg: \"bg-yellow-50\", text: \"text-yellow-800\", border: \"border-yellow-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\n                        </svg>\n                      )},\n                      Other: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                        </svg>\n                      )},\n                    };\n\n                    return (\n                      <div\n                        key={vehicle.id}\n                        draggable\n                        onDragStart={(e) => handleDragStart(e, vehicle)}\n                        onDrag={handleDrag}\n                        onDragEnd={handleDragEnd}\n                        className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all cursor-grab active:cursor-grabbing border border-slate-100/50 overflow-hidden ${draggedCard?.id === vehicle.id ? \"opacity-40 scale-95\" : \"\"}`}\n                        onClick={() => openVehicleDrawer(vehicle)}\n                      >\n                        <div className=\"p-3\">\n                          {/* Title with Registration Badge */}\n                          <div className=\"flex justify-between items-start mb-2\">\n                            <div className=\"flex-1 min-w-0\">\n                              <div className=\"flex items-center gap-2 flex-wrap\">\n                                <p className=\"font-bold text-slate-900 text-sm leading-tight\">\n                                  {vehicle.year || \"\"} {vehicle.make} {vehicle.model}\n                                </p>\n                                <span className=\"font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md\">\n                                  {vehicle.regCurrent}\n                                </span>\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Tags - Modern Pill Style */}\n                          <div className=\"flex gap-1.5 flex-wrap mb-2\">\n                            {/* Trade badge */}\n                            {vehicle.saleType === \"TRADE\" && (\n                              <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase\">\n                                Trade\n                              </span>\n                            )}\n                            {/* Courtesy/Fleet badges */}\n                            {vehicle.type === \"COURTESY\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-cyan-600 text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                Courtesy\n                              </span>\n                            )}\n                            {vehicle.type === \"FLEET_OTHER\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-[#0066CC] text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                                </svg>\n                                Fleet\n                              </span>\n                            )}\n                            {motStatus?.type === \"expired\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"due_soon\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"valid\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"unknown\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-slate-100 text-slate-500 border border-slate-200\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT ?\n                              </span>\n                            )}\n                            {/* Issue Pills with Icons */}\n                            {Object.entries(issueCounts).map(([category, count]) => {\n                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;\n                              return (\n                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>\n                                  {style.icon}\n                                  {count} {category}\n                                </span>\n                              );\n                            })}\n                            {vehicle.locationId && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-[#0066CC]/10 text-[#0066CC] border border-[#0066CC]/20\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                </svg>\n                                {vehicle.locationId.name}\n                              </span>\n                            )}\n                            {/* Custom Labels */}\n                            {vehicle.labels?.map((label) => (\n                              <span\n                                key={label.id}\n                                className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border\"\n                                style={{\n                                  backgroundColor: `${label.colour}10`,\n                                  color: label.colour,\n                                  borderColor: `${label.colour}30`,\n                                }}\n                              >\n                                <span className=\"w-1.5 h-1.5 rounded-full\" style={{ backgroundColor: label.colour }}></span>\n                                {label.name}\n                              </span>\n                            ))}\n                          </div>\n\n                          {/* Slick Progress Bar */}\n                          {tasks.length > 0 && (\n                            <div className=\"mb-2\">\n                              <span className=\"text-xs text-slate-400 mb-1 block\">\n                                {completedTasks}/{tasks.length} tasks\n                              </span>\n                              <div className=\"w-full bg-slate-100 rounded-full h-2\">\n                                <div\n                                  className=\"h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400\"\n                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}\n                                ></div>\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Footer - Duration (Sold or In Stock) */}\n                          <div className=\"pt-2 border-t border-slate-100 flex items-center justify-between\">\n                            <span className={`inline-flex items-center gap-1 text-[10px] font-medium ${\n                              duration.isSold ? \"text-emerald-600\" : duration.days > 30 ? \"text-red-500\" : \"text-slate-400\"\n                            }`}>\n                              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                              {duration.label}\n                            </span>\n                            {!duration.isSold && duration.days > 30 && (\n                              <span className=\"inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-500 border border-red-100\">\n                                Aging\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n\n                  {/* Empty State */}\n                  {columnVehicles.length === 0 && (\n                    <div className=\"text-center py-8 px-4\">\n                      <div className=\"w-12 h-12 mx-auto mb-3 rounded-full bg-white/50 flex items-center justify-center\">\n                        <svg className=\"w-6 h-6 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                        </svg>\n                      </div>\n                      <p className=\"text-sm text-slate-500 font-medium\">No vehicles</p>\n                      <p className=\"text-xs text-slate-400 mt-1\">Drag cards here to move</p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            );\n          })}\n          </div>\n        </>\n      )}\n\n      {/* Vehicle Detail Drawer - Full Screen on Mobile */}\n      {selectedVehicle && (\n        <div className=\"fixed inset-0 z-50 flex justify-end\">\n          <div className=\"bg-black/50 absolute inset-0 hidden md:block\" onClick={() => setSelectedVehicle(null)}></div>\n          <div className=\"relative bg-white w-full md:max-w-3xl h-full overflow-y-auto flex flex-col\">\n            {/* Sticky Header */}\n            <div className=\"sticky top-0 bg-white border-b border-slate-200 px-4 md:px-6 py-3 md:py-4 flex justify-between items-center z-10\">\n              <div className=\"flex items-center gap-3\">\n                {/* Back button on mobile */}\n                <button className=\"md:hidden btn btn-ghost btn-sm btn-circle\" onClick={() => setSelectedVehicle(null)}>\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <div>\n                  <h2 className=\"text-lg md:text-xl font-bold text-slate-900\">\n                    {selectedVehicle.year || \"\"} {selectedVehicle.make} {selectedVehicle.model}\n                  </h2>\n                  <p className=\"text-xs md:text-sm text-slate-500 font-mono mt-0.5\">{selectedVehicle.regCurrent}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-1 md:gap-2\">\n                <button\n                  className=\"hidden md:flex btn btn-outline btn-sm\"\n                  onClick={handleGenerateJobSheet}\n                  disabled={isGeneratingJobSheet}\n                  title=\"Share job sheet with mechanic\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z\" />\n                  </svg>\n                  {isGeneratingJobSheet ? \"...\" : \"Share\"}\n                </button>\n                <button\n                  className=\"hidden md:flex btn btn-outline btn-sm\"\n                  onClick={handleGeneratePrepSummary}\n                  disabled={isGeneratingPrepSummary}\n                  title=\"Export prep summary PDF\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                  </svg>\n                  {isGeneratingPrepSummary ? \"...\" : \"Prep PDF\"}\n                </button>\n                <button className=\"hidden md:flex btn btn-outline btn-sm\" onClick={handlePrintVehicle} title=\"Print vehicle details\">\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                  </svg>\n                  Print\n                </button>\n                <button\n                  className=\"btn btn-ghost btn-sm text-error\"\n                  onClick={async () => {\n                    if (confirm(\"Delete this vehicle?\")) {\n                      await fetch(`/api/vehicles/${selectedVehicle.id}`, { method: \"DELETE\" });\n                      setSelectedVehicle(null);\n                      fetchVehicles();\n                      toast.success(\"Vehicle deleted\");\n                    }\n                  }}\n                  title=\"Delete vehicle\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                  </svg>\n                </button>\n                <button className=\"hidden md:flex btn btn-ghost btn-sm\" onClick={() => setSelectedVehicle(null)}>\n                  ✕\n                </button>\n              </div>\n            </div>\n\n            {/* Tabs - Using DaisyUI tabs */}\n            <div className=\"bg-base-100 border-b border-base-300 px-4\">\n              <div className=\"tabs tabs-bordered\">\n                <button\n                  className={`tab ${activeTab === \"overview\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"overview\")}\n                >\n                  Overview\n                </button>\n                <button\n                  className={`tab ${activeTab === \"checklist\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"checklist\")}\n                >\n                  Checklist {selectedVehicle.tasks?.length > 0 && `(${selectedVehicle.tasks.length})`}\n                </button>\n                <button\n                  className={`tab ${activeTab === \"issues\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"issues\")}\n                >\n                  Issues {selectedVehicle.issues?.length > 0 && `(${selectedVehicle.issues.length})`}\n                </button>\n                <button\n                  className={`tab ${activeTab === \"documents\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"documents\")}\n                >\n                  Documents {selectedVehicle.documents?.length > 0 && `(${selectedVehicle.documents.length})`}\n                </button>\n                <button\n                  className={`tab ${activeTab === \"activity\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => {\n                    setActiveTab(\"activity\");\n                    if (selectedVehicle?.id) {\n                      fetchActivity(selectedVehicle.id);\n                    }\n                  }}\n                >\n                  Activity\n                </button>\n              </div>\n            </div>\n\n            <div className=\"p-6 space-y-6\">\n              {/* Overview Tab */}\n              {activeTab === \"overview\" && (\n                <div className=\"space-y-6\">\n                  {/* Identity Section */}\n                  <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                    <h3 className=\"text-sm font-semibold text-slate-900 mb-4\">Identity</h3>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Registration</label>\n                        <div className=\"flex gap-2\">\n                          <input\n                            type=\"text\"\n                            className=\"input input-sm bg-slate-50 border-slate-200 text-slate-900 flex-1 font-mono uppercase\"\n                            value={selectedVehicle.regCurrent || \"\"}\n                            onChange={(e) => setSelectedVehicle({ ...selectedVehicle, regCurrent: e.target.value.toUpperCase() })}\n                            onBlur={async () => {\n                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                method: \"PUT\",\n                                headers: { \"Content-Type\": \"application/json\" },\n                                body: JSON.stringify({ regCurrent: selectedVehicle.regCurrent }),\n                              });\n                              fetchVehicles();\n                            }}\n                          />\n                          <button\n                            type=\"button\"\n                            className=\"btn btn-sm btn-primary\"\n                            onClick={lookupVehicleDVLA}\n                            disabled={isLookingUpDrawer}\n                            title=\"Lookup DVLA data for this registration\"\n                          >\n                            {isLookingUpDrawer ? (\n                              <span className=\"loading loading-spinner loading-xs\"></span>\n                            ) : (\n                              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n                              </svg>\n                            )}\n                          </button>\n                        </div>\n                        <p className=\"text-xs text-slate-400 mt-1\">Click lookup to refresh DVLA data</p>\n                      </div>\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">VIN</label>\n                        <input\n                          type=\"text\"\n                          className=\"input input-sm bg-slate-50 border-slate-200 text-slate-900\"\n                          value={selectedVehicle.vin || \"\"}\n                          onChange={(e) => setSelectedVehicle({ ...selectedVehicle, vin: e.target.value })}\n                          onBlur={async () => {\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify({ vin: selectedVehicle.vin }),\n                            });\n                            fetchVehicles();\n                          }}\n                        />\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Custom Labels Section */}\n                  <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                    <h3 className=\"text-sm font-semibold text-slate-900 mb-3\">Custom Labels</h3>\n\n                    {/* Applied Labels Display */}\n                    {selectedVehicle.labels?.length > 0 && (\n                      <div className=\"flex flex-wrap gap-2 mb-3\">\n                        {selectedVehicle.labels.map((label) => (\n                          <span\n                            key={label.id}\n                            className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold\"\n                            style={{\n                              backgroundColor: `${label.colour}20`,\n                              color: label.colour,\n                            }}\n                          >\n                            <span className=\"w-2 h-2 rounded-full\" style={{ backgroundColor: label.colour }}></span>\n                            {label.name}\n                            <button\n                              type=\"button\"\n                              onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}\n                              className=\"ml-0.5 hover:opacity-70\"\n                            >\n                              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                              </svg>\n                            </button>\n                          </span>\n                        ))}\n                      </div>\n                    )}\n\n                    {/* Labels Dropdown */}\n                    <div className=\"relative\">\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowLabelsDropdown(!showLabelsDropdown)}\n                        className=\"w-full flex items-center justify-between px-3 py-2 border border-slate-300 rounded-lg bg-white text-sm hover:border-slate-400 transition-colors\"\n                      >\n                        <span className=\"text-slate-600\">\n                          {selectedVehicle.labels?.length > 0\n                            ? `${selectedVehicle.labels.length} label${selectedVehicle.labels.length > 1 ? 's' : ''} selected`\n                            : \"Select labels...\"\n                          }\n                        </span>\n                        <svg className={`w-4 h-4 text-slate-400 transition-transform ${showLabelsDropdown ? 'rotate-180' : ''}`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                        </svg>\n                      </button>\n\n                      {showLabelsDropdown && (\n                        <div className=\"absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-auto\">\n                          {availableLabels.map((label) => {\n                            const isApplied = selectedVehicle.labels?.some(l => l.id === label.id);\n                            return (\n                              <button\n                                key={label.id}\n                                type=\"button\"\n                                onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}\n                                className=\"w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left\"\n                              >\n                                <span\n                                  className=\"w-3 h-3 rounded-full flex-shrink-0\"\n                                  style={{ backgroundColor: label.colour }}\n                                ></span>\n                                <span className=\"flex-1 text-sm text-slate-700\">{label.name}</span>\n                                {isApplied && (\n                                  <svg className=\"w-4 h-4 text-green-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                                    <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                                  </svg>\n                                )}\n                              </button>\n                            );\n                          })}\n\n                          {/* Add New Label Option */}\n                          <div className=\"border-t border-slate-100\">\n                            <button\n                              type=\"button\"\n                              onClick={() => {\n                                setShowLabelsDropdown(false);\n                                setShowAddLabelModal(true);\n                              }}\n                              className=\"w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left text-[#0066CC]\"\n                            >\n                              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                              </svg>\n                              <span className=\"text-sm font-medium\">Add new label</span>\n                            </button>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n\n                    {availableLabels.length === 0 && (\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowAddLabelModal(true)}\n                        className=\"w-full flex items-center justify-center gap-2 px-3 py-2 border border-dashed border-slate-300 rounded-lg text-sm text-slate-500 hover:border-slate-400 hover:text-slate-600 transition-colors\"\n                      >\n                        <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                        </svg>\n                        Create your first label\n                      </button>\n                    )}\n                  </div>\n\n                  {/* Status & Location Section - Now below Identity */}\n                  <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                    <h3 className=\"text-sm font-semibold text-slate-900 mb-4\">Status & Location</h3>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Vehicle Type</label>\n                        <select\n                          className=\"select select-sm select-bordered w-full\"\n                          value={selectedVehicle.type || \"STOCK\"}\n                          onChange={async (e) => {\n                            const newType = e.target.value;\n                            const updates = { type: newType };\n                            // Clear saleType if not Stock\n                            if (newType !== \"STOCK\") {\n                              updates.saleType = null;\n                            }\n                            setSelectedVehicle({ ...selectedVehicle, ...updates });\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify(updates),\n                            });\n                            fetchVehicles();\n                            toast.success(\"Vehicle type updated\");\n                          }}\n                        >\n                          <option value=\"STOCK\">Stock</option>\n                          <option value=\"COURTESY\">Courtesy</option>\n                          <option value=\"FLEET_OTHER\">Fleet</option>\n                        </select>\n                      </div>\n                      {/* Sale Type - Only show for Stock vehicles */}\n                      {(selectedVehicle.type === \"STOCK\" || !selectedVehicle.type) && (\n                        <div className=\"form-control\">\n                          <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Sale Type</label>\n                          <select\n                            className=\"select select-sm select-bordered w-full\"\n                            value={selectedVehicle.saleType || \"RETAIL\"}\n                            onChange={async (e) => {\n                              const newSaleType = e.target.value;\n                              setSelectedVehicle({ ...selectedVehicle, saleType: newSaleType });\n                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                method: \"PUT\",\n                                headers: { \"Content-Type\": \"application/json\" },\n                                body: JSON.stringify({ saleType: newSaleType }),\n                              });\n                              fetchVehicles();\n                              toast.success(\"Sale type updated\");\n                            }}\n                          >\n                            <option value=\"RETAIL\">Retail</option>\n                            <option value=\"TRADE\">Trade</option>\n                          </select>\n                        </div>\n                      )}\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Status</label>\n                        <select\n                          className=\"select select-sm select-bordered w-full\"\n                          value={selectedVehicle.status || \"in_stock\"}\n                          onChange={async (e) => {\n                            const newStatus = e.target.value;\n                            setSelectedVehicle({ ...selectedVehicle, status: newStatus });\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify({ status: newStatus }),\n                            });\n                            fetchVehicles();\n                            toast.success(`Status updated to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);\n                          }}\n                        >\n                          {COLUMNS.map(col => (\n                            <option key={col.key} value={col.key}>{col.label}</option>\n                          ))}\n                        </select>\n                      </div>\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Location</label>\n                        <select\n                          className=\"select select-sm select-bordered w-full\"\n                          value={selectedVehicle.locationId?.id || selectedVehicle.locationId?._id || selectedVehicle.locationId || \"\"}\n                          onChange={async (e) => {\n                            const value = e.target.value;\n                            if (value === \"__add_new__\") {\n                              setShowAddLocationModal(true);\n                              return;\n                            }\n                            const locationId = value || null;\n                            setSelectedVehicle({ ...selectedVehicle, locationId: locationId });\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify({ locationId }),\n                            });\n                            const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n                            setSelectedVehicle(updated);\n                            fetchVehicles();\n                            toast.success(\"Location updated\");\n                          }}\n                        >\n                          <option value=\"\">On Site</option>\n                          {locations.map(loc => (\n                            <option key={loc.id || loc._id} value={loc.id || loc._id}>{loc.name}</option>\n                          ))}\n                          <option value=\"__add_new__\">+ Add Location</option>\n                        </select>\n                      </div>\n                    </div>\n                  </div>\n\n                    <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                      <h3 className=\"text-sm font-semibold text-slate-900 mb-4\">Specs</h3>\n                      <div className=\"space-y-3\">\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Make</label>\n                            <input\n                              type=\"text\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.make || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, make: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ make: selectedVehicle.make }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Model</label>\n                            <input\n                              type=\"text\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.model || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, model: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ model: selectedVehicle.model }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Year</label>\n                            <input\n                              type=\"number\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.year || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, year: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ year: selectedVehicle.year }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Mileage</label>\n                            <input\n                              type=\"number\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.mileageCurrent || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, mileageCurrent: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ mileageCurrent: selectedVehicle.mileageCurrent }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Colour</label>\n                            <input\n                              type=\"text\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.colour || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, colour: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ colour: selectedVehicle.colour }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Fuel Type</label>\n                            <select\n                              className=\"select select-sm select-bordered\"\n                              value={selectedVehicle.fuelType || \"\"}\n                              onChange={async (e) => {\n                                const newValue = e.target.value;\n                                setSelectedVehicle({ ...selectedVehicle, fuelType: newValue });\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ fuelType: newValue }),\n                                });\n                                fetchVehicles();\n                              }}\n                            >\n                              <option value=\"\">Select...</option>\n                              <option value=\"Petrol\">Petrol</option>\n                              <option value=\"Diesel\">Diesel</option>\n                              <option value=\"Hybrid\">Hybrid</option>\n                              <option value=\"Electric\">Electric</option>\n                            </select>\n                          </div>\n                        </div>\n\n                        <div className=\"form-control\">\n                          <label className=\"label label-text text-xs\">MOT Expiry Date</label>\n                          <input\n                            type=\"date\"\n                            className=\"input input-sm input-bordered\"\n                            value={selectedVehicle.motExpiryDate ? new Date(selectedVehicle.motExpiryDate).toISOString().split('T')[0] : \"\"}\n                            onChange={async (e) => {\n                              const newValue = e.target.value;\n                              setSelectedVehicle({ ...selectedVehicle, motExpiryDate: newValue });\n                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                method: \"PUT\",\n                                headers: { \"Content-Type\": \"application/json\" },\n                                body: JSON.stringify({ motExpiryDate: newValue }),\n                              });\n                              fetchVehicles();\n                            }}\n                          />\n                        </div>\n                      </div>\n                    </div>\n\n                  <div className=\"card bg-base-200\">\n                    <div className=\"card-body p-4\">\n                      <h3 className=\"font-semibold mb-2\">V5 Document</h3>\n                      {selectedVehicle.v5Url ? (\n                        <div>\n                          <a href={selectedVehicle.v5Url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"btn btn-sm btn-outline w-full mb-2\">\n                            View V5 Document\n                          </a>\n                          <label className=\"btn btn-sm btn-ghost w-full\">\n                            Replace V5\n                            <input type=\"file\" accept=\"image/*,.pdf\" className=\"hidden\" onChange={(e) => uploadV5(e.target.files[0])} />\n                          </label>\n                        </div>\n                      ) : (\n                        <label className=\"btn btn-primary btn-sm w-full\">\n                          Upload V5\n                          <input type=\"file\" accept=\"image/*,.pdf\" className=\"hidden\" onChange={(e) => uploadV5(e.target.files[0])} />\n                        </label>\n                      )}\n                    </div>\n                  </div>\n\n                  {selectedVehicle.notes && (\n                    <div className=\"card bg-base-200\">\n                      <div className=\"card-body p-4\">\n                        <h3 className=\"font-semibold mb-2\">Notes</h3>\n                        <p className=\"text-sm whitespace-pre-wrap\">{selectedVehicle.notes}</p>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              )}\n\n\n              {/* Prep Checklist Tab */}\n              {activeTab === \"checklist\" && (\n                <div className=\"card bg-base-200\">\n                  <div className=\"card-body p-4\">\n                    <h3 className=\"font-semibold mb-3\">Prep Checklist</h3>\n                    <div className=\"space-y-2\">\n                      {selectedVehicle.tasks?.map((task) => (\n                        <div key={task.id} className=\"p-2 rounded hover:bg-base-300 group\">\n                          <div className=\"flex items-center gap-2\">\n                            <select\n                              className=\"select select-bordered select-xs\"\n                              value={task.status || \"pending\"}\n                              onChange={(e) => updateTaskStatus(task.id, e.target.value)}\n                              onClick={(e) => e.stopPropagation()}\n                            >\n                              <option value=\"pending\">Pending</option>\n                              <option value=\"in_progress\">In Progress</option>\n                              <option value=\"done\">Done</option>\n                              <option value=\"not_required\">Not Required</option>\n                            </select>\n                            {editingTaskId === task.id ? (\n                              <input\n                                type=\"text\"\n                                className=\"input input-bordered input-xs flex-1\"\n                                value={editingTaskName}\n                                onChange={(e) => setEditingTaskName(e.target.value)}\n                                onBlur={() => {\n                                  if (editingTaskName.trim() && editingTaskName !== task.name) {\n                                    updateTaskName(task.id, editingTaskName);\n                                  } else {\n                                    setEditingTaskId(null);\n                                    setEditingTaskName(\"\");\n                                  }\n                                }}\n                                onKeyPress={(e) => {\n                                  if (e.key === \"Enter\") {\n                                    if (editingTaskName.trim() && editingTaskName !== task.name) {\n                                      updateTaskName(task.id, editingTaskName);\n                                    } else {\n                                      setEditingTaskId(null);\n                                      setEditingTaskName(\"\");\n                                    }\n                                  }\n                                }}\n                                onKeyDown={(e) => {\n                                  if (e.key === \"Escape\") {\n                                    setEditingTaskId(null);\n                                    setEditingTaskName(\"\");\n                                  }\n                                }}\n                                autoFocus\n                              />\n                            ) : (\n                              <span\n                                className={`flex-1 text-sm cursor-pointer ${task.status === \"done\" ? \"line-through text-base-content/50\" : \"\"}`}\n                                onClick={() => {\n                                  setEditingTaskId(task.id);\n                                  setEditingTaskName(task.name);\n                                }}\n                                title=\"Click to edit\"\n                              >\n                                {task.name}\n                                {/* Show parts status chip next to task name */}\n                                {task.partsOrders?.length > 0 && (\n                                  <span className={`ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${\n                                    task.partsOrders.every(o => o.status === \"RECEIVED\")\n                                      ? \"bg-green-100 text-green-800 border border-green-200\"\n                                      : task.partsOrders.some(o => o.status === \"RECEIVED\")\n                                        ? \"bg-blue-100 text-blue-800 border border-blue-200\"\n                                        : \"bg-amber-100 text-amber-800 border border-amber-200\"\n                                  }`}>\n                                    {task.partsOrders.every(o => o.status === \"RECEIVED\")\n                                      ? `✓ Parts Received (${task.partsOrders.length})`\n                                      : task.partsOrders.some(o => o.status === \"RECEIVED\")\n                                        ? `Parts: ${task.partsOrders.filter(o => o.status === \"RECEIVED\").length}/${task.partsOrders.length} Received`\n                                        : `Parts Ordered (${task.partsOrders.length})`\n                                    }\n                                  </span>\n                                )}\n                              </span>\n                            )}\n                            {task.completedAt && !editingTaskId && (\n                              <span className=\"text-xs text-base-content/50\">\n                                {formatDate(task.completedAt)}\n                              </span>\n                            )}\n                            {/* Order Parts button - show for pending/in_progress tasks */}\n                            {task.status !== \"done\" && task.status !== \"not_required\" && (\n                              <button\n                                className=\"btn btn-ghost btn-xs text-amber-600 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  openPartsOrderModal(task.id);\n                                }}\n                                title=\"Order Parts\"\n                              >\n                                + Parts\n                              </button>\n                            )}\n                            <button\n                              className=\"btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity\"\n                              onClick={() => deleteTask(task.id)}\n                            >\n                              ✕\n                            </button>\n                          </div>\n                          {/* Parts orders section - show if task has parts orders */}\n                          {task.partsOrders?.length > 0 && (\n                            <div className=\"mt-2 ml-6 pl-2 border-l-2 border-amber-300 space-y-1\">\n                              {task.partsOrders.map((order) => (\n                                <div key={order._id || order.id} className=\"flex items-center gap-2 text-xs\">\n                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium ${\n                                    order.status === \"RECEIVED\"\n                                      ? \"bg-green-100 text-green-700\"\n                                      : \"bg-amber-100 text-amber-700\"\n                                  }`}>\n                                    {order.status === \"RECEIVED\" ? \"✓\" : \"⏳\"}\n                                  </span>\n                                  <span className=\"text-base-content/80\">{getSupplierDisplay(order)}</span>\n                                  {order.orderRef && (\n                                    <span className=\"text-base-content/50\">Ref: {order.orderRef}</span>\n                                  )}\n                                  {order.expectedAt && order.status !== \"RECEIVED\" && (\n                                    <span className=\"text-base-content/50\">\n                                      ETA: {formatDate(order.expectedAt)}\n                                    </span>\n                                  )}\n                                  {order.status !== \"RECEIVED\" && (\n                                    <button\n                                      className=\"btn btn-ghost btn-xs text-green-600\"\n                                      onClick={(e) => {\n                                        e.stopPropagation();\n                                        markPartsReceived(task.id, order._id || order.id);\n                                      }}\n                                      title=\"Mark as Received\"\n                                    >\n                                      ✓ Received\n                                    </button>\n                                  )}\n                                  <button\n                                    className=\"btn btn-ghost btn-xs\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      openPartsOrderModal(task.id, order);\n                                    }}\n                                    title=\"Edit\"\n                                  >\n                                    ✎\n                                  </button>\n                                  <button\n                                    className=\"btn btn-ghost btn-xs text-error\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      removePartsOrder(task.id, order._id || order.id);\n                                    }}\n                                    title=\"Remove\"\n                                  >\n                                    ✕\n                                  </button>\n                                </div>\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      ))}\n                    </div>\n                    <div className=\"flex gap-2 mt-3\">\n                      <input\n                        type=\"text\"\n                        className=\"input input-bordered input-sm flex-1\"\n                        placeholder=\"Add new task...\"\n                        value={newTaskName}\n                        onChange={(e) => setNewTaskName(e.target.value)}\n                        onKeyPress={(e) => e.key === \"Enter\" && addTask()}\n                      />\n                      <button className=\"btn btn-primary btn-sm\" onClick={addTask}>\n                        Add\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Issues Tab */}\n              {activeTab === \"issues\" && (\n                <div className=\"space-y-4\">\n                  <button\n                    className=\"flex items-center justify-center gap-2 w-full px-4 py-2.5 bg-[#0066CC] hover:bg-[#0055AA] text-white text-sm font-medium rounded-xl shadow-sm shadow-[#0066CC]/25 hover:shadow-md transition-all\"\n                    onClick={() => setShowAddIssueModal(true)}\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    Add Issue\n                  </button>\n\n                  {selectedVehicle.issues && selectedVehicle.issues.length > 0 ? (\n                    <div className=\"space-y-3\">\n                      {selectedVehicle.issues.map((issue) => (\n                        <div key={issue.id} className=\"bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden hover:shadow-md transition-shadow\">\n                          {/* Issue Header with Status Bar */}\n                          <div className={`px-4 py-3 border-b border-slate-100 ${\n                            issue.status === \"Complete\" ? \"bg-emerald-50/50\" :\n                            issue.status === \"In Progress\" ? \"bg-amber-50/50\" :\n                            issue.status === \"Ordered\" ? \"bg-blue-50/50\" :\n                            \"bg-red-50/50\"\n                          }`}>\n                            <div className=\"flex items-center justify-between gap-3\">\n                              <div className=\"flex items-center gap-2 flex-wrap min-w-0\">\n                                <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-[#0066CC]/10 text-[#0066CC]\">\n                                  {issue.category}\n                                </span>\n                                {issue.subcategory && (\n                                  <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600\">\n                                    {issue.subcategory}\n                                  </span>\n                                )}\n                              </div>\n                              <select\n                                className={`text-xs font-semibold px-2.5 py-1.5 rounded-lg border-0 cursor-pointer transition-colors ${\n                                  issue.status === \"Complete\" ? \"bg-emerald-100 text-emerald-700\" :\n                                  issue.status === \"In Progress\" ? \"bg-amber-100 text-amber-700\" :\n                                  issue.status === \"Ordered\" ? \"bg-blue-100 text-blue-700\" :\n                                  \"bg-red-100 text-red-700\"\n                                }`}\n                                value={issue.status || \"Outstanding\"}\n                                onChange={(e) => updateIssue(issue.id, { status: e.target.value })}\n                              >\n                                <option value=\"Outstanding\">Outstanding</option>\n                                <option value=\"Ordered\">Ordered</option>\n                                <option value=\"In Progress\">In Progress</option>\n                                <option value=\"Complete\">Complete</option>\n                              </select>\n                            </div>\n                          </div>\n\n                          {/* Issue Body */}\n                          <div className=\"p-4 space-y-3\">\n                            {/* Description */}\n                            <p className=\"text-sm font-medium text-slate-800\">{issue.description}</p>\n\n                            {/* Details Grid */}\n                            <div className=\"space-y-2\">\n                              {issue.actionNeeded && (\n                                <div className=\"flex items-start gap-2\">\n                                  <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pt-0.5 w-14\">Action</span>\n                                  <p className=\"text-sm text-slate-600\">{issue.actionNeeded}</p>\n                                </div>\n                              )}\n                              {issue.notes && (\n                                <div className=\"flex items-start gap-2\">\n                                  <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pt-0.5 w-14\">Notes</span>\n                                  <p className=\"text-sm text-slate-600\">{issue.notes}</p>\n                                </div>\n                              )}\n                            </div>\n\n                            {/* Parts Details */}\n                            {issue.partsRequired && (\n                              <div className=\"flex items-start gap-2 p-3 bg-[#0066CC]/5 rounded-xl border border-[#0066CC]/10\">\n                                <div className=\"w-7 h-7 rounded-lg bg-[#0066CC]/10 flex items-center justify-center shrink-0\">\n                                  <svg className=\"w-4 h-4 text-[#0066CC]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z\" />\n                                  </svg>\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <span className=\"inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-[#0066CC]/10 text-[#0066CC]\">\n                                    Parts Required\n                                  </span>\n                                  {issue.partsDetails && (\n                                    <p className=\"text-sm text-slate-600 mt-1\">{issue.partsDetails}</p>\n                                  )}\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Photos */}\n                            {issue.photos && issue.photos.length > 0 && (\n                              <div className=\"pt-2\">\n                                <p className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2\">\n                                  Photos ({issue.photos.length})\n                                </p>\n                                <div className=\"flex flex-wrap gap-2\">\n                                  {issue.photos.map((photo, idx) => (\n                                    <a key={idx} href={photo} target=\"_blank\" rel=\"noopener noreferrer\" className=\"group\">\n                                      <img\n                                        src={photo}\n                                        alt={`Issue photo ${idx + 1}`}\n                                        className=\"w-16 h-16 object-cover rounded-xl border-2 border-slate-200 group-hover:border-[#0066CC] group-hover:scale-105 transition-all\"\n                                      />\n                                    </a>\n                                  ))}\n                                </div>\n                              </div>\n                            )}\n                          </div>\n\n                          {/* Updates Accordion */}\n                          <div className=\"border-t border-slate-100\">\n                            <button\n                              className=\"w-full flex items-center justify-between px-4 py-2.5 text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors\"\n                              onClick={() => setExpandedIssues(prev => ({\n                                ...prev,\n                                [issue.id]: !prev[issue.id]\n                              }))}\n                            >\n                              <span className=\"flex items-center gap-2\">\n                                <svg className=\"w-4 h-4 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\n                                </svg>\n                                Updates {issue.updates?.length > 0 && `(${issue.updates.length})`}\n                              </span>\n                              <svg\n                                className={`w-4 h-4 text-slate-400 transition-transform duration-200 ${expandedIssues[issue.id] ? \"rotate-180\" : \"\"}`}\n                                fill=\"none\"\n                                stroke=\"currentColor\"\n                                viewBox=\"0 0 24 24\"\n                              >\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                              </svg>\n                            </button>\n\n                            {expandedIssues[issue.id] && (\n                              <div className=\"px-4 pb-4 space-y-3 bg-slate-50/50\">\n                                {/* Creation timestamp */}\n                                <div className=\"flex gap-3 text-xs\">\n                                  <div className=\"w-1 bg-slate-200 rounded-full\"></div>\n                                  <p className=\"text-slate-500\">\n                                    Created {formatDate(issue.createdAt)}\n                                  </p>\n                                </div>\n\n                                {/* Updates timeline */}\n                                {issue.updates && issue.updates.length > 0 ? (\n                                  issue.updates.map((update, idx) => (\n                                    <div key={idx} className=\"flex gap-3\">\n                                      <div className=\"w-1 bg-[#0066CC]/30 rounded-full\"></div>\n                                      <div className=\"flex-1 min-w-0\">\n                                        <div className=\"flex items-center gap-2 mb-1\">\n                                          <p className=\"text-sm font-semibold text-slate-700\">{update.userName || \"User\"}</p>\n                                          <span className=\"text-xs text-slate-400\">{formatDate(update.createdAt)}</span>\n                                        </div>\n                                        <p className=\"text-sm text-slate-600\">{update.content}</p>\n                                      </div>\n                                    </div>\n                                  ))\n                                ) : (\n                                  <p className=\"text-xs text-slate-400 text-center py-2\">No updates yet</p>\n                                )}\n\n                                {/* Add update input */}\n                                <div className=\"flex gap-2 pt-2\">\n                                  <input\n                                    type=\"text\"\n                                    className=\"flex-1 px-3 py-2 text-sm bg-white border border-slate-200 rounded-xl focus:border-[#0066CC] focus:ring-1 focus:ring-[#0066CC]/20 outline-none transition-all\"\n                                    placeholder=\"Add an update...\"\n                                    value={issueUpdateContent[issue.id] || \"\"}\n                                    onChange={(e) => setIssueUpdateContent(prev => ({\n                                      ...prev,\n                                      [issue.id]: e.target.value\n                                    }))}\n                                    onKeyPress={(e) => {\n                                      if (e.key === \"Enter\") {\n                                        addIssueUpdate(issue.id, issueUpdateContent[issue.id]);\n                                      }\n                                    }}\n                                  />\n                                  <button\n                                    className=\"px-4 py-2 bg-[#0066CC] hover:bg-[#0055AA] text-white text-sm font-medium rounded-xl transition-colors\"\n                                    onClick={() => addIssueUpdate(issue.id, issueUpdateContent[issue.id])}\n                                  >\n                                    Add\n                                  </button>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n\n                          {/* Actions Footer */}\n                          <div className=\"flex items-center justify-end gap-2 px-4 py-3 bg-slate-50/50 border-t border-slate-100\">\n                            <button\n                              className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-slate-600 hover:text-[#0066CC] hover:bg-[#0066CC]/5 rounded-lg transition-colors\"\n                              onClick={() => openEditIssue(issue)}\n                            >\n                              <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\n                              </svg>\n                              Edit\n                            </button>\n                            <button\n                              className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\n                              onClick={() => {\n                                if (confirm(\"Delete this issue?\")) deleteIssue(issue.id);\n                              }}\n                            >\n                              <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                              Delete\n                            </button>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center\">\n                      <div className=\"w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3\">\n                        <svg className=\"w-6 h-6 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                        </svg>\n                      </div>\n                      <p className=\"text-sm font-medium text-slate-600\">No issues recorded</p>\n                      <p className=\"text-xs text-slate-400 mt-1\">Add an issue to track problems with this vehicle</p>\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Documents Tab */}\n              {activeTab === \"documents\" && (\n                <div className=\"space-y-4\">\n                  <button\n                    className=\"btn btn-primary btn-sm w-full\"\n                    onClick={() => setShowAddDocumentModal(true)}\n                  >\n                    + Add Document/Image\n                  </button>\n\n                  {selectedVehicle.documents && selectedVehicle.documents.length > 0 ? (\n                    <div className=\"space-y-3\">\n                      {selectedVehicle.documents.map((doc) => (\n                        <div key={doc.id} className=\"card bg-base-200\">\n                          <div className=\"card-body p-4\">\n                            <div className=\"flex justify-between items-start\">\n                              <div className=\"flex-1\">\n                                <p className=\"text-sm font-medium\">{doc.name}</p>\n                                <span className=\"badge badge-sm mt-1\">\n                                  {doc.type === \"v5\" && \"V5\"}\n                                  {doc.type === \"service_history\" && \"Service History\"}\n                                  {doc.type === \"fault_codes\" && \"Fault Codes\"}\n                                  {doc.type === \"other\" && \"Other\"}\n                                </span>\n                              </div>\n                              <div className=\"flex gap-1\">\n                                <a\n                                  href={doc.url}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"btn btn-ghost btn-xs\"\n                                  onClick={(e) => e.stopPropagation()}\n                                >\n                                  View\n                                </a>\n                                <button\n                                  className=\"btn btn-ghost btn-xs text-error\"\n                                  onClick={() => {\n                                    if (confirm(\"Delete this document?\")) deleteDocument(doc.id);\n                                  }}\n                                >\n                                  Delete\n                                </button>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-8 text-base-content/60\">\n                      No documents uploaded\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Activity Tab */}\n              {activeTab === \"activity\" && (\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Activity Log</h3>\n\n                  {activityLoading && activityData.activities.length === 0 ? (\n                    <div className=\"flex justify-center py-8\">\n                      <div className=\"w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\n                    </div>\n                  ) : activityData.activities.length === 0 ? (\n                    <div className=\"text-center py-8 text-base-content/60\">\n                      No activity recorded yet\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {activityData.activities.map((activity) => (\n                        <div\n                          key={activity._id || activity.id}\n                          className=\"flex items-start gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100\"\n                        >\n                          <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${\n                            activity.type === \"VEHICLE_CREATED\" ? \"bg-green-100\" :\n                            activity.type === \"STATUS_CHANGED\" ? \"bg-blue-100\" :\n                            activity.type === \"TYPE_CHANGED\" ? \"bg-[#0066CC]/10\" :\n                            activity.type === \"LOCATION_CHANGED\" ? \"bg-[#0066CC]/10\" :\n                            activity.type === \"TASK_COMPLETED\" ? \"bg-emerald-100\" :\n                            activity.type === \"TASK_STATUS_UPDATED\" ? \"bg-amber-100\" :\n                            activity.type === \"TASK_PROGRESS_UPDATED\" ? \"bg-orange-100\" :\n                            activity.type === \"TASK_PARTS_STATUS_CHANGED\" || activity.type === \"TASK_PARTS_ORDER_ADDED\" ? \"bg-amber-100\" :\n                            activity.type === \"TASK_PARTS_ORDER_UPDATED\" ? \"bg-blue-100\" :\n                            activity.type === \"TASK_PARTS_ORDER_REMOVED\" ? \"bg-red-100\" :\n                            activity.type === \"TASK_ADDED\" || activity.type === \"TASK_DELETED\" ? \"bg-slate-100\" :\n                            activity.type === \"ISSUE_ADDED\" ? \"bg-red-100\" :\n                            activity.type === \"ISSUE_RESOLVED\" ? \"bg-green-100\" :\n                            activity.type === \"ISSUE_UPDATED\" || activity.type === \"ISSUE_COMMENT_ADDED\" ? \"bg-yellow-100\" :\n                            \"bg-slate-100\"\n                          }`}>\n                            {/* Vehicle lifecycle */}\n                            {activity.type === \"VEHICLE_CREATED\" && (\n                              <svg className=\"w-4 h-4 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"STATUS_CHANGED\" && (\n                              <svg className=\"w-4 h-4 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TYPE_CHANGED\" && (\n                              <svg className=\"w-4 h-4 text-[#0066CC]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                              </svg>\n                            )}\n                            {activity.type === \"LOCATION_CHANGED\" && (\n                              <svg className=\"w-4 h-4 text-[#0066CC]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"DETAILS_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-[#14B8A6]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\n                              </svg>\n                            )}\n                            {/* Task events */}\n                            {activity.type === \"TASK_COMPLETED\" && (\n                              <svg className=\"w-4 h-4 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_STATUS_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_PROGRESS_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-orange-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                              </svg>\n                            )}\n                            {(activity.type === \"TASK_ADDED\" || activity.type === \"TASK_UPDATED\") && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_DELETED\" && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                            )}\n                            {/* Parts ordering events */}\n                            {(activity.type === \"TASK_PARTS_STATUS_CHANGED\" || activity.type === \"TASK_PARTS_ORDER_ADDED\") && (\n                              <svg className=\"w-4 h-4 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_PARTS_ORDER_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_PARTS_ORDER_REMOVED\" && (\n                              <svg className=\"w-4 h-4 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                            )}\n                            {/* Issue events */}\n                            {activity.type === \"ISSUE_ADDED\" && (\n                              <svg className=\"w-4 h-4 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"ISSUE_RESOLVED\" && (\n                              <svg className=\"w-4 h-4 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                              </svg>\n                            )}\n                            {(activity.type === \"ISSUE_UPDATED\" || activity.type === \"ISSUE_COMMENT_ADDED\") && (\n                              <svg className=\"w-4 h-4 text-yellow-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"ISSUE_DELETED\" && (\n                              <svg className=\"w-4 h-4 text-red-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                            )}\n                            {/* Document events */}\n                            {(activity.type === \"DOC_UPLOADED\" || activity.type === \"DOC_DELETED\") && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                              </svg>\n                            )}\n                            {/* Fallback for any unhandled types */}\n                            {![\"VEHICLE_CREATED\", \"STATUS_CHANGED\", \"TYPE_CHANGED\", \"LOCATION_CHANGED\", \"DETAILS_UPDATED\",\n                               \"TASK_COMPLETED\", \"TASK_STATUS_UPDATED\", \"TASK_PROGRESS_UPDATED\", \"TASK_ADDED\", \"TASK_UPDATED\", \"TASK_DELETED\",\n                               \"TASK_PARTS_STATUS_CHANGED\", \"TASK_PARTS_ORDER_ADDED\", \"TASK_PARTS_ORDER_UPDATED\", \"TASK_PARTS_ORDER_REMOVED\",\n                               \"ISSUE_ADDED\", \"ISSUE_RESOLVED\", \"ISSUE_UPDATED\", \"ISSUE_COMMENT_ADDED\", \"ISSUE_DELETED\",\n                               \"DOC_UPLOADED\", \"DOC_DELETED\"].includes(activity.type) && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            )}\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm text-slate-900\">{activity.message}</p>\n                            <p className=\"text-xs text-slate-500 mt-0.5\">\n                              by {activity.actorName || \"Unknown\"} &middot; {formatRelativeTime(activity.createdAt)}\n                            </p>\n                          </div>\n                        </div>\n                      ))}\n\n                      {activityData.hasMore && (\n                        <button\n                          onClick={() => fetchActivity(selectedVehicle.id, true)}\n                          disabled={activityLoading}\n                          className=\"w-full btn btn-ghost btn-sm text-slate-600\"\n                        >\n                          {activityLoading ? (\n                            <span className=\"flex items-center gap-2\">\n                              <div className=\"w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin\"></div>\n                              Loading...\n                            </span>\n                          ) : (\n                            \"Load more\"\n                          )}\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Drag Preview - floating card that follows cursor */}\n      {draggedCard && (\n        <div\n          className=\"fixed pointer-events-none z-50\"\n          style={{\n            left: dragPosition.x - 120,\n            top: dragPosition.y - 30,\n            transform: \"rotate(3deg)\",\n          }}\n        >\n          <div className=\"bg-white rounded-xl shadow-2xl border-2 border-blue-400 w-60 p-3 opacity-90\">\n            <div className=\"flex items-center gap-2\">\n              <p className=\"font-bold text-slate-900 text-sm truncate\">\n                {draggedCard.year} {draggedCard.make} {draggedCard.model}\n              </p>\n            </div>\n            <span className=\"font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md inline-block mt-1\">\n              {draggedCard.regCurrent}\n            </span>\n          </div>\n        </div>\n      )}\n\n      {showAddModal && (\n        <AddVehicleModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchVehicles(); }} />\n      )}\n\n      {showAddIssueModal && (\n        <AddIssueModal\n          issueForm={issueForm}\n          setIssueForm={setIssueForm}\n          isEditing={!!editingIssue}\n          onClose={() => {\n            setShowAddIssueModal(false);\n            setEditingIssue(null);\n            setIssueForm({\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              priority: \"medium\",\n              location: \"\",\n              status: \"outstanding\",\n              notes: \"\",\n              photos: [],\n              partsRequired: false,\n              partsDetails: \"\",\n            });\n          }}\n          onSubmit={editingIssue ? saveEditedIssue : addIssue}\n        />\n      )}\n\n      {showAddDocumentModal && (\n        <AddDocumentModal\n          documentForm={documentForm}\n          setDocumentForm={setDocumentForm}\n          onClose={() => {\n            setShowAddDocumentModal(false);\n            setDocumentForm({ name: \"\", type: \"other\", file: null });\n          }}\n          onSubmit={() => {\n            if (!documentForm.file) {\n              return toast.error(\"File is required\");\n            }\n            if (documentForm.type === \"other\" && !documentForm.name) {\n              return toast.error(\"Document name is required for 'Other' type\");\n            }\n            // Generate default name based on type if not \"other\"\n            const docName = documentForm.type === \"other\"\n              ? documentForm.name\n              : documentForm.type.replace(/_/g, \" \").replace(/\\b\\w/g, l => l.toUpperCase());\n            uploadDocument(documentForm.file, docName, documentForm.type);\n          }}\n        />\n      )}\n\n      {showAddLocationModal && (\n        <AddLocationModal\n          onClose={() => setShowAddLocationModal(false)}\n          onSuccess={(newLocation) => {\n            setLocations([...locations, newLocation]);\n            setSelectedVehicle({ ...selectedVehicle, locationId: newLocation.id || newLocation._id });\n            fetch(`/api/vehicles/${selectedVehicle.id}`, {\n              method: \"PUT\",\n              headers: { \"Content-Type\": \"application/json\" },\n              body: JSON.stringify({ locationId: newLocation.id || newLocation._id }),\n            }).then(() => {\n              fetchVehicles();\n              setShowAddLocationModal(false);\n            });\n          }}\n        />\n      )}\n\n      {/* Parts Order Modal */}\n      {showPartsOrderModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">\n                {editingPartsOrderId ? \"Edit Parts Order\" : \"Add Parts Order\"}\n              </h3>\n              <button\n                onClick={closePartsOrderModal}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Supplier</span>\n                </label>\n                <select\n                  className=\"select select-bordered w-full\"\n                  value={partsOrderForm.supplierType}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, supplierType: e.target.value })}\n                >\n                  <option value=\"EURO_CAR_PARTS\">Euro Car Parts</option>\n                  <option value=\"TPS\">TPS</option>\n                  <option value=\"MAIN_DEALER\">Main Dealer</option>\n                  <option value=\"LOCAL_FACTOR\">Local Factor</option>\n                  <option value=\"ONLINE\">Online</option>\n                  <option value=\"OTHER\">Other</option>\n                </select>\n              </div>\n              {partsOrderForm.supplierType === \"OTHER\" && (\n                <div className=\"form-control\">\n                  <label className=\"label\">\n                    <span className=\"label-text font-medium\">Supplier Name</span>\n                  </label>\n                  <input\n                    type=\"text\"\n                    placeholder=\"Enter supplier name\"\n                    className=\"input input-bordered w-full\"\n                    value={partsOrderForm.supplierName}\n                    onChange={(e) => setPartsOrderForm({ ...partsOrderForm, supplierName: e.target.value })}\n                  />\n                </div>\n              )}\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Order Reference (Optional)</span>\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"e.g., ORD-123456\"\n                  className=\"input input-bordered w-full\"\n                  value={partsOrderForm.orderRef}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, orderRef: e.target.value })}\n                />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Expected Delivery (Optional)</span>\n                </label>\n                <input\n                  type=\"date\"\n                  className=\"input input-bordered w-full\"\n                  value={partsOrderForm.expectedAt}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, expectedAt: e.target.value })}\n                />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Notes (Optional)</span>\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"e.g., Oil filter + air filter\"\n                  className=\"input input-bordered w-full\"\n                  value={partsOrderForm.notes}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, notes: e.target.value })}\n                />\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2 p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={closePartsOrderModal}\n              >\n                Cancel\n              </button>\n              <button\n                className=\"btn btn-primary\"\n                onClick={editingPartsOrderId ? updatePartsOrder : addPartsOrder}\n              >\n                {editingPartsOrderId ? \"Update\" : \"Add Order\"}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Add Label Modal */}\n      {showAddLabelModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Create New Label</h3>\n              <button\n                onClick={() => {\n                  setShowAddLabelModal(false);\n                  setNewLabelForm({ name: \"\", colour: \"#6366f1\" });\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Label Name</span>\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"e.g., Hot Lead, Awaiting Finance\"\n                  className=\"input input-bordered w-full\"\n                  value={newLabelForm.name}\n                  onChange={(e) => setNewLabelForm({ ...newLabelForm, name: e.target.value })}\n                  autoFocus\n                />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Colour</span>\n                </label>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"color\"\n                    className=\"w-12 h-10 rounded cursor-pointer border border-slate-300\"\n                    value={newLabelForm.colour}\n                    onChange={(e) => setNewLabelForm({ ...newLabelForm, colour: e.target.value })}\n                  />\n                  <div className=\"flex gap-2\">\n                    {[\"#ef4444\", \"#f59e0b\", \"#22c55e\", \"#3b82f6\", \"#8b5cf6\", \"#ec4899\", \"#6b7280\"].map(color => (\n                      <button\n                        key={color}\n                        type=\"button\"\n                        onClick={() => setNewLabelForm({ ...newLabelForm, colour: color })}\n                        className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${newLabelForm.colour === color ? 'border-slate-900 scale-110' : 'border-transparent'}`}\n                        style={{ backgroundColor: color }}\n                      />\n                    ))}\n                  </div>\n                </div>\n              </div>\n              {/* Preview */}\n              {newLabelForm.name && (\n                <div className=\"pt-2\">\n                  <label className=\"label\">\n                    <span className=\"label-text font-medium\">Preview</span>\n                  </label>\n                  <span\n                    className=\"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold\"\n                    style={{\n                      backgroundColor: `${newLabelForm.colour}20`,\n                      color: newLabelForm.colour,\n                    }}\n                  >\n                    <span className=\"w-2 h-2 rounded-full\" style={{ backgroundColor: newLabelForm.colour }}></span>\n                    {newLabelForm.name}\n                  </span>\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end gap-2 p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowAddLabelModal(false);\n                  setNewLabelForm({ name: \"\", colour: \"#6366f1\" });\n                }}\n              >\n                Cancel\n              </button>\n              <button\n                className=\"btn btn-primary\"\n                onClick={createLabel}\n                disabled={!newLabelForm.name.trim()}\n              >\n                Create Label\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Job Sheet Share Modal */}\n      {showJobSheetModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Share Job Sheet</h3>\n              <button\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4\">\n              {isGeneratingJobSheet ? (\n                <div className=\"flex flex-col items-center py-8\">\n                  <div className=\"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3\"></div>\n                  <p className=\"text-slate-600\">Generating share link...</p>\n                </div>\n              ) : jobSheetLink ? (\n                <div className=\"space-y-4\">\n                  <div className=\"bg-slate-50 rounded-lg p-3\">\n                    <p className=\"text-xs text-slate-500 mb-1\">Shareable Link</p>\n                    <p className=\"text-sm font-mono text-slate-900 break-all\">{jobSheetLink}</p>\n                  </div>\n                  <p className=\"text-xs text-slate-500\">\n                    This link expires in 60 days. Anyone with this link can view the job sheet.\n                  </p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      onClick={copyJobSheetLink}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      Copy Link\n                    </button>\n                    <button\n                      onClick={shareViaWhatsApp}\n                      className=\"btn btn-success btn-sm gap-2 text-white\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\n                      </svg>\n                      WhatsApp\n                    </button>\n                    <button\n                      onClick={() => {\n                        const subject = `Job Sheet - ${selectedVehicle?.regCurrent || 'Vehicle'}`;\n                        const body = `Here is the job sheet for ${selectedVehicle?.regCurrent || 'the vehicle'}:\\n\\n${jobSheetLink}`;\n                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);\n                      }}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n                      </svg>\n                      Email\n                    </button>\n                    <button\n                      onClick={() => window.open(jobSheetLink, '_blank')}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                      </svg>\n                      Print / PDF\n                    </button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  No link generated yet\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Prep Summary Share Modal */}\n      {showPrepSummaryModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Prep Summary PDF</h3>\n              <button\n                onClick={() => {\n                  setShowPrepSummaryModal(false);\n                  setPrepSummaryLink(null);\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4\">\n              {isGeneratingPrepSummary ? (\n                <div className=\"flex flex-col items-center py-8\">\n                  <div className=\"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3\"></div>\n                  <p className=\"text-slate-600\">Generating prep summary...</p>\n                </div>\n              ) : prepSummaryLink ? (\n                <div className=\"space-y-4\">\n                  <div className=\"bg-slate-50 rounded-lg p-3\">\n                    <p className=\"text-xs text-slate-500 mb-1\">Shareable Link</p>\n                    <p className=\"text-sm font-mono text-slate-900 break-all\">{prepSummaryLink.url}</p>\n                  </div>\n                  <p className=\"text-xs text-slate-500\">\n                    This link expires in 60 days. Click Print/PDF to save a PDF of the prep summary.\n                  </p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      onClick={copyPrepSummaryLink}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      Copy Link\n                    </button>\n                    <button\n                      onClick={sharePrepSummaryViaWhatsApp}\n                      className=\"btn btn-success btn-sm gap-2 text-white\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\n                      </svg>\n                      WhatsApp\n                    </button>\n                    <button\n                      onClick={() => {\n                        const subject = `Prep Summary - ${selectedVehicle?.regCurrent || 'Vehicle'}`;\n                        const body = `Here is the prep summary for ${selectedVehicle?.regCurrent || 'the vehicle'}:\\n\\n${prepSummaryLink.url}`;\n                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);\n                      }}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n                      </svg>\n                      Email\n                    </button>\n                    <button\n                      onClick={() => window.open(prepSummaryLink.url, '_blank')}\n                      className=\"btn btn-primary btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                      </svg>\n                      Print / PDF\n                    </button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  No link generated yet\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowPrepSummaryModal(false);\n                  setPrepSummaryLink(null);\n                }}\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Manual Share Fallback Modal */}\n      {showManualShareModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\n          <div className=\"bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Share Link</h3>\n              <button\n                onClick={() => {\n                  setShowManualShareModal(false);\n                  setManualShareUrl(\"\");\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <p className=\"text-sm text-slate-600\">\n                Copy the link below to share:\n              </p>\n              <div className=\"bg-slate-50 rounded-lg p-3 relative\">\n                <input\n                  type=\"text\"\n                  value={manualShareUrl}\n                  readOnly\n                  className=\"w-full bg-transparent text-sm font-mono text-slate-900 border-none focus:outline-none pr-10\"\n                  onClick={(e) => e.target.select()}\n                />\n                <button\n                  onClick={async () => {\n                    try {\n                      await navigator.clipboard.writeText(manualShareUrl);\n                      toast.success(\"Link copied!\");\n                    } catch {\n                      // If clipboard still fails, user can manually copy\n                      toast.info(\"Select and copy the link manually\");\n                    }\n                  }}\n                  className=\"absolute right-2 top-1/2 -translate-y-1/2 p-2 hover:bg-slate-200 rounded transition-colors\"\n                  title=\"Copy to clipboard\"\n                >\n                  <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                  </svg>\n                </button>\n              </div>\n              <p className=\"text-xs text-slate-500\">\n                Click the link to select it, then use Ctrl+C (or Cmd+C on Mac) to copy.\n              </p>\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-primary\"\n                onClick={() => {\n                  setShowManualShareModal(false);\n                  setManualShareUrl(\"\");\n                }}\n              >\n                Done\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </DashboardLayout>\n  );\n}\n\nfunction AddVehicleModal({ onClose, onSuccess }) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [locations, setLocations] = useState([]);\n  const [prepTemplates, setPrepTemplates] = useState([]);\n  const [formData, setFormData] = useState({\n    regCurrent: \"\", make: \"\", model: \"\", year: \"\", mileageCurrent: \"\",\n    fuelType: \"\", transmission: \"\", colour: \"\", notes: \"\", locationId: \"\",\n    motExpiryDate: \"\", // MOT expiry date (autofilled from lookup or manual entry)\n    engineCapacity: \"\", // Engine capacity in cc (autofilled from lookup or manual entry)\n    type: \"STOCK\", // STOCK, COURTESY, FLEET_OTHER\n    saleType: \"RETAIL\", // RETAIL, TRADE - only used when type is STOCK\n    dvlaDetails: null, // DVLA VES extended details\n    lastDvlaFetchAt: null, // When DVLA lookup was performed\n  });\n\n  // Appraisal lookup state\n  const [matchedAppraisal, setMatchedAppraisal] = useState(null);\n  const [isCheckingAppraisal, setIsCheckingAppraisal] = useState(false);\n  const [appraisalDismissed, setAppraisalDismissed] = useState(false);\n\n  // VRM appraisal suggestions\n  const [appraisalSuggestions, setAppraisalSuggestions] = useState([]);\n  const [showAppraisalDropdown, setShowAppraisalDropdown] = useState(false);\n  const [isSearchingAppraisals, setIsSearchingAppraisals] = useState(false);\n\n  // Document uploads\n  const [v5File, setV5File] = useState(null);\n  const [serviceHistoryFile, setServiceHistoryFile] = useState(null);\n  const [faultCodesFile, setFaultCodesFile] = useState(null);\n  const [otherDocuments, setOtherDocuments] = useState([]);\n\n  // Initial issues (array of issues to create with the vehicle)\n  const [initialIssues, setInitialIssues] = useState([]);\n  const [showAddIssueInVehicleModal, setShowAddIssueInVehicleModal] = useState(false);\n  const [newIssueForm, setNewIssueForm] = useState({\n    category: \"\",\n    subcategory: \"\",\n    description: \"\",\n    actionNeeded: \"\",\n    status: \"Outstanding\",\n    notes: \"\",\n    photos: [],\n  });\n\n  // Prep checklist template\n  const [selectedTemplate, setSelectedTemplate] = useState(\"default\");\n\n  useEffect(() => {\n    fetchLocations();\n    fetchPrepTemplates();\n  }, []);\n\n  const fetchLocations = async () => {\n    try {\n      const res = await fetch(\"/api/locations\");\n      const data = await res.json();\n      setLocations(data);\n    } catch (error) {\n      console.error(\"Failed to fetch locations\");\n    }\n  };\n\n  const fetchPrepTemplates = async () => {\n    try {\n      const res = await fetch(\"/api/prep-tasks\");\n      const data = await res.json();\n      setPrepTemplates(data);\n      // Auto-select first template if available\n      if (data.length > 0) setSelectedTemplate(\"default\");\n    } catch (error) {\n      console.error(\"Failed to fetch prep templates\");\n    }\n  };\n\n  // Search unconverted appraisals as user types VRM\n  const searchAppraisals = async (vrm) => {\n    if (!vrm || vrm.length < 2) {\n      setAppraisalSuggestions([]);\n      setShowAppraisalDropdown(false);\n      return;\n    }\n    setIsSearchingAppraisals(true);\n    try {\n      const res = await fetch(`/api/appraisals/search-unconverted?q=${encodeURIComponent(vrm)}`);\n      if (res.ok) {\n        const results = await res.json();\n        setAppraisalSuggestions(results);\n        setShowAppraisalDropdown(results.length > 0);\n      } else {\n        setAppraisalSuggestions([]);\n        setShowAppraisalDropdown(false);\n      }\n    } catch (error) {\n      setAppraisalSuggestions([]);\n      setShowAppraisalDropdown(false);\n    } finally {\n      setIsSearchingAppraisals(false);\n    }\n  };\n\n  // Handle selecting an appraisal from suggestions\n  const handleSelectAppraisalSuggestion = (appraisal) => {\n    setFormData(prev => ({\n      ...prev,\n      regCurrent: appraisal.vehicleReg || prev.regCurrent,\n      make: appraisal.vehicleMake || prev.make,\n      model: appraisal.vehicleModel || prev.model,\n      year: appraisal.vehicleYear || prev.year,\n      mileageCurrent: appraisal.mileage || prev.mileageCurrent,\n    }));\n    setMatchedAppraisal(appraisal);\n    setAppraisalDismissed(false);\n    setShowAppraisalDropdown(false);\n    setAppraisalSuggestions([]);\n    toast.success(`Loaded appraisal for ${appraisal.vehicleReg}`);\n  };\n\n  // Check for existing appraisal when VRM changes\n  const checkForAppraisal = async (vrm) => {\n    if (!vrm || vrm.length < 2) {\n      setMatchedAppraisal(null);\n      return;\n    }\n    setIsCheckingAppraisal(true);\n    try {\n      const res = await fetch(`/api/appraisals/by-vrm?vrm=${encodeURIComponent(vrm)}`);\n      if (res.ok) {\n        const appraisal = await res.json();\n        setMatchedAppraisal(appraisal);\n        setAppraisalDismissed(false);\n      } else {\n        setMatchedAppraisal(null);\n      }\n    } catch (error) {\n      setMatchedAppraisal(null);\n    } finally {\n      setIsCheckingAppraisal(false);\n    }\n  };\n\n  // Import data from matched appraisal\n  const importFromAppraisal = () => {\n    if (!matchedAppraisal) return;\n    setFormData(prev => ({\n      ...prev,\n      regCurrent: matchedAppraisal.vehicleReg || prev.regCurrent,\n      make: matchedAppraisal.vehicleMake || prev.make,\n      model: matchedAppraisal.vehicleModel || prev.model,\n      year: matchedAppraisal.vehicleYear || prev.year,\n      mileageCurrent: matchedAppraisal.mileage || prev.mileageCurrent,\n      notes: matchedAppraisal.conditionNotes || prev.notes,\n    }));\n    setAppraisalDismissed(true);\n    toast.success(\"Imported data from appraisal\");\n  };\n\n  // Convert appraisal directly to stock (uses the convert API)\n  const convertAppraisalToStock = async () => {\n    if (!matchedAppraisal) return;\n    setIsLoading(true);\n    try {\n      // Determine the API endpoint based on appraisal type\n      const endpoint = matchedAppraisal.type === \"customer_px\"\n        ? `/api/customer-px/${matchedAppraisal.id}/convert`\n        : `/api/appraisals/${matchedAppraisal.id}/convert`;\n\n      const res = await fetch(endpoint, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ initialStatus: \"in_stock\" }),\n      });\n\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to convert appraisal\");\n      }\n\n      toast.success(\"Appraisal converted to stock!\");\n      onSuccess();\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleLookup = async () => {\n    if (!formData.regCurrent) return toast.error(\"Enter registration first\");\n    setIsLookingUp(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: formData.regCurrent }),\n      });\n      const data = await res.json();\n\n      // Check for error response\n      if (!res.ok || data.error) {\n        toast.error(data.message || data.error || \"Vehicle not found\");\n        return;\n      }\n\n      if (data.isDummy) showDummyNotification(\"DVLA API\");\n\n      // Update form with DVLA data\n      setFormData(prev => ({\n        ...prev,\n        make: data.make || prev.make,\n        model: data.model || prev.model,\n        year: data.yearOfManufacture || data.year || prev.year,\n        colour: data.colour || prev.colour,\n        fuelType: data.fuelType || prev.fuelType,\n        transmission: data.transmission || prev.transmission,\n        motExpiryDate: data.motExpiryDate || prev.motExpiryDate,\n        // Engine capacity from DVLA (in cc)\n        engineCapacity: data.engineCapacity || data.dvlaDetails?.engineCapacity || prev.engineCapacity,\n        // Store full DVLA details for API persistence\n        dvlaDetails: data.dvlaDetails || null,\n        lastDvlaFetchAt: data.lastDvlaFetchAt || null,\n      }));\n\n      toast.success(`Found: ${data.make} ${data.model || \"\"} (${data.yearOfManufacture || \"\"})`);\n    } catch (error) {\n      toast.error(\"Lookup failed - please try again\");\n    } finally {\n      setIsLookingUp(false);\n    }\n  };\n\n  const uploadFile = async (file) => {\n    if (!file) return null;\n    const formData = new FormData();\n    formData.append(\"file\", file);\n    const res = await fetch(\"/api/vehicles/upload\", {\n      method: \"POST\",\n      body: formData,\n    });\n    if (!res.ok) throw new Error(\"Upload failed\");\n    const data = await res.json();\n    // Store S3 key (permanent) if available, otherwise use URL (for local dev)\n    return data.key || data.url;\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    if (!formData.regCurrent || !formData.make || !formData.model) {\n      return toast.error(\"Reg, make and model are required\");\n    }\n    setIsLoading(true);\n    try {\n      // Create vehicle first\n      // If \"None\" is selected, skip default tasks\n      // If \"default\" is selected, create default tasks (don't skip)\n      const skipDefault = selectedTemplate === \"\";\n      const vehicleRes = await fetch(\"/api/vehicles\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ ...formData, skipDefaultTasks: skipDefault }),\n      });\n      if (!vehicleRes.ok) {\n        const errorData = await vehicleRes.json();\n        throw new Error(errorData.error || \"Failed to create vehicle\");\n      }\n      const vehicle = await vehicleRes.json();\n\n      // Upload documents\n      if (v5File) {\n        const v5Url = await uploadFile(v5File);\n        await fetch(`/api/vehicles/${vehicle.id}`, {\n          method: \"PUT\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ v5Url }),\n        });\n      }\n\n      if (serviceHistoryFile) {\n        const url = await uploadFile(serviceHistoryFile);\n        await fetch(`/api/vehicles/${vehicle.id}/documents`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ name: \"Service History\", type: \"service_history\", url }),\n        });\n      }\n\n      if (faultCodesFile) {\n        const url = await uploadFile(faultCodesFile);\n        await fetch(`/api/vehicles/${vehicle.id}/documents`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ name: \"Fault Codes\", type: \"fault_codes\", url }),\n        });\n      }\n\n      // Upload other documents\n      for (const doc of otherDocuments) {\n        if (doc.file) {\n          const url = await uploadFile(doc.file);\n          await fetch(`/api/vehicles/${vehicle.id}/documents`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ name: doc.name || \"Document\", type: \"other\", url }),\n          });\n        }\n      }\n\n      // Create initial issues from the array\n      for (const issue of initialIssues) {\n        await fetch(`/api/vehicles/${vehicle.id}/issues`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            category: issue.category,\n            subcategory: issue.subcategory,\n            description: issue.description,\n            actionNeeded: issue.actionNeeded,\n            status: issue.status || \"Outstanding\",\n            notes: issue.notes,\n          }),\n        });\n      }\n\n      // Create prep tasks based on template\n      // Only create from prepTemplates if a custom template is selected (not \"default\" which is handled by API)\n      if (selectedTemplate && selectedTemplate !== \"default\" && prepTemplates.length > 0) {\n        for (const template of prepTemplates) {\n          await fetch(`/api/vehicles/${vehicle.id}/tasks`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ name: template.name }),\n          });\n        }\n      }\n\n      // Link appraisal to vehicle if one was matched\n      if (matchedAppraisal && matchedAppraisal.id) {\n        await fetch(`/api/appraisals/${matchedAppraisal.id}`, {\n          method: \"PATCH\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            decision: \"converted\",\n            vehicleId: vehicle.id,\n            decidedAt: new Date(),\n          }),\n        });\n      }\n\n      toast.success(\"Vehicle added!\");\n      onSuccess();\n    } catch (error) {\n      console.error(\"Error:\", error);\n      toast.error(error.message);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box max-w-4xl max-h-[90vh] overflow-y-auto bg-white\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h3 className=\"text-xl font-bold text-slate-900\">Add Vehicle</h3>\n          <button\n            type=\"button\"\n            onClick={onClose}\n            className=\"p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200\"\n          >\n            <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n            </svg>\n          </button>\n        </div>\n        <form onSubmit={handleSubmit}>\n          {/* Vehicle Details Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Vehicle Details</h4>\n            <div className=\"relative flex gap-2 mb-4\">\n              <div className=\"relative flex-1\">\n                <input\n                  type=\"text\"\n                  placeholder=\"Registration\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg uppercase font-mono text-slate-900 placeholder-slate-400 focus:bg-white focus:border-transparent focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  value={formData.regCurrent}\n                  onChange={(e) => {\n                    const newValue = e.target.value.toUpperCase();\n                    setFormData({ ...formData, regCurrent: newValue });\n                    searchAppraisals(newValue);\n                  }}\n                  onFocus={() => {\n                    if (appraisalSuggestions.length > 0) setShowAppraisalDropdown(true);\n                  }}\n                  onBlur={(e) => {\n                    // Delay hiding dropdown so click on suggestion can register\n                    setTimeout(() => setShowAppraisalDropdown(false), 200);\n                    checkForAppraisal(e.target.value);\n                  }}\n                />\n                {isSearchingAppraisals && (\n                  <span className=\"absolute right-3 top-1/2 -translate-y-1/2 loading loading-spinner loading-sm\"></span>\n                )}\n                {/* Appraisal Suggestions Dropdown */}\n                {showAppraisalDropdown && appraisalSuggestions.length > 0 && (\n                  <div className=\"absolute top-full left-0 right-0 z-50 mt-1 bg-base-100 border border-base-300 rounded-lg shadow-xl max-h-64 overflow-y-auto\">\n                    <div className=\"px-3 py-2 text-xs text-base-content/60 border-b border-base-200 bg-base-200/50\">\n                      Unconverted Appraisals\n                    </div>\n                    {appraisalSuggestions.map((appraisal) => (\n                      <button\n                        key={appraisal.id}\n                        type=\"button\"\n                        className=\"w-full px-3 py-2 text-left hover:bg-base-200 border-b border-base-200 last:border-b-0 flex items-center gap-3\"\n                        onClick={() => handleSelectAppraisalSuggestion(appraisal)}\n                      >\n                        <div className=\"flex-1\">\n                          <div className=\"font-mono font-bold\">{appraisal.vehicleReg}</div>\n                          <div className=\"text-sm text-base-content/70\">\n                            {appraisal.vehicleMake} {appraisal.vehicleModel} {appraisal.vehicleYear ? `(${appraisal.vehicleYear})` : \"\"}\n                          </div>\n                        </div>\n                        <span className={`badge badge-sm ${appraisal.type === \"dealer\" ? \"badge-primary\" : \"badge-secondary\"}`}>\n                          {appraisal.type === \"dealer\" ? \"Dealer\" : \"Customer PX\"}\n                        </span>\n                      </button>\n                    ))}\n                  </div>\n                )}\n              </div>\n              <button\n                type=\"button\"\n                className=\"px-5 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-2\"\n                onClick={handleLookup}\n                disabled={isLookingUp}\n              >\n                {isLookingUp ? <span className=\"loading loading-spinner loading-sm\"></span> : <><span>🔍</span><span>Lookup</span></>}\n              </button>\n            </div>\n\n            {/* Appraisal Match Alert */}\n            {isCheckingAppraisal && (\n              <div className=\"alert mb-4\">\n                <span className=\"loading loading-spinner loading-sm\"></span>\n                <span>Checking for existing appraisals...</span>\n              </div>\n            )}\n            {matchedAppraisal && !appraisalDismissed && (\n              <div className=\"alert alert-success mb-4\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5 shrink-0\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n                <div className=\"flex-1\">\n                  <p className=\"font-semibold\">\n                    {matchedAppraisal.type === \"customer_px\" ? \"Customer PX\" : \"Dealer\"} Appraisal Found: {matchedAppraisal.vehicleReg}\n                  </p>\n                  <p className=\"text-sm opacity-80\">\n                    {matchedAppraisal.vehicleMake} {matchedAppraisal.vehicleModel} {matchedAppraisal.vehicleYear ? `(${matchedAppraisal.vehicleYear})` : \"\"}\n                    {matchedAppraisal.mileage ? ` • ${matchedAppraisal.mileage.toLocaleString()} miles` : \"\"}\n                  </p>\n                </div>\n                <div className=\"flex flex-col sm:flex-row gap-2\">\n                  <button type=\"button\" className=\"btn btn-sm btn-primary\" onClick={convertAppraisalToStock} disabled={isLoading}>\n                    {isLoading ? <span className=\"loading loading-spinner loading-sm\"></span> : \"Convert to Stock\"}\n                  </button>\n                  <button type=\"button\" className=\"btn btn-sm btn-ghost\" onClick={importFromAppraisal}>\n                    Import Data Only\n                  </button>\n                  <button type=\"button\" className=\"btn btn-sm btn-ghost\" onClick={() => setAppraisalDismissed(true)}>\n                    Dismiss\n                  </button>\n                </div>\n              </div>\n            )}\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Make *</label>\n                <input type=\"text\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.make}\n                  onChange={(e) => setFormData({ ...formData, make: e.target.value })} required />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Model *</label>\n                <input type=\"text\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.model}\n                  onChange={(e) => setFormData({ ...formData, model: e.target.value })} required />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Year</label>\n                <input type=\"number\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.year}\n                  onChange={(e) => setFormData({ ...formData, year: e.target.value })} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Mileage</label>\n                <input type=\"number\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.mileageCurrent}\n                  onChange={(e) => setFormData({ ...formData, mileageCurrent: e.target.value })} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Colour</label>\n                <input type=\"text\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.colour}\n                  onChange={(e) => setFormData({ ...formData, colour: e.target.value })} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Fuel Type</label>\n                <select className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\" value={formData.fuelType?.toUpperCase() || \"\"}\n                  onChange={(e) => setFormData({ ...formData, fuelType: e.target.value })}>\n                  <option value=\"\">Select...</option>\n                  <option value=\"PETROL\">Petrol</option>\n                  <option value=\"DIESEL\">Diesel</option>\n                  <option value=\"HYBRID\">Hybrid</option>\n                  <option value=\"ELECTRIC\">Electric</option>\n                  <option value=\"LPG\">LPG</option>\n                  <option value=\"CNG\">CNG</option>\n                </select>\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">MOT Expiry Date</label>\n                <input\n                  type=\"date\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  value={formData.motExpiryDate ? formData.motExpiryDate.split(\"T\")[0] : \"\"}\n                  onChange={(e) => setFormData({ ...formData, motExpiryDate: e.target.value })}\n                />\n                <p className=\"text-xs text-slate-400 mt-1.5\">\n                  {formData.motExpiryDate ? \"\" : \"Auto-filled by VRM lookup or enter manually\"}\n                </p>\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Transmission</label>\n                <select className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\" value={formData.transmission?.toUpperCase() || \"\"}\n                  onChange={(e) => setFormData({ ...formData, transmission: e.target.value })}>\n                  <option value=\"\">Select...</option>\n                  <option value=\"MANUAL\">Manual</option>\n                  <option value=\"AUTOMATIC\">Automatic</option>\n                  <option value=\"SEMI-AUTO\">Semi-Auto</option>\n                  <option value=\"CVT\">CVT</option>\n                </select>\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Engine Capacity (cc)</label>\n                <input\n                  type=\"number\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  placeholder=\"e.g., 1500\"\n                  value={formData.engineCapacity || \"\"}\n                  onChange={(e) => setFormData({ ...formData, engineCapacity: e.target.value })}\n                />\n                <p className=\"text-xs text-slate-400 mt-1.5\">\n                  {formData.engineCapacity ? \"\" : \"Auto-filled by VRM lookup\"}\n                </p>\n              </div>\n            </div>\n          </div>\n\n          {/* Vehicle Type Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Vehicle Type</h4>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Vehicle Type</label>\n                <select\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                  value={formData.type}\n                  onChange={(e) => {\n                    const newType = e.target.value;\n                    setFormData({\n                      ...formData,\n                      type: newType,\n                      // Clear saleType if not Stock\n                      saleType: newType === \"STOCK\" ? (formData.saleType || \"RETAIL\") : undefined\n                    });\n                  }}\n                >\n                  <option value=\"STOCK\">Stock - For sale</option>\n                  <option value=\"COURTESY\">Courtesy - Loan vehicle</option>\n                  <option value=\"FLEET_OTHER\">Fleet/Other - Company vehicle</option>\n                </select>\n              </div>\n              {/* Sale Type - Only show for Stock vehicles */}\n              {formData.type === \"STOCK\" && (\n                <div className=\"form-control\">\n                  <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Sale Type</label>\n                  <select\n                    className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                    value={formData.saleType || \"RETAIL\"}\n                    onChange={(e) => setFormData({ ...formData, saleType: e.target.value })}\n                  >\n                    <option value=\"RETAIL\">Retail - Customer sale</option>\n                    <option value=\"TRADE\">Trade - Dealer sale</option>\n                  </select>\n                </div>\n              )}\n            </div>\n            <p className=\"text-xs text-slate-400 mt-3\">\n              {formData.type === \"COURTESY\" && \"This vehicle will be available in courtesy car forms\"}\n              {formData.type === \"FLEET_OTHER\" && \"This vehicle will not appear in sales board\"}\n              {formData.type === \"STOCK\" && formData.saleType === \"TRADE\" && \"Trade vehicles are marked separately and can be filtered\"}\n              {formData.type === \"STOCK\" && formData.saleType !== \"TRADE\" && \"This vehicle will go through the normal sales prep flow\"}\n            </p>\n          </div>\n\n          {/* Location Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Location</h4>\n            <div className=\"form-control\">\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={formData.locationId}\n                onChange={(e) => setFormData({ ...formData, locationId: e.target.value })}\n              >\n                <option value=\"\">On Site</option>\n                {locations.map(loc => (\n                  <option key={loc.id} value={loc.id}>{loc.name}</option>\n                ))}\n              </select>\n            </div>\n          </div>\n\n          {/* Document Uploads Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Document Uploads (Optional)</h4>\n            <div className=\"space-y-4\">\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">V5 Document</label>\n                <input type=\"file\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" accept=\"image/*,.pdf\"\n                  onChange={(e) => setV5File(e.target.files[0])} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Service History</label>\n                <input type=\"file\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" accept=\"image/*,.pdf\"\n                  onChange={(e) => setServiceHistoryFile(e.target.files[0])} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Fault Codes</label>\n                <input type=\"file\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" accept=\"image/*,.pdf\"\n                  onChange={(e) => setFaultCodesFile(e.target.files[0])} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Other Documents</label>\n                <button\n                  type=\"button\"\n                  className=\"px-4 py-2.5 bg-slate-50 border border-slate-200 hover:border-slate-300 hover:bg-slate-100 text-slate-700 text-sm font-medium rounded-lg transition-all duration-200\"\n                  onClick={() => setOtherDocuments([...otherDocuments, { name: \"\", file: null }])}\n                >\n                  + Add Document/Image\n                </button>\n                {otherDocuments.map((doc, idx) => (\n                  <div key={idx} className=\"flex gap-2 mt-3\">\n                    <input\n                      type=\"text\"\n                      placeholder=\"Document name\"\n                      className=\"flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 text-sm placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                      value={doc.name}\n                      onChange={(e) => {\n                        const updated = [...otherDocuments];\n                        updated[idx].name = e.target.value;\n                        setOtherDocuments(updated);\n                      }}\n                    />\n                    <input\n                      type=\"file\"\n                      className=\"flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 text-sm file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium file:text-xs hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] transition-all duration-200 outline-none\"\n                      onChange={(e) => {\n                        const updated = [...otherDocuments];\n                        updated[idx].file = e.target.files[0];\n                        setOtherDocuments(updated);\n                      }}\n                    />\n                    <button\n                      type=\"button\"\n                      className=\"p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all duration-200\"\n                      onClick={() => setOtherDocuments(otherDocuments.filter((_, i) => i !== idx))}\n                    >\n                      ✕\n                    </button>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {/* Initial Issues Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Initial Issues (Optional)</h4>\n\n            {/* Add Issue Button */}\n            <button\n              type=\"button\"\n              className=\"w-full px-4 py-2.5 bg-slate-50 border border-slate-200 hover:border-slate-300 hover:bg-slate-100 text-slate-700 text-sm font-medium rounded-lg transition-all duration-200 mb-3\"\n              onClick={() => setShowAddIssueInVehicleModal(true)}\n            >\n              + Add Issue\n            </button>\n\n            {/* Issue Summary Cards */}\n            {initialIssues.length > 0 && (\n              <div className=\"space-y-2\">\n                {initialIssues.map((issue, index) => (\n                  <div key={index} className=\"card bg-base-200\">\n                    <div className=\"card-body p-3\">\n                      <div className=\"flex justify-between items-start gap-2\">\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            <span className=\"badge badge-sm\">{issue.category}</span>\n                            {issue.subcategory && (\n                              <span className=\"badge badge-sm badge-ghost\">{issue.subcategory}</span>\n                            )}\n                          </div>\n                          <p className=\"text-sm font-medium truncate\">{issue.description}</p>\n                          {issue.actionNeeded && (\n                            <p className=\"text-xs text-base-content/60 mt-1\">Action: {issue.actionNeeded}</p>\n                          )}\n                        </div>\n                        <button\n                          type=\"button\"\n                          className=\"btn btn-ghost btn-xs text-error\"\n                          onClick={() => {\n                            setInitialIssues(initialIssues.filter((_, i) => i !== index));\n                          }}\n                        >\n                          ✕\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* Prep Checklist Template Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Prep Checklist Template</h4>\n            <div className=\"form-control\">\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={selectedTemplate}\n                onChange={(e) => setSelectedTemplate(e.target.value)}\n              >\n                <option value=\"\">None - add tasks manually</option>\n                <option value=\"default\">Standard Prep (5 tasks)</option>\n              </select>\n            </div>\n\n            {/* Task Preview for Standard Prep */}\n            {selectedTemplate === \"default\" && (\n              <div className=\"mt-3 p-4 bg-slate-50 rounded-lg border border-slate-100\">\n                <p className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-3\">Tasks included:</p>\n                <div className=\"text-sm text-slate-600 space-y-2\">\n                  {[\"PDI\", \"Valet\", \"Photos\", \"MOT Check\", \"Advert\"].map((task, idx) => (\n                    <div key={idx} className=\"flex items-center gap-2\">\n                      <span className=\"text-[#0066CC]\">✓</span>\n                      <span>{task}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n\n          {/* Notes Section */}\n          <div className=\"mb-8\">\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Additional Notes</label>\n              <textarea\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                rows={4}\n                value={formData.notes}\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n              ></textarea>\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-end gap-3 pt-4 border-t border-slate-100\">\n            <button\n              type=\"button\"\n              className=\"px-5 py-2.5 border border-slate-200 text-slate-600 hover:text-slate-800 hover:border-slate-300 hover:bg-slate-50 font-medium rounded-lg transition-all duration-200\"\n              onClick={onClose}\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-2.5 bg-[#0066CC] hover:bg-[#0055BB] text-white font-medium rounded-lg shadow-sm hover:shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n              disabled={isLoading}\n            >\n              {isLoading ? <><span className=\"loading loading-spinner loading-sm\"></span><span>Saving...</span></> : \"Add Vehicle\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n\n      {/* Nested Add Issue Modal */}\n      {showAddIssueInVehicleModal && (\n        <AddIssueModal\n          issueForm={newIssueForm}\n          setIssueForm={setNewIssueForm}\n          onClose={() => {\n            setShowAddIssueInVehicleModal(false);\n            setNewIssueForm({\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              status: \"Outstanding\",\n              notes: \"\",\n              photos: [],\n            });\n          }}\n          onSubmit={() => {\n            // Validate required fields\n            if (!newIssueForm.category || !newIssueForm.subcategory || !newIssueForm.description) {\n              return toast.error(\"Category, subcategory, and description are required\");\n            }\n\n            // Add issue to the array\n            setInitialIssues([...initialIssues, { ...newIssueForm }]);\n\n            // Close modal and reset form\n            setShowAddIssueInVehicleModal(false);\n            setNewIssueForm({\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              status: \"Outstanding\",\n              notes: \"\",\n              photos: [],\n            });\n            toast.success(\"Issue added\");\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\nfunction AddIssueModal({ issueForm, setIssueForm, onClose, onSubmit, isEditing = false }) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [photoFiles, setPhotoFiles] = useState([]);\n  const [photoPreviews, setPhotoPreviews] = useState([]);\n  const [isUploadingPhotos, setIsUploadingPhotos] = useState(false);\n\n  const handlePhotoChange = (e) => {\n    const files = Array.from(e.target.files);\n    setPhotoFiles(prev => [...prev, ...files]);\n\n    // Create previews\n    files.forEach(file => {\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setPhotoPreviews(prev => [...prev, reader.result]);\n      };\n      reader.readAsDataURL(file);\n    });\n  };\n\n  const removePhoto = (index) => {\n    setPhotoFiles(prev => prev.filter((_, i) => i !== index));\n    setPhotoPreviews(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const uploadPhotos = async () => {\n    const uploadedUrls = [];\n    for (const file of photoFiles) {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      const res = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: formData,\n      });\n      if (res.ok) {\n        const data = await res.json();\n        // Store S3 key (permanent) if available, otherwise use URL (for local dev)\n        uploadedUrls.push(data.key || data.url);\n      }\n    }\n    return uploadedUrls;\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsLoading(true);\n    try {\n      // Upload photos first if any\n      let photoUrls = [];\n      if (photoFiles.length > 0) {\n        setIsUploadingPhotos(true);\n        photoUrls = await uploadPhotos();\n        setIsUploadingPhotos(false);\n      }\n      // Pass photo URLs/keys to onSubmit\n      await onSubmit(photoUrls);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box max-w-2xl bg-white\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h3 className=\"text-xl font-bold text-slate-900\">{isEditing ? \"Edit Issue\" : \"Add Issue\"}</h3>\n          <button\n            type=\"button\"\n            onClick={onClose}\n            className=\"p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200\"\n          >\n            <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n            </svg>\n          </button>\n        </div>\n        <form onSubmit={handleSubmit}>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Category *</label>\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={issueForm.category}\n                onChange={(e) => {\n                  setIssueForm({ ...issueForm, category: e.target.value, subcategory: \"\" });\n                }}\n                required\n              >\n                <option value=\"\">Select category...</option>\n                <option value=\"mechanical\">Mechanical</option>\n                <option value=\"electrical\">Electrical</option>\n                <option value=\"bodywork\">Bodywork</option>\n                <option value=\"interior\">Interior</option>\n                <option value=\"tyres\">Tyres</option>\n                <option value=\"mot\">MOT</option>\n                <option value=\"service\">Service</option>\n                <option value=\"fault_codes\">Fault Codes</option>\n                <option value=\"other\">Other</option>\n              </select>\n            </div>\n\n            {issueForm.category && (\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Subcategory</label>\n                <select\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                  value={issueForm.subcategory}\n                  onChange={(e) => setIssueForm({ ...issueForm, subcategory: e.target.value })}\n                >\n                  <option value=\"\">Select subcategory...</option>\n                  {ISSUE_SUBCATEGORIES[issueForm.category]?.map((sub) => (\n                    <option key={sub} value={sub}>{sub}</option>\n                  ))}\n                </select>\n              </div>\n            )}\n\n            {/* Fault Codes field - only show for fault_codes category */}\n            {issueForm.category === \"fault_codes\" && (\n              <div className=\"form-control col-span-2\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Fault Codes</label>\n                <input\n                  type=\"text\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 font-mono placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  value={issueForm.faultCodes || \"\"}\n                  onChange={(e) => setIssueForm({ ...issueForm, faultCodes: e.target.value })}\n                  placeholder=\"e.g. P0301, P0420, C1234\"\n                />\n                <p className=\"text-xs text-slate-400 mt-1.5\">Enter codes separated by commas</p>\n              </div>\n            )}\n\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Description *</label>\n              <textarea\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                value={issueForm.description}\n                onChange={(e) => setIssueForm({ ...issueForm, description: e.target.value })}\n                placeholder={issueForm.category === \"fault_codes\" ? \"Describe what the fault codes indicate...\" : \"Describe the issue...\"}\n                required\n                rows=\"3\"\n              ></textarea>\n            </div>\n\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Action Needed</label>\n              <input\n                type=\"text\"\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                value={issueForm.actionNeeded}\n                onChange={(e) => setIssueForm({ ...issueForm, actionNeeded: e.target.value })}\n                placeholder=\"What needs to be done?\"\n              />\n            </div>\n\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Priority</label>\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={issueForm.priority || \"medium\"}\n                onChange={(e) => setIssueForm({ ...issueForm, priority: e.target.value })}\n              >\n                <option value=\"low\">Low</option>\n                <option value=\"medium\">Medium</option>\n                <option value=\"high\">High</option>\n              </select>\n            </div>\n\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Location</label>\n              <input\n                type=\"text\"\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                value={issueForm.location || \"\"}\n                onChange={(e) => setIssueForm({ ...issueForm, location: e.target.value })}\n                placeholder=\"e.g., Front Left, Rear Bumper\"\n              />\n            </div>\n\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Status</label>\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={issueForm.status}\n                onChange={(e) => setIssueForm({ ...issueForm, status: e.target.value })}\n              >\n                <option value=\"outstanding\">Outstanding</option>\n                <option value=\"ordered\">Ordered</option>\n                <option value=\"in_progress\">In Progress</option>\n                <option value=\"resolved\">Resolved</option>\n              </select>\n            </div>\n\n            {/* Parts Required Section */}\n            <div className=\"form-control flex items-center\">\n              <label className=\"flex items-center gap-3 cursor-pointer mt-6\">\n                <div className=\"relative\">\n                  <input\n                    type=\"checkbox\"\n                    className=\"sr-only peer\"\n                    checked={issueForm.partsRequired || false}\n                    onChange={(e) => setIssueForm({ ...issueForm, partsRequired: e.target.checked })}\n                  />\n                  <div className=\"w-5 h-5 rounded border-2 border-slate-300 peer-checked:border-[#0066CC] peer-checked:bg-[#0066CC] transition-all duration-200 flex items-center justify-center\">\n                    <svg className=\"w-3 h-3 text-white opacity-0 peer-checked:opacity-100\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={3} d=\"M5 13l4 4L19 7\" />\n                    </svg>\n                  </div>\n                </div>\n                <span className=\"text-sm font-medium text-slate-700\">Parts Required</span>\n              </label>\n            </div>\n\n            {issueForm.partsRequired && (\n              <div className=\"form-control col-span-2\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Parts Details</label>\n                <textarea\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                  value={issueForm.partsDetails || \"\"}\n                  onChange={(e) => setIssueForm({ ...issueForm, partsDetails: e.target.value })}\n                  placeholder=\"Supplier, part numbers, who ordered, ETA...\"\n                  rows=\"2\"\n                ></textarea>\n              </div>\n            )}\n\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Notes</label>\n              <textarea\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                value={issueForm.notes}\n                onChange={(e) => setIssueForm({ ...issueForm, notes: e.target.value })}\n                placeholder=\"Additional notes...\"\n                rows=\"2\"\n              ></textarea>\n            </div>\n\n            {/* Photo Upload */}\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Photos</label>\n              <input\n                type=\"file\"\n                accept=\"image/*\"\n                multiple\n                onChange={handlePhotoChange}\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n              />\n              {photoPreviews.length > 0 && (\n                <div className=\"flex flex-wrap gap-2 mt-3\">\n                  {photoPreviews.map((preview, idx) => (\n                    <div key={idx} className=\"relative\">\n                      <img src={preview} alt={`Preview ${idx + 1}`} className=\"w-20 h-20 object-cover rounded-lg\" />\n                      <button\n                        type=\"button\"\n                        onClick={() => removePhoto(idx)}\n                        className=\"absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs flex items-center justify-center transition-colors\"\n                      >\n                        ✕\n                      </button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-end gap-3 pt-6 mt-6 border-t border-slate-100\">\n            <button\n              type=\"button\"\n              className=\"px-5 py-2.5 border border-slate-200 text-slate-600 hover:text-slate-800 hover:border-slate-300 hover:bg-slate-50 font-medium rounded-lg transition-all duration-200\"\n              onClick={onClose}\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-2.5 bg-[#0066CC] hover:bg-[#0055BB] text-white font-medium rounded-lg shadow-sm hover:shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n              disabled={isLoading || isUploadingPhotos}\n            >\n              {isLoading || isUploadingPhotos ? (\n                <>\n                  <span className=\"loading loading-spinner loading-sm\"></span>\n                  <span>{isUploadingPhotos ? \"Uploading photos...\" : \"Saving...\"}</span>\n                </>\n              ) : \"Add Issue\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n\nfunction AddDocumentModal({ documentForm, setDocumentForm, onClose, onSubmit }) {\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsLoading(true);\n    try {\n      await onSubmit();\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box\">\n        <h3 className=\"font-bold text-lg mb-4\">Add Document/Image</h3>\n        <form onSubmit={handleSubmit}>\n          <div className=\"space-y-4\">\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Document Type</span></label>\n              <select\n                className=\"select select-bordered\"\n                value={documentForm.type}\n                onChange={(e) => setDocumentForm({ ...documentForm, type: e.target.value })}\n              >\n                <option value=\"v5\">V5</option>\n                <option value=\"service_history\">Service History</option>\n                <option value=\"fault_codes\">Fault Codes</option>\n                <option value=\"other\">Other</option>\n              </select>\n            </div>\n\n            {/* Only show Document Name field when \"Other\" is selected */}\n            {documentForm.type === \"other\" && (\n              <div className=\"form-control\">\n                <label className=\"label\"><span className=\"label-text\">Document Name *</span></label>\n                <input\n                  type=\"text\"\n                  className=\"input input-bordered\"\n                  value={documentForm.name}\n                  onChange={(e) => setDocumentForm({ ...documentForm, name: e.target.value })}\n                  placeholder=\"e.g., MOT Certificate, Insurance\"\n                  required\n                />\n              </div>\n            )}\n\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">File *</span></label>\n              <input\n                type=\"file\"\n                className=\"file-input file-input-bordered w-full\"\n                onChange={(e) => setDocumentForm({ ...documentForm, file: e.target.files[0] })}\n                accept=\"image/*,.pdf,.doc,.docx\"\n                required\n              />\n            </div>\n          </div>\n\n          <div className=\"modal-action\">\n            <button type=\"button\" className=\"btn btn-ghost\" onClick={onClose}>Cancel</button>\n            <button type=\"submit\" className=\"btn btn-primary\" disabled={isLoading}>\n              {isLoading ? <span className=\"loading loading-spinner\"></span> : \"Upload Document/Image\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n\nfunction AddLocationModal({ onClose, onSuccess }) {\n  const [name, setName] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    if (!name.trim()) return toast.error(\"Location name is required\");\n\n    setIsLoading(true);\n    try {\n      const res = await fetch(\"/api/locations\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: name.trim(), type: \"offsite\" }),\n      });\n      if (!res.ok) throw new Error(\"Failed to create location\");\n      const newLocation = await res.json();\n      toast.success(\"Location added\");\n      onSuccess(newLocation);\n    } catch (error) {\n      toast.error(\"Failed to add location\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box\">\n        <h3 className=\"font-bold text-lg mb-4\">Add New Location</h3>\n        <form onSubmit={handleSubmit}>\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text\">Location Name *</span>\n            </label>\n            <input\n              type=\"text\"\n              className=\"input input-bordered w-full\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              placeholder=\"e.g., ABC Body Shop, Paint Centre\"\n              required\n              autoFocus\n            />\n          </div>\n          <div className=\"modal-action\">\n            <button type=\"button\" className=\"btn btn-ghost\" onClick={onClose}>\n              Cancel\n            </button>\n            <button type=\"submit\" className=\"btn btn-primary\" disabled={isLoading}>\n              {isLoading ? <span className=\"loading loading-spinner\"></span> : \"Add Location\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n","structuredPatch":[{"oldStart":52,"oldLines":6,"newStart":52,"newLines":7,"lines":[" };"," "," export default function SalesPrep() {","+  const router = useRouter();","   const [vehicles, setVehicles] = useState([]);","   const [isLoading, setIsLoading] = useState(true);","   const [selectedVehicle, setSelectedVehicle] = useState(null);"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"a237fb77-2e07-4da1-9734-1853088b9682","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Tx8bTxZ4bZ97Q6kKug3qfV","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add a useEffect that checks for the addVehicle query param and opens the modal when it's \"1\". I'll add this after the existing useEffect that fetches data.","signature":"EtICCkYICxgCKkCDYxRZ9csHsbGgzywN7fprv9bxTtP1DVTczXEVHhuzIzWbRo0MsQLOll65h5pzoP1rWQ1EBpWGD4Uenn6q6EtvEgyJ5G/ib0uXGtSuAywaDA4LTB7G+WiOvoXvcSIw7FUgj0DbsotLbmKibxTFzGMvAJZMqj8/aw/E8NiS0ARiPfsNOfiWSAlP943tdwMbKrkBGcysLlKZ99KCw4YGVRhduUFfkSzEUqhKb3EKI5TILi++b7K+NdPylU0DF6TFOfFROQFDH2C8yEaFjtp2h8dWf3peZGrco2BsxOT6jChHM7RYs/p+pkj4fnSeNCz2MFh7ebaRcQfFSvwAmlTjdolTXqrmoKVBiVVkO9qxud8E1ZReVwEpWc/R7KX5eW02rsc0R8yo+VDwJgTRoGMh7gblGCo9rhan4wyR601YGh76vMzsLcHIVnJvV/EYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":600,"cache_read_input_tokens":84272,"cache_creation":{"ephemeral_5m_input_tokens":600,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd8om8UCsfHKAm4G1tja","type":"assistant","uuid":"5aaa5e60-3fa0-423c-bd9d-039fd1cb0e41","timestamp":"2025-12-30T15:49:07.034Z"}
{"parentUuid":"5aaa5e60-3fa0-423c-bd9d-039fd1cb0e41","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Tx8bTxZ4bZ97Q6kKug3qfV","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll add a useEffect to handle the query parameter:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":600,"cache_read_input_tokens":84272,"cache_creation":{"ephemeral_5m_input_tokens":600,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd8om8UCsfHKAm4G1tja","type":"assistant","uuid":"cb794c07-cab5-4e57-8ca0-03fc07858556","timestamp":"2025-12-30T15:49:07.450Z"}
{"parentUuid":"cb794c07-cab5-4e57-8ca0-03fc07858556","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Tx8bTxZ4bZ97Q6kKug3qfV","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013nDVwyJLXc19CLksQccCkJ","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","old_string":"  useEffect(() => {\n    fetchVehicles();\n    fetchLocations();\n    fetchLabels();\n  }, []);","new_string":"  useEffect(() => {\n    fetchVehicles();\n    fetchLocations();\n    fetchLabels();\n  }, []);\n\n  // Handle addVehicle query param (from Quick Add menu)\n  useEffect(() => {\n    if (router.query.addVehicle === \"1\") {\n      setShowAddModal(true);\n      // Remove the query param from URL without reload\n      router.replace(\"/sales-prep\", undefined, { shallow: true });\n    }\n  }, [router.query.addVehicle]);"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":600,"cache_read_input_tokens":84272,"cache_creation":{"ephemeral_5m_input_tokens":600,"ephemeral_1h_input_tokens":0},"output_tokens":322,"service_tier":"standard"}},"requestId":"req_011CWd8om8UCsfHKAm4G1tja","type":"assistant","uuid":"051fbd77-b09d-4449-b142-3e1dd4aee409","timestamp":"2025-12-30T15:49:10.845Z"}
{"parentUuid":"051fbd77-b09d-4449-b142-3e1dd4aee409","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013nDVwyJLXc19CLksQccCkJ","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   193→\n   194→  // Mobile state\n   195→  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"in_stock\");\n   196→\n   197→  useEffect(() => {\n   198→    fetchVehicles();\n   199→    fetchLocations();\n   200→    fetchLabels();\n   201→  }, []);\n   202→\n   203→  // Handle addVehicle query param (from Quick Add menu)\n   204→  useEffect(() => {\n   205→    if (router.query.addVehicle === \"1\") {\n   206→      setShowAddModal(true);\n   207→      // Remove the query param from URL without reload\n   208→      router.replace(\"/sales-prep\", undefined, { shallow: true });\n   209→    }\n   210→  }, [router.query.addVehicle]);\n   211→\n   212→  const fetchVehicles = async () => {\n   213→    try {\n   214→      const res = await fetch(\"/api/vehicles\");"}]},"uuid":"6054b397-05ed-4bdb-b8a6-3b44e0d14852","timestamp":"2025-12-30T15:49:12.121Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\sales-prep.js","oldString":"  useEffect(() => {\n    fetchVehicles();\n    fetchLocations();\n    fetchLabels();\n  }, []);","newString":"  useEffect(() => {\n    fetchVehicles();\n    fetchLocations();\n    fetchLabels();\n  }, []);\n\n  // Handle addVehicle query param (from Quick Add menu)\n  useEffect(() => {\n    if (router.query.addVehicle === \"1\") {\n      setShowAddModal(true);\n      // Remove the query param from URL without reload\n      router.replace(\"/sales-prep\", undefined, { shallow: true });\n    }\n  }, [router.query.addVehicle]);","originalFile":"import { useEffect, useState, useRef, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport { toast } from \"react-hot-toast\";\nimport { showDummyNotification } from \"@/utils/notifications\";\nimport { BottomSheet } from \"@/components/ui/BottomSheet\";\nimport { Portal } from \"@/components/ui/Portal\";\nimport { MobileStageSelector } from \"@/components/ui/PageShell\";\n\nconst COLUMNS = [\n  { key: \"in_stock\", label: \"In Stock\", gradient: \"from-orange-100/60\", accent: \"border-l-orange-400\", accentBg: \"bg-orange-400\" },\n  { key: \"in_prep\", label: \"Advertised\", gradient: \"from-blue-100/60\", accent: \"border-l-blue-400\", accentBg: \"bg-blue-400\" },\n  { key: \"live\", label: \"Sold In Progress\", gradient: \"from-cyan-100/60\", accent: \"border-l-cyan-400\", accentBg: \"bg-cyan-400\" },\n  { key: \"reserved\", label: \"Completed\", gradient: \"from-emerald-100/60\", accent: \"border-l-emerald-400\", accentBg: \"bg-emerald-400\" },\n  { key: \"delivered\", label: \"Delivered\", gradient: \"from-teal-100/60\", accent: \"border-l-teal-400\", accentBg: \"bg-teal-400\" },\n];\n\nconst ISSUE_SUBCATEGORIES = {\n  mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n  electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n  bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n  interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n  tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n  mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n  service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n  fault_codes: [\"Engine\", \"Transmission\", \"ABS\", \"Airbag\", \"Emissions\", \"Other\"],\n  other: [\"General\", \"Misc\"],\n};\n\n// Sold statuses - these show \"Sold X days\" instead of \"In stock X days\"\nconst SOLD_STATUSES = [\"live\", \"reserved\", \"delivered\"];\n\n// Helper to compute duration label based on status\nconst getVehicleDuration = (vehicle) => {\n  const isSold = SOLD_STATUSES.includes(vehicle.status);\n\n  if (isSold) {\n    if (vehicle.soldAt) {\n      const daysSold = Math.floor((Date.now() - new Date(vehicle.soldAt).getTime()) / (1000 * 60 * 60 * 24));\n      return { days: daysSold, label: `Sold ${daysSold}d`, isSold: true };\n    }\n    // Legacy sold vehicle without soldAt - just show \"Sold\"\n    return { days: 0, label: \"Sold\", isSold: true };\n  }\n\n  const daysInStock = vehicle.createdAt\n    ? Math.floor((Date.now() - new Date(vehicle.createdAt).getTime()) / (1000 * 60 * 60 * 24))\n    : 0;\n  return { days: daysInStock, label: `${daysInStock}d in stock`, isSold: false };\n};\n\nexport default function SalesPrep() {\n  const router = useRouter();\n  const [vehicles, setVehicles] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedVehicle, setSelectedVehicle] = useState(null);\n  const [isLookingUpDrawer, setIsLookingUpDrawer] = useState(false);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [draggedCard, setDraggedCard] = useState(null);\n  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });\n  const [newTaskName, setNewTaskName] = useState(\"\");\n  const [activeTab, setActiveTab] = useState(\"overview\");\n  const [editingTaskId, setEditingTaskId] = useState(null);\n  const [editingTaskName, setEditingTaskName] = useState(\"\");\n\n  // Parts ordering state\n  const [showPartsOrderModal, setShowPartsOrderModal] = useState(false);\n  const [partsOrderTaskId, setPartsOrderTaskId] = useState(null);\n  const [partsOrderForm, setPartsOrderForm] = useState({\n    supplierType: \"EURO_CAR_PARTS\",\n    supplierName: \"\",\n    orderRef: \"\",\n    expectedAt: \"\",\n    notes: \"\",\n  });\n  const [editingPartsOrderId, setEditingPartsOrderId] = useState(null);\n\n  // Column sorting state\n  const [columnSortOptions, setColumnSortOptions] = useState({});\n\n  // Job sheet share state\n  const [showJobSheetModal, setShowJobSheetModal] = useState(false);\n  const [jobSheetLink, setJobSheetLink] = useState(null);\n  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);\n\n  // Prep summary share state\n  const [showPrepSummaryModal, setShowPrepSummaryModal] = useState(false);\n  const [prepSummaryLink, setPrepSummaryLink] = useState(null);\n  const [isGeneratingPrepSummary, setIsGeneratingPrepSummary] = useState(false);\n\n  // Manual share fallback modal\n  const [showManualShareModal, setShowManualShareModal] = useState(false);\n  const [manualShareUrl, setManualShareUrl] = useState(\"\");\n\n  // Issues state\n  const [showAddIssueModal, setShowAddIssueModal] = useState(false);\n  const [editingIssue, setEditingIssue] = useState(null); // For edit mode\n  const [issueForm, setIssueForm] = useState({\n    category: \"\",\n    subcategory: \"\",\n    description: \"\",\n    actionNeeded: \"\",\n    priority: \"medium\",\n    location: \"\",\n    status: \"outstanding\",\n    notes: \"\",\n    photos: [],\n    partsRequired: false,\n    partsDetails: \"\",\n  });\n  const [issueUpdateContent, setIssueUpdateContent] = useState({});\n  const [expandedIssues, setExpandedIssues] = useState({});\n\n  // Filters state - with localStorage persistence\n  const [activeFilters, setActiveFilters] = useState([]);\n  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);\n  const filterButtonRef = useRef(null);\n  const [filterPopoverPos, setFilterPopoverPos] = useState({ top: 0, right: 0 });\n\n  // Calculate popover position when opening\n  const openFiltersDropdown = useCallback(() => {\n    if (filterButtonRef.current) {\n      const rect = filterButtonRef.current.getBoundingClientRect();\n      const viewportHeight = window.innerHeight;\n      const viewportWidth = window.innerWidth;\n\n      // Position below the button, aligned to right edge\n      let top = rect.bottom + 8;\n      let right = viewportWidth - rect.right;\n\n      // Ensure popover doesn't go below viewport (max 70vh height + 16px padding)\n      const popoverHeight = Math.min(viewportHeight * 0.7, 600);\n      if (top + popoverHeight > viewportHeight - 16) {\n        top = Math.max(16, viewportHeight - popoverHeight - 16);\n      }\n\n      // Ensure popover doesn't go off right edge\n      right = Math.max(16, right);\n\n      setFilterPopoverPos({ top, right });\n    }\n    setShowFiltersDropdown(true);\n  }, []);\n\n  // Load filters from localStorage on mount\n  useEffect(() => {\n    try {\n      const savedFilters = localStorage.getItem(\"salesPrepFilters\");\n      if (savedFilters) {\n        setActiveFilters(JSON.parse(savedFilters));\n      }\n    } catch (e) {\n      console.warn(\"Failed to load saved filters:\", e);\n    }\n  }, []);\n\n  // Save filters to localStorage when they change\n  useEffect(() => {\n    try {\n      localStorage.setItem(\"salesPrepFilters\", JSON.stringify(activeFilters));\n    } catch (e) {\n      console.warn(\"Failed to save filters:\", e);\n    }\n  }, [activeFilters]);\n\n  // Documents state\n  const [showAddDocumentModal, setShowAddDocumentModal] = useState(false);\n  const [documentForm, setDocumentForm] = useState({\n    name: \"\",\n    type: \"other\",\n    file: null,\n  });\n\n  // Location state\n  const [locations, setLocations] = useState([]);\n  const [showAddLocationModal, setShowAddLocationModal] = useState(false);\n\n  // Vehicle Labels state\n  const [availableLabels, setAvailableLabels] = useState([]);\n  const [showLabelsDropdown, setShowLabelsDropdown] = useState(false);\n  const [showAddLabelModal, setShowAddLabelModal] = useState(false);\n  const [newLabelForm, setNewLabelForm] = useState({ name: \"\", colour: \"#6366f1\" });\n\n  // Activity log state\n  const [activityData, setActivityData] = useState({ activities: [], total: 0, hasMore: false });\n  const [activityLoading, setActivityLoading] = useState(false);\n\n  // VRM Search state\n  const [vrmSearch, setVrmSearch] = useState(\"\");\n  const [showVrmDropdown, setShowVrmDropdown] = useState(false);\n\n  // Mobile state\n  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"in_stock\");\n\n  useEffect(() => {\n    fetchVehicles();\n    fetchLocations();\n    fetchLabels();\n  }, []);\n\n  const fetchVehicles = async () => {\n    try {\n      const res = await fetch(\"/api/vehicles\");\n      if (!res.ok) {\n        throw new Error(`API error: ${res.status}`);\n      }\n      const data = await res.json();\n      setVehicles(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"Failed to load vehicles:\", error);\n      toast.error(\"Failed to load vehicles\");\n      setVehicles([]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const fetchLocations = async () => {\n    try {\n      const res = await fetch(\"/api/locations\");\n      const data = await res.json();\n      setLocations(data);\n    } catch (error) {\n      console.error(\"Failed to load locations:\", error);\n    }\n  };\n\n  const fetchLabels = async () => {\n    try {\n      const res = await fetch(\"/api/labels\");\n      const data = await res.json();\n      setAvailableLabels(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"Failed to load labels:\", error);\n    }\n  };\n\n  // Fetch vehicle activity log\n  const fetchActivity = async (vehicleId, loadMore = false) => {\n    if (!vehicleId) return;\n    setActivityLoading(true);\n    try {\n      const offset = loadMore ? activityData.activities.length : 0;\n      const res = await fetch(`/api/vehicles/${vehicleId}/activity?limit=25&offset=${offset}`);\n      const data = await res.json();\n      if (loadMore) {\n        setActivityData(prev => ({\n          activities: [...prev.activities, ...data.activities],\n          total: data.total,\n          hasMore: data.hasMore,\n        }));\n      } else {\n        setActivityData(data);\n      }\n    } catch (error) {\n      console.error(\"Failed to load activity:\", error);\n    } finally {\n      setActivityLoading(false);\n    }\n  };\n\n  // Format relative time for activity log\n  const formatRelativeTime = (dateStr) => {\n    const date = new Date(dateStr);\n    const now = new Date();\n    const diffMs = now - date;\n    const diffMins = Math.floor(diffMs / 60000);\n    const diffHours = Math.floor(diffMs / 3600000);\n    const diffDays = Math.floor(diffMs / 86400000);\n\n    if (diffMins < 1) return \"just now\";\n    if (diffMins < 60) return `${diffMins}m ago`;\n    if (diffHours < 24) return `${diffHours}h ago`;\n    if (diffDays < 7) return `${diffDays}d ago`;\n    return date.toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\" });\n  };\n\n  // Toggle a label on/off for a vehicle\n  const toggleVehicleLabel = async (vehicleId, labelId) => {\n    try {\n      const res = await fetch(`/api/vehicles/${vehicleId}/labels/${labelId}`, {\n        method: \"POST\",\n      });\n      if (res.ok) {\n        const updatedData = await res.json();\n        // Update selected vehicle if it's the same one\n        if (selectedVehicle?.id === vehicleId) {\n          setSelectedVehicle(prev => ({\n            ...prev,\n            labels: updatedData.labels || [],\n          }));\n        }\n        fetchVehicles();\n      }\n    } catch (error) {\n      toast.error(\"Failed to update label\");\n    }\n  };\n\n  // Create a new label\n  const createLabel = async () => {\n    if (!newLabelForm.name.trim()) {\n      toast.error(\"Label name is required\");\n      return;\n    }\n    try {\n      const res = await fetch(\"/api/labels\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(newLabelForm),\n      });\n      if (res.ok) {\n        const newLabel = await res.json();\n        setAvailableLabels(prev => [...prev, newLabel]);\n        setNewLabelForm({ name: \"\", colour: \"#6366f1\" });\n        setShowAddLabelModal(false);\n        toast.success(\"Label created\");\n      }\n    } catch (error) {\n      toast.error(\"Failed to create label\");\n    }\n  };\n\n  // Open vehicle drawer - vehicle from grid already has tasks, issues, documents\n  const openVehicleDrawer = (vehicle) => {\n    setSelectedVehicle({ ...vehicle, id: vehicle.id || vehicle._id });\n    setActiveTab(\"overview\");\n    setShowLabelsDropdown(false); // Close labels dropdown when opening new vehicle\n    setActivityData({ activities: [], total: 0, hasMore: false }); // Reset activity when opening new vehicle\n  };\n\n  const updateVehicleStatus = async (vehicleId, newStatus) => {\n    try {\n      await fetch(`/api/vehicles/${vehicleId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ status: newStatus }),\n      });\n      fetchVehicles();\n      toast.success(`Moved to ${newStatus.replace(\"_\", \" \")}`);\n    } catch (error) {\n      toast.error(\"Failed to update\");\n    }\n  };\n\n  // DVLA lookup for existing vehicle in drawer\n  const lookupVehicleDVLA = async () => {\n    if (!selectedVehicle?.regCurrent) {\n      toast.error(\"No registration to lookup\");\n      return;\n    }\n    setIsLookingUpDrawer(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: selectedVehicle.regCurrent }),\n      });\n      const data = await res.json();\n\n      if (!res.ok || data.error) {\n        toast.error(data.message || data.error || \"Vehicle not found\");\n        return;\n      }\n\n      if (data.isDummy) showDummyNotification(\"DVLA API\");\n\n      // Update the vehicle with DVLA data\n      const updatePayload = {\n        make: data.make || selectedVehicle.make,\n        model: data.model || selectedVehicle.model,\n        year: data.yearOfManufacture || data.year || selectedVehicle.year,\n        colour: data.colour || selectedVehicle.colour,\n        fuelType: data.fuelType || selectedVehicle.fuelType,\n        transmission: data.transmission || selectedVehicle.transmission,\n        motExpiryDate: data.motExpiryDate || selectedVehicle.motExpiryDate,\n        dvlaDetails: data.dvlaDetails || null,\n        lastDvlaFetchAt: data.lastDvlaFetchAt || new Date().toISOString(),\n      };\n\n      await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updatePayload),\n      });\n\n      // Refresh vehicle data\n      const updatedRes = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const updatedVehicle = await updatedRes.json();\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n\n      toast.success(`Updated: ${data.make} ${data.model || \"\"} (${data.yearOfManufacture || \"\"})`);\n    } catch (error) {\n      toast.error(\"Lookup failed - please try again\");\n    } finally {\n      setIsLookingUpDrawer(false);\n    }\n  };\n\n  const updateTaskStatus = async (taskId, newStatus) => {\n    try {\n      const payload = { status: newStatus };\n      if (newStatus === \"done\") {\n        payload.completedAt = new Date().toISOString();\n      }\n      // Clear progress when changing status (optional: keep if staying in_progress)\n      if (newStatus !== \"in_progress\") {\n        payload.progress = \"NONE\";\n        payload.progressNote = \"\";\n      }\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n    } catch (error) {\n      toast.error(\"Failed to update task\");\n    }\n  };\n\n  // Update task progress sub-status (for parts ordering, booking, etc.)\n  const updateTaskProgress = async (taskId, progress, progressNote = null) => {\n    try {\n      const payload = { progress };\n      if (progressNote !== null) {\n        payload.progressNote = progressNote;\n      }\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n    } catch (error) {\n      toast.error(\"Failed to update task progress\");\n    }\n  };\n\n  // Parts order management functions\n  const openPartsOrderModal = (taskId, existingOrder = null) => {\n    setPartsOrderTaskId(taskId);\n    if (existingOrder) {\n      setEditingPartsOrderId(existingOrder._id || existingOrder.id);\n      setPartsOrderForm({\n        supplierType: existingOrder.supplierType || \"EURO_CAR_PARTS\",\n        supplierName: existingOrder.supplierName || \"\",\n        orderRef: existingOrder.orderRef || \"\",\n        expectedAt: existingOrder.expectedAt ? existingOrder.expectedAt.split(\"T\")[0] : \"\",\n        notes: existingOrder.notes || \"\",\n      });\n    } else {\n      setEditingPartsOrderId(null);\n      setPartsOrderForm({\n        supplierType: \"EURO_CAR_PARTS\",\n        supplierName: \"\",\n        orderRef: \"\",\n        expectedAt: \"\",\n        notes: \"\",\n      });\n    }\n    setShowPartsOrderModal(true);\n  };\n\n  const closePartsOrderModal = () => {\n    setShowPartsOrderModal(false);\n    setPartsOrderTaskId(null);\n    setEditingPartsOrderId(null);\n    setPartsOrderForm({\n      supplierType: \"EURO_CAR_PARTS\",\n      supplierName: \"\",\n      orderRef: \"\",\n      expectedAt: \"\",\n      notes: \"\",\n    });\n  };\n\n  const addPartsOrder = async () => {\n    if (!partsOrderTaskId) return;\n    try {\n      const orderData = {\n        supplierType: partsOrderForm.supplierType,\n        ...(partsOrderForm.supplierType === \"OTHER\" && partsOrderForm.supplierName && { supplierName: partsOrderForm.supplierName }),\n        ...(partsOrderForm.orderRef && { orderRef: partsOrderForm.orderRef }),\n        ...(partsOrderForm.expectedAt && { expectedAt: partsOrderForm.expectedAt }),\n        ...(partsOrderForm.notes && { notes: partsOrderForm.notes }),\n      };\n\n      await fetch(`/api/tasks/${partsOrderTaskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ addPartsOrder: orderData }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      closePartsOrderModal();\n      toast.success(\"Parts order added\");\n    } catch (error) {\n      toast.error(\"Failed to add parts order\");\n    }\n  };\n\n  const updatePartsOrder = async () => {\n    if (!partsOrderTaskId || !editingPartsOrderId) return;\n    try {\n      const orderData = {\n        orderId: editingPartsOrderId,\n        supplierType: partsOrderForm.supplierType,\n        supplierName: partsOrderForm.supplierType === \"OTHER\" ? partsOrderForm.supplierName : null,\n        orderRef: partsOrderForm.orderRef || null,\n        expectedAt: partsOrderForm.expectedAt || null,\n        notes: partsOrderForm.notes || null,\n      };\n\n      await fetch(`/api/tasks/${partsOrderTaskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ updatePartsOrder: orderData }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      closePartsOrderModal();\n      toast.success(\"Parts order updated\");\n    } catch (error) {\n      toast.error(\"Failed to update parts order\");\n    }\n  };\n\n  const removePartsOrder = async (taskId, orderId) => {\n    if (!confirm(\"Remove this parts order?\")) return;\n    try {\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ removePartsOrderId: orderId }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      toast.success(\"Parts order removed\");\n    } catch (error) {\n      toast.error(\"Failed to remove parts order\");\n    }\n  };\n\n  const markPartsReceived = async (taskId, orderId) => {\n    try {\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          updatePartsOrder: {\n            orderId,\n            status: \"RECEIVED\",\n            receivedAt: new Date().toISOString(),\n          },\n        }),\n      });\n\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      toast.success(\"Parts marked as received\");\n    } catch (error) {\n      toast.error(\"Failed to update parts order\");\n    }\n  };\n\n  // Helper to get supplier display name\n  const getSupplierDisplay = (order) => {\n    const labels = {\n      EURO_CAR_PARTS: \"Euro Car Parts\",\n      TPS: \"TPS\",\n      MAIN_DEALER: \"Main Dealer\",\n      LOCAL_FACTOR: \"Local Factor\",\n      ONLINE: \"Online\",\n      OTHER: order.supplierName || \"Other\",\n    };\n    return labels[order.supplierType] || order.supplierType;\n  };\n\n  const updateTaskName = async (taskId, newName) => {\n    if (!newName.trim()) {\n      toast.error(\"Task name cannot be empty\");\n      return;\n    }\n    try {\n      await fetch(`/api/tasks/${taskId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: newName }),\n      });\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);\n      const data = await res.json();\n      setSelectedVehicle(data);\n      fetchVehicles();\n      setEditingTaskId(null);\n      setEditingTaskName(\"\");\n      toast.success(\"Task updated\");\n    } catch (error) {\n      toast.error(\"Failed to update task\");\n    }\n  };\n\n  const addTask = async () => {\n    if (!newTaskName.trim()) return toast.error(\"Task name is required\");\n    try {\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/tasks`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: newTaskName }),\n      });\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.error || \"Failed to add task\");\n      }\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      setNewTaskName(\"\");\n      fetchVehicles();\n      toast.success(\"Task added\");\n    } catch (error) {\n      console.error(\"Add task error:\", error);\n      toast.error(error.message || \"Failed to add task\");\n    }\n  };\n\n  const deleteTask = async (taskId) => {\n    try {\n      await fetch(`/api/tasks/${taskId}`, { method: \"DELETE\" });\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Task removed\");\n    } catch (error) {\n      toast.error(\"Failed to delete task\");\n    }\n  };\n\n  // Issue functions\n  const addIssue = async (photoUrls = []) => {\n    if (!issueForm.category || !issueForm.subcategory || !issueForm.description) {\n      return toast.error(\"Category, subcategory, and description are required\");\n    }\n    try {\n      const issueData = {\n        ...issueForm,\n        photos: [...(issueForm.photos || []), ...photoUrls],\n      };\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/issues`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(issueData),\n      });\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new Error(errorData.error || \"Failed to add issue\");\n      }\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      setShowAddIssueModal(false);\n      setIssueForm({\n        category: \"\",\n        subcategory: \"\",\n        description: \"\",\n        actionNeeded: \"\",\n        status: \"outstanding\",\n        notes: \"\",\n        photos: [],\n      });\n      toast.success(\"Issue added\");\n    } catch (error) {\n      console.error(\"Add issue error:\", error);\n      toast.error(error.message || \"Failed to add issue\");\n    }\n  };\n\n  const updateIssue = async (issueId, updates) => {\n    try {\n      const res = await fetch(`/api/issues/${issueId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      if (!res.ok) throw new Error(\"Failed to update issue\");\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Issue updated\");\n    } catch (error) {\n      toast.error(\"Failed to update issue\");\n    }\n  };\n\n  // Open edit issue modal with prefilled data\n  const openEditIssue = (issue) => {\n    setEditingIssue(issue);\n    setIssueForm({\n      category: issue.category?.toLowerCase() || \"\",\n      subcategory: issue.subcategory || \"\",\n      description: issue.description || \"\",\n      actionNeeded: issue.actionNeeded || \"\",\n      priority: issue.priority || \"medium\",\n      location: issue.location || \"\",\n      status: issue.status?.toLowerCase().replace(\" \", \"_\") || \"outstanding\",\n      notes: issue.notes || \"\",\n      photos: issue.photos || [],\n      partsRequired: issue.partsRequired || false,\n      partsDetails: issue.partsDetails || \"\",\n    });\n    setShowAddIssueModal(true);\n  };\n\n  // Save edited issue\n  const saveEditedIssue = async (photoUrls = []) => {\n    if (!editingIssue) return;\n    try {\n      const updates = {\n        ...issueForm,\n        photos: [...(issueForm.photos || []), ...photoUrls],\n      };\n      await updateIssue(editingIssue.id, updates);\n      setShowAddIssueModal(false);\n      setEditingIssue(null);\n      setIssueForm({\n        category: \"\",\n        subcategory: \"\",\n        description: \"\",\n        actionNeeded: \"\",\n        priority: \"medium\",\n        location: \"\",\n        status: \"outstanding\",\n        notes: \"\",\n        photos: [],\n        partsRequired: false,\n        partsDetails: \"\",\n      });\n    } catch (error) {\n      toast.error(\"Failed to save issue\");\n    }\n  };\n\n  const deleteIssue = async (issueId) => {\n    try {\n      await fetch(`/api/issues/${issueId}`, { method: \"DELETE\" });\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Issue removed\");\n    } catch (error) {\n      toast.error(\"Failed to delete issue\");\n    }\n  };\n\n  const addIssueUpdate = async (issueId, content) => {\n    if (!content?.trim()) {\n      return toast.error(\"Update content cannot be empty\");\n    }\n\n    try {\n      await fetch(`/api/issues/${issueId}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          content: content.trim(),\n          userName: \"Current User\" // TODO: Replace with actual user name from auth\n        }),\n      });\n\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      setIssueUpdateContent(prev => ({ ...prev, [issueId]: \"\" }));\n      toast.success(\"Update added\");\n    } catch (error) {\n      toast.error(\"Failed to add update\");\n    }\n  };\n\n  // Document functions\n  const uploadDocument = async (file, name, type) => {\n    if (!file) return;\n\n    try {\n      // First upload the file\n      const uploadFormData = new FormData();\n      uploadFormData.append(\"file\", file);\n\n      const uploadRes = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: uploadFormData,\n      });\n      if (!uploadRes.ok) throw new Error(\"File upload failed\");\n      const uploadData = await uploadRes.json();\n\n      // Then create the document record with the URL\n      const docRes = await fetch(`/api/vehicles/${selectedVehicle.id}/documents`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name, type, url: uploadData.url }),\n      });\n      if (!docRes.ok) throw new Error(\"Document creation failed\");\n\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      setShowAddDocumentModal(false);\n      setDocumentForm({ name: \"\", type: \"other\", file: null });\n      toast.success(\"Document uploaded\");\n    } catch (error) {\n      console.error(\"Upload error:\", error);\n      toast.error(\"Failed to upload document\");\n    }\n  };\n\n  const deleteDocument = async (documentId) => {\n    try {\n      await fetch(`/api/documents/${documentId}`, { method: \"DELETE\" });\n      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updatedVehicle);\n      fetchVehicles();\n      toast.success(\"Document removed\");\n    } catch (error) {\n      toast.error(\"Failed to delete document\");\n    }\n  };\n\n  const handleDragStart = (e, vehicle) => {\n    setDraggedCard(vehicle);\n    setDragPosition({ x: e.clientX, y: e.clientY });\n    e.dataTransfer.effectAllowed = \"move\";\n    // Create invisible drag image (we'll render our own preview)\n    const emptyImg = new Image();\n    emptyImg.src = \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\";\n    e.dataTransfer.setDragImage(emptyImg, 0, 0);\n  };\n\n  const handleDrag = (e) => {\n    if (e.clientX !== 0 && e.clientY !== 0) {\n      setDragPosition({ x: e.clientX, y: e.clientY });\n    }\n  };\n\n  const handleDragOver = (e) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDragEnd = () => {\n    setDraggedCard(null);\n  };\n\n  const handleDrop = async (e, newStatus) => {\n    e.preventDefault();\n    if (!draggedCard || draggedCard.status === newStatus) {\n      setDraggedCard(null);\n      return;\n    }\n    const vehicleId = draggedCard.id || draggedCard._id;\n    await updateVehicleStatus(vehicleId, newStatus);\n    setDraggedCard(null);\n  };\n\n  const uploadV5 = async (file) => {\n    if (!file) return;\n\n    try {\n      // First upload the file\n      const formData = new FormData();\n      formData.append(\"file\", file);\n\n      const uploadRes = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: formData,\n      });\n      if (!uploadRes.ok) throw new Error(\"Upload failed\");\n      const uploadData = await uploadRes.json();\n\n      // Then update the vehicle with the V5 URL\n      await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ v5Url: uploadData.url }),\n      });\n\n      const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n      setSelectedVehicle(updated);\n      fetchVehicles();\n      toast.success(\"V5 uploaded\");\n    } catch (error) {\n      console.error(\"V5 upload error:\", error);\n      toast.error(\"Failed to upload V5\");\n    }\n  };\n\n  const formatDate = (date) => {\n    if (!date) return \"—\";\n    return new Date(date).toLocaleDateString(\"en-GB\", { day: \"2-digit\", month: \"short\", year: \"numeric\" });\n  };\n\n  const toggleFilter = (filter) => {\n    setActiveFilters(prev =>\n      prev.includes(filter)\n        ? prev.filter(f => f !== filter)\n        : [...prev, filter]\n    );\n  };\n\n  const getFilteredVehicles = (vehicleList) => {\n    if (activeFilters.length === 0) return vehicleList;\n\n    return vehicleList.filter(vehicle => {\n      return activeFilters.every(filter => {\n        const tasks = vehicle.tasks || [];\n        const issues = vehicle.issues || [];\n        const activeIssues = issues.filter(i => {\n          const status = (i.status || \"\").toLowerCase();\n          return [\"outstanding\", \"ordered\", \"in progress\", \"in_progress\"].includes(status);\n        });\n\n        // Prep task filters\n        if (filter === \"awaiting_pdi\") return !tasks.find(t => t.name.toLowerCase().includes(\"pdi\") && t.status === \"done\");\n        if (filter === \"awaiting_valet\") return !tasks.find(t => t.name.toLowerCase().includes(\"valet\") && t.status === \"done\");\n        if (filter === \"awaiting_photos\") return !tasks.find(t => t.name.toLowerCase().includes(\"photo\") && t.status === \"done\");\n        if (filter === \"awaiting_mot\") return !tasks.find(t => t.name.toLowerCase().includes(\"mot\") && t.status === \"done\");\n\n        // Issue filters\n        if (filter === \"needs_paint\") return activeIssues.some(i => {\n          const cat = (i.category || \"\").toLowerCase();\n          return cat === \"bodywork\" || cat === \"cosmetic\";\n        });\n        if (filter === \"needs_mechanical\") return activeIssues.some(i => {\n          const cat = (i.category || \"\").toLowerCase();\n          return cat === \"mechanical\";\n        });\n        if (filter === \"needs_electrical\") return activeIssues.some(i => {\n          const cat = (i.category || \"\").toLowerCase();\n          return cat === \"electrical\";\n        });\n\n        // Location filter\n        if (filter === \"offsite\") return vehicle.locationId != null;\n\n        // MOT filters\n        if (filter === \"mot_due_soon\") {\n          if (!vehicle.motExpiryDate) return false;\n          const expiry = new Date(vehicle.motExpiryDate);\n          const now = new Date();\n          const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));\n          return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;\n        }\n        if (filter === \"mot_expired\") {\n          if (!vehicle.motExpiryDate) return false;\n          const expiry = new Date(vehicle.motExpiryDate);\n          const now = new Date();\n          return expiry < now;\n        }\n\n        // Sale type filters\n        if (filter === \"trade_only\") return vehicle.saleType === \"TRADE\";\n        if (filter === \"retail_only\") return vehicle.saleType === \"RETAIL\" || !vehicle.saleType;\n\n        // Vehicle type filters\n        if (filter === \"type_stock\") return vehicle.type === \"STOCK\" || !vehicle.type;\n        if (filter === \"type_courtesy\") return vehicle.type === \"COURTESY\";\n        if (filter === \"type_fleet\") return vehicle.type === \"FLEET_OTHER\";\n\n        return true;\n      });\n    });\n  };\n\n  const getVehiclesByStatus = (status) => {\n    const statusVehicles = vehicles.filter(v => v.status === status);\n    const filtered = getFilteredVehicles(statusVehicles);\n\n    // Apply sorting based on columnSortOptions\n    const sortOption = columnSortOptions[status] || \"oldest_first\";\n\n    return [...filtered].sort((a, b) => {\n      const daysA = a.createdAt ? Math.floor((new Date() - new Date(a.createdAt)) / (1000 * 60 * 60 * 24)) : 0;\n      const daysB = b.createdAt ? Math.floor((new Date() - new Date(b.createdAt)) / (1000 * 60 * 60 * 24)) : 0;\n\n      switch (sortOption) {\n        case \"oldest_first\":\n          return daysB - daysA; // More days = older = first\n        case \"newest_first\":\n          return daysA - daysB; // Fewer days = newer = first\n        case \"alphabetical\":\n          const nameA = `${a.make || \"\"} ${a.model || \"\"}`.toLowerCase();\n          const nameB = `${b.make || \"\"} ${b.model || \"\"}`.toLowerCase();\n          return nameA.localeCompare(nameB);\n        default:\n          return daysB - daysA;\n      }\n    });\n  };\n\n  const getFilterCount = (filter) => {\n    const allFiltered = getFilteredVehicles(vehicles.filter(v => {\n      const tasks = v.tasks || [];\n      const issues = v.issues || [];\n      const activeIssues = issues.filter(i => {\n        const status = (i.status || \"\").toLowerCase();\n        return [\"outstanding\", \"ordered\", \"in progress\", \"in_progress\"].includes(status);\n      });\n\n      if (filter === \"awaiting_pdi\") return !tasks.find(t => t.name.toLowerCase().includes(\"pdi\") && t.status === \"done\");\n      if (filter === \"awaiting_valet\") return !tasks.find(t => t.name.toLowerCase().includes(\"valet\") && t.status === \"done\");\n      if (filter === \"awaiting_photos\") return !tasks.find(t => t.name.toLowerCase().includes(\"photo\") && t.status === \"done\");\n      if (filter === \"awaiting_mot\") return !tasks.find(t => t.name.toLowerCase().includes(\"mot\") && t.status === \"done\");\n      if (filter === \"needs_paint\") return activeIssues.some(i => {\n        const cat = (i.category || \"\").toLowerCase();\n        return cat === \"bodywork\" || cat === \"cosmetic\";\n      });\n      if (filter === \"needs_mechanical\") return activeIssues.some(i => {\n        const cat = (i.category || \"\").toLowerCase();\n        return cat === \"mechanical\";\n      });\n      if (filter === \"needs_electrical\") return activeIssues.some(i => {\n        const cat = (i.category || \"\").toLowerCase();\n        return cat === \"electrical\";\n      });\n      if (filter === \"offsite\") return v.locationId != null;\n      if (filter === \"mot_due_soon\") {\n        if (!v.motExpiryDate) return false;\n        const expiry = new Date(v.motExpiryDate);\n        const now = new Date();\n        const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));\n        return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;\n      }\n      if (filter === \"mot_expired\") {\n        if (!v.motExpiryDate) return false;\n        const expiry = new Date(v.motExpiryDate);\n        return expiry < new Date();\n      }\n      if (filter === \"trade_only\") return v.saleType === \"TRADE\";\n      if (filter === \"retail_only\") return v.saleType === \"RETAIL\" || !v.saleType;\n      if (filter === \"type_stock\") return v.type === \"STOCK\" || !v.type;\n      if (filter === \"type_courtesy\") return v.type === \"COURTESY\";\n      if (filter === \"type_fleet\") return v.type === \"FLEET_OTHER\";\n      return false;\n    }));\n    return allFiltered.length;\n  };\n\n  // VRM Search functions\n  const getVrmSearchResults = () => {\n    if (vrmSearch.length < 2) return [];\n    const searchTerm = vrmSearch.toUpperCase().replace(/\\s/g, \"\");\n    return vehicles.filter(v => {\n      const reg = (v.regCurrent || \"\").toUpperCase().replace(/\\s/g, \"\");\n      return reg.includes(searchTerm);\n    }).slice(0, 8); // Limit to 8 results\n  };\n\n  const handleVrmSelect = (vehicle) => {\n    // Close dropdown and clear search\n    setVrmSearch(\"\");\n    setShowVrmDropdown(false);\n\n    // Find which column this vehicle is in and scroll to it\n    const columnIndex = COLUMNS.findIndex(col => col.key === vehicle.status);\n    if (columnIndex >= 0) {\n      // Scroll the column into view\n      const columnElements = document.querySelectorAll('[data-column-key]');\n      if (columnElements[columnIndex]) {\n        columnElements[columnIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });\n      }\n    }\n\n    // Open the vehicle drawer with full details\n    openVehicleDrawer(vehicle);\n  };\n\n  const getStatusLabel = (statusKey) => {\n    const col = COLUMNS.find(c => c.key === statusKey);\n    return col ? col.label : statusKey;\n  };\n\n  const handlePrintVehicle = () => {\n    if (!selectedVehicle) return;\n\n    const vehicle = selectedVehicle;\n    const tasks = vehicle.tasks || [];\n    const issues = vehicle.issues || [];\n    const documents = vehicle.documents || [];\n    const completedTasks = tasks.filter(t => t.status === \"done\").length;\n    const daysInStock = vehicle.createdAt\n      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))\n      : 0;\n\n    // Get status label from COLUMNS\n    const statusColumn = COLUMNS.find(col => col.key === vehicle.status);\n    const statusLabel = statusColumn ? statusColumn.label : vehicle.status;\n\n    // Generate HTML for print\n    const printContent = `\n<!DOCTYPE html>\n<html>\n<head>\n  <title>${vehicle.year || \"\"} ${vehicle.make} ${vehicle.model} - ${vehicle.regCurrent}</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }\n    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }\n    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }\n    .reg { font-size: 18px; font-family: monospace; color: #64748b; }\n    .section { margin-bottom: 30px; }\n    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }\n    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }\n    .field { margin-bottom: 12px; }\n    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }\n    .field-value { font-size: 14px; color: #1e293b; }\n    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }\n    .badge-status { background: #e0e7ff; color: #4338ca; }\n    .badge-days { background: ${daysInStock > 30 ? '#fef2f2' : '#f1f5f9'}; color: ${daysInStock > 30 ? '#dc2626' : '#475569'}; }\n    .task-list { list-style: none; }\n    .task-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }\n    .task-status { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }\n    .task-done { background: #dcfce7; color: #16a34a; }\n    .task-pending { background: #fef3c7; color: #d97706; }\n    .task-progress { background: #dbeafe; color: #2563eb; }\n    .issue-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }\n    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; }\n    .issue-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; }\n    .issue-desc { font-size: 14px; color: #1e293b; }\n    .doc-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }\n    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }\n    @media print {\n      body { padding: 20px; }\n      .no-print { display: none; }\n    }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <div class=\"title\">${vehicle.year || \"\"} ${vehicle.make} ${vehicle.model}</div>\n    <div class=\"reg\">${vehicle.regCurrent}</div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Overview</div>\n    <div style=\"display: flex; gap: 12px; margin-bottom: 16px;\">\n      <span class=\"badge badge-status\">${statusLabel}</span>\n      <span class=\"badge badge-days\">Days in Stock: ${daysInStock}</span>\n      ${vehicle.locationId ? `<span class=\"badge\" style=\"background:#eef2ff;color:#4f46e5;\">📍 ${vehicle.locationId.name || 'Offsite'}</span>` : '<span class=\"badge\" style=\"background:#f0fdf4;color:#16a34a;\">📍 On Site</span>'}\n    </div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Vehicle Details</div>\n    <div class=\"grid\">\n      <div class=\"field\">\n        <div class=\"field-label\">Registration</div>\n        <div class=\"field-value\">${vehicle.regCurrent || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">VIN</div>\n        <div class=\"field-value\">${vehicle.vin || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Make</div>\n        <div class=\"field-value\">${vehicle.make || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Model</div>\n        <div class=\"field-value\">${vehicle.model || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Year</div>\n        <div class=\"field-value\">${vehicle.year || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Mileage</div>\n        <div class=\"field-value\">${vehicle.mileageCurrent ? vehicle.mileageCurrent.toLocaleString() + ' miles' : '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Colour</div>\n        <div class=\"field-value\">${vehicle.colour || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">Fuel Type</div>\n        <div class=\"field-value\">${vehicle.fuelType || '—'}</div>\n      </div>\n      <div class=\"field\">\n        <div class=\"field-label\">MOT Expiry</div>\n        <div class=\"field-value\">${vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : '—'}</div>\n      </div>\n    </div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Prep Checklist (${completedTasks}/${tasks.length} complete)</div>\n    ${tasks.length > 0 ? `\n    <ul class=\"task-list\">\n      ${tasks.map(task => `\n        <li class=\"task-item\">\n          <span class=\"task-status ${task.status === 'done' ? 'task-done' : task.status === 'in_progress' ? 'task-progress' : 'task-pending'}\">\n            ${task.status === 'done' ? '✓' : task.status === 'in_progress' ? '→' : '○'}\n          </span>\n          <span style=\"${task.status === 'done' ? 'text-decoration: line-through; color: #94a3b8;' : ''}\">${task.name}</span>\n          ${task.completedAt ? `<span style=\"font-size: 11px; color: #94a3b8; margin-left: auto;\">${new Date(task.completedAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</span>` : ''}\n        </li>\n      `).join('')}\n    </ul>\n    ` : '<p style=\"color: #94a3b8; font-size: 14px;\">No tasks</p>'}\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Issues (${issues.length})</div>\n    ${issues.length > 0 ? issues.map(issue => `\n      <div class=\"issue-card\">\n        <div class=\"issue-header\">\n          <span class=\"issue-badge\">${issue.category}</span>\n          ${issue.subcategory ? `<span class=\"issue-badge\">${issue.subcategory}</span>` : ''}\n          <span class=\"issue-badge\" style=\"margin-left: auto;\">${issue.status || 'Outstanding'}</span>\n        </div>\n        <div class=\"issue-desc\">${issue.description}</div>\n        ${issue.actionNeeded ? `<div style=\"font-size: 12px; color: #64748b; margin-top: 6px;\">Action: ${issue.actionNeeded}</div>` : ''}\n      </div>\n    `).join('') : '<p style=\"color: #94a3b8; font-size: 14px;\">No issues recorded</p>'}\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Documents (${documents.length})</div>\n    ${documents.length > 0 ? documents.map(doc => `\n      <div class=\"doc-item\">\n        <span style=\"font-weight: 500;\">${doc.name}</span>\n        <span style=\"font-size: 12px; color: #94a3b8; margin-left: 8px;\">(${doc.type.replace(/_/g, ' ')})</span>\n      </div>\n    `).join('') : '<p style=\"color: #94a3b8; font-size: 14px;\">No documents uploaded</p>'}\n    ${vehicle.v5Url ? '<div class=\"doc-item\"><span style=\"font-weight: 500;\">V5 Document</span> <span style=\"font-size: 12px; color: #16a34a;\">✓ Uploaded</span></div>' : ''}\n  </div>\n\n  ${vehicle.notes ? `\n  <div class=\"section\">\n    <div class=\"section-title\">Notes</div>\n    <p style=\"font-size: 14px; white-space: pre-wrap;\">${vehicle.notes}</p>\n  </div>\n  ` : ''}\n\n  <div class=\"footer\">\n    Printed from DealerFlow on ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}\n  </div>\n</body>\n</html>\n    `;\n\n    // Open in new tab\n    const printWindow = window.open('', '_blank');\n    printWindow.document.write(printContent);\n    printWindow.document.close();\n  };\n\n  // Share utility with fallback chain: Web Share API → Clipboard → Manual modal\n  // SSR-safe: only runs client-side, with guards for browser API availability\n  const shareWithFallback = async (url, title, text) => {\n    // Guard against SSR - this should only run client-side\n    if (typeof window === \"undefined\" || typeof navigator === \"undefined\") {\n      return false;\n    }\n\n    // 1. Try Web Share API (native sharing on mobile/supported browsers)\n    if (typeof navigator.share === \"function\") {\n      try {\n        await navigator.share({ title, text, url });\n        return true;\n      } catch (error) {\n        // User cancelled or share failed - continue to fallback\n        if (error.name !== \"AbortError\") {\n          console.log(\"Web Share API failed, trying clipboard fallback\");\n        }\n      }\n    }\n\n    // 2. Try Clipboard API\n    if (navigator.clipboard && typeof navigator.clipboard.writeText === \"function\") {\n      try {\n        await navigator.clipboard.writeText(url);\n        toast.success(\"Link copied to clipboard!\");\n        return true;\n      } catch (error) {\n        console.log(\"Clipboard API failed, showing manual modal\");\n      }\n    }\n\n    // 3. Fallback to manual modal\n    setManualShareUrl(url);\n    setShowManualShareModal(true);\n    return false;\n  };\n\n  // Job sheet share handlers\n  const handleGenerateJobSheet = async () => {\n    if (!selectedVehicle) return;\n    setIsGeneratingJobSheet(true);\n    try {\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/job-sheet`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ expiresInDays: 60 }),\n      });\n      if (!res.ok) throw new Error(\"Failed to generate share link\");\n      const data = await res.json();\n      const fullUrl = `${window.location.origin}${data.shareUrl}`;\n      setJobSheetLink({\n        url: fullUrl,\n        expiresAt: data.expiresAt,\n      });\n      setShowJobSheetModal(true);\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsGeneratingJobSheet(false);\n    }\n  };\n\n  const copyJobSheetLink = async () => {\n    if (jobSheetLink?.url) {\n      await shareWithFallback(\n        jobSheetLink.url,\n        `Job Sheet - ${selectedVehicle?.regCurrent || \"Vehicle\"}`,\n        `Job sheet for ${selectedVehicle?.regCurrent}: ${jobSheetLink.url}`\n      );\n    }\n  };\n\n  const shareViaWhatsApp = () => {\n    if (typeof window === \"undefined\") return;\n    if (jobSheetLink?.url) {\n      const text = `Job sheet for ${selectedVehicle?.regCurrent || \"Vehicle\"}: ${jobSheetLink.url}`;\n      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, \"_blank\");\n    }\n  };\n\n  // Prep summary share handlers\n  const handleGeneratePrepSummary = async () => {\n    if (!selectedVehicle) return;\n    setIsGeneratingPrepSummary(true);\n    try {\n      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/prep-summary`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ expiresInDays: 60 }),\n      });\n      if (!res.ok) throw new Error(\"Failed to generate share link\");\n      const data = await res.json();\n      const fullUrl = `${window.location.origin}${data.shareUrl}`;\n      setPrepSummaryLink({\n        url: fullUrl,\n        expiresAt: data.expiresAt,\n      });\n      setShowPrepSummaryModal(true);\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsGeneratingPrepSummary(false);\n    }\n  };\n\n  const copyPrepSummaryLink = async () => {\n    if (prepSummaryLink?.url) {\n      await shareWithFallback(\n        prepSummaryLink.url,\n        `Prep Summary - ${selectedVehicle?.regCurrent || \"Vehicle\"}`,\n        `Prep summary for ${selectedVehicle?.regCurrent}: ${prepSummaryLink.url}`\n      );\n    }\n  };\n\n  const sharePrepSummaryViaWhatsApp = () => {\n    if (typeof window === \"undefined\") return;\n    if (prepSummaryLink?.url) {\n      const text = `Prep summary for ${selectedVehicle?.regCurrent || \"Vehicle\"}: ${prepSummaryLink.url}`;\n      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, \"_blank\");\n    }\n  };\n\n  const getMOTStatus = (motExpiryDate) => {\n    if (!motExpiryDate) {\n      return { type: \"unknown\", label: \"Unknown\", days: null, class: \"bg-slate-100 text-slate-500 border border-slate-200\" };\n    }\n    const expiry = new Date(motExpiryDate);\n    const now = new Date();\n    const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));\n\n    if (daysUntilExpiry < 0) {\n      const daysOverdue = Math.abs(daysUntilExpiry);\n      return { type: \"expired\", label: `Expired ${daysOverdue}d`, days: daysOverdue, class: \"bg-red-50 text-red-700 border border-red-200\" };\n    }\n    if (daysUntilExpiry <= 30) {\n      return { type: \"due_soon\", label: `${daysUntilExpiry}d`, days: daysUntilExpiry, class: \"bg-amber-50 text-amber-700 border border-amber-200\" };\n    }\n    return { type: \"valid\", label: `${daysUntilExpiry}d`, days: daysUntilExpiry, class: null };\n  };\n\n  const getActiveIssuesByCategory = (issues = []) => {\n    const activeIssues = issues.filter(i => {\n      const status = (i.status || \"\").toLowerCase();\n      return [\"outstanding\", \"ordered\", \"in_progress\", \"in progress\"].includes(status);\n    });\n    const categoryCounts = {};\n    activeIssues.forEach(issue => {\n      categoryCounts[issue.category] = (categoryCounts[issue.category] || 0) + 1;\n    });\n    return categoryCounts;\n  };\n\n  return (\n    <DashboardLayout>\n      <Head><title>Stock & Prep | DealerFlow</title></Head>\n\n      <div className=\"flex justify-between items-center mb-6\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Stock & Prep Board</h1>\n          <p className=\"text-base-content/60 mt-1\">Manage vehicle prep and sales pipeline &bull; Drag cards to move between stages</p>\n        </div>\n        <button className=\"btn btn-primary\" onClick={() => setShowAddModal(true)}>\n          + Add Vehicle\n        </button>\n      </div>\n\n      {/* Consolidated Filters */}\n      <div className=\"sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-slate-200 mb-4 -mx-6 px-6 py-4\">\n        <div className=\"flex gap-2 items-center\">\n            {/* VRM Search */}\n            <div className=\"relative\">\n              <div className=\"relative\">\n                <svg className=\"w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n                </svg>\n                <input\n                  type=\"text\"\n                  placeholder=\"Search VRM...\"\n                  className=\"input input-sm input-bordered pl-9 pr-8 w-44 font-mono uppercase\"\n                  value={vrmSearch}\n                  onChange={(e) => {\n                    setVrmSearch(e.target.value.toUpperCase());\n                    setShowVrmDropdown(e.target.value.length >= 2);\n                  }}\n                  onFocus={() => vrmSearch.length >= 2 && setShowVrmDropdown(true)}\n                  onKeyDown={(e) => {\n                    if (e.key === \"Escape\") {\n                      setShowVrmDropdown(false);\n                      e.target.blur();\n                    }\n                  }}\n                />\n                {vrmSearch && (\n                  <button\n                    className=\"absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600\"\n                    onClick={() => {\n                      setVrmSearch(\"\");\n                      setShowVrmDropdown(false);\n                    }}\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                    </svg>\n                  </button>\n                )}\n              </div>\n\n              {/* VRM Search Dropdown */}\n              {showVrmDropdown && (\n                <>\n                  <div className=\"fixed inset-0 z-10\" onClick={() => setShowVrmDropdown(false)}></div>\n                  <div className=\"absolute top-full left-0 mt-1 w-72 bg-white rounded-xl shadow-xl border border-slate-200 z-20 overflow-hidden\">\n                    {getVrmSearchResults().length > 0 ? (\n                      <ul className=\"py-1 max-h-64 overflow-y-auto\">\n                        {getVrmSearchResults().map((vehicle) => (\n                          <li key={vehicle.id || vehicle._id}>\n                            <button\n                              className=\"w-full px-4 py-2.5 text-left hover:bg-slate-50 flex items-center justify-between gap-2 transition-colors\"\n                              onClick={() => handleVrmSelect(vehicle)}\n                            >\n                              <div className=\"flex items-center gap-3\">\n                                <span className=\"font-mono font-bold text-slate-900\">{vehicle.regCurrent}</span>\n                                <span className=\"text-sm text-slate-500\">{vehicle.make} {vehicle.model}</span>\n                              </div>\n                              <span className=\"text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600\">\n                                {getStatusLabel(vehicle.status)}\n                              </span>\n                            </button>\n                          </li>\n                        ))}\n                      </ul>\n                    ) : (\n                      <div className=\"px-4 py-6 text-center\">\n                        <svg className=\"w-8 h-8 mx-auto text-slate-300 mb-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                        </svg>\n                        <p className=\"text-sm text-slate-500\">No vehicles found</p>\n                        <p className=\"text-xs text-slate-400 mt-1\">Try a different registration</p>\n                      </div>\n                    )}\n                  </div>\n                </>\n              )}\n            </div>\n\n            <div className=\"divider divider-horizontal mx-1\"></div>\n\n            {/* All Vehicles Button */}\n            <button\n              className={`btn btn-sm ${activeFilters.length === 0 ? \"btn-primary\" : \"btn-outline\"}`}\n              onClick={() => setActiveFilters([])}\n            >\n              All Vehicles ({vehicles.length})\n            </button>\n\n            <div className=\"divider divider-horizontal mx-1\"></div>\n\n            {/* Consolidated Filters - Strictly Separated Desktop/Mobile */}\n            <div className=\"shrink-0\">\n              {/* Trigger Button */}\n              <button\n                ref={filterButtonRef}\n                className={`flex items-center gap-2 px-3 py-2 rounded-lg shrink-0 whitespace-nowrap text-sm font-medium transition-all ${\n                  activeFilters.length > 0\n                    ? \"bg-blue-600 text-white\"\n                    : \"bg-white border border-slate-200 text-slate-700 hover:border-slate-300\"\n                }`}\n                onClick={() => showFiltersDropdown ? setShowFiltersDropdown(false) : openFiltersDropdown()}\n              >\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\" />\n                </svg>\n                <span className=\"hidden sm:inline\">Filters</span>\n                {activeFilters.length > 0 && (\n                  <span className={`text-xs px-1.5 py-0.5 rounded-full ${\n                    activeFilters.length > 0 ? \"bg-white/20 text-white\" : \"bg-slate-100 text-slate-600\"\n                  }`}>{activeFilters.length}</span>\n                )}\n              </button>\n\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              {/* DESKTOP: Fixed Popover via Portal (lg: and up) */}\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              {showFiltersDropdown && (\n                <Portal>\n                  <div className=\"hidden lg:block fixed inset-0 z-[9998]\">\n                    {/* Backdrop */}\n                    <div\n                      className=\"fixed inset-0\"\n                      onClick={() => setShowFiltersDropdown(false)}\n                    />\n\n                    {/* Desktop Filter Panel - Fixed position, viewport-clamped */}\n                    <div\n                      className=\"fixed w-[360px] max-h-[70vh] bg-white rounded-xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden\"\n                      style={{ top: filterPopoverPos.top, right: filterPopoverPos.right }}\n                    >\n                      {/* Sticky Header */}\n                      <div className=\"flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-white shrink-0\">\n                        <h3 className=\"font-semibold text-slate-900\">Filters</h3>\n                        <button\n                          onClick={() => setShowFiltersDropdown(false)}\n                          className=\"p-1 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors\"\n                        >\n                          <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                          </svg>\n                        </button>\n                      </div>\n\n                      {/* Scrollable Content */}\n                      <div className=\"flex-1 overflow-y-auto p-4 space-y-5\">\n                        {/* Prep Tasks Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Prep Tasks</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"awaiting_pdi\", label: \"Awaiting PDI\" },\n                              { key: \"awaiting_valet\", label: \"Awaiting Valet\" },\n                              { key: \"awaiting_photos\", label: \"Awaiting Photos\" },\n                              { key: \"awaiting_mot\", label: \"Awaiting MOT\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* Issues Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Issues</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"needs_paint\", label: \"Needs Paint\" },\n                              { key: \"needs_mechanical\", label: \"Needs Mechanical\" },\n                              { key: \"needs_electrical\", label: \"Needs Electrical\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* Location Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Location</h5>\n                          <div className=\"space-y-1.5\">\n                            {(() => {\n                              const isActive = activeFilters.includes(\"offsite\");\n                              const count = getFilterCount(\"offsite\");\n                              return (\n                                <button\n                                  onClick={() => toggleFilter(\"offsite\")}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>Offsite Only</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })()}\n                          </div>\n                        </div>\n\n                        {/* Vehicle Type Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Vehicle Type</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"type_stock\", label: \"Stock Vehicles\" },\n                              { key: \"type_courtesy\", label: \"Courtesy Vehicles\" },\n                              { key: \"type_fleet\", label: \"Fleet Vehicles\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* Sale Type Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">Sale Type</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"trade_only\", label: \"Trade Only\" },\n                              { key: \"retail_only\", label: \"Retail Only\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n\n                        {/* MOT Status Section */}\n                        <div>\n                          <h5 className=\"text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2\">MOT Status</h5>\n                          <div className=\"space-y-1.5\">\n                            {[\n                              { key: \"mot_expired\", label: \"MOT Expired\" },\n                              { key: \"mot_due_soon\", label: \"MOT Due Soon\" },\n                            ].map(filter => {\n                              const isActive = activeFilters.includes(filter.key);\n                              const count = getFilterCount(filter.key);\n                              return (\n                                <button\n                                  key={filter.key}\n                                  onClick={() => toggleFilter(filter.key)}\n                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${\n                                    isActive\n                                      ? \"bg-blue-50 text-blue-700 ring-1 ring-blue-200\"\n                                      : \"text-slate-600 hover:bg-slate-50\"\n                                  }`}\n                                >\n                                  <span>{filter.label}</span>\n                                  <span className={`text-xs px-1.5 py-0.5 rounded ${\n                                    isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                                  }`}>{count}</span>\n                                </button>\n                              );\n                            })}\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Sticky Footer */}\n                      <div className=\"border-t border-slate-200 p-3 bg-white flex gap-2 shrink-0\">\n                        <button\n                          onClick={() => setActiveFilters([])}\n                          className=\"flex-1 px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors\"\n                        >\n                          Clear\n                        </button>\n                        <button\n                          onClick={() => setShowFiltersDropdown(false)}\n                          className=\"flex-1 bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-800 transition-colors\"\n                        >\n                          Apply\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                </Portal>\n              )}\n\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              {/* MOBILE/TABLET: Bottom Sheet (< lg screens) */}\n              {/* Uses its own internal Portal for correct positioning */}\n              {/* ═══════════════════════════════════════════════════════════════ */}\n              <BottomSheet\n                    isOpen={showFiltersDropdown}\n                    onClose={() => setShowFiltersDropdown(false)}\n                    hideAbove=\"lg\"\n                    title=\"Filters\"\n                    footer={\n                      <div className=\"flex gap-3\">\n                        <button\n                          onClick={() => setActiveFilters([])}\n                          className=\"flex-1 px-4 py-3 text-base font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors\"\n                        >\n                          Clear\n                        </button>\n                        <button\n                          onClick={() => setShowFiltersDropdown(false)}\n                          className=\"flex-1 bg-slate-900 text-white py-3 rounded-xl text-base font-bold hover:bg-slate-800 transition-colors\"\n                        >\n                          Apply {activeFilters.length > 0 && `(${activeFilters.length})`}\n                        </button>\n                      </div>\n                    }\n                  >\n                    {/* Prep Tasks */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3\">Prep Tasks</h5>\n                    {[\n                      { key: \"awaiting_pdi\", label: \"Awaiting PDI\" },\n                      { key: \"awaiting_valet\", label: \"Awaiting Valet\" },\n                      { key: \"awaiting_photos\", label: \"Awaiting Photos\" },\n                      { key: \"awaiting_mot\", label: \"Awaiting MOT\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* Issues */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Issues</h5>\n                    {[\n                      { key: \"needs_paint\", label: \"Needs Paint\" },\n                      { key: \"needs_mechanical\", label: \"Needs Mechanical\" },\n                      { key: \"needs_electrical\", label: \"Needs Electrical\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* Location */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Location</h5>\n                    {(() => {\n                      const isActive = activeFilters.includes(\"offsite\");\n                      const count = getFilterCount(\"offsite\");\n                      return (\n                        <button\n                          onClick={() => toggleFilter(\"offsite\")}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>Offsite Only</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })()}\n\n                    {/* Vehicle Type */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Vehicle Type</h5>\n                    {[\n                      { key: \"type_stock\", label: \"Stock Vehicles\" },\n                      { key: \"type_courtesy\", label: \"Courtesy Vehicles\" },\n                      { key: \"type_fleet\", label: \"Fleet Vehicles\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* Sale Type */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">Sale Type</h5>\n                    {[\n                      { key: \"trade_only\", label: \"Trade Only\" },\n                      { key: \"retail_only\", label: \"Retail Only\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n\n                    {/* MOT Status */}\n                    <h5 className=\"text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6\">MOT Status</h5>\n                    {[\n                      { key: \"mot_expired\", label: \"MOT Expired\" },\n                      { key: \"mot_due_soon\", label: \"MOT Due Soon\" },\n                    ].map(filter => {\n                      const isActive = activeFilters.includes(filter.key);\n                      const count = getFilterCount(filter.key);\n                      return (\n                        <button\n                          key={filter.key}\n                          onClick={() => toggleFilter(filter.key)}\n                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${\n                            isActive\n                              ? \"bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm\"\n                              : \"text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100\"\n                          }`}\n                        >\n                          <span>{filter.label}</span>\n                          <span className={`text-sm px-2.5 py-1 rounded-lg ${\n                            isActive ? \"bg-blue-100 text-blue-700\" : \"bg-slate-100 text-slate-500\"\n                          }`}>{count}</span>\n                        </button>\n                      );\n                    })}\n                  </BottomSheet>\n            </div>\n          </div>\n      </div>\n\n      {isLoading ? (\n        <div className=\"flex justify-center py-20\">\n          <span className=\"loading loading-spinner loading-lg\"></span>\n        </div>\n      ) : (\n        <>\n          {/* Mobile Column Tabs - Dropdown for clearer UX */}\n          <div className=\"md:hidden mb-4\">\n            <MobileStageSelector\n              stages={COLUMNS.map((col) => ({\n                value: col.key,\n                label: col.label,\n                count: getVehiclesByStatus(col.key).length,\n              }))}\n              activeStage={mobileActiveColumn}\n              onStageChange={setMobileActiveColumn}\n            />\n          </div>\n\n          {/* Mobile Single Column View */}\n          <div className=\"md:hidden\">\n            {COLUMNS.filter(col => col.key === mobileActiveColumn).map((col) => {\n              const columnVehicles = getVehiclesByStatus(col.key);\n\n              // Issue category styling with icons (mobile)\n              const issueCategoryStyles = {\n                Mechanical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                  </svg>\n                )},\n                Cosmetic: { bg: \"bg-teal-50\", text: \"text-teal-700\", border: \"border-teal-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01\" />\n                  </svg>\n                )},\n                Electrical: { bg: \"bg-yellow-50\", text: \"text-yellow-800\", border: \"border-yellow-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\n                  </svg>\n                )},\n                Other: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\", icon: (\n                  <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                  </svg>\n                )},\n              };\n\n              return (\n                <div key={col.key} className=\"space-y-3\">\n                  {columnVehicles.map((vehicle) => {\n                    const tasks = vehicle.tasks || [];\n                    const completedTasks = tasks.filter(t => t.status === \"done\").length;\n                    const motStatus = getMOTStatus(vehicle.motExpiryDate);\n                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);\n                    const duration = getVehicleDuration(vehicle);\n\n                    return (\n                      <div\n                        key={vehicle.id}\n                        className=\"bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100/50 overflow-hidden active:scale-[0.98]\"\n                        onClick={() => openVehicleDrawer(vehicle)}\n                      >\n                        <div className=\"p-4\">\n                          {/* Title with Registration Badge */}\n                          <div className=\"flex justify-between items-start mb-2\">\n                            <div className=\"flex-1\">\n                              <div className=\"flex items-center gap-2 flex-wrap mb-1\">\n                                <p className=\"font-bold text-slate-900 text-base\">\n                                  {vehicle.year || \"\"} {vehicle.make} {vehicle.model}\n                                </p>\n                                <span className=\"font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md\">\n                                  {vehicle.regCurrent}\n                                </span>\n                              </div>\n                            </div>\n                            {/* Duration badge - Sold or In Stock */}\n                            <span className={`inline-flex items-center gap-1 text-xs ${\n                              duration.isSold ? \"text-emerald-600\" : duration.days > 30 ? \"text-red-500\" : \"text-slate-400\"\n                            }`}>\n                              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                              {duration.label}\n                            </span>\n                          </div>\n\n                          {/* Tags - Modern Pill Style */}\n                          <div className=\"flex gap-1.5 flex-wrap mb-3\">\n                            {vehicle.locationId && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-[#0066CC]/10 text-[#0066CC] border border-[#0066CC]/20\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                </svg>\n                                {vehicle.locationId.name || \"Offsite\"}\n                              </span>\n                            )}\n                            {vehicle.saleType === \"TRADE\" && (\n                              <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase\">\n                                Trade\n                              </span>\n                            )}\n                            {vehicle.type === \"COURTESY\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-cyan-600 text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                Courtesy\n                              </span>\n                            )}\n                            {vehicle.type === \"FLEET_OTHER\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-[#0066CC] text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                                </svg>\n                                Fleet\n                              </span>\n                            )}\n                            {motStatus?.type === \"expired\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"due_soon\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"valid\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"unknown\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-slate-100 text-slate-500 border border-slate-200\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT ?\n                              </span>\n                            )}\n                            {/* Issue Pills with Icons */}\n                            {Object.entries(issueCounts).map(([category, count]) => {\n                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;\n                              return (\n                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>\n                                  {style.icon}\n                                  {count} {category}\n                                </span>\n                              );\n                            })}\n                            {/* Custom Labels */}\n                            {vehicle.labels?.map((label) => (\n                              <span\n                                key={label.id}\n                                className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border\"\n                                style={{\n                                  backgroundColor: `${label.colour}10`,\n                                  color: label.colour,\n                                  borderColor: `${label.colour}30`,\n                                }}\n                              >\n                                <span className=\"w-1.5 h-1.5 rounded-full\" style={{ backgroundColor: label.colour }}></span>\n                                {label.name}\n                              </span>\n                            ))}\n                          </div>\n\n                          {/* Slick Progress Bar */}\n                          {tasks.length > 0 && (\n                            <div>\n                              <span className=\"text-xs text-slate-400 mb-1 block\">\n                                {completedTasks}/{tasks.length} tasks\n                              </span>\n                              <div className=\"w-full bg-slate-100 rounded-full h-2\">\n                                <div\n                                  className=\"h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400\"\n                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}\n                                ></div>\n                              </div>\n                            </div>\n                          )}\n                        </div>\n                      </div>\n                    );\n                  })}\n                  {columnVehicles.length === 0 && (\n                    <div className=\"text-center py-12 text-slate-400\">\n                      <p className=\"text-sm\">No vehicles in {col.label}</p>\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Mobile Floating Action Button */}\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"md:hidden fixed fab-safe right-4 z-40 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all active:scale-95\"\n          >\n            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n            </svg>\n          </button>\n\n          {/* Desktop Multi-Column View */}\n          <div className=\"hidden md:flex gap-4 overflow-x-auto pb-6\">\n            {COLUMNS.map((col) => {\n              const columnVehicles = getVehiclesByStatus(col.key);\n              return (\n                <div\n                  key={col.key}\n                  data-column-key={col.key}\n                  className={`flex-shrink-0 w-64 bg-gradient-to-b ${col.gradient} to-transparent rounded-2xl p-3 min-h-[400px]`}\n                  onDragOver={handleDragOver}\n                onDrop={(e) => handleDrop(e, col.key)}\n              >\n                {/* Integrated Header */}\n                <div className=\"flex items-center justify-between mb-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <h3 className=\"font-semibold text-slate-700 text-sm\">\n                      {col.label}\n                    </h3>\n                    <span className=\"bg-slate-900/10 text-slate-700 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center\">\n                      {columnVehicles.length}\n                    </span>\n                  </div>\n                  <div className=\"dropdown dropdown-end\">\n                    <label tabIndex={0} className=\"btn btn-ghost btn-xs gap-1 bg-white/30 backdrop-blur-sm hover:bg-white/50 rounded-full\">\n                      <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12\" />\n                      </svg>\n                      <span className=\"text-xs\">\n                        {columnSortOptions[col.key] === \"newest_first\" ? \"Newest\" :\n                         columnSortOptions[col.key] === \"alphabetical\" ? \"A-Z\" : \"Oldest\"}\n                      </span>\n                    </label>\n                    <ul tabIndex={0} className=\"dropdown-content z-30 menu p-2 shadow-lg bg-white rounded-xl w-44 mt-2\">\n                      <li>\n                        <button\n                          className={`rounded-lg ${columnSortOptions[col.key] === \"oldest_first\" || !columnSortOptions[col.key] ? \"active bg-slate-100\" : \"\"}`}\n                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"oldest_first\" }))}\n                        >\n                          Oldest First\n                        </button>\n                      </li>\n                      <li>\n                        <button\n                          className={`rounded-lg ${columnSortOptions[col.key] === \"newest_first\" ? \"active bg-slate-100\" : \"\"}`}\n                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"newest_first\" }))}\n                        >\n                          Newest First\n                        </button>\n                      </li>\n                      <li>\n                        <button\n                          className={`rounded-lg ${columnSortOptions[col.key] === \"alphabetical\" ? \"active bg-slate-100\" : \"\"}`}\n                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"alphabetical\" }))}\n                        >\n                          Alphabetical (Make/Model)\n                        </button>\n                      </li>\n                    </ul>\n                  </div>\n                </div>\n\n                {/* Cards Container */}\n                <div className=\"space-y-3\">\n                  {columnVehicles.map((vehicle) => {\n                    const tasks = vehicle.tasks || [];\n                    const completedTasks = tasks.filter(t => t.status === \"done\").length;\n                    const motStatus = getMOTStatus(vehicle.motExpiryDate);\n                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);\n                    const duration = getVehicleDuration(vehicle);\n\n                    // Issue category styling with icons\n                    const issueCategoryStyles = {\n                      Mechanical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                        </svg>\n                      )},\n                      Cosmetic: { bg: \"bg-teal-50\", text: \"text-teal-700\", border: \"border-teal-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01\" />\n                        </svg>\n                      )},\n                      Electrical: { bg: \"bg-yellow-50\", text: \"text-yellow-800\", border: \"border-yellow-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 10V3L4 14h7v7l9-11h-7z\" />\n                        </svg>\n                      )},\n                      Other: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\", icon: (\n                        <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                        </svg>\n                      )},\n                    };\n\n                    return (\n                      <div\n                        key={vehicle.id}\n                        draggable\n                        onDragStart={(e) => handleDragStart(e, vehicle)}\n                        onDrag={handleDrag}\n                        onDragEnd={handleDragEnd}\n                        className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all cursor-grab active:cursor-grabbing border border-slate-100/50 overflow-hidden ${draggedCard?.id === vehicle.id ? \"opacity-40 scale-95\" : \"\"}`}\n                        onClick={() => openVehicleDrawer(vehicle)}\n                      >\n                        <div className=\"p-3\">\n                          {/* Title with Registration Badge */}\n                          <div className=\"flex justify-between items-start mb-2\">\n                            <div className=\"flex-1 min-w-0\">\n                              <div className=\"flex items-center gap-2 flex-wrap\">\n                                <p className=\"font-bold text-slate-900 text-sm leading-tight\">\n                                  {vehicle.year || \"\"} {vehicle.make} {vehicle.model}\n                                </p>\n                                <span className=\"font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md\">\n                                  {vehicle.regCurrent}\n                                </span>\n                              </div>\n                            </div>\n                          </div>\n\n                          {/* Tags - Modern Pill Style */}\n                          <div className=\"flex gap-1.5 flex-wrap mb-2\">\n                            {/* Trade badge */}\n                            {vehicle.saleType === \"TRADE\" && (\n                              <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase\">\n                                Trade\n                              </span>\n                            )}\n                            {/* Courtesy/Fleet badges */}\n                            {vehicle.type === \"COURTESY\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-cyan-600 text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                Courtesy\n                              </span>\n                            )}\n                            {vehicle.type === \"FLEET_OTHER\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-[#0066CC] text-white uppercase\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4\" />\n                                </svg>\n                                Fleet\n                              </span>\n                            )}\n                            {motStatus?.type === \"expired\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"due_soon\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"valid\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT {vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : motStatus.label}\n                              </span>\n                            )}\n                            {motStatus?.type === \"unknown\" && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-slate-100 text-slate-500 border border-slate-200\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                                </svg>\n                                MOT ?\n                              </span>\n                            )}\n                            {/* Issue Pills with Icons */}\n                            {Object.entries(issueCounts).map(([category, count]) => {\n                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;\n                              return (\n                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>\n                                  {style.icon}\n                                  {count} {category}\n                                </span>\n                              );\n                            })}\n                            {vehicle.locationId && (\n                              <span className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-[#0066CC]/10 text-[#0066CC] border border-[#0066CC]/20\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                </svg>\n                                {vehicle.locationId.name}\n                              </span>\n                            )}\n                            {/* Custom Labels */}\n                            {vehicle.labels?.map((label) => (\n                              <span\n                                key={label.id}\n                                className=\"inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border\"\n                                style={{\n                                  backgroundColor: `${label.colour}10`,\n                                  color: label.colour,\n                                  borderColor: `${label.colour}30`,\n                                }}\n                              >\n                                <span className=\"w-1.5 h-1.5 rounded-full\" style={{ backgroundColor: label.colour }}></span>\n                                {label.name}\n                              </span>\n                            ))}\n                          </div>\n\n                          {/* Slick Progress Bar */}\n                          {tasks.length > 0 && (\n                            <div className=\"mb-2\">\n                              <span className=\"text-xs text-slate-400 mb-1 block\">\n                                {completedTasks}/{tasks.length} tasks\n                              </span>\n                              <div className=\"w-full bg-slate-100 rounded-full h-2\">\n                                <div\n                                  className=\"h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400\"\n                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}\n                                ></div>\n                              </div>\n                            </div>\n                          )}\n\n                          {/* Footer - Duration (Sold or In Stock) */}\n                          <div className=\"pt-2 border-t border-slate-100 flex items-center justify-between\">\n                            <span className={`inline-flex items-center gap-1 text-[10px] font-medium ${\n                              duration.isSold ? \"text-emerald-600\" : duration.days > 30 ? \"text-red-500\" : \"text-slate-400\"\n                            }`}>\n                              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                              {duration.label}\n                            </span>\n                            {!duration.isSold && duration.days > 30 && (\n                              <span className=\"inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-500 border border-red-100\">\n                                Aging\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n\n                  {/* Empty State */}\n                  {columnVehicles.length === 0 && (\n                    <div className=\"text-center py-8 px-4\">\n                      <div className=\"w-12 h-12 mx-auto mb-3 rounded-full bg-white/50 flex items-center justify-center\">\n                        <svg className=\"w-6 h-6 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={1.5} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                        </svg>\n                      </div>\n                      <p className=\"text-sm text-slate-500 font-medium\">No vehicles</p>\n                      <p className=\"text-xs text-slate-400 mt-1\">Drag cards here to move</p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            );\n          })}\n          </div>\n        </>\n      )}\n\n      {/* Vehicle Detail Drawer - Full Screen on Mobile */}\n      {selectedVehicle && (\n        <div className=\"fixed inset-0 z-50 flex justify-end\">\n          <div className=\"bg-black/50 absolute inset-0 hidden md:block\" onClick={() => setSelectedVehicle(null)}></div>\n          <div className=\"relative bg-white w-full md:max-w-3xl h-full overflow-y-auto flex flex-col\">\n            {/* Sticky Header */}\n            <div className=\"sticky top-0 bg-white border-b border-slate-200 px-4 md:px-6 py-3 md:py-4 flex justify-between items-center z-10\">\n              <div className=\"flex items-center gap-3\">\n                {/* Back button on mobile */}\n                <button className=\"md:hidden btn btn-ghost btn-sm btn-circle\" onClick={() => setSelectedVehicle(null)}>\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <div>\n                  <h2 className=\"text-lg md:text-xl font-bold text-slate-900\">\n                    {selectedVehicle.year || \"\"} {selectedVehicle.make} {selectedVehicle.model}\n                  </h2>\n                  <p className=\"text-xs md:text-sm text-slate-500 font-mono mt-0.5\">{selectedVehicle.regCurrent}</p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-1 md:gap-2\">\n                <button\n                  className=\"hidden md:flex btn btn-outline btn-sm\"\n                  onClick={handleGenerateJobSheet}\n                  disabled={isGeneratingJobSheet}\n                  title=\"Share job sheet with mechanic\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z\" />\n                  </svg>\n                  {isGeneratingJobSheet ? \"...\" : \"Share\"}\n                </button>\n                <button\n                  className=\"hidden md:flex btn btn-outline btn-sm\"\n                  onClick={handleGeneratePrepSummary}\n                  disabled={isGeneratingPrepSummary}\n                  title=\"Export prep summary PDF\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                  </svg>\n                  {isGeneratingPrepSummary ? \"...\" : \"Prep PDF\"}\n                </button>\n                <button className=\"hidden md:flex btn btn-outline btn-sm\" onClick={handlePrintVehicle} title=\"Print vehicle details\">\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                  </svg>\n                  Print\n                </button>\n                <button\n                  className=\"btn btn-ghost btn-sm text-error\"\n                  onClick={async () => {\n                    if (confirm(\"Delete this vehicle?\")) {\n                      await fetch(`/api/vehicles/${selectedVehicle.id}`, { method: \"DELETE\" });\n                      setSelectedVehicle(null);\n                      fetchVehicles();\n                      toast.success(\"Vehicle deleted\");\n                    }\n                  }}\n                  title=\"Delete vehicle\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                  </svg>\n                </button>\n                <button className=\"hidden md:flex btn btn-ghost btn-sm\" onClick={() => setSelectedVehicle(null)}>\n                  ✕\n                </button>\n              </div>\n            </div>\n\n            {/* Tabs - Using DaisyUI tabs */}\n            <div className=\"bg-base-100 border-b border-base-300 px-4\">\n              <div className=\"tabs tabs-bordered\">\n                <button\n                  className={`tab ${activeTab === \"overview\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"overview\")}\n                >\n                  Overview\n                </button>\n                <button\n                  className={`tab ${activeTab === \"checklist\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"checklist\")}\n                >\n                  Checklist {selectedVehicle.tasks?.length > 0 && `(${selectedVehicle.tasks.length})`}\n                </button>\n                <button\n                  className={`tab ${activeTab === \"issues\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"issues\")}\n                >\n                  Issues {selectedVehicle.issues?.length > 0 && `(${selectedVehicle.issues.length})`}\n                </button>\n                <button\n                  className={`tab ${activeTab === \"documents\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => setActiveTab(\"documents\")}\n                >\n                  Documents {selectedVehicle.documents?.length > 0 && `(${selectedVehicle.documents.length})`}\n                </button>\n                <button\n                  className={`tab ${activeTab === \"activity\" ? \"tab-active\" : \"\"}`}\n                  onClick={() => {\n                    setActiveTab(\"activity\");\n                    if (selectedVehicle?.id) {\n                      fetchActivity(selectedVehicle.id);\n                    }\n                  }}\n                >\n                  Activity\n                </button>\n              </div>\n            </div>\n\n            <div className=\"p-6 space-y-6\">\n              {/* Overview Tab */}\n              {activeTab === \"overview\" && (\n                <div className=\"space-y-6\">\n                  {/* Identity Section */}\n                  <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                    <h3 className=\"text-sm font-semibold text-slate-900 mb-4\">Identity</h3>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Registration</label>\n                        <div className=\"flex gap-2\">\n                          <input\n                            type=\"text\"\n                            className=\"input input-sm bg-slate-50 border-slate-200 text-slate-900 flex-1 font-mono uppercase\"\n                            value={selectedVehicle.regCurrent || \"\"}\n                            onChange={(e) => setSelectedVehicle({ ...selectedVehicle, regCurrent: e.target.value.toUpperCase() })}\n                            onBlur={async () => {\n                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                method: \"PUT\",\n                                headers: { \"Content-Type\": \"application/json\" },\n                                body: JSON.stringify({ regCurrent: selectedVehicle.regCurrent }),\n                              });\n                              fetchVehicles();\n                            }}\n                          />\n                          <button\n                            type=\"button\"\n                            className=\"btn btn-sm btn-primary\"\n                            onClick={lookupVehicleDVLA}\n                            disabled={isLookingUpDrawer}\n                            title=\"Lookup DVLA data for this registration\"\n                          >\n                            {isLookingUpDrawer ? (\n                              <span className=\"loading loading-spinner loading-xs\"></span>\n                            ) : (\n                              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n                              </svg>\n                            )}\n                          </button>\n                        </div>\n                        <p className=\"text-xs text-slate-400 mt-1\">Click lookup to refresh DVLA data</p>\n                      </div>\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">VIN</label>\n                        <input\n                          type=\"text\"\n                          className=\"input input-sm bg-slate-50 border-slate-200 text-slate-900\"\n                          value={selectedVehicle.vin || \"\"}\n                          onChange={(e) => setSelectedVehicle({ ...selectedVehicle, vin: e.target.value })}\n                          onBlur={async () => {\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify({ vin: selectedVehicle.vin }),\n                            });\n                            fetchVehicles();\n                          }}\n                        />\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Custom Labels Section */}\n                  <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                    <h3 className=\"text-sm font-semibold text-slate-900 mb-3\">Custom Labels</h3>\n\n                    {/* Applied Labels Display */}\n                    {selectedVehicle.labels?.length > 0 && (\n                      <div className=\"flex flex-wrap gap-2 mb-3\">\n                        {selectedVehicle.labels.map((label) => (\n                          <span\n                            key={label.id}\n                            className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold\"\n                            style={{\n                              backgroundColor: `${label.colour}20`,\n                              color: label.colour,\n                            }}\n                          >\n                            <span className=\"w-2 h-2 rounded-full\" style={{ backgroundColor: label.colour }}></span>\n                            {label.name}\n                            <button\n                              type=\"button\"\n                              onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}\n                              className=\"ml-0.5 hover:opacity-70\"\n                            >\n                              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                              </svg>\n                            </button>\n                          </span>\n                        ))}\n                      </div>\n                    )}\n\n                    {/* Labels Dropdown */}\n                    <div className=\"relative\">\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowLabelsDropdown(!showLabelsDropdown)}\n                        className=\"w-full flex items-center justify-between px-3 py-2 border border-slate-300 rounded-lg bg-white text-sm hover:border-slate-400 transition-colors\"\n                      >\n                        <span className=\"text-slate-600\">\n                          {selectedVehicle.labels?.length > 0\n                            ? `${selectedVehicle.labels.length} label${selectedVehicle.labels.length > 1 ? 's' : ''} selected`\n                            : \"Select labels...\"\n                          }\n                        </span>\n                        <svg className={`w-4 h-4 text-slate-400 transition-transform ${showLabelsDropdown ? 'rotate-180' : ''}`} fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                        </svg>\n                      </button>\n\n                      {showLabelsDropdown && (\n                        <div className=\"absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-auto\">\n                          {availableLabels.map((label) => {\n                            const isApplied = selectedVehicle.labels?.some(l => l.id === label.id);\n                            return (\n                              <button\n                                key={label.id}\n                                type=\"button\"\n                                onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}\n                                className=\"w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left\"\n                              >\n                                <span\n                                  className=\"w-3 h-3 rounded-full flex-shrink-0\"\n                                  style={{ backgroundColor: label.colour }}\n                                ></span>\n                                <span className=\"flex-1 text-sm text-slate-700\">{label.name}</span>\n                                {isApplied && (\n                                  <svg className=\"w-4 h-4 text-green-500\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                                    <path fillRule=\"evenodd\" d=\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                                  </svg>\n                                )}\n                              </button>\n                            );\n                          })}\n\n                          {/* Add New Label Option */}\n                          <div className=\"border-t border-slate-100\">\n                            <button\n                              type=\"button\"\n                              onClick={() => {\n                                setShowLabelsDropdown(false);\n                                setShowAddLabelModal(true);\n                              }}\n                              className=\"w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left text-[#0066CC]\"\n                            >\n                              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                              </svg>\n                              <span className=\"text-sm font-medium\">Add new label</span>\n                            </button>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n\n                    {availableLabels.length === 0 && (\n                      <button\n                        type=\"button\"\n                        onClick={() => setShowAddLabelModal(true)}\n                        className=\"w-full flex items-center justify-center gap-2 px-3 py-2 border border-dashed border-slate-300 rounded-lg text-sm text-slate-500 hover:border-slate-400 hover:text-slate-600 transition-colors\"\n                      >\n                        <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                        </svg>\n                        Create your first label\n                      </button>\n                    )}\n                  </div>\n\n                  {/* Status & Location Section - Now below Identity */}\n                  <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                    <h3 className=\"text-sm font-semibold text-slate-900 mb-4\">Status & Location</h3>\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Vehicle Type</label>\n                        <select\n                          className=\"select select-sm select-bordered w-full\"\n                          value={selectedVehicle.type || \"STOCK\"}\n                          onChange={async (e) => {\n                            const newType = e.target.value;\n                            const updates = { type: newType };\n                            // Clear saleType if not Stock\n                            if (newType !== \"STOCK\") {\n                              updates.saleType = null;\n                            }\n                            setSelectedVehicle({ ...selectedVehicle, ...updates });\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify(updates),\n                            });\n                            fetchVehicles();\n                            toast.success(\"Vehicle type updated\");\n                          }}\n                        >\n                          <option value=\"STOCK\">Stock</option>\n                          <option value=\"COURTESY\">Courtesy</option>\n                          <option value=\"FLEET_OTHER\">Fleet</option>\n                        </select>\n                      </div>\n                      {/* Sale Type - Only show for Stock vehicles */}\n                      {(selectedVehicle.type === \"STOCK\" || !selectedVehicle.type) && (\n                        <div className=\"form-control\">\n                          <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Sale Type</label>\n                          <select\n                            className=\"select select-sm select-bordered w-full\"\n                            value={selectedVehicle.saleType || \"RETAIL\"}\n                            onChange={async (e) => {\n                              const newSaleType = e.target.value;\n                              setSelectedVehicle({ ...selectedVehicle, saleType: newSaleType });\n                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                method: \"PUT\",\n                                headers: { \"Content-Type\": \"application/json\" },\n                                body: JSON.stringify({ saleType: newSaleType }),\n                              });\n                              fetchVehicles();\n                              toast.success(\"Sale type updated\");\n                            }}\n                          >\n                            <option value=\"RETAIL\">Retail</option>\n                            <option value=\"TRADE\">Trade</option>\n                          </select>\n                        </div>\n                      )}\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Status</label>\n                        <select\n                          className=\"select select-sm select-bordered w-full\"\n                          value={selectedVehicle.status || \"in_stock\"}\n                          onChange={async (e) => {\n                            const newStatus = e.target.value;\n                            setSelectedVehicle({ ...selectedVehicle, status: newStatus });\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify({ status: newStatus }),\n                            });\n                            fetchVehicles();\n                            toast.success(`Status updated to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);\n                          }}\n                        >\n                          {COLUMNS.map(col => (\n                            <option key={col.key} value={col.key}>{col.label}</option>\n                          ))}\n                        </select>\n                      </div>\n                      <div className=\"form-control\">\n                        <label className=\"text-xs font-medium text-slate-600 mb-1 block\">Location</label>\n                        <select\n                          className=\"select select-sm select-bordered w-full\"\n                          value={selectedVehicle.locationId?.id || selectedVehicle.locationId?._id || selectedVehicle.locationId || \"\"}\n                          onChange={async (e) => {\n                            const value = e.target.value;\n                            if (value === \"__add_new__\") {\n                              setShowAddLocationModal(true);\n                              return;\n                            }\n                            const locationId = value || null;\n                            setSelectedVehicle({ ...selectedVehicle, locationId: locationId });\n                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                              method: \"PUT\",\n                              headers: { \"Content-Type\": \"application/json\" },\n                              body: JSON.stringify({ locationId }),\n                            });\n                            const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());\n                            setSelectedVehicle(updated);\n                            fetchVehicles();\n                            toast.success(\"Location updated\");\n                          }}\n                        >\n                          <option value=\"\">On Site</option>\n                          {locations.map(loc => (\n                            <option key={loc.id || loc._id} value={loc.id || loc._id}>{loc.name}</option>\n                          ))}\n                          <option value=\"__add_new__\">+ Add Location</option>\n                        </select>\n                      </div>\n                    </div>\n                  </div>\n\n                    <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-4\">\n                      <h3 className=\"text-sm font-semibold text-slate-900 mb-4\">Specs</h3>\n                      <div className=\"space-y-3\">\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Make</label>\n                            <input\n                              type=\"text\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.make || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, make: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ make: selectedVehicle.make }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Model</label>\n                            <input\n                              type=\"text\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.model || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, model: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ model: selectedVehicle.model }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Year</label>\n                            <input\n                              type=\"number\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.year || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, year: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ year: selectedVehicle.year }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Mileage</label>\n                            <input\n                              type=\"number\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.mileageCurrent || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, mileageCurrent: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ mileageCurrent: selectedVehicle.mileageCurrent }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Colour</label>\n                            <input\n                              type=\"text\"\n                              className=\"input input-sm input-bordered\"\n                              value={selectedVehicle.colour || \"\"}\n                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, colour: e.target.value })}\n                              onBlur={async () => {\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ colour: selectedVehicle.colour }),\n                                });\n                                fetchVehicles();\n                              }}\n                            />\n                          </div>\n\n                          <div className=\"form-control\">\n                            <label className=\"label label-text text-xs\">Fuel Type</label>\n                            <select\n                              className=\"select select-sm select-bordered\"\n                              value={selectedVehicle.fuelType || \"\"}\n                              onChange={async (e) => {\n                                const newValue = e.target.value;\n                                setSelectedVehicle({ ...selectedVehicle, fuelType: newValue });\n                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                  method: \"PUT\",\n                                  headers: { \"Content-Type\": \"application/json\" },\n                                  body: JSON.stringify({ fuelType: newValue }),\n                                });\n                                fetchVehicles();\n                              }}\n                            >\n                              <option value=\"\">Select...</option>\n                              <option value=\"Petrol\">Petrol</option>\n                              <option value=\"Diesel\">Diesel</option>\n                              <option value=\"Hybrid\">Hybrid</option>\n                              <option value=\"Electric\">Electric</option>\n                            </select>\n                          </div>\n                        </div>\n\n                        <div className=\"form-control\">\n                          <label className=\"label label-text text-xs\">MOT Expiry Date</label>\n                          <input\n                            type=\"date\"\n                            className=\"input input-sm input-bordered\"\n                            value={selectedVehicle.motExpiryDate ? new Date(selectedVehicle.motExpiryDate).toISOString().split('T')[0] : \"\"}\n                            onChange={async (e) => {\n                              const newValue = e.target.value;\n                              setSelectedVehicle({ ...selectedVehicle, motExpiryDate: newValue });\n                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {\n                                method: \"PUT\",\n                                headers: { \"Content-Type\": \"application/json\" },\n                                body: JSON.stringify({ motExpiryDate: newValue }),\n                              });\n                              fetchVehicles();\n                            }}\n                          />\n                        </div>\n                      </div>\n                    </div>\n\n                  <div className=\"card bg-base-200\">\n                    <div className=\"card-body p-4\">\n                      <h3 className=\"font-semibold mb-2\">V5 Document</h3>\n                      {selectedVehicle.v5Url ? (\n                        <div>\n                          <a href={selectedVehicle.v5Url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"btn btn-sm btn-outline w-full mb-2\">\n                            View V5 Document\n                          </a>\n                          <label className=\"btn btn-sm btn-ghost w-full\">\n                            Replace V5\n                            <input type=\"file\" accept=\"image/*,.pdf\" className=\"hidden\" onChange={(e) => uploadV5(e.target.files[0])} />\n                          </label>\n                        </div>\n                      ) : (\n                        <label className=\"btn btn-primary btn-sm w-full\">\n                          Upload V5\n                          <input type=\"file\" accept=\"image/*,.pdf\" className=\"hidden\" onChange={(e) => uploadV5(e.target.files[0])} />\n                        </label>\n                      )}\n                    </div>\n                  </div>\n\n                  {selectedVehicle.notes && (\n                    <div className=\"card bg-base-200\">\n                      <div className=\"card-body p-4\">\n                        <h3 className=\"font-semibold mb-2\">Notes</h3>\n                        <p className=\"text-sm whitespace-pre-wrap\">{selectedVehicle.notes}</p>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              )}\n\n\n              {/* Prep Checklist Tab */}\n              {activeTab === \"checklist\" && (\n                <div className=\"card bg-base-200\">\n                  <div className=\"card-body p-4\">\n                    <h3 className=\"font-semibold mb-3\">Prep Checklist</h3>\n                    <div className=\"space-y-2\">\n                      {selectedVehicle.tasks?.map((task) => (\n                        <div key={task.id} className=\"p-2 rounded hover:bg-base-300 group\">\n                          <div className=\"flex items-center gap-2\">\n                            <select\n                              className=\"select select-bordered select-xs\"\n                              value={task.status || \"pending\"}\n                              onChange={(e) => updateTaskStatus(task.id, e.target.value)}\n                              onClick={(e) => e.stopPropagation()}\n                            >\n                              <option value=\"pending\">Pending</option>\n                              <option value=\"in_progress\">In Progress</option>\n                              <option value=\"done\">Done</option>\n                              <option value=\"not_required\">Not Required</option>\n                            </select>\n                            {editingTaskId === task.id ? (\n                              <input\n                                type=\"text\"\n                                className=\"input input-bordered input-xs flex-1\"\n                                value={editingTaskName}\n                                onChange={(e) => setEditingTaskName(e.target.value)}\n                                onBlur={() => {\n                                  if (editingTaskName.trim() && editingTaskName !== task.name) {\n                                    updateTaskName(task.id, editingTaskName);\n                                  } else {\n                                    setEditingTaskId(null);\n                                    setEditingTaskName(\"\");\n                                  }\n                                }}\n                                onKeyPress={(e) => {\n                                  if (e.key === \"Enter\") {\n                                    if (editingTaskName.trim() && editingTaskName !== task.name) {\n                                      updateTaskName(task.id, editingTaskName);\n                                    } else {\n                                      setEditingTaskId(null);\n                                      setEditingTaskName(\"\");\n                                    }\n                                  }\n                                }}\n                                onKeyDown={(e) => {\n                                  if (e.key === \"Escape\") {\n                                    setEditingTaskId(null);\n                                    setEditingTaskName(\"\");\n                                  }\n                                }}\n                                autoFocus\n                              />\n                            ) : (\n                              <span\n                                className={`flex-1 text-sm cursor-pointer ${task.status === \"done\" ? \"line-through text-base-content/50\" : \"\"}`}\n                                onClick={() => {\n                                  setEditingTaskId(task.id);\n                                  setEditingTaskName(task.name);\n                                }}\n                                title=\"Click to edit\"\n                              >\n                                {task.name}\n                                {/* Show parts status chip next to task name */}\n                                {task.partsOrders?.length > 0 && (\n                                  <span className={`ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${\n                                    task.partsOrders.every(o => o.status === \"RECEIVED\")\n                                      ? \"bg-green-100 text-green-800 border border-green-200\"\n                                      : task.partsOrders.some(o => o.status === \"RECEIVED\")\n                                        ? \"bg-blue-100 text-blue-800 border border-blue-200\"\n                                        : \"bg-amber-100 text-amber-800 border border-amber-200\"\n                                  }`}>\n                                    {task.partsOrders.every(o => o.status === \"RECEIVED\")\n                                      ? `✓ Parts Received (${task.partsOrders.length})`\n                                      : task.partsOrders.some(o => o.status === \"RECEIVED\")\n                                        ? `Parts: ${task.partsOrders.filter(o => o.status === \"RECEIVED\").length}/${task.partsOrders.length} Received`\n                                        : `Parts Ordered (${task.partsOrders.length})`\n                                    }\n                                  </span>\n                                )}\n                              </span>\n                            )}\n                            {task.completedAt && !editingTaskId && (\n                              <span className=\"text-xs text-base-content/50\">\n                                {formatDate(task.completedAt)}\n                              </span>\n                            )}\n                            {/* Order Parts button - show for pending/in_progress tasks */}\n                            {task.status !== \"done\" && task.status !== \"not_required\" && (\n                              <button\n                                className=\"btn btn-ghost btn-xs text-amber-600 opacity-0 group-hover:opacity-100 transition-opacity\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  openPartsOrderModal(task.id);\n                                }}\n                                title=\"Order Parts\"\n                              >\n                                + Parts\n                              </button>\n                            )}\n                            <button\n                              className=\"btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity\"\n                              onClick={() => deleteTask(task.id)}\n                            >\n                              ✕\n                            </button>\n                          </div>\n                          {/* Parts orders section - show if task has parts orders */}\n                          {task.partsOrders?.length > 0 && (\n                            <div className=\"mt-2 ml-6 pl-2 border-l-2 border-amber-300 space-y-1\">\n                              {task.partsOrders.map((order) => (\n                                <div key={order._id || order.id} className=\"flex items-center gap-2 text-xs\">\n                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium ${\n                                    order.status === \"RECEIVED\"\n                                      ? \"bg-green-100 text-green-700\"\n                                      : \"bg-amber-100 text-amber-700\"\n                                  }`}>\n                                    {order.status === \"RECEIVED\" ? \"✓\" : \"⏳\"}\n                                  </span>\n                                  <span className=\"text-base-content/80\">{getSupplierDisplay(order)}</span>\n                                  {order.orderRef && (\n                                    <span className=\"text-base-content/50\">Ref: {order.orderRef}</span>\n                                  )}\n                                  {order.expectedAt && order.status !== \"RECEIVED\" && (\n                                    <span className=\"text-base-content/50\">\n                                      ETA: {formatDate(order.expectedAt)}\n                                    </span>\n                                  )}\n                                  {order.status !== \"RECEIVED\" && (\n                                    <button\n                                      className=\"btn btn-ghost btn-xs text-green-600\"\n                                      onClick={(e) => {\n                                        e.stopPropagation();\n                                        markPartsReceived(task.id, order._id || order.id);\n                                      }}\n                                      title=\"Mark as Received\"\n                                    >\n                                      ✓ Received\n                                    </button>\n                                  )}\n                                  <button\n                                    className=\"btn btn-ghost btn-xs\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      openPartsOrderModal(task.id, order);\n                                    }}\n                                    title=\"Edit\"\n                                  >\n                                    ✎\n                                  </button>\n                                  <button\n                                    className=\"btn btn-ghost btn-xs text-error\"\n                                    onClick={(e) => {\n                                      e.stopPropagation();\n                                      removePartsOrder(task.id, order._id || order.id);\n                                    }}\n                                    title=\"Remove\"\n                                  >\n                                    ✕\n                                  </button>\n                                </div>\n                              ))}\n                            </div>\n                          )}\n                        </div>\n                      ))}\n                    </div>\n                    <div className=\"flex gap-2 mt-3\">\n                      <input\n                        type=\"text\"\n                        className=\"input input-bordered input-sm flex-1\"\n                        placeholder=\"Add new task...\"\n                        value={newTaskName}\n                        onChange={(e) => setNewTaskName(e.target.value)}\n                        onKeyPress={(e) => e.key === \"Enter\" && addTask()}\n                      />\n                      <button className=\"btn btn-primary btn-sm\" onClick={addTask}>\n                        Add\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              )}\n\n              {/* Issues Tab */}\n              {activeTab === \"issues\" && (\n                <div className=\"space-y-4\">\n                  <button\n                    className=\"flex items-center justify-center gap-2 w-full px-4 py-2.5 bg-[#0066CC] hover:bg-[#0055AA] text-white text-sm font-medium rounded-xl shadow-sm shadow-[#0066CC]/25 hover:shadow-md transition-all\"\n                    onClick={() => setShowAddIssueModal(true)}\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                    </svg>\n                    Add Issue\n                  </button>\n\n                  {selectedVehicle.issues && selectedVehicle.issues.length > 0 ? (\n                    <div className=\"space-y-3\">\n                      {selectedVehicle.issues.map((issue) => (\n                        <div key={issue.id} className=\"bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden hover:shadow-md transition-shadow\">\n                          {/* Issue Header with Status Bar */}\n                          <div className={`px-4 py-3 border-b border-slate-100 ${\n                            issue.status === \"Complete\" ? \"bg-emerald-50/50\" :\n                            issue.status === \"In Progress\" ? \"bg-amber-50/50\" :\n                            issue.status === \"Ordered\" ? \"bg-blue-50/50\" :\n                            \"bg-red-50/50\"\n                          }`}>\n                            <div className=\"flex items-center justify-between gap-3\">\n                              <div className=\"flex items-center gap-2 flex-wrap min-w-0\">\n                                <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-[#0066CC]/10 text-[#0066CC]\">\n                                  {issue.category}\n                                </span>\n                                {issue.subcategory && (\n                                  <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600\">\n                                    {issue.subcategory}\n                                  </span>\n                                )}\n                              </div>\n                              <select\n                                className={`text-xs font-semibold px-2.5 py-1.5 rounded-lg border-0 cursor-pointer transition-colors ${\n                                  issue.status === \"Complete\" ? \"bg-emerald-100 text-emerald-700\" :\n                                  issue.status === \"In Progress\" ? \"bg-amber-100 text-amber-700\" :\n                                  issue.status === \"Ordered\" ? \"bg-blue-100 text-blue-700\" :\n                                  \"bg-red-100 text-red-700\"\n                                }`}\n                                value={issue.status || \"Outstanding\"}\n                                onChange={(e) => updateIssue(issue.id, { status: e.target.value })}\n                              >\n                                <option value=\"Outstanding\">Outstanding</option>\n                                <option value=\"Ordered\">Ordered</option>\n                                <option value=\"In Progress\">In Progress</option>\n                                <option value=\"Complete\">Complete</option>\n                              </select>\n                            </div>\n                          </div>\n\n                          {/* Issue Body */}\n                          <div className=\"p-4 space-y-3\">\n                            {/* Description */}\n                            <p className=\"text-sm font-medium text-slate-800\">{issue.description}</p>\n\n                            {/* Details Grid */}\n                            <div className=\"space-y-2\">\n                              {issue.actionNeeded && (\n                                <div className=\"flex items-start gap-2\">\n                                  <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pt-0.5 w-14\">Action</span>\n                                  <p className=\"text-sm text-slate-600\">{issue.actionNeeded}</p>\n                                </div>\n                              )}\n                              {issue.notes && (\n                                <div className=\"flex items-start gap-2\">\n                                  <span className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pt-0.5 w-14\">Notes</span>\n                                  <p className=\"text-sm text-slate-600\">{issue.notes}</p>\n                                </div>\n                              )}\n                            </div>\n\n                            {/* Parts Details */}\n                            {issue.partsRequired && (\n                              <div className=\"flex items-start gap-2 p-3 bg-[#0066CC]/5 rounded-xl border border-[#0066CC]/10\">\n                                <div className=\"w-7 h-7 rounded-lg bg-[#0066CC]/10 flex items-center justify-center shrink-0\">\n                                  <svg className=\"w-4 h-4 text-[#0066CC]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z\" />\n                                  </svg>\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <span className=\"inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-[#0066CC]/10 text-[#0066CC]\">\n                                    Parts Required\n                                  </span>\n                                  {issue.partsDetails && (\n                                    <p className=\"text-sm text-slate-600 mt-1\">{issue.partsDetails}</p>\n                                  )}\n                                </div>\n                              </div>\n                            )}\n\n                            {/* Photos */}\n                            {issue.photos && issue.photos.length > 0 && (\n                              <div className=\"pt-2\">\n                                <p className=\"text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2\">\n                                  Photos ({issue.photos.length})\n                                </p>\n                                <div className=\"flex flex-wrap gap-2\">\n                                  {issue.photos.map((photo, idx) => (\n                                    <a key={idx} href={photo} target=\"_blank\" rel=\"noopener noreferrer\" className=\"group\">\n                                      <img\n                                        src={photo}\n                                        alt={`Issue photo ${idx + 1}`}\n                                        className=\"w-16 h-16 object-cover rounded-xl border-2 border-slate-200 group-hover:border-[#0066CC] group-hover:scale-105 transition-all\"\n                                      />\n                                    </a>\n                                  ))}\n                                </div>\n                              </div>\n                            )}\n                          </div>\n\n                          {/* Updates Accordion */}\n                          <div className=\"border-t border-slate-100\">\n                            <button\n                              className=\"w-full flex items-center justify-between px-4 py-2.5 text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors\"\n                              onClick={() => setExpandedIssues(prev => ({\n                                ...prev,\n                                [issue.id]: !prev[issue.id]\n                              }))}\n                            >\n                              <span className=\"flex items-center gap-2\">\n                                <svg className=\"w-4 h-4 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\n                                </svg>\n                                Updates {issue.updates?.length > 0 && `(${issue.updates.length})`}\n                              </span>\n                              <svg\n                                className={`w-4 h-4 text-slate-400 transition-transform duration-200 ${expandedIssues[issue.id] ? \"rotate-180\" : \"\"}`}\n                                fill=\"none\"\n                                stroke=\"currentColor\"\n                                viewBox=\"0 0 24 24\"\n                              >\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                              </svg>\n                            </button>\n\n                            {expandedIssues[issue.id] && (\n                              <div className=\"px-4 pb-4 space-y-3 bg-slate-50/50\">\n                                {/* Creation timestamp */}\n                                <div className=\"flex gap-3 text-xs\">\n                                  <div className=\"w-1 bg-slate-200 rounded-full\"></div>\n                                  <p className=\"text-slate-500\">\n                                    Created {formatDate(issue.createdAt)}\n                                  </p>\n                                </div>\n\n                                {/* Updates timeline */}\n                                {issue.updates && issue.updates.length > 0 ? (\n                                  issue.updates.map((update, idx) => (\n                                    <div key={idx} className=\"flex gap-3\">\n                                      <div className=\"w-1 bg-[#0066CC]/30 rounded-full\"></div>\n                                      <div className=\"flex-1 min-w-0\">\n                                        <div className=\"flex items-center gap-2 mb-1\">\n                                          <p className=\"text-sm font-semibold text-slate-700\">{update.userName || \"User\"}</p>\n                                          <span className=\"text-xs text-slate-400\">{formatDate(update.createdAt)}</span>\n                                        </div>\n                                        <p className=\"text-sm text-slate-600\">{update.content}</p>\n                                      </div>\n                                    </div>\n                                  ))\n                                ) : (\n                                  <p className=\"text-xs text-slate-400 text-center py-2\">No updates yet</p>\n                                )}\n\n                                {/* Add update input */}\n                                <div className=\"flex gap-2 pt-2\">\n                                  <input\n                                    type=\"text\"\n                                    className=\"flex-1 px-3 py-2 text-sm bg-white border border-slate-200 rounded-xl focus:border-[#0066CC] focus:ring-1 focus:ring-[#0066CC]/20 outline-none transition-all\"\n                                    placeholder=\"Add an update...\"\n                                    value={issueUpdateContent[issue.id] || \"\"}\n                                    onChange={(e) => setIssueUpdateContent(prev => ({\n                                      ...prev,\n                                      [issue.id]: e.target.value\n                                    }))}\n                                    onKeyPress={(e) => {\n                                      if (e.key === \"Enter\") {\n                                        addIssueUpdate(issue.id, issueUpdateContent[issue.id]);\n                                      }\n                                    }}\n                                  />\n                                  <button\n                                    className=\"px-4 py-2 bg-[#0066CC] hover:bg-[#0055AA] text-white text-sm font-medium rounded-xl transition-colors\"\n                                    onClick={() => addIssueUpdate(issue.id, issueUpdateContent[issue.id])}\n                                  >\n                                    Add\n                                  </button>\n                                </div>\n                              </div>\n                            )}\n                          </div>\n\n                          {/* Actions Footer */}\n                          <div className=\"flex items-center justify-end gap-2 px-4 py-3 bg-slate-50/50 border-t border-slate-100\">\n                            <button\n                              className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-slate-600 hover:text-[#0066CC] hover:bg-[#0066CC]/5 rounded-lg transition-colors\"\n                              onClick={() => openEditIssue(issue)}\n                            >\n                              <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\n                              </svg>\n                              Edit\n                            </button>\n                            <button\n                              className=\"flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors\"\n                              onClick={() => {\n                                if (confirm(\"Delete this issue?\")) deleteIssue(issue.id);\n                              }}\n                            >\n                              <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                              Delete\n                            </button>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center\">\n                      <div className=\"w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3\">\n                        <svg className=\"w-6 h-6 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                        </svg>\n                      </div>\n                      <p className=\"text-sm font-medium text-slate-600\">No issues recorded</p>\n                      <p className=\"text-xs text-slate-400 mt-1\">Add an issue to track problems with this vehicle</p>\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Documents Tab */}\n              {activeTab === \"documents\" && (\n                <div className=\"space-y-4\">\n                  <button\n                    className=\"btn btn-primary btn-sm w-full\"\n                    onClick={() => setShowAddDocumentModal(true)}\n                  >\n                    + Add Document/Image\n                  </button>\n\n                  {selectedVehicle.documents && selectedVehicle.documents.length > 0 ? (\n                    <div className=\"space-y-3\">\n                      {selectedVehicle.documents.map((doc) => (\n                        <div key={doc.id} className=\"card bg-base-200\">\n                          <div className=\"card-body p-4\">\n                            <div className=\"flex justify-between items-start\">\n                              <div className=\"flex-1\">\n                                <p className=\"text-sm font-medium\">{doc.name}</p>\n                                <span className=\"badge badge-sm mt-1\">\n                                  {doc.type === \"v5\" && \"V5\"}\n                                  {doc.type === \"service_history\" && \"Service History\"}\n                                  {doc.type === \"fault_codes\" && \"Fault Codes\"}\n                                  {doc.type === \"other\" && \"Other\"}\n                                </span>\n                              </div>\n                              <div className=\"flex gap-1\">\n                                <a\n                                  href={doc.url}\n                                  target=\"_blank\"\n                                  rel=\"noopener noreferrer\"\n                                  className=\"btn btn-ghost btn-xs\"\n                                  onClick={(e) => e.stopPropagation()}\n                                >\n                                  View\n                                </a>\n                                <button\n                                  className=\"btn btn-ghost btn-xs text-error\"\n                                  onClick={() => {\n                                    if (confirm(\"Delete this document?\")) deleteDocument(doc.id);\n                                  }}\n                                >\n                                  Delete\n                                </button>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"text-center py-8 text-base-content/60\">\n                      No documents uploaded\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Activity Tab */}\n              {activeTab === \"activity\" && (\n                <div className=\"space-y-4\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Activity Log</h3>\n\n                  {activityLoading && activityData.activities.length === 0 ? (\n                    <div className=\"flex justify-center py-8\">\n                      <div className=\"w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin\"></div>\n                    </div>\n                  ) : activityData.activities.length === 0 ? (\n                    <div className=\"text-center py-8 text-base-content/60\">\n                      No activity recorded yet\n                    </div>\n                  ) : (\n                    <div className=\"space-y-3\">\n                      {activityData.activities.map((activity) => (\n                        <div\n                          key={activity._id || activity.id}\n                          className=\"flex items-start gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100\"\n                        >\n                          <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${\n                            activity.type === \"VEHICLE_CREATED\" ? \"bg-green-100\" :\n                            activity.type === \"STATUS_CHANGED\" ? \"bg-blue-100\" :\n                            activity.type === \"TYPE_CHANGED\" ? \"bg-[#0066CC]/10\" :\n                            activity.type === \"LOCATION_CHANGED\" ? \"bg-[#0066CC]/10\" :\n                            activity.type === \"TASK_COMPLETED\" ? \"bg-emerald-100\" :\n                            activity.type === \"TASK_STATUS_UPDATED\" ? \"bg-amber-100\" :\n                            activity.type === \"TASK_PROGRESS_UPDATED\" ? \"bg-orange-100\" :\n                            activity.type === \"TASK_PARTS_STATUS_CHANGED\" || activity.type === \"TASK_PARTS_ORDER_ADDED\" ? \"bg-amber-100\" :\n                            activity.type === \"TASK_PARTS_ORDER_UPDATED\" ? \"bg-blue-100\" :\n                            activity.type === \"TASK_PARTS_ORDER_REMOVED\" ? \"bg-red-100\" :\n                            activity.type === \"TASK_ADDED\" || activity.type === \"TASK_DELETED\" ? \"bg-slate-100\" :\n                            activity.type === \"ISSUE_ADDED\" ? \"bg-red-100\" :\n                            activity.type === \"ISSUE_RESOLVED\" ? \"bg-green-100\" :\n                            activity.type === \"ISSUE_UPDATED\" || activity.type === \"ISSUE_COMMENT_ADDED\" ? \"bg-yellow-100\" :\n                            \"bg-slate-100\"\n                          }`}>\n                            {/* Vehicle lifecycle */}\n                            {activity.type === \"VEHICLE_CREATED\" && (\n                              <svg className=\"w-4 h-4 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"STATUS_CHANGED\" && (\n                              <svg className=\"w-4 h-4 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TYPE_CHANGED\" && (\n                              <svg className=\"w-4 h-4 text-[#0066CC]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                              </svg>\n                            )}\n                            {activity.type === \"LOCATION_CHANGED\" && (\n                              <svg className=\"w-4 h-4 text-[#0066CC]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\" />\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"DETAILS_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-[#14B8A6]\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\" />\n                              </svg>\n                            )}\n                            {/* Task events */}\n                            {activity.type === \"TASK_COMPLETED\" && (\n                              <svg className=\"w-4 h-4 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_STATUS_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_PROGRESS_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-orange-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                              </svg>\n                            )}\n                            {(activity.type === \"TASK_ADDED\" || activity.type === \"TASK_UPDATED\") && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_DELETED\" && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                            )}\n                            {/* Parts ordering events */}\n                            {(activity.type === \"TASK_PARTS_STATUS_CHANGED\" || activity.type === \"TASK_PARTS_ORDER_ADDED\") && (\n                              <svg className=\"w-4 h-4 text-amber-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_PARTS_ORDER_UPDATED\" && (\n                              <svg className=\"w-4 h-4 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                              </svg>\n                            )}\n                            {activity.type === \"TASK_PARTS_ORDER_REMOVED\" && (\n                              <svg className=\"w-4 h-4 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                            )}\n                            {/* Issue events */}\n                            {activity.type === \"ISSUE_ADDED\" && (\n                              <svg className=\"w-4 h-4 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"ISSUE_RESOLVED\" && (\n                              <svg className=\"w-4 h-4 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                              </svg>\n                            )}\n                            {(activity.type === \"ISSUE_UPDATED\" || activity.type === \"ISSUE_COMMENT_ADDED\") && (\n                              <svg className=\"w-4 h-4 text-yellow-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z\" />\n                              </svg>\n                            )}\n                            {activity.type === \"ISSUE_DELETED\" && (\n                              <svg className=\"w-4 h-4 text-red-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\" />\n                              </svg>\n                            )}\n                            {/* Document events */}\n                            {(activity.type === \"DOC_UPLOADED\" || activity.type === \"DOC_DELETED\") && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                              </svg>\n                            )}\n                            {/* Fallback for any unhandled types */}\n                            {![\"VEHICLE_CREATED\", \"STATUS_CHANGED\", \"TYPE_CHANGED\", \"LOCATION_CHANGED\", \"DETAILS_UPDATED\",\n                               \"TASK_COMPLETED\", \"TASK_STATUS_UPDATED\", \"TASK_PROGRESS_UPDATED\", \"TASK_ADDED\", \"TASK_UPDATED\", \"TASK_DELETED\",\n                               \"TASK_PARTS_STATUS_CHANGED\", \"TASK_PARTS_ORDER_ADDED\", \"TASK_PARTS_ORDER_UPDATED\", \"TASK_PARTS_ORDER_REMOVED\",\n                               \"ISSUE_ADDED\", \"ISSUE_RESOLVED\", \"ISSUE_UPDATED\", \"ISSUE_COMMENT_ADDED\", \"ISSUE_DELETED\",\n                               \"DOC_UPLOADED\", \"DOC_DELETED\"].includes(activity.type) && (\n                              <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            )}\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-sm text-slate-900\">{activity.message}</p>\n                            <p className=\"text-xs text-slate-500 mt-0.5\">\n                              by {activity.actorName || \"Unknown\"} &middot; {formatRelativeTime(activity.createdAt)}\n                            </p>\n                          </div>\n                        </div>\n                      ))}\n\n                      {activityData.hasMore && (\n                        <button\n                          onClick={() => fetchActivity(selectedVehicle.id, true)}\n                          disabled={activityLoading}\n                          className=\"w-full btn btn-ghost btn-sm text-slate-600\"\n                        >\n                          {activityLoading ? (\n                            <span className=\"flex items-center gap-2\">\n                              <div className=\"w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin\"></div>\n                              Loading...\n                            </span>\n                          ) : (\n                            \"Load more\"\n                          )}\n                        </button>\n                      )}\n                    </div>\n                  )}\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Drag Preview - floating card that follows cursor */}\n      {draggedCard && (\n        <div\n          className=\"fixed pointer-events-none z-50\"\n          style={{\n            left: dragPosition.x - 120,\n            top: dragPosition.y - 30,\n            transform: \"rotate(3deg)\",\n          }}\n        >\n          <div className=\"bg-white rounded-xl shadow-2xl border-2 border-blue-400 w-60 p-3 opacity-90\">\n            <div className=\"flex items-center gap-2\">\n              <p className=\"font-bold text-slate-900 text-sm truncate\">\n                {draggedCard.year} {draggedCard.make} {draggedCard.model}\n              </p>\n            </div>\n            <span className=\"font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md inline-block mt-1\">\n              {draggedCard.regCurrent}\n            </span>\n          </div>\n        </div>\n      )}\n\n      {showAddModal && (\n        <AddVehicleModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchVehicles(); }} />\n      )}\n\n      {showAddIssueModal && (\n        <AddIssueModal\n          issueForm={issueForm}\n          setIssueForm={setIssueForm}\n          isEditing={!!editingIssue}\n          onClose={() => {\n            setShowAddIssueModal(false);\n            setEditingIssue(null);\n            setIssueForm({\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              priority: \"medium\",\n              location: \"\",\n              status: \"outstanding\",\n              notes: \"\",\n              photos: [],\n              partsRequired: false,\n              partsDetails: \"\",\n            });\n          }}\n          onSubmit={editingIssue ? saveEditedIssue : addIssue}\n        />\n      )}\n\n      {showAddDocumentModal && (\n        <AddDocumentModal\n          documentForm={documentForm}\n          setDocumentForm={setDocumentForm}\n          onClose={() => {\n            setShowAddDocumentModal(false);\n            setDocumentForm({ name: \"\", type: \"other\", file: null });\n          }}\n          onSubmit={() => {\n            if (!documentForm.file) {\n              return toast.error(\"File is required\");\n            }\n            if (documentForm.type === \"other\" && !documentForm.name) {\n              return toast.error(\"Document name is required for 'Other' type\");\n            }\n            // Generate default name based on type if not \"other\"\n            const docName = documentForm.type === \"other\"\n              ? documentForm.name\n              : documentForm.type.replace(/_/g, \" \").replace(/\\b\\w/g, l => l.toUpperCase());\n            uploadDocument(documentForm.file, docName, documentForm.type);\n          }}\n        />\n      )}\n\n      {showAddLocationModal && (\n        <AddLocationModal\n          onClose={() => setShowAddLocationModal(false)}\n          onSuccess={(newLocation) => {\n            setLocations([...locations, newLocation]);\n            setSelectedVehicle({ ...selectedVehicle, locationId: newLocation.id || newLocation._id });\n            fetch(`/api/vehicles/${selectedVehicle.id}`, {\n              method: \"PUT\",\n              headers: { \"Content-Type\": \"application/json\" },\n              body: JSON.stringify({ locationId: newLocation.id || newLocation._id }),\n            }).then(() => {\n              fetchVehicles();\n              setShowAddLocationModal(false);\n            });\n          }}\n        />\n      )}\n\n      {/* Parts Order Modal */}\n      {showPartsOrderModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">\n                {editingPartsOrderId ? \"Edit Parts Order\" : \"Add Parts Order\"}\n              </h3>\n              <button\n                onClick={closePartsOrderModal}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Supplier</span>\n                </label>\n                <select\n                  className=\"select select-bordered w-full\"\n                  value={partsOrderForm.supplierType}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, supplierType: e.target.value })}\n                >\n                  <option value=\"EURO_CAR_PARTS\">Euro Car Parts</option>\n                  <option value=\"TPS\">TPS</option>\n                  <option value=\"MAIN_DEALER\">Main Dealer</option>\n                  <option value=\"LOCAL_FACTOR\">Local Factor</option>\n                  <option value=\"ONLINE\">Online</option>\n                  <option value=\"OTHER\">Other</option>\n                </select>\n              </div>\n              {partsOrderForm.supplierType === \"OTHER\" && (\n                <div className=\"form-control\">\n                  <label className=\"label\">\n                    <span className=\"label-text font-medium\">Supplier Name</span>\n                  </label>\n                  <input\n                    type=\"text\"\n                    placeholder=\"Enter supplier name\"\n                    className=\"input input-bordered w-full\"\n                    value={partsOrderForm.supplierName}\n                    onChange={(e) => setPartsOrderForm({ ...partsOrderForm, supplierName: e.target.value })}\n                  />\n                </div>\n              )}\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Order Reference (Optional)</span>\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"e.g., ORD-123456\"\n                  className=\"input input-bordered w-full\"\n                  value={partsOrderForm.orderRef}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, orderRef: e.target.value })}\n                />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Expected Delivery (Optional)</span>\n                </label>\n                <input\n                  type=\"date\"\n                  className=\"input input-bordered w-full\"\n                  value={partsOrderForm.expectedAt}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, expectedAt: e.target.value })}\n                />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Notes (Optional)</span>\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"e.g., Oil filter + air filter\"\n                  className=\"input input-bordered w-full\"\n                  value={partsOrderForm.notes}\n                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, notes: e.target.value })}\n                />\n              </div>\n            </div>\n            <div className=\"flex justify-end gap-2 p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={closePartsOrderModal}\n              >\n                Cancel\n              </button>\n              <button\n                className=\"btn btn-primary\"\n                onClick={editingPartsOrderId ? updatePartsOrder : addPartsOrder}\n              >\n                {editingPartsOrderId ? \"Update\" : \"Add Order\"}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Add Label Modal */}\n      {showAddLabelModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Create New Label</h3>\n              <button\n                onClick={() => {\n                  setShowAddLabelModal(false);\n                  setNewLabelForm({ name: \"\", colour: \"#6366f1\" });\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Label Name</span>\n                </label>\n                <input\n                  type=\"text\"\n                  placeholder=\"e.g., Hot Lead, Awaiting Finance\"\n                  className=\"input input-bordered w-full\"\n                  value={newLabelForm.name}\n                  onChange={(e) => setNewLabelForm({ ...newLabelForm, name: e.target.value })}\n                  autoFocus\n                />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"label\">\n                  <span className=\"label-text font-medium\">Colour</span>\n                </label>\n                <div className=\"flex items-center gap-3\">\n                  <input\n                    type=\"color\"\n                    className=\"w-12 h-10 rounded cursor-pointer border border-slate-300\"\n                    value={newLabelForm.colour}\n                    onChange={(e) => setNewLabelForm({ ...newLabelForm, colour: e.target.value })}\n                  />\n                  <div className=\"flex gap-2\">\n                    {[\"#ef4444\", \"#f59e0b\", \"#22c55e\", \"#3b82f6\", \"#8b5cf6\", \"#ec4899\", \"#6b7280\"].map(color => (\n                      <button\n                        key={color}\n                        type=\"button\"\n                        onClick={() => setNewLabelForm({ ...newLabelForm, colour: color })}\n                        className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${newLabelForm.colour === color ? 'border-slate-900 scale-110' : 'border-transparent'}`}\n                        style={{ backgroundColor: color }}\n                      />\n                    ))}\n                  </div>\n                </div>\n              </div>\n              {/* Preview */}\n              {newLabelForm.name && (\n                <div className=\"pt-2\">\n                  <label className=\"label\">\n                    <span className=\"label-text font-medium\">Preview</span>\n                  </label>\n                  <span\n                    className=\"inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold\"\n                    style={{\n                      backgroundColor: `${newLabelForm.colour}20`,\n                      color: newLabelForm.colour,\n                    }}\n                  >\n                    <span className=\"w-2 h-2 rounded-full\" style={{ backgroundColor: newLabelForm.colour }}></span>\n                    {newLabelForm.name}\n                  </span>\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end gap-2 p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowAddLabelModal(false);\n                  setNewLabelForm({ name: \"\", colour: \"#6366f1\" });\n                }}\n              >\n                Cancel\n              </button>\n              <button\n                className=\"btn btn-primary\"\n                onClick={createLabel}\n                disabled={!newLabelForm.name.trim()}\n              >\n                Create Label\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Job Sheet Share Modal */}\n      {showJobSheetModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Share Job Sheet</h3>\n              <button\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4\">\n              {isGeneratingJobSheet ? (\n                <div className=\"flex flex-col items-center py-8\">\n                  <div className=\"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3\"></div>\n                  <p className=\"text-slate-600\">Generating share link...</p>\n                </div>\n              ) : jobSheetLink ? (\n                <div className=\"space-y-4\">\n                  <div className=\"bg-slate-50 rounded-lg p-3\">\n                    <p className=\"text-xs text-slate-500 mb-1\">Shareable Link</p>\n                    <p className=\"text-sm font-mono text-slate-900 break-all\">{jobSheetLink}</p>\n                  </div>\n                  <p className=\"text-xs text-slate-500\">\n                    This link expires in 60 days. Anyone with this link can view the job sheet.\n                  </p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      onClick={copyJobSheetLink}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      Copy Link\n                    </button>\n                    <button\n                      onClick={shareViaWhatsApp}\n                      className=\"btn btn-success btn-sm gap-2 text-white\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\n                      </svg>\n                      WhatsApp\n                    </button>\n                    <button\n                      onClick={() => {\n                        const subject = `Job Sheet - ${selectedVehicle?.regCurrent || 'Vehicle'}`;\n                        const body = `Here is the job sheet for ${selectedVehicle?.regCurrent || 'the vehicle'}:\\n\\n${jobSheetLink}`;\n                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);\n                      }}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n                      </svg>\n                      Email\n                    </button>\n                    <button\n                      onClick={() => window.open(jobSheetLink, '_blank')}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                      </svg>\n                      Print / PDF\n                    </button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  No link generated yet\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Prep Summary Share Modal */}\n      {showPrepSummaryModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Prep Summary PDF</h3>\n              <button\n                onClick={() => {\n                  setShowPrepSummaryModal(false);\n                  setPrepSummaryLink(null);\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4\">\n              {isGeneratingPrepSummary ? (\n                <div className=\"flex flex-col items-center py-8\">\n                  <div className=\"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3\"></div>\n                  <p className=\"text-slate-600\">Generating prep summary...</p>\n                </div>\n              ) : prepSummaryLink ? (\n                <div className=\"space-y-4\">\n                  <div className=\"bg-slate-50 rounded-lg p-3\">\n                    <p className=\"text-xs text-slate-500 mb-1\">Shareable Link</p>\n                    <p className=\"text-sm font-mono text-slate-900 break-all\">{prepSummaryLink.url}</p>\n                  </div>\n                  <p className=\"text-xs text-slate-500\">\n                    This link expires in 60 days. Click Print/PDF to save a PDF of the prep summary.\n                  </p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      onClick={copyPrepSummaryLink}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      Copy Link\n                    </button>\n                    <button\n                      onClick={sharePrepSummaryViaWhatsApp}\n                      className=\"btn btn-success btn-sm gap-2 text-white\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\n                      </svg>\n                      WhatsApp\n                    </button>\n                    <button\n                      onClick={() => {\n                        const subject = `Prep Summary - ${selectedVehicle?.regCurrent || 'Vehicle'}`;\n                        const body = `Here is the prep summary for ${selectedVehicle?.regCurrent || 'the vehicle'}:\\n\\n${prepSummaryLink.url}`;\n                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);\n                      }}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n                      </svg>\n                      Email\n                    </button>\n                    <button\n                      onClick={() => window.open(prepSummaryLink.url, '_blank')}\n                      className=\"btn btn-primary btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                      </svg>\n                      Print / PDF\n                    </button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  No link generated yet\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowPrepSummaryModal(false);\n                  setPrepSummaryLink(null);\n                }}\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Manual Share Fallback Modal */}\n      {showManualShareModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\n          <div className=\"bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Share Link</h3>\n              <button\n                onClick={() => {\n                  setShowManualShareModal(false);\n                  setManualShareUrl(\"\");\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4 space-y-4\">\n              <p className=\"text-sm text-slate-600\">\n                Copy the link below to share:\n              </p>\n              <div className=\"bg-slate-50 rounded-lg p-3 relative\">\n                <input\n                  type=\"text\"\n                  value={manualShareUrl}\n                  readOnly\n                  className=\"w-full bg-transparent text-sm font-mono text-slate-900 border-none focus:outline-none pr-10\"\n                  onClick={(e) => e.target.select()}\n                />\n                <button\n                  onClick={async () => {\n                    try {\n                      await navigator.clipboard.writeText(manualShareUrl);\n                      toast.success(\"Link copied!\");\n                    } catch {\n                      // If clipboard still fails, user can manually copy\n                      toast.info(\"Select and copy the link manually\");\n                    }\n                  }}\n                  className=\"absolute right-2 top-1/2 -translate-y-1/2 p-2 hover:bg-slate-200 rounded transition-colors\"\n                  title=\"Copy to clipboard\"\n                >\n                  <svg className=\"w-4 h-4 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                  </svg>\n                </button>\n              </div>\n              <p className=\"text-xs text-slate-500\">\n                Click the link to select it, then use Ctrl+C (or Cmd+C on Mac) to copy.\n              </p>\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-primary\"\n                onClick={() => {\n                  setShowManualShareModal(false);\n                  setManualShareUrl(\"\");\n                }}\n              >\n                Done\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </DashboardLayout>\n  );\n}\n\nfunction AddVehicleModal({ onClose, onSuccess }) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [locations, setLocations] = useState([]);\n  const [prepTemplates, setPrepTemplates] = useState([]);\n  const [formData, setFormData] = useState({\n    regCurrent: \"\", make: \"\", model: \"\", year: \"\", mileageCurrent: \"\",\n    fuelType: \"\", transmission: \"\", colour: \"\", notes: \"\", locationId: \"\",\n    motExpiryDate: \"\", // MOT expiry date (autofilled from lookup or manual entry)\n    engineCapacity: \"\", // Engine capacity in cc (autofilled from lookup or manual entry)\n    type: \"STOCK\", // STOCK, COURTESY, FLEET_OTHER\n    saleType: \"RETAIL\", // RETAIL, TRADE - only used when type is STOCK\n    dvlaDetails: null, // DVLA VES extended details\n    lastDvlaFetchAt: null, // When DVLA lookup was performed\n  });\n\n  // Appraisal lookup state\n  const [matchedAppraisal, setMatchedAppraisal] = useState(null);\n  const [isCheckingAppraisal, setIsCheckingAppraisal] = useState(false);\n  const [appraisalDismissed, setAppraisalDismissed] = useState(false);\n\n  // VRM appraisal suggestions\n  const [appraisalSuggestions, setAppraisalSuggestions] = useState([]);\n  const [showAppraisalDropdown, setShowAppraisalDropdown] = useState(false);\n  const [isSearchingAppraisals, setIsSearchingAppraisals] = useState(false);\n\n  // Document uploads\n  const [v5File, setV5File] = useState(null);\n  const [serviceHistoryFile, setServiceHistoryFile] = useState(null);\n  const [faultCodesFile, setFaultCodesFile] = useState(null);\n  const [otherDocuments, setOtherDocuments] = useState([]);\n\n  // Initial issues (array of issues to create with the vehicle)\n  const [initialIssues, setInitialIssues] = useState([]);\n  const [showAddIssueInVehicleModal, setShowAddIssueInVehicleModal] = useState(false);\n  const [newIssueForm, setNewIssueForm] = useState({\n    category: \"\",\n    subcategory: \"\",\n    description: \"\",\n    actionNeeded: \"\",\n    status: \"Outstanding\",\n    notes: \"\",\n    photos: [],\n  });\n\n  // Prep checklist template\n  const [selectedTemplate, setSelectedTemplate] = useState(\"default\");\n\n  useEffect(() => {\n    fetchLocations();\n    fetchPrepTemplates();\n  }, []);\n\n  const fetchLocations = async () => {\n    try {\n      const res = await fetch(\"/api/locations\");\n      const data = await res.json();\n      setLocations(data);\n    } catch (error) {\n      console.error(\"Failed to fetch locations\");\n    }\n  };\n\n  const fetchPrepTemplates = async () => {\n    try {\n      const res = await fetch(\"/api/prep-tasks\");\n      const data = await res.json();\n      setPrepTemplates(data);\n      // Auto-select first template if available\n      if (data.length > 0) setSelectedTemplate(\"default\");\n    } catch (error) {\n      console.error(\"Failed to fetch prep templates\");\n    }\n  };\n\n  // Search unconverted appraisals as user types VRM\n  const searchAppraisals = async (vrm) => {\n    if (!vrm || vrm.length < 2) {\n      setAppraisalSuggestions([]);\n      setShowAppraisalDropdown(false);\n      return;\n    }\n    setIsSearchingAppraisals(true);\n    try {\n      const res = await fetch(`/api/appraisals/search-unconverted?q=${encodeURIComponent(vrm)}`);\n      if (res.ok) {\n        const results = await res.json();\n        setAppraisalSuggestions(results);\n        setShowAppraisalDropdown(results.length > 0);\n      } else {\n        setAppraisalSuggestions([]);\n        setShowAppraisalDropdown(false);\n      }\n    } catch (error) {\n      setAppraisalSuggestions([]);\n      setShowAppraisalDropdown(false);\n    } finally {\n      setIsSearchingAppraisals(false);\n    }\n  };\n\n  // Handle selecting an appraisal from suggestions\n  const handleSelectAppraisalSuggestion = (appraisal) => {\n    setFormData(prev => ({\n      ...prev,\n      regCurrent: appraisal.vehicleReg || prev.regCurrent,\n      make: appraisal.vehicleMake || prev.make,\n      model: appraisal.vehicleModel || prev.model,\n      year: appraisal.vehicleYear || prev.year,\n      mileageCurrent: appraisal.mileage || prev.mileageCurrent,\n    }));\n    setMatchedAppraisal(appraisal);\n    setAppraisalDismissed(false);\n    setShowAppraisalDropdown(false);\n    setAppraisalSuggestions([]);\n    toast.success(`Loaded appraisal for ${appraisal.vehicleReg}`);\n  };\n\n  // Check for existing appraisal when VRM changes\n  const checkForAppraisal = async (vrm) => {\n    if (!vrm || vrm.length < 2) {\n      setMatchedAppraisal(null);\n      return;\n    }\n    setIsCheckingAppraisal(true);\n    try {\n      const res = await fetch(`/api/appraisals/by-vrm?vrm=${encodeURIComponent(vrm)}`);\n      if (res.ok) {\n        const appraisal = await res.json();\n        setMatchedAppraisal(appraisal);\n        setAppraisalDismissed(false);\n      } else {\n        setMatchedAppraisal(null);\n      }\n    } catch (error) {\n      setMatchedAppraisal(null);\n    } finally {\n      setIsCheckingAppraisal(false);\n    }\n  };\n\n  // Import data from matched appraisal\n  const importFromAppraisal = () => {\n    if (!matchedAppraisal) return;\n    setFormData(prev => ({\n      ...prev,\n      regCurrent: matchedAppraisal.vehicleReg || prev.regCurrent,\n      make: matchedAppraisal.vehicleMake || prev.make,\n      model: matchedAppraisal.vehicleModel || prev.model,\n      year: matchedAppraisal.vehicleYear || prev.year,\n      mileageCurrent: matchedAppraisal.mileage || prev.mileageCurrent,\n      notes: matchedAppraisal.conditionNotes || prev.notes,\n    }));\n    setAppraisalDismissed(true);\n    toast.success(\"Imported data from appraisal\");\n  };\n\n  // Convert appraisal directly to stock (uses the convert API)\n  const convertAppraisalToStock = async () => {\n    if (!matchedAppraisal) return;\n    setIsLoading(true);\n    try {\n      // Determine the API endpoint based on appraisal type\n      const endpoint = matchedAppraisal.type === \"customer_px\"\n        ? `/api/customer-px/${matchedAppraisal.id}/convert`\n        : `/api/appraisals/${matchedAppraisal.id}/convert`;\n\n      const res = await fetch(endpoint, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ initialStatus: \"in_stock\" }),\n      });\n\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.error || \"Failed to convert appraisal\");\n      }\n\n      toast.success(\"Appraisal converted to stock!\");\n      onSuccess();\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleLookup = async () => {\n    if (!formData.regCurrent) return toast.error(\"Enter registration first\");\n    setIsLookingUp(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: formData.regCurrent }),\n      });\n      const data = await res.json();\n\n      // Check for error response\n      if (!res.ok || data.error) {\n        toast.error(data.message || data.error || \"Vehicle not found\");\n        return;\n      }\n\n      if (data.isDummy) showDummyNotification(\"DVLA API\");\n\n      // Update form with DVLA data\n      setFormData(prev => ({\n        ...prev,\n        make: data.make || prev.make,\n        model: data.model || prev.model,\n        year: data.yearOfManufacture || data.year || prev.year,\n        colour: data.colour || prev.colour,\n        fuelType: data.fuelType || prev.fuelType,\n        transmission: data.transmission || prev.transmission,\n        motExpiryDate: data.motExpiryDate || prev.motExpiryDate,\n        // Engine capacity from DVLA (in cc)\n        engineCapacity: data.engineCapacity || data.dvlaDetails?.engineCapacity || prev.engineCapacity,\n        // Store full DVLA details for API persistence\n        dvlaDetails: data.dvlaDetails || null,\n        lastDvlaFetchAt: data.lastDvlaFetchAt || null,\n      }));\n\n      toast.success(`Found: ${data.make} ${data.model || \"\"} (${data.yearOfManufacture || \"\"})`);\n    } catch (error) {\n      toast.error(\"Lookup failed - please try again\");\n    } finally {\n      setIsLookingUp(false);\n    }\n  };\n\n  const uploadFile = async (file) => {\n    if (!file) return null;\n    const formData = new FormData();\n    formData.append(\"file\", file);\n    const res = await fetch(\"/api/vehicles/upload\", {\n      method: \"POST\",\n      body: formData,\n    });\n    if (!res.ok) throw new Error(\"Upload failed\");\n    const data = await res.json();\n    // Store S3 key (permanent) if available, otherwise use URL (for local dev)\n    return data.key || data.url;\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    if (!formData.regCurrent || !formData.make || !formData.model) {\n      return toast.error(\"Reg, make and model are required\");\n    }\n    setIsLoading(true);\n    try {\n      // Create vehicle first\n      // If \"None\" is selected, skip default tasks\n      // If \"default\" is selected, create default tasks (don't skip)\n      const skipDefault = selectedTemplate === \"\";\n      const vehicleRes = await fetch(\"/api/vehicles\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ ...formData, skipDefaultTasks: skipDefault }),\n      });\n      if (!vehicleRes.ok) {\n        const errorData = await vehicleRes.json();\n        throw new Error(errorData.error || \"Failed to create vehicle\");\n      }\n      const vehicle = await vehicleRes.json();\n\n      // Upload documents\n      if (v5File) {\n        const v5Url = await uploadFile(v5File);\n        await fetch(`/api/vehicles/${vehicle.id}`, {\n          method: \"PUT\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ v5Url }),\n        });\n      }\n\n      if (serviceHistoryFile) {\n        const url = await uploadFile(serviceHistoryFile);\n        await fetch(`/api/vehicles/${vehicle.id}/documents`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ name: \"Service History\", type: \"service_history\", url }),\n        });\n      }\n\n      if (faultCodesFile) {\n        const url = await uploadFile(faultCodesFile);\n        await fetch(`/api/vehicles/${vehicle.id}/documents`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ name: \"Fault Codes\", type: \"fault_codes\", url }),\n        });\n      }\n\n      // Upload other documents\n      for (const doc of otherDocuments) {\n        if (doc.file) {\n          const url = await uploadFile(doc.file);\n          await fetch(`/api/vehicles/${vehicle.id}/documents`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ name: doc.name || \"Document\", type: \"other\", url }),\n          });\n        }\n      }\n\n      // Create initial issues from the array\n      for (const issue of initialIssues) {\n        await fetch(`/api/vehicles/${vehicle.id}/issues`, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            category: issue.category,\n            subcategory: issue.subcategory,\n            description: issue.description,\n            actionNeeded: issue.actionNeeded,\n            status: issue.status || \"Outstanding\",\n            notes: issue.notes,\n          }),\n        });\n      }\n\n      // Create prep tasks based on template\n      // Only create from prepTemplates if a custom template is selected (not \"default\" which is handled by API)\n      if (selectedTemplate && selectedTemplate !== \"default\" && prepTemplates.length > 0) {\n        for (const template of prepTemplates) {\n          await fetch(`/api/vehicles/${vehicle.id}/tasks`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({ name: template.name }),\n          });\n        }\n      }\n\n      // Link appraisal to vehicle if one was matched\n      if (matchedAppraisal && matchedAppraisal.id) {\n        await fetch(`/api/appraisals/${matchedAppraisal.id}`, {\n          method: \"PATCH\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            decision: \"converted\",\n            vehicleId: vehicle.id,\n            decidedAt: new Date(),\n          }),\n        });\n      }\n\n      toast.success(\"Vehicle added!\");\n      onSuccess();\n    } catch (error) {\n      console.error(\"Error:\", error);\n      toast.error(error.message);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box max-w-4xl max-h-[90vh] overflow-y-auto bg-white\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h3 className=\"text-xl font-bold text-slate-900\">Add Vehicle</h3>\n          <button\n            type=\"button\"\n            onClick={onClose}\n            className=\"p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200\"\n          >\n            <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n            </svg>\n          </button>\n        </div>\n        <form onSubmit={handleSubmit}>\n          {/* Vehicle Details Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Vehicle Details</h4>\n            <div className=\"relative flex gap-2 mb-4\">\n              <div className=\"relative flex-1\">\n                <input\n                  type=\"text\"\n                  placeholder=\"Registration\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg uppercase font-mono text-slate-900 placeholder-slate-400 focus:bg-white focus:border-transparent focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  value={formData.regCurrent}\n                  onChange={(e) => {\n                    const newValue = e.target.value.toUpperCase();\n                    setFormData({ ...formData, regCurrent: newValue });\n                    searchAppraisals(newValue);\n                  }}\n                  onFocus={() => {\n                    if (appraisalSuggestions.length > 0) setShowAppraisalDropdown(true);\n                  }}\n                  onBlur={(e) => {\n                    // Delay hiding dropdown so click on suggestion can register\n                    setTimeout(() => setShowAppraisalDropdown(false), 200);\n                    checkForAppraisal(e.target.value);\n                  }}\n                />\n                {isSearchingAppraisals && (\n                  <span className=\"absolute right-3 top-1/2 -translate-y-1/2 loading loading-spinner loading-sm\"></span>\n                )}\n                {/* Appraisal Suggestions Dropdown */}\n                {showAppraisalDropdown && appraisalSuggestions.length > 0 && (\n                  <div className=\"absolute top-full left-0 right-0 z-50 mt-1 bg-base-100 border border-base-300 rounded-lg shadow-xl max-h-64 overflow-y-auto\">\n                    <div className=\"px-3 py-2 text-xs text-base-content/60 border-b border-base-200 bg-base-200/50\">\n                      Unconverted Appraisals\n                    </div>\n                    {appraisalSuggestions.map((appraisal) => (\n                      <button\n                        key={appraisal.id}\n                        type=\"button\"\n                        className=\"w-full px-3 py-2 text-left hover:bg-base-200 border-b border-base-200 last:border-b-0 flex items-center gap-3\"\n                        onClick={() => handleSelectAppraisalSuggestion(appraisal)}\n                      >\n                        <div className=\"flex-1\">\n                          <div className=\"font-mono font-bold\">{appraisal.vehicleReg}</div>\n                          <div className=\"text-sm text-base-content/70\">\n                            {appraisal.vehicleMake} {appraisal.vehicleModel} {appraisal.vehicleYear ? `(${appraisal.vehicleYear})` : \"\"}\n                          </div>\n                        </div>\n                        <span className={`badge badge-sm ${appraisal.type === \"dealer\" ? \"badge-primary\" : \"badge-secondary\"}`}>\n                          {appraisal.type === \"dealer\" ? \"Dealer\" : \"Customer PX\"}\n                        </span>\n                      </button>\n                    ))}\n                  </div>\n                )}\n              </div>\n              <button\n                type=\"button\"\n                className=\"px-5 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-2\"\n                onClick={handleLookup}\n                disabled={isLookingUp}\n              >\n                {isLookingUp ? <span className=\"loading loading-spinner loading-sm\"></span> : <><span>🔍</span><span>Lookup</span></>}\n              </button>\n            </div>\n\n            {/* Appraisal Match Alert */}\n            {isCheckingAppraisal && (\n              <div className=\"alert mb-4\">\n                <span className=\"loading loading-spinner loading-sm\"></span>\n                <span>Checking for existing appraisals...</span>\n              </div>\n            )}\n            {matchedAppraisal && !appraisalDismissed && (\n              <div className=\"alert alert-success mb-4\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5 shrink-0\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n                <div className=\"flex-1\">\n                  <p className=\"font-semibold\">\n                    {matchedAppraisal.type === \"customer_px\" ? \"Customer PX\" : \"Dealer\"} Appraisal Found: {matchedAppraisal.vehicleReg}\n                  </p>\n                  <p className=\"text-sm opacity-80\">\n                    {matchedAppraisal.vehicleMake} {matchedAppraisal.vehicleModel} {matchedAppraisal.vehicleYear ? `(${matchedAppraisal.vehicleYear})` : \"\"}\n                    {matchedAppraisal.mileage ? ` • ${matchedAppraisal.mileage.toLocaleString()} miles` : \"\"}\n                  </p>\n                </div>\n                <div className=\"flex flex-col sm:flex-row gap-2\">\n                  <button type=\"button\" className=\"btn btn-sm btn-primary\" onClick={convertAppraisalToStock} disabled={isLoading}>\n                    {isLoading ? <span className=\"loading loading-spinner loading-sm\"></span> : \"Convert to Stock\"}\n                  </button>\n                  <button type=\"button\" className=\"btn btn-sm btn-ghost\" onClick={importFromAppraisal}>\n                    Import Data Only\n                  </button>\n                  <button type=\"button\" className=\"btn btn-sm btn-ghost\" onClick={() => setAppraisalDismissed(true)}>\n                    Dismiss\n                  </button>\n                </div>\n              </div>\n            )}\n\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Make *</label>\n                <input type=\"text\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.make}\n                  onChange={(e) => setFormData({ ...formData, make: e.target.value })} required />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Model *</label>\n                <input type=\"text\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.model}\n                  onChange={(e) => setFormData({ ...formData, model: e.target.value })} required />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Year</label>\n                <input type=\"number\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.year}\n                  onChange={(e) => setFormData({ ...formData, year: e.target.value })} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Mileage</label>\n                <input type=\"number\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.mileageCurrent}\n                  onChange={(e) => setFormData({ ...formData, mileageCurrent: e.target.value })} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Colour</label>\n                <input type=\"text\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" value={formData.colour}\n                  onChange={(e) => setFormData({ ...formData, colour: e.target.value })} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Fuel Type</label>\n                <select className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\" value={formData.fuelType?.toUpperCase() || \"\"}\n                  onChange={(e) => setFormData({ ...formData, fuelType: e.target.value })}>\n                  <option value=\"\">Select...</option>\n                  <option value=\"PETROL\">Petrol</option>\n                  <option value=\"DIESEL\">Diesel</option>\n                  <option value=\"HYBRID\">Hybrid</option>\n                  <option value=\"ELECTRIC\">Electric</option>\n                  <option value=\"LPG\">LPG</option>\n                  <option value=\"CNG\">CNG</option>\n                </select>\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">MOT Expiry Date</label>\n                <input\n                  type=\"date\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  value={formData.motExpiryDate ? formData.motExpiryDate.split(\"T\")[0] : \"\"}\n                  onChange={(e) => setFormData({ ...formData, motExpiryDate: e.target.value })}\n                />\n                <p className=\"text-xs text-slate-400 mt-1.5\">\n                  {formData.motExpiryDate ? \"\" : \"Auto-filled by VRM lookup or enter manually\"}\n                </p>\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Transmission</label>\n                <select className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\" value={formData.transmission?.toUpperCase() || \"\"}\n                  onChange={(e) => setFormData({ ...formData, transmission: e.target.value })}>\n                  <option value=\"\">Select...</option>\n                  <option value=\"MANUAL\">Manual</option>\n                  <option value=\"AUTOMATIC\">Automatic</option>\n                  <option value=\"SEMI-AUTO\">Semi-Auto</option>\n                  <option value=\"CVT\">CVT</option>\n                </select>\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Engine Capacity (cc)</label>\n                <input\n                  type=\"number\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  placeholder=\"e.g., 1500\"\n                  value={formData.engineCapacity || \"\"}\n                  onChange={(e) => setFormData({ ...formData, engineCapacity: e.target.value })}\n                />\n                <p className=\"text-xs text-slate-400 mt-1.5\">\n                  {formData.engineCapacity ? \"\" : \"Auto-filled by VRM lookup\"}\n                </p>\n              </div>\n            </div>\n          </div>\n\n          {/* Vehicle Type Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Vehicle Type</h4>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Vehicle Type</label>\n                <select\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                  value={formData.type}\n                  onChange={(e) => {\n                    const newType = e.target.value;\n                    setFormData({\n                      ...formData,\n                      type: newType,\n                      // Clear saleType if not Stock\n                      saleType: newType === \"STOCK\" ? (formData.saleType || \"RETAIL\") : undefined\n                    });\n                  }}\n                >\n                  <option value=\"STOCK\">Stock - For sale</option>\n                  <option value=\"COURTESY\">Courtesy - Loan vehicle</option>\n                  <option value=\"FLEET_OTHER\">Fleet/Other - Company vehicle</option>\n                </select>\n              </div>\n              {/* Sale Type - Only show for Stock vehicles */}\n              {formData.type === \"STOCK\" && (\n                <div className=\"form-control\">\n                  <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Sale Type</label>\n                  <select\n                    className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                    value={formData.saleType || \"RETAIL\"}\n                    onChange={(e) => setFormData({ ...formData, saleType: e.target.value })}\n                  >\n                    <option value=\"RETAIL\">Retail - Customer sale</option>\n                    <option value=\"TRADE\">Trade - Dealer sale</option>\n                  </select>\n                </div>\n              )}\n            </div>\n            <p className=\"text-xs text-slate-400 mt-3\">\n              {formData.type === \"COURTESY\" && \"This vehicle will be available in courtesy car forms\"}\n              {formData.type === \"FLEET_OTHER\" && \"This vehicle will not appear in sales board\"}\n              {formData.type === \"STOCK\" && formData.saleType === \"TRADE\" && \"Trade vehicles are marked separately and can be filtered\"}\n              {formData.type === \"STOCK\" && formData.saleType !== \"TRADE\" && \"This vehicle will go through the normal sales prep flow\"}\n            </p>\n          </div>\n\n          {/* Location Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Location</h4>\n            <div className=\"form-control\">\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={formData.locationId}\n                onChange={(e) => setFormData({ ...formData, locationId: e.target.value })}\n              >\n                <option value=\"\">On Site</option>\n                {locations.map(loc => (\n                  <option key={loc.id} value={loc.id}>{loc.name}</option>\n                ))}\n              </select>\n            </div>\n          </div>\n\n          {/* Document Uploads Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Document Uploads (Optional)</h4>\n            <div className=\"space-y-4\">\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">V5 Document</label>\n                <input type=\"file\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" accept=\"image/*,.pdf\"\n                  onChange={(e) => setV5File(e.target.files[0])} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Service History</label>\n                <input type=\"file\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" accept=\"image/*,.pdf\"\n                  onChange={(e) => setServiceHistoryFile(e.target.files[0])} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Fault Codes</label>\n                <input type=\"file\" className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\" accept=\"image/*,.pdf\"\n                  onChange={(e) => setFaultCodesFile(e.target.files[0])} />\n              </div>\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Other Documents</label>\n                <button\n                  type=\"button\"\n                  className=\"px-4 py-2.5 bg-slate-50 border border-slate-200 hover:border-slate-300 hover:bg-slate-100 text-slate-700 text-sm font-medium rounded-lg transition-all duration-200\"\n                  onClick={() => setOtherDocuments([...otherDocuments, { name: \"\", file: null }])}\n                >\n                  + Add Document/Image\n                </button>\n                {otherDocuments.map((doc, idx) => (\n                  <div key={idx} className=\"flex gap-2 mt-3\">\n                    <input\n                      type=\"text\"\n                      placeholder=\"Document name\"\n                      className=\"flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 text-sm placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                      value={doc.name}\n                      onChange={(e) => {\n                        const updated = [...otherDocuments];\n                        updated[idx].name = e.target.value;\n                        setOtherDocuments(updated);\n                      }}\n                    />\n                    <input\n                      type=\"file\"\n                      className=\"flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 text-sm file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium file:text-xs hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] transition-all duration-200 outline-none\"\n                      onChange={(e) => {\n                        const updated = [...otherDocuments];\n                        updated[idx].file = e.target.files[0];\n                        setOtherDocuments(updated);\n                      }}\n                    />\n                    <button\n                      type=\"button\"\n                      className=\"p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all duration-200\"\n                      onClick={() => setOtherDocuments(otherDocuments.filter((_, i) => i !== idx))}\n                    >\n                      ✕\n                    </button>\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n\n          {/* Initial Issues Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Initial Issues (Optional)</h4>\n\n            {/* Add Issue Button */}\n            <button\n              type=\"button\"\n              className=\"w-full px-4 py-2.5 bg-slate-50 border border-slate-200 hover:border-slate-300 hover:bg-slate-100 text-slate-700 text-sm font-medium rounded-lg transition-all duration-200 mb-3\"\n              onClick={() => setShowAddIssueInVehicleModal(true)}\n            >\n              + Add Issue\n            </button>\n\n            {/* Issue Summary Cards */}\n            {initialIssues.length > 0 && (\n              <div className=\"space-y-2\">\n                {initialIssues.map((issue, index) => (\n                  <div key={index} className=\"card bg-base-200\">\n                    <div className=\"card-body p-3\">\n                      <div className=\"flex justify-between items-start gap-2\">\n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-center gap-2 mb-1\">\n                            <span className=\"badge badge-sm\">{issue.category}</span>\n                            {issue.subcategory && (\n                              <span className=\"badge badge-sm badge-ghost\">{issue.subcategory}</span>\n                            )}\n                          </div>\n                          <p className=\"text-sm font-medium truncate\">{issue.description}</p>\n                          {issue.actionNeeded && (\n                            <p className=\"text-xs text-base-content/60 mt-1\">Action: {issue.actionNeeded}</p>\n                          )}\n                        </div>\n                        <button\n                          type=\"button\"\n                          className=\"btn btn-ghost btn-xs text-error\"\n                          onClick={() => {\n                            setInitialIssues(initialIssues.filter((_, i) => i !== index));\n                          }}\n                        >\n                          ✕\n                        </button>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          {/* Prep Checklist Template Section */}\n          <div className=\"mb-6 pb-6 border-b border-slate-100\">\n            <h4 className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-4\">Prep Checklist Template</h4>\n            <div className=\"form-control\">\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={selectedTemplate}\n                onChange={(e) => setSelectedTemplate(e.target.value)}\n              >\n                <option value=\"\">None - add tasks manually</option>\n                <option value=\"default\">Standard Prep (5 tasks)</option>\n              </select>\n            </div>\n\n            {/* Task Preview for Standard Prep */}\n            {selectedTemplate === \"default\" && (\n              <div className=\"mt-3 p-4 bg-slate-50 rounded-lg border border-slate-100\">\n                <p className=\"text-xs font-bold text-slate-500 uppercase tracking-wider mb-3\">Tasks included:</p>\n                <div className=\"text-sm text-slate-600 space-y-2\">\n                  {[\"PDI\", \"Valet\", \"Photos\", \"MOT Check\", \"Advert\"].map((task, idx) => (\n                    <div key={idx} className=\"flex items-center gap-2\">\n                      <span className=\"text-[#0066CC]\">✓</span>\n                      <span>{task}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n          </div>\n\n          {/* Notes Section */}\n          <div className=\"mb-8\">\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Additional Notes</label>\n              <textarea\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                rows={4}\n                value={formData.notes}\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n              ></textarea>\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-end gap-3 pt-4 border-t border-slate-100\">\n            <button\n              type=\"button\"\n              className=\"px-5 py-2.5 border border-slate-200 text-slate-600 hover:text-slate-800 hover:border-slate-300 hover:bg-slate-50 font-medium rounded-lg transition-all duration-200\"\n              onClick={onClose}\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-2.5 bg-[#0066CC] hover:bg-[#0055BB] text-white font-medium rounded-lg shadow-sm hover:shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n              disabled={isLoading}\n            >\n              {isLoading ? <><span className=\"loading loading-spinner loading-sm\"></span><span>Saving...</span></> : \"Add Vehicle\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n\n      {/* Nested Add Issue Modal */}\n      {showAddIssueInVehicleModal && (\n        <AddIssueModal\n          issueForm={newIssueForm}\n          setIssueForm={setNewIssueForm}\n          onClose={() => {\n            setShowAddIssueInVehicleModal(false);\n            setNewIssueForm({\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              status: \"Outstanding\",\n              notes: \"\",\n              photos: [],\n            });\n          }}\n          onSubmit={() => {\n            // Validate required fields\n            if (!newIssueForm.category || !newIssueForm.subcategory || !newIssueForm.description) {\n              return toast.error(\"Category, subcategory, and description are required\");\n            }\n\n            // Add issue to the array\n            setInitialIssues([...initialIssues, { ...newIssueForm }]);\n\n            // Close modal and reset form\n            setShowAddIssueInVehicleModal(false);\n            setNewIssueForm({\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              status: \"Outstanding\",\n              notes: \"\",\n              photos: [],\n            });\n            toast.success(\"Issue added\");\n          }}\n        />\n      )}\n    </div>\n  );\n}\n\nfunction AddIssueModal({ issueForm, setIssueForm, onClose, onSubmit, isEditing = false }) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [photoFiles, setPhotoFiles] = useState([]);\n  const [photoPreviews, setPhotoPreviews] = useState([]);\n  const [isUploadingPhotos, setIsUploadingPhotos] = useState(false);\n\n  const handlePhotoChange = (e) => {\n    const files = Array.from(e.target.files);\n    setPhotoFiles(prev => [...prev, ...files]);\n\n    // Create previews\n    files.forEach(file => {\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        setPhotoPreviews(prev => [...prev, reader.result]);\n      };\n      reader.readAsDataURL(file);\n    });\n  };\n\n  const removePhoto = (index) => {\n    setPhotoFiles(prev => prev.filter((_, i) => i !== index));\n    setPhotoPreviews(prev => prev.filter((_, i) => i !== index));\n  };\n\n  const uploadPhotos = async () => {\n    const uploadedUrls = [];\n    for (const file of photoFiles) {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      const res = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: formData,\n      });\n      if (res.ok) {\n        const data = await res.json();\n        // Store S3 key (permanent) if available, otherwise use URL (for local dev)\n        uploadedUrls.push(data.key || data.url);\n      }\n    }\n    return uploadedUrls;\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsLoading(true);\n    try {\n      // Upload photos first if any\n      let photoUrls = [];\n      if (photoFiles.length > 0) {\n        setIsUploadingPhotos(true);\n        photoUrls = await uploadPhotos();\n        setIsUploadingPhotos(false);\n      }\n      // Pass photo URLs/keys to onSubmit\n      await onSubmit(photoUrls);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box max-w-2xl bg-white\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h3 className=\"text-xl font-bold text-slate-900\">{isEditing ? \"Edit Issue\" : \"Add Issue\"}</h3>\n          <button\n            type=\"button\"\n            onClick={onClose}\n            className=\"p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200\"\n          >\n            <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n            </svg>\n          </button>\n        </div>\n        <form onSubmit={handleSubmit}>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Category *</label>\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={issueForm.category}\n                onChange={(e) => {\n                  setIssueForm({ ...issueForm, category: e.target.value, subcategory: \"\" });\n                }}\n                required\n              >\n                <option value=\"\">Select category...</option>\n                <option value=\"mechanical\">Mechanical</option>\n                <option value=\"electrical\">Electrical</option>\n                <option value=\"bodywork\">Bodywork</option>\n                <option value=\"interior\">Interior</option>\n                <option value=\"tyres\">Tyres</option>\n                <option value=\"mot\">MOT</option>\n                <option value=\"service\">Service</option>\n                <option value=\"fault_codes\">Fault Codes</option>\n                <option value=\"other\">Other</option>\n              </select>\n            </div>\n\n            {issueForm.category && (\n              <div className=\"form-control\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Subcategory</label>\n                <select\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                  value={issueForm.subcategory}\n                  onChange={(e) => setIssueForm({ ...issueForm, subcategory: e.target.value })}\n                >\n                  <option value=\"\">Select subcategory...</option>\n                  {ISSUE_SUBCATEGORIES[issueForm.category]?.map((sub) => (\n                    <option key={sub} value={sub}>{sub}</option>\n                  ))}\n                </select>\n              </div>\n            )}\n\n            {/* Fault Codes field - only show for fault_codes category */}\n            {issueForm.category === \"fault_codes\" && (\n              <div className=\"form-control col-span-2\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Fault Codes</label>\n                <input\n                  type=\"text\"\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 font-mono placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                  value={issueForm.faultCodes || \"\"}\n                  onChange={(e) => setIssueForm({ ...issueForm, faultCodes: e.target.value })}\n                  placeholder=\"e.g. P0301, P0420, C1234\"\n                />\n                <p className=\"text-xs text-slate-400 mt-1.5\">Enter codes separated by commas</p>\n              </div>\n            )}\n\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Description *</label>\n              <textarea\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                value={issueForm.description}\n                onChange={(e) => setIssueForm({ ...issueForm, description: e.target.value })}\n                placeholder={issueForm.category === \"fault_codes\" ? \"Describe what the fault codes indicate...\" : \"Describe the issue...\"}\n                required\n                rows=\"3\"\n              ></textarea>\n            </div>\n\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Action Needed</label>\n              <input\n                type=\"text\"\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                value={issueForm.actionNeeded}\n                onChange={(e) => setIssueForm({ ...issueForm, actionNeeded: e.target.value })}\n                placeholder=\"What needs to be done?\"\n              />\n            </div>\n\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Priority</label>\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={issueForm.priority || \"medium\"}\n                onChange={(e) => setIssueForm({ ...issueForm, priority: e.target.value })}\n              >\n                <option value=\"low\">Low</option>\n                <option value=\"medium\">Medium</option>\n                <option value=\"high\">High</option>\n              </select>\n            </div>\n\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Location</label>\n              <input\n                type=\"text\"\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n                value={issueForm.location || \"\"}\n                onChange={(e) => setIssueForm({ ...issueForm, location: e.target.value })}\n                placeholder=\"e.g., Front Left, Rear Bumper\"\n              />\n            </div>\n\n            <div className=\"form-control\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Status</label>\n              <select\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer\"\n                value={issueForm.status}\n                onChange={(e) => setIssueForm({ ...issueForm, status: e.target.value })}\n              >\n                <option value=\"outstanding\">Outstanding</option>\n                <option value=\"ordered\">Ordered</option>\n                <option value=\"in_progress\">In Progress</option>\n                <option value=\"resolved\">Resolved</option>\n              </select>\n            </div>\n\n            {/* Parts Required Section */}\n            <div className=\"form-control flex items-center\">\n              <label className=\"flex items-center gap-3 cursor-pointer mt-6\">\n                <div className=\"relative\">\n                  <input\n                    type=\"checkbox\"\n                    className=\"sr-only peer\"\n                    checked={issueForm.partsRequired || false}\n                    onChange={(e) => setIssueForm({ ...issueForm, partsRequired: e.target.checked })}\n                  />\n                  <div className=\"w-5 h-5 rounded border-2 border-slate-300 peer-checked:border-[#0066CC] peer-checked:bg-[#0066CC] transition-all duration-200 flex items-center justify-center\">\n                    <svg className=\"w-3 h-3 text-white opacity-0 peer-checked:opacity-100\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={3} d=\"M5 13l4 4L19 7\" />\n                    </svg>\n                  </div>\n                </div>\n                <span className=\"text-sm font-medium text-slate-700\">Parts Required</span>\n              </label>\n            </div>\n\n            {issueForm.partsRequired && (\n              <div className=\"form-control col-span-2\">\n                <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Parts Details</label>\n                <textarea\n                  className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                  value={issueForm.partsDetails || \"\"}\n                  onChange={(e) => setIssueForm({ ...issueForm, partsDetails: e.target.value })}\n                  placeholder=\"Supplier, part numbers, who ordered, ETA...\"\n                  rows=\"2\"\n                ></textarea>\n              </div>\n            )}\n\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Notes</label>\n              <textarea\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none\"\n                value={issueForm.notes}\n                onChange={(e) => setIssueForm({ ...issueForm, notes: e.target.value })}\n                placeholder=\"Additional notes...\"\n                rows=\"2\"\n              ></textarea>\n            </div>\n\n            {/* Photo Upload */}\n            <div className=\"form-control col-span-2\">\n              <label className=\"block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2\">Photos</label>\n              <input\n                type=\"file\"\n                accept=\"image/*\"\n                multiple\n                onChange={handlePhotoChange}\n                className=\"w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none\"\n              />\n              {photoPreviews.length > 0 && (\n                <div className=\"flex flex-wrap gap-2 mt-3\">\n                  {photoPreviews.map((preview, idx) => (\n                    <div key={idx} className=\"relative\">\n                      <img src={preview} alt={`Preview ${idx + 1}`} className=\"w-20 h-20 object-cover rounded-lg\" />\n                      <button\n                        type=\"button\"\n                        onClick={() => removePhoto(idx)}\n                        className=\"absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs flex items-center justify-center transition-colors\"\n                      >\n                        ✕\n                      </button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n\n          <div className=\"flex items-center justify-end gap-3 pt-6 mt-6 border-t border-slate-100\">\n            <button\n              type=\"button\"\n              className=\"px-5 py-2.5 border border-slate-200 text-slate-600 hover:text-slate-800 hover:border-slate-300 hover:bg-slate-50 font-medium rounded-lg transition-all duration-200\"\n              onClick={onClose}\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              className=\"px-6 py-2.5 bg-[#0066CC] hover:bg-[#0055BB] text-white font-medium rounded-lg shadow-sm hover:shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2\"\n              disabled={isLoading || isUploadingPhotos}\n            >\n              {isLoading || isUploadingPhotos ? (\n                <>\n                  <span className=\"loading loading-spinner loading-sm\"></span>\n                  <span>{isUploadingPhotos ? \"Uploading photos...\" : \"Saving...\"}</span>\n                </>\n              ) : \"Add Issue\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n\nfunction AddDocumentModal({ documentForm, setDocumentForm, onClose, onSubmit }) {\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsLoading(true);\n    try {\n      await onSubmit();\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box\">\n        <h3 className=\"font-bold text-lg mb-4\">Add Document/Image</h3>\n        <form onSubmit={handleSubmit}>\n          <div className=\"space-y-4\">\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Document Type</span></label>\n              <select\n                className=\"select select-bordered\"\n                value={documentForm.type}\n                onChange={(e) => setDocumentForm({ ...documentForm, type: e.target.value })}\n              >\n                <option value=\"v5\">V5</option>\n                <option value=\"service_history\">Service History</option>\n                <option value=\"fault_codes\">Fault Codes</option>\n                <option value=\"other\">Other</option>\n              </select>\n            </div>\n\n            {/* Only show Document Name field when \"Other\" is selected */}\n            {documentForm.type === \"other\" && (\n              <div className=\"form-control\">\n                <label className=\"label\"><span className=\"label-text\">Document Name *</span></label>\n                <input\n                  type=\"text\"\n                  className=\"input input-bordered\"\n                  value={documentForm.name}\n                  onChange={(e) => setDocumentForm({ ...documentForm, name: e.target.value })}\n                  placeholder=\"e.g., MOT Certificate, Insurance\"\n                  required\n                />\n              </div>\n            )}\n\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">File *</span></label>\n              <input\n                type=\"file\"\n                className=\"file-input file-input-bordered w-full\"\n                onChange={(e) => setDocumentForm({ ...documentForm, file: e.target.files[0] })}\n                accept=\"image/*,.pdf,.doc,.docx\"\n                required\n              />\n            </div>\n          </div>\n\n          <div className=\"modal-action\">\n            <button type=\"button\" className=\"btn btn-ghost\" onClick={onClose}>Cancel</button>\n            <button type=\"submit\" className=\"btn btn-primary\" disabled={isLoading}>\n              {isLoading ? <span className=\"loading loading-spinner\"></span> : \"Upload Document/Image\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n\nfunction AddLocationModal({ onClose, onSuccess }) {\n  const [name, setName] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    if (!name.trim()) return toast.error(\"Location name is required\");\n\n    setIsLoading(true);\n    try {\n      const res = await fetch(\"/api/locations\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ name: name.trim(), type: \"offsite\" }),\n      });\n      if (!res.ok) throw new Error(\"Failed to create location\");\n      const newLocation = await res.json();\n      toast.success(\"Location added\");\n      onSuccess(newLocation);\n    } catch (error) {\n      toast.error(\"Failed to add location\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box\">\n        <h3 className=\"font-bold text-lg mb-4\">Add New Location</h3>\n        <form onSubmit={handleSubmit}>\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text\">Location Name *</span>\n            </label>\n            <input\n              type=\"text\"\n              className=\"input input-bordered w-full\"\n              value={name}\n              onChange={(e) => setName(e.target.value)}\n              placeholder=\"e.g., ABC Body Shop, Paint Centre\"\n              required\n              autoFocus\n            />\n          </div>\n          <div className=\"modal-action\">\n            <button type=\"button\" className=\"btn btn-ghost\" onClick={onClose}>\n              Cancel\n            </button>\n            <button type=\"submit\" className=\"btn btn-primary\" disabled={isLoading}>\n              {isLoading ? <span className=\"loading loading-spinner\"></span> : \"Add Location\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n","structuredPatch":[{"oldStart":200,"oldLines":6,"newStart":200,"newLines":15,"lines":["     fetchLabels();","   }, []);"," ","+  // Handle addVehicle query param (from Quick Add menu)","+  useEffect(() => {","+    if (router.query.addVehicle === \"1\") {","+      setShowAddModal(true);","+      // Remove the query param from URL without reload","+      router.replace(\"/sales-prep\", undefined, { shallow: true });","+    }","+  }, [router.query.addVehicle]);","+","   const fetchVehicles = async () => {","     try {","       const res = await fetch(\"/api/vehicles\");"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"6054b397-05ed-4bdb-b8a6-3b44e0d14852","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01158z7Y3Wpagej1UmEQGvuB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I've completed the first two tasks (Quick Add z-index fix and adding the new menu items). Let me update the todo list and move on to the AI service issues.","signature":"EsQCCkYICxgCKkDySRw+llFlKbqFCcGnth8Ii5MRzOSJWqAkxbeaddRDrl53IEMzIdQRVG02/e/Cx3VB54j+9xu2srSghI9ookckEgz40iS7152IWhhGflUaDKG31p7Y6d5qcauCsyIwApZRcvGGadwDd6yGfsu9GftyZzcbFZXIbXiRHB9mrjbj+gkCknnQWoZZdbuEQpsIKqsBX3CK87/VmJU1a9tLQH8D8go65Zsy9qvaazig5qfWhFrmybrvnUVgFSgdwn83hhaAWpygPWx5plStjzn/neCSOGJW70gqK/dEEUhvN+taq8juKObdJe5l1HsDjLFwF03Nt/vLGqxd6Se6mBkjqeShyYSnYuCyWHOwTx7S3Uqimm8X+q0eT3yooPkSTaLUd3wOgvOP0Kzi2+UnQHpDONpWRP7YxtRVElNRsswrGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":816,"cache_read_input_tokens":84872,"cache_creation":{"ephemeral_5m_input_tokens":816,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd8pYSG53YU6enQdk2dm","type":"assistant","uuid":"4f3e60f8-de83-48a6-bb9d-420b1a403c7c","timestamp":"2025-12-30T15:49:18.181Z"}
{"parentUuid":"4f3e60f8-de83-48a6-bb9d-420b1a403c7c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01158z7Y3Wpagej1UmEQGvuB","type":"message","role":"assistant","content":[{"type":"text","text":"I've completed Task 1 and Task 2. Let me update the todo list:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":816,"cache_read_input_tokens":84872,"cache_creation":{"ephemeral_5m_input_tokens":816,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd8pYSG53YU6enQdk2dm","type":"assistant","uuid":"fb225d98-c106-4acc-b8af-ea387edb1d22","timestamp":"2025-12-30T15:49:18.725Z"}
{"parentUuid":"fb225d98-c106-4acc-b8af-ea387edb1d22","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01158z7Y3Wpagej1UmEQGvuB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SwcjZaTTf7Gv9qBsg4gDpG","name":"TodoWrite","input":{"todos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"completed","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"completed","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"in_progress","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"pending","activeForm":"Implementing Test Drive licence OCR extraction"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":816,"cache_read_input_tokens":84872,"cache_creation":{"ephemeral_5m_input_tokens":816,"ephemeral_1h_input_tokens":0},"output_tokens":264,"service_tier":"standard"}},"requestId":"req_011CWd8pYSG53YU6enQdk2dm","type":"assistant","uuid":"c072dbb9-0e0a-4a20-97e7-6820cd9cbff4","timestamp":"2025-12-30T15:49:21.729Z"}
{"parentUuid":"c072dbb9-0e0a-4a20-97e7-6820cd9cbff4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SwcjZaTTf7Gv9qBsg4gDpG","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"63e01888-da59-4ad7-b59e-dea120d5e96e","timestamp":"2025-12-30T15:49:21.800Z","toolUseResult":{"oldTodos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"in_progress","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"pending","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"pending","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"pending","activeForm":"Implementing Test Drive licence OCR extraction"}],"newTodos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"completed","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"completed","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"in_progress","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"pending","activeForm":"Implementing Test Drive licence OCR extraction"}]}}
{"parentUuid":"63e01888-da59-4ad7-b59e-dea120d5e96e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_017vwFN41F8TnGgaPg7g39EG","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to work on Task 3: Debug and fix AI service issues.\n\nLooking at the requirements:\n1. The health endpoint needs auth protection with dealer context\n2. Need to improve error handling in the UI\n3. Update error styling\n4. Centralize OpenAI client (already done in libs/openai.js)\n\nLet me:\n1. Update the health endpoint to use withDealerContext\n2. Look at where the AI errors are displayed and update the UI\n3. Update the error styling in AISuggestionsPanel or any other related component\n\nLet me first update the health endpoint.","signature":"ErkFCkYICxgCKkAQsFEHm7jj5FegE/rGDGLxfv9ZkD5Hn5hgbTs/LCyVMTO9tj3luGmtRR9i33DEiHBuGzz4KtUaMYswmLLk8t7XEgxIWFkktB5bPbzrTO8aDIsysZGzjNmKv+LuCCIwEfl7jxKPISBEQDWDbJjNxSOP+CptojoogEqhGOxCfuu4AoC9+8LPNGzbwhXEkTp1KqAE6DdQj95IJfaCp+3kEssLbhXaM+qzu/ZOb8R5mhPmXkbHdUdajoqOfjWlNGU3rQdEvt8hlVQojYKZOUKX9LANTC2q3DzlKAvZkf3yFqmMJIzmwz+X3kvBDvYh//6eXkpa1UXxeUsHvv8nj6ktL+NWYVwsNErPaaVdkt2CCklA+16cM18xCXRT7QeLS6b2pCELPfSwh1UqGIduTyC6Kg4naFSublBjlFE32rPR4wRCVo1szwvrSnxr07Lf/24rlbhV/YpLIddv7NOvVBAL1+9CDYDOi1WdYF4Ef+wSDN83pNqX5pOHZO0NL/cF9/W4lxjAxlQ8KvPMpBPQaHt0MdbZ7iK8StqFkUGjMqTLaHaruPqJEzKYheJADE+G8irgmsiWMe246Ga7NELJxPCscWPA5m4Sm10RJiXF+aV2gdf24k2HlCZbPLA872LZnWKD7ftDgrTRm0I1AUFkisyEZWLFfSxm9mEyMUsvjVwZUmvN3axGpBBTlaIueAJeBI6iUjmNjXPOZB9e+/FoZZ1zY3/6QjRQe6xcCPZflbeODLV1ZPZN2F685dQswPicyKbT3FCBDPjf0Bt40iON3ZjPBFVAkvKM+sHrVBym6DTB9HQykUArjTwufKCStihLdZz6crvcJzYvPy/jkH+4lip+MdFT8ZY53UhokRPeqgFUatDbqyM5W9Wc7QAwTA3zCTa+DigKNzmShq7e/sUn80ufTZxg3RgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":313,"cache_read_input_tokens":85688,"cache_creation":{"ephemeral_5m_input_tokens":313,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8qFU5fA8CJqJj4Wyr5","type":"assistant","uuid":"3e8b8b42-b26e-4fd7-b532-74b42ba06eb1","timestamp":"2025-12-30T15:49:29.066Z"}
{"parentUuid":"3e8b8b42-b26e-4fd7-b532-74b42ba06eb1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_017vwFN41F8TnGgaPg7g39EG","type":"message","role":"assistant","content":[{"type":"text","text":"## Task 3: Debug and fix AI service issues\n\nFirst, let me update the AI health endpoint to use dealer context authentication:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":313,"cache_read_input_tokens":85688,"cache_creation":{"ephemeral_5m_input_tokens":313,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8qFU5fA8CJqJj4Wyr5","type":"assistant","uuid":"c55a6cd0-13ed-45f6-8df8-e3f792d839d0","timestamp":"2025-12-30T15:49:29.683Z"}
{"parentUuid":"c55a6cd0-13ed-45f6-8df8-e3f792d839d0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_017vwFN41F8TnGgaPg7g39EG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XQ8fpbRgUeoosbZpLzfsuM","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\health.js","old_string":"/**\n * AI Health Check Endpoint\n *\n * GET /api/ai/health\n *\n * Returns the status of the OpenAI configuration.\n * Used for diagnostics and debugging.\n *\n * Response:\n * - ok: boolean - whether AI is configured and ready\n * - provider: \"openai\" - the AI provider (always OpenAI)\n * - model: string - the default model used\n * - hasOpenAIKey: boolean - whether the key is present\n * - keyPrefix: string - first 7 chars of the key for verification\n * - message: string - human-readable status message\n * - error: string - error code if not ok\n */\n\nexport default function handler(req, res) {\n  if (req.method !== \"GET\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const apiKey = process.env.OPENAI_API_KEY;\n  const model = process.env.AI_MODEL || \"gpt-4o-mini\";\n\n  if (!apiKey) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasOpenAIKey: false,\n      keyPrefix: null,\n      error: \"missing OPENAI_API_KEY\",\n      message: \"OpenAI is not configured. Set OPENAI_API_KEY in .env.local and restart the server.\",\n    });\n  }\n\n  // Check key format (should start with sk-)\n  if (!apiKey.startsWith(\"sk-\")) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasOpenAIKey: true,\n      keyPrefix: apiKey.slice(0, 7) + \"...\",\n      error: \"invalid OPENAI_API_KEY format\",\n      message: \"OPENAI_API_KEY should start with 'sk-'. Check your .env.local file.\",\n    });\n  }\n\n  return res.status(200).json({\n    ok: true,\n    provider: \"openai\",\n    model: model,\n    hasOpenAIKey: true,\n    keyPrefix: apiKey.slice(0, 7) + \"...\",\n    message: \"OpenAI is configured and ready\",\n  });\n}","new_string":"/**\n * AI Health Check Endpoint\n *\n * GET /api/ai/health\n *\n * Returns the status of the OpenAI configuration.\n * Used for diagnostics and debugging.\n * Protected by dealer context authentication.\n *\n * Response:\n * - ok: boolean - whether AI is configured and ready\n * - provider: \"openai\" - the AI provider (always OpenAI)\n * - model: string - the default model used\n * - hasKey: boolean - whether the key is present\n * - keyPrefix: string - first 7 chars of the key for verification\n * - message: string - human-readable status message\n * - error: string - error code if not ok\n */\n\nimport { withDealerContext } from \"@/libs/authContext\";\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"GET\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const apiKey = process.env.OPENAI_API_KEY;\n  const model = process.env.AI_MODEL || \"gpt-4o-mini\";\n\n  if (!apiKey) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasKey: false,\n      keyPrefix: null,\n      error: \"MISSING_KEY\",\n      message: \"OpenAI is not configured. Set OPENAI_API_KEY in .env.local and restart the server.\",\n    });\n  }\n\n  // Check key format (should start with sk-)\n  if (!apiKey.startsWith(\"sk-\")) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasKey: true,\n      keyPrefix: apiKey.slice(0, 7) + \"...\",\n      error: \"INVALID_KEY_FORMAT\",\n      message: \"OPENAI_API_KEY should start with 'sk-'. Check your .env.local file.\",\n    });\n  }\n\n  return res.status(200).json({\n    ok: true,\n    provider: \"openai\",\n    model: model,\n    hasKey: true,\n    keyPrefix: apiKey.slice(0, 7) + \"...\",\n    message: \"OpenAI is configured and ready\",\n  });\n}\n\nexport default withDealerContext(handler);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":313,"cache_read_input_tokens":85688,"cache_creation":{"ephemeral_5m_input_tokens":313,"ephemeral_1h_input_tokens":0},"output_tokens":1437,"service_tier":"standard"}},"requestId":"req_011CWd8qFU5fA8CJqJj4Wyr5","type":"assistant","uuid":"e293c74d-6003-4f2e-b35d-7a48c3b07d56","timestamp":"2025-12-30T15:49:47.508Z"}
{"type":"file-history-snapshot","messageId":"e293c74d-6003-4f2e-b35d-7a48c3b07d56","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"e293c74d-6003-4f2e-b35d-7a48c3b07d56","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XQ8fpbRgUeoosbZpLzfsuM","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\health.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→/**\n     2→ * AI Health Check Endpoint\n     3→ *\n     4→ * GET /api/ai/health\n     5→ *\n     6→ * Returns the status of the OpenAI configuration.\n     7→ * Used for diagnostics and debugging.\n     8→ * Protected by dealer context authentication.\n     9→ *\n    10→ * Response:\n    11→ * - ok: boolean - whether AI is configured and ready\n    12→ * - provider: \"openai\" - the AI provider (always OpenAI)\n    13→ * - model: string - the default model used\n    14→ * - hasKey: boolean - whether the key is present\n    15→ * - keyPrefix: string - first 7 chars of the key for verification\n    16→ * - message: string - human-readable status message\n    17→ * - error: string - error code if not ok\n    18→ */\n    19→\n    20→import { withDealerContext } from \"@/libs/authContext\";\n    21→\n    22→async function handler(req, res, ctx) {\n    23→  if (req.method !== \"GET\") {\n    24→    return res.status(405).json({ error: \"Method not allowed\" });\n    25→  }\n    26→\n    27→  const apiKey = process.env.OPENAI_API_KEY;\n    28→  const model = process.env.AI_MODEL || \"gpt-4o-mini\";\n    29→\n    30→  if (!apiKey) {\n    31→    return res.status(200).json({\n    32→      ok: false,\n    33→      provider: \"openai\",\n    34→      model: model,\n    35→      hasKey: false,\n    36→      keyPrefix: null,\n    37→      error: \"MISSING_KEY\",\n    38→      message: \"OpenAI is not configured. Set OPENAI_API_KEY in .env.local and restart the server.\",\n    39→    });\n    40→  }\n    41→\n    42→  // Check key format (should start with sk-)\n    43→  if (!apiKey.startsWith(\"sk-\")) {\n    44→    return res.status(200).json({\n    45→      ok: false,\n    46→      provider: \"openai\",\n    47→      model: model,\n    48→      hasKey: true,\n    49→      keyPrefix: apiKey.slice(0, 7) + \"...\",\n    50→      error: \"INVALID_KEY_FORMAT\",\n    51→      message: \"OPENAI_API_KEY should start with 'sk-'. Check your .env.local file.\",\n    52→    });\n    53→  }\n    54→\n    55→  return res.status(200).json({\n    56→    ok: true,\n    57→    provider: \"openai\",\n    58→    model: model,\n    59→    hasKey: true,\n    60→    keyPrefix: apiKey.slice(0, 7) + \"...\",\n    61→    message: \"OpenAI is configured and ready\",\n    62→  });\n    63→}\n    64→\n    65→export default withDealerContext(handler);\n    66→"}]},"uuid":"f46148b8-e0b8-4ce9-bf02-0d96873f87e3","timestamp":"2025-12-30T15:49:48.760Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\health.js","oldString":"/**\n * AI Health Check Endpoint\n *\n * GET /api/ai/health\n *\n * Returns the status of the OpenAI configuration.\n * Used for diagnostics and debugging.\n *\n * Response:\n * - ok: boolean - whether AI is configured and ready\n * - provider: \"openai\" - the AI provider (always OpenAI)\n * - model: string - the default model used\n * - hasOpenAIKey: boolean - whether the key is present\n * - keyPrefix: string - first 7 chars of the key for verification\n * - message: string - human-readable status message\n * - error: string - error code if not ok\n */\n\nexport default function handler(req, res) {\n  if (req.method !== \"GET\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const apiKey = process.env.OPENAI_API_KEY;\n  const model = process.env.AI_MODEL || \"gpt-4o-mini\";\n\n  if (!apiKey) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasOpenAIKey: false,\n      keyPrefix: null,\n      error: \"missing OPENAI_API_KEY\",\n      message: \"OpenAI is not configured. Set OPENAI_API_KEY in .env.local and restart the server.\",\n    });\n  }\n\n  // Check key format (should start with sk-)\n  if (!apiKey.startsWith(\"sk-\")) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasOpenAIKey: true,\n      keyPrefix: apiKey.slice(0, 7) + \"...\",\n      error: \"invalid OPENAI_API_KEY format\",\n      message: \"OPENAI_API_KEY should start with 'sk-'. Check your .env.local file.\",\n    });\n  }\n\n  return res.status(200).json({\n    ok: true,\n    provider: \"openai\",\n    model: model,\n    hasOpenAIKey: true,\n    keyPrefix: apiKey.slice(0, 7) + \"...\",\n    message: \"OpenAI is configured and ready\",\n  });\n}","newString":"/**\n * AI Health Check Endpoint\n *\n * GET /api/ai/health\n *\n * Returns the status of the OpenAI configuration.\n * Used for diagnostics and debugging.\n * Protected by dealer context authentication.\n *\n * Response:\n * - ok: boolean - whether AI is configured and ready\n * - provider: \"openai\" - the AI provider (always OpenAI)\n * - model: string - the default model used\n * - hasKey: boolean - whether the key is present\n * - keyPrefix: string - first 7 chars of the key for verification\n * - message: string - human-readable status message\n * - error: string - error code if not ok\n */\n\nimport { withDealerContext } from \"@/libs/authContext\";\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"GET\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const apiKey = process.env.OPENAI_API_KEY;\n  const model = process.env.AI_MODEL || \"gpt-4o-mini\";\n\n  if (!apiKey) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasKey: false,\n      keyPrefix: null,\n      error: \"MISSING_KEY\",\n      message: \"OpenAI is not configured. Set OPENAI_API_KEY in .env.local and restart the server.\",\n    });\n  }\n\n  // Check key format (should start with sk-)\n  if (!apiKey.startsWith(\"sk-\")) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasKey: true,\n      keyPrefix: apiKey.slice(0, 7) + \"...\",\n      error: \"INVALID_KEY_FORMAT\",\n      message: \"OPENAI_API_KEY should start with 'sk-'. Check your .env.local file.\",\n    });\n  }\n\n  return res.status(200).json({\n    ok: true,\n    provider: \"openai\",\n    model: model,\n    hasKey: true,\n    keyPrefix: apiKey.slice(0, 7) + \"...\",\n    message: \"OpenAI is configured and ready\",\n  });\n}\n\nexport default withDealerContext(handler);","originalFile":"/**\n * AI Health Check Endpoint\n *\n * GET /api/ai/health\n *\n * Returns the status of the OpenAI configuration.\n * Used for diagnostics and debugging.\n *\n * Response:\n * - ok: boolean - whether AI is configured and ready\n * - provider: \"openai\" - the AI provider (always OpenAI)\n * - model: string - the default model used\n * - hasOpenAIKey: boolean - whether the key is present\n * - keyPrefix: string - first 7 chars of the key for verification\n * - message: string - human-readable status message\n * - error: string - error code if not ok\n */\n\nexport default function handler(req, res) {\n  if (req.method !== \"GET\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const apiKey = process.env.OPENAI_API_KEY;\n  const model = process.env.AI_MODEL || \"gpt-4o-mini\";\n\n  if (!apiKey) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasOpenAIKey: false,\n      keyPrefix: null,\n      error: \"missing OPENAI_API_KEY\",\n      message: \"OpenAI is not configured. Set OPENAI_API_KEY in .env.local and restart the server.\",\n    });\n  }\n\n  // Check key format (should start with sk-)\n  if (!apiKey.startsWith(\"sk-\")) {\n    return res.status(200).json({\n      ok: false,\n      provider: \"openai\",\n      model: model,\n      hasOpenAIKey: true,\n      keyPrefix: apiKey.slice(0, 7) + \"...\",\n      error: \"invalid OPENAI_API_KEY format\",\n      message: \"OPENAI_API_KEY should start with 'sk-'. Check your .env.local file.\",\n    });\n  }\n\n  return res.status(200).json({\n    ok: true,\n    provider: \"openai\",\n    model: model,\n    hasOpenAIKey: true,\n    keyPrefix: apiKey.slice(0, 7) + \"...\",\n    message: \"OpenAI is configured and ready\",\n  });\n}\n","structuredPatch":[{"oldStart":5,"oldLines":18,"newStart":5,"newLines":21,"lines":["  *","  * Returns the status of the OpenAI configuration.","  * Used for diagnostics and debugging.","+ * Protected by dealer context authentication.","  *","  * Response:","  * - ok: boolean - whether AI is configured and ready","  * - provider: \"openai\" - the AI provider (always OpenAI)","  * - model: string - the default model used","- * - hasOpenAIKey: boolean - whether the key is present","+ * - hasKey: boolean - whether the key is present","  * - keyPrefix: string - first 7 chars of the key for verification","  * - message: string - human-readable status message","  * - error: string - error code if not ok","  */"," ","-export default function handler(req, res) {","+import { withDealerContext } from \"@/libs/authContext\";","+","+async function handler(req, res, ctx) {","   if (req.method !== \"GET\") {","     return res.status(405).json({ error: \"Method not allowed\" });","   }"]},{"oldStart":29,"oldLines":9,"newStart":32,"newLines":9,"lines":["       ok: false,","       provider: \"openai\",","       model: model,","-      hasOpenAIKey: false,","+      hasKey: false,","       keyPrefix: null,","-      error: \"missing OPENAI_API_KEY\",","+      error: \"MISSING_KEY\",","       message: \"OpenAI is not configured. Set OPENAI_API_KEY in .env.local and restart the server.\",","     });","   }"]},{"oldStart":42,"oldLines":9,"newStart":45,"newLines":9,"lines":["       ok: false,","       provider: \"openai\",","       model: model,","-      hasOpenAIKey: true,","+      hasKey: true,","       keyPrefix: apiKey.slice(0, 7) + \"...\",","-      error: \"invalid OPENAI_API_KEY format\",","+      error: \"INVALID_KEY_FORMAT\",","       message: \"OPENAI_API_KEY should start with 'sk-'. Check your .env.local file.\",","     });","   }"]},{"oldStart":53,"oldLines":8,"newStart":56,"newLines":10,"lines":["     ok: true,","     provider: \"openai\",","     model: model,","-    hasOpenAIKey: true,","+    hasKey: true,","     keyPrefix: apiKey.slice(0, 7) + \"...\",","     message: \"OpenAI is configured and ready\",","   });"," }","+","+export default withDealerContext(handler);"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"f46148b8-e0b8-4ce9-bf02-0d96873f87e3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WfGSynnrEEmwJZVbqnvPsq","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good. Now I need to update the OpenAI library to have better error handling. Let me also update the callOpenAI function to properly handle different error types including 401/403 and rate limits.","signature":"EuwCCkYICxgCKkCU+FRKvMvA/Lngr7hxU9FlHGxAIbds/jOUPLzZYVfvgErQkK+LxKeZUK0LMu+GAZY9CAK7TSZ6/pvlGHwXparWEgyzEb6/4NglXFybCrEaDCY9q4d0HzIHt68HtCIw6n58uTPaJa6ZJuapSfWtiiKzBiYr2O60GPiXL455pfrO/PiQh1EF3BbRdxgt9T9kKtMBWJYq5Si5Pgg4HlIAih7GnwRqeLbXay5GC6PZDTLhzraw4QqNBU/+ITGsSgU4iUbsYwgVSWZJNGekVo7k6iHKOIKO6sbOMTYk8AwKraa+lXi958W1dJZvk4Tau0t6Uq9mWFAui/E0/jZrJGYPKhmNFGO5JyFZ/qbBgZ39ftZ1gbe9eUnR6gELV3awnRdG0SnGjPmqVxdQibNiSFellh3eUJ/YWZqo+zgFmPR+y28ne1hxEyUSVVu4S4KlDib7qWxWzN5ZSuWx1QDqoGMosqDxPqDKuxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2292,"cache_read_input_tokens":86001,"cache_creation":{"ephemeral_5m_input_tokens":2292,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8sFLCK9SJXBZCNxjMs","type":"assistant","uuid":"fe9143af-7ee5-43ec-9da8-eb62355f93de","timestamp":"2025-12-30T15:49:54.155Z"}
{"parentUuid":"fe9143af-7ee5-43ec-9da8-eb62355f93de","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WfGSynnrEEmwJZVbqnvPsq","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the OpenAI library to have better error handling and clearer error codes:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2292,"cache_read_input_tokens":86001,"cache_creation":{"ephemeral_5m_input_tokens":2292,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8sFLCK9SJXBZCNxjMs","type":"assistant","uuid":"65c44782-9b77-41f3-89e7-09645e0eabe3","timestamp":"2025-12-30T15:49:54.610Z"}
{"parentUuid":"65c44782-9b77-41f3-89e7-09645e0eabe3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WfGSynnrEEmwJZVbqnvPsq","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AmqvTHAX2R24sSodctAr99","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\libs\\openai.js","old_string":"  try {\n    const response = await client.chat.completions.create({\n      model: options.model || \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: options.temperature || 0.3,\n      max_tokens: options.maxTokens || 1500,\n      response_format: { type: \"json_object\" },\n    });\n\n    const content = response.choices?.[0]?.message?.content;\n\n    if (!content) {\n      return {\n        success: false,\n        error: \"Empty AI response\",\n        errorCode: \"EMPTY_RESPONSE\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    // Parse JSON response\n    const parsed = safeJsonParse(content);\n    return {\n      success: true,\n      isDummy: false,\n      data: parsed,\n    };\n  } catch (error) {\n    console.error(\"[OpenAI] Error:\", error.message);\n\n    if (error.status === 401) {\n      return {\n        success: false,\n        error: \"OpenAI authentication failed. Check your API key.\",\n        errorCode: \"AUTH_FAILED\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    return {\n      success: false,\n      error: \"OpenAI service unavailable\",\n      errorCode: \"SERVICE_ERROR\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n}","new_string":"  try {\n    const response = await client.chat.completions.create({\n      model: options.model || \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: options.temperature || 0.3,\n      max_tokens: options.maxTokens || 1500,\n      response_format: { type: \"json_object\" },\n    });\n\n    const content = response.choices?.[0]?.message?.content;\n\n    if (!content) {\n      return {\n        success: false,\n        error: \"Empty AI response\",\n        errorCode: \"EMPTY_RESPONSE\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    // Parse JSON response\n    const parsed = safeJsonParse(content);\n    return {\n      success: true,\n      isDummy: false,\n      data: parsed,\n    };\n  } catch (error) {\n    console.error(\"[OpenAI] Error:\", error.message, error.status);\n\n    // Handle specific OpenAI error types\n    if (error.status === 401) {\n      return {\n        success: false,\n        error: \"OpenAI authentication failed. Check your API key.\",\n        errorCode: \"AUTH_FAILED\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    if (error.status === 429) {\n      return {\n        success: false,\n        error: \"Rate limit exceeded. Please try again in a moment.\",\n        errorCode: \"RATE_LIMIT\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    if (error.status === 500 || error.status === 502 || error.status === 503) {\n      return {\n        success: false,\n        error: \"OpenAI service is temporarily unavailable. Please try again later.\",\n        errorCode: \"SERVICE_UNAVAILABLE\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    if (error.status === 400) {\n      return {\n        success: false,\n        error: \"Invalid request to OpenAI API.\",\n        errorCode: \"BAD_REQUEST\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    return {\n      success: false,\n      error: error.message || \"OpenAI service error\",\n      errorCode: \"SERVICE_ERROR\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2292,"cache_read_input_tokens":86001,"cache_creation":{"ephemeral_5m_input_tokens":2292,"ephemeral_1h_input_tokens":0},"output_tokens":1232,"service_tier":"standard"}},"requestId":"req_011CWd8sFLCK9SJXBZCNxjMs","type":"assistant","uuid":"74f2d74c-f952-4784-9af5-a7726d3405b6","timestamp":"2025-12-30T15:50:11.066Z"}
{"type":"file-history-snapshot","messageId":"74f2d74c-f952-4784-9af5-a7726d3405b6","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"},"libs\\openai.js":{"backupFileName":"a8e7fe417f7ecf06@v1","version":1,"backupTime":"2025-12-30T15:50:12.398Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"74f2d74c-f952-4784-9af5-a7726d3405b6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AmqvTHAX2R24sSodctAr99","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\libs\\openai.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   108→      data: generateDummySuggestions(),\n   109→    };\n   110→  }\n   111→\n   112→  try {\n   113→    const response = await client.chat.completions.create({\n   114→      model: options.model || \"gpt-4o-mini\",\n   115→      messages: [\n   116→        { role: \"system\", content: systemPrompt },\n   117→        { role: \"user\", content: userPrompt },\n   118→      ],\n   119→      temperature: options.temperature || 0.3,\n   120→      max_tokens: options.maxTokens || 1500,\n   121→      response_format: { type: \"json_object\" },\n   122→    });\n   123→\n   124→    const content = response.choices?.[0]?.message?.content;\n   125→\n   126→    if (!content) {\n   127→      return {\n   128→        success: false,\n   129→        error: \"Empty AI response\",\n   130→        errorCode: \"EMPTY_RESPONSE\",\n   131→        isDummy: true,\n   132→        data: generateDummySuggestions(),\n   133→      };\n   134→    }\n   135→\n   136→    // Parse JSON response\n   137→    const parsed = safeJsonParse(content);\n   138→    return {\n   139→      success: true,\n   140→      isDummy: false,\n   141→      data: parsed,\n   142→    };\n   143→  } catch (error) {\n   144→    console.error(\"[OpenAI] Error:\", error.message, error.status);\n   145→\n   146→    // Handle specific OpenAI error types\n   147→    if (error.status === 401) {\n   148→      return {\n   149→        success: false,\n   150→        error: \"OpenAI authentication failed. Check your API key.\",\n   151→        errorCode: \"AUTH_FAILED\",\n   152→        isDummy: true,\n   153→        data: generateDummySuggestions(),\n   154→      };\n   155→    }\n   156→\n   157→    if (error.status === 429) {\n   158→      return {\n   159→        success: false,\n   160→        error: \"Rate limit exceeded. Please try again in a moment.\",\n   161→        errorCode: \"RATE_LIMIT\",\n   162→        isDummy: true,\n   163→        data: generateDummySuggestions(),\n   164→      };\n   165→    }\n   166→\n   167→    if (error.status === 500 || error.status === 502 || error.status === 503) {\n   168→      return {\n   169→        success: false,\n   170→        error: \"OpenAI service is temporarily unavailable. Please try again later.\",\n   171→        errorCode: \"SERVICE_UNAVAILABLE\",\n   172→        isDummy: true,\n   173→        data: generateDummySuggestions(),\n   174→      };\n   175→    }\n   176→\n   177→    if (error.status === 400) {\n   178→      return {\n   179→        success: false,\n   180→        error: \"Invalid request to OpenAI API.\",\n   181→        errorCode: \"BAD_REQUEST\",\n   182→        isDummy: true,\n   183→        data: generateDummySuggestions(),\n   184→      };\n   185→    }\n   186→\n   187→    return {\n   188→      success: false,\n   189→      error: error.message || \"OpenAI service error\",\n   190→      errorCode: \"SERVICE_ERROR\",\n   191→      isDummy: true,\n   192→      data: generateDummySuggestions(),\n   193→    };\n   194→  }\n   195→}\n   196→\n   197→/**\n   198→ * Generate dummy suggestions when AI is not available\n   199→ */"}]},"uuid":"874a2543-ffd5-4dec-b4dd-a3bf74d3856c","timestamp":"2025-12-30T15:50:12.357Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\libs\\openai.js","oldString":"  try {\n    const response = await client.chat.completions.create({\n      model: options.model || \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: options.temperature || 0.3,\n      max_tokens: options.maxTokens || 1500,\n      response_format: { type: \"json_object\" },\n    });\n\n    const content = response.choices?.[0]?.message?.content;\n\n    if (!content) {\n      return {\n        success: false,\n        error: \"Empty AI response\",\n        errorCode: \"EMPTY_RESPONSE\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    // Parse JSON response\n    const parsed = safeJsonParse(content);\n    return {\n      success: true,\n      isDummy: false,\n      data: parsed,\n    };\n  } catch (error) {\n    console.error(\"[OpenAI] Error:\", error.message);\n\n    if (error.status === 401) {\n      return {\n        success: false,\n        error: \"OpenAI authentication failed. Check your API key.\",\n        errorCode: \"AUTH_FAILED\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    return {\n      success: false,\n      error: \"OpenAI service unavailable\",\n      errorCode: \"SERVICE_ERROR\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n}","newString":"  try {\n    const response = await client.chat.completions.create({\n      model: options.model || \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: options.temperature || 0.3,\n      max_tokens: options.maxTokens || 1500,\n      response_format: { type: \"json_object\" },\n    });\n\n    const content = response.choices?.[0]?.message?.content;\n\n    if (!content) {\n      return {\n        success: false,\n        error: \"Empty AI response\",\n        errorCode: \"EMPTY_RESPONSE\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    // Parse JSON response\n    const parsed = safeJsonParse(content);\n    return {\n      success: true,\n      isDummy: false,\n      data: parsed,\n    };\n  } catch (error) {\n    console.error(\"[OpenAI] Error:\", error.message, error.status);\n\n    // Handle specific OpenAI error types\n    if (error.status === 401) {\n      return {\n        success: false,\n        error: \"OpenAI authentication failed. Check your API key.\",\n        errorCode: \"AUTH_FAILED\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    if (error.status === 429) {\n      return {\n        success: false,\n        error: \"Rate limit exceeded. Please try again in a moment.\",\n        errorCode: \"RATE_LIMIT\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    if (error.status === 500 || error.status === 502 || error.status === 503) {\n      return {\n        success: false,\n        error: \"OpenAI service is temporarily unavailable. Please try again later.\",\n        errorCode: \"SERVICE_UNAVAILABLE\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    if (error.status === 400) {\n      return {\n        success: false,\n        error: \"Invalid request to OpenAI API.\",\n        errorCode: \"BAD_REQUEST\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    return {\n      success: false,\n      error: error.message || \"OpenAI service error\",\n      errorCode: \"SERVICE_ERROR\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n}","originalFile":"/**\n * OpenAI Client Helper\n *\n * Server-side only helper for OpenAI API access.\n * Provides a singleton client and helper functions.\n */\n\nimport OpenAI from \"openai\";\n\n// Singleton client - created once and reused\nlet _client = null;\n\n/**\n * Get or create the OpenAI client singleton\n * Always call this function - don't use a top-level export\n * because env vars may not be available at module load time.\n * @returns {OpenAI | null}\n */\nexport function getOpenAIClient() {\n  const apiKey = process.env.OPENAI_API_KEY;\n  if (!apiKey) {\n    console.warn(\"[OpenAI] OPENAI_API_KEY not set - AI features disabled\");\n    return null;\n  }\n  if (!_client) {\n    _client = new OpenAI({\n      apiKey: apiKey,\n    });\n  }\n  return _client;\n}\n\n/**\n * Get the OpenAI API key from environment\n * @returns {{ apiKey: string | null, isConfigured: boolean }}\n */\nexport function getAIConfig() {\n  const apiKey = process.env.OPENAI_API_KEY;\n  return {\n    apiKey,\n    isConfigured: !!apiKey,\n  };\n}\n\n/**\n * Safely parse JSON from AI response\n * Strips code fences if present and throws clear error if parsing fails\n * @param {string} text - Raw text from AI\n * @returns {object} Parsed JSON object\n * @throws {Error} If parsing fails\n */\nexport function safeJsonParse(text) {\n  if (!text) {\n    throw new Error(\"Empty AI response - cannot parse JSON\");\n  }\n\n  // Strip markdown code fences if present\n  const cleaned = text\n    .replace(/```json\\s*/gi, \"\")\n    .replace(/```\\s*/g, \"\")\n    .trim();\n\n  try {\n    return JSON.parse(cleaned);\n  } catch (e) {\n    throw new Error(`Failed to parse AI JSON response: ${e.message}. Raw text: ${cleaned.slice(0, 200)}...`);\n  }\n}\n\n/**\n * Standard AI suggestion response schema\n */\nexport const AI_SUGGESTION_SCHEMA = {\n  suspected_issues: [{ title: \"\", why: \"\", urgency: \"low|med|high\" }],\n  checks_to_run: [{ step: \"\", tools: \"\", time_estimate_mins: 0 }],\n  questions_for_customer: [{ question: \"\", why: \"\" }],\n  parts_to_consider: [{ part: \"\", notes: \"\" }],\n  safety_notes: [{ note: \"\" }],\n};\n\n/**\n * Call OpenAI API with structured JSON output\n * @param {string} systemPrompt - System message for context\n * @param {string} userPrompt - User message with the request\n * @param {object} options - Additional options\n * @returns {Promise<object>} Parsed JSON response\n */\nexport async function callOpenAI(systemPrompt, userPrompt, options = {}) {\n  const { isConfigured } = getAIConfig();\n\n  if (!isConfigured) {\n    return {\n      success: false,\n      error: \"OpenAI not configured. Please set OPENAI_API_KEY in .env.local and restart the server.\",\n      errorCode: \"NOT_CONFIGURED\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n\n  const client = getOpenAIClient();\n  if (!client) {\n    return {\n      success: false,\n      error: \"OpenAI client not available\",\n      errorCode: \"CLIENT_ERROR\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n\n  try {\n    const response = await client.chat.completions.create({\n      model: options.model || \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt },\n      ],\n      temperature: options.temperature || 0.3,\n      max_tokens: options.maxTokens || 1500,\n      response_format: { type: \"json_object\" },\n    });\n\n    const content = response.choices?.[0]?.message?.content;\n\n    if (!content) {\n      return {\n        success: false,\n        error: \"Empty AI response\",\n        errorCode: \"EMPTY_RESPONSE\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    // Parse JSON response\n    const parsed = safeJsonParse(content);\n    return {\n      success: true,\n      isDummy: false,\n      data: parsed,\n    };\n  } catch (error) {\n    console.error(\"[OpenAI] Error:\", error.message);\n\n    if (error.status === 401) {\n      return {\n        success: false,\n        error: \"OpenAI authentication failed. Check your API key.\",\n        errorCode: \"AUTH_FAILED\",\n        isDummy: true,\n        data: generateDummySuggestions(),\n      };\n    }\n\n    return {\n      success: false,\n      error: \"OpenAI service unavailable\",\n      errorCode: \"SERVICE_ERROR\",\n      isDummy: true,\n      data: generateDummySuggestions(),\n    };\n  }\n}\n\n/**\n * Generate dummy suggestions when AI is not available\n */\nfunction generateDummySuggestions() {\n  return {\n    suspected_issues: [\n      {\n        title: \"Unable to generate AI suggestions\",\n        why: \"OpenAI service is not configured or unavailable. Please set OPENAI_API_KEY.\",\n        urgency: \"low\",\n      },\n    ],\n    checks_to_run: [],\n    questions_for_customer: [],\n    parts_to_consider: [],\n    safety_notes: [],\n  };\n}\n\n/**\n * UK used car dealer context for AI prompts\n */\nexport const UK_DEALER_CONTEXT = `You are an expert automotive diagnostic assistant for a UK used car dealership.\nYour role is to help service advisors and technicians diagnose vehicle issues.\n\nImportant constraints:\n- UK context: Use British terminology (bonnet not hood, boot not trunk, etc.)\n- Used car dealer context: Practical, cost-effective advice\n- Practical tone: Clear, actionable guidance\n- DO NOT invent facts or make assumptions without evidence\n- If information is insufficient, ask questions rather than guess\n- Focus on common issues and realistic scenarios\n- Always consider customer safety`;\n","structuredPatch":[{"oldStart":141,"oldLines":8,"newStart":141,"newLines":9,"lines":["       data: parsed,","     };","   } catch (error) {","-    console.error(\"[OpenAI] Error:\", error.message);","+    console.error(\"[OpenAI] Error:\", error.message, error.status);"," ","+    // Handle specific OpenAI error types","     if (error.status === 401) {","       return {","         success: false,"]},{"oldStart":153,"oldLines":9,"newStart":154,"newLines":39,"lines":["       };","     }"," ","+    if (error.status === 429) {","+      return {","+        success: false,","+        error: \"Rate limit exceeded. Please try again in a moment.\",","+        errorCode: \"RATE_LIMIT\",","+        isDummy: true,","+        data: generateDummySuggestions(),","+      };","+    }","+","+    if (error.status === 500 || error.status === 502 || error.status === 503) {","+      return {","+        success: false,","+        error: \"OpenAI service is temporarily unavailable. Please try again later.\",","+        errorCode: \"SERVICE_UNAVAILABLE\",","+        isDummy: true,","+        data: generateDummySuggestions(),","+      };","+    }","+","+    if (error.status === 400) {","+      return {","+        success: false,","+        error: \"Invalid request to OpenAI API.\",","+        errorCode: \"BAD_REQUEST\",","+        isDummy: true,","+        data: generateDummySuggestions(),","+      };","+    }","+","     return {","       success: false,","-      error: \"OpenAI service unavailable\",","+      error: error.message || \"OpenAI service error\",","       errorCode: \"SERVICE_ERROR\",","       isDummy: true,","       data: generateDummySuggestions(),"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"874a2543-ffd5-4dec-b4dd-a3bf74d3856c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Hf5jNpZcpxSTcJqMpAJaQH","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to update the AISuggestionsPanel component to:\n1. Show better error messages based on the error code\n2. Update the styling to use DaisyUI alert styles instead of the current approach\n\nLet me read the full AISuggestionsPanel component to see how it currently handles errors:","signature":"EsEDCkYICxgCKkDA6hKu9FrUXweP2lewbYnWI6uvUGpJfLqDoJUhOTcTBuYxd5z/XXHJ1SLmXaRijhWXzOAP1FzqenQmDzbWosMVEgySddoqjecqzktsrQ0aDCYeBUWSNCc2ki1KACIwB/JPyUuYm7+Xs5WBoUAep/309z9H8HK0aeHvr0uTouIrWdyPkVSRiLVLLOPY5rWMKqgCqdmfUBJ1BVW92chx+fg737ihCmVaZyN2UUqTXDunl25dRqCBN9HXTsWS+AaBB4hShkklc9qCoLYZhSEuPKe5j5/loLBsP6gYaUv/BNQ3dQ7s37TZFdV4h8/KZhS9SmQbGwV27EQsanfQc//7XoH9TA5UoTmYXixBz+ZMMhNAkS2JssQ6CBnOBk/+oEvKmxsbyLpuWamLIbAMb0/76Cl302o6nHPi4s8LekQYFvTkws/hvwi0SXotHgmd0jmKPm4cdxxWefIDqIMhni1EHrCKqUhh1uGanUJxUFTx+3qkB89RQEkAjUA6G1CyEV0bS9XuXeTGrJIp6vsyumjt8zNIhEgs2dCRr4LyEearmegH4ejH8GxyKryVjaSNAil67x7PpSJB++QIHyAYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2270,"cache_read_input_tokens":88293,"cache_creation":{"ephemeral_5m_input_tokens":2270,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8tzmQ9ix1QLqXbYMVy","type":"assistant","uuid":"210def65-eca3-47f1-967f-284e73b95036","timestamp":"2025-12-30T15:50:18.547Z"}
{"parentUuid":"210def65-eca3-47f1-967f-284e73b95036","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Hf5jNpZcpxSTcJqMpAJaQH","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the AISuggestionsPanel component to show better error messages with updated DaisyUI styling:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2270,"cache_read_input_tokens":88293,"cache_creation":{"ephemeral_5m_input_tokens":2270,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8tzmQ9ix1QLqXbYMVy","type":"assistant","uuid":"55ca319c-3f07-4120-9db2-1962ec15041d","timestamp":"2025-12-30T15:50:19.144Z"}
{"parentUuid":"55ca319c-3f07-4120-9db2-1962ec15041d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Hf5jNpZcpxSTcJqMpAJaQH","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AVPUNkd2zLzwvcVWnoPtJF","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js","old_string":"/**\n * AI Suggestions Panel Component\n *\n * Displays AI-generated diagnostic suggestions in a collapsible panel.\n * Shows: suspected issues, checks to run, customer questions, parts, safety notes.\n * Includes \"Copy to notes\" functionality.\n */\n\nimport { useState } from \"react\";\nimport { toast } from \"react-hot-toast\";\n\n// Urgency badge colors\nconst URGENCY_COLORS = {\n  low: \"badge-success\",\n  med: \"badge-warning\",\n  high: \"badge-error\",\n};\n\nconst URGENCY_LABELS = {\n  low: \"Low\",\n  med: \"Medium\",\n  high: \"High\",\n};\n\nexport default function AISuggestionsPanel({\n  suggestions,\n  isLoading,\n  isDummy,\n  onCopyToNotes,\n  className = \"\",\n}) {","new_string":"/**\n * AI Suggestions Panel Component\n *\n * Displays AI-generated diagnostic suggestions in a collapsible panel.\n * Shows: suspected issues, checks to run, customer questions, parts, safety notes.\n * Includes \"Copy to notes\" functionality.\n */\n\nimport { useState } from \"react\";\nimport { toast } from \"react-hot-toast\";\n\n// Urgency badge colors\nconst URGENCY_COLORS = {\n  low: \"badge-success\",\n  med: \"badge-warning\",\n  high: \"badge-error\",\n};\n\nconst URGENCY_LABELS = {\n  low: \"Low\",\n  med: \"Medium\",\n  high: \"High\",\n};\n\n// Error display helper - returns user-friendly message based on error code\nfunction getErrorDisplay(errorCode, errorMessage) {\n  switch (errorCode) {\n    case \"NOT_CONFIGURED\":\n    case \"MISSING_KEY\":\n      return {\n        title: \"AI Not Configured\",\n        message: \"OpenAI API key is not set. Please contact your administrator.\",\n        type: \"warning\",\n      };\n    case \"AUTH_FAILED\":\n    case \"INVALID_KEY_FORMAT\":\n      return {\n        title: \"AI Authentication Error\",\n        message: \"The OpenAI API key is invalid. Please check your configuration.\",\n        type: \"error\",\n      };\n    case \"RATE_LIMIT\":\n      return {\n        title: \"Rate Limit Exceeded\",\n        message: \"Too many requests. Please wait a moment and try again.\",\n        type: \"warning\",\n      };\n    case \"SERVICE_UNAVAILABLE\":\n      return {\n        title: \"AI Service Unavailable\",\n        message: \"OpenAI is temporarily unavailable. Please try again later.\",\n        type: \"warning\",\n      };\n    case \"UNAUTHORIZED\":\n      return {\n        title: \"Not Authorised\",\n        message: \"Please sign in to use AI features.\",\n        type: \"error\",\n      };\n    default:\n      return {\n        title: \"AI Error\",\n        message: errorMessage || \"An error occurred while generating suggestions.\",\n        type: \"error\",\n      };\n  }\n}\n\nexport default function AISuggestionsPanel({\n  suggestions,\n  isLoading,\n  isDummy,\n  errorCode,\n  errorMessage,\n  onCopyToNotes,\n  className = \"\",\n}) {"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2270,"cache_read_input_tokens":88293,"cache_creation":{"ephemeral_5m_input_tokens":2270,"ephemeral_1h_input_tokens":0},"output_tokens":989,"service_tier":"standard"}},"requestId":"req_011CWd8tzmQ9ix1QLqXbYMVy","type":"assistant","uuid":"9e4e6ce8-c710-4963-a8b0-e96afd92b040","timestamp":"2025-12-30T15:50:34.646Z"}
{"type":"file-history-snapshot","messageId":"9e4e6ce8-c710-4963-a8b0-e96afd92b040","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"},"libs\\openai.js":{"backupFileName":"a8e7fe417f7ecf06@v1","version":1,"backupTime":"2025-12-30T15:50:12.398Z"},"components\\AISuggestionsPanel.js":{"backupFileName":"9b357355b418cc6f@v1","version":1,"backupTime":"2025-12-30T15:50:35.851Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"9e4e6ce8-c710-4963-a8b0-e96afd92b040","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AVPUNkd2zLzwvcVWnoPtJF","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→/**\n     2→ * AI Suggestions Panel Component\n     3→ *\n     4→ * Displays AI-generated diagnostic suggestions in a collapsible panel.\n     5→ * Shows: suspected issues, checks to run, customer questions, parts, safety notes.\n     6→ * Includes \"Copy to notes\" functionality.\n     7→ */\n     8→\n     9→import { useState } from \"react\";\n    10→import { toast } from \"react-hot-toast\";\n    11→\n    12→// Urgency badge colors\n    13→const URGENCY_COLORS = {\n    14→  low: \"badge-success\",\n    15→  med: \"badge-warning\",\n    16→  high: \"badge-error\",\n    17→};\n    18→\n    19→const URGENCY_LABELS = {\n    20→  low: \"Low\",\n    21→  med: \"Medium\",\n    22→  high: \"High\",\n    23→};\n    24→\n    25→// Error display helper - returns user-friendly message based on error code\n    26→function getErrorDisplay(errorCode, errorMessage) {\n    27→  switch (errorCode) {\n    28→    case \"NOT_CONFIGURED\":\n    29→    case \"MISSING_KEY\":\n    30→      return {\n    31→        title: \"AI Not Configured\",\n    32→        message: \"OpenAI API key is not set. Please contact your administrator.\",\n    33→        type: \"warning\",\n    34→      };\n    35→    case \"AUTH_FAILED\":\n    36→    case \"INVALID_KEY_FORMAT\":\n    37→      return {\n    38→        title: \"AI Authentication Error\",\n    39→        message: \"The OpenAI API key is invalid. Please check your configuration.\",\n    40→        type: \"error\",\n    41→      };\n    42→    case \"RATE_LIMIT\":\n    43→      return {\n    44→        title: \"Rate Limit Exceeded\",\n    45→        message: \"Too many requests. Please wait a moment and try again.\",\n    46→        type: \"warning\",\n    47→      };\n    48→    case \"SERVICE_UNAVAILABLE\":\n    49→      return {\n    50→        title: \"AI Service Unavailable\",\n    51→        message: \"OpenAI is temporarily unavailable. Please try again later.\",\n    52→        type: \"warning\",\n    53→      };\n    54→    case \"UNAUTHORIZED\":\n    55→      return {\n    56→        title: \"Not Authorised\",\n    57→        message: \"Please sign in to use AI features.\",\n    58→        type: \"error\",\n    59→      };\n    60→    default:\n    61→      return {\n    62→        title: \"AI Error\",\n    63→        message: errorMessage || \"An error occurred while generating suggestions.\",\n    64→        type: \"error\",\n    65→      };\n    66→  }\n    67→}\n    68→\n    69→export default function AISuggestionsPanel({\n    70→  suggestions,\n    71→  isLoading,\n    72→  isDummy,\n    73→  errorCode,\n    74→  errorMessage,\n    75→  onCopyToNotes,\n    76→  className = \"\",\n    77→}) {\n    78→  const [isExpanded, setIsExpanded] = useState(true);\n    79→\n    80→  if (!suggestions && !isLoading) {\n    81→    return null;"}]},"uuid":"0e62aa53-9eec-4944-85bf-9fef49a50aad","timestamp":"2025-12-30T15:50:35.844Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js","oldString":"/**\n * AI Suggestions Panel Component\n *\n * Displays AI-generated diagnostic suggestions in a collapsible panel.\n * Shows: suspected issues, checks to run, customer questions, parts, safety notes.\n * Includes \"Copy to notes\" functionality.\n */\n\nimport { useState } from \"react\";\nimport { toast } from \"react-hot-toast\";\n\n// Urgency badge colors\nconst URGENCY_COLORS = {\n  low: \"badge-success\",\n  med: \"badge-warning\",\n  high: \"badge-error\",\n};\n\nconst URGENCY_LABELS = {\n  low: \"Low\",\n  med: \"Medium\",\n  high: \"High\",\n};\n\nexport default function AISuggestionsPanel({\n  suggestions,\n  isLoading,\n  isDummy,\n  onCopyToNotes,\n  className = \"\",\n}) {","newString":"/**\n * AI Suggestions Panel Component\n *\n * Displays AI-generated diagnostic suggestions in a collapsible panel.\n * Shows: suspected issues, checks to run, customer questions, parts, safety notes.\n * Includes \"Copy to notes\" functionality.\n */\n\nimport { useState } from \"react\";\nimport { toast } from \"react-hot-toast\";\n\n// Urgency badge colors\nconst URGENCY_COLORS = {\n  low: \"badge-success\",\n  med: \"badge-warning\",\n  high: \"badge-error\",\n};\n\nconst URGENCY_LABELS = {\n  low: \"Low\",\n  med: \"Medium\",\n  high: \"High\",\n};\n\n// Error display helper - returns user-friendly message based on error code\nfunction getErrorDisplay(errorCode, errorMessage) {\n  switch (errorCode) {\n    case \"NOT_CONFIGURED\":\n    case \"MISSING_KEY\":\n      return {\n        title: \"AI Not Configured\",\n        message: \"OpenAI API key is not set. Please contact your administrator.\",\n        type: \"warning\",\n      };\n    case \"AUTH_FAILED\":\n    case \"INVALID_KEY_FORMAT\":\n      return {\n        title: \"AI Authentication Error\",\n        message: \"The OpenAI API key is invalid. Please check your configuration.\",\n        type: \"error\",\n      };\n    case \"RATE_LIMIT\":\n      return {\n        title: \"Rate Limit Exceeded\",\n        message: \"Too many requests. Please wait a moment and try again.\",\n        type: \"warning\",\n      };\n    case \"SERVICE_UNAVAILABLE\":\n      return {\n        title: \"AI Service Unavailable\",\n        message: \"OpenAI is temporarily unavailable. Please try again later.\",\n        type: \"warning\",\n      };\n    case \"UNAUTHORIZED\":\n      return {\n        title: \"Not Authorised\",\n        message: \"Please sign in to use AI features.\",\n        type: \"error\",\n      };\n    default:\n      return {\n        title: \"AI Error\",\n        message: errorMessage || \"An error occurred while generating suggestions.\",\n        type: \"error\",\n      };\n  }\n}\n\nexport default function AISuggestionsPanel({\n  suggestions,\n  isLoading,\n  isDummy,\n  errorCode,\n  errorMessage,\n  onCopyToNotes,\n  className = \"\",\n}) {","originalFile":"/**\n * AI Suggestions Panel Component\n *\n * Displays AI-generated diagnostic suggestions in a collapsible panel.\n * Shows: suspected issues, checks to run, customer questions, parts, safety notes.\n * Includes \"Copy to notes\" functionality.\n */\n\nimport { useState } from \"react\";\nimport { toast } from \"react-hot-toast\";\n\n// Urgency badge colors\nconst URGENCY_COLORS = {\n  low: \"badge-success\",\n  med: \"badge-warning\",\n  high: \"badge-error\",\n};\n\nconst URGENCY_LABELS = {\n  low: \"Low\",\n  med: \"Medium\",\n  high: \"High\",\n};\n\nexport default function AISuggestionsPanel({\n  suggestions,\n  isLoading,\n  isDummy,\n  onCopyToNotes,\n  className = \"\",\n}) {\n  const [isExpanded, setIsExpanded] = useState(true);\n\n  if (!suggestions && !isLoading) {\n    return null;\n  }\n\n  const handleCopyToNotes = () => {\n    if (!suggestions) return;\n\n    // Format suggestions as text\n    const lines = [];\n    lines.push(\"=== AI SUGGESTIONS ===\\n\");\n\n    if (suggestions.suspected_issues?.length > 0) {\n      lines.push(\"SUSPECTED ISSUES:\");\n      suggestions.suspected_issues.forEach((issue, i) => {\n        lines.push(`${i + 1}. ${issue.title} [${issue.urgency?.toUpperCase()}]`);\n        if (issue.why) lines.push(`   Why: ${issue.why}`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.checks_to_run?.length > 0) {\n      lines.push(\"CHECKS TO RUN:\");\n      suggestions.checks_to_run.forEach((check, i) => {\n        lines.push(`${i + 1}. ${check.step}`);\n        if (check.tools) lines.push(`   Tools: ${check.tools}`);\n        if (check.time_estimate_mins) lines.push(`   Est. time: ${check.time_estimate_mins} mins`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.questions_for_customer?.length > 0) {\n      lines.push(\"QUESTIONS FOR CUSTOMER:\");\n      suggestions.questions_for_customer.forEach((q, i) => {\n        lines.push(`${i + 1}. ${q.question}`);\n        if (q.why) lines.push(`   Reason: ${q.why}`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.parts_to_consider?.length > 0) {\n      lines.push(\"PARTS TO CONSIDER:\");\n      suggestions.parts_to_consider.forEach((part, i) => {\n        lines.push(`${i + 1}. ${part.part}`);\n        if (part.notes) lines.push(`   Notes: ${part.notes}`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.safety_notes?.length > 0) {\n      lines.push(\"SAFETY NOTES:\");\n      suggestions.safety_notes.forEach((note, i) => {\n        lines.push(`- ${note.note}`);\n      });\n    }\n\n    const text = lines.join(\"\\n\");\n\n    // If callback provided, use it\n    if (onCopyToNotes) {\n      onCopyToNotes(text);\n      toast.success(\"Added to notes\");\n    } else {\n      // Otherwise copy to clipboard\n      navigator.clipboard.writeText(text).then(() => {\n        toast.success(\"Copied to clipboard\");\n      }).catch(() => {\n        toast.error(\"Failed to copy\");\n      });\n    }\n  };\n\n  return (\n    <div className={`bg-base-200 rounded-lg border border-base-300 ${className}`}>\n      {/* Header */}\n      <div\n        className=\"flex items-center justify-between p-3 cursor-pointer hover:bg-base-300/50 rounded-t-lg\"\n        onClick={() => setIsExpanded(!isExpanded)}\n      >\n        <div className=\"flex items-center gap-2\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            className=\"h-5 w-5 text-primary\"\n            viewBox=\"0 0 24 24\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth=\"2\"\n          >\n            <path d=\"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5\" />\n          </svg>\n          <span className=\"font-medium\">AI Suggestions</span>\n          {isDummy && (\n            <span className=\"badge badge-sm badge-ghost\">Demo</span>\n          )}\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {isLoading && (\n            <span className=\"loading loading-spinner loading-sm\"></span>\n          )}\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            className={`h-4 w-4 transition-transform ${isExpanded ? \"rotate-180\" : \"\"}`}\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n          </svg>\n        </div>\n      </div>\n\n      {/* Content */}\n      {isExpanded && (\n        <div className=\"p-3 pt-0 space-y-4\">\n          {isLoading ? (\n            <div className=\"text-center py-4 text-base-content/60\">\n              <span className=\"loading loading-dots loading-md\"></span>\n              <p className=\"mt-2 text-sm\">Analysing...</p>\n            </div>\n          ) : suggestions ? (\n            <>\n              {/* Suspected Issues */}\n              {suggestions.suspected_issues?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-warning\">!</span> Suspected Issues\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {suggestions.suspected_issues.map((issue, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <span className=\"font-medium\">{issue.title}</span>\n                          {issue.urgency && (\n                            <span className={`badge badge-xs ${URGENCY_COLORS[issue.urgency] || \"badge-ghost\"}`}>\n                              {URGENCY_LABELS[issue.urgency] || issue.urgency}\n                            </span>\n                          )}\n                        </div>\n                        {issue.why && (\n                          <p className=\"text-base-content/70 mt-1\">{issue.why}</p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Checks to Run */}\n              {suggestions.checks_to_run?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-info\">&#10003;</span> Checks to Run\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {suggestions.checks_to_run.map((check, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <p className=\"font-medium\">{check.step}</p>\n                        <div className=\"flex gap-4 mt-1 text-xs text-base-content/60\">\n                          {check.tools && <span>Tools: {check.tools}</span>}\n                          {check.time_estimate_mins > 0 && (\n                            <span>~{check.time_estimate_mins} mins</span>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Questions for Customer */}\n              {suggestions.questions_for_customer?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-secondary\">?</span> Questions for Customer\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {suggestions.questions_for_customer.map((q, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <p className=\"font-medium\">{q.question}</p>\n                        {q.why && (\n                          <p className=\"text-base-content/60 text-xs mt-1\">\n                            Why: {q.why}\n                          </p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Parts to Consider */}\n              {suggestions.parts_to_consider?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-accent\">&#9881;</span> Parts to Consider\n                  </h4>\n                  <div className=\"space-y-1\">\n                    {suggestions.parts_to_consider.map((part, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <span className=\"font-medium\">{part.part}</span>\n                        {part.notes && (\n                          <span className=\"text-base-content/60\"> - {part.notes}</span>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Safety Notes */}\n              {suggestions.safety_notes?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-error\">&#9888;</span> Safety Notes\n                  </h4>\n                  <div className=\"bg-error/10 border border-error/20 rounded p-2\">\n                    <ul className=\"text-sm space-y-1\">\n                      {suggestions.safety_notes.map((note, i) => (\n                        <li key={i} className=\"flex items-start gap-2\">\n                          <span className=\"text-error\">&#8226;</span>\n                          <span>{note.note}</span>\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              )}\n\n              {/* Copy to Notes Button */}\n              <div className=\"pt-2 border-t border-base-300\">\n                <button\n                  type=\"button\"\n                  className=\"btn btn-sm btn-ghost gap-2\"\n                  onClick={handleCopyToNotes}\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    className=\"h-4 w-4\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    stroke=\"currentColor\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={2}\n                      d=\"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\"\n                    />\n                  </svg>\n                  Copy to notes\n                </button>\n              </div>\n            </>\n          ) : (\n            <p className=\"text-sm text-base-content/60 text-center py-4\">\n              No suggestions available\n            </p>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","structuredPatch":[{"oldStart":22,"oldLines":10,"newStart":22,"newLines":56,"lines":["   high: \"High\","," };"," ","+// Error display helper - returns user-friendly message based on error code","+function getErrorDisplay(errorCode, errorMessage) {","+  switch (errorCode) {","+    case \"NOT_CONFIGURED\":","+    case \"MISSING_KEY\":","+      return {","+        title: \"AI Not Configured\",","+        message: \"OpenAI API key is not set. Please contact your administrator.\",","+        type: \"warning\",","+      };","+    case \"AUTH_FAILED\":","+    case \"INVALID_KEY_FORMAT\":","+      return {","+        title: \"AI Authentication Error\",","+        message: \"The OpenAI API key is invalid. Please check your configuration.\",","+        type: \"error\",","+      };","+    case \"RATE_LIMIT\":","+      return {","+        title: \"Rate Limit Exceeded\",","+        message: \"Too many requests. Please wait a moment and try again.\",","+        type: \"warning\",","+      };","+    case \"SERVICE_UNAVAILABLE\":","+      return {","+        title: \"AI Service Unavailable\",","+        message: \"OpenAI is temporarily unavailable. Please try again later.\",","+        type: \"warning\",","+      };","+    case \"UNAUTHORIZED\":","+      return {","+        title: \"Not Authorised\",","+        message: \"Please sign in to use AI features.\",","+        type: \"error\",","+      };","+    default:","+      return {","+        title: \"AI Error\",","+        message: errorMessage || \"An error occurred while generating suggestions.\",","+        type: \"error\",","+      };","+  }","+}","+"," export default function AISuggestionsPanel({","   suggestions,","   isLoading,","   isDummy,","+  errorCode,","+  errorMessage,","   onCopyToNotes,","   className = \"\","," }) {"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"0e62aa53-9eec-4944-85bf-9fef49a50aad","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_014d25Hs78LdNq175Uqn1Goj","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to also update the content section of the panel to handle the isDummy case better with proper styling. Let me look at the rest of the component.","signature":"EsQCCkYICxgCKkBbrr1yyEDS+fOR+/61R8bkC2Hydf5WESXUIq8gr6tx0+7RjSmhPeDDjaBzzXuSp1o/4PapA9QquzQQD82hpN9EEgyaiod/j4d6AWLsY2EaDLekvVqxuHGFgYpw7CIwIazlwvafO7/4CQ8RiTmDX9Krkdk5Sq7ZWnEupfDqL+XtyTmVUUwGRgcCc6NVK4/qKqsB0ImU8a2Q2BP/a7SiukXDTkyTMNefBLCfPVrmUNR+OCP5LBW3xnAdifThZgL3dNkg8uH/UibNrggU9JqBe2AAgBKPfmLXLVtvo/8WxLWiinIkfSj1i2oUcyV3O/CtAy0R7VL8wr5v/BRniVwuPd/WPqRSr5Vcx0pf2esnHm3T0kyyCbPBPUEMafJIBkXhV8evOBFJdbKUSDWLfNsMx0iXZDI7RVlBmTBIqO6NGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2093,"cache_read_input_tokens":90563,"cache_creation":{"ephemeral_5m_input_tokens":2093,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8vjbeFCtJnZi88sw1x","type":"assistant","uuid":"ca164106-88a4-4d17-a275-e0f04c858aa4","timestamp":"2025-12-30T15:50:42.129Z"}
{"parentUuid":"ca164106-88a4-4d17-a275-e0f04c858aa4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_014d25Hs78LdNq175Uqn1Goj","type":"message","role":"assistant","content":[{"type":"text","text":"Now I need to add proper error display in the component. Let me read the rest of the component and update it:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2093,"cache_read_input_tokens":90563,"cache_creation":{"ephemeral_5m_input_tokens":2093,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8vjbeFCtJnZi88sw1x","type":"assistant","uuid":"f9221fa1-db66-4d88-bfa6-b3bd086df168","timestamp":"2025-12-30T15:50:42.577Z"}
{"parentUuid":"f9221fa1-db66-4d88-bfa6-b3bd086df168","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_014d25Hs78LdNq175Uqn1Goj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MXJwfXrTn69MCWwvS8hMtq","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js","offset":140,"limit":60}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2093,"cache_read_input_tokens":90563,"cache_creation":{"ephemeral_5m_input_tokens":2093,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8vjbeFCtJnZi88sw1x","type":"assistant","uuid":"eef51e40-dd63-496a-a470-9c25a977de41","timestamp":"2025-12-30T15:50:43.966Z"}
{"parentUuid":"eef51e40-dd63-496a-a470-9c25a977de41","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MXJwfXrTn69MCWwvS8hMtq","type":"tool_result","content":"   140→      toast.success(\"Added to notes\");\n   141→    } else {\n   142→      // Otherwise copy to clipboard\n   143→      navigator.clipboard.writeText(text).then(() => {\n   144→        toast.success(\"Copied to clipboard\");\n   145→      }).catch(() => {\n   146→        toast.error(\"Failed to copy\");\n   147→      });\n   148→    }\n   149→  };\n   150→\n   151→  return (\n   152→    <div className={`bg-base-200 rounded-lg border border-base-300 ${className}`}>\n   153→      {/* Header */}\n   154→      <div\n   155→        className=\"flex items-center justify-between p-3 cursor-pointer hover:bg-base-300/50 rounded-t-lg\"\n   156→        onClick={() => setIsExpanded(!isExpanded)}\n   157→      >\n   158→        <div className=\"flex items-center gap-2\">\n   159→          <svg\n   160→            xmlns=\"http://www.w3.org/2000/svg\"\n   161→            className=\"h-5 w-5 text-primary\"\n   162→            viewBox=\"0 0 24 24\"\n   163→            fill=\"none\"\n   164→            stroke=\"currentColor\"\n   165→            strokeWidth=\"2\"\n   166→          >\n   167→            <path d=\"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5\" />\n   168→          </svg>\n   169→          <span className=\"font-medium\">AI Suggestions</span>\n   170→          {isDummy && (\n   171→            <span className=\"badge badge-sm badge-ghost\">Demo</span>\n   172→          )}\n   173→        </div>\n   174→        <div className=\"flex items-center gap-2\">\n   175→          {isLoading && (\n   176→            <span className=\"loading loading-spinner loading-sm\"></span>\n   177→          )}\n   178→          <svg\n   179→            xmlns=\"http://www.w3.org/2000/svg\"\n   180→            className={`h-4 w-4 transition-transform ${isExpanded ? \"rotate-180\" : \"\"}`}\n   181→            fill=\"none\"\n   182→            viewBox=\"0 0 24 24\"\n   183→            stroke=\"currentColor\"\n   184→          >\n   185→            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n   186→          </svg>\n   187→        </div>\n   188→      </div>\n   189→\n   190→      {/* Content */}\n   191→      {isExpanded && (\n   192→        <div className=\"p-3 pt-0 space-y-4\">\n   193→          {isLoading ? (\n   194→            <div className=\"text-center py-4 text-base-content/60\">\n   195→              <span className=\"loading loading-dots loading-md\"></span>\n   196→              <p className=\"mt-2 text-sm\">Analysing...</p>\n   197→            </div>\n   198→          ) : suggestions ? (\n   199→            <>\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a5ade00a-d5d0-460f-9ca6-396f8d7f0e6f","timestamp":"2025-12-30T15:50:45.428Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js","content":"      toast.success(\"Added to notes\");\n    } else {\n      // Otherwise copy to clipboard\n      navigator.clipboard.writeText(text).then(() => {\n        toast.success(\"Copied to clipboard\");\n      }).catch(() => {\n        toast.error(\"Failed to copy\");\n      });\n    }\n  };\n\n  return (\n    <div className={`bg-base-200 rounded-lg border border-base-300 ${className}`}>\n      {/* Header */}\n      <div\n        className=\"flex items-center justify-between p-3 cursor-pointer hover:bg-base-300/50 rounded-t-lg\"\n        onClick={() => setIsExpanded(!isExpanded)}\n      >\n        <div className=\"flex items-center gap-2\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            className=\"h-5 w-5 text-primary\"\n            viewBox=\"0 0 24 24\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth=\"2\"\n          >\n            <path d=\"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5\" />\n          </svg>\n          <span className=\"font-medium\">AI Suggestions</span>\n          {isDummy && (\n            <span className=\"badge badge-sm badge-ghost\">Demo</span>\n          )}\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {isLoading && (\n            <span className=\"loading loading-spinner loading-sm\"></span>\n          )}\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            className={`h-4 w-4 transition-transform ${isExpanded ? \"rotate-180\" : \"\"}`}\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n          </svg>\n        </div>\n      </div>\n\n      {/* Content */}\n      {isExpanded && (\n        <div className=\"p-3 pt-0 space-y-4\">\n          {isLoading ? (\n            <div className=\"text-center py-4 text-base-content/60\">\n              <span className=\"loading loading-dots loading-md\"></span>\n              <p className=\"mt-2 text-sm\">Analysing...</p>\n            </div>\n          ) : suggestions ? (\n            <>","numLines":60,"startLine":140,"totalLines":342}}}
{"parentUuid":"a5ade00a-d5d0-460f-9ca6-396f8d7f0e6f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RerGinDygLqFuWFWMEzz2z","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to update the content section to properly handle errors with isDummy. Let me update the section where it shows the suggestions to include error handling with proper styling.","signature":"Et0CCkYICxgCKkBGGBlq9lzk5SBi/IGFkKyBc3bWzgcLFJQf9ub9ChgFiZyG5OvvzRPaJQOcDK5fbVp7aQI163SqPTs0taz5gToBEgyEJN4u4Ll1Z41A8yAaDMtKCakm90ZhOWvGsiIwIx4cQrxumtkLjsg+VZNwmyo8hrMgciVCctJsIjK8XDjCwR6kPuk5+ELkjv9KxeAcKsQBDf45465zE6CPqEmKcPWkoahEitXA/KgIbdE0knGfH0r8u4mMaaILfYKr2lJRCJGFsyEbkLCEX504vu4vI0c4jACUycSnG2d5yQcuDKPbcfI20HzdU+UYE6e8Nvmk85O/GKEAfXLmQBFz04+LF6Q+bYNDrbBRZVrfdrUX8+1UtGLiQqvho7v9H1fj7IUJx2wyXFjUnLSh7aUZlTyBIytGWfNo7Cc0Tpgd7BvcYirXMovzIRr8uVlq94L8BZxnqtnoQOTx9BgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1106,"cache_read_input_tokens":92656,"cache_creation":{"ephemeral_5m_input_tokens":1106,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWd8wS4ESN4x9GUstTwqi","type":"assistant","uuid":"ff5f1ec0-6550-4a0e-bd40-7589c6842c8f","timestamp":"2025-12-30T15:50:50.464Z"}
{"parentUuid":"ff5f1ec0-6550-4a0e-bd40-7589c6842c8f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RerGinDygLqFuWFWMEzz2z","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FnsQiw7US9F4k3fdcyRAH6","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js","old_string":"      {/* Content */}\n      {isExpanded && (\n        <div className=\"p-3 pt-0 space-y-4\">\n          {isLoading ? (\n            <div className=\"text-center py-4 text-base-content/60\">\n              <span className=\"loading loading-dots loading-md\"></span>\n              <p className=\"mt-2 text-sm\">Analysing...</p>\n            </div>\n          ) : suggestions ? (\n            <>","new_string":"      {/* Content */}\n      {isExpanded && (\n        <div className=\"p-3 pt-0 space-y-4\">\n          {isLoading ? (\n            <div className=\"text-center py-4 text-base-content/60\">\n              <span className=\"loading loading-dots loading-md\"></span>\n              <p className=\"mt-2 text-sm\">Analysing...</p>\n            </div>\n          ) : isDummy && errorCode ? (\n            // Show error message with proper styling when in dummy mode due to error\n            (() => {\n              const errorDisplay = getErrorDisplay(errorCode, errorMessage);\n              const alertClass = errorDisplay.type === \"error\" ? \"alert-error\" : \"alert-warning\";\n              return (\n                <div className={`alert ${alertClass} shadow-sm`}>\n                  <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                  <div>\n                    <h3 className=\"font-bold text-sm\">{errorDisplay.title}</h3>\n                    <p className=\"text-xs\">{errorDisplay.message}</p>\n                  </div>\n                </div>\n              );\n            })()\n          ) : suggestions ? (\n            <>"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1106,"cache_read_input_tokens":92656,"cache_creation":{"ephemeral_5m_input_tokens":1106,"ephemeral_1h_input_tokens":0},"output_tokens":724,"service_tier":"standard"}},"requestId":"req_011CWd8wS4ESN4x9GUstTwqi","type":"assistant","uuid":"588e086c-7d8e-4506-b936-6ac084e994a5","timestamp":"2025-12-30T15:51:00.030Z"}
{"parentUuid":"588e086c-7d8e-4506-b936-6ac084e994a5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FnsQiw7US9F4k3fdcyRAH6","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   186→          </svg>\n   187→        </div>\n   188→      </div>\n   189→\n   190→      {/* Content */}\n   191→      {isExpanded && (\n   192→        <div className=\"p-3 pt-0 space-y-4\">\n   193→          {isLoading ? (\n   194→            <div className=\"text-center py-4 text-base-content/60\">\n   195→              <span className=\"loading loading-dots loading-md\"></span>\n   196→              <p className=\"mt-2 text-sm\">Analysing...</p>\n   197→            </div>\n   198→          ) : isDummy && errorCode ? (\n   199→            // Show error message with proper styling when in dummy mode due to error\n   200→            (() => {\n   201→              const errorDisplay = getErrorDisplay(errorCode, errorMessage);\n   202→              const alertClass = errorDisplay.type === \"error\" ? \"alert-error\" : \"alert-warning\";\n   203→              return (\n   204→                <div className={`alert ${alertClass} shadow-sm`}>\n   205→                  <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n   206→                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n   207→                  </svg>\n   208→                  <div>\n   209→                    <h3 className=\"font-bold text-sm\">{errorDisplay.title}</h3>\n   210→                    <p className=\"text-xs\">{errorDisplay.message}</p>\n   211→                  </div>\n   212→                </div>\n   213→              );\n   214→            })()\n   215→          ) : suggestions ? (\n   216→            <>\n   217→              {/* Suspected Issues */}\n   218→              {suggestions.suspected_issues?.length > 0 && (\n   219→                <div>\n   220→                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">"}]},"uuid":"74f94515-63c6-4e94-8c62-473479544221","timestamp":"2025-12-30T15:51:01.267Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\components\\AISuggestionsPanel.js","oldString":"      {/* Content */}\n      {isExpanded && (\n        <div className=\"p-3 pt-0 space-y-4\">\n          {isLoading ? (\n            <div className=\"text-center py-4 text-base-content/60\">\n              <span className=\"loading loading-dots loading-md\"></span>\n              <p className=\"mt-2 text-sm\">Analysing...</p>\n            </div>\n          ) : suggestions ? (\n            <>","newString":"      {/* Content */}\n      {isExpanded && (\n        <div className=\"p-3 pt-0 space-y-4\">\n          {isLoading ? (\n            <div className=\"text-center py-4 text-base-content/60\">\n              <span className=\"loading loading-dots loading-md\"></span>\n              <p className=\"mt-2 text-sm\">Analysing...</p>\n            </div>\n          ) : isDummy && errorCode ? (\n            // Show error message with proper styling when in dummy mode due to error\n            (() => {\n              const errorDisplay = getErrorDisplay(errorCode, errorMessage);\n              const alertClass = errorDisplay.type === \"error\" ? \"alert-error\" : \"alert-warning\";\n              return (\n                <div className={`alert ${alertClass} shadow-sm`}>\n                  <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                  </svg>\n                  <div>\n                    <h3 className=\"font-bold text-sm\">{errorDisplay.title}</h3>\n                    <p className=\"text-xs\">{errorDisplay.message}</p>\n                  </div>\n                </div>\n              );\n            })()\n          ) : suggestions ? (\n            <>","originalFile":"/**\n * AI Suggestions Panel Component\n *\n * Displays AI-generated diagnostic suggestions in a collapsible panel.\n * Shows: suspected issues, checks to run, customer questions, parts, safety notes.\n * Includes \"Copy to notes\" functionality.\n */\n\nimport { useState } from \"react\";\nimport { toast } from \"react-hot-toast\";\n\n// Urgency badge colors\nconst URGENCY_COLORS = {\n  low: \"badge-success\",\n  med: \"badge-warning\",\n  high: \"badge-error\",\n};\n\nconst URGENCY_LABELS = {\n  low: \"Low\",\n  med: \"Medium\",\n  high: \"High\",\n};\n\n// Error display helper - returns user-friendly message based on error code\nfunction getErrorDisplay(errorCode, errorMessage) {\n  switch (errorCode) {\n    case \"NOT_CONFIGURED\":\n    case \"MISSING_KEY\":\n      return {\n        title: \"AI Not Configured\",\n        message: \"OpenAI API key is not set. Please contact your administrator.\",\n        type: \"warning\",\n      };\n    case \"AUTH_FAILED\":\n    case \"INVALID_KEY_FORMAT\":\n      return {\n        title: \"AI Authentication Error\",\n        message: \"The OpenAI API key is invalid. Please check your configuration.\",\n        type: \"error\",\n      };\n    case \"RATE_LIMIT\":\n      return {\n        title: \"Rate Limit Exceeded\",\n        message: \"Too many requests. Please wait a moment and try again.\",\n        type: \"warning\",\n      };\n    case \"SERVICE_UNAVAILABLE\":\n      return {\n        title: \"AI Service Unavailable\",\n        message: \"OpenAI is temporarily unavailable. Please try again later.\",\n        type: \"warning\",\n      };\n    case \"UNAUTHORIZED\":\n      return {\n        title: \"Not Authorised\",\n        message: \"Please sign in to use AI features.\",\n        type: \"error\",\n      };\n    default:\n      return {\n        title: \"AI Error\",\n        message: errorMessage || \"An error occurred while generating suggestions.\",\n        type: \"error\",\n      };\n  }\n}\n\nexport default function AISuggestionsPanel({\n  suggestions,\n  isLoading,\n  isDummy,\n  errorCode,\n  errorMessage,\n  onCopyToNotes,\n  className = \"\",\n}) {\n  const [isExpanded, setIsExpanded] = useState(true);\n\n  if (!suggestions && !isLoading) {\n    return null;\n  }\n\n  const handleCopyToNotes = () => {\n    if (!suggestions) return;\n\n    // Format suggestions as text\n    const lines = [];\n    lines.push(\"=== AI SUGGESTIONS ===\\n\");\n\n    if (suggestions.suspected_issues?.length > 0) {\n      lines.push(\"SUSPECTED ISSUES:\");\n      suggestions.suspected_issues.forEach((issue, i) => {\n        lines.push(`${i + 1}. ${issue.title} [${issue.urgency?.toUpperCase()}]`);\n        if (issue.why) lines.push(`   Why: ${issue.why}`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.checks_to_run?.length > 0) {\n      lines.push(\"CHECKS TO RUN:\");\n      suggestions.checks_to_run.forEach((check, i) => {\n        lines.push(`${i + 1}. ${check.step}`);\n        if (check.tools) lines.push(`   Tools: ${check.tools}`);\n        if (check.time_estimate_mins) lines.push(`   Est. time: ${check.time_estimate_mins} mins`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.questions_for_customer?.length > 0) {\n      lines.push(\"QUESTIONS FOR CUSTOMER:\");\n      suggestions.questions_for_customer.forEach((q, i) => {\n        lines.push(`${i + 1}. ${q.question}`);\n        if (q.why) lines.push(`   Reason: ${q.why}`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.parts_to_consider?.length > 0) {\n      lines.push(\"PARTS TO CONSIDER:\");\n      suggestions.parts_to_consider.forEach((part, i) => {\n        lines.push(`${i + 1}. ${part.part}`);\n        if (part.notes) lines.push(`   Notes: ${part.notes}`);\n      });\n      lines.push(\"\");\n    }\n\n    if (suggestions.safety_notes?.length > 0) {\n      lines.push(\"SAFETY NOTES:\");\n      suggestions.safety_notes.forEach((note, i) => {\n        lines.push(`- ${note.note}`);\n      });\n    }\n\n    const text = lines.join(\"\\n\");\n\n    // If callback provided, use it\n    if (onCopyToNotes) {\n      onCopyToNotes(text);\n      toast.success(\"Added to notes\");\n    } else {\n      // Otherwise copy to clipboard\n      navigator.clipboard.writeText(text).then(() => {\n        toast.success(\"Copied to clipboard\");\n      }).catch(() => {\n        toast.error(\"Failed to copy\");\n      });\n    }\n  };\n\n  return (\n    <div className={`bg-base-200 rounded-lg border border-base-300 ${className}`}>\n      {/* Header */}\n      <div\n        className=\"flex items-center justify-between p-3 cursor-pointer hover:bg-base-300/50 rounded-t-lg\"\n        onClick={() => setIsExpanded(!isExpanded)}\n      >\n        <div className=\"flex items-center gap-2\">\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            className=\"h-5 w-5 text-primary\"\n            viewBox=\"0 0 24 24\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth=\"2\"\n          >\n            <path d=\"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5\" />\n          </svg>\n          <span className=\"font-medium\">AI Suggestions</span>\n          {isDummy && (\n            <span className=\"badge badge-sm badge-ghost\">Demo</span>\n          )}\n        </div>\n        <div className=\"flex items-center gap-2\">\n          {isLoading && (\n            <span className=\"loading loading-spinner loading-sm\"></span>\n          )}\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            className={`h-4 w-4 transition-transform ${isExpanded ? \"rotate-180\" : \"\"}`}\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n          </svg>\n        </div>\n      </div>\n\n      {/* Content */}\n      {isExpanded && (\n        <div className=\"p-3 pt-0 space-y-4\">\n          {isLoading ? (\n            <div className=\"text-center py-4 text-base-content/60\">\n              <span className=\"loading loading-dots loading-md\"></span>\n              <p className=\"mt-2 text-sm\">Analysing...</p>\n            </div>\n          ) : suggestions ? (\n            <>\n              {/* Suspected Issues */}\n              {suggestions.suspected_issues?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-warning\">!</span> Suspected Issues\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {suggestions.suspected_issues.map((issue, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <div className=\"flex items-start justify-between gap-2\">\n                          <span className=\"font-medium\">{issue.title}</span>\n                          {issue.urgency && (\n                            <span className={`badge badge-xs ${URGENCY_COLORS[issue.urgency] || \"badge-ghost\"}`}>\n                              {URGENCY_LABELS[issue.urgency] || issue.urgency}\n                            </span>\n                          )}\n                        </div>\n                        {issue.why && (\n                          <p className=\"text-base-content/70 mt-1\">{issue.why}</p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Checks to Run */}\n              {suggestions.checks_to_run?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-info\">&#10003;</span> Checks to Run\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {suggestions.checks_to_run.map((check, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <p className=\"font-medium\">{check.step}</p>\n                        <div className=\"flex gap-4 mt-1 text-xs text-base-content/60\">\n                          {check.tools && <span>Tools: {check.tools}</span>}\n                          {check.time_estimate_mins > 0 && (\n                            <span>~{check.time_estimate_mins} mins</span>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Questions for Customer */}\n              {suggestions.questions_for_customer?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-secondary\">?</span> Questions for Customer\n                  </h4>\n                  <div className=\"space-y-2\">\n                    {suggestions.questions_for_customer.map((q, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <p className=\"font-medium\">{q.question}</p>\n                        {q.why && (\n                          <p className=\"text-base-content/60 text-xs mt-1\">\n                            Why: {q.why}\n                          </p>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Parts to Consider */}\n              {suggestions.parts_to_consider?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-accent\">&#9881;</span> Parts to Consider\n                  </h4>\n                  <div className=\"space-y-1\">\n                    {suggestions.parts_to_consider.map((part, i) => (\n                      <div key={i} className=\"bg-base-100 rounded p-2 text-sm\">\n                        <span className=\"font-medium\">{part.part}</span>\n                        {part.notes && (\n                          <span className=\"text-base-content/60\"> - {part.notes}</span>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Safety Notes */}\n              {suggestions.safety_notes?.length > 0 && (\n                <div>\n                  <h4 className=\"text-sm font-semibold mb-2 flex items-center gap-1\">\n                    <span className=\"text-error\">&#9888;</span> Safety Notes\n                  </h4>\n                  <div className=\"bg-error/10 border border-error/20 rounded p-2\">\n                    <ul className=\"text-sm space-y-1\">\n                      {suggestions.safety_notes.map((note, i) => (\n                        <li key={i} className=\"flex items-start gap-2\">\n                          <span className=\"text-error\">&#8226;</span>\n                          <span>{note.note}</span>\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                </div>\n              )}\n\n              {/* Copy to Notes Button */}\n              <div className=\"pt-2 border-t border-base-300\">\n                <button\n                  type=\"button\"\n                  className=\"btn btn-sm btn-ghost gap-2\"\n                  onClick={handleCopyToNotes}\n                >\n                  <svg\n                    xmlns=\"http://www.w3.org/2000/svg\"\n                    className=\"h-4 w-4\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    stroke=\"currentColor\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={2}\n                      d=\"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\"\n                    />\n                  </svg>\n                  Copy to notes\n                </button>\n              </div>\n            </>\n          ) : (\n            <p className=\"text-sm text-base-content/60 text-center py-4\">\n              No suggestions available\n            </p>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","structuredPatch":[{"oldStart":195,"oldLines":6,"newStart":195,"newLines":23,"lines":["               <span className=\"loading loading-dots loading-md\"></span>","               <p className=\"mt-2 text-sm\">Analysing...</p>","             </div>","+          ) : isDummy && errorCode ? (","+            // Show error message with proper styling when in dummy mode due to error","+            (() => {","+              const errorDisplay = getErrorDisplay(errorCode, errorMessage);","+              const alertClass = errorDisplay.type === \"error\" ? \"alert-error\" : \"alert-warning\";","+              return (","+                <div className={`alert ${alertClass} shadow-sm`}>","+                  <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">","+                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />","+                  </svg>","+                  <div>","+                    <h3 className=\"font-bold text-sm\">{errorDisplay.title}</h3>","+                    <p className=\"text-xs\">{errorDisplay.message}</p>","+                  </div>","+                </div>","+              );","+            })()","           ) : suggestions ? (","             <>","               {/* Suspected Issues */}"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"74f94515-63c6-4e94-8c62-473479544221","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_018etZkphHjiVh5LfRi3UR4j","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to update the warranty.js page to pass the error code and message to the AISuggestionsPanel. Let me look at how it's using the panel currently.","signature":"EsMCCkYICxgCKkDVd7MqvGTwSR4OIgWwnowcxmySOpIxetXIn416AATvNtd7bi75EJh118tkz/FsL98NBWZ+rOwT8AcFiov79GOzEgxlb/fNauqnSjTt8JoaDMpLWs3u9oQq4/RK2CIwNZ3yWSCjk03XcgZG5uW2grQGsRmcXeqzqFCPAVS8t4kmpC9MRQX2xS9iXw0rY9OwKqoBl8sIPeo3pHy+aOkOYWdhU5gSXYjtgKPTgSC7eNLw4aKG/koStojayh0xGUFLTzeO/I1aUuocxo6zZpZXY2dqcQI7zAnW7iCXfV/ywChpgsSZXwuVGL1xc9WVKwb+KPRU6HGLJ4T6gsk8DHUOlTXjStRUqf4EILTEnJj2i8Cyee45yX7BeWnWf6nJt8gOgw1djwm/rGvOk+T0m7aK+GsTOf3QbyxkSdqk0okYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1614,"cache_read_input_tokens":93762,"cache_creation":{"ephemeral_5m_input_tokens":1614,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8xdKv9wGv2eMvcrbcY","type":"assistant","uuid":"725bc723-b941-4e57-9de2-51a14f1485be","timestamp":"2025-12-30T15:51:05.841Z"}
{"parentUuid":"725bc723-b941-4e57-9de2-51a14f1485be","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_018etZkphHjiVh5LfRi3UR4j","type":"message","role":"assistant","content":[{"type":"text","text":"Now I need to update the warranty.js page to pass error code and message to the AISuggestionsPanel:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1614,"cache_read_input_tokens":93762,"cache_creation":{"ephemeral_5m_input_tokens":1614,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8xdKv9wGv2eMvcrbcY","type":"assistant","uuid":"1a7805d9-a9a5-4162-8f80-3e7dc73e8e57","timestamp":"2025-12-30T15:51:06.392Z"}
{"parentUuid":"1a7805d9-a9a5-4162-8f80-3e7dc73e8e57","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_018etZkphHjiVh5LfRi3UR4j","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01BmynBHCxcTvgvcJERbfNKE","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","offset":597,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1614,"cache_read_input_tokens":93762,"cache_creation":{"ephemeral_5m_input_tokens":1614,"ephemeral_1h_input_tokens":0},"output_tokens":173,"service_tier":"standard"}},"requestId":"req_011CWd8xdKv9wGv2eMvcrbcY","type":"assistant","uuid":"206bb8ae-9e01-460c-a2b4-c9c97951b7b6","timestamp":"2025-12-30T15:51:07.510Z"}
{"parentUuid":"206bb8ae-9e01-460c-a2b4-c9c97951b7b6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01BmynBHCxcTvgvcJERbfNKE","type":"tool_result","content":"   597→  // Fetch AI diagnostic suggestions\n   598→  const fetchAIDiagnostics = async () => {\n   599→    if (!selectedCase) return;\n   600→    setIsLoadingDiagnostics(true);\n   601→    setAiDiagnostics(null);\n   602→    try {\n   603→      const vehicle = selectedCase.vehicleId;\n   604→      const res = await fetch(\"/api/ai/warranty-suggestions\", {\n   605→        method: \"POST\",\n   606→        headers: { \"Content-Type\": \"application/json\" },\n   607→        body: JSON.stringify({\n   608→          vehicleMake: vehicle?.make,\n   609→          vehicleModel: vehicle?.model,\n   610→          vehicleYear: vehicle?.year,\n   611→          mileage: vehicle?.mileage,\n   612→          fuelType: vehicle?.fuelType,\n   613→          symptomDescription: selectedCase.summary || selectedCase.details?.description || \"\",\n   614→          faultCodes: selectedCase.details?.faultCodes,\n   615→          warrantyType: selectedCase.warrantyType,\n   616→          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,\n   617→        }),\n   618→      });\n   619→      const data = await res.json();\n   620→      if (data.success) {\n   621→        setAiDiagnostics({\n   622→          suggestions: data.suggestions,\n   623→          isDummy: data.isDummy,\n   624→        });\n   625→      } else {\n   626→        toast.error(data.error || \"Failed to get AI suggestions\");\n   627→      }\n   628→    } catch (error) {\n   629→      console.error(\"AI diagnostics error:\", error);\n   630→      toast.error(\"Failed to get AI suggestions\");\n   631→    } finally {\n   632→      setIsLoadingDiagnostics(false);\n   633→    }\n   634→  };\n   635→\n   636→  const copyToClipboard = (text, label) => {\n   637→    navigator.clipboard.writeText(text);\n   638→    toast.success(`${label} copied to clipboard`);\n   639→  };\n   640→\n   641→  // Filter cases by search query and filters\n   642→  const getFilteredCases = () => {\n   643→    let filtered = cases;\n   644→\n   645→    // Apply search query filter\n   646→    if (searchQuery.trim()) {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a3c17dbb-3561-49ac-a853-49d9d2d4a36f","timestamp":"2025-12-30T15:51:08.970Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","content":"  // Fetch AI diagnostic suggestions\n  const fetchAIDiagnostics = async () => {\n    if (!selectedCase) return;\n    setIsLoadingDiagnostics(true);\n    setAiDiagnostics(null);\n    try {\n      const vehicle = selectedCase.vehicleId;\n      const res = await fetch(\"/api/ai/warranty-suggestions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          vehicleMake: vehicle?.make,\n          vehicleModel: vehicle?.model,\n          vehicleYear: vehicle?.year,\n          mileage: vehicle?.mileage,\n          fuelType: vehicle?.fuelType,\n          symptomDescription: selectedCase.summary || selectedCase.details?.description || \"\",\n          faultCodes: selectedCase.details?.faultCodes,\n          warrantyType: selectedCase.warrantyType,\n          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,\n        }),\n      });\n      const data = await res.json();\n      if (data.success) {\n        setAiDiagnostics({\n          suggestions: data.suggestions,\n          isDummy: data.isDummy,\n        });\n      } else {\n        toast.error(data.error || \"Failed to get AI suggestions\");\n      }\n    } catch (error) {\n      console.error(\"AI diagnostics error:\", error);\n      toast.error(\"Failed to get AI suggestions\");\n    } finally {\n      setIsLoadingDiagnostics(false);\n    }\n  };\n\n  const copyToClipboard = (text, label) => {\n    navigator.clipboard.writeText(text);\n    toast.success(`${label} copied to clipboard`);\n  };\n\n  // Filter cases by search query and filters\n  const getFilteredCases = () => {\n    let filtered = cases;\n\n    // Apply search query filter\n    if (searchQuery.trim()) {","numLines":50,"startLine":597,"totalLines":2718}}}
{"parentUuid":"a3c17dbb-3561-49ac-a853-49d9d2d4a36f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_016yDukwZeWPLJ7xvCPeRAnm","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to update the fetchAIDiagnostics function to handle the error code and message properly, and then also update where the AISuggestionsPanel is used to pass the new props. Let me also check where the API response sets isDummy and message.","signature":"EpwDCkYICxgCKkBChk3rHVIj5JbZs2Bz1NSSp5UlP1pMSMF1wcidGNEfmsR8mPG2Fq1vPpDBoriVw9Aq/OAdyWCdWx2DNGA2oZxdEgxO72xa79rE+cwwLIoaDBWAe8kY9j3Nc0qMJSIwAjwF96V8NPo41NaiS1yjnS+nP6JNzrWXAWevNrKd2XMWmgz1kDRA8THJWaNrR/LxKoMC0muhNe9nT0fxQjvG7UnGNC7zuGkTjI3smfTIhULp8qbITGQimlvYUS9o4W1OXVq/Ji/AQNL7VLOKrxbZKeaK41WbVsUeJ9rsXh+x60JbyekwFAvDMcjCAH05+Orc3YD2WrC/oJ9t/s/28pisR5gdOFPxIS4njDVmDEgZgoD4Zv99mRB3AUZ9aCIZ/ETakcfLCFCdNciKES1sfFW7Ti8VlRlZIrW6vMlhWqN5X+BFwOkvmA8wwtTAVHOgKGJiscFE2uQbrsEf4vUWkWQWfGL5gZnKqp6MxCfzyB3ut+vCE4KfiKV1JQ6HKWHT21U2UN/4Uwxb6HZJkUaQmvxIgiCKAz+fIhgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":904,"cache_read_input_tokens":95376,"cache_creation":{"ephemeral_5m_input_tokens":904,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8yCe8v7CNGMyesmm1b","type":"assistant","uuid":"4f87fcb3-9807-4e87-a576-4d7e2a9634ff","timestamp":"2025-12-30T15:51:16.045Z"}
{"parentUuid":"4f87fcb3-9807-4e87-a576-4d7e2a9634ff","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_016yDukwZeWPLJ7xvCPeRAnm","type":"message","role":"assistant","content":[{"type":"text","text":"Let me update the warranty.js fetchAIDiagnostics function and the AISuggestionsPanel usage:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":904,"cache_read_input_tokens":95376,"cache_creation":{"ephemeral_5m_input_tokens":904,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8yCe8v7CNGMyesmm1b","type":"assistant","uuid":"4c7f1eb0-211d-46d4-953a-e75eda68021c","timestamp":"2025-12-30T15:51:16.462Z"}
{"parentUuid":"4c7f1eb0-211d-46d4-953a-e75eda68021c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_016yDukwZeWPLJ7xvCPeRAnm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Bt8L3gEieiNoAgXLfhY1S3","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","old_string":"  // Fetch AI diagnostic suggestions\n  const fetchAIDiagnostics = async () => {\n    if (!selectedCase) return;\n    setIsLoadingDiagnostics(true);\n    setAiDiagnostics(null);\n    try {\n      const vehicle = selectedCase.vehicleId;\n      const res = await fetch(\"/api/ai/warranty-suggestions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          vehicleMake: vehicle?.make,\n          vehicleModel: vehicle?.model,\n          vehicleYear: vehicle?.year,\n          mileage: vehicle?.mileage,\n          fuelType: vehicle?.fuelType,\n          symptomDescription: selectedCase.summary || selectedCase.details?.description || \"\",\n          faultCodes: selectedCase.details?.faultCodes,\n          warrantyType: selectedCase.warrantyType,\n          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,\n        }),\n      });\n      const data = await res.json();\n      if (data.success) {\n        setAiDiagnostics({\n          suggestions: data.suggestions,\n          isDummy: data.isDummy,\n        });\n      } else {\n        toast.error(data.error || \"Failed to get AI suggestions\");\n      }\n    } catch (error) {\n      console.error(\"AI diagnostics error:\", error);\n      toast.error(\"Failed to get AI suggestions\");\n    } finally {\n      setIsLoadingDiagnostics(false);\n    }\n  };","new_string":"  // Fetch AI diagnostic suggestions\n  const fetchAIDiagnostics = async () => {\n    if (!selectedCase) return;\n    setIsLoadingDiagnostics(true);\n    setAiDiagnostics(null);\n    try {\n      const vehicle = selectedCase.vehicleId;\n      const res = await fetch(\"/api/ai/warranty-suggestions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          vehicleMake: vehicle?.make,\n          vehicleModel: vehicle?.model,\n          vehicleYear: vehicle?.year,\n          mileage: vehicle?.mileage,\n          fuelType: vehicle?.fuelType,\n          symptomDescription: selectedCase.summary || selectedCase.details?.description || \"\",\n          faultCodes: selectedCase.details?.faultCodes,\n          warrantyType: selectedCase.warrantyType,\n          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,\n        }),\n      });\n\n      // Handle auth errors separately\n      if (res.status === 401 || res.status === 403) {\n        setAiDiagnostics({\n          suggestions: null,\n          isDummy: true,\n          errorCode: \"UNAUTHORIZED\",\n          errorMessage: \"Please sign in to use AI features.\",\n        });\n        return;\n      }\n\n      const data = await res.json();\n      if (data.success) {\n        setAiDiagnostics({\n          suggestions: data.suggestions,\n          isDummy: data.isDummy,\n          errorCode: data.isDummy ? \"NOT_CONFIGURED\" : null,\n          errorMessage: data.message,\n        });\n      } else {\n        setAiDiagnostics({\n          suggestions: null,\n          isDummy: true,\n          errorCode: data.errorCode || \"SERVICE_ERROR\",\n          errorMessage: data.error || \"Failed to get AI suggestions\",\n        });\n      }\n    } catch (error) {\n      console.error(\"AI diagnostics error:\", error);\n      setAiDiagnostics({\n        suggestions: null,\n        isDummy: true,\n        errorCode: \"SERVICE_ERROR\",\n        errorMessage: \"Failed to connect to AI service\",\n      });\n    } finally {\n      setIsLoadingDiagnostics(false);\n    }\n  };"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":904,"cache_read_input_tokens":95376,"cache_creation":{"ephemeral_5m_input_tokens":904,"ephemeral_1h_input_tokens":0},"output_tokens":1166,"service_tier":"standard"}},"requestId":"req_011CWd8yCe8v7CNGMyesmm1b","type":"assistant","uuid":"e7b0417d-dbb2-4ce7-a5e6-66dc640e4c92","timestamp":"2025-12-30T15:51:30.359Z"}
{"type":"file-history-snapshot","messageId":"e7b0417d-dbb2-4ce7-a5e6-66dc640e4c92","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"},"libs\\openai.js":{"backupFileName":"a8e7fe417f7ecf06@v1","version":1,"backupTime":"2025-12-30T15:50:12.398Z"},"components\\AISuggestionsPanel.js":{"backupFileName":"9b357355b418cc6f@v1","version":1,"backupTime":"2025-12-30T15:50:35.851Z"},"pages\\warranty.js":{"backupFileName":"a81b4f663f49afea@v1","version":1,"backupTime":"2025-12-30T15:51:31.630Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"e7b0417d-dbb2-4ce7-a5e6-66dc640e4c92","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Bt8L3gEieiNoAgXLfhY1S3","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\warranty.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   593→      setIsGeneratingAI(false);\n   594→    }\n   595→  };\n   596→\n   597→  // Fetch AI diagnostic suggestions\n   598→  const fetchAIDiagnostics = async () => {\n   599→    if (!selectedCase) return;\n   600→    setIsLoadingDiagnostics(true);\n   601→    setAiDiagnostics(null);\n   602→    try {\n   603→      const vehicle = selectedCase.vehicleId;\n   604→      const res = await fetch(\"/api/ai/warranty-suggestions\", {\n   605→        method: \"POST\",\n   606→        headers: { \"Content-Type\": \"application/json\" },\n   607→        body: JSON.stringify({\n   608→          vehicleMake: vehicle?.make,\n   609→          vehicleModel: vehicle?.model,\n   610→          vehicleYear: vehicle?.year,\n   611→          mileage: vehicle?.mileage,\n   612→          fuelType: vehicle?.fuelType,\n   613→          symptomDescription: selectedCase.summary || selectedCase.details?.description || \"\",\n   614→          faultCodes: selectedCase.details?.faultCodes,\n   615→          warrantyType: selectedCase.warrantyType,\n   616→          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,\n   617→        }),\n   618→      });\n   619→\n   620→      // Handle auth errors separately\n   621→      if (res.status === 401 || res.status === 403) {\n   622→        setAiDiagnostics({\n   623→          suggestions: null,\n   624→          isDummy: true,\n   625→          errorCode: \"UNAUTHORIZED\",\n   626→          errorMessage: \"Please sign in to use AI features.\",\n   627→        });\n   628→        return;\n   629→      }\n   630→\n   631→      const data = await res.json();\n   632→      if (data.success) {\n   633→        setAiDiagnostics({\n   634→          suggestions: data.suggestions,\n   635→          isDummy: data.isDummy,\n   636→          errorCode: data.isDummy ? \"NOT_CONFIGURED\" : null,\n   637→          errorMessage: data.message,\n   638→        });\n   639→      } else {\n   640→        setAiDiagnostics({\n   641→          suggestions: null,\n   642→          isDummy: true,\n   643→          errorCode: data.errorCode || \"SERVICE_ERROR\",\n   644→          errorMessage: data.error || \"Failed to get AI suggestions\",\n   645→        });\n   646→      }\n   647→    } catch (error) {\n   648→      console.error(\"AI diagnostics error:\", error);\n   649→      setAiDiagnostics({\n   650→        suggestions: null,\n   651→        isDummy: true,\n   652→        errorCode: \"SERVICE_ERROR\",\n   653→        errorMessage: \"Failed to connect to AI service\",\n   654→      });\n   655→    } finally {\n   656→      setIsLoadingDiagnostics(false);\n   657→    }\n   658→  };\n   659→\n   660→  const copyToClipboard = (text, label) => {\n   661→    navigator.clipboard.writeText(text);\n   662→    toast.success(`${label} copied to clipboard`);"}]},"uuid":"bf72f9bc-faf5-4fa2-9976-19390a89b6be","timestamp":"2025-12-30T15:51:31.622Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","oldString":"  // Fetch AI diagnostic suggestions\n  const fetchAIDiagnostics = async () => {\n    if (!selectedCase) return;\n    setIsLoadingDiagnostics(true);\n    setAiDiagnostics(null);\n    try {\n      const vehicle = selectedCase.vehicleId;\n      const res = await fetch(\"/api/ai/warranty-suggestions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          vehicleMake: vehicle?.make,\n          vehicleModel: vehicle?.model,\n          vehicleYear: vehicle?.year,\n          mileage: vehicle?.mileage,\n          fuelType: vehicle?.fuelType,\n          symptomDescription: selectedCase.summary || selectedCase.details?.description || \"\",\n          faultCodes: selectedCase.details?.faultCodes,\n          warrantyType: selectedCase.warrantyType,\n          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,\n        }),\n      });\n      const data = await res.json();\n      if (data.success) {\n        setAiDiagnostics({\n          suggestions: data.suggestions,\n          isDummy: data.isDummy,\n        });\n      } else {\n        toast.error(data.error || \"Failed to get AI suggestions\");\n      }\n    } catch (error) {\n      console.error(\"AI diagnostics error:\", error);\n      toast.error(\"Failed to get AI suggestions\");\n    } finally {\n      setIsLoadingDiagnostics(false);\n    }\n  };","newString":"  // Fetch AI diagnostic suggestions\n  const fetchAIDiagnostics = async () => {\n    if (!selectedCase) return;\n    setIsLoadingDiagnostics(true);\n    setAiDiagnostics(null);\n    try {\n      const vehicle = selectedCase.vehicleId;\n      const res = await fetch(\"/api/ai/warranty-suggestions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          vehicleMake: vehicle?.make,\n          vehicleModel: vehicle?.model,\n          vehicleYear: vehicle?.year,\n          mileage: vehicle?.mileage,\n          fuelType: vehicle?.fuelType,\n          symptomDescription: selectedCase.summary || selectedCase.details?.description || \"\",\n          faultCodes: selectedCase.details?.faultCodes,\n          warrantyType: selectedCase.warrantyType,\n          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,\n        }),\n      });\n\n      // Handle auth errors separately\n      if (res.status === 401 || res.status === 403) {\n        setAiDiagnostics({\n          suggestions: null,\n          isDummy: true,\n          errorCode: \"UNAUTHORIZED\",\n          errorMessage: \"Please sign in to use AI features.\",\n        });\n        return;\n      }\n\n      const data = await res.json();\n      if (data.success) {\n        setAiDiagnostics({\n          suggestions: data.suggestions,\n          isDummy: data.isDummy,\n          errorCode: data.isDummy ? \"NOT_CONFIGURED\" : null,\n          errorMessage: data.message,\n        });\n      } else {\n        setAiDiagnostics({\n          suggestions: null,\n          isDummy: true,\n          errorCode: data.errorCode || \"SERVICE_ERROR\",\n          errorMessage: data.error || \"Failed to get AI suggestions\",\n        });\n      }\n    } catch (error) {\n      console.error(\"AI diagnostics error:\", error);\n      setAiDiagnostics({\n        suggestions: null,\n        isDummy: true,\n        errorCode: \"SERVICE_ERROR\",\n        errorMessage: \"Failed to connect to AI service\",\n      });\n    } finally {\n      setIsLoadingDiagnostics(false);\n    }\n  };","originalFile":"import { useEffect, useState, useRef } from \"react\";\nimport { useRouter } from \"next/router\";\nimport Head from \"next/head\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport VehicleDrawer from \"@/components/VehicleDrawer\";\nimport AISuggestionsPanel from \"@/components/AISuggestionsPanel\";\nimport { BottomSheet } from \"@/components/ui/BottomSheet\";\nimport { MobileStageSelector } from \"@/components/ui/PageShell\";\nimport { toast } from \"react-hot-toast\";\n\n// Column config matching Sales & Prep style\n// NOTE: Internal keys are legacy names - keep stable for database compatibility\n// Display labels have been updated for clarity\nconst COLUMNS = [\n  { key: \"not_booked_in\", label: \"Not Booked In\", gradient: \"from-red-100/60\", accent: \"border-l-red-400\", accentBg: \"bg-red-400\" },\n  { key: \"on_site\", label: \"Booked In\", gradient: \"from-amber-100/60\", accent: \"border-l-amber-400\", accentBg: \"bg-amber-400\" }, // Legacy key: \"on_site\" displays as \"Booked In\"\n  { key: \"work_complete\", label: \"Work Complete\", gradient: \"from-blue-100/60\", accent: \"border-l-blue-400\", accentBg: \"bg-blue-400\" },\n  { key: \"collected\", label: \"Closed\", gradient: \"from-emerald-100/60\", accent: \"border-l-emerald-400\", accentBg: \"bg-emerald-400\" }, // Legacy key: \"collected\" displays as \"Closed\"\n];\n\nconst PRIORITIES = {\n  low: { bg: \"bg-slate-100\", text: \"text-slate-600\", border: \"border-slate-200\" },\n  normal: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\" },\n  high: { bg: \"bg-amber-50\", text: \"text-amber-700\", border: \"border-amber-100\" },\n  critical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\" },\n};\n\nconst SOURCE_LABELS = {\n  warranty_claim_form: \"Warranty Claim\",\n  low_review: \"Low Review\",\n  complaint_form: \"Complaint\",\n  manual: \"Manual\",\n};\n\n// Timeline event icons\nconst EVENT_ICONS = {\n  CASE_CREATED: \"📋\",\n  SUBMISSION_LINKED: \"🔗\",\n  COMMENT_ADDED: \"💬\",\n  STATUS_CHANGED: \"🔄\",\n  AI_REVIEW_GENERATED: \"🤖\",\n  ATTACHMENT_ADDED: \"📎\",\n  LOCATION_UPDATED: \"📍\",\n  BOOKING_UPDATED: \"📅\",\n  PARTS_UPDATED: \"🔧\",\n  COURTESY_REQUIRED_TOGGLED: \"🚗\",\n  COURTESY_ALLOCATED: \"🚗\",\n  COURTESY_RETURNED: \"🚗\",\n  COURTESY_OUT_RECORDED: \"🚗\",\n  COURTESY_IN_RECORDED: \"🚗\",\n  // Warranty booking auto-move events\n  WARRANTY_BOOKED_IN: \"📅\",\n  WARRANTY_BOOKING_UPDATED: \"📅\",\n  WARRANTY_BOOKING_CANCELLED: \"❌\",\n  WARRANTY_STAGE_MOVED: \"🔀\",\n};\n\n// Timeline grouping constant\nconst STATUS_FLIP_GROUP_WINDOW_MS = 10 * 60 * 1000; // 10 minutes\n\n// Group consecutive STATUS_CHANGED events within the time window\nconst groupTimelineEvents = (events) => {\n  if (!events || events.length === 0) return [];\n\n  const sorted = [...events].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n  const grouped = [];\n  let currentGroup = null;\n\n  for (const event of sorted) {\n    if (event.type === \"STATUS_CHANGED\") {\n      if (currentGroup) {\n        // Check if this event is within the time window of the last event in the group\n        const lastEventTime = new Date(currentGroup.events[currentGroup.events.length - 1].createdAt).getTime();\n        const thisEventTime = new Date(event.createdAt).getTime();\n\n        if (lastEventTime - thisEventTime <= STATUS_FLIP_GROUP_WINDOW_MS) {\n          currentGroup.events.push(event);\n          continue;\n        } else {\n          // Close current group and start new one\n          grouped.push(currentGroup);\n          currentGroup = { isGroup: true, type: \"STATUS_CHANGED_GROUP\", events: [event] };\n        }\n      } else {\n        currentGroup = { isGroup: true, type: \"STATUS_CHANGED_GROUP\", events: [event] };\n      }\n    } else {\n      // Non-status event - close any current group and add this event\n      if (currentGroup) {\n        grouped.push(currentGroup);\n        currentGroup = null;\n      }\n      grouped.push(event);\n    }\n  }\n\n  // Don't forget to add the last group if exists\n  if (currentGroup) {\n    grouped.push(currentGroup);\n  }\n\n  return grouped;\n};\n\n// Repair location type labels\nconst REPAIR_LOCATION_LABELS = {\n  WITH_CUSTOMER: \"With customer\",\n  ON_SITE: \"On-site\",\n  THIRD_PARTY: \"Third-party\",\n};\n\n// Repair location type badge styles\nconst REPAIR_LOCATION_STYLES = {\n  WITH_CUSTOMER: { bg: \"bg-slate-100\", text: \"text-slate-600\" },\n  ON_SITE: { bg: \"bg-emerald-100\", text: \"text-emerald-700\" },\n  THIRD_PARTY: { bg: \"bg-[#14B8A6]/10\", text: \"text-[#14B8A6]\" },\n};\n\n// Format booked date/time for display\nconst formatBookedDate = (date) => {\n  if (!date) return null;\n  const d = new Date(date);\n  return d.toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\" }) +\n    \" \" + d.toLocaleTimeString(\"en-GB\", { hour: \"2-digit\", minute: \"2-digit\" });\n};\n\n// Helper to calculate days since date\nconst daysSince = (date) => {\n  if (!date) return 0;\n  const diff = Date.now() - new Date(date).getTime();\n  return Math.floor(diff / (1000 * 60 * 60 * 24));\n};\n\n// Helper for relative time display\nconst relativeTime = (date) => {\n  const days = daysSince(date);\n  if (days === 0) {\n    const hours = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60 * 60));\n    if (hours === 0) {\n      const mins = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60));\n      return mins <= 1 ? \"Just now\" : `${mins}m ago`;\n    }\n    return `${hours}h ago`;\n  }\n  if (days === 1) return \"Yesterday\";\n  if (days < 7) return `${days}d ago`;\n  if (days < 30) return `${Math.floor(days / 7)}w ago`;\n  return `${Math.floor(days / 30)}mo ago`;\n};\n\nexport default function Warranty() {\n  const router = useRouter();\n  const [cases, setCases] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedCase, setSelectedCase] = useState(null);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [newComment, setNewComment] = useState(\"\");\n  const [commentAttachments, setCommentAttachments] = useState([]);\n  const [isUploadingCaseMedia, setIsUploadingCaseMedia] = useState(false);\n  const [isGeneratingAI, setIsGeneratingAI] = useState(false);\n  const [showRegenerateConfirm, setShowRegenerateConfirm] = useState(false);\n  const [aiDiagnostics, setAiDiagnostics] = useState(null);\n  const [isLoadingDiagnostics, setIsLoadingDiagnostics] = useState(false);\n  const [expandedTimelineGroups, setExpandedTimelineGroups] = useState({});\n  const [isVehicleDrawerOpen, setIsVehicleDrawerOpen] = useState(false);\n  const [selectedVehicleId, setSelectedVehicleId] = useState(null);\n  const fileInputRef = useRef(null);\n\n  // Drag state - matching Sales & Prep\n  const [draggedCard, setDraggedCard] = useState(null);\n  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });\n\n  // Courtesy car state\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [isLoadingCourtesy, setIsLoadingCourtesy] = useState(false);\n\n  // Column sorting state\n  const [columnSortOptions, setColumnSortOptions] = useState({});\n\n  // Search filter state\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  // Filter state (matching stock board style)\n  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);\n  const [showMobileFilters, setShowMobileFilters] = useState(false);\n  const [filters, setFilters] = useState({\n    location: \"all\",      // \"all\" | \"ON_SITE\" | \"THIRD_PARTY\"\n    booked: \"all\",        // \"all\" | \"booked\" | \"not_booked\"\n    partsRequired: \"all\", // \"all\" | \"yes\" | \"no\"\n    priority: \"all\",      // \"all\" | \"low\" | \"normal\" | \"high\" | \"critical\"\n  });\n\n  // Mobile column selection\n  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"not_booked_in\");\n\n  // Job sheet share state\n  const [showJobSheetModal, setShowJobSheetModal] = useState(false);\n  const [jobSheetLink, setJobSheetLink] = useState(null);\n  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);\n\n  useEffect(() => { fetchCases(); }, []);\n\n  // Auto-open case from query param (e.g., /warranty?caseId=123)\n  useEffect(() => {\n    if (router.query.caseId && !selectedCase) {\n      fetchCaseDetail(router.query.caseId);\n    }\n  }, [router.query.caseId]);\n\n  const fetchCases = async () => {\n    try {\n      const res = await fetch(\"/api/aftercare\");\n      // Check for JSON response\n      const contentType = res.headers.get(\"content-type\") || \"\";\n      if (!contentType.includes(\"application/json\")) {\n        console.error(\"[Warranty] Non-JSON response:\", res.status);\n        toast.error(res.status === 401 || res.status === 403 ? \"Session expired - please sign in\" : \"Failed to load cases\");\n        setCases([]);\n        return;\n      }\n      if (!res.ok) {\n        const err = await res.json();\n        toast.error(err.error || \"Failed to load cases\");\n        setCases([]);\n        return;\n      }\n      const data = await res.json();\n      setCases(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"[Warranty] Fetch error:\", error);\n      toast.error(\"Failed to load cases\");\n      setCases([]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const fetchCaseDetail = async (caseId) => {\n    if (!caseId) return; // Guard against undefined/null caseId\n    // Clear AI diagnostics when switching cases\n    setAiDiagnostics(null);\n    try {\n      const res = await fetch(`/api/aftercare/${caseId}`);\n      // Check for JSON response\n      const contentType = res.headers.get(\"content-type\") || \"\";\n      if (!contentType.includes(\"application/json\")) {\n        console.error(\"[Warranty] Case detail non-JSON response:\", res.status);\n        toast.error(\"Failed to load case details\");\n        return;\n      }\n      if (!res.ok) {\n        const err = await res.json();\n        toast.error(err.error || \"Failed to load case\");\n        return;\n      }\n      const data = await res.json();\n      // Normalize id field (API returns _id, we use id internally)\n      setSelectedCase({ ...data, id: data._id || data.id });\n    } catch (error) {\n      console.error(\"[Warranty] Case detail error:\", error);\n      toast.error(\"Failed to load case\");\n    }\n  };\n\n  // Helper function to update case fields with proper error handling\n  const updateCase = async (updates, successMessage) => {\n    const caseId = selectedCase?.id || selectedCase?._id;\n    if (!caseId) return false;\n    try {\n      const res = await fetch(`/api/aftercare/${caseId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to update case\");\n      }\n      // Update local state from response\n      if (data.case) {\n        setSelectedCase({ ...data.case, id: data.case._id || data.case.id });\n        setCases(prev => prev.map(c =>\n          (c.id || c._id) === caseId ? { ...data.case, id: data.case._id || data.case.id } : c\n        ));\n      }\n\n      // Handle auto-move toast messages for booking changes\n      if (data.autoMoved) {\n        const COLUMN_LABELS = {\n          not_booked_in: \"Not Booked In\",\n          on_site: \"Booked In\",\n          work_complete: \"Work Complete\",\n          collected: \"Closed\"\n        };\n        if (data.autoMovedTo === \"on_site\") {\n          toast.success(`Booked in — moved to Booked In`, { duration: 4000 });\n        } else if (data.autoMovedFrom === \"on_site\") {\n          toast.success(`Booking cancelled — moved back to ${COLUMN_LABELS[data.autoMovedTo] || data.autoMovedTo}`, { duration: 4000 });\n        }\n      } else if (successMessage) {\n        toast.success(successMessage);\n      }\n      return data;\n    } catch (error) {\n      toast.error(error.message || \"Failed to update case\");\n      return false;\n    }\n  };\n\n  // Load available courtesy vehicles\n  const loadCourtesyVehicles = async () => {\n    setIsLoadingCourtesy(true);\n    try {\n      const res = await fetch(\"/api/aftercare/courtesy\");\n      const data = await res.json();\n      setCourtesyVehicles(data.available || []);\n    } catch (error) {\n      console.error(\"Error loading courtesy vehicles:\", error);\n    } finally {\n      setIsLoadingCourtesy(false);\n    }\n  };\n\n  // Allocate courtesy vehicle to case\n  const allocateCourtesy = async (courtesyVehicleId, dateDueBack) => {\n    const caseId = selectedCase?.id || selectedCase?._id;\n    if (!caseId || !courtesyVehicleId) return false;\n    try {\n      const res = await fetch(\"/api/aftercare/courtesy\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ caseId, courtesyVehicleId, dateDueBack }),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to allocate courtesy vehicle\");\n      }\n      if (data.case) {\n        setSelectedCase({ ...data.case, id: data.case._id || data.case.id });\n        setCases(prev => prev.map(c =>\n          (c.id || c._id) === caseId ? { ...data.case, id: data.case._id || data.case.id } : c\n        ));\n      }\n      toast.success(\"Courtesy vehicle allocated\");\n      loadCourtesyVehicles(); // Refresh available list\n      return true;\n    } catch (error) {\n      toast.error(error.message || \"Failed to allocate courtesy vehicle\");\n      return false;\n    }\n  };\n\n  // Return courtesy vehicle\n  const returnCourtesy = async () => {\n    const allocationId = selectedCase?.courtesyAllocationId || selectedCase?.courtesyAllocation?._id;\n    if (!allocationId) return false;\n    try {\n      const res = await fetch(\"/api/aftercare/courtesy\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ allocationId }),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to return courtesy vehicle\");\n      }\n      // Refresh case detail\n      fetchCaseDetail(selectedCase.id || selectedCase._id);\n      loadCourtesyVehicles(); // Refresh available list\n      toast.success(\"Courtesy vehicle returned\");\n      return true;\n    } catch (error) {\n      toast.error(error.message || \"Failed to return courtesy vehicle\");\n      return false;\n    }\n  };\n\n  // Generate job sheet share link\n  const handleGenerateJobSheet = async () => {\n    const caseId = selectedCase?.id || selectedCase?._id;\n    if (!caseId) return;\n    setIsGeneratingJobSheet(true);\n    setShowJobSheetModal(true);\n    try {\n      const res = await fetch(`/api/aftercare/${caseId}/job-sheet`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ expiresInDays: 60 }),\n      });\n      const data = await res.json();\n      if (!res.ok) {\n        throw new Error(data.error || \"Failed to generate share link\");\n      }\n      const fullUrl = `${window.location.origin}${data.shareUrl}`;\n      setJobSheetLink(fullUrl);\n      toast.success(\"Job sheet link generated\");\n    } catch (error) {\n      toast.error(error.message || \"Failed to generate share link\");\n      setShowJobSheetModal(false);\n    } finally {\n      setIsGeneratingJobSheet(false);\n    }\n  };\n\n  // Copy job sheet link to clipboard\n  const copyJobSheetLink = () => {\n    if (jobSheetLink) {\n      navigator.clipboard.writeText(jobSheetLink);\n      toast.success(\"Link copied to clipboard\");\n    }\n  };\n\n  // Share job sheet via WhatsApp\n  const shareViaWhatsApp = () => {\n    if (jobSheetLink) {\n      const reg = selectedCase?.regAtPurchase || selectedCase?.currentReg || \"Vehicle\";\n      const text = `Job Sheet for ${reg}: ${jobSheetLink}`;\n      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, \"_blank\");\n    }\n  };\n\n  // Drag handlers - matching Sales & Prep exactly\n  const handleDragStart = (e, caseItem) => {\n    setDraggedCard(caseItem);\n    setDragPosition({ x: e.clientX, y: e.clientY });\n    e.dataTransfer.effectAllowed = \"move\";\n    // Create invisible drag image (we render our own preview)\n    const emptyImg = new Image();\n    emptyImg.src = \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\";\n    e.dataTransfer.setDragImage(emptyImg, 0, 0);\n  };\n\n  const handleDrag = (e) => {\n    if (e.clientX !== 0 && e.clientY !== 0) {\n      setDragPosition({ x: e.clientX, y: e.clientY });\n    }\n  };\n\n  const handleDragOver = (e) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDragEnd = () => {\n    setDraggedCard(null);\n  };\n\n  const handleDrop = async (e, newStatus) => {\n    e.preventDefault();\n    if (!draggedCard || draggedCard.boardStatus === newStatus) {\n      setDraggedCard(null);\n      return;\n    }\n    const caseId = draggedCard.id || draggedCard._id;\n\n    // Optimistic update\n    setCases(prev => prev.map(c =>\n      (c.id || c._id) === caseId ? { ...c, boardStatus: newStatus } : c\n    ));\n\n    try {\n      const res = await fetch(`/api/aftercare/${caseId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ boardStatus: newStatus }),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to update status\");\n      }\n      toast.success(`Moved to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);\n      // Update local state from response\n      if (data.case) {\n        setCases(prev => prev.map(c =>\n          (c.id || c._id) === caseId ? { ...data.case, id: data.case._id || data.case.id } : c\n        ));\n      } else {\n        fetchCases();\n      }\n    } catch (error) {\n      toast.error(error.message || \"Failed to update\");\n      fetchCases(); // Revert on error\n    }\n    setDraggedCard(null);\n  };\n\n  const handleFileSelect = async (e) => {\n    const files = Array.from(e.target.files);\n    if (files.length === 0) return;\n\n    const uploadedFiles = [];\n    for (const file of files) {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      try {\n        const res = await fetch(\"/api/vehicles/upload\", { method: \"POST\", body: formData });\n        const data = await res.json();\n        if (data.url) {\n          uploadedFiles.push({ url: data.url, filename: data.filename || file.name });\n        }\n      } catch (err) {\n        toast.error(`Failed to upload ${file.name}`);\n      }\n    }\n    setCommentAttachments([...commentAttachments, ...uploadedFiles]);\n  };\n\n  // Upload media to case (not comment)\n  const handleCaseMediaUpload = async (e) => {\n    const files = Array.from(e.target.files);\n    if (files.length === 0 || !selectedCase) return;\n\n    setIsUploadingCaseMedia(true);\n    const uploadedFiles = [];\n\n    for (const file of files) {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      try {\n        const res = await fetch(\"/api/vehicles/upload\", { method: \"POST\", body: formData });\n        const data = await res.json();\n        if (data.url) {\n          uploadedFiles.push({ url: data.url, filename: data.filename || file.name });\n        }\n      } catch (err) {\n        toast.error(`Failed to upload ${file.name}`);\n      }\n    }\n\n    if (uploadedFiles.length > 0) {\n      try {\n        await fetch(`/api/aftercare/${selectedCase.id}`, {\n          method: \"PUT\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ _addAttachments: uploadedFiles }),\n        });\n        toast.success(`${uploadedFiles.length} file(s) added to case`);\n        fetchCaseDetail(selectedCase.id);\n      } catch (err) {\n        toast.error(\"Failed to add media to case\");\n      }\n    }\n\n    setIsUploadingCaseMedia(false);\n    // Reset the input\n    e.target.value = \"\";\n  };\n\n  const addComment = async () => {\n    if (!newComment.trim() && commentAttachments.length === 0) return;\n    try {\n      const res = await fetch(`/api/aftercare/${selectedCase.id}/comments`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          content: newComment || \"(attachment)\",\n          authorType: \"staff\",\n          attachments: commentAttachments\n        }),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to add comment\");\n      }\n      setNewComment(\"\");\n      setCommentAttachments([]);\n      // Refetch the case to get updated comments and timeline events\n      fetchCaseDetail(selectedCase.id);\n      toast.success(\"Comment added\");\n    } catch (error) {\n      toast.error(error.message || \"Failed to add comment\");\n    }\n  };\n\n  const generateAIReview = async (regenerate = false) => {\n    if (regenerate) {\n      setShowRegenerateConfirm(false);\n    }\n    setIsGeneratingAI(true);\n    try {\n      const res = await fetch(\"/api/ai/case-review\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ caseId: selectedCase.id }),\n      });\n      const data = await res.json();\n      if (!res.ok) throw new Error(data.error || \"Failed to generate\");\n      fetchCaseDetail(selectedCase.id);\n      toast.success(\"AI review generated\");\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsGeneratingAI(false);\n    }\n  };\n\n  // Fetch AI diagnostic suggestions\n  const fetchAIDiagnostics = async () => {\n    if (!selectedCase) return;\n    setIsLoadingDiagnostics(true);\n    setAiDiagnostics(null);\n    try {\n      const vehicle = selectedCase.vehicleId;\n      const res = await fetch(\"/api/ai/warranty-suggestions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          vehicleMake: vehicle?.make,\n          vehicleModel: vehicle?.model,\n          vehicleYear: vehicle?.year,\n          mileage: vehicle?.mileage,\n          fuelType: vehicle?.fuelType,\n          symptomDescription: selectedCase.summary || selectedCase.details?.description || \"\",\n          faultCodes: selectedCase.details?.faultCodes,\n          warrantyType: selectedCase.warrantyType,\n          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,\n        }),\n      });\n      const data = await res.json();\n      if (data.success) {\n        setAiDiagnostics({\n          suggestions: data.suggestions,\n          isDummy: data.isDummy,\n        });\n      } else {\n        toast.error(data.error || \"Failed to get AI suggestions\");\n      }\n    } catch (error) {\n      console.error(\"AI diagnostics error:\", error);\n      toast.error(\"Failed to get AI suggestions\");\n    } finally {\n      setIsLoadingDiagnostics(false);\n    }\n  };\n\n  const copyToClipboard = (text, label) => {\n    navigator.clipboard.writeText(text);\n    toast.success(`${label} copied to clipboard`);\n  };\n\n  // Filter cases by search query and filters\n  const getFilteredCases = () => {\n    let filtered = cases;\n\n    // Apply search query filter\n    if (searchQuery.trim()) {\n      const query = searchQuery.toUpperCase().replace(/\\s/g, \"\");\n      filtered = filtered.filter(c => {\n        // Search by VRM\n        const regAtPurchase = (c.regAtPurchase || \"\").toUpperCase().replace(/\\s/g, \"\");\n        const currentReg = (c.currentReg || \"\").toUpperCase().replace(/\\s/g, \"\");\n        const detailsReg = (c.details?.vehicleReg || \"\").toUpperCase().replace(/\\s/g, \"\");\n        // Search by customer name\n        const customerName = (c.contactId?.name || \"\").toUpperCase();\n        return regAtPurchase.includes(query) ||\n               currentReg.includes(query) ||\n               detailsReg.includes(query) ||\n               customerName.includes(query);\n      });\n    }\n\n    // Apply location filter\n    if (filters.location !== \"all\") {\n      filtered = filtered.filter(c => (c.repairLocationType || \"WITH_CUSTOMER\") === filters.location);\n    }\n\n    // Apply booked filter\n    if (filters.booked === \"booked\") {\n      filtered = filtered.filter(c => c.bookedInAt);\n    } else if (filters.booked === \"not_booked\") {\n      filtered = filtered.filter(c => !c.bookedInAt);\n    }\n\n    // Apply parts required filter\n    if (filters.partsRequired === \"yes\") {\n      filtered = filtered.filter(c => c.partsRequired === true);\n    } else if (filters.partsRequired === \"no\") {\n      filtered = filtered.filter(c => !c.partsRequired);\n    }\n\n    // Apply priority filter\n    if (filters.priority !== \"all\") {\n      filtered = filtered.filter(c => (c.priority || \"normal\") === filters.priority);\n    }\n\n    return filtered;\n  };\n\n  // Check if any filters are active\n  const hasActiveFilters = () => {\n    return filters.location !== \"all\" ||\n           filters.booked !== \"all\" ||\n           filters.partsRequired !== \"all\" ||\n           filters.priority !== \"all\";\n  };\n\n  // Clear all filters\n  const clearFilters = () => {\n    setFilters({\n      location: \"all\",\n      booked: \"all\",\n      partsRequired: \"all\",\n      priority: \"all\",\n    });\n  };\n\n  // Get cases by status with sorting\n  const getCasesByStatus = (status) => {\n    const filteredBySearch = getFilteredCases();\n    const filtered = filteredBySearch.filter(c => c.boardStatus === status);\n    const sortOption = columnSortOptions[status] || \"oldest_first\";\n\n    return filtered.sort((a, b) => {\n      if (sortOption === \"newest_first\") {\n        return new Date(b.createdAt) - new Date(a.createdAt);\n      }\n      if (sortOption === \"alphabetical\") {\n        const nameA = a.contactId?.name || \"\";\n        const nameB = b.contactId?.name || \"\";\n        return nameA.localeCompare(nameB);\n      }\n      // oldest_first (default)\n      return new Date(a.createdAt) - new Date(b.createdAt);\n    });\n  };\n\n  // Calculate attachment count for a case\n  const getAttachmentCount = (c) => {\n    const caseAttachments = c.attachments?.length || 0;\n    const submissionAttachments = c.submissionAttachmentCount || 0;\n    const commentAttachments = c.commentAttachmentCount || 0;\n    return caseAttachments + submissionAttachments + commentAttachments;\n  };\n\n  // Get activity count (events count)\n  const getActivityCount = (c) => c.events?.length || 0;\n\n  return (\n    <DashboardLayout>\n      <Head><title>Aftersales/Warranty | DealerFlow</title></Head>\n\n      {/* Hero Header - Modern gradient design */}\n      <div className=\"relative rounded-2xl overflow-hidden mb-6 bg-gradient-to-br from-[#0066CC]/[0.06] via-[#14B8A6]/[0.04] to-[#0EA5E9]/[0.03] border border-slate-100/50\">\n        <div className=\"relative px-6 py-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\n          <div>\n            <div className=\"flex items-center gap-3 mb-2\">\n              <div className=\"w-10 h-10 rounded-xl bg-[#0066CC] flex items-center justify-center shadow-md shadow-[#0066CC]/25\">\n                <svg className=\"w-5 h-5 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z\" />\n                </svg>\n              </div>\n              <h1 className=\"text-2xl md:text-3xl font-bold text-slate-900\">Aftersales / Warranty</h1>\n            </div>\n            <p className=\"text-slate-500 text-sm md:text-base\">Manage warranty cases and aftercare</p>\n          </div>\n          <button\n            className=\"flex items-center justify-center gap-2 px-5 py-2.5 bg-[#0066CC] hover:bg-[#0055AA] text-white font-medium rounded-xl shadow-md shadow-[#0066CC]/25 hover:shadow-lg transition-all\"\n            onClick={() => setShowAddModal(true)}\n          >\n            <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n            </svg>\n            New Case\n          </button>\n        </div>\n      </div>\n\n      {/* Search & Filters Bar */}\n      <div className=\"mb-6 flex flex-col sm:flex-row gap-3\">\n        <div className=\"relative flex-1 max-w-md\">\n          <svg className=\"absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n          </svg>\n          <input\n            type=\"text\"\n            placeholder=\"Search by VRM or customer name...\"\n            className=\"w-full pl-10 pr-10 py-2.5 bg-white border border-slate-200 rounded-xl text-sm placeholder:text-slate-400 focus:border-[#0066CC] focus:ring-2 focus:ring-[#0066CC]/20 outline-none transition-all\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n          />\n          {searchQuery && (\n            <button\n              className=\"absolute right-3.5 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors\"\n              onClick={() => setSearchQuery(\"\")}\n            >\n              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          )}\n        </div>\n\n        {/* Filter Button - Mobile opens BottomSheet, Desktop opens dropdown */}\n        <div className=\"relative\">\n          {/* Mobile Filter Button */}\n          <button\n            className={`md:hidden flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all ${\n              hasActiveFilters()\n                ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                : \"bg-white border border-slate-200 text-slate-600 hover:border-[#0066CC] hover:text-[#0066CC]\"\n            }`}\n            onClick={() => setShowMobileFilters(true)}\n          >\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\" />\n            </svg>\n            Filters\n            {hasActiveFilters() && (\n              <span className={`inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold ${\n                hasActiveFilters() ? \"bg-white/20 text-white\" : \"bg-slate-200 text-slate-600\"\n              }`}>\n                {Object.values(filters).filter(v => v !== \"all\").length}\n              </span>\n            )}\n          </button>\n\n          {/* Desktop Filter Button */}\n          <button\n            className={`hidden md:flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all ${\n              hasActiveFilters()\n                ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                : \"bg-white border border-slate-200 text-slate-600 hover:border-[#0066CC] hover:text-[#0066CC]\"\n            }`}\n            onClick={() => setShowFiltersDropdown(!showFiltersDropdown)}\n          >\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\" />\n            </svg>\n            Filters\n            {hasActiveFilters() && (\n              <span className={`inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold ${\n                hasActiveFilters() ? \"bg-white/20 text-white\" : \"bg-slate-200 text-slate-600\"\n              }`}>\n                {Object.values(filters).filter(v => v !== \"all\").length}\n              </span>\n            )}\n          </button>\n\n          {/* Desktop Filter Dropdown */}\n          {showFiltersDropdown && (\n            <div className=\"hidden md:block absolute z-30 mt-2 w-72 bg-white border border-slate-200 rounded-xl shadow-lg p-4\">\n              <div className=\"flex justify-between items-center mb-3\">\n                <h4 className=\"font-semibold text-sm\">Filters</h4>\n                {hasActiveFilters() && (\n                  <button className=\"btn btn-ghost btn-xs\" onClick={clearFilters}>\n                    Clear all\n                  </button>\n                )}\n              </div>\n\n              <div className=\"space-y-3\">\n                {/* Location Filter */}\n                <div className=\"form-control\">\n                  <label className=\"label label-text text-xs py-0\">Location</label>\n                  <select\n                    className=\"select select-bordered select-sm w-full\"\n                    value={filters.location}\n                    onChange={(e) => setFilters({ ...filters, location: e.target.value })}\n                  >\n                    <option value=\"all\">All</option>\n                    <option value=\"WITH_CUSTOMER\">With customer</option>\n                    <option value=\"ON_SITE\">On-site</option>\n                    <option value=\"THIRD_PARTY\">Third-party</option>\n                  </select>\n                </div>\n\n                {/* Booked Filter */}\n                <div className=\"form-control\">\n                  <label className=\"label label-text text-xs py-0\">Booked Status</label>\n                  <select\n                    className=\"select select-bordered select-sm w-full\"\n                    value={filters.booked}\n                    onChange={(e) => setFilters({ ...filters, booked: e.target.value })}\n                  >\n                    <option value=\"all\">All</option>\n                    <option value=\"booked\">Booked</option>\n                    <option value=\"not_booked\">Not Booked</option>\n                  </select>\n                </div>\n\n                {/* Parts Required Filter */}\n                <div className=\"form-control\">\n                  <label className=\"label label-text text-xs py-0\">Parts Required</label>\n                  <select\n                    className=\"select select-bordered select-sm w-full\"\n                    value={filters.partsRequired}\n                    onChange={(e) => setFilters({ ...filters, partsRequired: e.target.value })}\n                  >\n                    <option value=\"all\">All</option>\n                    <option value=\"yes\">Yes</option>\n                    <option value=\"no\">No</option>\n                  </select>\n                </div>\n\n                {/* Priority Filter */}\n                <div className=\"form-control\">\n                  <label className=\"label label-text text-xs py-0\">Priority</label>\n                  <select\n                    className=\"select select-bordered select-sm w-full\"\n                    value={filters.priority}\n                    onChange={(e) => setFilters({ ...filters, priority: e.target.value })}\n                  >\n                    <option value=\"all\">All</option>\n                    <option value=\"low\">Low</option>\n                    <option value=\"normal\">Normal</option>\n                    <option value=\"high\">High</option>\n                    <option value=\"critical\">Critical</option>\n                  </select>\n                </div>\n              </div>\n\n              <button\n                className=\"btn btn-sm btn-block mt-4\"\n                onClick={() => setShowFiltersDropdown(false)}\n              >\n                Apply\n              </button>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Mobile Filters BottomSheet */}\n      <BottomSheet\n        isOpen={showMobileFilters}\n        onClose={() => setShowMobileFilters(false)}\n        title=\"Filters\"\n        footer={\n          <div className=\"flex gap-2\">\n            {hasActiveFilters() && (\n              <button\n                className=\"btn btn-ghost flex-1\"\n                onClick={() => {\n                  clearFilters();\n                  setShowMobileFilters(false);\n                }}\n              >\n                Clear All\n              </button>\n            )}\n            <button\n              className=\"btn btn-primary flex-1\"\n              onClick={() => setShowMobileFilters(false)}\n            >\n              Apply Filters\n            </button>\n          </div>\n        }\n      >\n        <div className=\"space-y-4\">\n          {/* Location Filter */}\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text font-medium\">Location</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              value={filters.location}\n              onChange={(e) => setFilters({ ...filters, location: e.target.value })}\n            >\n              <option value=\"all\">All Locations</option>\n              <option value=\"WITH_CUSTOMER\">With customer</option>\n              <option value=\"ON_SITE\">On-site</option>\n              <option value=\"THIRD_PARTY\">Third-party</option>\n            </select>\n          </div>\n\n          {/* Booked Filter */}\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text font-medium\">Booked Status</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              value={filters.booked}\n              onChange={(e) => setFilters({ ...filters, booked: e.target.value })}\n            >\n              <option value=\"all\">All</option>\n              <option value=\"booked\">Booked</option>\n              <option value=\"not_booked\">Not Booked</option>\n            </select>\n          </div>\n\n          {/* Parts Required Filter */}\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text font-medium\">Parts Required</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              value={filters.partsRequired}\n              onChange={(e) => setFilters({ ...filters, partsRequired: e.target.value })}\n            >\n              <option value=\"all\">All</option>\n              <option value=\"yes\">Yes</option>\n              <option value=\"no\">No</option>\n            </select>\n          </div>\n\n          {/* Priority Filter */}\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text font-medium\">Priority</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              value={filters.priority}\n              onChange={(e) => setFilters({ ...filters, priority: e.target.value })}\n            >\n              <option value=\"all\">All Priorities</option>\n              <option value=\"low\">Low</option>\n              <option value=\"normal\">Normal</option>\n              <option value=\"high\">High</option>\n              <option value=\"critical\">Critical</option>\n            </select>\n          </div>\n        </div>\n      </BottomSheet>\n\n      {/* Active filters / result count summary */}\n      {(searchQuery || hasActiveFilters()) && (\n        <div className=\"mb-4\">\n          <p className=\"text-sm text-slate-500\">\n            Showing {getFilteredCases().length} of {cases.length} cases\n            {hasActiveFilters() && (\n              <button className=\"ml-2 text-primary hover:underline\" onClick={clearFilters}>\n                Clear filters\n              </button>\n            )}\n          </p>\n        </div>\n      )}\n\n      {isLoading ? (\n        <div className=\"flex justify-center py-20\">\n          <span className=\"loading loading-spinner loading-lg\"></span>\n        </div>\n      ) : (\n        <>\n          {/* Mobile Column Selector */}\n          <MobileStageSelector\n            stages={COLUMNS.map((col) => ({\n              value: col.key,\n              label: col.label,\n              count: getCasesByStatus(col.key).length,\n            }))}\n            activeStage={mobileActiveColumn}\n            onStageChange={setMobileActiveColumn}\n            className=\"mb-4\"\n          />\n\n          {/* Mobile Single Column View */}\n          <div className=\"md:hidden\">\n            {COLUMNS.filter(col => col.key === mobileActiveColumn).map((col) => {\n              const columnCases = getCasesByStatus(col.key);\n              return (\n                <div key={col.key} className=\"space-y-3\">\n                  {columnCases.map((caseItem) => {\n                    const daysOpen = daysSince(caseItem.createdAt);\n                    const priority = caseItem.priority || \"normal\";\n                    const priorityStyle = PRIORITIES[priority] || PRIORITIES.normal;\n                    const locationType = caseItem.repairLocationType || \"WITH_CUSTOMER\";\n                    const locationStyle = REPAIR_LOCATION_STYLES[locationType] || REPAIR_LOCATION_STYLES.WITH_CUSTOMER;\n                    const attachmentCount = (caseItem.submissionAttachmentCount || 0) + (caseItem.commentAttachmentCount || 0);\n                    const activityCount = (caseItem.comments?.length || 0) + (caseItem.events?.length || 0);\n\n                    return (\n                      <div\n                        key={caseItem.id || caseItem._id}\n                        className=\"bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100/50 overflow-hidden active:scale-[0.98]\"\n                        onClick={() => {\n                          const id = caseItem.id || caseItem._id;\n                          fetchCaseDetail(id);\n                        }}\n                      >\n                        <div className={`border-l-4 ${col.accent}`}>\n                          <div className=\"p-4\">\n                            {/* Top row: Reg + badges */}\n                            <div className=\"flex justify-between items-start mb-2\">\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-1.5 flex-wrap\">\n                                  <span className=\"inline-block bg-[#fcd34d] border border-yellow-500/50 rounded-md px-2 py-0.5 shadow-sm font-mono font-bold text-slate-900 text-xs tracking-wider uppercase\">\n                                    {caseItem.regAtPurchase || caseItem.details?.vehicleReg || \"NO REG\"}\n                                  </span>\n                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold ${locationStyle.bg} ${locationStyle.text}`}>\n                                    {REPAIR_LOCATION_LABELS[locationType]}\n                                  </span>\n                                  <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${priorityStyle.bg} ${priorityStyle.text} border ${priorityStyle.border}`}>\n                                    {priority.charAt(0).toUpperCase() + priority.slice(1)}\n                                  </span>\n                                </div>\n                              </div>\n                            </div>\n\n                            {/* Customer name + Vehicle make/model */}\n                            <div className=\"mb-2\">\n                              <p className=\"font-semibold text-slate-900 text-sm truncate\">\n                                {caseItem.contactId?.name || \"Unknown\"}\n                              </p>\n                              {caseItem.vehicleId && (\n                                <p className=\"text-xs text-slate-500\">\n                                  {caseItem.vehicleId.make} {caseItem.vehicleId.model}\n                                </p>\n                              )}\n                            </div>\n\n                            {/* Booked date row */}\n                            {caseItem.bookedInAt && (\n                              <div className=\"flex items-center gap-1 mb-1.5 text-xs text-amber-700\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n                                </svg>\n                                <span className=\"font-medium\">Booked: {formatBookedDate(caseItem.bookedInAt)}</span>\n                              </div>\n                            )}\n\n                            {/* Courtesy badge row */}\n                            {(caseItem.courtesyRequired || caseItem.courtesyAllocationId) && (\n                              <div className=\"flex items-center gap-1 mb-1.5 text-xs\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                {caseItem.courtesyAllocationId ? (\n                                  <span className=\"font-medium text-emerald-700\">\n                                    Courtesy: {caseItem.courtesyAllocation?.courtesyVehicle?.regCurrent || \"Allocated\"}\n                                  </span>\n                                ) : (\n                                  <span className=\"font-medium text-amber-600\">Courtesy needed</span>\n                                )}\n                              </div>\n                            )}\n\n                            {/* Footer row: Days open + icons */}\n                            <div className=\"flex items-center justify-between text-xs text-slate-500\">\n                              <span className=\"font-medium\">{daysOpen}d open</span>\n                              <div className=\"flex items-center gap-2\">\n                                {caseItem.partsRequired && (\n                                  <span className=\"flex items-center gap-0.5 text-orange-600\" title=\"Parts Required\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                    </svg>\n                                  </span>\n                                )}\n                                {attachmentCount > 0 && (\n                                  <span className=\"flex items-center gap-0.5\" title=\"Attachments\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13\" />\n                                    </svg>\n                                    {attachmentCount}\n                                  </span>\n                                )}\n                                {activityCount > 0 && (\n                                  <span className=\"flex items-center gap-0.5\" title=\"Activity\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\n                                    </svg>\n                                    {activityCount}\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                  {columnCases.length === 0 && (\n                    <div className=\"text-center py-12 text-slate-400\">\n                      <p className=\"text-sm\">No cases in {col.label}</p>\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Mobile Floating Action Button */}\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"md:hidden fixed fab-safe right-4 z-40 w-14 h-14 bg-[#0066CC] hover:bg-[#0055AA] text-white rounded-2xl shadow-lg shadow-[#0066CC]/30 flex items-center justify-center transition-all active:scale-95\"\n          >\n            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n            </svg>\n          </button>\n\n          {/* Desktop Multi-Column View - Matching Sales & Prep exactly */}\n          <div className=\"hidden md:flex gap-4 overflow-x-auto pb-6\">\n            {COLUMNS.map((col) => {\n              const columnCases = getCasesByStatus(col.key);\n              return (\n                <div\n                  key={col.key}\n                  data-column-key={col.key}\n                  className={`flex-shrink-0 w-64 bg-gradient-to-b ${col.gradient} to-transparent rounded-2xl p-3 min-h-[400px]`}\n                  onDragOver={handleDragOver}\n                  onDrop={(e) => handleDrop(e, col.key)}\n                >\n                  {/* Integrated Header - Same as Sales & Prep */}\n                  <div className=\"flex items-center justify-between mb-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <h3 className=\"font-semibold text-slate-700 text-sm\">\n                        {col.label}\n                      </h3>\n                      <span className=\"bg-slate-900/10 text-slate-700 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center\">\n                        {columnCases.length}\n                      </span>\n                    </div>\n                    <div className=\"dropdown dropdown-end\">\n                      <label tabIndex={0} className=\"btn btn-ghost btn-xs gap-1 bg-white/30 backdrop-blur-sm hover:bg-white/50 rounded-full\">\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12\" />\n                        </svg>\n                        <span className=\"text-xs\">\n                          {columnSortOptions[col.key] === \"newest_first\" ? \"Newest\" :\n                           columnSortOptions[col.key] === \"alphabetical\" ? \"A-Z\" : \"Oldest\"}\n                        </span>\n                      </label>\n                      <ul tabIndex={0} className=\"dropdown-content z-30 menu p-2 shadow-lg bg-white rounded-xl w-44 mt-2\">\n                        <li>\n                          <button\n                            className={`rounded-lg ${columnSortOptions[col.key] === \"oldest_first\" || !columnSortOptions[col.key] ? \"active bg-slate-100\" : \"\"}`}\n                            onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"oldest_first\" }))}\n                          >\n                            Oldest First\n                          </button>\n                        </li>\n                        <li>\n                          <button\n                            className={`rounded-lg ${columnSortOptions[col.key] === \"newest_first\" ? \"active bg-slate-100\" : \"\"}`}\n                            onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"newest_first\" }))}\n                          >\n                            Newest First\n                          </button>\n                        </li>\n                        <li>\n                          <button\n                            className={`rounded-lg ${columnSortOptions[col.key] === \"alphabetical\" ? \"active bg-slate-100\" : \"\"}`}\n                            onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"alphabetical\" }))}\n                          >\n                            Alphabetical (Name)\n                          </button>\n                        </li>\n                      </ul>\n                    </div>\n                  </div>\n\n                  {/* Cards Container */}\n                  <div className=\"space-y-3\">\n                    {columnCases.map((caseItem) => {\n                      const daysOpen = daysSince(caseItem.createdAt);\n                      const attachmentCount = getAttachmentCount(caseItem);\n                      const activityCount = getActivityCount(caseItem);\n                      // Default priority to \"normal\" if missing\n                      const priority = caseItem.priority || \"normal\";\n                      const priorityStyle = PRIORITIES[priority] || PRIORITIES.normal;\n                      // Default location to WITH_CUSTOMER if missing (vehicle starts with customer)\n                      const locationType = caseItem.repairLocationType || \"WITH_CUSTOMER\";\n                      const locationStyle = REPAIR_LOCATION_STYLES[locationType] || REPAIR_LOCATION_STYLES.WITH_CUSTOMER;\n\n                      return (\n                        <div\n                          key={caseItem.id || caseItem._id}\n                          draggable\n                          onDragStart={(e) => handleDragStart(e, caseItem)}\n                          onDrag={handleDrag}\n                          onDragEnd={handleDragEnd}\n                          className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all cursor-grab active:cursor-grabbing border border-slate-100/50 overflow-hidden ${(draggedCard?.id || draggedCard?._id) === (caseItem.id || caseItem._id) ? \"opacity-40 scale-95\" : \"opacity-100\"}`}\n                          onClick={() => fetchCaseDetail(caseItem.id || caseItem._id)}\n                        >\n                          <div className=\"p-3\">\n                            {/* Top row: Reg + badges */}\n                            <div className=\"flex justify-between items-start mb-2\">\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-1.5 flex-wrap\">\n                                  <span className=\"inline-block bg-[#fcd34d] border border-yellow-500/50 rounded-md px-2 py-0.5 shadow-sm font-mono font-bold text-slate-900 text-xs tracking-wider uppercase\">\n                                    {caseItem.regAtPurchase || caseItem.details?.vehicleReg || \"NO REG\"}\n                                  </span>\n                                  {/* Location badge - always shown */}\n                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold ${locationStyle.bg} ${locationStyle.text}`}>\n                                    {REPAIR_LOCATION_LABELS[locationType]}\n                                  </span>\n                                  {/* Warranty type badge */}\n                                  {caseItem.warrantyType && (\n                                    <span className=\"inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold bg-[#0066CC]/10 text-[#0066CC]\">\n                                      {caseItem.warrantyType === \"Dealer Warranty\" ? \"Dealer\" : \"External\"}\n                                    </span>\n                                  )}\n                                </div>\n                              </div>\n                              {/* Priority badge */}\n                              <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${priorityStyle.bg} ${priorityStyle.text} border ${priorityStyle.border}`}>\n                                {priority.charAt(0).toUpperCase() + priority.slice(1)}\n                              </span>\n                            </div>\n\n                            {/* Customer name + Vehicle make/model */}\n                            <div className=\"mb-2\">\n                              <p className=\"font-semibold text-slate-900 text-sm truncate\">\n                                {caseItem.contactId?.name || \"Unknown\"}\n                              </p>\n                              {caseItem.vehicleId && (\n                                <p className=\"text-xs text-slate-500\">\n                                  {caseItem.vehicleId.make} {caseItem.vehicleId.model}\n                                </p>\n                              )}\n                              {!caseItem.vehicleId && caseItem.details?.make && (\n                                <p className=\"text-xs text-slate-500\">\n                                  {caseItem.details.make} {caseItem.details.model}\n                                </p>\n                              )}\n                            </div>\n\n                            {/* Booked date row - shown if bookedInAt exists */}\n                            {caseItem.bookedInAt && (\n                              <div className=\"flex items-center gap-1 mb-1.5 text-xs text-amber-700\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n                                </svg>\n                                <span className=\"font-medium\">Booked: {formatBookedDate(caseItem.bookedInAt)}</span>\n                              </div>\n                            )}\n\n                            {/* Courtesy badge row - shown if courtesyRequired or has allocation */}\n                            {(caseItem.courtesyRequired || caseItem.courtesyAllocationId) && (\n                              <div className=\"flex items-center gap-1 mb-1.5 text-xs\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                {caseItem.courtesyAllocationId ? (\n                                  <span className=\"font-medium text-emerald-700\">\n                                    Courtesy: {caseItem.courtesyAllocation?.courtesyVehicle?.regCurrent || \"Allocated\"}\n                                  </span>\n                                ) : (\n                                  <span className=\"font-medium text-amber-600\">Courtesy needed</span>\n                                )}\n                              </div>\n                            )}\n\n                            {/* Footer row: Days open + icons + source */}\n                            <div className=\"flex items-center justify-between text-xs text-slate-500\">\n                              <span className=\"font-medium\">{daysOpen}d open</span>\n                              <div className=\"flex items-center gap-2\">\n                                {caseItem.partsRequired && (\n                                  <span className=\"flex items-center gap-0.5 text-orange-600\" title=\"Parts Required\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                    </svg>\n                                    Parts\n                                  </span>\n                                )}\n                                {attachmentCount > 0 && (\n                                  <span className=\"flex items-center gap-0.5\" title=\"Attachments\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13\" />\n                                    </svg>\n                                    {attachmentCount}\n                                  </span>\n                                )}\n                                {activityCount > 0 && (\n                                  <span className=\"flex items-center gap-0.5\" title=\"Activity\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\n                                    </svg>\n                                    {activityCount}\n                                  </span>\n                                )}\n                                {caseItem.source === \"warranty_claim_form\" && (\n                                  <span className=\"inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-medium bg-slate-100 text-slate-600\">\n                                    Warranty Claim\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      );\n                    })}\n\n                    {columnCases.length === 0 && (\n                      <div className=\"text-center py-12 text-slate-400\">\n                        <p className=\"text-sm\">No cases in {col.label}</p>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Drag Preview - floating card that follows cursor (same as Sales & Prep) */}\n          {draggedCard && (\n            <div\n              className=\"fixed pointer-events-none z-50\"\n              style={{\n                left: dragPosition.x - 120,\n                top: dragPosition.y - 30,\n                transform: \"rotate(3deg)\",\n              }}\n            >\n              <div className=\"bg-white rounded-xl shadow-2xl border-2 border-blue-400 w-60 p-3 opacity-90\">\n                <div className=\"flex items-center gap-2\">\n                  <p className=\"font-bold text-slate-900 text-sm truncate\">\n                    {draggedCard.contactId?.name || \"Unknown\"}\n                  </p>\n                </div>\n                <span className=\"inline-block bg-[#fcd34d] border border-yellow-500/50 rounded-md px-2 py-0.5 shadow-sm font-mono font-bold text-slate-900 text-xs tracking-wider uppercase mt-1\">\n                  {draggedCard.regAtPurchase || draggedCard.details?.vehicleReg || \"NO REG\"}\n                </span>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n\n      {/* Case Detail Drawer */}\n      {selectedCase && (\n        <div className=\"fixed inset-0 z-50 flex justify-end\">\n          <div className=\"bg-black/40 absolute inset-0 backdrop-blur-sm\" onClick={() => setSelectedCase(null)}></div>\n          <div className=\"relative bg-white w-full max-w-xl h-full overflow-y-auto shadow-2xl\">\n            {/* Modern Sticky Header */}\n            <div className=\"sticky top-0 bg-white/95 backdrop-blur-md border-b border-slate-200 px-5 py-4 z-10\">\n              <div className=\"flex justify-between items-start gap-3\">\n                {/* Back button on mobile */}\n                <button className=\"md:hidden p-2 -ml-2 rounded-lg hover:bg-slate-100 transition-colors\" onClick={() => setSelectedCase(null)}>\n                  <svg className=\"w-5 h-5 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <div className=\"flex-1 min-w-0\">\n                  {/* VRM + Status Pills Row */}\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <span className=\"inline-flex items-center bg-amber-100 border border-amber-300 rounded-lg px-3 py-1.5 font-mono font-bold text-slate-900 text-base tracking-wider uppercase shadow-sm\">\n                      {selectedCase.regAtPurchase || selectedCase.details?.vehicleReg || \"NO REG\"}\n                    </span>\n                    {selectedCase.warrantyType && (\n                      <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 border border-slate-200\">\n                        {selectedCase.warrantyType}\n                      </span>\n                    )}\n                    <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold capitalize ${PRIORITIES[selectedCase.priority]?.bg} ${PRIORITIES[selectedCase.priority]?.text} ${PRIORITIES[selectedCase.priority]?.border} border`}>\n                      {selectedCase.priority}\n                    </span>\n                  </div>\n                  <p className=\"text-sm text-slate-500 mt-1.5 truncate\">\n                    {selectedCase.contactId?.name || \"Unknown\"} &middot; {daysSince(selectedCase.createdAt)}d open\n                  </p>\n                </div>\n                <div className=\"hidden md:flex items-center gap-1.5\">\n                  <button\n                    onClick={handleGenerateJobSheet}\n                    className=\"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors\"\n                    title=\"Share Job Sheet\"\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z\" />\n                    </svg>\n                    Share\n                  </button>\n                  <button\n                    className=\"p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors\"\n                    onClick={() => setSelectedCase(null)}\n                  >\n                    <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                    </svg>\n                  </button>\n                </div>\n              </div>\n\n              {/* Status Segmented Control */}\n              <div className=\"flex gap-2 mt-4\">\n                <div className=\"flex-1 bg-slate-100 rounded-lg p-1 flex\">\n                  {COLUMNS.map(c => (\n                    <button\n                      key={c.key}\n                      onClick={async () => {\n                        if (selectedCase.boardStatus !== c.key) {\n                          await updateCase(\n                            { boardStatus: c.key },\n                            `Moved to ${c.label}`\n                          );\n                        }\n                      }}\n                      className={`flex-1 px-2 py-1.5 text-xs font-medium rounded-md transition-all ${\n                        selectedCase.boardStatus === c.key\n                          ? \"bg-white text-slate-900 shadow-sm\"\n                          : \"text-slate-500 hover:text-slate-700\"\n                      }`}\n                    >\n                      {c.label}\n                    </button>\n                  ))}\n                </div>\n                <div className=\"bg-slate-100 rounded-lg p-1 flex\">\n                  {[\"low\", \"normal\", \"high\", \"critical\"].map(p => (\n                    <button\n                      key={p}\n                      onClick={async () => {\n                        if (selectedCase.priority !== p) {\n                          await updateCase({ priority: p }, \"Priority updated\");\n                        }\n                      }}\n                      className={`px-2 py-1.5 text-xs font-medium rounded-md capitalize transition-all ${\n                        selectedCase.priority === p\n                          ? `${PRIORITIES[p]?.bg} ${PRIORITIES[p]?.text} shadow-sm`\n                          : \"text-slate-400 hover:text-slate-600\"\n                      }`}\n                    >\n                      {p === \"critical\" ? \"!\" : p.charAt(0).toUpperCase()}\n                    </button>\n                  ))}\n                </div>\n              </div>\n            </div>\n\n            <div className=\"px-5 py-4 space-y-4\">\n              {/* Customer & Vehicle Section */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Customer & Vehicle</h3>\n                </div>\n                <div className=\"p-4\">\n                  <div className=\"grid grid-cols-2 gap-x-4 gap-y-3 text-sm\">\n                    <div>\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Name</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.contactId?.name || \"—\"}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Phone</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.contactId?.phone || \"—\"}</p>\n                    </div>\n                    <div className=\"col-span-2\">\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Email</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.contactId?.email || \"—\"}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Reg at Purchase</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.regAtPurchase || \"—\"}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Current Reg</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.currentReg || selectedCase.details?.vehicleReg || \"—\"}</p>\n                    </div>\n                    {selectedCase.vehicleId && (\n                      <>\n                        <div className=\"col-span-2\">\n                          <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Vehicle</span>\n                          <p className=\"text-slate-900 mt-0.5\">\n                            {selectedCase.vehicleId.make} {selectedCase.vehicleId.model} {selectedCase.vehicleId.year}\n                          </p>\n                        </div>\n                        <div className=\"col-span-2 pt-1\">\n                          <button\n                            className=\"inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-[#0066CC] bg-[#0066CC]/5 hover:bg-[#0066CC]/10 border border-[#0066CC]/20 rounded-lg transition-colors\"\n                            onClick={() => {\n                              setSelectedVehicleId(selectedCase.vehicleId._id || selectedCase.vehicleId.id);\n                              setIsVehicleDrawerOpen(true);\n                            }}\n                          >\n                            <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\n                            </svg>\n                            View Vehicle\n                          </button>\n                        </div>\n                      </>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Repair Location Section */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Repair Location</h3>\n                  <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${REPAIR_LOCATION_STYLES[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]?.bg} ${REPAIR_LOCATION_STYLES[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]?.text}`}>\n                    {REPAIR_LOCATION_LABELS[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]}\n                  </span>\n                </div>\n                <div className=\"p-4 space-y-4\">\n                  {/* Location Type Segmented Control */}\n                  <div>\n                    <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-2 block\">Location Type</label>\n                    <div className=\"bg-slate-100 rounded-lg p-1 flex\">\n                      {[\n                        { key: \"WITH_CUSTOMER\", label: \"With Customer\", icon: \"🏠\" },\n                        { key: \"ON_SITE\", label: \"On-site\", icon: \"🏢\" },\n                        { key: \"THIRD_PARTY\", label: \"Third-party\", icon: \"🔧\" },\n                      ].map(loc => (\n                        <button\n                          key={loc.key}\n                          onClick={async () => {\n                            if ((selectedCase.repairLocationType || \"WITH_CUSTOMER\") !== loc.key) {\n                              const oldValue = selectedCase.repairLocationType || \"WITH_CUSTOMER\";\n                              await updateCase({\n                                repairLocationType: loc.key,\n                                _eventType: \"LOCATION_UPDATED\",\n                                _eventMetadata: { fromLocation: oldValue, toLocation: loc.key }\n                              }, \"Repair location updated\");\n                            }\n                          }}\n                          className={`flex-1 px-2 py-2 text-xs font-medium rounded-md transition-all flex items-center justify-center gap-1 ${\n                            (selectedCase.repairLocationType || \"WITH_CUSTOMER\") === loc.key\n                              ? `${REPAIR_LOCATION_STYLES[loc.key]?.bg} ${REPAIR_LOCATION_STYLES[loc.key]?.text} shadow-sm`\n                              : \"text-slate-500 hover:text-slate-700\"\n                          }`}\n                        >\n                          <span>{loc.icon}</span>\n                          <span className=\"hidden sm:inline\">{loc.label}</span>\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n\n                  {/* Show additional fields for third-party repairs */}\n                  {selectedCase.repairLocationType === \"THIRD_PARTY\" && (\n                    <div className=\"space-y-3 pt-2 border-t border-slate-100\">\n                      <div>\n                        <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Garage Name</label>\n                        <input\n                          type=\"text\"\n                          className=\"w-full px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm\"\n                          value={selectedCase.repairLocationName || \"\"}\n                          placeholder=\"e.g., ABC Motors\"\n                          onChange={(e) => setSelectedCase({ ...selectedCase, repairLocationName: e.target.value })}\n                          onBlur={() => updateCase({ repairLocationName: selectedCase.repairLocationName })}\n                        />\n                      </div>\n\n                      <div>\n                        <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Notes</label>\n                        <textarea\n                          className=\"w-full px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm resize-none\"\n                          rows={2}\n                          value={selectedCase.repairLocationNotes || \"\"}\n                          placeholder=\"Any notes about the repair location...\"\n                          onChange={(e) => setSelectedCase({ ...selectedCase, repairLocationNotes: e.target.value })}\n                          onBlur={() => updateCase({ repairLocationNotes: selectedCase.repairLocationNotes })}\n                        />\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* Booking Section - Accent Styled */}\n              <div className={`rounded-xl border-2 shadow-sm overflow-hidden ${\n                selectedCase.bookedInAt\n                  ? \"bg-emerald-50/50 border-emerald-200\"\n                  : \"bg-amber-50/50 border-amber-200\"\n              }`}>\n                <div className={`px-4 py-3 flex items-center justify-between ${\n                  selectedCase.bookedInAt\n                    ? \"bg-emerald-100/50 border-b border-emerald-200\"\n                    : \"bg-amber-100/50 border-b border-amber-200\"\n                }`}>\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-lg\">{selectedCase.bookedInAt ? \"📅\" : \"⏳\"}</span>\n                    <h3 className=\"text-sm font-semibold text-slate-900\">Booking</h3>\n                  </div>\n                  {selectedCase.bookedInAt ? (\n                    <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700 border border-emerald-200\">\n                      {formatBookedDate(selectedCase.bookedInAt)}\n                    </span>\n                  ) : (\n                    <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700 border border-amber-200\">\n                      Not Booked\n                    </span>\n                  )}\n                </div>\n                <div className=\"p-4\">\n                  <div>\n                    <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Booked Date & Time</label>\n                    <input\n                      type=\"datetime-local\"\n                      className={`w-full px-3 py-2.5 rounded-lg text-slate-900 transition-all outline-none text-sm font-medium ${\n                        selectedCase.bookedInAt\n                          ? \"bg-white border border-emerald-200 focus:ring-2 focus:ring-emerald-500\"\n                          : \"bg-white border border-amber-200 focus:ring-2 focus:ring-amber-500\"\n                      }`}\n                      value={selectedCase.bookedInAt ? new Date(selectedCase.bookedInAt).toISOString().slice(0, 16) : \"\"}\n                      onChange={async (e) => {\n                        const newValue = e.target.value ? new Date(e.target.value).toISOString() : null;\n                        const oldValue = selectedCase.bookedInAt || null;\n                        await updateCase({\n                          bookedInAt: newValue,\n                          _eventType: \"BOOKING_UPDATED\",\n                          _eventMetadata: { oldBookedAt: oldValue, newBookedAt: newValue }\n                        }, newValue ? \"Booking updated\" : null);\n                      }}\n                    />\n                    {selectedCase.bookedInAt && (\n                      <button\n                        className=\"inline-flex items-center gap-1 mt-2 px-2 py-1 text-xs font-medium text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors\"\n                        onClick={async () => {\n                          const oldValue = selectedCase.bookedInAt;\n                          await updateCase({\n                            bookedInAt: null,\n                            _eventType: \"BOOKING_UPDATED\",\n                            _eventMetadata: { oldBookedAt: oldValue, newBookedAt: null }\n                          }, \"Booking cleared\");\n                        }}\n                      >\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                        Clear booking\n                      </button>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Parts Required Section */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Parts</h3>\n                  {selectedCase.partsRequired && (\n                    <span className=\"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-700\">\n                      Required\n                    </span>\n                  )}\n                </div>\n                <div className=\"p-4 space-y-3\">\n                  <label className=\"flex items-center gap-3 cursor-pointer group\">\n                    <div className=\"relative\">\n                      <input\n                        type=\"checkbox\"\n                        className=\"sr-only peer\"\n                        checked={selectedCase.partsRequired || false}\n                        onChange={async (e) => {\n                          const newValue = e.target.checked;\n                          const oldValue = selectedCase.partsRequired || false;\n                          await updateCase({\n                            partsRequired: newValue,\n                            _eventType: \"PARTS_UPDATED\",\n                            _eventMetadata: { partsRequired: newValue, wasRequired: oldValue }\n                          }, newValue ? \"Parts required marked\" : \"Parts not required\");\n                        }}\n                      />\n                      <div className=\"w-10 h-6 bg-slate-200 rounded-full peer-checked:bg-[#0066CC] transition-colors\"></div>\n                      <div className=\"absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-4\"></div>\n                    </div>\n                    <span className=\"text-sm font-medium text-slate-700 group-hover:text-slate-900\">Parts required</span>\n                  </label>\n\n                  {selectedCase.partsRequired && (\n                    <div className=\"pt-2 border-t border-slate-100\">\n                      <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Parts Notes</label>\n                      <textarea\n                        className=\"w-full px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm resize-none\"\n                        rows={2}\n                        value={selectedCase.partsNotes || \"\"}\n                        placeholder=\"List parts needed, order status, etc...\"\n                        onChange={(e) => setSelectedCase({ ...selectedCase, partsNotes: e.target.value })}\n                        onBlur={() => updateCase({\n                          partsNotes: selectedCase.partsNotes,\n                          _eventType: \"PARTS_UPDATED\",\n                          _eventMetadata: { partsNotes: selectedCase.partsNotes }\n                        })}\n                      />\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* Courtesy Car Section */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-base\">🚗</span>\n                    <h3 className=\"text-sm font-semibold text-slate-900\">Courtesy Car</h3>\n                  </div>\n                  {selectedCase.courtesyAllocation?.status === \"OUT\" && (\n                    <span className=\"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700\">\n                      Out\n                    </span>\n                  )}\n                </div>\n                <div className=\"p-4 space-y-3\">\n                  {/* Toggle: Courtesy Required */}\n                  <label className=\"flex items-center gap-3 cursor-pointer group\">\n                    <div className=\"relative\">\n                      <input\n                        type=\"checkbox\"\n                        className=\"sr-only peer\"\n                        checked={selectedCase.courtesyRequired || false}\n                        onChange={async (e) => {\n                          const newValue = e.target.checked;\n                          await updateCase({\n                            courtesyRequired: newValue,\n                            _eventType: \"COURTESY_REQUIRED_TOGGLED\",\n                            _eventMetadata: { courtesyRequired: newValue }\n                          }, newValue ? \"Courtesy car marked as required\" : \"Courtesy car not required\");\n                        }}\n                      />\n                      <div className=\"w-10 h-6 bg-slate-200 rounded-full peer-checked:bg-[#0066CC] transition-colors\"></div>\n                      <div className=\"absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-4\"></div>\n                    </div>\n                    <span className=\"text-sm font-medium text-slate-700 group-hover:text-slate-900\">Courtesy car required</span>\n                  </label>\n\n                  {/* Allocation Display / Controls */}\n                  {selectedCase.courtesyAllocation && selectedCase.courtesyAllocation.status === \"OUT\" ? (\n                    <div className=\"bg-emerald-50 border border-emerald-200 rounded-lg p-3 space-y-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"text-sm font-medium text-emerald-800\">Currently Allocated</span>\n                        <span className=\"inline-flex items-center bg-amber-100 border border-amber-300 rounded-lg px-2 py-0.5 font-mono font-bold text-slate-900 text-xs tracking-wider uppercase\">\n                          {selectedCase.courtesyAllocation.courtesyVehicle?.regCurrent || \"N/A\"}\n                        </span>\n                      </div>\n                      {selectedCase.courtesyAllocation.courtesyVehicle && (\n                        <p className=\"text-xs text-emerald-700\">\n                          {selectedCase.courtesyAllocation.courtesyVehicle.make} {selectedCase.courtesyAllocation.courtesyVehicle.model}\n                        </p>\n                      )}\n                      {selectedCase.courtesyAllocation.dateDueBack && (\n                        <p className=\"text-xs text-emerald-700\">\n                          Due back: {new Date(selectedCase.courtesyAllocation.dateDueBack).toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\" })}\n                        </p>\n                      )}\n                      <button\n                        className=\"inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-emerald-700 bg-emerald-100 hover:bg-emerald-200 border border-emerald-200 rounded-lg transition-colors mt-1\"\n                        onClick={returnCourtesy}\n                      >\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                        Mark as Returned\n                      </button>\n                    </div>\n                  ) : selectedCase.courtesyAllocation && selectedCase.courtesyAllocation.status === \"RETURNED\" ? (\n                    <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-3\">\n                      <div className=\"flex items-center gap-2 text-sm text-slate-600\">\n                        <svg className=\"w-4 h-4 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                        Courtesy car returned\n                        {selectedCase.courtesyAllocation.courtesyVehicle?.regCurrent && (\n                          <span className=\"font-mono text-xs bg-slate-100 px-1.5 py-0.5 rounded\">({selectedCase.courtesyAllocation.courtesyVehicle.regCurrent})</span>\n                        )}\n                      </div>\n                    </div>\n                  ) : selectedCase.courtesyRequired ? (\n                    <div className=\"space-y-2 pt-2 border-t border-slate-100\">\n                      <p className=\"text-xs text-amber-600 font-medium flex items-center gap-1\">\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                        </svg>\n                        No courtesy car allocated yet\n                      </p>\n                      <div>\n                        <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Select Vehicle</label>\n                        <select\n                          className=\"w-full px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm\"\n                          onFocus={loadCourtesyVehicles}\n                          onChange={(e) => {\n                            if (e.target.value) {\n                              allocateCourtesy(e.target.value);\n                            }\n                          }}\n                          defaultValue=\"\"\n                        >\n                          <option value=\"\" disabled>\n                            {isLoadingCourtesy ? \"Loading...\" : \"Choose courtesy vehicle...\"}\n                          </option>\n                          {courtesyVehicles.map((v) => (\n                            <option key={v._id} value={v._id}>\n                              {v.regCurrent} - {v.make} {v.model}\n                            </option>\n                          ))}\n                          {courtesyVehicles.length === 0 && !isLoadingCourtesy && (\n                            <option value=\"\" disabled>No courtesy vehicles available</option>\n                          )}\n                        </select>\n                      </div>\n                    </div>\n                  ) : null}\n                </div>\n              </div>\n\n              {/* Quick Actions Row */}\n              <div className=\"flex gap-2 flex-wrap\">\n                {selectedCase.aiReview?.payload ? (\n                  <button\n                    className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors\"\n                    onClick={() => setShowRegenerateConfirm(true)}\n                    disabled={isGeneratingAI}\n                  >\n                    {isGeneratingAI ? (\n                      <span className=\"w-4 h-4 border-2 border-slate-300 border-t-slate-600 rounded-full animate-spin\"></span>\n                    ) : (\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                      </svg>\n                    )}\n                    Regenerate AI\n                  </button>\n                ) : (\n                  <button\n                    className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-[#0066CC] hover:bg-[#0055BB] rounded-lg transition-colors shadow-sm\"\n                    onClick={() => generateAIReview()}\n                    disabled={isGeneratingAI}\n                  >\n                    {isGeneratingAI ? (\n                      <span className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\"></span>\n                    ) : (\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" />\n                      </svg>\n                    )}\n                    Generate AI Review\n                  </button>\n                )}\n                <button\n                  className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                  disabled={!selectedCase.aiReview?.payload?.draftCustomerReply}\n                  onClick={() => copyToClipboard(selectedCase.aiReview?.payload?.draftCustomerReply, \"Customer reply\")}\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                  </svg>\n                  Customer Reply\n                </button>\n                <button\n                  className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                  disabled={!selectedCase.aiReview?.payload?.draftInternalNote}\n                  onClick={() => copyToClipboard(selectedCase.aiReview?.payload?.draftInternalNote, \"Internal note\")}\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                  </svg>\n                  Internal Note\n                </button>\n              </div>\n\n              {/* AI Case Review Panel */}\n              {selectedCase.aiReview?.payload ? (\n                <div className=\"bg-[#0066CC]/5/50 rounded-xl border border-[#0066CC]/20 overflow-hidden\">\n                  <div className=\"px-4 py-3 border-b border-[#0066CC]/10 flex justify-between items-center bg-[#0066CC]/8\">\n                    <h3 className=\"text-sm font-semibold text-[#0055BB] flex items-center gap-2\">\n                      <span>🤖</span> AI Case Review\n                    </h3>\n                    <span className=\"text-xs text-[#0066CC]\">\n                      Generated {relativeTime(selectedCase.aiReview.generatedAt)}\n                    </span>\n                  </div>\n                  <div className=\"p-4 space-y-4\">\n                    {/* Summary */}\n                    <div>\n                      <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5\">Summary</h4>\n                      <p className=\"text-sm text-slate-700\">{selectedCase.aiReview.payload.summary}</p>\n                    </div>\n\n                    {/* Possible Causes */}\n                    {selectedCase.aiReview.payload.possibleCauses?.length > 0 && (\n                      <div>\n                        <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5\">Possible Causes</h4>\n                        <ul className=\"text-sm text-slate-700 list-disc list-inside space-y-1\">\n                          {selectedCase.aiReview.payload.possibleCauses.map((cause, i) => (\n                            <li key={i}>{cause}</li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n\n                    {/* Recommended Steps */}\n                    {selectedCase.aiReview.payload.recommendedSteps?.length > 0 && (\n                      <div>\n                        <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5\">Recommended Next Steps</h4>\n                        <ol className=\"text-sm text-slate-700 list-decimal list-inside space-y-1\">\n                          {selectedCase.aiReview.payload.recommendedSteps.map((step, i) => (\n                            <li key={i}>{step}</li>\n                          ))}\n                        </ol>\n                      </div>\n                    )}\n\n                    {/* Warranty Considerations */}\n                    {selectedCase.aiReview.payload.warrantyConsiderations?.length > 0 && (\n                      <div>\n                        <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5\">Warranty Considerations</h4>\n                        <ul className=\"text-sm text-slate-700 list-disc list-inside space-y-1\">\n                          {selectedCase.aiReview.payload.warrantyConsiderations.map((item, i) => (\n                            <li key={i}>{item}</li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n\n                    {/* Draft Customer Reply */}\n                    {selectedCase.aiReview.payload.draftCustomerReply && (\n                      <div>\n                        <div className=\"flex justify-between items-center mb-1.5\">\n                          <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Draft Customer Reply</h4>\n                          <button\n                            className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0066CC] hover:text-[#0066CC] hover:bg-[#0066CC]/10 rounded transition-colors\"\n                            onClick={() => copyToClipboard(selectedCase.aiReview.payload.draftCustomerReply, \"Customer reply\")}\n                          >\n                            <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                            </svg>\n                            Copy\n                          </button>\n                        </div>\n                        <p className=\"text-sm bg-white p-3 rounded-lg border border-[#0066CC]/10 whitespace-pre-wrap text-slate-700\">\n                          {selectedCase.aiReview.payload.draftCustomerReply}\n                        </p>\n                      </div>\n                    )}\n\n                    {/* Draft Internal Note */}\n                    {selectedCase.aiReview.payload.draftInternalNote && (\n                      <div>\n                        <div className=\"flex justify-between items-center mb-1.5\">\n                          <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Draft Internal Note</h4>\n                          <button\n                            className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0066CC] hover:text-[#0066CC] hover:bg-[#0066CC]/10 rounded transition-colors\"\n                            onClick={() => copyToClipboard(selectedCase.aiReview.payload.draftInternalNote, \"Internal note\")}\n                          >\n                            <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                            </svg>\n                            Copy\n                          </button>\n                        </div>\n                        <p className=\"text-sm bg-white p-3 rounded-lg border border-[#0066CC]/10 whitespace-pre-wrap text-slate-700\">\n                          {selectedCase.aiReview.payload.draftInternalNote}\n                        </p>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              ) : (\n                <div className=\"bg-slate-50 rounded-xl border border-slate-200 p-6 text-center\">\n                  <div className=\"w-10 h-10 mx-auto mb-3 rounded-full bg-slate-100 flex items-center justify-center text-lg\">\n                    🤖\n                  </div>\n                  <p className=\"text-sm text-slate-500\">\n                    Click \"Generate AI Review\" to get AI-powered analysis of this case.\n                  </p>\n                </div>\n              )}\n\n              {/* AI Diagnostics Panel */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">AI Diagnostics</h3>\n                  <button\n                    className=\"inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-md transition-colors\"\n                    onClick={fetchAIDiagnostics}\n                    disabled={isLoadingDiagnostics}\n                  >\n                    {isLoadingDiagnostics ? (\n                      <span className=\"w-3.5 h-3.5 border-2 border-slate-300 border-t-slate-600 rounded-full animate-spin\"></span>\n                    ) : aiDiagnostics ? (\n                      <>\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                        </svg>\n                        Refresh\n                      </>\n                    ) : (\n                      <>\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" />\n                        </svg>\n                        Get Suggestions\n                      </>\n                    )}\n                  </button>\n                </div>\n                {(aiDiagnostics || isLoadingDiagnostics) && (\n                  <AISuggestionsPanel\n                    suggestions={aiDiagnostics?.suggestions}\n                    isLoading={isLoadingDiagnostics}\n                    isDummy={aiDiagnostics?.isDummy}\n                    onCopyToNotes={(text) => {\n                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);\n                      toast.success(\"Added to comment draft\");\n                    }}\n                  />\n                )}\n              </div>\n\n              {/* Issue Summary */}\n              {selectedCase.summary && (\n                <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                  <div className=\"px-4 py-3 border-b border-slate-100\">\n                    <h3 className=\"text-sm font-semibold text-slate-900\">Issue Summary</h3>\n                  </div>\n                  <div className=\"p-4\">\n                    <p className=\"text-sm text-slate-700 whitespace-pre-wrap\">{selectedCase.summary}</p>\n                  </div>\n                </div>\n              )}\n\n              {/* Attachments/Media */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">\n                    Attachments {(selectedCase.attachments?.length || 0) > 0 && (\n                      <span className=\"ml-1 text-slate-400 font-normal\">({selectedCase.attachments.length})</span>\n                    )}\n                  </h3>\n                  <label className=\"inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-md transition-colors cursor-pointer\">\n                    {isUploadingCaseMedia ? (\n                      <span className=\"w-3.5 h-3.5 border-2 border-slate-300 border-t-slate-600 rounded-full animate-spin\"></span>\n                    ) : (\n                      <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                      </svg>\n                    )}\n                    Add Media\n                    <input\n                      type=\"file\"\n                      multiple\n                      accept=\"image/*,video/*,.pdf\"\n                      className=\"hidden\"\n                      onChange={handleCaseMediaUpload}\n                      disabled={isUploadingCaseMedia}\n                    />\n                  </label>\n                </div>\n                <div className=\"p-4\">\n                  {selectedCase.attachments?.length > 0 ? (\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      {selectedCase.attachments.map((att, i) => (\n                        <a\n                          key={i}\n                          href={att.url}\n                          target=\"_blank\"\n                          rel=\"noopener noreferrer\"\n                          className=\"block aspect-square bg-slate-100 rounded-lg overflow-hidden hover:ring-2 hover:ring-blue-500 transition-all\"\n                        >\n                          {att.url.match(/\\.(jpg|jpeg|png|gif|webp)$/i) ? (\n                            <img src={att.url} alt={att.filename} className=\"w-full h-full object-cover\" />\n                          ) : att.url.match(/\\.(mp4|webm|mov)$/i) ? (\n                            <div className=\"w-full h-full flex items-center justify-center bg-slate-200\">\n                              <svg className=\"w-8 h-8 text-slate-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z\" />\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            </div>\n                          ) : (\n                            <div className=\"w-full h-full flex flex-col items-center justify-center bg-slate-100 p-2\">\n                              <svg className=\"w-6 h-6 text-slate-400 mb-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                              </svg>\n                              <span className=\"text-xs text-slate-500 text-center truncate w-full\">{att.filename}</span>\n                            </div>\n                          )}\n                        </a>\n                      ))}\n                    </div>\n                  ) : (\n                    <p className=\"text-sm text-slate-500 text-center py-2\">No attachments yet. Click \"Add Media\" to upload photos or documents.</p>\n                  )}\n                </div>\n              </div>\n\n              {/* Timeline */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Timeline</h3>\n                </div>\n                <div className=\"p-4\">\n                  {/* Event-driven timeline (newest first) with grouping */}\n                  <div className=\"space-y-3 mb-4\">\n                    {groupTimelineEvents(selectedCase.events || []).map((item, idx) => {\n                      // Handle grouped STATUS_CHANGED events\n                      if (item.isGroup && item.type === \"STATUS_CHANGED_GROUP\") {\n                        const isExpanded = expandedTimelineGroups[idx];\n                        const lastEvent = item.events[0]; // Most recent in group\n\n                        // If only one event in group, render normally\n                        if (item.events.length === 1) {\n                          const event = item.events[0];\n                          return (\n                            <div key={idx} className=\"flex gap-3 items-start opacity-70\">\n                              <div className=\"text-base text-slate-400\" title={event.type}>\n                                {EVENT_ICONS.STATUS_CHANGED}\n                              </div>\n                              <div className=\"flex-1 min-w-0\">\n                                <p className=\"text-xs text-slate-500\">{event.summary || \"Status changed\"}</p>\n                                <p className=\"text-xs text-slate-400\" title={new Date(event.createdAt).toLocaleString()}>\n                                  {relativeTime(event.createdAt)}\n                                  {event.createdByName && <span className=\"ml-1\">by {event.createdByName}</span>}\n                                </p>\n                              </div>\n                            </div>\n                          );\n                        }\n\n                        return (\n                          <div key={idx} className=\"border border-slate-200 rounded-lg p-2 bg-slate-50/50\">\n                            <button\n                              className=\"flex gap-3 items-start w-full text-left\"\n                              onClick={() => setExpandedTimelineGroups(prev => ({ ...prev, [idx]: !prev[idx] }))}\n                            >\n                              <div className=\"text-base text-slate-400\" title=\"Multiple status changes\">\n                                {EVENT_ICONS.STATUS_CHANGED}\n                              </div>\n                              <div className=\"flex-1 min-w-0\">\n                                <p className=\"text-xs text-slate-600 font-medium\">\n                                  Status updated {item.events.length} times\n                                </p>\n                                <p className=\"text-xs text-slate-400\">\n                                  Last change: {relativeTime(lastEvent.createdAt)}\n                                </p>\n                              </div>\n                              <svg\n                                className={`w-4 h-4 text-slate-400 transition-transform ${isExpanded ? \"rotate-180\" : \"\"}`}\n                                fill=\"none\"\n                                stroke=\"currentColor\"\n                                viewBox=\"0 0 24 24\"\n                              >\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                              </svg>\n                            </button>\n\n                            {isExpanded && (\n                              <div className=\"mt-2 ml-7 space-y-2 border-l-2 border-slate-200 pl-3\">\n                                {item.events.map((event, subIdx) => (\n                                  <div key={subIdx} className=\"text-xs\">\n                                    <p className=\"text-slate-600\">{event.summary || \"Status changed\"}</p>\n                                    <p className=\"text-slate-400\">\n                                      {relativeTime(event.createdAt)}\n                                      {event.createdByName && <span className=\"ml-1\">by {event.createdByName}</span>}\n                                    </p>\n                                  </div>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                        );\n                      }\n\n                      // Handle individual events\n                      const event = item;\n                      const isProminent = event.type === \"COMMENT_ADDED\" || event.type === \"AI_REVIEW_GENERATED\";\n                      const isMinimal = event.type === \"CASE_CREATED\";\n                      const isStatusChange = event.type === \"STATUS_CHANGED\";\n\n                      return (\n                        <div\n                          key={idx}\n                          className={`flex gap-3 items-start ${isStatusChange ? \"opacity-70\" : \"\"} ${isMinimal ? \"opacity-50\" : \"\"}`}\n                        >\n                          <div\n                            className={`${isProminent ? \"text-lg\" : \"text-base\"} ${isStatusChange || isMinimal ? \"text-slate-400\" : \"\"}`}\n                            title={event.type}\n                          >\n                            {EVENT_ICONS[event.type] || \"📌\"}\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            {/* Prominent events (comments, AI reviews) get larger text and preview */}\n                            {isProminent ? (\n                              <>\n                                <p className=\"text-sm font-medium text-slate-900\">{event.summary || event.type.replace(/_/g, \" \")}</p>\n                                {event.type === \"COMMENT_ADDED\" && event.metadata?.content && (\n                                  <p className=\"text-xs text-slate-500 mt-0.5 line-clamp-2\">\n                                    \"{event.metadata.content}\"\n                                  </p>\n                                )}\n                              </>\n                            ) : (\n                              <p className={`${isStatusChange || isMinimal ? \"text-xs text-slate-500\" : \"text-sm text-slate-700\"}`}>\n                                {event.summary || event.type.replace(/_/g, \" \")}\n                              </p>\n                            )}\n                            <p\n                              className={`text-xs ${isStatusChange || isMinimal ? \"text-slate-400\" : \"text-slate-500\"}`}\n                              title={new Date(event.createdAt).toLocaleString()}\n                            >\n                              {relativeTime(event.createdAt)}\n                              {event.createdByName && <span className=\"ml-1\">by {event.createdByName}</span>}\n                            </p>\n                          </div>\n                        </div>\n                      );\n                    })}\n\n                    {(!selectedCase.events || selectedCase.events.length === 0) && (\n                      <p className=\"text-sm text-slate-500\">No timeline events yet.</p>\n                    )}\n                  </div>\n\n                  {/* Comments (legacy display for existing comments) */}\n                  {selectedCase.comments?.length > 0 && (\n                    <div className=\"border-t border-slate-100 pt-3 mt-3\">\n                      <h4 className=\"font-medium text-sm text-slate-900 mb-2\">Comments</h4>\n                      <div className=\"space-y-3\">\n                        {selectedCase.comments.map((comment) => (\n                          <div key={comment.id} className={`p-3 rounded-lg ${\n                            comment.authorType === \"customer\" ? \"bg-[#0066CC]/5 border border-[#0066CC]/10\" : \"bg-slate-50 border border-slate-100\"\n                          }`}>\n                            <div className=\"flex justify-between text-xs text-slate-500 mb-1\">\n                              <span className=\"font-medium\">{comment.authorType === \"customer\" ? \"Customer\" : \"Staff\"}</span>\n                              <span title={new Date(comment.createdAt).toLocaleString()}>\n                                {relativeTime(comment.createdAt)}\n                              </span>\n                            </div>\n                            <p className=\"text-sm text-slate-700\">{comment.content}</p>\n                            {comment.attachments?.length > 0 && (\n                              <div className=\"flex gap-2 mt-2 flex-wrap\">\n                                {comment.attachments.map((att, i) => (\n                                  <a\n                                    key={i}\n                                    href={att.url || att}\n                                    target=\"_blank\"\n                                    rel=\"noopener noreferrer\"\n                                    className=\"inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium text-slate-600 bg-white border border-slate-200 rounded-md hover:bg-slate-50\"\n                                  >\n                                    📎 {att.filename || \"File\"}\n                                  </a>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Add Comment with Attachment */}\n                  <div className=\"mt-4 pt-3 border-t border-slate-100\">\n                    {commentAttachments.length > 0 && (\n                      <div className=\"flex gap-2 flex-wrap mb-2\">\n                        {commentAttachments.map((att, i) => (\n                          <span key={i} className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-slate-600 bg-slate-100 rounded-md\">\n                            📎 {att.filename}\n                            <button\n                              className=\"text-red-500 hover:text-red-600 ml-0.5\"\n                              onClick={() => setCommentAttachments(commentAttachments.filter((_, j) => j !== i))}\n                            >\n                              ✕\n                            </button>\n                          </span>\n                        ))}\n                      </div>\n                    )}\n                    <div className=\"flex gap-2\">\n                      <input\n                        type=\"text\"\n                        className=\"flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm\"\n                        placeholder=\"Add a comment...\"\n                        value={newComment}\n                        onChange={(e) => setNewComment(e.target.value)}\n                        onKeyPress={(e) => e.key === \"Enter\" && addComment()}\n                      />\n                      <input\n                        type=\"file\"\n                        ref={fileInputRef}\n                        className=\"hidden\"\n                        multiple\n                        onChange={handleFileSelect}\n                      />\n                      <button\n                        className=\"p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors\"\n                        onClick={() => fileInputRef.current?.click()}\n                        title=\"Attach files\"\n                      >\n                        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13\" />\n                        </svg>\n                      </button>\n                      <button\n                        className=\"px-4 py-2 text-sm font-medium text-white bg-[#0066CC] hover:bg-[#0055BB] rounded-lg transition-colors\"\n                        onClick={addComment}\n                      >\n                        Add\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Regenerate Confirm Modal */}\n      {showRegenerateConfirm && (\n        <div className=\"modal modal-open\">\n          <div className=\"modal-box\">\n            <h3 className=\"font-bold text-lg\">Regenerate AI Review?</h3>\n            <p className=\"py-4\">This will replace the existing AI review with a new one. This action cannot be undone.</p>\n            <div className=\"modal-action\">\n              <button className=\"btn btn-ghost\" onClick={() => setShowRegenerateConfirm(false)}>Cancel</button>\n              <button className=\"btn btn-primary\" onClick={() => generateAIReview(true)}>Regenerate</button>\n            </div>\n          </div>\n          <div className=\"modal-backdrop\" onClick={() => setShowRegenerateConfirm(false)}></div>\n        </div>\n      )}\n\n      {/* Add Case Modal */}\n      {showAddModal && (\n        <AddCaseModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchCases(); }} />\n      )}\n\n      {/* Vehicle Drawer - Stacked over warranty case drawer */}\n      <VehicleDrawer\n        vehicleId={selectedVehicleId}\n        isOpen={isVehicleDrawerOpen}\n        onClose={() => {\n          setIsVehicleDrawerOpen(false);\n          setSelectedVehicleId(null);\n        }}\n        isStacked={true}\n        readOnly={true}\n      />\n\n      {/* Job Sheet Share Modal */}\n      {showJobSheetModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-[60]\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Share Job Sheet</h3>\n              <button\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4\">\n              {isGeneratingJobSheet ? (\n                <div className=\"flex flex-col items-center py-8\">\n                  <div className=\"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3\"></div>\n                  <p className=\"text-slate-600\">Generating share link...</p>\n                </div>\n              ) : jobSheetLink ? (\n                <div className=\"space-y-4\">\n                  <div className=\"bg-slate-50 rounded-lg p-3\">\n                    <p className=\"text-xs text-slate-500 mb-1\">Shareable Link</p>\n                    <p className=\"text-sm font-mono text-slate-900 break-all\">{jobSheetLink}</p>\n                  </div>\n                  <p className=\"text-xs text-slate-500\">\n                    This link expires in 60 days. Anyone with this link can view the job sheet.\n                  </p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      onClick={copyJobSheetLink}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      Copy Link\n                    </button>\n                    <button\n                      onClick={shareViaWhatsApp}\n                      className=\"btn btn-success btn-sm gap-2 text-white\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\n                      </svg>\n                      WhatsApp\n                    </button>\n                    <button\n                      onClick={() => {\n                        const reg = selectedCase?.regAtPurchase || selectedCase?.currentReg || \"Vehicle\";\n                        const subject = `Job Sheet - ${reg}`;\n                        const body = `Here is the warranty job sheet for ${reg}:\\n\\n${jobSheetLink}`;\n                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);\n                      }}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n                      </svg>\n                      Email\n                    </button>\n                    <button\n                      onClick={() => window.open(jobSheetLink, '_blank')}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                      </svg>\n                      Print / PDF\n                    </button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  No link generated yet\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </DashboardLayout>\n  );\n}\n\nfunction AddCaseModal({ onClose, onSuccess }) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [isUploadingMedia, setIsUploadingMedia] = useState(false);\n  const [mediaAttachments, setMediaAttachments] = useState([]);\n  const [formData, setFormData] = useState({\n    customerName: \"\", customerEmail: \"\", customerPhone: \"\",\n    vehicleReg: \"\", regAtPurchase: \"\", summary: \"\", priority: \"normal\",\n    warrantyType: \"\", mileage: \"\",\n    addressStreet: \"\", addressCity: \"\", addressPostcode: \"\",\n  });\n\n  const handleMediaUpload = async (e) => {\n    const files = Array.from(e.target.files);\n    if (files.length === 0) return;\n    setIsUploadingMedia(true);\n    const uploadedFiles = [];\n    for (const file of files) {\n      const formDataObj = new FormData();\n      formDataObj.append(\"file\", file);\n      try {\n        const res = await fetch(\"/api/vehicles/upload\", { method: \"POST\", body: formDataObj });\n        const data = await res.json();\n        if (data.url) {\n          uploadedFiles.push({ url: data.url, filename: data.filename || file.name });\n        }\n      } catch (err) {\n        toast.error(`Failed to upload ${file.name}`);\n      }\n    }\n    setMediaAttachments([...mediaAttachments, ...uploadedFiles]);\n    setIsUploadingMedia(false);\n    e.target.value = \"\";\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    if (!formData.customerName) return toast.error(\"Customer name required\");\n    setIsLoading(true);\n    try {\n      const payload = {\n        ...formData,\n        source: \"manual\",\n        attachments: mediaAttachments,\n        details: {\n          mileage: formData.mileage,\n          customerAddress: {\n            street: formData.addressStreet,\n            city: formData.addressCity,\n            postcode: formData.addressPostcode,\n          }\n        }\n      };\n      const res = await fetch(\"/api/aftercare\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      if (!res.ok) throw new Error(\"Failed to create\");\n      toast.success(\"Case created!\");\n      onSuccess();\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box\">\n        <h3 className=\"font-bold text-lg mb-4\">New Aftercare Case</h3>\n        <form onSubmit={handleSubmit}>\n          <div className=\"form-control mb-3\">\n            <label className=\"label\"><span className=\"label-text\">Customer Name *</span></label>\n            <input type=\"text\" className=\"input input-bordered\" value={formData.customerName}\n              onChange={(e) => setFormData({ ...formData, customerName: e.target.value })} required />\n          </div>\n          <div className=\"grid grid-cols-2 gap-3\">\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Phone</span></label>\n              <input type=\"tel\" className=\"input input-bordered\" value={formData.customerPhone}\n                onChange={(e) => setFormData({ ...formData, customerPhone: e.target.value })} />\n            </div>\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Email</span></label>\n              <input type=\"email\" className=\"input input-bordered\" value={formData.customerEmail}\n                onChange={(e) => setFormData({ ...formData, customerEmail: e.target.value })} />\n            </div>\n          </div>\n          <div className=\"grid grid-cols-2 gap-3 mt-3\">\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Current Reg (If different)</span></label>\n              <input type=\"text\" className=\"input input-bordered uppercase\" value={formData.vehicleReg}\n                onChange={(e) => setFormData({ ...formData, vehicleReg: e.target.value.toUpperCase() })} />\n            </div>\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Reg at Purchase</span></label>\n              <input type=\"text\" className=\"input input-bordered uppercase\" value={formData.regAtPurchase}\n                onChange={(e) => setFormData({ ...formData, regAtPurchase: e.target.value.toUpperCase() })} />\n            </div>\n          </div>\n          <div className=\"grid grid-cols-2 gap-3 mt-3\">\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Priority</span></label>\n              <select className=\"select select-bordered\" value={formData.priority}\n                onChange={(e) => setFormData({ ...formData, priority: e.target.value })}>\n                <option value=\"low\">Low</option>\n                <option value=\"normal\">Normal</option>\n                <option value=\"high\">High</option>\n                <option value=\"critical\">Critical</option>\n              </select>\n            </div>\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Warranty Type</span></label>\n              <select className=\"select select-bordered\" value={formData.warrantyType}\n                onChange={(e) => setFormData({ ...formData, warrantyType: e.target.value })}>\n                <option value=\"\">Not specified</option>\n                <option value=\"Dealer Warranty\">Dealer Warranty</option>\n                <option value=\"External Warranty\">External Warranty</option>\n              </select>\n            </div>\n          </div>\n          <div className=\"form-control mt-3\">\n            <label className=\"label\"><span className=\"label-text\">Current Mileage</span></label>\n            <input type=\"number\" className=\"input input-bordered\" placeholder=\"e.g. 45000\"\n              value={formData.mileage}\n              onChange={(e) => setFormData({ ...formData, mileage: e.target.value })} />\n          </div>\n          <div className=\"form-control mt-3\">\n            <label className=\"label\"><span className=\"label-text\">Customer Address</span></label>\n            <input type=\"text\" className=\"input input-bordered mb-2\" placeholder=\"Street address\"\n              value={formData.addressStreet}\n              onChange={(e) => setFormData({ ...formData, addressStreet: e.target.value })} />\n            <div className=\"grid grid-cols-2 gap-2\">\n              <input type=\"text\" className=\"input input-bordered\" placeholder=\"City\"\n                value={formData.addressCity}\n                onChange={(e) => setFormData({ ...formData, addressCity: e.target.value })} />\n              <input type=\"text\" className=\"input input-bordered uppercase\" placeholder=\"Postcode\"\n                value={formData.addressPostcode}\n                onChange={(e) => setFormData({ ...formData, addressPostcode: e.target.value.toUpperCase() })} />\n            </div>\n          </div>\n          <div className=\"form-control mt-3\">\n            <label className=\"label\"><span className=\"label-text\">Issue Summary</span></label>\n            <textarea className=\"textarea textarea-bordered\" value={formData.summary}\n              onChange={(e) => setFormData({ ...formData, summary: e.target.value })}></textarea>\n          </div>\n          <div className=\"form-control mt-3\">\n            <label className=\"label\"><span className=\"label-text\">Photos/Documents</span></label>\n            <div className=\"flex flex-wrap gap-2 mb-2\">\n              {mediaAttachments.map((att, i) => (\n                <div key={i} className=\"relative w-16 h-16 bg-slate-100 rounded overflow-hidden group\">\n                  {att.url.match(/\\.(jpg|jpeg|png|gif|webp)$/i) ? (\n                    <img src={att.url} alt={att.filename} className=\"w-full h-full object-cover\" />\n                  ) : (\n                    <div className=\"w-full h-full flex items-center justify-center text-xs text-slate-500 p-1\">\n                      {att.filename}\n                    </div>\n                  )}\n                  <button\n                    type=\"button\"\n                    className=\"absolute top-0 right-0 bg-red-500 text-white w-4 h-4 text-xs flex items-center justify-center rounded-bl opacity-0 group-hover:opacity-100 transition-opacity\"\n                    onClick={() => setMediaAttachments(mediaAttachments.filter((_, j) => j !== i))}\n                  >\n                    ×\n                  </button>\n                </div>\n              ))}\n            </div>\n            <label className=\"btn btn-outline btn-sm gap-2 w-fit cursor-pointer\">\n              {isUploadingMedia ? (\n                <span className=\"loading loading-spinner loading-xs\"></span>\n              ) : (\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                </svg>\n              )}\n              Add Photos\n              <input\n                type=\"file\"\n                multiple\n                accept=\"image/*,.pdf\"\n                className=\"hidden\"\n                onChange={handleMediaUpload}\n                disabled={isUploadingMedia}\n              />\n            </label>\n          </div>\n          <div className=\"modal-action\">\n            <button type=\"button\" className=\"btn btn-ghost\" onClick={onClose}>Cancel</button>\n            <button type=\"submit\" className=\"btn btn-primary\" disabled={isLoading}>\n              {isLoading ? <span className=\"loading loading-spinner\"></span> : \"Create Case\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n","structuredPatch":[{"oldStart":616,"oldLines":18,"newStart":616,"newLines":42,"lines":["           additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,","         }),","       });","+","+      // Handle auth errors separately","+      if (res.status === 401 || res.status === 403) {","+        setAiDiagnostics({","+          suggestions: null,","+          isDummy: true,","+          errorCode: \"UNAUTHORIZED\",","+          errorMessage: \"Please sign in to use AI features.\",","+        });","+        return;","+      }","+","       const data = await res.json();","       if (data.success) {","         setAiDiagnostics({","           suggestions: data.suggestions,","           isDummy: data.isDummy,","+          errorCode: data.isDummy ? \"NOT_CONFIGURED\" : null,","+          errorMessage: data.message,","         });","       } else {","-        toast.error(data.error || \"Failed to get AI suggestions\");","+        setAiDiagnostics({","+          suggestions: null,","+          isDummy: true,","+          errorCode: data.errorCode || \"SERVICE_ERROR\",","+          errorMessage: data.error || \"Failed to get AI suggestions\",","+        });","       }","     } catch (error) {","       console.error(\"AI diagnostics error:\", error);","-      toast.error(\"Failed to get AI suggestions\");","+      setAiDiagnostics({","+        suggestions: null,","+        isDummy: true,","+        errorCode: \"SERVICE_ERROR\",","+        errorMessage: \"Failed to connect to AI service\",","+      });","     } finally {","       setIsLoadingDiagnostics(false);","     }"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"bf72f9bc-faf5-4fa2-9976-19390a89b6be","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VdvWHWW4zDE6BYXJPv56iZ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to find where the AISuggestionsPanel is used in warranty.js and update it to pass the new errorCode and errorMessage props.","signature":"Eq8CCkYICxgCKkC74IkUHbgB47/kMl+GaLriV64/K0JpshpbKZQKGhE1EYOiHd3WBYFyWeSnP8zvGU4WQUiX9CpTO8yee+H15MwLEgwtZEw3K/zgzzpStJoaDM3QqveVO5t8lM8RQSIwYirCypQSDrs1ZF3xicLRDGmuXCZVcPaooXUZ1rScwZVFbmK+xsEt+N9Y/td4H1+cKpYBS7f1UzEE8Eev5vP7vpxLN1e0mAImOv8e1gDQULFLRFXrGQQd2tM/9CpYLrhD6iHRGOfVpRQKgCbp64qjWdvzJU7lP1tEe7w/7zaHbri/d4+zRGiYq0D/CczHoRpGpjUCC6bXdAXe8VkY4POkQHi0mo7HuL4wEQ9EAcCsA/Tg2uUNvFP9n9fAAkobM7bTEXPE2IHWg/ILGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2258,"cache_read_input_tokens":96280,"cache_creation":{"ephemeral_5m_input_tokens":2258,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8zraSwD4rXXuHoyVsZ","type":"assistant","uuid":"4cb2a997-e272-4269-81ef-5cb0409682d1","timestamp":"2025-12-30T15:51:36.589Z"}
{"parentUuid":"4cb2a997-e272-4269-81ef-5cb0409682d1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VdvWHWW4zDE6BYXJPv56iZ","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the AISuggestionsPanel usage in warranty.js to pass the error props:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2258,"cache_read_input_tokens":96280,"cache_creation":{"ephemeral_5m_input_tokens":2258,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd8zraSwD4rXXuHoyVsZ","type":"assistant","uuid":"88a99e0e-14db-4eb9-97f3-90141d7b2cda","timestamp":"2025-12-30T15:51:37.333Z"}
{"parentUuid":"88a99e0e-14db-4eb9-97f3-90141d7b2cda","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01VdvWHWW4zDE6BYXJPv56iZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01TVhPU9q7y9Y6n7iFut6agu","name":"Grep","input":{"pattern":"AISuggestionsPanel","path":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","output_mode":"content","-n":true,"-C":5}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2258,"cache_read_input_tokens":96280,"cache_creation":{"ephemeral_5m_input_tokens":2258,"ephemeral_1h_input_tokens":0},"output_tokens":207,"service_tier":"standard"}},"requestId":"req_011CWd8zraSwD4rXXuHoyVsZ","type":"assistant","uuid":"ecd8fd39-613e-4a37-bb68-e9422577ad87","timestamp":"2025-12-30T15:51:39.407Z"}
{"parentUuid":"ecd8fd39-613e-4a37-bb68-e9422577ad87","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01TVhPU9q7y9Y6n7iFut6agu","type":"tool_result","content":"1-import { useEffect, useState, useRef } from \"react\";\r\n2-import { useRouter } from \"next/router\";\r\n3-import Head from \"next/head\";\r\n4-import DashboardLayout from \"@/components/DashboardLayout\";\r\n5-import VehicleDrawer from \"@/components/VehicleDrawer\";\r\n6:import AISuggestionsPanel from \"@/components/AISuggestionsPanel\";\r\n7-import { BottomSheet } from \"@/components/ui/BottomSheet\";\r\n8-import { MobileStageSelector } from \"@/components/ui/PageShell\";\r\n9-import { toast } from \"react-hot-toast\";\r\n10-\r\n11-// Column config matching Sales & Prep style\r\n--\n2097-                      </>\r\n2098-                    )}\r\n2099-                  </button>\r\n2100-                </div>\r\n2101-                {(aiDiagnostics || isLoadingDiagnostics) && (\r\n2102:                  <AISuggestionsPanel\r\n2103-                    suggestions={aiDiagnostics?.suggestions}\r\n2104-                    isLoading={isLoadingDiagnostics}\r\n2105-                    isDummy={aiDiagnostics?.isDummy}\r\n2106-                    onCopyToNotes={(text) => {\r\n2107-                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);"}]},"uuid":"a4c76417-e9c4-4ca8-993f-1e1d86eb6d27","timestamp":"2025-12-30T15:51:40.870Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"1-import { useEffect, useState, useRef } from \"react\";\r\n2-import { useRouter } from \"next/router\";\r\n3-import Head from \"next/head\";\r\n4-import DashboardLayout from \"@/components/DashboardLayout\";\r\n5-import VehicleDrawer from \"@/components/VehicleDrawer\";\r\n6:import AISuggestionsPanel from \"@/components/AISuggestionsPanel\";\r\n7-import { BottomSheet } from \"@/components/ui/BottomSheet\";\r\n8-import { MobileStageSelector } from \"@/components/ui/PageShell\";\r\n9-import { toast } from \"react-hot-toast\";\r\n10-\r\n11-// Column config matching Sales & Prep style\r\n--\n2097-                      </>\r\n2098-                    )}\r\n2099-                  </button>\r\n2100-                </div>\r\n2101-                {(aiDiagnostics || isLoadingDiagnostics) && (\r\n2102:                  <AISuggestionsPanel\r\n2103-                    suggestions={aiDiagnostics?.suggestions}\r\n2104-                    isLoading={isLoadingDiagnostics}\r\n2105-                    isDummy={aiDiagnostics?.isDummy}\r\n2106-                    onCopyToNotes={(text) => {\r\n2107-                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);","numLines":23}}
{"parentUuid":"a4c76417-e9c4-4ca8-993f-1e1d86eb6d27","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NmtydYmeLuFtkbfXz3XrUC","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to update the AISuggestionsPanel usage to include the new props.","signature":"Eu8BCkYICxgCKkBiuGKzKKhnkpeq2KtBbgv5D7T0ARZvEQCxe/TNQAC/uVtKbNGkCp6kGYsXUuhCYCk2vlpOD2ML8KDsJPwY0I5iEgy6KeaTX3UDnMxwTosaDILFYab2DLVjI3A90yIw9y/n79GAo/YaUg4RM+Cppv37oqIphanNm5A5BJVpAvg3IHwywAtUP6/sErtiFmokKldL1add6yMTDGUU2FCqbyLPJ1znqEJOevWAhoktWU9na88TgUoG85auh81RjdO+EZUCOGaysSRgfHINtZbALjJx1isnyuS3UQpLA+ws0v8goR5Y9M5TH/oYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":572,"cache_read_input_tokens":98538,"cache_creation":{"ephemeral_5m_input_tokens":572,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd91ZL9GwUtELFgtY9o2","type":"assistant","uuid":"9cd6a47a-ebb7-44d6-bb98-472a21a19c0d","timestamp":"2025-12-30T15:51:45.237Z"}
{"parentUuid":"9cd6a47a-ebb7-44d6-bb98-472a21a19c0d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NmtydYmeLuFtkbfXz3XrUC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011PfUhh34SxToJXL6Bab6hc","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","old_string":"                {(aiDiagnostics || isLoadingDiagnostics) && (\n                  <AISuggestionsPanel\n                    suggestions={aiDiagnostics?.suggestions}\n                    isLoading={isLoadingDiagnostics}\n                    isDummy={aiDiagnostics?.isDummy}\n                    onCopyToNotes={(text) => {\n                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);","new_string":"                {(aiDiagnostics || isLoadingDiagnostics) && (\n                  <AISuggestionsPanel\n                    suggestions={aiDiagnostics?.suggestions}\n                    isLoading={isLoadingDiagnostics}\n                    isDummy={aiDiagnostics?.isDummy}\n                    errorCode={aiDiagnostics?.errorCode}\n                    errorMessage={aiDiagnostics?.errorMessage}\n                    onCopyToNotes={(text) => {\n                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":572,"cache_read_input_tokens":98538,"cache_creation":{"ephemeral_5m_input_tokens":572,"ephemeral_1h_input_tokens":0},"output_tokens":391,"service_tier":"standard"}},"requestId":"req_011CWd91ZL9GwUtELFgtY9o2","type":"assistant","uuid":"4ce66e9c-8c3e-409b-a406-3f14abdc2fba","timestamp":"2025-12-30T15:51:49.010Z"}
{"parentUuid":"4ce66e9c-8c3e-409b-a406-3f14abdc2fba","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011PfUhh34SxToJXL6Bab6hc","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\warranty.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n  2097→                      </>\n  2098→                    )}\n  2099→                  </button>\n  2100→                </div>\n  2101→                {(aiDiagnostics || isLoadingDiagnostics) && (\n  2102→                  <AISuggestionsPanel\n  2103→                    suggestions={aiDiagnostics?.suggestions}\n  2104→                    isLoading={isLoadingDiagnostics}\n  2105→                    isDummy={aiDiagnostics?.isDummy}\n  2106→                    errorCode={aiDiagnostics?.errorCode}\n  2107→                    errorMessage={aiDiagnostics?.errorMessage}\n  2108→                    onCopyToNotes={(text) => {\n  2109→                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);\n  2110→                      toast.success(\"Added to comment draft\");\n  2111→                    }}\n  2112→                  />\n  2113→                )}"}]},"uuid":"357a7e99-900f-406a-a8c3-fe952dfb595f","timestamp":"2025-12-30T15:51:50.358Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\warranty.js","oldString":"                {(aiDiagnostics || isLoadingDiagnostics) && (\n                  <AISuggestionsPanel\n                    suggestions={aiDiagnostics?.suggestions}\n                    isLoading={isLoadingDiagnostics}\n                    isDummy={aiDiagnostics?.isDummy}\n                    onCopyToNotes={(text) => {\n                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);","newString":"                {(aiDiagnostics || isLoadingDiagnostics) && (\n                  <AISuggestionsPanel\n                    suggestions={aiDiagnostics?.suggestions}\n                    isLoading={isLoadingDiagnostics}\n                    isDummy={aiDiagnostics?.isDummy}\n                    errorCode={aiDiagnostics?.errorCode}\n                    errorMessage={aiDiagnostics?.errorMessage}\n                    onCopyToNotes={(text) => {\n                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);","originalFile":"import { useEffect, useState, useRef } from \"react\";\nimport { useRouter } from \"next/router\";\nimport Head from \"next/head\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport VehicleDrawer from \"@/components/VehicleDrawer\";\nimport AISuggestionsPanel from \"@/components/AISuggestionsPanel\";\nimport { BottomSheet } from \"@/components/ui/BottomSheet\";\nimport { MobileStageSelector } from \"@/components/ui/PageShell\";\nimport { toast } from \"react-hot-toast\";\n\n// Column config matching Sales & Prep style\n// NOTE: Internal keys are legacy names - keep stable for database compatibility\n// Display labels have been updated for clarity\nconst COLUMNS = [\n  { key: \"not_booked_in\", label: \"Not Booked In\", gradient: \"from-red-100/60\", accent: \"border-l-red-400\", accentBg: \"bg-red-400\" },\n  { key: \"on_site\", label: \"Booked In\", gradient: \"from-amber-100/60\", accent: \"border-l-amber-400\", accentBg: \"bg-amber-400\" }, // Legacy key: \"on_site\" displays as \"Booked In\"\n  { key: \"work_complete\", label: \"Work Complete\", gradient: \"from-blue-100/60\", accent: \"border-l-blue-400\", accentBg: \"bg-blue-400\" },\n  { key: \"collected\", label: \"Closed\", gradient: \"from-emerald-100/60\", accent: \"border-l-emerald-400\", accentBg: \"bg-emerald-400\" }, // Legacy key: \"collected\" displays as \"Closed\"\n];\n\nconst PRIORITIES = {\n  low: { bg: \"bg-slate-100\", text: \"text-slate-600\", border: \"border-slate-200\" },\n  normal: { bg: \"bg-blue-50\", text: \"text-blue-700\", border: \"border-blue-100\" },\n  high: { bg: \"bg-amber-50\", text: \"text-amber-700\", border: \"border-amber-100\" },\n  critical: { bg: \"bg-red-50\", text: \"text-red-700\", border: \"border-red-100\" },\n};\n\nconst SOURCE_LABELS = {\n  warranty_claim_form: \"Warranty Claim\",\n  low_review: \"Low Review\",\n  complaint_form: \"Complaint\",\n  manual: \"Manual\",\n};\n\n// Timeline event icons\nconst EVENT_ICONS = {\n  CASE_CREATED: \"📋\",\n  SUBMISSION_LINKED: \"🔗\",\n  COMMENT_ADDED: \"💬\",\n  STATUS_CHANGED: \"🔄\",\n  AI_REVIEW_GENERATED: \"🤖\",\n  ATTACHMENT_ADDED: \"📎\",\n  LOCATION_UPDATED: \"📍\",\n  BOOKING_UPDATED: \"📅\",\n  PARTS_UPDATED: \"🔧\",\n  COURTESY_REQUIRED_TOGGLED: \"🚗\",\n  COURTESY_ALLOCATED: \"🚗\",\n  COURTESY_RETURNED: \"🚗\",\n  COURTESY_OUT_RECORDED: \"🚗\",\n  COURTESY_IN_RECORDED: \"🚗\",\n  // Warranty booking auto-move events\n  WARRANTY_BOOKED_IN: \"📅\",\n  WARRANTY_BOOKING_UPDATED: \"📅\",\n  WARRANTY_BOOKING_CANCELLED: \"❌\",\n  WARRANTY_STAGE_MOVED: \"🔀\",\n};\n\n// Timeline grouping constant\nconst STATUS_FLIP_GROUP_WINDOW_MS = 10 * 60 * 1000; // 10 minutes\n\n// Group consecutive STATUS_CHANGED events within the time window\nconst groupTimelineEvents = (events) => {\n  if (!events || events.length === 0) return [];\n\n  const sorted = [...events].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));\n  const grouped = [];\n  let currentGroup = null;\n\n  for (const event of sorted) {\n    if (event.type === \"STATUS_CHANGED\") {\n      if (currentGroup) {\n        // Check if this event is within the time window of the last event in the group\n        const lastEventTime = new Date(currentGroup.events[currentGroup.events.length - 1].createdAt).getTime();\n        const thisEventTime = new Date(event.createdAt).getTime();\n\n        if (lastEventTime - thisEventTime <= STATUS_FLIP_GROUP_WINDOW_MS) {\n          currentGroup.events.push(event);\n          continue;\n        } else {\n          // Close current group and start new one\n          grouped.push(currentGroup);\n          currentGroup = { isGroup: true, type: \"STATUS_CHANGED_GROUP\", events: [event] };\n        }\n      } else {\n        currentGroup = { isGroup: true, type: \"STATUS_CHANGED_GROUP\", events: [event] };\n      }\n    } else {\n      // Non-status event - close any current group and add this event\n      if (currentGroup) {\n        grouped.push(currentGroup);\n        currentGroup = null;\n      }\n      grouped.push(event);\n    }\n  }\n\n  // Don't forget to add the last group if exists\n  if (currentGroup) {\n    grouped.push(currentGroup);\n  }\n\n  return grouped;\n};\n\n// Repair location type labels\nconst REPAIR_LOCATION_LABELS = {\n  WITH_CUSTOMER: \"With customer\",\n  ON_SITE: \"On-site\",\n  THIRD_PARTY: \"Third-party\",\n};\n\n// Repair location type badge styles\nconst REPAIR_LOCATION_STYLES = {\n  WITH_CUSTOMER: { bg: \"bg-slate-100\", text: \"text-slate-600\" },\n  ON_SITE: { bg: \"bg-emerald-100\", text: \"text-emerald-700\" },\n  THIRD_PARTY: { bg: \"bg-[#14B8A6]/10\", text: \"text-[#14B8A6]\" },\n};\n\n// Format booked date/time for display\nconst formatBookedDate = (date) => {\n  if (!date) return null;\n  const d = new Date(date);\n  return d.toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\" }) +\n    \" \" + d.toLocaleTimeString(\"en-GB\", { hour: \"2-digit\", minute: \"2-digit\" });\n};\n\n// Helper to calculate days since date\nconst daysSince = (date) => {\n  if (!date) return 0;\n  const diff = Date.now() - new Date(date).getTime();\n  return Math.floor(diff / (1000 * 60 * 60 * 24));\n};\n\n// Helper for relative time display\nconst relativeTime = (date) => {\n  const days = daysSince(date);\n  if (days === 0) {\n    const hours = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60 * 60));\n    if (hours === 0) {\n      const mins = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60));\n      return mins <= 1 ? \"Just now\" : `${mins}m ago`;\n    }\n    return `${hours}h ago`;\n  }\n  if (days === 1) return \"Yesterday\";\n  if (days < 7) return `${days}d ago`;\n  if (days < 30) return `${Math.floor(days / 7)}w ago`;\n  return `${Math.floor(days / 30)}mo ago`;\n};\n\nexport default function Warranty() {\n  const router = useRouter();\n  const [cases, setCases] = useState([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedCase, setSelectedCase] = useState(null);\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [newComment, setNewComment] = useState(\"\");\n  const [commentAttachments, setCommentAttachments] = useState([]);\n  const [isUploadingCaseMedia, setIsUploadingCaseMedia] = useState(false);\n  const [isGeneratingAI, setIsGeneratingAI] = useState(false);\n  const [showRegenerateConfirm, setShowRegenerateConfirm] = useState(false);\n  const [aiDiagnostics, setAiDiagnostics] = useState(null);\n  const [isLoadingDiagnostics, setIsLoadingDiagnostics] = useState(false);\n  const [expandedTimelineGroups, setExpandedTimelineGroups] = useState({});\n  const [isVehicleDrawerOpen, setIsVehicleDrawerOpen] = useState(false);\n  const [selectedVehicleId, setSelectedVehicleId] = useState(null);\n  const fileInputRef = useRef(null);\n\n  // Drag state - matching Sales & Prep\n  const [draggedCard, setDraggedCard] = useState(null);\n  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });\n\n  // Courtesy car state\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [isLoadingCourtesy, setIsLoadingCourtesy] = useState(false);\n\n  // Column sorting state\n  const [columnSortOptions, setColumnSortOptions] = useState({});\n\n  // Search filter state\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  // Filter state (matching stock board style)\n  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);\n  const [showMobileFilters, setShowMobileFilters] = useState(false);\n  const [filters, setFilters] = useState({\n    location: \"all\",      // \"all\" | \"ON_SITE\" | \"THIRD_PARTY\"\n    booked: \"all\",        // \"all\" | \"booked\" | \"not_booked\"\n    partsRequired: \"all\", // \"all\" | \"yes\" | \"no\"\n    priority: \"all\",      // \"all\" | \"low\" | \"normal\" | \"high\" | \"critical\"\n  });\n\n  // Mobile column selection\n  const [mobileActiveColumn, setMobileActiveColumn] = useState(\"not_booked_in\");\n\n  // Job sheet share state\n  const [showJobSheetModal, setShowJobSheetModal] = useState(false);\n  const [jobSheetLink, setJobSheetLink] = useState(null);\n  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);\n\n  useEffect(() => { fetchCases(); }, []);\n\n  // Auto-open case from query param (e.g., /warranty?caseId=123)\n  useEffect(() => {\n    if (router.query.caseId && !selectedCase) {\n      fetchCaseDetail(router.query.caseId);\n    }\n  }, [router.query.caseId]);\n\n  const fetchCases = async () => {\n    try {\n      const res = await fetch(\"/api/aftercare\");\n      // Check for JSON response\n      const contentType = res.headers.get(\"content-type\") || \"\";\n      if (!contentType.includes(\"application/json\")) {\n        console.error(\"[Warranty] Non-JSON response:\", res.status);\n        toast.error(res.status === 401 || res.status === 403 ? \"Session expired - please sign in\" : \"Failed to load cases\");\n        setCases([]);\n        return;\n      }\n      if (!res.ok) {\n        const err = await res.json();\n        toast.error(err.error || \"Failed to load cases\");\n        setCases([]);\n        return;\n      }\n      const data = await res.json();\n      setCases(Array.isArray(data) ? data : []);\n    } catch (error) {\n      console.error(\"[Warranty] Fetch error:\", error);\n      toast.error(\"Failed to load cases\");\n      setCases([]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const fetchCaseDetail = async (caseId) => {\n    if (!caseId) return; // Guard against undefined/null caseId\n    // Clear AI diagnostics when switching cases\n    setAiDiagnostics(null);\n    try {\n      const res = await fetch(`/api/aftercare/${caseId}`);\n      // Check for JSON response\n      const contentType = res.headers.get(\"content-type\") || \"\";\n      if (!contentType.includes(\"application/json\")) {\n        console.error(\"[Warranty] Case detail non-JSON response:\", res.status);\n        toast.error(\"Failed to load case details\");\n        return;\n      }\n      if (!res.ok) {\n        const err = await res.json();\n        toast.error(err.error || \"Failed to load case\");\n        return;\n      }\n      const data = await res.json();\n      // Normalize id field (API returns _id, we use id internally)\n      setSelectedCase({ ...data, id: data._id || data.id });\n    } catch (error) {\n      console.error(\"[Warranty] Case detail error:\", error);\n      toast.error(\"Failed to load case\");\n    }\n  };\n\n  // Helper function to update case fields with proper error handling\n  const updateCase = async (updates, successMessage) => {\n    const caseId = selectedCase?.id || selectedCase?._id;\n    if (!caseId) return false;\n    try {\n      const res = await fetch(`/api/aftercare/${caseId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to update case\");\n      }\n      // Update local state from response\n      if (data.case) {\n        setSelectedCase({ ...data.case, id: data.case._id || data.case.id });\n        setCases(prev => prev.map(c =>\n          (c.id || c._id) === caseId ? { ...data.case, id: data.case._id || data.case.id } : c\n        ));\n      }\n\n      // Handle auto-move toast messages for booking changes\n      if (data.autoMoved) {\n        const COLUMN_LABELS = {\n          not_booked_in: \"Not Booked In\",\n          on_site: \"Booked In\",\n          work_complete: \"Work Complete\",\n          collected: \"Closed\"\n        };\n        if (data.autoMovedTo === \"on_site\") {\n          toast.success(`Booked in — moved to Booked In`, { duration: 4000 });\n        } else if (data.autoMovedFrom === \"on_site\") {\n          toast.success(`Booking cancelled — moved back to ${COLUMN_LABELS[data.autoMovedTo] || data.autoMovedTo}`, { duration: 4000 });\n        }\n      } else if (successMessage) {\n        toast.success(successMessage);\n      }\n      return data;\n    } catch (error) {\n      toast.error(error.message || \"Failed to update case\");\n      return false;\n    }\n  };\n\n  // Load available courtesy vehicles\n  const loadCourtesyVehicles = async () => {\n    setIsLoadingCourtesy(true);\n    try {\n      const res = await fetch(\"/api/aftercare/courtesy\");\n      const data = await res.json();\n      setCourtesyVehicles(data.available || []);\n    } catch (error) {\n      console.error(\"Error loading courtesy vehicles:\", error);\n    } finally {\n      setIsLoadingCourtesy(false);\n    }\n  };\n\n  // Allocate courtesy vehicle to case\n  const allocateCourtesy = async (courtesyVehicleId, dateDueBack) => {\n    const caseId = selectedCase?.id || selectedCase?._id;\n    if (!caseId || !courtesyVehicleId) return false;\n    try {\n      const res = await fetch(\"/api/aftercare/courtesy\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ caseId, courtesyVehicleId, dateDueBack }),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to allocate courtesy vehicle\");\n      }\n      if (data.case) {\n        setSelectedCase({ ...data.case, id: data.case._id || data.case.id });\n        setCases(prev => prev.map(c =>\n          (c.id || c._id) === caseId ? { ...data.case, id: data.case._id || data.case.id } : c\n        ));\n      }\n      toast.success(\"Courtesy vehicle allocated\");\n      loadCourtesyVehicles(); // Refresh available list\n      return true;\n    } catch (error) {\n      toast.error(error.message || \"Failed to allocate courtesy vehicle\");\n      return false;\n    }\n  };\n\n  // Return courtesy vehicle\n  const returnCourtesy = async () => {\n    const allocationId = selectedCase?.courtesyAllocationId || selectedCase?.courtesyAllocation?._id;\n    if (!allocationId) return false;\n    try {\n      const res = await fetch(\"/api/aftercare/courtesy\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ allocationId }),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to return courtesy vehicle\");\n      }\n      // Refresh case detail\n      fetchCaseDetail(selectedCase.id || selectedCase._id);\n      loadCourtesyVehicles(); // Refresh available list\n      toast.success(\"Courtesy vehicle returned\");\n      return true;\n    } catch (error) {\n      toast.error(error.message || \"Failed to return courtesy vehicle\");\n      return false;\n    }\n  };\n\n  // Generate job sheet share link\n  const handleGenerateJobSheet = async () => {\n    const caseId = selectedCase?.id || selectedCase?._id;\n    if (!caseId) return;\n    setIsGeneratingJobSheet(true);\n    setShowJobSheetModal(true);\n    try {\n      const res = await fetch(`/api/aftercare/${caseId}/job-sheet`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ expiresInDays: 60 }),\n      });\n      const data = await res.json();\n      if (!res.ok) {\n        throw new Error(data.error || \"Failed to generate share link\");\n      }\n      const fullUrl = `${window.location.origin}${data.shareUrl}`;\n      setJobSheetLink(fullUrl);\n      toast.success(\"Job sheet link generated\");\n    } catch (error) {\n      toast.error(error.message || \"Failed to generate share link\");\n      setShowJobSheetModal(false);\n    } finally {\n      setIsGeneratingJobSheet(false);\n    }\n  };\n\n  // Copy job sheet link to clipboard\n  const copyJobSheetLink = () => {\n    if (jobSheetLink) {\n      navigator.clipboard.writeText(jobSheetLink);\n      toast.success(\"Link copied to clipboard\");\n    }\n  };\n\n  // Share job sheet via WhatsApp\n  const shareViaWhatsApp = () => {\n    if (jobSheetLink) {\n      const reg = selectedCase?.regAtPurchase || selectedCase?.currentReg || \"Vehicle\";\n      const text = `Job Sheet for ${reg}: ${jobSheetLink}`;\n      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, \"_blank\");\n    }\n  };\n\n  // Drag handlers - matching Sales & Prep exactly\n  const handleDragStart = (e, caseItem) => {\n    setDraggedCard(caseItem);\n    setDragPosition({ x: e.clientX, y: e.clientY });\n    e.dataTransfer.effectAllowed = \"move\";\n    // Create invisible drag image (we render our own preview)\n    const emptyImg = new Image();\n    emptyImg.src = \"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\";\n    e.dataTransfer.setDragImage(emptyImg, 0, 0);\n  };\n\n  const handleDrag = (e) => {\n    if (e.clientX !== 0 && e.clientY !== 0) {\n      setDragPosition({ x: e.clientX, y: e.clientY });\n    }\n  };\n\n  const handleDragOver = (e) => {\n    e.preventDefault();\n    e.dataTransfer.dropEffect = \"move\";\n  };\n\n  const handleDragEnd = () => {\n    setDraggedCard(null);\n  };\n\n  const handleDrop = async (e, newStatus) => {\n    e.preventDefault();\n    if (!draggedCard || draggedCard.boardStatus === newStatus) {\n      setDraggedCard(null);\n      return;\n    }\n    const caseId = draggedCard.id || draggedCard._id;\n\n    // Optimistic update\n    setCases(prev => prev.map(c =>\n      (c.id || c._id) === caseId ? { ...c, boardStatus: newStatus } : c\n    ));\n\n    try {\n      const res = await fetch(`/api/aftercare/${caseId}`, {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ boardStatus: newStatus }),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to update status\");\n      }\n      toast.success(`Moved to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);\n      // Update local state from response\n      if (data.case) {\n        setCases(prev => prev.map(c =>\n          (c.id || c._id) === caseId ? { ...data.case, id: data.case._id || data.case.id } : c\n        ));\n      } else {\n        fetchCases();\n      }\n    } catch (error) {\n      toast.error(error.message || \"Failed to update\");\n      fetchCases(); // Revert on error\n    }\n    setDraggedCard(null);\n  };\n\n  const handleFileSelect = async (e) => {\n    const files = Array.from(e.target.files);\n    if (files.length === 0) return;\n\n    const uploadedFiles = [];\n    for (const file of files) {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      try {\n        const res = await fetch(\"/api/vehicles/upload\", { method: \"POST\", body: formData });\n        const data = await res.json();\n        if (data.url) {\n          uploadedFiles.push({ url: data.url, filename: data.filename || file.name });\n        }\n      } catch (err) {\n        toast.error(`Failed to upload ${file.name}`);\n      }\n    }\n    setCommentAttachments([...commentAttachments, ...uploadedFiles]);\n  };\n\n  // Upload media to case (not comment)\n  const handleCaseMediaUpload = async (e) => {\n    const files = Array.from(e.target.files);\n    if (files.length === 0 || !selectedCase) return;\n\n    setIsUploadingCaseMedia(true);\n    const uploadedFiles = [];\n\n    for (const file of files) {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      try {\n        const res = await fetch(\"/api/vehicles/upload\", { method: \"POST\", body: formData });\n        const data = await res.json();\n        if (data.url) {\n          uploadedFiles.push({ url: data.url, filename: data.filename || file.name });\n        }\n      } catch (err) {\n        toast.error(`Failed to upload ${file.name}`);\n      }\n    }\n\n    if (uploadedFiles.length > 0) {\n      try {\n        await fetch(`/api/aftercare/${selectedCase.id}`, {\n          method: \"PUT\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ _addAttachments: uploadedFiles }),\n        });\n        toast.success(`${uploadedFiles.length} file(s) added to case`);\n        fetchCaseDetail(selectedCase.id);\n      } catch (err) {\n        toast.error(\"Failed to add media to case\");\n      }\n    }\n\n    setIsUploadingCaseMedia(false);\n    // Reset the input\n    e.target.value = \"\";\n  };\n\n  const addComment = async () => {\n    if (!newComment.trim() && commentAttachments.length === 0) return;\n    try {\n      const res = await fetch(`/api/aftercare/${selectedCase.id}/comments`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          content: newComment || \"(attachment)\",\n          authorType: \"staff\",\n          attachments: commentAttachments\n        }),\n      });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to add comment\");\n      }\n      setNewComment(\"\");\n      setCommentAttachments([]);\n      // Refetch the case to get updated comments and timeline events\n      fetchCaseDetail(selectedCase.id);\n      toast.success(\"Comment added\");\n    } catch (error) {\n      toast.error(error.message || \"Failed to add comment\");\n    }\n  };\n\n  const generateAIReview = async (regenerate = false) => {\n    if (regenerate) {\n      setShowRegenerateConfirm(false);\n    }\n    setIsGeneratingAI(true);\n    try {\n      const res = await fetch(\"/api/ai/case-review\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ caseId: selectedCase.id }),\n      });\n      const data = await res.json();\n      if (!res.ok) throw new Error(data.error || \"Failed to generate\");\n      fetchCaseDetail(selectedCase.id);\n      toast.success(\"AI review generated\");\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsGeneratingAI(false);\n    }\n  };\n\n  // Fetch AI diagnostic suggestions\n  const fetchAIDiagnostics = async () => {\n    if (!selectedCase) return;\n    setIsLoadingDiagnostics(true);\n    setAiDiagnostics(null);\n    try {\n      const vehicle = selectedCase.vehicleId;\n      const res = await fetch(\"/api/ai/warranty-suggestions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          vehicleMake: vehicle?.make,\n          vehicleModel: vehicle?.model,\n          vehicleYear: vehicle?.year,\n          mileage: vehicle?.mileage,\n          fuelType: vehicle?.fuelType,\n          symptomDescription: selectedCase.summary || selectedCase.details?.description || \"\",\n          faultCodes: selectedCase.details?.faultCodes,\n          warrantyType: selectedCase.warrantyType,\n          additionalContext: selectedCase.details ? JSON.stringify(selectedCase.details) : null,\n        }),\n      });\n\n      // Handle auth errors separately\n      if (res.status === 401 || res.status === 403) {\n        setAiDiagnostics({\n          suggestions: null,\n          isDummy: true,\n          errorCode: \"UNAUTHORIZED\",\n          errorMessage: \"Please sign in to use AI features.\",\n        });\n        return;\n      }\n\n      const data = await res.json();\n      if (data.success) {\n        setAiDiagnostics({\n          suggestions: data.suggestions,\n          isDummy: data.isDummy,\n          errorCode: data.isDummy ? \"NOT_CONFIGURED\" : null,\n          errorMessage: data.message,\n        });\n      } else {\n        setAiDiagnostics({\n          suggestions: null,\n          isDummy: true,\n          errorCode: data.errorCode || \"SERVICE_ERROR\",\n          errorMessage: data.error || \"Failed to get AI suggestions\",\n        });\n      }\n    } catch (error) {\n      console.error(\"AI diagnostics error:\", error);\n      setAiDiagnostics({\n        suggestions: null,\n        isDummy: true,\n        errorCode: \"SERVICE_ERROR\",\n        errorMessage: \"Failed to connect to AI service\",\n      });\n    } finally {\n      setIsLoadingDiagnostics(false);\n    }\n  };\n\n  const copyToClipboard = (text, label) => {\n    navigator.clipboard.writeText(text);\n    toast.success(`${label} copied to clipboard`);\n  };\n\n  // Filter cases by search query and filters\n  const getFilteredCases = () => {\n    let filtered = cases;\n\n    // Apply search query filter\n    if (searchQuery.trim()) {\n      const query = searchQuery.toUpperCase().replace(/\\s/g, \"\");\n      filtered = filtered.filter(c => {\n        // Search by VRM\n        const regAtPurchase = (c.regAtPurchase || \"\").toUpperCase().replace(/\\s/g, \"\");\n        const currentReg = (c.currentReg || \"\").toUpperCase().replace(/\\s/g, \"\");\n        const detailsReg = (c.details?.vehicleReg || \"\").toUpperCase().replace(/\\s/g, \"\");\n        // Search by customer name\n        const customerName = (c.contactId?.name || \"\").toUpperCase();\n        return regAtPurchase.includes(query) ||\n               currentReg.includes(query) ||\n               detailsReg.includes(query) ||\n               customerName.includes(query);\n      });\n    }\n\n    // Apply location filter\n    if (filters.location !== \"all\") {\n      filtered = filtered.filter(c => (c.repairLocationType || \"WITH_CUSTOMER\") === filters.location);\n    }\n\n    // Apply booked filter\n    if (filters.booked === \"booked\") {\n      filtered = filtered.filter(c => c.bookedInAt);\n    } else if (filters.booked === \"not_booked\") {\n      filtered = filtered.filter(c => !c.bookedInAt);\n    }\n\n    // Apply parts required filter\n    if (filters.partsRequired === \"yes\") {\n      filtered = filtered.filter(c => c.partsRequired === true);\n    } else if (filters.partsRequired === \"no\") {\n      filtered = filtered.filter(c => !c.partsRequired);\n    }\n\n    // Apply priority filter\n    if (filters.priority !== \"all\") {\n      filtered = filtered.filter(c => (c.priority || \"normal\") === filters.priority);\n    }\n\n    return filtered;\n  };\n\n  // Check if any filters are active\n  const hasActiveFilters = () => {\n    return filters.location !== \"all\" ||\n           filters.booked !== \"all\" ||\n           filters.partsRequired !== \"all\" ||\n           filters.priority !== \"all\";\n  };\n\n  // Clear all filters\n  const clearFilters = () => {\n    setFilters({\n      location: \"all\",\n      booked: \"all\",\n      partsRequired: \"all\",\n      priority: \"all\",\n    });\n  };\n\n  // Get cases by status with sorting\n  const getCasesByStatus = (status) => {\n    const filteredBySearch = getFilteredCases();\n    const filtered = filteredBySearch.filter(c => c.boardStatus === status);\n    const sortOption = columnSortOptions[status] || \"oldest_first\";\n\n    return filtered.sort((a, b) => {\n      if (sortOption === \"newest_first\") {\n        return new Date(b.createdAt) - new Date(a.createdAt);\n      }\n      if (sortOption === \"alphabetical\") {\n        const nameA = a.contactId?.name || \"\";\n        const nameB = b.contactId?.name || \"\";\n        return nameA.localeCompare(nameB);\n      }\n      // oldest_first (default)\n      return new Date(a.createdAt) - new Date(b.createdAt);\n    });\n  };\n\n  // Calculate attachment count for a case\n  const getAttachmentCount = (c) => {\n    const caseAttachments = c.attachments?.length || 0;\n    const submissionAttachments = c.submissionAttachmentCount || 0;\n    const commentAttachments = c.commentAttachmentCount || 0;\n    return caseAttachments + submissionAttachments + commentAttachments;\n  };\n\n  // Get activity count (events count)\n  const getActivityCount = (c) => c.events?.length || 0;\n\n  return (\n    <DashboardLayout>\n      <Head><title>Aftersales/Warranty | DealerFlow</title></Head>\n\n      {/* Hero Header - Modern gradient design */}\n      <div className=\"relative rounded-2xl overflow-hidden mb-6 bg-gradient-to-br from-[#0066CC]/[0.06] via-[#14B8A6]/[0.04] to-[#0EA5E9]/[0.03] border border-slate-100/50\">\n        <div className=\"relative px-6 py-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4\">\n          <div>\n            <div className=\"flex items-center gap-3 mb-2\">\n              <div className=\"w-10 h-10 rounded-xl bg-[#0066CC] flex items-center justify-center shadow-md shadow-[#0066CC]/25\">\n                <svg className=\"w-5 h-5 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z\" />\n                </svg>\n              </div>\n              <h1 className=\"text-2xl md:text-3xl font-bold text-slate-900\">Aftersales / Warranty</h1>\n            </div>\n            <p className=\"text-slate-500 text-sm md:text-base\">Manage warranty cases and aftercare</p>\n          </div>\n          <button\n            className=\"flex items-center justify-center gap-2 px-5 py-2.5 bg-[#0066CC] hover:bg-[#0055AA] text-white font-medium rounded-xl shadow-md shadow-[#0066CC]/25 hover:shadow-lg transition-all\"\n            onClick={() => setShowAddModal(true)}\n          >\n            <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n            </svg>\n            New Case\n          </button>\n        </div>\n      </div>\n\n      {/* Search & Filters Bar */}\n      <div className=\"mb-6 flex flex-col sm:flex-row gap-3\">\n        <div className=\"relative flex-1 max-w-md\">\n          <svg className=\"absolute left-3.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" />\n          </svg>\n          <input\n            type=\"text\"\n            placeholder=\"Search by VRM or customer name...\"\n            className=\"w-full pl-10 pr-10 py-2.5 bg-white border border-slate-200 rounded-xl text-sm placeholder:text-slate-400 focus:border-[#0066CC] focus:ring-2 focus:ring-[#0066CC]/20 outline-none transition-all\"\n            value={searchQuery}\n            onChange={(e) => setSearchQuery(e.target.value)}\n          />\n          {searchQuery && (\n            <button\n              className=\"absolute right-3.5 top-1/2 -translate-y-1/2 w-5 h-5 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-colors\"\n              onClick={() => setSearchQuery(\"\")}\n            >\n              <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          )}\n        </div>\n\n        {/* Filter Button - Mobile opens BottomSheet, Desktop opens dropdown */}\n        <div className=\"relative\">\n          {/* Mobile Filter Button */}\n          <button\n            className={`md:hidden flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all ${\n              hasActiveFilters()\n                ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                : \"bg-white border border-slate-200 text-slate-600 hover:border-[#0066CC] hover:text-[#0066CC]\"\n            }`}\n            onClick={() => setShowMobileFilters(true)}\n          >\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\" />\n            </svg>\n            Filters\n            {hasActiveFilters() && (\n              <span className={`inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold ${\n                hasActiveFilters() ? \"bg-white/20 text-white\" : \"bg-slate-200 text-slate-600\"\n              }`}>\n                {Object.values(filters).filter(v => v !== \"all\").length}\n              </span>\n            )}\n          </button>\n\n          {/* Desktop Filter Button */}\n          <button\n            className={`hidden md:flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all ${\n              hasActiveFilters()\n                ? \"bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25\"\n                : \"bg-white border border-slate-200 text-slate-600 hover:border-[#0066CC] hover:text-[#0066CC]\"\n            }`}\n            onClick={() => setShowFiltersDropdown(!showFiltersDropdown)}\n          >\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\" />\n            </svg>\n            Filters\n            {hasActiveFilters() && (\n              <span className={`inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold ${\n                hasActiveFilters() ? \"bg-white/20 text-white\" : \"bg-slate-200 text-slate-600\"\n              }`}>\n                {Object.values(filters).filter(v => v !== \"all\").length}\n              </span>\n            )}\n          </button>\n\n          {/* Desktop Filter Dropdown */}\n          {showFiltersDropdown && (\n            <div className=\"hidden md:block absolute z-30 mt-2 w-72 bg-white border border-slate-200 rounded-xl shadow-lg p-4\">\n              <div className=\"flex justify-between items-center mb-3\">\n                <h4 className=\"font-semibold text-sm\">Filters</h4>\n                {hasActiveFilters() && (\n                  <button className=\"btn btn-ghost btn-xs\" onClick={clearFilters}>\n                    Clear all\n                  </button>\n                )}\n              </div>\n\n              <div className=\"space-y-3\">\n                {/* Location Filter */}\n                <div className=\"form-control\">\n                  <label className=\"label label-text text-xs py-0\">Location</label>\n                  <select\n                    className=\"select select-bordered select-sm w-full\"\n                    value={filters.location}\n                    onChange={(e) => setFilters({ ...filters, location: e.target.value })}\n                  >\n                    <option value=\"all\">All</option>\n                    <option value=\"WITH_CUSTOMER\">With customer</option>\n                    <option value=\"ON_SITE\">On-site</option>\n                    <option value=\"THIRD_PARTY\">Third-party</option>\n                  </select>\n                </div>\n\n                {/* Booked Filter */}\n                <div className=\"form-control\">\n                  <label className=\"label label-text text-xs py-0\">Booked Status</label>\n                  <select\n                    className=\"select select-bordered select-sm w-full\"\n                    value={filters.booked}\n                    onChange={(e) => setFilters({ ...filters, booked: e.target.value })}\n                  >\n                    <option value=\"all\">All</option>\n                    <option value=\"booked\">Booked</option>\n                    <option value=\"not_booked\">Not Booked</option>\n                  </select>\n                </div>\n\n                {/* Parts Required Filter */}\n                <div className=\"form-control\">\n                  <label className=\"label label-text text-xs py-0\">Parts Required</label>\n                  <select\n                    className=\"select select-bordered select-sm w-full\"\n                    value={filters.partsRequired}\n                    onChange={(e) => setFilters({ ...filters, partsRequired: e.target.value })}\n                  >\n                    <option value=\"all\">All</option>\n                    <option value=\"yes\">Yes</option>\n                    <option value=\"no\">No</option>\n                  </select>\n                </div>\n\n                {/* Priority Filter */}\n                <div className=\"form-control\">\n                  <label className=\"label label-text text-xs py-0\">Priority</label>\n                  <select\n                    className=\"select select-bordered select-sm w-full\"\n                    value={filters.priority}\n                    onChange={(e) => setFilters({ ...filters, priority: e.target.value })}\n                  >\n                    <option value=\"all\">All</option>\n                    <option value=\"low\">Low</option>\n                    <option value=\"normal\">Normal</option>\n                    <option value=\"high\">High</option>\n                    <option value=\"critical\">Critical</option>\n                  </select>\n                </div>\n              </div>\n\n              <button\n                className=\"btn btn-sm btn-block mt-4\"\n                onClick={() => setShowFiltersDropdown(false)}\n              >\n                Apply\n              </button>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Mobile Filters BottomSheet */}\n      <BottomSheet\n        isOpen={showMobileFilters}\n        onClose={() => setShowMobileFilters(false)}\n        title=\"Filters\"\n        footer={\n          <div className=\"flex gap-2\">\n            {hasActiveFilters() && (\n              <button\n                className=\"btn btn-ghost flex-1\"\n                onClick={() => {\n                  clearFilters();\n                  setShowMobileFilters(false);\n                }}\n              >\n                Clear All\n              </button>\n            )}\n            <button\n              className=\"btn btn-primary flex-1\"\n              onClick={() => setShowMobileFilters(false)}\n            >\n              Apply Filters\n            </button>\n          </div>\n        }\n      >\n        <div className=\"space-y-4\">\n          {/* Location Filter */}\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text font-medium\">Location</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              value={filters.location}\n              onChange={(e) => setFilters({ ...filters, location: e.target.value })}\n            >\n              <option value=\"all\">All Locations</option>\n              <option value=\"WITH_CUSTOMER\">With customer</option>\n              <option value=\"ON_SITE\">On-site</option>\n              <option value=\"THIRD_PARTY\">Third-party</option>\n            </select>\n          </div>\n\n          {/* Booked Filter */}\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text font-medium\">Booked Status</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              value={filters.booked}\n              onChange={(e) => setFilters({ ...filters, booked: e.target.value })}\n            >\n              <option value=\"all\">All</option>\n              <option value=\"booked\">Booked</option>\n              <option value=\"not_booked\">Not Booked</option>\n            </select>\n          </div>\n\n          {/* Parts Required Filter */}\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text font-medium\">Parts Required</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              value={filters.partsRequired}\n              onChange={(e) => setFilters({ ...filters, partsRequired: e.target.value })}\n            >\n              <option value=\"all\">All</option>\n              <option value=\"yes\">Yes</option>\n              <option value=\"no\">No</option>\n            </select>\n          </div>\n\n          {/* Priority Filter */}\n          <div className=\"form-control\">\n            <label className=\"label\">\n              <span className=\"label-text font-medium\">Priority</span>\n            </label>\n            <select\n              className=\"select select-bordered w-full\"\n              value={filters.priority}\n              onChange={(e) => setFilters({ ...filters, priority: e.target.value })}\n            >\n              <option value=\"all\">All Priorities</option>\n              <option value=\"low\">Low</option>\n              <option value=\"normal\">Normal</option>\n              <option value=\"high\">High</option>\n              <option value=\"critical\">Critical</option>\n            </select>\n          </div>\n        </div>\n      </BottomSheet>\n\n      {/* Active filters / result count summary */}\n      {(searchQuery || hasActiveFilters()) && (\n        <div className=\"mb-4\">\n          <p className=\"text-sm text-slate-500\">\n            Showing {getFilteredCases().length} of {cases.length} cases\n            {hasActiveFilters() && (\n              <button className=\"ml-2 text-primary hover:underline\" onClick={clearFilters}>\n                Clear filters\n              </button>\n            )}\n          </p>\n        </div>\n      )}\n\n      {isLoading ? (\n        <div className=\"flex justify-center py-20\">\n          <span className=\"loading loading-spinner loading-lg\"></span>\n        </div>\n      ) : (\n        <>\n          {/* Mobile Column Selector */}\n          <MobileStageSelector\n            stages={COLUMNS.map((col) => ({\n              value: col.key,\n              label: col.label,\n              count: getCasesByStatus(col.key).length,\n            }))}\n            activeStage={mobileActiveColumn}\n            onStageChange={setMobileActiveColumn}\n            className=\"mb-4\"\n          />\n\n          {/* Mobile Single Column View */}\n          <div className=\"md:hidden\">\n            {COLUMNS.filter(col => col.key === mobileActiveColumn).map((col) => {\n              const columnCases = getCasesByStatus(col.key);\n              return (\n                <div key={col.key} className=\"space-y-3\">\n                  {columnCases.map((caseItem) => {\n                    const daysOpen = daysSince(caseItem.createdAt);\n                    const priority = caseItem.priority || \"normal\";\n                    const priorityStyle = PRIORITIES[priority] || PRIORITIES.normal;\n                    const locationType = caseItem.repairLocationType || \"WITH_CUSTOMER\";\n                    const locationStyle = REPAIR_LOCATION_STYLES[locationType] || REPAIR_LOCATION_STYLES.WITH_CUSTOMER;\n                    const attachmentCount = (caseItem.submissionAttachmentCount || 0) + (caseItem.commentAttachmentCount || 0);\n                    const activityCount = (caseItem.comments?.length || 0) + (caseItem.events?.length || 0);\n\n                    return (\n                      <div\n                        key={caseItem.id || caseItem._id}\n                        className=\"bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100/50 overflow-hidden active:scale-[0.98]\"\n                        onClick={() => {\n                          const id = caseItem.id || caseItem._id;\n                          fetchCaseDetail(id);\n                        }}\n                      >\n                        <div className={`border-l-4 ${col.accent}`}>\n                          <div className=\"p-4\">\n                            {/* Top row: Reg + badges */}\n                            <div className=\"flex justify-between items-start mb-2\">\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-1.5 flex-wrap\">\n                                  <span className=\"inline-block bg-[#fcd34d] border border-yellow-500/50 rounded-md px-2 py-0.5 shadow-sm font-mono font-bold text-slate-900 text-xs tracking-wider uppercase\">\n                                    {caseItem.regAtPurchase || caseItem.details?.vehicleReg || \"NO REG\"}\n                                  </span>\n                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold ${locationStyle.bg} ${locationStyle.text}`}>\n                                    {REPAIR_LOCATION_LABELS[locationType]}\n                                  </span>\n                                  <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${priorityStyle.bg} ${priorityStyle.text} border ${priorityStyle.border}`}>\n                                    {priority.charAt(0).toUpperCase() + priority.slice(1)}\n                                  </span>\n                                </div>\n                              </div>\n                            </div>\n\n                            {/* Customer name + Vehicle make/model */}\n                            <div className=\"mb-2\">\n                              <p className=\"font-semibold text-slate-900 text-sm truncate\">\n                                {caseItem.contactId?.name || \"Unknown\"}\n                              </p>\n                              {caseItem.vehicleId && (\n                                <p className=\"text-xs text-slate-500\">\n                                  {caseItem.vehicleId.make} {caseItem.vehicleId.model}\n                                </p>\n                              )}\n                            </div>\n\n                            {/* Booked date row */}\n                            {caseItem.bookedInAt && (\n                              <div className=\"flex items-center gap-1 mb-1.5 text-xs text-amber-700\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n                                </svg>\n                                <span className=\"font-medium\">Booked: {formatBookedDate(caseItem.bookedInAt)}</span>\n                              </div>\n                            )}\n\n                            {/* Courtesy badge row */}\n                            {(caseItem.courtesyRequired || caseItem.courtesyAllocationId) && (\n                              <div className=\"flex items-center gap-1 mb-1.5 text-xs\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                {caseItem.courtesyAllocationId ? (\n                                  <span className=\"font-medium text-emerald-700\">\n                                    Courtesy: {caseItem.courtesyAllocation?.courtesyVehicle?.regCurrent || \"Allocated\"}\n                                  </span>\n                                ) : (\n                                  <span className=\"font-medium text-amber-600\">Courtesy needed</span>\n                                )}\n                              </div>\n                            )}\n\n                            {/* Footer row: Days open + icons */}\n                            <div className=\"flex items-center justify-between text-xs text-slate-500\">\n                              <span className=\"font-medium\">{daysOpen}d open</span>\n                              <div className=\"flex items-center gap-2\">\n                                {caseItem.partsRequired && (\n                                  <span className=\"flex items-center gap-0.5 text-orange-600\" title=\"Parts Required\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                    </svg>\n                                  </span>\n                                )}\n                                {attachmentCount > 0 && (\n                                  <span className=\"flex items-center gap-0.5\" title=\"Attachments\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13\" />\n                                    </svg>\n                                    {attachmentCount}\n                                  </span>\n                                )}\n                                {activityCount > 0 && (\n                                  <span className=\"flex items-center gap-0.5\" title=\"Activity\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\n                                    </svg>\n                                    {activityCount}\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                  {columnCases.length === 0 && (\n                    <div className=\"text-center py-12 text-slate-400\">\n                      <p className=\"text-sm\">No cases in {col.label}</p>\n                    </div>\n                  )}\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Mobile Floating Action Button */}\n          <button\n            onClick={() => setShowAddModal(true)}\n            className=\"md:hidden fixed fab-safe right-4 z-40 w-14 h-14 bg-[#0066CC] hover:bg-[#0055AA] text-white rounded-2xl shadow-lg shadow-[#0066CC]/30 flex items-center justify-center transition-all active:scale-95\"\n          >\n            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n            </svg>\n          </button>\n\n          {/* Desktop Multi-Column View - Matching Sales & Prep exactly */}\n          <div className=\"hidden md:flex gap-4 overflow-x-auto pb-6\">\n            {COLUMNS.map((col) => {\n              const columnCases = getCasesByStatus(col.key);\n              return (\n                <div\n                  key={col.key}\n                  data-column-key={col.key}\n                  className={`flex-shrink-0 w-64 bg-gradient-to-b ${col.gradient} to-transparent rounded-2xl p-3 min-h-[400px]`}\n                  onDragOver={handleDragOver}\n                  onDrop={(e) => handleDrop(e, col.key)}\n                >\n                  {/* Integrated Header - Same as Sales & Prep */}\n                  <div className=\"flex items-center justify-between mb-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <h3 className=\"font-semibold text-slate-700 text-sm\">\n                        {col.label}\n                      </h3>\n                      <span className=\"bg-slate-900/10 text-slate-700 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center\">\n                        {columnCases.length}\n                      </span>\n                    </div>\n                    <div className=\"dropdown dropdown-end\">\n                      <label tabIndex={0} className=\"btn btn-ghost btn-xs gap-1 bg-white/30 backdrop-blur-sm hover:bg-white/50 rounded-full\">\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12\" />\n                        </svg>\n                        <span className=\"text-xs\">\n                          {columnSortOptions[col.key] === \"newest_first\" ? \"Newest\" :\n                           columnSortOptions[col.key] === \"alphabetical\" ? \"A-Z\" : \"Oldest\"}\n                        </span>\n                      </label>\n                      <ul tabIndex={0} className=\"dropdown-content z-30 menu p-2 shadow-lg bg-white rounded-xl w-44 mt-2\">\n                        <li>\n                          <button\n                            className={`rounded-lg ${columnSortOptions[col.key] === \"oldest_first\" || !columnSortOptions[col.key] ? \"active bg-slate-100\" : \"\"}`}\n                            onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"oldest_first\" }))}\n                          >\n                            Oldest First\n                          </button>\n                        </li>\n                        <li>\n                          <button\n                            className={`rounded-lg ${columnSortOptions[col.key] === \"newest_first\" ? \"active bg-slate-100\" : \"\"}`}\n                            onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"newest_first\" }))}\n                          >\n                            Newest First\n                          </button>\n                        </li>\n                        <li>\n                          <button\n                            className={`rounded-lg ${columnSortOptions[col.key] === \"alphabetical\" ? \"active bg-slate-100\" : \"\"}`}\n                            onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: \"alphabetical\" }))}\n                          >\n                            Alphabetical (Name)\n                          </button>\n                        </li>\n                      </ul>\n                    </div>\n                  </div>\n\n                  {/* Cards Container */}\n                  <div className=\"space-y-3\">\n                    {columnCases.map((caseItem) => {\n                      const daysOpen = daysSince(caseItem.createdAt);\n                      const attachmentCount = getAttachmentCount(caseItem);\n                      const activityCount = getActivityCount(caseItem);\n                      // Default priority to \"normal\" if missing\n                      const priority = caseItem.priority || \"normal\";\n                      const priorityStyle = PRIORITIES[priority] || PRIORITIES.normal;\n                      // Default location to WITH_CUSTOMER if missing (vehicle starts with customer)\n                      const locationType = caseItem.repairLocationType || \"WITH_CUSTOMER\";\n                      const locationStyle = REPAIR_LOCATION_STYLES[locationType] || REPAIR_LOCATION_STYLES.WITH_CUSTOMER;\n\n                      return (\n                        <div\n                          key={caseItem.id || caseItem._id}\n                          draggable\n                          onDragStart={(e) => handleDragStart(e, caseItem)}\n                          onDrag={handleDrag}\n                          onDragEnd={handleDragEnd}\n                          className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all cursor-grab active:cursor-grabbing border border-slate-100/50 overflow-hidden ${(draggedCard?.id || draggedCard?._id) === (caseItem.id || caseItem._id) ? \"opacity-40 scale-95\" : \"opacity-100\"}`}\n                          onClick={() => fetchCaseDetail(caseItem.id || caseItem._id)}\n                        >\n                          <div className=\"p-3\">\n                            {/* Top row: Reg + badges */}\n                            <div className=\"flex justify-between items-start mb-2\">\n                              <div className=\"flex-1 min-w-0\">\n                                <div className=\"flex items-center gap-1.5 flex-wrap\">\n                                  <span className=\"inline-block bg-[#fcd34d] border border-yellow-500/50 rounded-md px-2 py-0.5 shadow-sm font-mono font-bold text-slate-900 text-xs tracking-wider uppercase\">\n                                    {caseItem.regAtPurchase || caseItem.details?.vehicleReg || \"NO REG\"}\n                                  </span>\n                                  {/* Location badge - always shown */}\n                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold ${locationStyle.bg} ${locationStyle.text}`}>\n                                    {REPAIR_LOCATION_LABELS[locationType]}\n                                  </span>\n                                  {/* Warranty type badge */}\n                                  {caseItem.warrantyType && (\n                                    <span className=\"inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-semibold bg-[#0066CC]/10 text-[#0066CC]\">\n                                      {caseItem.warrantyType === \"Dealer Warranty\" ? \"Dealer\" : \"External\"}\n                                    </span>\n                                  )}\n                                </div>\n                              </div>\n                              {/* Priority badge */}\n                              <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${priorityStyle.bg} ${priorityStyle.text} border ${priorityStyle.border}`}>\n                                {priority.charAt(0).toUpperCase() + priority.slice(1)}\n                              </span>\n                            </div>\n\n                            {/* Customer name + Vehicle make/model */}\n                            <div className=\"mb-2\">\n                              <p className=\"font-semibold text-slate-900 text-sm truncate\">\n                                {caseItem.contactId?.name || \"Unknown\"}\n                              </p>\n                              {caseItem.vehicleId && (\n                                <p className=\"text-xs text-slate-500\">\n                                  {caseItem.vehicleId.make} {caseItem.vehicleId.model}\n                                </p>\n                              )}\n                              {!caseItem.vehicleId && caseItem.details?.make && (\n                                <p className=\"text-xs text-slate-500\">\n                                  {caseItem.details.make} {caseItem.details.model}\n                                </p>\n                              )}\n                            </div>\n\n                            {/* Booked date row - shown if bookedInAt exists */}\n                            {caseItem.bookedInAt && (\n                              <div className=\"flex items-center gap-1 mb-1.5 text-xs text-amber-700\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n                                </svg>\n                                <span className=\"font-medium\">Booked: {formatBookedDate(caseItem.bookedInAt)}</span>\n                              </div>\n                            )}\n\n                            {/* Courtesy badge row - shown if courtesyRequired or has allocation */}\n                            {(caseItem.courtesyRequired || caseItem.courtesyAllocationId) && (\n                              <div className=\"flex items-center gap-1 mb-1.5 text-xs\">\n                                <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4\" />\n                                </svg>\n                                {caseItem.courtesyAllocationId ? (\n                                  <span className=\"font-medium text-emerald-700\">\n                                    Courtesy: {caseItem.courtesyAllocation?.courtesyVehicle?.regCurrent || \"Allocated\"}\n                                  </span>\n                                ) : (\n                                  <span className=\"font-medium text-amber-600\">Courtesy needed</span>\n                                )}\n                              </div>\n                            )}\n\n                            {/* Footer row: Days open + icons + source */}\n                            <div className=\"flex items-center justify-between text-xs text-slate-500\">\n                              <span className=\"font-medium\">{daysOpen}d open</span>\n                              <div className=\"flex items-center gap-2\">\n                                {caseItem.partsRequired && (\n                                  <span className=\"flex items-center gap-0.5 text-orange-600\" title=\"Parts Required\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z\" />\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                                    </svg>\n                                    Parts\n                                  </span>\n                                )}\n                                {attachmentCount > 0 && (\n                                  <span className=\"flex items-center gap-0.5\" title=\"Attachments\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13\" />\n                                    </svg>\n                                    {attachmentCount}\n                                  </span>\n                                )}\n                                {activityCount > 0 && (\n                                  <span className=\"flex items-center gap-0.5\" title=\"Activity\">\n                                    <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\" />\n                                    </svg>\n                                    {activityCount}\n                                  </span>\n                                )}\n                                {caseItem.source === \"warranty_claim_form\" && (\n                                  <span className=\"inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-medium bg-slate-100 text-slate-600\">\n                                    Warranty Claim\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      );\n                    })}\n\n                    {columnCases.length === 0 && (\n                      <div className=\"text-center py-12 text-slate-400\">\n                        <p className=\"text-sm\">No cases in {col.label}</p>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n\n          {/* Drag Preview - floating card that follows cursor (same as Sales & Prep) */}\n          {draggedCard && (\n            <div\n              className=\"fixed pointer-events-none z-50\"\n              style={{\n                left: dragPosition.x - 120,\n                top: dragPosition.y - 30,\n                transform: \"rotate(3deg)\",\n              }}\n            >\n              <div className=\"bg-white rounded-xl shadow-2xl border-2 border-blue-400 w-60 p-3 opacity-90\">\n                <div className=\"flex items-center gap-2\">\n                  <p className=\"font-bold text-slate-900 text-sm truncate\">\n                    {draggedCard.contactId?.name || \"Unknown\"}\n                  </p>\n                </div>\n                <span className=\"inline-block bg-[#fcd34d] border border-yellow-500/50 rounded-md px-2 py-0.5 shadow-sm font-mono font-bold text-slate-900 text-xs tracking-wider uppercase mt-1\">\n                  {draggedCard.regAtPurchase || draggedCard.details?.vehicleReg || \"NO REG\"}\n                </span>\n              </div>\n            </div>\n          )}\n        </>\n      )}\n\n      {/* Case Detail Drawer */}\n      {selectedCase && (\n        <div className=\"fixed inset-0 z-50 flex justify-end\">\n          <div className=\"bg-black/40 absolute inset-0 backdrop-blur-sm\" onClick={() => setSelectedCase(null)}></div>\n          <div className=\"relative bg-white w-full max-w-xl h-full overflow-y-auto shadow-2xl\">\n            {/* Modern Sticky Header */}\n            <div className=\"sticky top-0 bg-white/95 backdrop-blur-md border-b border-slate-200 px-5 py-4 z-10\">\n              <div className=\"flex justify-between items-start gap-3\">\n                {/* Back button on mobile */}\n                <button className=\"md:hidden p-2 -ml-2 rounded-lg hover:bg-slate-100 transition-colors\" onClick={() => setSelectedCase(null)}>\n                  <svg className=\"w-5 h-5 text-slate-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n                  </svg>\n                </button>\n                <div className=\"flex-1 min-w-0\">\n                  {/* VRM + Status Pills Row */}\n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <span className=\"inline-flex items-center bg-amber-100 border border-amber-300 rounded-lg px-3 py-1.5 font-mono font-bold text-slate-900 text-base tracking-wider uppercase shadow-sm\">\n                      {selectedCase.regAtPurchase || selectedCase.details?.vehicleReg || \"NO REG\"}\n                    </span>\n                    {selectedCase.warrantyType && (\n                      <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-slate-100 text-slate-600 border border-slate-200\">\n                        {selectedCase.warrantyType}\n                      </span>\n                    )}\n                    <span className={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold capitalize ${PRIORITIES[selectedCase.priority]?.bg} ${PRIORITIES[selectedCase.priority]?.text} ${PRIORITIES[selectedCase.priority]?.border} border`}>\n                      {selectedCase.priority}\n                    </span>\n                  </div>\n                  <p className=\"text-sm text-slate-500 mt-1.5 truncate\">\n                    {selectedCase.contactId?.name || \"Unknown\"} &middot; {daysSince(selectedCase.createdAt)}d open\n                  </p>\n                </div>\n                <div className=\"hidden md:flex items-center gap-1.5\">\n                  <button\n                    onClick={handleGenerateJobSheet}\n                    className=\"inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors\"\n                    title=\"Share Job Sheet\"\n                  >\n                    <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z\" />\n                    </svg>\n                    Share\n                  </button>\n                  <button\n                    className=\"p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors\"\n                    onClick={() => setSelectedCase(null)}\n                  >\n                    <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                    </svg>\n                  </button>\n                </div>\n              </div>\n\n              {/* Status Segmented Control */}\n              <div className=\"flex gap-2 mt-4\">\n                <div className=\"flex-1 bg-slate-100 rounded-lg p-1 flex\">\n                  {COLUMNS.map(c => (\n                    <button\n                      key={c.key}\n                      onClick={async () => {\n                        if (selectedCase.boardStatus !== c.key) {\n                          await updateCase(\n                            { boardStatus: c.key },\n                            `Moved to ${c.label}`\n                          );\n                        }\n                      }}\n                      className={`flex-1 px-2 py-1.5 text-xs font-medium rounded-md transition-all ${\n                        selectedCase.boardStatus === c.key\n                          ? \"bg-white text-slate-900 shadow-sm\"\n                          : \"text-slate-500 hover:text-slate-700\"\n                      }`}\n                    >\n                      {c.label}\n                    </button>\n                  ))}\n                </div>\n                <div className=\"bg-slate-100 rounded-lg p-1 flex\">\n                  {[\"low\", \"normal\", \"high\", \"critical\"].map(p => (\n                    <button\n                      key={p}\n                      onClick={async () => {\n                        if (selectedCase.priority !== p) {\n                          await updateCase({ priority: p }, \"Priority updated\");\n                        }\n                      }}\n                      className={`px-2 py-1.5 text-xs font-medium rounded-md capitalize transition-all ${\n                        selectedCase.priority === p\n                          ? `${PRIORITIES[p]?.bg} ${PRIORITIES[p]?.text} shadow-sm`\n                          : \"text-slate-400 hover:text-slate-600\"\n                      }`}\n                    >\n                      {p === \"critical\" ? \"!\" : p.charAt(0).toUpperCase()}\n                    </button>\n                  ))}\n                </div>\n              </div>\n            </div>\n\n            <div className=\"px-5 py-4 space-y-4\">\n              {/* Customer & Vehicle Section */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Customer & Vehicle</h3>\n                </div>\n                <div className=\"p-4\">\n                  <div className=\"grid grid-cols-2 gap-x-4 gap-y-3 text-sm\">\n                    <div>\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Name</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.contactId?.name || \"—\"}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Phone</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.contactId?.phone || \"—\"}</p>\n                    </div>\n                    <div className=\"col-span-2\">\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Email</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.contactId?.email || \"—\"}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Reg at Purchase</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.regAtPurchase || \"—\"}</p>\n                    </div>\n                    <div>\n                      <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Current Reg</span>\n                      <p className=\"text-slate-900 mt-0.5\">{selectedCase.currentReg || selectedCase.details?.vehicleReg || \"—\"}</p>\n                    </div>\n                    {selectedCase.vehicleId && (\n                      <>\n                        <div className=\"col-span-2\">\n                          <span className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Vehicle</span>\n                          <p className=\"text-slate-900 mt-0.5\">\n                            {selectedCase.vehicleId.make} {selectedCase.vehicleId.model} {selectedCase.vehicleId.year}\n                          </p>\n                        </div>\n                        <div className=\"col-span-2 pt-1\">\n                          <button\n                            className=\"inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-[#0066CC] bg-[#0066CC]/5 hover:bg-[#0066CC]/10 border border-[#0066CC]/20 rounded-lg transition-colors\"\n                            onClick={() => {\n                              setSelectedVehicleId(selectedCase.vehicleId._id || selectedCase.vehicleId.id);\n                              setIsVehicleDrawerOpen(true);\n                            }}\n                          >\n                            <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\n                            </svg>\n                            View Vehicle\n                          </button>\n                        </div>\n                      </>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Repair Location Section */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Repair Location</h3>\n                  <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${REPAIR_LOCATION_STYLES[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]?.bg} ${REPAIR_LOCATION_STYLES[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]?.text}`}>\n                    {REPAIR_LOCATION_LABELS[selectedCase.repairLocationType || \"WITH_CUSTOMER\"]}\n                  </span>\n                </div>\n                <div className=\"p-4 space-y-4\">\n                  {/* Location Type Segmented Control */}\n                  <div>\n                    <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-2 block\">Location Type</label>\n                    <div className=\"bg-slate-100 rounded-lg p-1 flex\">\n                      {[\n                        { key: \"WITH_CUSTOMER\", label: \"With Customer\", icon: \"🏠\" },\n                        { key: \"ON_SITE\", label: \"On-site\", icon: \"🏢\" },\n                        { key: \"THIRD_PARTY\", label: \"Third-party\", icon: \"🔧\" },\n                      ].map(loc => (\n                        <button\n                          key={loc.key}\n                          onClick={async () => {\n                            if ((selectedCase.repairLocationType || \"WITH_CUSTOMER\") !== loc.key) {\n                              const oldValue = selectedCase.repairLocationType || \"WITH_CUSTOMER\";\n                              await updateCase({\n                                repairLocationType: loc.key,\n                                _eventType: \"LOCATION_UPDATED\",\n                                _eventMetadata: { fromLocation: oldValue, toLocation: loc.key }\n                              }, \"Repair location updated\");\n                            }\n                          }}\n                          className={`flex-1 px-2 py-2 text-xs font-medium rounded-md transition-all flex items-center justify-center gap-1 ${\n                            (selectedCase.repairLocationType || \"WITH_CUSTOMER\") === loc.key\n                              ? `${REPAIR_LOCATION_STYLES[loc.key]?.bg} ${REPAIR_LOCATION_STYLES[loc.key]?.text} shadow-sm`\n                              : \"text-slate-500 hover:text-slate-700\"\n                          }`}\n                        >\n                          <span>{loc.icon}</span>\n                          <span className=\"hidden sm:inline\">{loc.label}</span>\n                        </button>\n                      ))}\n                    </div>\n                  </div>\n\n                  {/* Show additional fields for third-party repairs */}\n                  {selectedCase.repairLocationType === \"THIRD_PARTY\" && (\n                    <div className=\"space-y-3 pt-2 border-t border-slate-100\">\n                      <div>\n                        <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Garage Name</label>\n                        <input\n                          type=\"text\"\n                          className=\"w-full px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm\"\n                          value={selectedCase.repairLocationName || \"\"}\n                          placeholder=\"e.g., ABC Motors\"\n                          onChange={(e) => setSelectedCase({ ...selectedCase, repairLocationName: e.target.value })}\n                          onBlur={() => updateCase({ repairLocationName: selectedCase.repairLocationName })}\n                        />\n                      </div>\n\n                      <div>\n                        <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Notes</label>\n                        <textarea\n                          className=\"w-full px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm resize-none\"\n                          rows={2}\n                          value={selectedCase.repairLocationNotes || \"\"}\n                          placeholder=\"Any notes about the repair location...\"\n                          onChange={(e) => setSelectedCase({ ...selectedCase, repairLocationNotes: e.target.value })}\n                          onBlur={() => updateCase({ repairLocationNotes: selectedCase.repairLocationNotes })}\n                        />\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* Booking Section - Accent Styled */}\n              <div className={`rounded-xl border-2 shadow-sm overflow-hidden ${\n                selectedCase.bookedInAt\n                  ? \"bg-emerald-50/50 border-emerald-200\"\n                  : \"bg-amber-50/50 border-amber-200\"\n              }`}>\n                <div className={`px-4 py-3 flex items-center justify-between ${\n                  selectedCase.bookedInAt\n                    ? \"bg-emerald-100/50 border-b border-emerald-200\"\n                    : \"bg-amber-100/50 border-b border-amber-200\"\n                }`}>\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-lg\">{selectedCase.bookedInAt ? \"📅\" : \"⏳\"}</span>\n                    <h3 className=\"text-sm font-semibold text-slate-900\">Booking</h3>\n                  </div>\n                  {selectedCase.bookedInAt ? (\n                    <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700 border border-emerald-200\">\n                      {formatBookedDate(selectedCase.bookedInAt)}\n                    </span>\n                  ) : (\n                    <span className=\"inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700 border border-amber-200\">\n                      Not Booked\n                    </span>\n                  )}\n                </div>\n                <div className=\"p-4\">\n                  <div>\n                    <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Booked Date & Time</label>\n                    <input\n                      type=\"datetime-local\"\n                      className={`w-full px-3 py-2.5 rounded-lg text-slate-900 transition-all outline-none text-sm font-medium ${\n                        selectedCase.bookedInAt\n                          ? \"bg-white border border-emerald-200 focus:ring-2 focus:ring-emerald-500\"\n                          : \"bg-white border border-amber-200 focus:ring-2 focus:ring-amber-500\"\n                      }`}\n                      value={selectedCase.bookedInAt ? new Date(selectedCase.bookedInAt).toISOString().slice(0, 16) : \"\"}\n                      onChange={async (e) => {\n                        const newValue = e.target.value ? new Date(e.target.value).toISOString() : null;\n                        const oldValue = selectedCase.bookedInAt || null;\n                        await updateCase({\n                          bookedInAt: newValue,\n                          _eventType: \"BOOKING_UPDATED\",\n                          _eventMetadata: { oldBookedAt: oldValue, newBookedAt: newValue }\n                        }, newValue ? \"Booking updated\" : null);\n                      }}\n                    />\n                    {selectedCase.bookedInAt && (\n                      <button\n                        className=\"inline-flex items-center gap-1 mt-2 px-2 py-1 text-xs font-medium text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors\"\n                        onClick={async () => {\n                          const oldValue = selectedCase.bookedInAt;\n                          await updateCase({\n                            bookedInAt: null,\n                            _eventType: \"BOOKING_UPDATED\",\n                            _eventMetadata: { oldBookedAt: oldValue, newBookedAt: null }\n                          }, \"Booking cleared\");\n                        }}\n                      >\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                        Clear booking\n                      </button>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* Parts Required Section */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Parts</h3>\n                  {selectedCase.partsRequired && (\n                    <span className=\"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-700\">\n                      Required\n                    </span>\n                  )}\n                </div>\n                <div className=\"p-4 space-y-3\">\n                  <label className=\"flex items-center gap-3 cursor-pointer group\">\n                    <div className=\"relative\">\n                      <input\n                        type=\"checkbox\"\n                        className=\"sr-only peer\"\n                        checked={selectedCase.partsRequired || false}\n                        onChange={async (e) => {\n                          const newValue = e.target.checked;\n                          const oldValue = selectedCase.partsRequired || false;\n                          await updateCase({\n                            partsRequired: newValue,\n                            _eventType: \"PARTS_UPDATED\",\n                            _eventMetadata: { partsRequired: newValue, wasRequired: oldValue }\n                          }, newValue ? \"Parts required marked\" : \"Parts not required\");\n                        }}\n                      />\n                      <div className=\"w-10 h-6 bg-slate-200 rounded-full peer-checked:bg-[#0066CC] transition-colors\"></div>\n                      <div className=\"absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-4\"></div>\n                    </div>\n                    <span className=\"text-sm font-medium text-slate-700 group-hover:text-slate-900\">Parts required</span>\n                  </label>\n\n                  {selectedCase.partsRequired && (\n                    <div className=\"pt-2 border-t border-slate-100\">\n                      <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Parts Notes</label>\n                      <textarea\n                        className=\"w-full px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm resize-none\"\n                        rows={2}\n                        value={selectedCase.partsNotes || \"\"}\n                        placeholder=\"List parts needed, order status, etc...\"\n                        onChange={(e) => setSelectedCase({ ...selectedCase, partsNotes: e.target.value })}\n                        onBlur={() => updateCase({\n                          partsNotes: selectedCase.partsNotes,\n                          _eventType: \"PARTS_UPDATED\",\n                          _eventMetadata: { partsNotes: selectedCase.partsNotes }\n                        })}\n                      />\n                    </div>\n                  )}\n                </div>\n              </div>\n\n              {/* Courtesy Car Section */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"text-base\">🚗</span>\n                    <h3 className=\"text-sm font-semibold text-slate-900\">Courtesy Car</h3>\n                  </div>\n                  {selectedCase.courtesyAllocation?.status === \"OUT\" && (\n                    <span className=\"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700\">\n                      Out\n                    </span>\n                  )}\n                </div>\n                <div className=\"p-4 space-y-3\">\n                  {/* Toggle: Courtesy Required */}\n                  <label className=\"flex items-center gap-3 cursor-pointer group\">\n                    <div className=\"relative\">\n                      <input\n                        type=\"checkbox\"\n                        className=\"sr-only peer\"\n                        checked={selectedCase.courtesyRequired || false}\n                        onChange={async (e) => {\n                          const newValue = e.target.checked;\n                          await updateCase({\n                            courtesyRequired: newValue,\n                            _eventType: \"COURTESY_REQUIRED_TOGGLED\",\n                            _eventMetadata: { courtesyRequired: newValue }\n                          }, newValue ? \"Courtesy car marked as required\" : \"Courtesy car not required\");\n                        }}\n                      />\n                      <div className=\"w-10 h-6 bg-slate-200 rounded-full peer-checked:bg-[#0066CC] transition-colors\"></div>\n                      <div className=\"absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-4\"></div>\n                    </div>\n                    <span className=\"text-sm font-medium text-slate-700 group-hover:text-slate-900\">Courtesy car required</span>\n                  </label>\n\n                  {/* Allocation Display / Controls */}\n                  {selectedCase.courtesyAllocation && selectedCase.courtesyAllocation.status === \"OUT\" ? (\n                    <div className=\"bg-emerald-50 border border-emerald-200 rounded-lg p-3 space-y-2\">\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"text-sm font-medium text-emerald-800\">Currently Allocated</span>\n                        <span className=\"inline-flex items-center bg-amber-100 border border-amber-300 rounded-lg px-2 py-0.5 font-mono font-bold text-slate-900 text-xs tracking-wider uppercase\">\n                          {selectedCase.courtesyAllocation.courtesyVehicle?.regCurrent || \"N/A\"}\n                        </span>\n                      </div>\n                      {selectedCase.courtesyAllocation.courtesyVehicle && (\n                        <p className=\"text-xs text-emerald-700\">\n                          {selectedCase.courtesyAllocation.courtesyVehicle.make} {selectedCase.courtesyAllocation.courtesyVehicle.model}\n                        </p>\n                      )}\n                      {selectedCase.courtesyAllocation.dateDueBack && (\n                        <p className=\"text-xs text-emerald-700\">\n                          Due back: {new Date(selectedCase.courtesyAllocation.dateDueBack).toLocaleDateString(\"en-GB\", { day: \"numeric\", month: \"short\" })}\n                        </p>\n                      )}\n                      <button\n                        className=\"inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-emerald-700 bg-emerald-100 hover:bg-emerald-200 border border-emerald-200 rounded-lg transition-colors mt-1\"\n                        onClick={returnCourtesy}\n                      >\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                        Mark as Returned\n                      </button>\n                    </div>\n                  ) : selectedCase.courtesyAllocation && selectedCase.courtesyAllocation.status === \"RETURNED\" ? (\n                    <div className=\"bg-slate-50 border border-slate-200 rounded-lg p-3\">\n                      <div className=\"flex items-center gap-2 text-sm text-slate-600\">\n                        <svg className=\"w-4 h-4 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                        Courtesy car returned\n                        {selectedCase.courtesyAllocation.courtesyVehicle?.regCurrent && (\n                          <span className=\"font-mono text-xs bg-slate-100 px-1.5 py-0.5 rounded\">({selectedCase.courtesyAllocation.courtesyVehicle.regCurrent})</span>\n                        )}\n                      </div>\n                    </div>\n                  ) : selectedCase.courtesyRequired ? (\n                    <div className=\"space-y-2 pt-2 border-t border-slate-100\">\n                      <p className=\"text-xs text-amber-600 font-medium flex items-center gap-1\">\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                        </svg>\n                        No courtesy car allocated yet\n                      </p>\n                      <div>\n                        <label className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5 block\">Select Vehicle</label>\n                        <select\n                          className=\"w-full px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm\"\n                          onFocus={loadCourtesyVehicles}\n                          onChange={(e) => {\n                            if (e.target.value) {\n                              allocateCourtesy(e.target.value);\n                            }\n                          }}\n                          defaultValue=\"\"\n                        >\n                          <option value=\"\" disabled>\n                            {isLoadingCourtesy ? \"Loading...\" : \"Choose courtesy vehicle...\"}\n                          </option>\n                          {courtesyVehicles.map((v) => (\n                            <option key={v._id} value={v._id}>\n                              {v.regCurrent} - {v.make} {v.model}\n                            </option>\n                          ))}\n                          {courtesyVehicles.length === 0 && !isLoadingCourtesy && (\n                            <option value=\"\" disabled>No courtesy vehicles available</option>\n                          )}\n                        </select>\n                      </div>\n                    </div>\n                  ) : null}\n                </div>\n              </div>\n\n              {/* Quick Actions Row */}\n              <div className=\"flex gap-2 flex-wrap\">\n                {selectedCase.aiReview?.payload ? (\n                  <button\n                    className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors\"\n                    onClick={() => setShowRegenerateConfirm(true)}\n                    disabled={isGeneratingAI}\n                  >\n                    {isGeneratingAI ? (\n                      <span className=\"w-4 h-4 border-2 border-slate-300 border-t-slate-600 rounded-full animate-spin\"></span>\n                    ) : (\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                      </svg>\n                    )}\n                    Regenerate AI\n                  </button>\n                ) : (\n                  <button\n                    className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-white bg-[#0066CC] hover:bg-[#0055BB] rounded-lg transition-colors shadow-sm\"\n                    onClick={() => generateAIReview()}\n                    disabled={isGeneratingAI}\n                  >\n                    {isGeneratingAI ? (\n                      <span className=\"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin\"></span>\n                    ) : (\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" />\n                      </svg>\n                    )}\n                    Generate AI Review\n                  </button>\n                )}\n                <button\n                  className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                  disabled={!selectedCase.aiReview?.payload?.draftCustomerReply}\n                  onClick={() => copyToClipboard(selectedCase.aiReview?.payload?.draftCustomerReply, \"Customer reply\")}\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                  </svg>\n                  Customer Reply\n                </button>\n                <button\n                  className=\"inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-slate-600 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n                  disabled={!selectedCase.aiReview?.payload?.draftInternalNote}\n                  onClick={() => copyToClipboard(selectedCase.aiReview?.payload?.draftInternalNote, \"Internal note\")}\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                  </svg>\n                  Internal Note\n                </button>\n              </div>\n\n              {/* AI Case Review Panel */}\n              {selectedCase.aiReview?.payload ? (\n                <div className=\"bg-[#0066CC]/5/50 rounded-xl border border-[#0066CC]/20 overflow-hidden\">\n                  <div className=\"px-4 py-3 border-b border-[#0066CC]/10 flex justify-between items-center bg-[#0066CC]/8\">\n                    <h3 className=\"text-sm font-semibold text-[#0055BB] flex items-center gap-2\">\n                      <span>🤖</span> AI Case Review\n                    </h3>\n                    <span className=\"text-xs text-[#0066CC]\">\n                      Generated {relativeTime(selectedCase.aiReview.generatedAt)}\n                    </span>\n                  </div>\n                  <div className=\"p-4 space-y-4\">\n                    {/* Summary */}\n                    <div>\n                      <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5\">Summary</h4>\n                      <p className=\"text-sm text-slate-700\">{selectedCase.aiReview.payload.summary}</p>\n                    </div>\n\n                    {/* Possible Causes */}\n                    {selectedCase.aiReview.payload.possibleCauses?.length > 0 && (\n                      <div>\n                        <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5\">Possible Causes</h4>\n                        <ul className=\"text-sm text-slate-700 list-disc list-inside space-y-1\">\n                          {selectedCase.aiReview.payload.possibleCauses.map((cause, i) => (\n                            <li key={i}>{cause}</li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n\n                    {/* Recommended Steps */}\n                    {selectedCase.aiReview.payload.recommendedSteps?.length > 0 && (\n                      <div>\n                        <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5\">Recommended Next Steps</h4>\n                        <ol className=\"text-sm text-slate-700 list-decimal list-inside space-y-1\">\n                          {selectedCase.aiReview.payload.recommendedSteps.map((step, i) => (\n                            <li key={i}>{step}</li>\n                          ))}\n                        </ol>\n                      </div>\n                    )}\n\n                    {/* Warranty Considerations */}\n                    {selectedCase.aiReview.payload.warrantyConsiderations?.length > 0 && (\n                      <div>\n                        <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide mb-1.5\">Warranty Considerations</h4>\n                        <ul className=\"text-sm text-slate-700 list-disc list-inside space-y-1\">\n                          {selectedCase.aiReview.payload.warrantyConsiderations.map((item, i) => (\n                            <li key={i}>{item}</li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n\n                    {/* Draft Customer Reply */}\n                    {selectedCase.aiReview.payload.draftCustomerReply && (\n                      <div>\n                        <div className=\"flex justify-between items-center mb-1.5\">\n                          <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Draft Customer Reply</h4>\n                          <button\n                            className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0066CC] hover:text-[#0066CC] hover:bg-[#0066CC]/10 rounded transition-colors\"\n                            onClick={() => copyToClipboard(selectedCase.aiReview.payload.draftCustomerReply, \"Customer reply\")}\n                          >\n                            <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                            </svg>\n                            Copy\n                          </button>\n                        </div>\n                        <p className=\"text-sm bg-white p-3 rounded-lg border border-[#0066CC]/10 whitespace-pre-wrap text-slate-700\">\n                          {selectedCase.aiReview.payload.draftCustomerReply}\n                        </p>\n                      </div>\n                    )}\n\n                    {/* Draft Internal Note */}\n                    {selectedCase.aiReview.payload.draftInternalNote && (\n                      <div>\n                        <div className=\"flex justify-between items-center mb-1.5\">\n                          <h4 className=\"text-xs font-medium text-slate-500 uppercase tracking-wide\">Draft Internal Note</h4>\n                          <button\n                            className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-[#0066CC] hover:text-[#0066CC] hover:bg-[#0066CC]/10 rounded transition-colors\"\n                            onClick={() => copyToClipboard(selectedCase.aiReview.payload.draftInternalNote, \"Internal note\")}\n                          >\n                            <svg className=\"w-3 h-3\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                            </svg>\n                            Copy\n                          </button>\n                        </div>\n                        <p className=\"text-sm bg-white p-3 rounded-lg border border-[#0066CC]/10 whitespace-pre-wrap text-slate-700\">\n                          {selectedCase.aiReview.payload.draftInternalNote}\n                        </p>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              ) : (\n                <div className=\"bg-slate-50 rounded-xl border border-slate-200 p-6 text-center\">\n                  <div className=\"w-10 h-10 mx-auto mb-3 rounded-full bg-slate-100 flex items-center justify-center text-lg\">\n                    🤖\n                  </div>\n                  <p className=\"text-sm text-slate-500\">\n                    Click \"Generate AI Review\" to get AI-powered analysis of this case.\n                  </p>\n                </div>\n              )}\n\n              {/* AI Diagnostics Panel */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">AI Diagnostics</h3>\n                  <button\n                    className=\"inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-md transition-colors\"\n                    onClick={fetchAIDiagnostics}\n                    disabled={isLoadingDiagnostics}\n                  >\n                    {isLoadingDiagnostics ? (\n                      <span className=\"w-3.5 h-3.5 border-2 border-slate-300 border-t-slate-600 rounded-full animate-spin\"></span>\n                    ) : aiDiagnostics ? (\n                      <>\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\" />\n                        </svg>\n                        Refresh\n                      </>\n                    ) : (\n                      <>\n                        <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z\" />\n                        </svg>\n                        Get Suggestions\n                      </>\n                    )}\n                  </button>\n                </div>\n                {(aiDiagnostics || isLoadingDiagnostics) && (\n                  <AISuggestionsPanel\n                    suggestions={aiDiagnostics?.suggestions}\n                    isLoading={isLoadingDiagnostics}\n                    isDummy={aiDiagnostics?.isDummy}\n                    onCopyToNotes={(text) => {\n                      setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);\n                      toast.success(\"Added to comment draft\");\n                    }}\n                  />\n                )}\n              </div>\n\n              {/* Issue Summary */}\n              {selectedCase.summary && (\n                <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                  <div className=\"px-4 py-3 border-b border-slate-100\">\n                    <h3 className=\"text-sm font-semibold text-slate-900\">Issue Summary</h3>\n                  </div>\n                  <div className=\"p-4\">\n                    <p className=\"text-sm text-slate-700 whitespace-pre-wrap\">{selectedCase.summary}</p>\n                  </div>\n                </div>\n              )}\n\n              {/* Attachments/Media */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100 flex items-center justify-between\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">\n                    Attachments {(selectedCase.attachments?.length || 0) > 0 && (\n                      <span className=\"ml-1 text-slate-400 font-normal\">({selectedCase.attachments.length})</span>\n                    )}\n                  </h3>\n                  <label className=\"inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-md transition-colors cursor-pointer\">\n                    {isUploadingCaseMedia ? (\n                      <span className=\"w-3.5 h-3.5 border-2 border-slate-300 border-t-slate-600 rounded-full animate-spin\"></span>\n                    ) : (\n                      <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                      </svg>\n                    )}\n                    Add Media\n                    <input\n                      type=\"file\"\n                      multiple\n                      accept=\"image/*,video/*,.pdf\"\n                      className=\"hidden\"\n                      onChange={handleCaseMediaUpload}\n                      disabled={isUploadingCaseMedia}\n                    />\n                  </label>\n                </div>\n                <div className=\"p-4\">\n                  {selectedCase.attachments?.length > 0 ? (\n                    <div className=\"grid grid-cols-3 gap-2\">\n                      {selectedCase.attachments.map((att, i) => (\n                        <a\n                          key={i}\n                          href={att.url}\n                          target=\"_blank\"\n                          rel=\"noopener noreferrer\"\n                          className=\"block aspect-square bg-slate-100 rounded-lg overflow-hidden hover:ring-2 hover:ring-blue-500 transition-all\"\n                        >\n                          {att.url.match(/\\.(jpg|jpeg|png|gif|webp)$/i) ? (\n                            <img src={att.url} alt={att.filename} className=\"w-full h-full object-cover\" />\n                          ) : att.url.match(/\\.(mp4|webm|mov)$/i) ? (\n                            <div className=\"w-full h-full flex items-center justify-center bg-slate-200\">\n                              <svg className=\"w-8 h-8 text-slate-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z\" />\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                              </svg>\n                            </div>\n                          ) : (\n                            <div className=\"w-full h-full flex flex-col items-center justify-center bg-slate-100 p-2\">\n                              <svg className=\"w-6 h-6 text-slate-400 mb-1\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n                              </svg>\n                              <span className=\"text-xs text-slate-500 text-center truncate w-full\">{att.filename}</span>\n                            </div>\n                          )}\n                        </a>\n                      ))}\n                    </div>\n                  ) : (\n                    <p className=\"text-sm text-slate-500 text-center py-2\">No attachments yet. Click \"Add Media\" to upload photos or documents.</p>\n                  )}\n                </div>\n              </div>\n\n              {/* Timeline */}\n              <div className=\"bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden\">\n                <div className=\"px-4 py-3 border-b border-slate-100\">\n                  <h3 className=\"text-sm font-semibold text-slate-900\">Timeline</h3>\n                </div>\n                <div className=\"p-4\">\n                  {/* Event-driven timeline (newest first) with grouping */}\n                  <div className=\"space-y-3 mb-4\">\n                    {groupTimelineEvents(selectedCase.events || []).map((item, idx) => {\n                      // Handle grouped STATUS_CHANGED events\n                      if (item.isGroup && item.type === \"STATUS_CHANGED_GROUP\") {\n                        const isExpanded = expandedTimelineGroups[idx];\n                        const lastEvent = item.events[0]; // Most recent in group\n\n                        // If only one event in group, render normally\n                        if (item.events.length === 1) {\n                          const event = item.events[0];\n                          return (\n                            <div key={idx} className=\"flex gap-3 items-start opacity-70\">\n                              <div className=\"text-base text-slate-400\" title={event.type}>\n                                {EVENT_ICONS.STATUS_CHANGED}\n                              </div>\n                              <div className=\"flex-1 min-w-0\">\n                                <p className=\"text-xs text-slate-500\">{event.summary || \"Status changed\"}</p>\n                                <p className=\"text-xs text-slate-400\" title={new Date(event.createdAt).toLocaleString()}>\n                                  {relativeTime(event.createdAt)}\n                                  {event.createdByName && <span className=\"ml-1\">by {event.createdByName}</span>}\n                                </p>\n                              </div>\n                            </div>\n                          );\n                        }\n\n                        return (\n                          <div key={idx} className=\"border border-slate-200 rounded-lg p-2 bg-slate-50/50\">\n                            <button\n                              className=\"flex gap-3 items-start w-full text-left\"\n                              onClick={() => setExpandedTimelineGroups(prev => ({ ...prev, [idx]: !prev[idx] }))}\n                            >\n                              <div className=\"text-base text-slate-400\" title=\"Multiple status changes\">\n                                {EVENT_ICONS.STATUS_CHANGED}\n                              </div>\n                              <div className=\"flex-1 min-w-0\">\n                                <p className=\"text-xs text-slate-600 font-medium\">\n                                  Status updated {item.events.length} times\n                                </p>\n                                <p className=\"text-xs text-slate-400\">\n                                  Last change: {relativeTime(lastEvent.createdAt)}\n                                </p>\n                              </div>\n                              <svg\n                                className={`w-4 h-4 text-slate-400 transition-transform ${isExpanded ? \"rotate-180\" : \"\"}`}\n                                fill=\"none\"\n                                stroke=\"currentColor\"\n                                viewBox=\"0 0 24 24\"\n                              >\n                                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                              </svg>\n                            </button>\n\n                            {isExpanded && (\n                              <div className=\"mt-2 ml-7 space-y-2 border-l-2 border-slate-200 pl-3\">\n                                {item.events.map((event, subIdx) => (\n                                  <div key={subIdx} className=\"text-xs\">\n                                    <p className=\"text-slate-600\">{event.summary || \"Status changed\"}</p>\n                                    <p className=\"text-slate-400\">\n                                      {relativeTime(event.createdAt)}\n                                      {event.createdByName && <span className=\"ml-1\">by {event.createdByName}</span>}\n                                    </p>\n                                  </div>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                        );\n                      }\n\n                      // Handle individual events\n                      const event = item;\n                      const isProminent = event.type === \"COMMENT_ADDED\" || event.type === \"AI_REVIEW_GENERATED\";\n                      const isMinimal = event.type === \"CASE_CREATED\";\n                      const isStatusChange = event.type === \"STATUS_CHANGED\";\n\n                      return (\n                        <div\n                          key={idx}\n                          className={`flex gap-3 items-start ${isStatusChange ? \"opacity-70\" : \"\"} ${isMinimal ? \"opacity-50\" : \"\"}`}\n                        >\n                          <div\n                            className={`${isProminent ? \"text-lg\" : \"text-base\"} ${isStatusChange || isMinimal ? \"text-slate-400\" : \"\"}`}\n                            title={event.type}\n                          >\n                            {EVENT_ICONS[event.type] || \"📌\"}\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            {/* Prominent events (comments, AI reviews) get larger text and preview */}\n                            {isProminent ? (\n                              <>\n                                <p className=\"text-sm font-medium text-slate-900\">{event.summary || event.type.replace(/_/g, \" \")}</p>\n                                {event.type === \"COMMENT_ADDED\" && event.metadata?.content && (\n                                  <p className=\"text-xs text-slate-500 mt-0.5 line-clamp-2\">\n                                    \"{event.metadata.content}\"\n                                  </p>\n                                )}\n                              </>\n                            ) : (\n                              <p className={`${isStatusChange || isMinimal ? \"text-xs text-slate-500\" : \"text-sm text-slate-700\"}`}>\n                                {event.summary || event.type.replace(/_/g, \" \")}\n                              </p>\n                            )}\n                            <p\n                              className={`text-xs ${isStatusChange || isMinimal ? \"text-slate-400\" : \"text-slate-500\"}`}\n                              title={new Date(event.createdAt).toLocaleString()}\n                            >\n                              {relativeTime(event.createdAt)}\n                              {event.createdByName && <span className=\"ml-1\">by {event.createdByName}</span>}\n                            </p>\n                          </div>\n                        </div>\n                      );\n                    })}\n\n                    {(!selectedCase.events || selectedCase.events.length === 0) && (\n                      <p className=\"text-sm text-slate-500\">No timeline events yet.</p>\n                    )}\n                  </div>\n\n                  {/* Comments (legacy display for existing comments) */}\n                  {selectedCase.comments?.length > 0 && (\n                    <div className=\"border-t border-slate-100 pt-3 mt-3\">\n                      <h4 className=\"font-medium text-sm text-slate-900 mb-2\">Comments</h4>\n                      <div className=\"space-y-3\">\n                        {selectedCase.comments.map((comment) => (\n                          <div key={comment.id} className={`p-3 rounded-lg ${\n                            comment.authorType === \"customer\" ? \"bg-[#0066CC]/5 border border-[#0066CC]/10\" : \"bg-slate-50 border border-slate-100\"\n                          }`}>\n                            <div className=\"flex justify-between text-xs text-slate-500 mb-1\">\n                              <span className=\"font-medium\">{comment.authorType === \"customer\" ? \"Customer\" : \"Staff\"}</span>\n                              <span title={new Date(comment.createdAt).toLocaleString()}>\n                                {relativeTime(comment.createdAt)}\n                              </span>\n                            </div>\n                            <p className=\"text-sm text-slate-700\">{comment.content}</p>\n                            {comment.attachments?.length > 0 && (\n                              <div className=\"flex gap-2 mt-2 flex-wrap\">\n                                {comment.attachments.map((att, i) => (\n                                  <a\n                                    key={i}\n                                    href={att.url || att}\n                                    target=\"_blank\"\n                                    rel=\"noopener noreferrer\"\n                                    className=\"inline-flex items-center gap-1 px-2 py-0.5 text-xs font-medium text-slate-600 bg-white border border-slate-200 rounded-md hover:bg-slate-50\"\n                                  >\n                                    📎 {att.filename || \"File\"}\n                                  </a>\n                                ))}\n                              </div>\n                            )}\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Add Comment with Attachment */}\n                  <div className=\"mt-4 pt-3 border-t border-slate-100\">\n                    {commentAttachments.length > 0 && (\n                      <div className=\"flex gap-2 flex-wrap mb-2\">\n                        {commentAttachments.map((att, i) => (\n                          <span key={i} className=\"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-slate-600 bg-slate-100 rounded-md\">\n                            📎 {att.filename}\n                            <button\n                              className=\"text-red-500 hover:text-red-600 ml-0.5\"\n                              onClick={() => setCommentAttachments(commentAttachments.filter((_, j) => j !== i))}\n                            >\n                              ✕\n                            </button>\n                          </span>\n                        ))}\n                      </div>\n                    )}\n                    <div className=\"flex gap-2\">\n                      <input\n                        type=\"text\"\n                        className=\"flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:border-transparent transition-all outline-none text-sm\"\n                        placeholder=\"Add a comment...\"\n                        value={newComment}\n                        onChange={(e) => setNewComment(e.target.value)}\n                        onKeyPress={(e) => e.key === \"Enter\" && addComment()}\n                      />\n                      <input\n                        type=\"file\"\n                        ref={fileInputRef}\n                        className=\"hidden\"\n                        multiple\n                        onChange={handleFileSelect}\n                      />\n                      <button\n                        className=\"p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-colors\"\n                        onClick={() => fileInputRef.current?.click()}\n                        title=\"Attach files\"\n                      >\n                        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13\" />\n                        </svg>\n                      </button>\n                      <button\n                        className=\"px-4 py-2 text-sm font-medium text-white bg-[#0066CC] hover:bg-[#0055BB] rounded-lg transition-colors\"\n                        onClick={addComment}\n                      >\n                        Add\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Regenerate Confirm Modal */}\n      {showRegenerateConfirm && (\n        <div className=\"modal modal-open\">\n          <div className=\"modal-box\">\n            <h3 className=\"font-bold text-lg\">Regenerate AI Review?</h3>\n            <p className=\"py-4\">This will replace the existing AI review with a new one. This action cannot be undone.</p>\n            <div className=\"modal-action\">\n              <button className=\"btn btn-ghost\" onClick={() => setShowRegenerateConfirm(false)}>Cancel</button>\n              <button className=\"btn btn-primary\" onClick={() => generateAIReview(true)}>Regenerate</button>\n            </div>\n          </div>\n          <div className=\"modal-backdrop\" onClick={() => setShowRegenerateConfirm(false)}></div>\n        </div>\n      )}\n\n      {/* Add Case Modal */}\n      {showAddModal && (\n        <AddCaseModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchCases(); }} />\n      )}\n\n      {/* Vehicle Drawer - Stacked over warranty case drawer */}\n      <VehicleDrawer\n        vehicleId={selectedVehicleId}\n        isOpen={isVehicleDrawerOpen}\n        onClose={() => {\n          setIsVehicleDrawerOpen(false);\n          setSelectedVehicleId(null);\n        }}\n        isStacked={true}\n        readOnly={true}\n      />\n\n      {/* Job Sheet Share Modal */}\n      {showJobSheetModal && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-[60]\">\n          <div className=\"bg-white rounded-xl shadow-2xl w-full max-w-md mx-4\">\n            <div className=\"flex items-center justify-between p-4 border-b border-slate-200\">\n              <h3 className=\"text-lg font-bold text-slate-900\">Share Job Sheet</h3>\n              <button\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n                className=\"btn btn-ghost btn-sm btn-circle\"\n              >\n                ✕\n              </button>\n            </div>\n            <div className=\"p-4\">\n              {isGeneratingJobSheet ? (\n                <div className=\"flex flex-col items-center py-8\">\n                  <div className=\"w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3\"></div>\n                  <p className=\"text-slate-600\">Generating share link...</p>\n                </div>\n              ) : jobSheetLink ? (\n                <div className=\"space-y-4\">\n                  <div className=\"bg-slate-50 rounded-lg p-3\">\n                    <p className=\"text-xs text-slate-500 mb-1\">Shareable Link</p>\n                    <p className=\"text-sm font-mono text-slate-900 break-all\">{jobSheetLink}</p>\n                  </div>\n                  <p className=\"text-xs text-slate-500\">\n                    This link expires in 60 days. Anyone with this link can view the job sheet.\n                  </p>\n                  <div className=\"grid grid-cols-2 gap-3\">\n                    <button\n                      onClick={copyJobSheetLink}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\" />\n                      </svg>\n                      Copy Link\n                    </button>\n                    <button\n                      onClick={shareViaWhatsApp}\n                      className=\"btn btn-success btn-sm gap-2 text-white\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path d=\"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z\"/>\n                      </svg>\n                      WhatsApp\n                    </button>\n                    <button\n                      onClick={() => {\n                        const reg = selectedCase?.regAtPurchase || selectedCase?.currentReg || \"Vehicle\";\n                        const subject = `Job Sheet - ${reg}`;\n                        const body = `Here is the warranty job sheet for ${reg}:\\n\\n${jobSheetLink}`;\n                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);\n                      }}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\n                      </svg>\n                      Email\n                    </button>\n                    <button\n                      onClick={() => window.open(jobSheetLink, '_blank')}\n                      className=\"btn btn-outline btn-sm gap-2\"\n                    >\n                      <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z\" />\n                      </svg>\n                      Print / PDF\n                    </button>\n                  </div>\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-slate-500\">\n                  No link generated yet\n                </div>\n              )}\n            </div>\n            <div className=\"flex justify-end p-4 border-t border-slate-200\">\n              <button\n                className=\"btn btn-ghost\"\n                onClick={() => {\n                  setShowJobSheetModal(false);\n                  setJobSheetLink(null);\n                }}\n              >\n                Close\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </DashboardLayout>\n  );\n}\n\nfunction AddCaseModal({ onClose, onSuccess }) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [isUploadingMedia, setIsUploadingMedia] = useState(false);\n  const [mediaAttachments, setMediaAttachments] = useState([]);\n  const [formData, setFormData] = useState({\n    customerName: \"\", customerEmail: \"\", customerPhone: \"\",\n    vehicleReg: \"\", regAtPurchase: \"\", summary: \"\", priority: \"normal\",\n    warrantyType: \"\", mileage: \"\",\n    addressStreet: \"\", addressCity: \"\", addressPostcode: \"\",\n  });\n\n  const handleMediaUpload = async (e) => {\n    const files = Array.from(e.target.files);\n    if (files.length === 0) return;\n    setIsUploadingMedia(true);\n    const uploadedFiles = [];\n    for (const file of files) {\n      const formDataObj = new FormData();\n      formDataObj.append(\"file\", file);\n      try {\n        const res = await fetch(\"/api/vehicles/upload\", { method: \"POST\", body: formDataObj });\n        const data = await res.json();\n        if (data.url) {\n          uploadedFiles.push({ url: data.url, filename: data.filename || file.name });\n        }\n      } catch (err) {\n        toast.error(`Failed to upload ${file.name}`);\n      }\n    }\n    setMediaAttachments([...mediaAttachments, ...uploadedFiles]);\n    setIsUploadingMedia(false);\n    e.target.value = \"\";\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    if (!formData.customerName) return toast.error(\"Customer name required\");\n    setIsLoading(true);\n    try {\n      const payload = {\n        ...formData,\n        source: \"manual\",\n        attachments: mediaAttachments,\n        details: {\n          mileage: formData.mileage,\n          customerAddress: {\n            street: formData.addressStreet,\n            city: formData.addressCity,\n            postcode: formData.addressPostcode,\n          }\n        }\n      };\n      const res = await fetch(\"/api/aftercare\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n      });\n      if (!res.ok) throw new Error(\"Failed to create\");\n      toast.success(\"Case created!\");\n      onSuccess();\n    } catch (error) {\n      toast.error(error.message);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"modal modal-open\">\n      <div className=\"modal-box\">\n        <h3 className=\"font-bold text-lg mb-4\">New Aftercare Case</h3>\n        <form onSubmit={handleSubmit}>\n          <div className=\"form-control mb-3\">\n            <label className=\"label\"><span className=\"label-text\">Customer Name *</span></label>\n            <input type=\"text\" className=\"input input-bordered\" value={formData.customerName}\n              onChange={(e) => setFormData({ ...formData, customerName: e.target.value })} required />\n          </div>\n          <div className=\"grid grid-cols-2 gap-3\">\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Phone</span></label>\n              <input type=\"tel\" className=\"input input-bordered\" value={formData.customerPhone}\n                onChange={(e) => setFormData({ ...formData, customerPhone: e.target.value })} />\n            </div>\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Email</span></label>\n              <input type=\"email\" className=\"input input-bordered\" value={formData.customerEmail}\n                onChange={(e) => setFormData({ ...formData, customerEmail: e.target.value })} />\n            </div>\n          </div>\n          <div className=\"grid grid-cols-2 gap-3 mt-3\">\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Current Reg (If different)</span></label>\n              <input type=\"text\" className=\"input input-bordered uppercase\" value={formData.vehicleReg}\n                onChange={(e) => setFormData({ ...formData, vehicleReg: e.target.value.toUpperCase() })} />\n            </div>\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Reg at Purchase</span></label>\n              <input type=\"text\" className=\"input input-bordered uppercase\" value={formData.regAtPurchase}\n                onChange={(e) => setFormData({ ...formData, regAtPurchase: e.target.value.toUpperCase() })} />\n            </div>\n          </div>\n          <div className=\"grid grid-cols-2 gap-3 mt-3\">\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Priority</span></label>\n              <select className=\"select select-bordered\" value={formData.priority}\n                onChange={(e) => setFormData({ ...formData, priority: e.target.value })}>\n                <option value=\"low\">Low</option>\n                <option value=\"normal\">Normal</option>\n                <option value=\"high\">High</option>\n                <option value=\"critical\">Critical</option>\n              </select>\n            </div>\n            <div className=\"form-control\">\n              <label className=\"label\"><span className=\"label-text\">Warranty Type</span></label>\n              <select className=\"select select-bordered\" value={formData.warrantyType}\n                onChange={(e) => setFormData({ ...formData, warrantyType: e.target.value })}>\n                <option value=\"\">Not specified</option>\n                <option value=\"Dealer Warranty\">Dealer Warranty</option>\n                <option value=\"External Warranty\">External Warranty</option>\n              </select>\n            </div>\n          </div>\n          <div className=\"form-control mt-3\">\n            <label className=\"label\"><span className=\"label-text\">Current Mileage</span></label>\n            <input type=\"number\" className=\"input input-bordered\" placeholder=\"e.g. 45000\"\n              value={formData.mileage}\n              onChange={(e) => setFormData({ ...formData, mileage: e.target.value })} />\n          </div>\n          <div className=\"form-control mt-3\">\n            <label className=\"label\"><span className=\"label-text\">Customer Address</span></label>\n            <input type=\"text\" className=\"input input-bordered mb-2\" placeholder=\"Street address\"\n              value={formData.addressStreet}\n              onChange={(e) => setFormData({ ...formData, addressStreet: e.target.value })} />\n            <div className=\"grid grid-cols-2 gap-2\">\n              <input type=\"text\" className=\"input input-bordered\" placeholder=\"City\"\n                value={formData.addressCity}\n                onChange={(e) => setFormData({ ...formData, addressCity: e.target.value })} />\n              <input type=\"text\" className=\"input input-bordered uppercase\" placeholder=\"Postcode\"\n                value={formData.addressPostcode}\n                onChange={(e) => setFormData({ ...formData, addressPostcode: e.target.value.toUpperCase() })} />\n            </div>\n          </div>\n          <div className=\"form-control mt-3\">\n            <label className=\"label\"><span className=\"label-text\">Issue Summary</span></label>\n            <textarea className=\"textarea textarea-bordered\" value={formData.summary}\n              onChange={(e) => setFormData({ ...formData, summary: e.target.value })}></textarea>\n          </div>\n          <div className=\"form-control mt-3\">\n            <label className=\"label\"><span className=\"label-text\">Photos/Documents</span></label>\n            <div className=\"flex flex-wrap gap-2 mb-2\">\n              {mediaAttachments.map((att, i) => (\n                <div key={i} className=\"relative w-16 h-16 bg-slate-100 rounded overflow-hidden group\">\n                  {att.url.match(/\\.(jpg|jpeg|png|gif|webp)$/i) ? (\n                    <img src={att.url} alt={att.filename} className=\"w-full h-full object-cover\" />\n                  ) : (\n                    <div className=\"w-full h-full flex items-center justify-center text-xs text-slate-500 p-1\">\n                      {att.filename}\n                    </div>\n                  )}\n                  <button\n                    type=\"button\"\n                    className=\"absolute top-0 right-0 bg-red-500 text-white w-4 h-4 text-xs flex items-center justify-center rounded-bl opacity-0 group-hover:opacity-100 transition-opacity\"\n                    onClick={() => setMediaAttachments(mediaAttachments.filter((_, j) => j !== i))}\n                  >\n                    ×\n                  </button>\n                </div>\n              ))}\n            </div>\n            <label className=\"btn btn-outline btn-sm gap-2 w-fit cursor-pointer\">\n              {isUploadingMedia ? (\n                <span className=\"loading loading-spinner loading-xs\"></span>\n              ) : (\n                <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                </svg>\n              )}\n              Add Photos\n              <input\n                type=\"file\"\n                multiple\n                accept=\"image/*,.pdf\"\n                className=\"hidden\"\n                onChange={handleMediaUpload}\n                disabled={isUploadingMedia}\n              />\n            </label>\n          </div>\n          <div className=\"modal-action\">\n            <button type=\"button\" className=\"btn btn-ghost\" onClick={onClose}>Cancel</button>\n            <button type=\"submit\" className=\"btn btn-primary\" disabled={isLoading}>\n              {isLoading ? <span className=\"loading loading-spinner\"></span> : \"Create Case\"}\n            </button>\n          </div>\n        </form>\n      </div>\n      <div className=\"modal-backdrop\" onClick={onClose}></div>\n    </div>\n  );\n}\n","structuredPatch":[{"oldStart":2103,"oldLines":6,"newStart":2103,"newLines":8,"lines":["                     suggestions={aiDiagnostics?.suggestions}","                     isLoading={isLoadingDiagnostics}","                     isDummy={aiDiagnostics?.isDummy}","+                    errorCode={aiDiagnostics?.errorCode}","+                    errorMessage={aiDiagnostics?.errorMessage}","                     onCopyToNotes={(text) => {","                       setNewComment((prev) => prev ? prev + \"\\n\\n\" + text : text);","                       toast.success(\"Added to comment draft\");"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"357a7e99-900f-406a-a8c3-fe952dfb595f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01H2bPqihH63oF8zH8yPReXt","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to also update the warranty-suggestions API to return the errorCode in its response so the frontend can use it. Let me check the current implementation.","signature":"EswCCkYICxgCKkAkTXbw9jsi4WSGNujoVApeqs0SvlxGH3gKzTdLtOXqWYAY5qehZUtZFueONmIgUcgg1tlQZ50RF7/s5IwnUcxhEgxvT1mvWoM2M1n+92YaDOSDwarAuk+HI/FylyIw2162riw1RegAf+a6+GLvYLcKpqGidJ2cbKSjwhb8ZnKWpNIH9eK3oAbTi+xGo8mVKrMBXj+eo02dMstfXBceACvU9CVl6UHM9f77wx9YKdV3h1kmNUWBcOsl3R4i0b28OXvF/dBwJBS4wvloMCgO+zmVRDzsy617RBN+2mJJ4QR3SvMUHBRgEg/P2k1TZd+I5CSM95QpWSVsBgOTxrkhZgSV5PKxTh/RMTh9iRszlgeYSPXDw7SUYn7Dr0bZf+MA0f2DExZvRY9cA99Ad8Cbg0++DoCB8e+VrFE1V5Hr+CFs6pN6gvYYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":893,"cache_read_input_tokens":99110,"cache_creation":{"ephemeral_5m_input_tokens":893,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd92Eb434Y46eRaHKEBr","type":"assistant","uuid":"b266a091-810b-455f-a957-bdf1e4e9a8d9","timestamp":"2025-12-30T15:51:55.676Z"}
{"parentUuid":"b266a091-810b-455f-a957-bdf1e4e9a8d9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01H2bPqihH63oF8zH8yPReXt","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the warranty-suggestions API to also return errorCode in its response:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":893,"cache_read_input_tokens":99110,"cache_creation":{"ephemeral_5m_input_tokens":893,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd92Eb434Y46eRaHKEBr","type":"assistant","uuid":"f6519941-52a8-42da-9e2b-39645d12e4c7","timestamp":"2025-12-30T15:51:56.192Z"}
{"parentUuid":"f6519941-52a8-42da-9e2b-39645d12e4c7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01H2bPqihH63oF8zH8yPReXt","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CGtSHqtDR52KnTue8Mytju","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-suggestions.js","old_string":"  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}","new_string":"  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      errorCode: result.errorCode,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":893,"cache_read_input_tokens":99110,"cache_creation":{"ephemeral_5m_input_tokens":893,"ephemeral_1h_input_tokens":0},"output_tokens":419,"service_tier":"standard"}},"requestId":"req_011CWd92Eb434Y46eRaHKEBr","type":"assistant","uuid":"1da66fee-fa32-4afb-b771-f21c04a096ad","timestamp":"2025-12-30T15:52:01.683Z"}
{"type":"file-history-snapshot","messageId":"1da66fee-fa32-4afb-b771-f21c04a096ad","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"},"libs\\openai.js":{"backupFileName":"a8e7fe417f7ecf06@v1","version":1,"backupTime":"2025-12-30T15:50:12.398Z"},"components\\AISuggestionsPanel.js":{"backupFileName":"9b357355b418cc6f@v1","version":1,"backupTime":"2025-12-30T15:50:35.851Z"},"pages\\warranty.js":{"backupFileName":"a81b4f663f49afea@v1","version":1,"backupTime":"2025-12-30T15:51:31.630Z"},"pages\\api\\ai\\warranty-suggestions.js":{"backupFileName":"5b8ac4e37dc9954c@v1","version":1,"backupTime":"2025-12-30T15:52:02.934Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"1da66fee-fa32-4afb-b771-f21c04a096ad","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CGtSHqtDR52KnTue8Mytju","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-suggestions.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    76→${symptomDescription}\n    77→\n    78→Generate your response as valid JSON with the exact schema specified.`;\n    79→\n    80→  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n    81→\n    82→  if (result.isDummy) {\n    83→    return res.status(200).json({\n    84→      success: true,\n    85→      isDummy: true,\n    86→      errorCode: result.errorCode,\n    87→      message: result.error || \"AI not configured - showing placeholder\",\n    88→      suggestions: result.data,\n    89→    });\n    90→  }\n    91→\n    92→  return res.status(200).json({\n    93→    success: true,\n    94→    isDummy: false,\n    95→    suggestions: result.data,\n    96→  });\n    97→}\n    98→\n    99→export default withDealerContext(handler);\n   100→"}]},"uuid":"0bc058e9-9983-4879-8d95-c20e8bf09192","timestamp":"2025-12-30T15:52:02.926Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-suggestions.js","oldString":"  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}","newString":"  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      errorCode: result.errorCode,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}","originalFile":"/**\n * AI Warranty Suggestions API\n *\n * POST - Generate AI suggestions for warranty/aftercare cases\n * Returns structured JSON with diagnostic guidance\n */\n\nimport { withDealerContext } from \"@/libs/authContext\";\nimport { callOpenAI, UK_DEALER_CONTEXT } from \"@/libs/openai\";\n\nconst SYSTEM_PROMPT = `${UK_DEALER_CONTEXT}\n\nYou are helping diagnose a warranty claim or aftercare issue. Based on the information provided, generate practical diagnostic suggestions.\n\nCRITICAL: You must respond with ONLY valid JSON. No markdown, no code fences, no prose outside the JSON.\nThe JSON must have exactly these 5 keys:\n- suspected_issues: array of {title, why, urgency} where urgency is \"low\", \"med\", or \"high\"\n- checks_to_run: array of {step, tools, time_estimate_mins}\n- questions_for_customer: array of {question, why}\n- parts_to_consider: array of {part, notes}\n- safety_notes: array of {note}\n\nRules:\n- If you don't have enough information, populate questions_for_customer instead of guessing\n- Be practical and cost-conscious (used car dealer context)\n- Time estimates should be realistic workshop times\n- Always include relevant safety considerations\n- Maximum 5 items per array`;\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const {\n    vehicleMake,\n    vehicleModel,\n    vehicleYear,\n    mileage,\n    fuelType,\n    symptomDescription,\n    faultCodes,\n    warrantyType,\n    additionalContext,\n  } = req.body;\n\n  if (!symptomDescription) {\n    return res.status(400).json({ error: \"Symptom description is required\" });\n  }\n\n  // Build context for AI\n  const contextParts = [];\n\n  if (vehicleMake || vehicleModel) {\n    contextParts.push(`Vehicle: ${[vehicleYear, vehicleMake, vehicleModel].filter(Boolean).join(\" \")}`);\n  }\n  if (mileage) {\n    contextParts.push(`Mileage: ${mileage}`);\n  }\n  if (fuelType) {\n    contextParts.push(`Fuel type: ${fuelType}`);\n  }\n  if (warrantyType) {\n    contextParts.push(`Warranty: ${warrantyType}`);\n  }\n  if (faultCodes) {\n    contextParts.push(`Fault codes: ${faultCodes}`);\n  }\n  if (additionalContext) {\n    contextParts.push(`Additional info: ${additionalContext}`);\n  }\n\n  const userPrompt = `Please analyse this warranty/aftercare issue and provide diagnostic suggestions.\n\n${contextParts.length > 0 ? \"VEHICLE & CONTEXT:\\n\" + contextParts.join(\"\\n\") + \"\\n\\n\" : \"\"}REPORTED SYMPTOMS:\n${symptomDescription}\n\nGenerate your response as valid JSON with the exact schema specified.`;\n\n  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}\n\nexport default withDealerContext(handler);\n","structuredPatch":[{"oldStart":83,"oldLines":6,"newStart":83,"newLines":7,"lines":["     return res.status(200).json({","       success: true,","       isDummy: true,","+      errorCode: result.errorCode,","       message: result.error || \"AI not configured - showing placeholder\",","       suggestions: result.data,","     });"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"0bc058e9-9983-4879-8d95-c20e8bf09192","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_015ikRhVpCVRDiuLRyqNvAaj","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me update the appraisal-issue-suggestions.js API as well for consistency:","signature":"EvkBCkYICxgCKkCDsit7vXwCybmiDW04AsUn44Tie6MAVUf+uE5dhjCZ2/IgkgVZ4fMp4ORKO75uIXJYYdFHdrKneYGmR4g4etU3EgwdZO2z+nRVH5ZePNYaDMaeJSA+A/4TNpxGDSIwanbOwztXKAVtnq2AHK6s+k6lY9q1jqKC/nDpV+K+gUFwYXU2hOSjX8e/xw2ECY3jKmHlVvqf0yQq91i6CQPzfH1h33vW7v/sWRNuqxkKw7OFcNo4qcHE1o1GWs+j/S9LCavd+kPcT9SoSc0w7iHs3N72/M2ZbCZDrt4uv6c7InN3qRLuAUfjCU36tTEaAa80EM5jGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":728,"cache_read_input_tokens":100003,"cache_creation":{"ephemeral_5m_input_tokens":728,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd93BcjhjDB8nRTCdjHn","type":"assistant","uuid":"57558fbe-40b6-40f3-9b1e-624ebbaf8f4d","timestamp":"2025-12-30T15:52:07.319Z"}
{"parentUuid":"57558fbe-40b6-40f3-9b1e-624ebbaf8f4d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_015ikRhVpCVRDiuLRyqNvAaj","type":"message","role":"assistant","content":[{"type":"text","text":"Let me also update the appraisal-issue-suggestions.js for consistency:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":728,"cache_read_input_tokens":100003,"cache_creation":{"ephemeral_5m_input_tokens":728,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd93BcjhjDB8nRTCdjHn","type":"assistant","uuid":"e7154bb7-4873-45bb-b403-5770ad901380","timestamp":"2025-12-30T15:52:07.812Z"}
{"parentUuid":"e7154bb7-4873-45bb-b403-5770ad901380","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_015ikRhVpCVRDiuLRyqNvAaj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_015LCEzTSGAFLJZf3MpiQMSD","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-issue-suggestions.js","old_string":"  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}","new_string":"  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      errorCode: result.errorCode,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":728,"cache_read_input_tokens":100003,"cache_creation":{"ephemeral_5m_input_tokens":728,"ephemeral_1h_input_tokens":0},"output_tokens":412,"service_tier":"standard"}},"requestId":"req_011CWd93BcjhjDB8nRTCdjHn","type":"assistant","uuid":"129d11eb-d700-43c9-abc9-0281cef38286","timestamp":"2025-12-30T15:52:12.117Z"}
{"type":"file-history-snapshot","messageId":"129d11eb-d700-43c9-abc9-0281cef38286","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"},"libs\\openai.js":{"backupFileName":"a8e7fe417f7ecf06@v1","version":1,"backupTime":"2025-12-30T15:50:12.398Z"},"components\\AISuggestionsPanel.js":{"backupFileName":"9b357355b418cc6f@v1","version":1,"backupTime":"2025-12-30T15:50:35.851Z"},"pages\\warranty.js":{"backupFileName":"a81b4f663f49afea@v1","version":1,"backupTime":"2025-12-30T15:51:31.630Z"},"pages\\api\\ai\\warranty-suggestions.js":{"backupFileName":"5b8ac4e37dc9954c@v1","version":1,"backupTime":"2025-12-30T15:52:02.934Z"},"pages\\api\\ai\\appraisal-issue-suggestions.js":{"backupFileName":"264b13f531a23f96@v1","version":1,"backupTime":"2025-12-30T15:52:13.361Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"129d11eb-d700-43c9-abc9-0281cef38286","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_015LCEzTSGAFLJZf3MpiQMSD","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-issue-suggestions.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    81→${issueDescription}\n    82→\n    83→Generate your response as valid JSON with the exact schema specified.`;\n    84→\n    85→  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n    86→\n    87→  if (result.isDummy) {\n    88→    return res.status(200).json({\n    89→      success: true,\n    90→      isDummy: true,\n    91→      errorCode: result.errorCode,\n    92→      message: result.error || \"AI not configured - showing placeholder\",\n    93→      suggestions: result.data,\n    94→    });\n    95→  }\n    96→\n    97→  return res.status(200).json({\n    98→    success: true,\n    99→    isDummy: false,\n   100→    suggestions: result.data,\n   101→  });\n   102→}\n   103→\n   104→export default withDealerContext(handler);\n   105→"}]},"uuid":"3a526775-0040-4cb4-9006-c697e537830e","timestamp":"2025-12-30T15:52:13.353Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-issue-suggestions.js","oldString":"  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}","newString":"  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      errorCode: result.errorCode,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}","originalFile":"/**\n * AI Appraisal Issue Suggestions API\n *\n * POST - Generate AI suggestions for vehicle appraisal issues\n * Returns structured JSON with diagnostic guidance\n */\n\nimport { withDealerContext } from \"@/libs/authContext\";\nimport { callOpenAI, UK_DEALER_CONTEXT } from \"@/libs/openai\";\n\nconst SYSTEM_PROMPT = `${UK_DEALER_CONTEXT}\n\nYou are helping assess an issue found during a vehicle appraisal (trade-in or part-exchange). Based on the information provided, generate practical investigation suggestions to help the dealer understand the scope and cost of repairs.\n\nCRITICAL: You must respond with ONLY valid JSON. No markdown, no code fences, no prose outside the JSON.\nThe JSON must have exactly these 5 keys:\n- suspected_issues: array of {title, why, urgency} where urgency is \"low\", \"med\", or \"high\"\n- checks_to_run: array of {step, tools, time_estimate_mins}\n- questions_for_customer: array of {question, why}\n- parts_to_consider: array of {part, notes}\n- safety_notes: array of {note}\n\nRules:\n- Focus on helping the dealer make an informed purchase decision\n- If you don't have enough information, populate questions_for_customer instead of guessing\n- Be practical and cost-conscious (used car dealer context)\n- Time estimates should be realistic workshop times\n- Consider resale implications when assessing urgency\n- Maximum 5 items per array`;\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const {\n    vehicleMake,\n    vehicleModel,\n    vehicleYear,\n    mileage,\n    fuelType,\n    issueCategory,\n    issueSubcategory,\n    issueDescription,\n    faultCodes,\n    additionalContext,\n  } = req.body;\n\n  if (!issueDescription) {\n    return res.status(400).json({ error: \"Issue description is required\" });\n  }\n\n  // Build context for AI\n  const contextParts = [];\n\n  if (vehicleMake || vehicleModel) {\n    contextParts.push(`Vehicle: ${[vehicleYear, vehicleMake, vehicleModel].filter(Boolean).join(\" \")}`);\n  }\n  if (mileage) {\n    contextParts.push(`Mileage: ${mileage}`);\n  }\n  if (fuelType) {\n    contextParts.push(`Fuel type: ${fuelType}`);\n  }\n  if (issueCategory) {\n    const categoryInfo = issueSubcategory\n      ? `${issueCategory} > ${issueSubcategory}`\n      : issueCategory;\n    contextParts.push(`Issue category: ${categoryInfo}`);\n  }\n  if (faultCodes) {\n    contextParts.push(`Fault codes: ${faultCodes}`);\n  }\n  if (additionalContext) {\n    contextParts.push(`Additional info: ${additionalContext}`);\n  }\n\n  const userPrompt = `Please analyse this appraisal issue and provide investigation suggestions to help with the purchase decision.\n\n${contextParts.length > 0 ? \"VEHICLE & CONTEXT:\\n\" + contextParts.join(\"\\n\") + \"\\n\\n\" : \"\"}ISSUE FOUND:\n${issueDescription}\n\nGenerate your response as valid JSON with the exact schema specified.`;\n\n  const result = await callOpenAI(SYSTEM_PROMPT, userPrompt);\n\n  if (result.isDummy) {\n    return res.status(200).json({\n      success: true,\n      isDummy: true,\n      message: result.error || \"AI not configured - showing placeholder\",\n      suggestions: result.data,\n    });\n  }\n\n  return res.status(200).json({\n    success: true,\n    isDummy: false,\n    suggestions: result.data,\n  });\n}\n\nexport default withDealerContext(handler);\n","structuredPatch":[{"oldStart":88,"oldLines":6,"newStart":88,"newLines":7,"lines":["     return res.status(200).json({","       success: true,","       isDummy: true,","+      errorCode: result.errorCode,","       message: result.error || \"AI not configured - showing placeholder\",","       suggestions: result.data,","     });"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"3a526775-0040-4cb4-9006-c697e537830e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WDM1PB3my5LBLJzhqmdwEX","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me also check if there are any other AI API endpoints that need the same treatment:","signature":"Ev8BCkYICxgCKkCLHi62pWrHehwYnkhHST8Dj/faVb5MMwFHP3vMHZMUAwOw2KXXVaNOCnDAaNLH3atH0pAceZiLagKY03QB84pjEgxZglTN7aLnZS65CrgaDOOU13Ngi2pfksEOBiIwmLLJDNDekVFEFwalZpm4UoTGdso8VO7mecPVwWdZMbUBkcpGc1rWKmWmx0b5THfWKmdXLxRgbSH2NlRnb6sgjEZUqveFdFGVNWKdF9MDJVtL09InZHnFj9USPa+avZKfv6BSFUgyU2DVYj0nattmiuxoIt4x1+zNgnnGv64Ege79SYXLP+cdabTLEvpY1k3T5gRbbY+yBqarGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":910,"cache_read_input_tokens":100731,"cache_creation":{"ephemeral_5m_input_tokens":910,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWd93wVhUHYoe9o38zshE","type":"assistant","uuid":"faa799cc-7459-4de2-9b61-ebeb525dca59","timestamp":"2025-12-30T15:52:17.981Z"}
{"parentUuid":"faa799cc-7459-4de2-9b61-ebeb525dca59","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WDM1PB3my5LBLJzhqmdwEX","type":"message","role":"assistant","content":[{"type":"text","text":"Let me check if there are any other AI API endpoints that need updating:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":910,"cache_read_input_tokens":100731,"cache_creation":{"ephemeral_5m_input_tokens":910,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWd93wVhUHYoe9o38zshE","type":"assistant","uuid":"19856fe2-f13d-4f2a-b9be-9a40ed635d26","timestamp":"2025-12-30T15:52:18.416Z"}
{"parentUuid":"19856fe2-f13d-4f2a-b9be-9a40ed635d26","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01WDM1PB3my5LBLJzhqmdwEX","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DdVZKSu9SqiAgBu49CwSw1","name":"Glob","input":{"pattern":"pages/api/ai/*.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":910,"cache_read_input_tokens":100731,"cache_creation":{"ephemeral_5m_input_tokens":910,"ephemeral_1h_input_tokens":0},"output_tokens":100,"service_tier":"standard"}},"requestId":"req_011CWd93wVhUHYoe9o38zshE","type":"assistant","uuid":"faa1885c-8962-48ea-8dd5-a6ba193ffe71","timestamp":"2025-12-30T15:52:19.086Z"}
{"parentUuid":"faa1885c-8962-48ea-8dd5-a6ba193ffe71","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DdVZKSu9SqiAgBu49CwSw1","type":"tool_result","content":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-summary.js\nC:\\Users\\georg\\dealerflow\\pages\\api\\ai\\case-review.js\nC:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-summary.js\nC:\\Users\\georg\\dealerflow\\pages\\api\\ai\\health.js\nC:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-suggestions.js\nC:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-issue-suggestions.js"}]},"uuid":"7ab892db-8bc6-4d71-a3c7-e29252a90758","timestamp":"2025-12-30T15:52:21.064Z","toolUseResult":{"filenames":["C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-summary.js","C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\case-review.js","C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-summary.js","C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\health.js","C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-suggestions.js","C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-issue-suggestions.js"],"durationMs":583,"numFiles":6,"truncated":false}}
{"parentUuid":"7ab892db-8bc6-4d71-a3c7-e29252a90758","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_013HjZhFKb4uZZMxnqje8nvS","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"There are a few more AI endpoints. Let me update them to also include the errorCode:","signature":"EvwBCkYICxgCKkDjlyklfvpWZvFT2vSI8wmYfGBurEH2nR42OXdigRT0tjmeIv4m4f6PBxZTH6hDrpi5lasfBv3j7O5IcachT2oFEgy+qeAROuUzqIwX2VQaDDwE90bJS9ySCzNppCIw0dRTjdsJxxZ8JSiTSu6eMUkAeygZRmWqxI1KZZ2lMQFYqeksBZJNxqDsTxicIvnPKmTfhnKFUnWkmwtXCLCxdate+Q3k5jgCmu7/BukpOr4/cbO6SPttJmZf4DW0fgSzcc2VP+J/6sCwfOYe1FSdBoyUjikci1PLo/KL7jSbJ4+U9SlFm92DrGeEFYpM5XjkY8DH+0QPGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":256,"cache_read_input_tokens":101641,"cache_creation":{"ephemeral_5m_input_tokens":256,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWd94WKerw4944TNqDH3K","type":"assistant","uuid":"e8baf2cc-a902-4d46-81e6-26e5afeff776","timestamp":"2025-12-30T15:52:26.308Z"}
{"parentUuid":"e8baf2cc-a902-4d46-81e6-26e5afeff776","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_013HjZhFKb4uZZMxnqje8nvS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01W8cRBwTBtyuuCkqr4sbfvZ","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\case-review.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":256,"cache_read_input_tokens":101641,"cache_creation":{"ephemeral_5m_input_tokens":256,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWd94WKerw4944TNqDH3K","type":"assistant","uuid":"d7b0cf45-9558-4cfb-b7c3-c605e74fd347","timestamp":"2025-12-30T15:52:27.339Z"}
{"parentUuid":"d7b0cf45-9558-4cfb-b7c3-c605e74fd347","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_013HjZhFKb4uZZMxnqje8nvS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01NqTuXEWkJwsugTTPSHeBXW","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-summary.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":256,"cache_read_input_tokens":101641,"cache_creation":{"ephemeral_5m_input_tokens":256,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWd94WKerw4944TNqDH3K","type":"assistant","uuid":"82e3d42b-6999-4f60-bf16-5ed338d6f602","timestamp":"2025-12-30T15:52:28.253Z"}
{"parentUuid":"82e3d42b-6999-4f60-bf16-5ed338d6f602","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_013HjZhFKb4uZZMxnqje8nvS","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GjmQ54e85TiqDEQqMjFp5F","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-summary.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":256,"cache_read_input_tokens":101641,"cache_creation":{"ephemeral_5m_input_tokens":256,"ephemeral_1h_input_tokens":0},"output_tokens":215,"service_tier":"standard"}},"requestId":"req_011CWd94WKerw4944TNqDH3K","type":"assistant","uuid":"a1ef842f-e139-41c6-994f-4aad810a09f4","timestamp":"2025-12-30T15:52:29.358Z"}
{"parentUuid":"a1ef842f-e139-41c6-994f-4aad810a09f4","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01W8cRBwTBtyuuCkqr4sbfvZ","type":"tool_result","content":"     1→// /pages/api/ai/case-review.js\n     2→\n     3→import connectMongo from \"@/libs/mongoose\";\n     4→import { withDealerContext } from \"@/libs/authContext\";\n     5→import { getOpenAIClient, safeJsonParse } from \"@/libs/openai\";\n     6→\n     7→import AftercareCase from \"@/models/AftercareCase\";\n     8→import AftercareCaseComment from \"@/models/AftercareCaseComment\";\n     9→import Vehicle from \"@/models/Vehicle\";\n    10→import VehicleTask from \"@/models/VehicleTask\";\n    11→import VehicleIssue from \"@/models/VehicleIssue\";\n    12→import FormSubmission from \"@/models/FormSubmission\";\n    13→\n    14→function clampArray(v) {\n    15→  if (!v) return [];\n    16→  if (Array.isArray(v)) return v.filter(Boolean);\n    17→  return [String(v)].filter(Boolean);\n    18→}\n    19→\n    20→async function handler(req, res, ctx) {\n    21→  if (req.method !== \"POST\") return res.status(405).json({ error: \"Method not allowed\" });\n    22→\n    23→  if (!process.env.OPENAI_API_KEY) {\n    24→    return res.status(500).json({\n    25→      error: \"OpenAI not configured. Please set OPENAI_API_KEY in .env.local and restart the server.\",\n    26→    });\n    27→  }\n    28→\n    29→  const openai = getOpenAIClient();\n    30→  if (!openai) {\n    31→    return res.status(500).json({ error: \"OpenAI client not available\" });\n    32→  }\n    33→\n    34→  await connectMongo();\n    35→  const { dealerId, userId } = ctx;\n    36→\n    37→  const { caseId, regenerate = false } = req.body || {};\n    38→  if (!caseId) return res.status(400).json({ error: \"caseId is required\" });\n    39→\n    40→  // Load the aftercare case\n    41→  const aftercareCase = await AftercareCase.findOne({ _id: caseId, dealerId })\n    42→    .populate(\"contactId\", \"name email phone\")\n    43→    .populate(\"vehicleId\", \"make model regCurrent year mileage fuelType engineSize\")\n    44→    .lean();\n    45→\n    46→  if (!aftercareCase) return res.status(404).json({ error: \"Case not found\" });\n    47→\n    48→  // If already generated and not regenerating, return cached\n    49→  if (aftercareCase.aiReview?.payload && !regenerate) {\n    50→    return res.status(200).json({\n    51→      ok: true,\n    52→      cached: true,\n    53→      aiReview: aftercareCase.aiReview,\n    54→    });\n    55→  }\n    56→\n    57→  // Comments (useful context)\n    58→  const comments = await AftercareCaseComment.find({ aftercareCaseId: caseId })\n    59→    .sort({ createdAt: 1 })\n    60→    .lean();\n    61→\n    62→  // If linked to a vehicle, include recent tasks/issues\n    63→  let recentTasks = [];\n    64→  let recentIssues = [];\n    65→  if (aftercareCase.vehicleId?._id) {\n    66→    recentTasks = await VehicleTask.find({ vehicleId: aftercareCase.vehicleId._id })\n    67→      .sort({ updatedAt: -1 })\n    68→      .limit(10)\n    69→      .lean();\n    70→\n    71→    recentIssues = await VehicleIssue.find({ vehicleId: aftercareCase.vehicleId._id })\n    72→      .sort({ updatedAt: -1 })\n    73→      .limit(10)\n    74→      .lean();\n    75→  } else if (aftercareCase.vehicleId) {\n    76→    // In case it wasn't populated correctly for some reason\n    77→    const v = await Vehicle.findById(aftercareCase.vehicleId).lean();\n    78→    if (v?._id) {\n    79→      recentTasks = await VehicleTask.find({ vehicleId: v._id }).sort({ updatedAt: -1 }).limit(10).lean();\n    80→      recentIssues = await VehicleIssue.find({ vehicleId: v._id }).sort({ updatedAt: -1 }).limit(10).lean();\n    81→    }\n    82→  }\n    83→\n    84→  // Linked form submissions (optional)\n    85→  let linkedSubmissions = [];\n    86→  if (aftercareCase.linkedSubmissionIds?.length) {\n    87→    linkedSubmissions = await FormSubmission.find({ _id: { $in: aftercareCase.linkedSubmissionIds } })\n    88→      .populate(\"formId\", \"name\")\n    89→      .lean();\n    90→  }\n    91→\n    92→  const customer = aftercareCase.contactId || {};\n    93→  const vehicle = aftercareCase.vehicleId || {};\n    94→\n    95→  const issueText =\n    96→    aftercareCase.details?.issueDescription ||\n    97→    aftercareCase.issueDescription ||\n    98→    aftercareCase.summary ||\n    99→    aftercareCase.details?.description ||\n   100→    \"No description provided\";\n   101→\n   102→  const daysOpen = Math.floor(\n   103→    (Date.now() - new Date(aftercareCase.createdAt).getTime()) / (1000 * 60 * 60 * 24)\n   104→  );\n   105→\n   106→  const context = {\n   107→    customer: {\n   108→      name: customer.name || \"Unknown\",\n   109→      email: customer.email || null,\n   110→      phone: customer.phone || null,\n   111→    },\n   112→    vehicle: {\n   113→      make: vehicle.make || aftercareCase.details?.vehicleMake || \"Unknown\",\n   114→      model: vehicle.model || aftercareCase.details?.vehicleModel || \"\",\n   115→      reg: aftercareCase.regAtPurchase || vehicle.regCurrent || \"Unknown\",\n   116→      year: vehicle.year || null,\n   117→      mileage: vehicle.mileage || aftercareCase.details?.mileageAtPurchase || null,\n   118→      fuelType: vehicle.fuelType || null,\n   119→      engineSize: vehicle.engineSize || null,\n   120→    },\n   121→    case: {\n   122→      warrantyType: aftercareCase.warrantyType || \"Dealer Warranty\",\n   123→      source: aftercareCase.source || \"Manual\",\n   124→      priority: aftercareCase.priority || \"normal\",\n   125→      status: aftercareCase.boardStatus || \"not_booked_in\",\n   126→      repairLocation: aftercareCase.repairLocationType || \"WITH_CUSTOMER\",\n   127→      partsRequired: !!aftercareCase.partsRequired,\n   128→      partsDetails: aftercareCase.partsDetails || aftercareCase.partsNotes || null,\n   129→      courtesyRequired: !!aftercareCase.courtesyRequired,\n   130→      purchaseDate: aftercareCase.purchaseDate || aftercareCase.details?.dateOfPurchase || null,\n   131→      daysOpen,\n   132→    },\n   133→    issueReported: issueText,\n   134→    recentComments: comments.slice(-6).map((c) => ({\n   135→      text: (c.text || \"\").slice(0, 700),\n   136→      isInternal: !!c.isInternal,\n   137→      createdAt: c.createdAt,\n   138→    })),\n   139→    recentVehicleTasks: recentTasks.slice(0, 10).map((t) => ({\n   140→      name: t.name,\n   141→      status: t.status,\n   142→      notes: t.notes ? String(t.notes).slice(0, 400) : null,\n   143→    })),\n   144→    recentVehicleIssues: recentIssues.slice(0, 10).map((i) => ({\n   145→      category: i.category,\n   146→      subcategory: i.subcategory,\n   147→      description: i.description ? String(i.description).slice(0, 400) : \"\",\n   148→      status: i.status,\n   149→    })),\n   150→    linkedSubmissions: linkedSubmissions.slice(0, 5).map((s) => {\n   151→      const formName = s.formId?.name || \"Form\";\n   152→      const answers = s.rawAnswers && typeof s.rawAnswers === \"object\" ? s.rawAnswers : {};\n   153→      const keyPairs = Object.entries(answers)\n   154→        .filter(([k]) => !k.startsWith(\"_\"))\n   155→        .slice(0, 15)\n   156→        .map(([k, v]) => `${k}: ${typeof v === \"object\" ? JSON.stringify(v) : String(v)}`);\n   157→      return { formName, keyAnswers: keyPairs };\n   158→    }),\n   159→  };\n   160→\n   161→  const prompt = `\n   162→You are an expert automotive aftersales/warranty specialist working for a UK car dealership.\n   163→\n   164→Analyse this aftersales/warranty case and produce guidance that a service advisor can use.\n   165→\n   166→You MUST return valid JSON ONLY (no markdown, no commentary) with EXACTLY these keys:\n   167→{\n   168→  \"summary\": \"2-3 sentence summary of what’s happening and current status\",\n   169→  \"possibleCauses\": [\"2-5 plausible causes, cautious language\"],\n   170→  \"recommendedSteps\": [\"2-6 practical next steps for the dealership\"],\n   171→  \"warrantyConsiderations\": [\"2-5 points about warranty coverage / evidence needed / exclusions\"],\n   172→  \"draftCustomerReply\": \"A short professional UK-tone customer message. Must advise customer not to undertake work without dealer authorisation.\",\n   173→  \"draftInternalNote\": \"Internal staff note summarising facts + what to do next\"\n   174→}\n   175→\n   176→Case context (JSON):\n   177→${JSON.stringify(context, null, 2)}\n   178→\n   179→Rules:\n   180→- Use cautious language: may, could, possible, suggests\n   181→- Be specific to the vehicle and issue where possible\n   182→- Customer reply must be empathetic and must include: do not authorise/undertake repairs without dealer approval\n   183→`.trim();\n   184→\n   185→  try {\n   186→    const completion = await openai.chat.completions.create({\n   187→      model: \"gpt-4o-mini\",\n   188→      messages: [\n   189→        {\n   190→          role: \"system\",\n   191→          content: \"Return JSON only. No markdown. No extra keys.\",\n   192→        },\n   193→        { role: \"user\", content: prompt },\n   194→      ],\n   195→      temperature: 0.4,\n   196→      max_tokens: 1200,\n   197→    });\n   198→\n   199→    const raw = completion.choices?.[0]?.message?.content || \"\";\n   200→    let payload;\n   201→    try {\n   202→      payload = safeJsonParse(raw);\n   203→    } catch (parseError) {\n   204→      console.error(\"AI returned non-JSON:\", raw);\n   205→      return res.status(500).json({ error: \"AI returned invalid JSON. Try again.\" });\n   206→    }\n   207→\n   208→    // normalize / validate shape defensively\n   209→    const normalized = {\n   210→      summary: payload.summary ? String(payload.summary).trim() : \"\",\n   211→      possibleCauses: clampArray(payload.possibleCauses),\n   212→      recommendedSteps: clampArray(payload.recommendedSteps),\n   213→      warrantyConsiderations: clampArray(payload.warrantyConsiderations),\n   214→      draftCustomerReply: payload.draftCustomerReply ? String(payload.draftCustomerReply).trim() : \"\",\n   215→      draftInternalNote: payload.draftInternalNote ? String(payload.draftInternalNote).trim() : \"\",\n   216→    };\n   217→\n   218→    const aiReview = {\n   219→      payload: normalized,\n   220→      generatedAt: new Date(),\n   221→      generatedByUserId: userId,\n   222→      model: \"gpt-4o-mini\",\n   223→    };\n   224→\n   225→    const event = {\n   226→      type: \"AI_REVIEW_GENERATED\",\n   227→      createdAt: new Date(),\n   228→      createdByUserId: userId,\n   229→      summary: \"AI case review generated\",\n   230→    };\n   231→\n   232→    await AftercareCase.updateOne(\n   233→      { _id: caseId, dealerId },\n   234→      {\n   235→        $set: { aiReview },\n   236→        $push: { events: event },\n   237→      }\n   238→    );\n   239→\n   240→    return res.status(200).json({\n   241→      ok: true,\n   242→      cached: false,\n   243→      aiReview,\n   244→    });\n   245→  } catch (err) {\n   246→    console.error(\"OpenAI case-review error:\", err);\n   247→    return res.status(500).json({ error: \"Failed to generate AI review\" });\n   248→  }\n   249→}\n   250→\n   251→export default withDealerContext(handler);\n   252→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ac97a10e-6863-4064-9cd1-999638b1f913","timestamp":"2025-12-30T15:52:33.477Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\case-review.js","content":"// /pages/api/ai/case-review.js\n\nimport connectMongo from \"@/libs/mongoose\";\nimport { withDealerContext } from \"@/libs/authContext\";\nimport { getOpenAIClient, safeJsonParse } from \"@/libs/openai\";\n\nimport AftercareCase from \"@/models/AftercareCase\";\nimport AftercareCaseComment from \"@/models/AftercareCaseComment\";\nimport Vehicle from \"@/models/Vehicle\";\nimport VehicleTask from \"@/models/VehicleTask\";\nimport VehicleIssue from \"@/models/VehicleIssue\";\nimport FormSubmission from \"@/models/FormSubmission\";\n\nfunction clampArray(v) {\n  if (!v) return [];\n  if (Array.isArray(v)) return v.filter(Boolean);\n  return [String(v)].filter(Boolean);\n}\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"POST\") return res.status(405).json({ error: \"Method not allowed\" });\n\n  if (!process.env.OPENAI_API_KEY) {\n    return res.status(500).json({\n      error: \"OpenAI not configured. Please set OPENAI_API_KEY in .env.local and restart the server.\",\n    });\n  }\n\n  const openai = getOpenAIClient();\n  if (!openai) {\n    return res.status(500).json({ error: \"OpenAI client not available\" });\n  }\n\n  await connectMongo();\n  const { dealerId, userId } = ctx;\n\n  const { caseId, regenerate = false } = req.body || {};\n  if (!caseId) return res.status(400).json({ error: \"caseId is required\" });\n\n  // Load the aftercare case\n  const aftercareCase = await AftercareCase.findOne({ _id: caseId, dealerId })\n    .populate(\"contactId\", \"name email phone\")\n    .populate(\"vehicleId\", \"make model regCurrent year mileage fuelType engineSize\")\n    .lean();\n\n  if (!aftercareCase) return res.status(404).json({ error: \"Case not found\" });\n\n  // If already generated and not regenerating, return cached\n  if (aftercareCase.aiReview?.payload && !regenerate) {\n    return res.status(200).json({\n      ok: true,\n      cached: true,\n      aiReview: aftercareCase.aiReview,\n    });\n  }\n\n  // Comments (useful context)\n  const comments = await AftercareCaseComment.find({ aftercareCaseId: caseId })\n    .sort({ createdAt: 1 })\n    .lean();\n\n  // If linked to a vehicle, include recent tasks/issues\n  let recentTasks = [];\n  let recentIssues = [];\n  if (aftercareCase.vehicleId?._id) {\n    recentTasks = await VehicleTask.find({ vehicleId: aftercareCase.vehicleId._id })\n      .sort({ updatedAt: -1 })\n      .limit(10)\n      .lean();\n\n    recentIssues = await VehicleIssue.find({ vehicleId: aftercareCase.vehicleId._id })\n      .sort({ updatedAt: -1 })\n      .limit(10)\n      .lean();\n  } else if (aftercareCase.vehicleId) {\n    // In case it wasn't populated correctly for some reason\n    const v = await Vehicle.findById(aftercareCase.vehicleId).lean();\n    if (v?._id) {\n      recentTasks = await VehicleTask.find({ vehicleId: v._id }).sort({ updatedAt: -1 }).limit(10).lean();\n      recentIssues = await VehicleIssue.find({ vehicleId: v._id }).sort({ updatedAt: -1 }).limit(10).lean();\n    }\n  }\n\n  // Linked form submissions (optional)\n  let linkedSubmissions = [];\n  if (aftercareCase.linkedSubmissionIds?.length) {\n    linkedSubmissions = await FormSubmission.find({ _id: { $in: aftercareCase.linkedSubmissionIds } })\n      .populate(\"formId\", \"name\")\n      .lean();\n  }\n\n  const customer = aftercareCase.contactId || {};\n  const vehicle = aftercareCase.vehicleId || {};\n\n  const issueText =\n    aftercareCase.details?.issueDescription ||\n    aftercareCase.issueDescription ||\n    aftercareCase.summary ||\n    aftercareCase.details?.description ||\n    \"No description provided\";\n\n  const daysOpen = Math.floor(\n    (Date.now() - new Date(aftercareCase.createdAt).getTime()) / (1000 * 60 * 60 * 24)\n  );\n\n  const context = {\n    customer: {\n      name: customer.name || \"Unknown\",\n      email: customer.email || null,\n      phone: customer.phone || null,\n    },\n    vehicle: {\n      make: vehicle.make || aftercareCase.details?.vehicleMake || \"Unknown\",\n      model: vehicle.model || aftercareCase.details?.vehicleModel || \"\",\n      reg: aftercareCase.regAtPurchase || vehicle.regCurrent || \"Unknown\",\n      year: vehicle.year || null,\n      mileage: vehicle.mileage || aftercareCase.details?.mileageAtPurchase || null,\n      fuelType: vehicle.fuelType || null,\n      engineSize: vehicle.engineSize || null,\n    },\n    case: {\n      warrantyType: aftercareCase.warrantyType || \"Dealer Warranty\",\n      source: aftercareCase.source || \"Manual\",\n      priority: aftercareCase.priority || \"normal\",\n      status: aftercareCase.boardStatus || \"not_booked_in\",\n      repairLocation: aftercareCase.repairLocationType || \"WITH_CUSTOMER\",\n      partsRequired: !!aftercareCase.partsRequired,\n      partsDetails: aftercareCase.partsDetails || aftercareCase.partsNotes || null,\n      courtesyRequired: !!aftercareCase.courtesyRequired,\n      purchaseDate: aftercareCase.purchaseDate || aftercareCase.details?.dateOfPurchase || null,\n      daysOpen,\n    },\n    issueReported: issueText,\n    recentComments: comments.slice(-6).map((c) => ({\n      text: (c.text || \"\").slice(0, 700),\n      isInternal: !!c.isInternal,\n      createdAt: c.createdAt,\n    })),\n    recentVehicleTasks: recentTasks.slice(0, 10).map((t) => ({\n      name: t.name,\n      status: t.status,\n      notes: t.notes ? String(t.notes).slice(0, 400) : null,\n    })),\n    recentVehicleIssues: recentIssues.slice(0, 10).map((i) => ({\n      category: i.category,\n      subcategory: i.subcategory,\n      description: i.description ? String(i.description).slice(0, 400) : \"\",\n      status: i.status,\n    })),\n    linkedSubmissions: linkedSubmissions.slice(0, 5).map((s) => {\n      const formName = s.formId?.name || \"Form\";\n      const answers = s.rawAnswers && typeof s.rawAnswers === \"object\" ? s.rawAnswers : {};\n      const keyPairs = Object.entries(answers)\n        .filter(([k]) => !k.startsWith(\"_\"))\n        .slice(0, 15)\n        .map(([k, v]) => `${k}: ${typeof v === \"object\" ? JSON.stringify(v) : String(v)}`);\n      return { formName, keyAnswers: keyPairs };\n    }),\n  };\n\n  const prompt = `\nYou are an expert automotive aftersales/warranty specialist working for a UK car dealership.\n\nAnalyse this aftersales/warranty case and produce guidance that a service advisor can use.\n\nYou MUST return valid JSON ONLY (no markdown, no commentary) with EXACTLY these keys:\n{\n  \"summary\": \"2-3 sentence summary of what’s happening and current status\",\n  \"possibleCauses\": [\"2-5 plausible causes, cautious language\"],\n  \"recommendedSteps\": [\"2-6 practical next steps for the dealership\"],\n  \"warrantyConsiderations\": [\"2-5 points about warranty coverage / evidence needed / exclusions\"],\n  \"draftCustomerReply\": \"A short professional UK-tone customer message. Must advise customer not to undertake work without dealer authorisation.\",\n  \"draftInternalNote\": \"Internal staff note summarising facts + what to do next\"\n}\n\nCase context (JSON):\n${JSON.stringify(context, null, 2)}\n\nRules:\n- Use cautious language: may, could, possible, suggests\n- Be specific to the vehicle and issue where possible\n- Customer reply must be empathetic and must include: do not authorise/undertake repairs without dealer approval\n`.trim();\n\n  try {\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"system\",\n          content: \"Return JSON only. No markdown. No extra keys.\",\n        },\n        { role: \"user\", content: prompt },\n      ],\n      temperature: 0.4,\n      max_tokens: 1200,\n    });\n\n    const raw = completion.choices?.[0]?.message?.content || \"\";\n    let payload;\n    try {\n      payload = safeJsonParse(raw);\n    } catch (parseError) {\n      console.error(\"AI returned non-JSON:\", raw);\n      return res.status(500).json({ error: \"AI returned invalid JSON. Try again.\" });\n    }\n\n    // normalize / validate shape defensively\n    const normalized = {\n      summary: payload.summary ? String(payload.summary).trim() : \"\",\n      possibleCauses: clampArray(payload.possibleCauses),\n      recommendedSteps: clampArray(payload.recommendedSteps),\n      warrantyConsiderations: clampArray(payload.warrantyConsiderations),\n      draftCustomerReply: payload.draftCustomerReply ? String(payload.draftCustomerReply).trim() : \"\",\n      draftInternalNote: payload.draftInternalNote ? String(payload.draftInternalNote).trim() : \"\",\n    };\n\n    const aiReview = {\n      payload: normalized,\n      generatedAt: new Date(),\n      generatedByUserId: userId,\n      model: \"gpt-4o-mini\",\n    };\n\n    const event = {\n      type: \"AI_REVIEW_GENERATED\",\n      createdAt: new Date(),\n      createdByUserId: userId,\n      summary: \"AI case review generated\",\n    };\n\n    await AftercareCase.updateOne(\n      { _id: caseId, dealerId },\n      {\n        $set: { aiReview },\n        $push: { events: event },\n      }\n    );\n\n    return res.status(200).json({\n      ok: true,\n      cached: false,\n      aiReview,\n    });\n  } catch (err) {\n    console.error(\"OpenAI case-review error:\", err);\n    return res.status(500).json({ error: \"Failed to generate AI review\" });\n  }\n}\n\nexport default withDealerContext(handler);\n","numLines":252,"startLine":1,"totalLines":252}}}
{"parentUuid":"ac97a10e-6863-4064-9cd1-999638b1f913","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01NqTuXEWkJwsugTTPSHeBXW","type":"tool_result","content":"     1→import connectMongo from \"@/libs/mongoose\";\n     2→import { withDealerContext } from \"@/libs/authContext\";\n     3→import { getOpenAIClient, safeJsonParse } from \"@/libs/openai\";\n     4→\n     5→// CHANGE THIS import if your model name differs:\n     6→import Appraisal from \"@/models/Appraisal\";\n     7→\n     8→async function handler(req, res, ctx) {\n     9→  if (req.method !== \"POST\") {\n    10→    return res.status(405).json({ error: \"Method not allowed\" });\n    11→  }\n    12→\n    13→  if (!process.env.OPENAI_API_KEY) {\n    14→    return res.status(500).json({\n    15→      error: \"OpenAI not configured. Please set OPENAI_API_KEY in .env.local and restart the server.\",\n    16→    });\n    17→  }\n    18→\n    19→  const openai = getOpenAIClient();\n    20→  if (!openai) {\n    21→    return res.status(500).json({ error: \"OpenAI client not available\" });\n    22→  }\n    23→\n    24→  await connectMongo();\n    25→\n    26→  const { dealerId, userId } = ctx;\n    27→  const { appraisalId, regenerate } = req.body || {};\n    28→\n    29→  if (!appraisalId) {\n    30→    return res.status(400).json({ error: \"appraisalId is required\" });\n    31→  }\n    32→\n    33→  try {\n    34→    const appraisal = await Appraisal.findOne({ _id: appraisalId, dealerId }).lean();\n    35→\n    36→    if (!appraisal) {\n    37→      return res.status(404).json({ error: \"Appraisal not found\" });\n    38→    }\n    39→\n    40→    // Return cached unless regenerate\n    41→    if (appraisal.aiSummary?.payload && !regenerate) {\n    42→      return res.status(200).json({\n    43→        ok: true,\n    44→        summary: appraisal.aiSummary.payload,\n    45→        cached: true,\n    46→        generatedAt: appraisal.aiSummary.generatedAt,\n    47→      });\n    48→    }\n    49→\n    50→    // Build compact input context (adjust field names to match your model)\n    51→    const context = {\n    52→      vrm: appraisal.vrm || appraisal.reg || null,\n    53→      make: appraisal.make || null,\n    54→      model: appraisal.model || null,\n    55→      derivative: appraisal.derivative || null,\n    56→      year: appraisal.year || null,\n    57→      fuel: appraisal.fuel || null,\n    58→      mileage: appraisal.mileage || null,\n    59→      transmission: appraisal.transmission || null,\n    60→      owners: appraisal.owners || null,\n    61→      serviceHistory: appraisal.serviceHistory || appraisal.service || null,\n    62→      motExpiry: appraisal.motExpiry || null,\n    63→      conditionNotes: (appraisal.conditionNotes || appraisal.notes || \"\").slice(0, 2000),\n    64→      // If you store issues/damage from appraisal\n    65→      issues: (appraisal.issues || []).slice(0, 20),\n    66→      photosCount: Array.isArray(appraisal.photos) ? appraisal.photos.length : null,\n    67→      source: appraisal.source || null,\n    68→    };\n    69→\n    70→    const prompt = `You are a UK used car dealer appraisal assistant.\n    71→Return VALID JSON only.\n    72→\n    73→You are helping a dealer decide what to pay for a vehicle and what prep is likely needed.\n    74→Be practical, conservative, and avoid guessing specific prices unless data supports it.\n    75→\n    76→APPRAISAL DATA:\n    77→${JSON.stringify(context, null, 2)}\n    78→\n    79→Respond with JSON:\n    80→{\n    81→  \"overallAssessment\": \"Short paragraph\",\n    82→  \"keyPositives\": [\"0-6 bullets\"],\n    83→  \"keyNegatives\": [\"0-10 bullets\"],\n    84→  \"recommendedChecks\": [\"0-8 bullets\"],\n    85→  \"reconditioningJobs\": [\n    86→    { \"title\": \"Job\", \"why\": \"Reason\", \"roughCostBand\": \"£ | ££ | £££\" }\n    87→  ],\n    88→  \"pricingNotes\": [\"0-6 bullets\"],\n    89→  \"recommendedDecision\": \"BUY | BUY_IF_PRICE_RIGHT | AVOID\",\n    90→  \"confidence\": \"LOW | MED | HIGH\"\n    91→}\n    92→`;\n    93→\n    94→    const completion = await openai.chat.completions.create({\n    95→      model: \"gpt-4o-mini\",\n    96→      messages: [\n    97→        {\n    98→          role: \"system\",\n    99→          content: \"Return JSON only. No markdown. No extra keys.\",\n   100→        },\n   101→        { role: \"user\", content: prompt },\n   102→      ],\n   103→      temperature: 0.6,\n   104→      max_tokens: 1100,\n   105→      response_format: { type: \"json_object\" },\n   106→    });\n   107→\n   108→    const responseText = completion.choices?.[0]?.message?.content || \"\";\n   109→    let aiResponse;\n   110→    try {\n   111→      aiResponse = safeJsonParse(responseText);\n   112→    } catch (parseError) {\n   113→      console.error(\"Failed to parse AI JSON:\", responseText);\n   114→      return res.status(500).json({ error: \"Failed to parse AI response JSON\" });\n   115→    }\n   116→\n   117→    const generatedAt = new Date();\n   118→\n   119→    await Appraisal.updateOne(\n   120→      { _id: appraisalId, dealerId },\n   121→      {\n   122→        $set: {\n   123→          aiSummary: {\n   124→            payload: aiResponse,\n   125→            generatedAt,\n   126→            generatedByUserId: userId,\n   127→          },\n   128→        },\n   129→      }\n   130→    );\n   131→\n   132→    return res.status(200).json({\n   133→      ok: true,\n   134→      summary: aiResponse,\n   135→      cached: false,\n   136→      generatedAt: generatedAt.toISOString(),\n   137→    });\n   138→  } catch (error) {\n   139→    console.error(\"Error generating appraisal summary:\", error);\n   140→    return res.status(500).json({ error: \"Failed to generate summary\" });\n   141→  }\n   142→}\n   143→\n   144→export default withDealerContext(handler);\n   145→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"77afee86-cc5f-4cfb-ae92-75289500fdfe","timestamp":"2025-12-30T15:52:33.478Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\appraisal-summary.js","content":"import connectMongo from \"@/libs/mongoose\";\nimport { withDealerContext } from \"@/libs/authContext\";\nimport { getOpenAIClient, safeJsonParse } from \"@/libs/openai\";\n\n// CHANGE THIS import if your model name differs:\nimport Appraisal from \"@/models/Appraisal\";\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  if (!process.env.OPENAI_API_KEY) {\n    return res.status(500).json({\n      error: \"OpenAI not configured. Please set OPENAI_API_KEY in .env.local and restart the server.\",\n    });\n  }\n\n  const openai = getOpenAIClient();\n  if (!openai) {\n    return res.status(500).json({ error: \"OpenAI client not available\" });\n  }\n\n  await connectMongo();\n\n  const { dealerId, userId } = ctx;\n  const { appraisalId, regenerate } = req.body || {};\n\n  if (!appraisalId) {\n    return res.status(400).json({ error: \"appraisalId is required\" });\n  }\n\n  try {\n    const appraisal = await Appraisal.findOne({ _id: appraisalId, dealerId }).lean();\n\n    if (!appraisal) {\n      return res.status(404).json({ error: \"Appraisal not found\" });\n    }\n\n    // Return cached unless regenerate\n    if (appraisal.aiSummary?.payload && !regenerate) {\n      return res.status(200).json({\n        ok: true,\n        summary: appraisal.aiSummary.payload,\n        cached: true,\n        generatedAt: appraisal.aiSummary.generatedAt,\n      });\n    }\n\n    // Build compact input context (adjust field names to match your model)\n    const context = {\n      vrm: appraisal.vrm || appraisal.reg || null,\n      make: appraisal.make || null,\n      model: appraisal.model || null,\n      derivative: appraisal.derivative || null,\n      year: appraisal.year || null,\n      fuel: appraisal.fuel || null,\n      mileage: appraisal.mileage || null,\n      transmission: appraisal.transmission || null,\n      owners: appraisal.owners || null,\n      serviceHistory: appraisal.serviceHistory || appraisal.service || null,\n      motExpiry: appraisal.motExpiry || null,\n      conditionNotes: (appraisal.conditionNotes || appraisal.notes || \"\").slice(0, 2000),\n      // If you store issues/damage from appraisal\n      issues: (appraisal.issues || []).slice(0, 20),\n      photosCount: Array.isArray(appraisal.photos) ? appraisal.photos.length : null,\n      source: appraisal.source || null,\n    };\n\n    const prompt = `You are a UK used car dealer appraisal assistant.\nReturn VALID JSON only.\n\nYou are helping a dealer decide what to pay for a vehicle and what prep is likely needed.\nBe practical, conservative, and avoid guessing specific prices unless data supports it.\n\nAPPRAISAL DATA:\n${JSON.stringify(context, null, 2)}\n\nRespond with JSON:\n{\n  \"overallAssessment\": \"Short paragraph\",\n  \"keyPositives\": [\"0-6 bullets\"],\n  \"keyNegatives\": [\"0-10 bullets\"],\n  \"recommendedChecks\": [\"0-8 bullets\"],\n  \"reconditioningJobs\": [\n    { \"title\": \"Job\", \"why\": \"Reason\", \"roughCostBand\": \"£ | ££ | £££\" }\n  ],\n  \"pricingNotes\": [\"0-6 bullets\"],\n  \"recommendedDecision\": \"BUY | BUY_IF_PRICE_RIGHT | AVOID\",\n  \"confidence\": \"LOW | MED | HIGH\"\n}\n`;\n\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"system\",\n          content: \"Return JSON only. No markdown. No extra keys.\",\n        },\n        { role: \"user\", content: prompt },\n      ],\n      temperature: 0.6,\n      max_tokens: 1100,\n      response_format: { type: \"json_object\" },\n    });\n\n    const responseText = completion.choices?.[0]?.message?.content || \"\";\n    let aiResponse;\n    try {\n      aiResponse = safeJsonParse(responseText);\n    } catch (parseError) {\n      console.error(\"Failed to parse AI JSON:\", responseText);\n      return res.status(500).json({ error: \"Failed to parse AI response JSON\" });\n    }\n\n    const generatedAt = new Date();\n\n    await Appraisal.updateOne(\n      { _id: appraisalId, dealerId },\n      {\n        $set: {\n          aiSummary: {\n            payload: aiResponse,\n            generatedAt,\n            generatedByUserId: userId,\n          },\n        },\n      }\n    );\n\n    return res.status(200).json({\n      ok: true,\n      summary: aiResponse,\n      cached: false,\n      generatedAt: generatedAt.toISOString(),\n    });\n  } catch (error) {\n    console.error(\"Error generating appraisal summary:\", error);\n    return res.status(500).json({ error: \"Failed to generate summary\" });\n  }\n}\n\nexport default withDealerContext(handler);\n","numLines":145,"startLine":1,"totalLines":145}}}
{"parentUuid":"77afee86-cc5f-4cfb-ae92-75289500fdfe","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GjmQ54e85TiqDEQqMjFp5F","type":"tool_result","content":"     1→import connectMongo from \"@/libs/mongoose\";\n     2→import AftercareCase from \"@/models/AftercareCase\";\n     3→import AftercareCaseComment from \"@/models/AftercareCaseComment\";\n     4→import { withDealerContext } from \"@/libs/authContext\";\n     5→import { getOpenAIClient, safeJsonParse } from \"@/libs/openai\";\n     6→\n     7→async function handler(req, res, ctx) {\n     8→  if (req.method !== \"POST\") {\n     9→    return res.status(405).json({ error: \"Method not allowed\" });\n    10→  }\n    11→\n    12→  if (!process.env.OPENAI_API_KEY) {\n    13→    return res.status(500).json({\n    14→      error: \"OpenAI not configured. Please set OPENAI_API_KEY in .env.local and restart the server.\",\n    15→    });\n    16→  }\n    17→\n    18→  const openai = getOpenAIClient();\n    19→  if (!openai) {\n    20→    return res.status(500).json({ error: \"OpenAI client not available\" });\n    21→  }\n    22→\n    23→  await connectMongo();\n    24→\n    25→  const { dealerId, userId } = ctx;\n    26→  const { caseId, regenerate } = req.body || {};\n    27→\n    28→  if (!caseId) {\n    29→    return res.status(400).json({ error: \"caseId is required\" });\n    30→  }\n    31→\n    32→  try {\n    33→    // Fetch the case with all details (scoped to dealer)\n    34→    const aftercareCase = await AftercareCase.findOne({ _id: caseId, dealerId })\n    35→      .populate(\"contactId\", \"name email phone\")\n    36→      .populate(\"vehicleId\", \"make model regCurrent year mileage\")\n    37→      .lean();\n    38→\n    39→    if (!aftercareCase) {\n    40→      return res.status(404).json({ error: \"Case not found\" });\n    41→    }\n    42→\n    43→    // Return cached AI review unless explicitly regenerating\n    44→    if (aftercareCase.aiReview?.payload && !regenerate) {\n    45→      return res.status(200).json({\n    46→        ok: true,\n    47→        summary: aftercareCase.aiReview.payload,\n    48→        cached: true,\n    49→        generatedAt: aftercareCase.aiReview.generatedAt,\n    50→      });\n    51→    }\n    52→\n    53→    // Fetch comments for additional context (dealer scoped)\n    54→    const comments = await AftercareCaseComment.find({\n    55→      aftercareCaseId: caseId,\n    56→      dealerId,\n    57→    })\n    58→      .sort({ createdAt: 1 })\n    59→      .lean();\n    60→\n    61→    // Build compact context for AI (cap lengths to control tokens/cost)\n    62→    const safeIssue =\n    63→      (aftercareCase.details?.issueDescription ||\n    64→        aftercareCase.issueDescription ||\n    65→        \"No description provided\") + \"\";\n    66→\n    67→    const caseContext = {\n    68→      customer: aftercareCase.contactId?.name || \"Unknown customer\",\n    69→      customerEmail: aftercareCase.contactId?.email || null,\n    70→      customerPhone: aftercareCase.contactId?.phone || null,\n    71→      vehicle: {\n    72→        make:\n    73→          aftercareCase.vehicleId?.make ||\n    74→          aftercareCase.details?.vehicleMake ||\n    75→          \"Unknown\",\n    76→        model:\n    77→          aftercareCase.vehicleId?.model ||\n    78→          aftercareCase.details?.vehicleModel ||\n    79→          \"\",\n    80→        reg:\n    81→          aftercareCase.regAtPurchase ||\n    82→          aftercareCase.vehicleId?.regCurrent ||\n    83→          \"Unknown\",\n    84→        year: aftercareCase.vehicleId?.year || null,\n    85→        mileage:\n    86→          aftercareCase.vehicleId?.mileage ||\n    87→          aftercareCase.details?.mileageAtPurchase ||\n    88→          null,\n    89→      },\n    90→      issue: safeIssue.slice(0, 2000),\n    91→      source: aftercareCase.source || \"Manual\",\n    92→      priority: aftercareCase.priority || \"normal\",\n    93→      status: aftercareCase.boardStatus || \"not_booked_in\",\n    94→      warrantyType: aftercareCase.warrantyType || \"Dealer Warranty\",\n    95→      purchaseDate:\n    96→        aftercareCase.purchaseDate || aftercareCase.details?.dateOfPurchase || null,\n    97→      daysOpen: Math.floor(\n    98→        (Date.now() - new Date(aftercareCase.createdAt).getTime()) /\n    99→          (1000 * 60 * 60 * 24)\n   100→      ),\n   101→      repairLocation: aftercareCase.repairLocationType || \"WITH_CUSTOMER\",\n   102→      partsRequired: !!aftercareCase.partsRequired,\n   103→      partsDetails: aftercareCase.partsDetails || null,\n   104→      courtesyRequired: !!aftercareCase.courtesyRequired,\n   105→      timeline: (aftercareCase.events || [])\n   106→        .slice(-10)\n   107→        .map((e) => ({\n   108→          type: e.type,\n   109→          summary: (e.summary || \"\").slice(0, 200),\n   110→          date: e.createdAt,\n   111→        })),\n   112→      comments: (comments || [])\n   113→        .slice(-5)\n   114→        .map((c) => ({\n   115→          text: (c.text || \"\").slice(0, 400),\n   116→          isInternal: !!c.isInternal,\n   117→          date: c.createdAt,\n   118→        })),\n   119→    };\n   120→\n   121→    const prompt = `You are an expert automotive warranty/aftersales case analyst for a UK car dealership.\n   122→Return VALID JSON only (no markdown, no extra commentary).\n   123→\n   124→CASE DETAILS:\n   125→- Customer: ${caseContext.customer}\n   126→- Vehicle: ${caseContext.vehicle.year || \"\"} ${caseContext.vehicle.make} ${caseContext.vehicle.model} (${caseContext.vehicle.reg})\n   127→- Mileage: ${caseContext.vehicle.mileage || \"Unknown\"}\n   128→- Purchase Date: ${\n   129→      caseContext.purchaseDate\n   130→        ? new Date(caseContext.purchaseDate).toLocaleDateString()\n   131→        : \"Unknown\"\n   132→    }\n   133→- Warranty Type: ${caseContext.warrantyType}\n   134→- Days Open: ${caseContext.daysOpen}\n   135→- Priority: ${caseContext.priority}\n   136→- Current Status: ${caseContext.status}\n   137→- Repair Location: ${caseContext.repairLocation}\n   138→- Parts Required: ${caseContext.partsRequired ? \"Yes\" : \"No\"}\n   139→${caseContext.partsDetails ? `- Parts Details: ${caseContext.partsDetails}` : \"\"}\n   140→- Courtesy Car Required: ${caseContext.courtesyRequired ? \"Yes\" : \"No\"}\n   141→\n   142→ISSUE REPORTED:\n   143→${caseContext.issue}\n   144→\n   145→${\n   146→  caseContext.comments.length > 0\n   147→    ? `RECENT COMMENTS:\n   148→${caseContext.comments\n   149→  .map((c) => `- ${c.text} (${c.isInternal ? \"Internal\" : \"Customer\"})`)\n   150→  .join(\"\\n\")}`\n   151→    : \"\"\n   152→}\n   153→\n   154→${\n   155→  caseContext.timeline.length > 0\n   156→    ? `RECENT ACTIVITY:\n   157→${caseContext.timeline.map((t) => `- ${t.summary}`).join(\"\\n\")}`\n   158→    : \"\"\n   159→}\n   160→\n   161→Respond with JSON:\n   162→{\n   163→  \"summary\": \"2-3 sentence summary of the case and current status\",\n   164→  \"assessment\": \"Is this likely warranty, wear & tear, customer misuse, etc. (keep balanced)\",\n   165→  \"recommendedActions\": [\"2-5 concrete next steps in order\"],\n   166→  \"estimatedComplexity\": \"LOW | MEDIUM | HIGH\",\n   167→  \"riskLevel\": \"LOW | MEDIUM | HIGH\",\n   168→  \"draftCustomerReply\": \"Short empathetic UK customer message (2-4 sentences)\",\n   169→  \"draftInternalNote\": \"Short internal note for staff\"\n   170→}\n   171→`;\n   172→\n   173→    const completion = await openai.chat.completions.create({\n   174→      model: \"gpt-4o-mini\",\n   175→      messages: [\n   176→        {\n   177→          role: \"system\",\n   178→          content: \"Return JSON only. No markdown. No extra keys.\",\n   179→        },\n   180→        { role: \"user\", content: prompt },\n   181→      ],\n   182→      temperature: 0.7,\n   183→      max_tokens: 1000,\n   184→      response_format: { type: \"json_object\" },\n   185→    });\n   186→\n   187→    const responseText = completion.choices?.[0]?.message?.content || \"\";\n   188→    let aiResponse;\n   189→    try {\n   190→      aiResponse = safeJsonParse(responseText);\n   191→    } catch (parseError) {\n   192→      console.error(\"Failed to parse AI JSON:\", responseText);\n   193→      return res.status(500).json({ error: \"Failed to parse AI response JSON\" });\n   194→    }\n   195→\n   196→    const generatedAt = new Date();\n   197→\n   198→    // Store result on the case\n   199→    await AftercareCase.updateOne(\n   200→      { _id: caseId, dealerId },\n   201→      {\n   202→        $set: {\n   203→          aiReview: {\n   204→            payload: aiResponse,\n   205→            generatedAt,\n   206→            generatedByUserId: userId,\n   207→          },\n   208→        },\n   209→      }\n   210→    );\n   211→\n   212→    return res.status(200).json({\n   213→      ok: true,\n   214→      summary: aiResponse,\n   215→      cached: false,\n   216→      generatedAt: generatedAt.toISOString(),\n   217→    });\n   218→  } catch (error) {\n   219→    console.error(\"Error generating warranty summary:\", error);\n   220→    return res.status(500).json({ error: \"Failed to generate summary\" });\n   221→  }\n   222→}\n   223→\n   224→export default withDealerContext(handler);\n   225→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e2ac4c0e-04e5-4330-8cc8-d038e191a71c","timestamp":"2025-12-30T15:52:33.479Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\ai\\warranty-summary.js","content":"import connectMongo from \"@/libs/mongoose\";\nimport AftercareCase from \"@/models/AftercareCase\";\nimport AftercareCaseComment from \"@/models/AftercareCaseComment\";\nimport { withDealerContext } from \"@/libs/authContext\";\nimport { getOpenAIClient, safeJsonParse } from \"@/libs/openai\";\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  if (!process.env.OPENAI_API_KEY) {\n    return res.status(500).json({\n      error: \"OpenAI not configured. Please set OPENAI_API_KEY in .env.local and restart the server.\",\n    });\n  }\n\n  const openai = getOpenAIClient();\n  if (!openai) {\n    return res.status(500).json({ error: \"OpenAI client not available\" });\n  }\n\n  await connectMongo();\n\n  const { dealerId, userId } = ctx;\n  const { caseId, regenerate } = req.body || {};\n\n  if (!caseId) {\n    return res.status(400).json({ error: \"caseId is required\" });\n  }\n\n  try {\n    // Fetch the case with all details (scoped to dealer)\n    const aftercareCase = await AftercareCase.findOne({ _id: caseId, dealerId })\n      .populate(\"contactId\", \"name email phone\")\n      .populate(\"vehicleId\", \"make model regCurrent year mileage\")\n      .lean();\n\n    if (!aftercareCase) {\n      return res.status(404).json({ error: \"Case not found\" });\n    }\n\n    // Return cached AI review unless explicitly regenerating\n    if (aftercareCase.aiReview?.payload && !regenerate) {\n      return res.status(200).json({\n        ok: true,\n        summary: aftercareCase.aiReview.payload,\n        cached: true,\n        generatedAt: aftercareCase.aiReview.generatedAt,\n      });\n    }\n\n    // Fetch comments for additional context (dealer scoped)\n    const comments = await AftercareCaseComment.find({\n      aftercareCaseId: caseId,\n      dealerId,\n    })\n      .sort({ createdAt: 1 })\n      .lean();\n\n    // Build compact context for AI (cap lengths to control tokens/cost)\n    const safeIssue =\n      (aftercareCase.details?.issueDescription ||\n        aftercareCase.issueDescription ||\n        \"No description provided\") + \"\";\n\n    const caseContext = {\n      customer: aftercareCase.contactId?.name || \"Unknown customer\",\n      customerEmail: aftercareCase.contactId?.email || null,\n      customerPhone: aftercareCase.contactId?.phone || null,\n      vehicle: {\n        make:\n          aftercareCase.vehicleId?.make ||\n          aftercareCase.details?.vehicleMake ||\n          \"Unknown\",\n        model:\n          aftercareCase.vehicleId?.model ||\n          aftercareCase.details?.vehicleModel ||\n          \"\",\n        reg:\n          aftercareCase.regAtPurchase ||\n          aftercareCase.vehicleId?.regCurrent ||\n          \"Unknown\",\n        year: aftercareCase.vehicleId?.year || null,\n        mileage:\n          aftercareCase.vehicleId?.mileage ||\n          aftercareCase.details?.mileageAtPurchase ||\n          null,\n      },\n      issue: safeIssue.slice(0, 2000),\n      source: aftercareCase.source || \"Manual\",\n      priority: aftercareCase.priority || \"normal\",\n      status: aftercareCase.boardStatus || \"not_booked_in\",\n      warrantyType: aftercareCase.warrantyType || \"Dealer Warranty\",\n      purchaseDate:\n        aftercareCase.purchaseDate || aftercareCase.details?.dateOfPurchase || null,\n      daysOpen: Math.floor(\n        (Date.now() - new Date(aftercareCase.createdAt).getTime()) /\n          (1000 * 60 * 60 * 24)\n      ),\n      repairLocation: aftercareCase.repairLocationType || \"WITH_CUSTOMER\",\n      partsRequired: !!aftercareCase.partsRequired,\n      partsDetails: aftercareCase.partsDetails || null,\n      courtesyRequired: !!aftercareCase.courtesyRequired,\n      timeline: (aftercareCase.events || [])\n        .slice(-10)\n        .map((e) => ({\n          type: e.type,\n          summary: (e.summary || \"\").slice(0, 200),\n          date: e.createdAt,\n        })),\n      comments: (comments || [])\n        .slice(-5)\n        .map((c) => ({\n          text: (c.text || \"\").slice(0, 400),\n          isInternal: !!c.isInternal,\n          date: c.createdAt,\n        })),\n    };\n\n    const prompt = `You are an expert automotive warranty/aftersales case analyst for a UK car dealership.\nReturn VALID JSON only (no markdown, no extra commentary).\n\nCASE DETAILS:\n- Customer: ${caseContext.customer}\n- Vehicle: ${caseContext.vehicle.year || \"\"} ${caseContext.vehicle.make} ${caseContext.vehicle.model} (${caseContext.vehicle.reg})\n- Mileage: ${caseContext.vehicle.mileage || \"Unknown\"}\n- Purchase Date: ${\n      caseContext.purchaseDate\n        ? new Date(caseContext.purchaseDate).toLocaleDateString()\n        : \"Unknown\"\n    }\n- Warranty Type: ${caseContext.warrantyType}\n- Days Open: ${caseContext.daysOpen}\n- Priority: ${caseContext.priority}\n- Current Status: ${caseContext.status}\n- Repair Location: ${caseContext.repairLocation}\n- Parts Required: ${caseContext.partsRequired ? \"Yes\" : \"No\"}\n${caseContext.partsDetails ? `- Parts Details: ${caseContext.partsDetails}` : \"\"}\n- Courtesy Car Required: ${caseContext.courtesyRequired ? \"Yes\" : \"No\"}\n\nISSUE REPORTED:\n${caseContext.issue}\n\n${\n  caseContext.comments.length > 0\n    ? `RECENT COMMENTS:\n${caseContext.comments\n  .map((c) => `- ${c.text} (${c.isInternal ? \"Internal\" : \"Customer\"})`)\n  .join(\"\\n\")}`\n    : \"\"\n}\n\n${\n  caseContext.timeline.length > 0\n    ? `RECENT ACTIVITY:\n${caseContext.timeline.map((t) => `- ${t.summary}`).join(\"\\n\")}`\n    : \"\"\n}\n\nRespond with JSON:\n{\n  \"summary\": \"2-3 sentence summary of the case and current status\",\n  \"assessment\": \"Is this likely warranty, wear & tear, customer misuse, etc. (keep balanced)\",\n  \"recommendedActions\": [\"2-5 concrete next steps in order\"],\n  \"estimatedComplexity\": \"LOW | MEDIUM | HIGH\",\n  \"riskLevel\": \"LOW | MEDIUM | HIGH\",\n  \"draftCustomerReply\": \"Short empathetic UK customer message (2-4 sentences)\",\n  \"draftInternalNote\": \"Short internal note for staff\"\n}\n`;\n\n    const completion = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"system\",\n          content: \"Return JSON only. No markdown. No extra keys.\",\n        },\n        { role: \"user\", content: prompt },\n      ],\n      temperature: 0.7,\n      max_tokens: 1000,\n      response_format: { type: \"json_object\" },\n    });\n\n    const responseText = completion.choices?.[0]?.message?.content || \"\";\n    let aiResponse;\n    try {\n      aiResponse = safeJsonParse(responseText);\n    } catch (parseError) {\n      console.error(\"Failed to parse AI JSON:\", responseText);\n      return res.status(500).json({ error: \"Failed to parse AI response JSON\" });\n    }\n\n    const generatedAt = new Date();\n\n    // Store result on the case\n    await AftercareCase.updateOne(\n      { _id: caseId, dealerId },\n      {\n        $set: {\n          aiReview: {\n            payload: aiResponse,\n            generatedAt,\n            generatedByUserId: userId,\n          },\n        },\n      }\n    );\n\n    return res.status(200).json({\n      ok: true,\n      summary: aiResponse,\n      cached: false,\n      generatedAt: generatedAt.toISOString(),\n    });\n  } catch (error) {\n    console.error(\"Error generating warranty summary:\", error);\n    return res.status(500).json({ error: \"Failed to generate summary\" });\n  }\n}\n\nexport default withDealerContext(handler);\n","numLines":225,"startLine":1,"totalLines":225}}}
{"parentUuid":"e2ac4c0e-04e5-4330-8cc8-d038e191a71c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QAc5xbNrJRrUNJkRMNVn7x","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"These other AI endpoints have a different structure - they directly check for OPENAI_API_KEY and use the openai client directly, rather than using the callOpenAI helper. They return 500 status codes with error messages, which is fine for their use case as they're not using the AISuggestionsPanel.\n\nThe main fix I need is for the AISuggestionsPanel which is now handling error codes properly. Let me update the todo list and move to the last task - implementing the Test Drive licence OCR extraction.","signature":"Ep0FCkYICxgCKkBNOkc+05kJPJN5wdUhConepCqHM2i7iFzlOZlx5j9UymedFIc7OOMmjXL0yqknOv3/hDuJwU6Sz34diRILAJaOEgxGCOGwHZtK1H82bJkaDIGPQn3Y+0NwSI5Z4yIwN1eFFYdo9uUb64pq2Tt+P6DIWaGu3NoBySAHGaNG68PKa8FNtXF6810YDBn6w0xgKoQEyBi5NZLYxJwSp+B5XqV+yAPdDQrtaqtnBxbAP3Tr99r8lo0TKQmfev92tPJNAY4lV85jW0QsQ5W7oopiu9FzTReswiIPmxH3io36dT7I+irPrnc3LqbMkBOd2G4krZSR9eMfdJ6y6XFDLvfoT8kMhd4h9vivUorHFP+/9P3wil5gQK+HEI8y8NqzsTh8O+HdRh0ZGr0aCXhD4Dtoxe6q5DakWfcnW4iWqdwFtIrl3gYTHUks9ztsIMi+iQpxHeSyQVwYwTM6CEcOX+s8AcRKXyQHNX138ceSmJFJbOeXCyy/VrmJbW41c9Rd1DweA7D7a9nuUilNX4MZA6vfO2f4MiB0nn/PG5hmfT8MNkSBcyJ+jt6W3wQmFGDweBqwkp+tOsyKD9drlW5tiJAoTOYPQoe6qoAiKeyENt0gNsv6Yt7gbSX0ZcdLaf92JdZc5EECb9GrjGpJUADxF7JmC8/oUU29WI3o07oyXYjItPeicKL6CDoO3gQ1l5Sf05R8K9zWeOfKPN4Vxf6GEHeuGMTPvHFHamswlWADd7+ab1MbLZ2HvjWDgxccYp/pZI11WSML38h4z954eEON1fYVEdz91/niqAtEt5JDR8YJv0ki41Oy5rY3PE2OMNaow2rLPewTKT6qNpjn7oocUCBqj0hYJScISp4lb9IkUYQIsGtA588B2IHCGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":9265,"cache_read_input_tokens":101897,"cache_creation":{"ephemeral_5m_input_tokens":9265,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd95TggZkTGafME1vW2E","type":"assistant","uuid":"98ce3500-bcd8-4751-ba1e-9a9bd250b5d8","timestamp":"2025-12-30T15:52:41.422Z"}
{"parentUuid":"98ce3500-bcd8-4751-ba1e-9a9bd250b5d8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QAc5xbNrJRrUNJkRMNVn7x","type":"message","role":"assistant","content":[{"type":"text","text":"The AI task is mostly complete. The other AI endpoints (case-review, appraisal-summary, warranty-summary) have different patterns - they return errors directly and aren't used by the AISuggestionsPanel. Let me now update the todo list and move to the final task:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":9265,"cache_read_input_tokens":101897,"cache_creation":{"ephemeral_5m_input_tokens":9265,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd95TggZkTGafME1vW2E","type":"assistant","uuid":"8cb28ec4-032f-4c7e-bd80-5499e98e2911","timestamp":"2025-12-30T15:52:43.264Z"}
{"parentUuid":"8cb28ec4-032f-4c7e-bd80-5499e98e2911","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QAc5xbNrJRrUNJkRMNVn7x","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LvhrrRUqFR46Z17ng433WT","name":"TodoWrite","input":{"todos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"completed","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"completed","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"completed","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"in_progress","activeForm":"Implementing Test Drive licence OCR extraction"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":9265,"cache_read_input_tokens":101897,"cache_creation":{"ephemeral_5m_input_tokens":9265,"ephemeral_1h_input_tokens":0},"output_tokens":385,"service_tier":"standard"}},"requestId":"req_011CWd95TggZkTGafME1vW2E","type":"assistant","uuid":"35439bb2-7195-425e-a9f7-03e5133e963a","timestamp":"2025-12-30T15:52:46.312Z"}
{"parentUuid":"35439bb2-7195-425e-a9f7-03e5133e963a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LvhrrRUqFR46Z17ng433WT","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"c442b1f0-83aa-48b4-ac0e-654d1fedc159","timestamp":"2025-12-30T15:52:46.424Z","toolUseResult":{"oldTodos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"completed","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"completed","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"in_progress","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"pending","activeForm":"Implementing Test Drive licence OCR extraction"}],"newTodos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"completed","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"completed","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"completed","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"in_progress","activeForm":"Implementing Test Drive licence OCR extraction"}]}}
{"parentUuid":"c442b1f0-83aa-48b4-ac0e-654d1fedc159","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GKDFjs9mQ7NASt2z74b9xB","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to implement the Test Drive licence OCR extraction. Looking at the requirements:\n\n1. Add a field at top of Test Drive form: \"Scan driving licence\" (camera/upload)\n2. Create a new API endpoint `/api/forms/test-drive/extract-licence`\n3. Use OpenAI vision model to extract fields from the licence\n4. Return extracted fields and populate form\n5. Show manual fallback if extraction fails\n\nLet me start by:\n1. Creating the API endpoint for extracting licence data\n2. Updating the Test Drive form template to add the licence scanning field\n\nFirst, let me create the API endpoint:","signature":"EucFCkYICxgCKkCa1yJ+AbJ1LsSMAD1jQxy6DX+me++LRv+UizEdTEW4eb0NA/2I8+IaN7sq9kauOAe02ZaXJJX6ImdOCmjuiWJaEgy4GOZE+ARSlWyLmsEaDCZBWYdFoHEKDxJCCiIwVS2XHq2G7MUUl5EneEoJms4Wf3TMlQSh5J4/4glWH4Bmu7bKDCwG25rdk5VFj+E9Ks4EFeslh0vNYq0biTzHGlpJE83QqlqtCzXmA/c51muntsvDBzeK0jU5iX/PJfJ4ExwwJuknr6AoQTvWm98za4SHbaYGXKvhvO8CnxeXwemCoo2ceKahLmMwfQuHNj4S2PgUHhS34qpyy4njYpVDlwrCIqUncZi7kR+7PnFjAk4a4FlRPfy4+kp0FamyTwFZEYkumcq7ETRy9vP+gSXUu/QerLso3YCdUgkmY1j5Kz5mXBEiape4/a9BYTXbJMYbIfZvl6pIoMK0YylVrQ9fdcWmvJ+C4ZnkTOd/+XqH0kvNhGrga33BbgaXxp6Rjno1fad255axVjsYhUbCwEWfZLgMJpBv/Fq3rILii9Qeg3FduTFWrp2QmIZ/bEMuF8WJZ7RWxfVBAJX/Wan1NeVBvLKy0sqYMuU7G6ziWoELDMsCIla6jQC6KPn27+hwpPQsw8ks/RFmOv7afqOf9WrugRhmQr9zYtfiUPY4DvAjvexNPkHU8dYTbGopY+b3h7zqIMHwR1v0Rw14dxyX23/K7f9DEq+VksJgL3F90jD1QltaCnsGVQOzP/sUL3B4a0CLSIJkk2HRS3aVLu2eB3Z/TIV4y2tOpMARIsLPC3KtshClrW8ibYmee/x1JJY9kosOA1gZhVyLTxyziVE0IExTQVbsD/5YPgS/kyzCZKptn6GdUXxRDocpKBjP/TXF30FvIs1Gretx31BTBdXyVoOZiZ9HQfsUKZKGAVsNOYc1L9cEnvfCyfym756jamdh2jBHyjoMebZA8JzHk9794VSK20AYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":434,"cache_read_input_tokens":111162,"cache_creation":{"ephemeral_5m_input_tokens":434,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd96NaNz5VZ9tHggogXv","type":"assistant","uuid":"9eb9aa17-62df-4e09-af3f-ac0461e863a5","timestamp":"2025-12-30T15:52:52.821Z"}
{"parentUuid":"9eb9aa17-62df-4e09-af3f-ac0461e863a5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GKDFjs9mQ7NASt2z74b9xB","type":"message","role":"assistant","content":[{"type":"text","text":"## Task 4: Implement Test Drive licence OCR extraction\n\nI'll create the API endpoint and update the Test Drive form. First, let me create the extraction endpoint:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":434,"cache_read_input_tokens":111162,"cache_creation":{"ephemeral_5m_input_tokens":434,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd96NaNz5VZ9tHggogXv","type":"assistant","uuid":"0ad47e00-781c-4983-9dbf-59086ef047b8","timestamp":"2025-12-30T15:52:54.212Z"}
{"parentUuid":"0ad47e00-781c-4983-9dbf-59086ef047b8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GKDFjs9mQ7NASt2z74b9xB","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EPo1xpCygo5BcAhKc7qoHa","name":"Bash","input":{"command":"mkdir -p \"C:/Users/georg/dealerflow/pages/api/forms/test-drive\"","description":"Create test-drive API directory"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":434,"cache_read_input_tokens":111162,"cache_creation":{"ephemeral_5m_input_tokens":434,"ephemeral_1h_input_tokens":0},"output_tokens":283,"service_tier":"standard"}},"requestId":"req_011CWd96NaNz5VZ9tHggogXv","type":"assistant","uuid":"2a547a86-ff7c-4bac-a579-835bf4967fba","timestamp":"2025-12-30T15:52:55.581Z"}
{"parentUuid":"2a547a86-ff7c-4bac-a579-835bf4967fba","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EPo1xpCygo5BcAhKc7qoHa","type":"tool_result","content":"","is_error":false}]},"uuid":"24bd12d3-faf8-430b-b647-0f85f6830a51","timestamp":"2025-12-30T15:52:58.808Z","toolUseResult":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"24bd12d3-faf8-430b-b647-0f85f6830a51","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XRAF9RaDAEhe2YjiJJXePg","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now let me create the licence extraction API endpoint:","signature":"Et4BCkYICxgCKkCIdWzfsk9L3xHgchRGRm661jeHJCpBrOOeBuo0Xp7g/OhCBF0vcPc5hflp2p6c2oWJAT3MzWNHkP+85ffNrlOkEgwmcnSeKc9StzO7HnUaDGWyKEa+t+8VogiT5iIwzZo05A3Y3/9K10n6JACkLzjoyBACwyXsuKh4eqs/BO5AKDMhAviNuQtd+k/LkYpnKkbkuVHTIzhAXrSjeO6zDFTS/R1FW5r4D3+MlwJAoniOKhIjWRYX4herut3WU0L6b2PfZ0+VLcRJBttPvnzCGexN9z8cWqLdGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":309,"cache_read_input_tokens":111596,"cache_creation":{"ephemeral_5m_input_tokens":309,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd97Ht8R4CcWsEgzGY9K","type":"assistant","uuid":"2e31a63b-d134-4604-9148-78a2e9832100","timestamp":"2025-12-30T15:53:03.856Z"}
{"parentUuid":"2e31a63b-d134-4604-9148-78a2e9832100","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XRAF9RaDAEhe2YjiJJXePg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01J82HNnd7ttiQjKmB5DyJjy","name":"Write","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\api\\forms\\test-drive\\extract-licence.js","content":"/**\n * Extract Driving Licence Details via OpenAI Vision API\n *\n * POST /api/forms/test-drive/extract-licence\n *\n * Accepts a base64-encoded image of a UK driving licence and extracts\n * key details using OpenAI's vision model.\n *\n * Request body:\n * - image: base64-encoded image data (required)\n * - mimeType: image MIME type (optional, defaults to image/jpeg)\n *\n * Response:\n * - ok: boolean\n * - data: extracted fields if successful\n * - error: error message if failed\n */\n\nimport { withDealerContext } from \"@/libs/authContext\";\nimport { getOpenAIClient, getAIConfig } from \"@/libs/openai\";\n\nconst EXTRACTION_PROMPT = `You are an expert at reading UK driving licences. Analyse this image of a UK driving licence and extract the following information.\n\nReturn ONLY valid JSON with exactly these keys:\n{\n  \"fullName\": \"The full name as shown on the licence (first name and surname)\",\n  \"firstName\": \"The first name only\",\n  \"lastName\": \"The surname/family name only\",\n  \"dateOfBirth\": \"Date of birth in YYYY-MM-DD format if visible\",\n  \"addressLine1\": \"First line of address\",\n  \"addressLine2\": \"Second line of address (empty string if none)\",\n  \"town\": \"Town/city name\",\n  \"postcode\": \"Postcode\",\n  \"licenceNumber\": \"The driving licence number (the long alphanumeric code)\",\n  \"issueDate\": \"Issue date in YYYY-MM-DD format if visible (section 4a)\",\n  \"expiryDate\": \"Expiry date in YYYY-MM-DD format if visible (section 4b)\",\n  \"confidence\": \"HIGH, MEDIUM, or LOW - your confidence in the extraction accuracy\",\n  \"missingFields\": [\"array of field names that could not be extracted\"]\n}\n\nImportant rules:\n- Only extract what you can clearly read - do not guess\n- For dates, use ISO format YYYY-MM-DD\n- If a field is not visible or readable, use null and add it to missingFields\n- The licence number is in section 5 and is usually 16+ characters\n- UK postcodes are in format like \"SW1A 1AA\" or \"M1 1AA\"\n- Return ONLY the JSON object, no markdown or explanations`;\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const { isConfigured } = getAIConfig();\n  if (!isConfigured) {\n    return res.status(200).json({\n      ok: false,\n      errorCode: \"NOT_CONFIGURED\",\n      error: \"AI service is not configured. Please contact your administrator.\",\n    });\n  }\n\n  const client = getOpenAIClient();\n  if (!client) {\n    return res.status(200).json({\n      ok: false,\n      errorCode: \"CLIENT_ERROR\",\n      error: \"AI service is temporarily unavailable.\",\n    });\n  }\n\n  const { image, mimeType = \"image/jpeg\" } = req.body;\n\n  if (!image) {\n    return res.status(400).json({\n      ok: false,\n      error: \"No image provided. Please upload a driving licence image.\",\n    });\n  }\n\n  // Validate base64 data\n  if (typeof image !== \"string\" || image.length < 100) {\n    return res.status(400).json({\n      ok: false,\n      error: \"Invalid image data. Please upload a valid image.\",\n    });\n  }\n\n  try {\n    // Prepare the image URL - support both raw base64 and data URLs\n    let imageUrl = image;\n    if (!image.startsWith(\"data:\")) {\n      imageUrl = `data:${mimeType};base64,${image}`;\n    }\n\n    const response = await client.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"user\",\n          content: [\n            { type: \"text\", text: EXTRACTION_PROMPT },\n            {\n              type: \"image_url\",\n              image_url: {\n                url: imageUrl,\n                detail: \"high\",\n              },\n            },\n          ],\n        },\n      ],\n      max_tokens: 800,\n      temperature: 0.1,\n    });\n\n    const content = response.choices?.[0]?.message?.content;\n\n    if (!content) {\n      return res.status(200).json({\n        ok: false,\n        error: \"Could not extract details from this image. Please try a clearer photo or enter details manually.\",\n      });\n    }\n\n    // Parse the JSON response\n    let extracted;\n    try {\n      // Clean up the response - remove any markdown code fences\n      const cleaned = content\n        .replace(/```json\\s*/gi, \"\")\n        .replace(/```\\s*/g, \"\")\n        .trim();\n      extracted = JSON.parse(cleaned);\n    } catch (parseError) {\n      console.error(\"[Licence Extract] Failed to parse AI response:\", content);\n      return res.status(200).json({\n        ok: false,\n        error: \"Could not read the licence details. Please try a clearer photo or enter details manually.\",\n      });\n    }\n\n    // Validate the extracted data has at least some useful fields\n    const hasMinimumData =\n      extracted.fullName ||\n      extracted.firstName ||\n      extracted.addressLine1 ||\n      extracted.licenceNumber;\n\n    if (!hasMinimumData) {\n      return res.status(200).json({\n        ok: false,\n        error: \"Could not extract enough details from this image. Please try a clearer photo or enter details manually.\",\n        data: extracted,\n      });\n    }\n\n    // Return successful extraction\n    return res.status(200).json({\n      ok: true,\n      data: {\n        fullName: extracted.fullName || null,\n        firstName: extracted.firstName || null,\n        lastName: extracted.lastName || null,\n        dateOfBirth: extracted.dateOfBirth || null,\n        addressLine1: extracted.addressLine1 || null,\n        addressLine2: extracted.addressLine2 || null,\n        town: extracted.town || null,\n        postcode: extracted.postcode || null,\n        licenceNumber: extracted.licenceNumber || null,\n        issueDate: extracted.issueDate || null,\n        expiryDate: extracted.expiryDate || null,\n        confidence: extracted.confidence || \"MEDIUM\",\n        missingFields: extracted.missingFields || [],\n      },\n    });\n  } catch (error) {\n    console.error(\"[Licence Extract] Error:\", error.message, error.status);\n\n    if (error.status === 401) {\n      return res.status(200).json({\n        ok: false,\n        errorCode: \"AUTH_FAILED\",\n        error: \"AI authentication failed. Please contact your administrator.\",\n      });\n    }\n\n    if (error.status === 429) {\n      return res.status(200).json({\n        ok: false,\n        errorCode: \"RATE_LIMIT\",\n        error: \"Too many requests. Please wait a moment and try again.\",\n      });\n    }\n\n    return res.status(200).json({\n      ok: false,\n      error: \"Failed to process the licence image. Please try again or enter details manually.\",\n    });\n  }\n}\n\nexport default withDealerContext(handler);\n"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":309,"cache_read_input_tokens":111596,"cache_creation":{"ephemeral_5m_input_tokens":309,"ephemeral_1h_input_tokens":0},"output_tokens":1964,"service_tier":"standard"}},"requestId":"req_011CWd97Ht8R4CcWsEgzGY9K","type":"assistant","uuid":"d24168d2-7b85-46dc-a358-451354b52b91","timestamp":"2025-12-30T15:53:36.919Z"}
{"type":"file-history-snapshot","messageId":"d24168d2-7b85-46dc-a358-451354b52b91","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"},"libs\\openai.js":{"backupFileName":"a8e7fe417f7ecf06@v1","version":1,"backupTime":"2025-12-30T15:50:12.398Z"},"components\\AISuggestionsPanel.js":{"backupFileName":"9b357355b418cc6f@v1","version":1,"backupTime":"2025-12-30T15:50:35.851Z"},"pages\\warranty.js":{"backupFileName":"a81b4f663f49afea@v1","version":1,"backupTime":"2025-12-30T15:51:31.630Z"},"pages\\api\\ai\\warranty-suggestions.js":{"backupFileName":"5b8ac4e37dc9954c@v1","version":1,"backupTime":"2025-12-30T15:52:02.934Z"},"pages\\api\\ai\\appraisal-issue-suggestions.js":{"backupFileName":"264b13f531a23f96@v1","version":1,"backupTime":"2025-12-30T15:52:13.361Z"},"pages\\api\\forms\\test-drive\\extract-licence.js":{"backupFileName":null,"version":1,"backupTime":"2025-12-30T15:53:38.201Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"d24168d2-7b85-46dc-a358-451354b52b91","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01J82HNnd7ttiQjKmB5DyJjy","type":"tool_result","content":"File created successfully at: C:\\Users\\georg\\dealerflow\\pages\\api\\forms\\test-drive\\extract-licence.js"}]},"uuid":"d157c879-9d93-4329-9695-fbef8b33e8f2","timestamp":"2025-12-30T15:53:38.347Z","toolUseResult":{"type":"create","filePath":"C:\\Users\\georg\\dealerflow\\pages\\api\\forms\\test-drive\\extract-licence.js","content":"/**\n * Extract Driving Licence Details via OpenAI Vision API\n *\n * POST /api/forms/test-drive/extract-licence\n *\n * Accepts a base64-encoded image of a UK driving licence and extracts\n * key details using OpenAI's vision model.\n *\n * Request body:\n * - image: base64-encoded image data (required)\n * - mimeType: image MIME type (optional, defaults to image/jpeg)\n *\n * Response:\n * - ok: boolean\n * - data: extracted fields if successful\n * - error: error message if failed\n */\n\nimport { withDealerContext } from \"@/libs/authContext\";\nimport { getOpenAIClient, getAIConfig } from \"@/libs/openai\";\n\nconst EXTRACTION_PROMPT = `You are an expert at reading UK driving licences. Analyse this image of a UK driving licence and extract the following information.\n\nReturn ONLY valid JSON with exactly these keys:\n{\n  \"fullName\": \"The full name as shown on the licence (first name and surname)\",\n  \"firstName\": \"The first name only\",\n  \"lastName\": \"The surname/family name only\",\n  \"dateOfBirth\": \"Date of birth in YYYY-MM-DD format if visible\",\n  \"addressLine1\": \"First line of address\",\n  \"addressLine2\": \"Second line of address (empty string if none)\",\n  \"town\": \"Town/city name\",\n  \"postcode\": \"Postcode\",\n  \"licenceNumber\": \"The driving licence number (the long alphanumeric code)\",\n  \"issueDate\": \"Issue date in YYYY-MM-DD format if visible (section 4a)\",\n  \"expiryDate\": \"Expiry date in YYYY-MM-DD format if visible (section 4b)\",\n  \"confidence\": \"HIGH, MEDIUM, or LOW - your confidence in the extraction accuracy\",\n  \"missingFields\": [\"array of field names that could not be extracted\"]\n}\n\nImportant rules:\n- Only extract what you can clearly read - do not guess\n- For dates, use ISO format YYYY-MM-DD\n- If a field is not visible or readable, use null and add it to missingFields\n- The licence number is in section 5 and is usually 16+ characters\n- UK postcodes are in format like \"SW1A 1AA\" or \"M1 1AA\"\n- Return ONLY the JSON object, no markdown or explanations`;\n\nasync function handler(req, res, ctx) {\n  if (req.method !== \"POST\") {\n    return res.status(405).json({ error: \"Method not allowed\" });\n  }\n\n  const { isConfigured } = getAIConfig();\n  if (!isConfigured) {\n    return res.status(200).json({\n      ok: false,\n      errorCode: \"NOT_CONFIGURED\",\n      error: \"AI service is not configured. Please contact your administrator.\",\n    });\n  }\n\n  const client = getOpenAIClient();\n  if (!client) {\n    return res.status(200).json({\n      ok: false,\n      errorCode: \"CLIENT_ERROR\",\n      error: \"AI service is temporarily unavailable.\",\n    });\n  }\n\n  const { image, mimeType = \"image/jpeg\" } = req.body;\n\n  if (!image) {\n    return res.status(400).json({\n      ok: false,\n      error: \"No image provided. Please upload a driving licence image.\",\n    });\n  }\n\n  // Validate base64 data\n  if (typeof image !== \"string\" || image.length < 100) {\n    return res.status(400).json({\n      ok: false,\n      error: \"Invalid image data. Please upload a valid image.\",\n    });\n  }\n\n  try {\n    // Prepare the image URL - support both raw base64 and data URLs\n    let imageUrl = image;\n    if (!image.startsWith(\"data:\")) {\n      imageUrl = `data:${mimeType};base64,${image}`;\n    }\n\n    const response = await client.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"user\",\n          content: [\n            { type: \"text\", text: EXTRACTION_PROMPT },\n            {\n              type: \"image_url\",\n              image_url: {\n                url: imageUrl,\n                detail: \"high\",\n              },\n            },\n          ],\n        },\n      ],\n      max_tokens: 800,\n      temperature: 0.1,\n    });\n\n    const content = response.choices?.[0]?.message?.content;\n\n    if (!content) {\n      return res.status(200).json({\n        ok: false,\n        error: \"Could not extract details from this image. Please try a clearer photo or enter details manually.\",\n      });\n    }\n\n    // Parse the JSON response\n    let extracted;\n    try {\n      // Clean up the response - remove any markdown code fences\n      const cleaned = content\n        .replace(/```json\\s*/gi, \"\")\n        .replace(/```\\s*/g, \"\")\n        .trim();\n      extracted = JSON.parse(cleaned);\n    } catch (parseError) {\n      console.error(\"[Licence Extract] Failed to parse AI response:\", content);\n      return res.status(200).json({\n        ok: false,\n        error: \"Could not read the licence details. Please try a clearer photo or enter details manually.\",\n      });\n    }\n\n    // Validate the extracted data has at least some useful fields\n    const hasMinimumData =\n      extracted.fullName ||\n      extracted.firstName ||\n      extracted.addressLine1 ||\n      extracted.licenceNumber;\n\n    if (!hasMinimumData) {\n      return res.status(200).json({\n        ok: false,\n        error: \"Could not extract enough details from this image. Please try a clearer photo or enter details manually.\",\n        data: extracted,\n      });\n    }\n\n    // Return successful extraction\n    return res.status(200).json({\n      ok: true,\n      data: {\n        fullName: extracted.fullName || null,\n        firstName: extracted.firstName || null,\n        lastName: extracted.lastName || null,\n        dateOfBirth: extracted.dateOfBirth || null,\n        addressLine1: extracted.addressLine1 || null,\n        addressLine2: extracted.addressLine2 || null,\n        town: extracted.town || null,\n        postcode: extracted.postcode || null,\n        licenceNumber: extracted.licenceNumber || null,\n        issueDate: extracted.issueDate || null,\n        expiryDate: extracted.expiryDate || null,\n        confidence: extracted.confidence || \"MEDIUM\",\n        missingFields: extracted.missingFields || [],\n      },\n    });\n  } catch (error) {\n    console.error(\"[Licence Extract] Error:\", error.message, error.status);\n\n    if (error.status === 401) {\n      return res.status(200).json({\n        ok: false,\n        errorCode: \"AUTH_FAILED\",\n        error: \"AI authentication failed. Please contact your administrator.\",\n      });\n    }\n\n    if (error.status === 429) {\n      return res.status(200).json({\n        ok: false,\n        errorCode: \"RATE_LIMIT\",\n        error: \"Too many requests. Please wait a moment and try again.\",\n      });\n    }\n\n    return res.status(200).json({\n      ok: false,\n      error: \"Failed to process the licence image. Please try again or enter details manually.\",\n    });\n  }\n}\n\nexport default withDealerContext(handler);\n","structuredPatch":[],"originalFile":null}}
{"parentUuid":"d157c879-9d93-4329-9695-fbef8b33e8f2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Wju1g3BYtpBRpe1tXS9adc","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to update the Test Drive form template to add the licence scanning field and the extracted fields. Looking at the formTemplates.js, I see the current Test Drive form structure. I need to:\n\n1. Add a LICENCE_SCAN field type at the top (this will need to be handled by the form filler component)\n2. Actually, I should look at how forms are rendered to understand the best approach\n\nLooking at the requirements again:\n- Add a field at top of Test Drive form: \"Scan driving licence\" (camera/upload)\n- When image is selected, upload to server endpoint\n- Auto-fill the form fields\n- Show a banner: \"Details captured from licence — please verify\"\n- Manual entry fields always visible but collapsed/secondary if extraction succeeded\n\nI think the best approach is to:\n1. Update the form template to have the licence photo field first\n2. Add the address and customer detail fields that will be auto-filled\n3. Create a custom component or hook that handles the extraction logic in the form filler\n\nLet me first update the Test Drive form template:","signature":"ErcJCkYICxgCKkAAvusfJNeYifdl7k/BMI3Xr0jcTLp8f8wALojsiLQFAx0gno+1FR+UxUTAR6Kpcd8In3gKtpGycb0BRbyZ3jMZEgwhdIy31hpdBJj5wi8aDKrt0rOpi1HiinVjTSIwWs3cCgzfJoeIJNAIqFt9GLbvBWBpa8HZwlnPnEOY1/jhZdH2+c1DKoziicW8S/uYKp4IvRuCTSbV61FWmtiQDS4cY2mu1Mfn/fuIp63KYPYqwrkU/k00E9B6fy+w7k/tQhqMWyluVw2/HzZIjBbNW2v3UX1JBBeBbo/Wz5I4Zm05E7sIC8v1xyOpJu3s/wF5QZfE7mFLT4xQWyaI5sXV+TQIpkIpbjUjZWDvKM15M2w3juDKETdek9c7DOaxHz2R9iU4HjBfvdmy7favpVBtxBr9cVB+Nb2aBj1pmgm0YvMbI4tDW/eMGXgitT8cJxm3jQ+jxe7dPRxUX8lvmn3Y9p/qWlML+lLhr6l5e1mAqpJywz0Xwsjh0YxStV472YBbmKb26Z2ys3fW0aaSSsrH6ASZ7Rsm+F67xjEaAq/2P1lSESKJ/Gb65FWmaDpVL8sf2iK34zL2pn2NlogN0c7kijLOpllL8Mx1ZhmAgcgQ6QOezU9IAB/ArAhetVicNpYxcEdjV6hINVqNy4QTR84XQxhE0KzZANKoMDIX4xdzL7sRPi2kB7azxjV6EBXpfFRrRR6GSkoIBeiZrKKtVO2K+51hW27ac14zFDmO9IrnG+WgO614Pgw+a3drmYUTWwSKxVuNoFYXc1g5N3nl8P+nc5ELZeaYcHlAJINihhGOEq5zwydJkaGP7supqua3nGH6iUxN5TKvktCoRxpG5AQ/ta0/17H55GJsGB9I71B4q5ytcHG06fd2m+mN9P8qVII3vgB2ODqRGuMhVxfmwrMVpSW8omg8liJbJguj15d9brnuaSYbqfYMlx3P4LM7yskRB3P19QotCe2qQ9rMT0360fgJFrL+/OTFMLyGm4CUeaUKZiB54b6RQF8ZJviRY3hLJd+/Nf5zhUnAh28QgTIX0Do6FKC9/Bb4hFccdRswsBvAdX0VBgCX8nbC177/RX3deO7Vg3YwQ9Ipqc3CNBYm/kLQEwqhqw6opKR1z8cOM1/RShwOpp1/rHyFZtzTNv9pOB7BJ/F/rSb7PCAw4WM8Kgs5bBnQMbsj9NKyNj4a6QXmUbh4uYJ9pk1cTac5jRObd+5RRjlGLyjEnZKmBqtE70YLwMl38onGSJEwJCEKI9eqTfNMxyqvrE3n5C3tkb+jfQXcTa1p8Ia20fztx5G0is3VYkzVIUygghsgFDApXqIYpfYYp/xKfA4l0VoSvmcEZVqk7Qx+IBdZEs2Dlgdga7mAj8+C/dHZaHeGOBgtGe0aGJjk038rlZgAX12dyjCjxxoyRunrQVkVUi1LmPsceh+u3K/kMfuKQRdjPvYOHBLZsJCj3M73dQ7pNdmpsVOi45v9vit+qCATR+DOG3UUmC22xyjzhyufrEXUrWfBwXQE9q7t74sYvfTwUDnezq1UTMG2Oi4hN9WOvr3Ncq1yrCeZTrf0cU6145Da3pQfnqSc3KAEfM0brT0OQzwV/6flVBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2013,"cache_read_input_tokens":111905,"cache_creation":{"ephemeral_5m_input_tokens":2013,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd9AEY3xVuxG8uTbJucw","type":"assistant","uuid":"ba5a5731-63d5-4eac-b9db-e4bbda1baf28","timestamp":"2025-12-30T15:53:49.219Z"}
{"parentUuid":"ba5a5731-63d5-4eac-b9db-e4bbda1baf28","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Wju1g3BYtpBRpe1tXS9adc","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the Test Drive form template to add the licence scanning field with extraction capability:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2013,"cache_read_input_tokens":111905,"cache_creation":{"ephemeral_5m_input_tokens":2013,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd9AEY3xVuxG8uTbJucw","type":"assistant","uuid":"dd447d8e-e051-491a-8bf3-52e12be208bf","timestamp":"2025-12-30T15:53:49.880Z"}
{"parentUuid":"dd447d8e-e051-491a-8bf3-52e12be208bf","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Wju1g3BYtpBRpe1tXS9adc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MzzmfwPSAXsrJpKckydC5k","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\libs\\formTemplates.js","old_string":"  // ═══════════════════════════════════════════════════════════════════════════════\n  // Test Drive Request\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Test Drive Request\",\n    type: \"TEST_DRIVE\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"test-drive\",\n    introText: \"Please complete this form to book a test drive. You must bring your valid driving licence on the day.\",\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] },\n    termsText: `By signing this form, I confirm that:\n- I hold a valid UK driving licence\n- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n- I will follow all road traffic laws\n- I am responsible for any parking or speeding fines incurred during the test drive\n- I will not allow any other person to drive the vehicle`,\n    fields: [\n      // Test Drive Details - date defaults to today, time defaults to current time (handled in frontend)\n      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 1 },\n      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 2 },\n      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 5 },\n      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 6 },\n      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 7 },\n      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 8 },\n      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 9 },\n      { label: \"Driving Licence\", fieldName: \"_section_licence\", type: \"SECTION_HEADER\", order: 15 },\n      { label: \"Upload Driving Licence (Front)\", fieldName: \"licence_photo\", type: \"FILE\", required: true, order: 16 },\n      { label: \"Address (if different from licence)\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: false, order: 21 },\n      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22 },\n      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: false, order: 23 },\n      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: false, order: 24 },\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 31, vrmLookup: true },\n      // Make and Model are hidden when vehicle is selected from stock (handled in frontend)\n      { label: \"Vehicle Make\", fieldName: \"vehicle_make\", type: \"TEXT\", required: false, order: 32, hiddenWhenStockSelected: true },\n      { label: \"Vehicle Model\", fieldName: \"vehicle_model\", type: \"TEXT\", required: false, order: 33, hiddenWhenStockSelected: true },\n      { label: \"Where did you find this vehicle?\", fieldName: \"source\", type: \"DROPDOWN\", required: true, order: 35, options: { choices: [\"AutoTrader\", \"eBay\", \"Facebook\", \"Google\", \"Referral\", \"Walk-in\", \"Other\"] } },\n      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"I agree to the Terms & Conditions\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n      { label: \"Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 42 },\n    ],\n  },","new_string":"  // ═══════════════════════════════════════════════════════════════════════════════\n  // Test Drive Request\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Test Drive Request\",\n    type: \"TEST_DRIVE\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"test-drive\",\n    introText: \"Please complete this form to book a test drive. You can scan your driving licence to auto-fill your details.\",\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] },\n    termsText: `By signing this form, I confirm that:\n- I hold a valid UK driving licence\n- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n- I will follow all road traffic laws\n- I am responsible for any parking or speeding fines incurred during the test drive\n- I will not allow any other person to drive the vehicle`,\n    fields: [\n      // Step 1: Scan Driving Licence (OCR extraction enabled)\n      { label: \"Scan Your Driving Licence\", fieldName: \"_section_licence_scan\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Take a photo or upload your driving licence (front)\", fieldName: \"licence_photo\", type: \"LICENCE_SCAN\", required: true, order: 2, helpText: \"We'll automatically extract your details to speed up the process\" },\n\n      // Test Drive Details - date defaults to today, time defaults to current time (handled in frontend)\n      { label: \"Test Drive Details\", fieldName: \"_section_testdrive\", type: \"SECTION_HEADER\", order: 5 },\n      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 6, defaultToday: true },\n      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 7, defaultNow: true },\n\n      // Your Details - auto-filled from licence if scanned\n      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 11, autoFillFromLicence: \"firstName\" },\n      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 12, autoFillFromLicence: \"lastName\" },\n      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 13 },\n      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 14 },\n\n      // Address - auto-filled from licence if scanned\n      { label: \"Address\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: true, order: 21, autoFillFromLicence: \"addressLine1\" },\n      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22, autoFillFromLicence: \"addressLine2\" },\n      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: true, order: 23, autoFillFromLicence: \"town\" },\n      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: true, order: 24, autoFillFromLicence: \"postcode\" },\n\n      // Vehicle Details\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 31, vrmLookup: true },\n      // Make and Model are hidden when vehicle is selected from stock (handled in frontend)\n      { label: \"Vehicle Make\", fieldName: \"vehicle_make\", type: \"TEXT\", required: false, order: 32, hiddenWhenStockSelected: true },\n      { label: \"Vehicle Model\", fieldName: \"vehicle_model\", type: \"TEXT\", required: false, order: 33, hiddenWhenStockSelected: true },\n      { label: \"Where did you find this vehicle?\", fieldName: \"source\", type: \"DROPDOWN\", required: true, order: 35, options: { choices: [\"AutoTrader\", \"eBay\", \"Facebook\", \"Google\", \"Referral\", \"Walk-in\", \"Other\"] } },\n\n      // Terms & Conditions\n      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"I agree to the Terms & Conditions\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n      { label: \"Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 42 },\n    ],\n  },"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2013,"cache_read_input_tokens":111905,"cache_creation":{"ephemeral_5m_input_tokens":2013,"ephemeral_1h_input_tokens":0},"output_tokens":2771,"service_tier":"standard"}},"requestId":"req_011CWd9AEY3xVuxG8uTbJucw","type":"assistant","uuid":"a7fe40e2-4a24-46dc-8fca-25e1e264536e","timestamp":"2025-12-30T15:54:27.137Z"}
{"type":"file-history-snapshot","messageId":"a7fe40e2-4a24-46dc-8fca-25e1e264536e","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"},"libs\\openai.js":{"backupFileName":"a8e7fe417f7ecf06@v1","version":1,"backupTime":"2025-12-30T15:50:12.398Z"},"components\\AISuggestionsPanel.js":{"backupFileName":"9b357355b418cc6f@v1","version":1,"backupTime":"2025-12-30T15:50:35.851Z"},"pages\\warranty.js":{"backupFileName":"a81b4f663f49afea@v1","version":1,"backupTime":"2025-12-30T15:51:31.630Z"},"pages\\api\\ai\\warranty-suggestions.js":{"backupFileName":"5b8ac4e37dc9954c@v1","version":1,"backupTime":"2025-12-30T15:52:02.934Z"},"pages\\api\\ai\\appraisal-issue-suggestions.js":{"backupFileName":"264b13f531a23f96@v1","version":1,"backupTime":"2025-12-30T15:52:13.361Z"},"pages\\api\\forms\\test-drive\\extract-licence.js":{"backupFileName":null,"version":1,"backupTime":"2025-12-30T15:53:38.201Z"},"libs\\formTemplates.js":{"backupFileName":"81e216fa5809acd6@v1","version":1,"backupTime":"2025-12-30T15:54:28.383Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"a7fe40e2-4a24-46dc-8fca-25e1e264536e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MzzmfwPSAXsrJpKckydC5k","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\libs\\formTemplates.js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   144→      { label: \"Inspector Signature\", fieldName: \"inspector_signature\", type: \"SIGNATURE\", required: true, order: 145 },\n   145→    ],\n   146→  },\n   147→\n   148→  // ═══════════════════════════════════════════════════════════════════════════════\n   149→  // Test Drive Request\n   150→  // ═══════════════════════════════════════════════════════════════════════════════\n   151→  {\n   152→    name: \"Test Drive Request\",\n   153→    type: \"TEST_DRIVE\",\n   154→    visibility: \"PUBLIC\", // Fully public - customers can access\n   155→    isPublic: true, // Deprecated - kept for backward compat\n   156→    publicSlug: \"test-drive\",\n   157→    introText: \"Please complete this form to book a test drive. You can scan your driving licence to auto-fill your details.\",\n   158→    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] },\n   159→    termsText: `By signing this form, I confirm that:\n   160→- I hold a valid UK driving licence\n   161→- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n   162→- I will follow all road traffic laws\n   163→- I am responsible for any parking or speeding fines incurred during the test drive\n   164→- I will not allow any other person to drive the vehicle`,\n   165→    fields: [\n   166→      // Step 1: Scan Driving Licence (OCR extraction enabled)\n   167→      { label: \"Scan Your Driving Licence\", fieldName: \"_section_licence_scan\", type: \"SECTION_HEADER\", order: 1 },\n   168→      { label: \"Take a photo or upload your driving licence (front)\", fieldName: \"licence_photo\", type: \"LICENCE_SCAN\", required: true, order: 2, helpText: \"We'll automatically extract your details to speed up the process\" },\n   169→\n   170→      // Test Drive Details - date defaults to today, time defaults to current time (handled in frontend)\n   171→      { label: \"Test Drive Details\", fieldName: \"_section_testdrive\", type: \"SECTION_HEADER\", order: 5 },\n   172→      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 6, defaultToday: true },\n   173→      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 7, defaultNow: true },\n   174→\n   175→      // Your Details - auto-filled from licence if scanned\n   176→      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },\n   177→      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 11, autoFillFromLicence: \"firstName\" },\n   178→      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 12, autoFillFromLicence: \"lastName\" },\n   179→      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 13 },\n   180→      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 14 },\n   181→\n   182→      // Address - auto-filled from licence if scanned\n   183→      { label: \"Address\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },\n   184→      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: true, order: 21, autoFillFromLicence: \"addressLine1\" },\n   185→      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22, autoFillFromLicence: \"addressLine2\" },\n   186→      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: true, order: 23, autoFillFromLicence: \"town\" },\n   187→      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: true, order: 24, autoFillFromLicence: \"postcode\" },\n   188→\n   189→      // Vehicle Details\n   190→      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 30 },\n   191→      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 31, vrmLookup: true },\n   192→      // Make and Model are hidden when vehicle is selected from stock (handled in frontend)\n   193→      { label: \"Vehicle Make\", fieldName: \"vehicle_make\", type: \"TEXT\", required: false, order: 32, hiddenWhenStockSelected: true },\n   194→      { label: \"Vehicle Model\", fieldName: \"vehicle_model\", type: \"TEXT\", required: false, order: 33, hiddenWhenStockSelected: true },\n   195→      { label: \"Where did you find this vehicle?\", fieldName: \"source\", type: \"DROPDOWN\", required: true, order: 35, options: { choices: [\"AutoTrader\", \"eBay\", \"Facebook\", \"Google\", \"Referral\", \"Walk-in\", \"Other\"] } },\n   196→\n   197→      // Terms & Conditions\n   198→      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n   199→      { label: \"I agree to the Terms & Conditions\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n   200→      { label: \"Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 42 },\n   201→    ],\n   202→  },\n   203→\n   204→  // ═══════════════════════════════════════════════════════════════════════════════\n   205→  // Courtesy Car Out\n   206→  // ═══════════════════════════════════════════════════════════════════════════════"}]},"uuid":"a8192373-5f89-43d2-ad6c-2c80cc5e585b","timestamp":"2025-12-30T15:54:28.375Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\libs\\formTemplates.js","oldString":"  // ═══════════════════════════════════════════════════════════════════════════════\n  // Test Drive Request\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Test Drive Request\",\n    type: \"TEST_DRIVE\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"test-drive\",\n    introText: \"Please complete this form to book a test drive. You must bring your valid driving licence on the day.\",\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] },\n    termsText: `By signing this form, I confirm that:\n- I hold a valid UK driving licence\n- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n- I will follow all road traffic laws\n- I am responsible for any parking or speeding fines incurred during the test drive\n- I will not allow any other person to drive the vehicle`,\n    fields: [\n      // Test Drive Details - date defaults to today, time defaults to current time (handled in frontend)\n      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 1 },\n      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 2 },\n      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 5 },\n      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 6 },\n      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 7 },\n      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 8 },\n      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 9 },\n      { label: \"Driving Licence\", fieldName: \"_section_licence\", type: \"SECTION_HEADER\", order: 15 },\n      { label: \"Upload Driving Licence (Front)\", fieldName: \"licence_photo\", type: \"FILE\", required: true, order: 16 },\n      { label: \"Address (if different from licence)\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: false, order: 21 },\n      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22 },\n      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: false, order: 23 },\n      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: false, order: 24 },\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 31, vrmLookup: true },\n      // Make and Model are hidden when vehicle is selected from stock (handled in frontend)\n      { label: \"Vehicle Make\", fieldName: \"vehicle_make\", type: \"TEXT\", required: false, order: 32, hiddenWhenStockSelected: true },\n      { label: \"Vehicle Model\", fieldName: \"vehicle_model\", type: \"TEXT\", required: false, order: 33, hiddenWhenStockSelected: true },\n      { label: \"Where did you find this vehicle?\", fieldName: \"source\", type: \"DROPDOWN\", required: true, order: 35, options: { choices: [\"AutoTrader\", \"eBay\", \"Facebook\", \"Google\", \"Referral\", \"Walk-in\", \"Other\"] } },\n      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"I agree to the Terms & Conditions\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n      { label: \"Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 42 },\n    ],\n  },","newString":"  // ═══════════════════════════════════════════════════════════════════════════════\n  // Test Drive Request\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Test Drive Request\",\n    type: \"TEST_DRIVE\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"test-drive\",\n    introText: \"Please complete this form to book a test drive. You can scan your driving licence to auto-fill your details.\",\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] },\n    termsText: `By signing this form, I confirm that:\n- I hold a valid UK driving licence\n- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n- I will follow all road traffic laws\n- I am responsible for any parking or speeding fines incurred during the test drive\n- I will not allow any other person to drive the vehicle`,\n    fields: [\n      // Step 1: Scan Driving Licence (OCR extraction enabled)\n      { label: \"Scan Your Driving Licence\", fieldName: \"_section_licence_scan\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Take a photo or upload your driving licence (front)\", fieldName: \"licence_photo\", type: \"LICENCE_SCAN\", required: true, order: 2, helpText: \"We'll automatically extract your details to speed up the process\" },\n\n      // Test Drive Details - date defaults to today, time defaults to current time (handled in frontend)\n      { label: \"Test Drive Details\", fieldName: \"_section_testdrive\", type: \"SECTION_HEADER\", order: 5 },\n      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 6, defaultToday: true },\n      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 7, defaultNow: true },\n\n      // Your Details - auto-filled from licence if scanned\n      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 11, autoFillFromLicence: \"firstName\" },\n      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 12, autoFillFromLicence: \"lastName\" },\n      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 13 },\n      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 14 },\n\n      // Address - auto-filled from licence if scanned\n      { label: \"Address\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: true, order: 21, autoFillFromLicence: \"addressLine1\" },\n      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22, autoFillFromLicence: \"addressLine2\" },\n      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: true, order: 23, autoFillFromLicence: \"town\" },\n      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: true, order: 24, autoFillFromLicence: \"postcode\" },\n\n      // Vehicle Details\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 31, vrmLookup: true },\n      // Make and Model are hidden when vehicle is selected from stock (handled in frontend)\n      { label: \"Vehicle Make\", fieldName: \"vehicle_make\", type: \"TEXT\", required: false, order: 32, hiddenWhenStockSelected: true },\n      { label: \"Vehicle Model\", fieldName: \"vehicle_model\", type: \"TEXT\", required: false, order: 33, hiddenWhenStockSelected: true },\n      { label: \"Where did you find this vehicle?\", fieldName: \"source\", type: \"DROPDOWN\", required: true, order: 35, options: { choices: [\"AutoTrader\", \"eBay\", \"Facebook\", \"Google\", \"Referral\", \"Walk-in\", \"Other\"] } },\n\n      // Terms & Conditions\n      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"I agree to the Terms & Conditions\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n      { label: \"Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 42 },\n    ],\n  },","originalFile":"// Default form templates for new dealers\n// Note: Appraisal forms are handled separately in the Appraisals section\n\n// Field types available:\n// TEXT, TEXTAREA, NUMBER, DATE, TIME, DATETIME, BOOLEAN, DROPDOWN, RADIO, FILE, SIGNATURE, RATING\n// SECTION_HEADER (display only), PARAGRAPH (display only), CHECKLIST (multiple checkboxes)\n\nexport const FORM_TEMPLATES = [\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // PDI (Pre-Delivery Inspection) - Comprehensive 8-section form\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"PDI (Pre-Delivery Inspection)\",\n    type: \"PDI\",\n    visibility: \"SHARE_LINK\", // Accessible via share link for 3rd parties (workshops, MOT centres)\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"pdi\",\n    introText: \"Complete all sections of this Pre-Delivery Inspection before vehicle handover.\",\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\"] },\n    fields: [\n      // Section 1: Vehicle Info\n      { label: \"Vehicle Information\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Make\", fieldName: \"make\", type: \"TEXT\", required: true, order: 3 },\n      { label: \"Model\", fieldName: \"model\", type: \"TEXT\", required: true, order: 4 },\n      { label: \"Mileage\", fieldName: \"mileage\", type: \"NUMBER\", required: true, order: 5 },\n      { label: \"Colour\", fieldName: \"colour\", type: \"TEXT\", required: true, order: 6 },\n      { label: \"Number of Keys\", fieldName: \"num_keys\", type: \"RADIO\", required: true, order: 7, options: { choices: [\"1\", \"2\", \"3+\"] } },\n\n      // Section 2: Interior Checks\n      { label: \"Interior Checks\", fieldName: \"_section_interior\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"Seat Adjustment\", fieldName: \"seat_adjustment\", type: \"RADIO\", required: true, order: 11, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Seat Belts\", fieldName: \"seat_belts\", type: \"RADIO\", required: true, order: 12, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Sun Visor/Sunroof\", fieldName: \"sun_visor\", type: \"RADIO\", required: true, order: 13, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Glove Box\", fieldName: \"glove_box\", type: \"RADIO\", required: true, order: 14, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Windows Front/Rear\", fieldName: \"windows\", type: \"RADIO\", required: true, order: 15, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Wipers\", fieldName: \"wipers\", type: \"RADIO\", required: true, order: 16, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Washer System\", fieldName: \"washer\", type: \"RADIO\", required: true, order: 17, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Sat Nav\", fieldName: \"sat_nav\", type: \"RADIO\", required: true, order: 18, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Horn\", fieldName: \"horn\", type: \"RADIO\", required: true, order: 19, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Fuel Gauge\", fieldName: \"fuel_gauge\", type: \"RADIO\", required: true, order: 20, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Temp Gauge\", fieldName: \"temp_gauge\", type: \"RADIO\", required: true, order: 21, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Dash Lights\", fieldName: \"dash_lights\", type: \"RADIO\", required: true, order: 22, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Audio System\", fieldName: \"audio_system\", type: \"RADIO\", required: true, order: 23, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Steering Wheel Controls\", fieldName: \"steering_controls\", type: \"RADIO\", required: true, order: 24, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Rear Camera\", fieldName: \"rear_camera\", type: \"RADIO\", required: true, order: 25, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Parking Sensors Front\", fieldName: \"parking_sensors_front\", type: \"RADIO\", required: true, order: 26, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Parking Sensors Rear\", fieldName: \"parking_sensors_rear\", type: \"RADIO\", required: true, order: 27, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Clock\", fieldName: \"clock\", type: \"RADIO\", required: true, order: 28, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Steering Tilt/Lock\", fieldName: \"steering_tilt\", type: \"RADIO\", required: true, order: 29, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"12V Outlet\", fieldName: \"outlet_12v\", type: \"RADIO\", required: true, order: 30, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Mirrors\", fieldName: \"mirrors\", type: \"RADIO\", required: true, order: 31, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Heated Seats\", fieldName: \"heated_seats\", type: \"RADIO\", required: true, order: 32, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Air Conditioning\", fieldName: \"air_con\", type: \"RADIO\", required: true, order: 33, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n      { label: \"Key Fobs Working\", fieldName: \"key_fobs\", type: \"RADIO\", required: true, order: 34, options: { choices: [\"Okay\", \"Repair/Replace\", \"N/A\"] } },\n\n      // Section 3: Equipment\n      { label: \"Equipment Checks\", fieldName: \"_section_equipment\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"Jack & Wrench\", fieldName: \"jack_wrench\", type: \"RADIO\", required: true, order: 41, options: { choices: [\"Present\", \"Missing\", \"N/A\"] } },\n      { label: \"Locking Wheel Nut Location\", fieldName: \"locking_nut_location\", type: \"TEXT\", required: false, order: 42 },\n      { label: \"Parcel Shelf\", fieldName: \"parcel_shelf\", type: \"RADIO\", required: true, order: 43, options: { choices: [\"Present\", \"Missing\", \"N/A\"] } },\n\n      // Section 4: Exterior\n      { label: \"Exterior Checks\", fieldName: \"_section_exterior\", type: \"SECTION_HEADER\", order: 50 },\n      { label: \"Wiper Blades\", fieldName: \"wiper_blades\", type: \"RADIO\", required: true, order: 51, options: { choices: [\"Okay\", \"Replace\", \"N/A\"] } },\n      { label: \"Bonnet\", fieldName: \"bonnet\", type: \"RADIO\", required: true, order: 52, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Boot\", fieldName: \"boot\", type: \"RADIO\", required: true, order: 53, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Door Locks\", fieldName: \"door_locks\", type: \"RADIO\", required: true, order: 54, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Central Locking\", fieldName: \"central_locking\", type: \"RADIO\", required: true, order: 55, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Exhaust\", fieldName: \"exhaust\", type: \"RADIO\", required: true, order: 56, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Fuel Cap\", fieldName: \"fuel_cap\", type: \"RADIO\", required: true, order: 57, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Aerial\", fieldName: \"aerial\", type: \"RADIO\", required: true, order: 58, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Wing Mirrors\", fieldName: \"wing_mirrors\", type: \"RADIO\", required: true, order: 59, options: { choices: [\"Okay\", \"Repair\", \"N/A\"] } },\n      { label: \"Windscreen Condition\", fieldName: \"windscreen\", type: \"RADIO\", required: true, order: 60, options: { choices: [\"Okay\", \"Chip\", \"Crack\", \"Replace\"] } },\n\n      // Tyres\n      { label: \"Tyres & Wheels\", fieldName: \"_section_tyres\", type: \"SECTION_HEADER\", order: 70 },\n      { label: \"Tyre Size Front\", fieldName: \"tyre_size_front\", type: \"TEXT\", required: true, order: 71 },\n      { label: \"Tyre Size Rear\", fieldName: \"tyre_size_rear\", type: \"TEXT\", required: true, order: 72 },\n      { label: \"Runflat Tyres\", fieldName: \"runflat\", type: \"RADIO\", required: true, order: 73, options: { choices: [\"Yes\", \"No\"] } },\n      { label: \"Tyre Depth - Front Left (mm)\", fieldName: \"tyre_depth_fl\", type: \"NUMBER\", required: true, order: 74 },\n      { label: \"Tyre Depth - Front Right (mm)\", fieldName: \"tyre_depth_fr\", type: \"NUMBER\", required: true, order: 75 },\n      { label: \"Tyre Depth - Rear Left (mm)\", fieldName: \"tyre_depth_rl\", type: \"NUMBER\", required: true, order: 76 },\n      { label: \"Tyre Depth - Rear Right (mm)\", fieldName: \"tyre_depth_rr\", type: \"NUMBER\", required: true, order: 77 },\n      { label: \"Brake Pad Depth - Front Left (mm)\", fieldName: \"brake_pad_fl\", type: \"NUMBER\", required: true, order: 78 },\n      { label: \"Brake Pad Depth - Front Right (mm)\", fieldName: \"brake_pad_fr\", type: \"NUMBER\", required: true, order: 79 },\n      { label: \"Brake Pad Depth - Rear Left (mm)\", fieldName: \"brake_pad_rl\", type: \"NUMBER\", required: true, order: 80 },\n      { label: \"Brake Pad Depth - Rear Right (mm)\", fieldName: \"brake_pad_rr\", type: \"NUMBER\", required: true, order: 81 },\n      { label: \"Wheels Condition\", fieldName: \"wheels_condition\", type: \"RADIO\", required: true, order: 82, options: { choices: [\"Good\", \"Minor Damage\", \"Needs Refurb\"] } },\n      { label: \"Tyre Pressure/Valves\", fieldName: \"tyre_pressure\", type: \"RADIO\", required: true, order: 83, options: { choices: [\"Okay\", \"Adjusted\", \"Issue\"] } },\n      { label: \"Brake Discs\", fieldName: \"brake_discs\", type: \"RADIO\", required: true, order: 84, options: { choices: [\"Okay\", \"Worn\", \"Replace\"] } },\n\n      // Section 5: Lights\n      { label: \"Light Checks\", fieldName: \"_section_lights\", type: \"SECTION_HEADER\", order: 90 },\n      { label: \"Headlights\", fieldName: \"headlights\", type: \"RADIO\", required: true, order: 91, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Brake Lights\", fieldName: \"brake_lights\", type: \"RADIO\", required: true, order: 92, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Fog Lights\", fieldName: \"fog_lights\", type: \"RADIO\", required: true, order: 93, options: { choices: [\"Okay\", \"Replace Bulb\", \"N/A\"] } },\n      { label: \"Reverse Lights\", fieldName: \"reverse_lights\", type: \"RADIO\", required: true, order: 94, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Indicators\", fieldName: \"indicators\", type: \"RADIO\", required: true, order: 95, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Number Plate Lights\", fieldName: \"number_plate_lights\", type: \"RADIO\", required: true, order: 96, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n      { label: \"Hazard Lights\", fieldName: \"hazard_lights\", type: \"RADIO\", required: true, order: 97, options: { choices: [\"Okay\", \"Repair\"] } },\n      { label: \"Interior Lights\", fieldName: \"interior_lights\", type: \"RADIO\", required: true, order: 98, options: { choices: [\"Okay\", \"Replace Bulb\", \"Repair\"] } },\n\n      // Section 6: Road Test\n      { label: \"Road Test\", fieldName: \"_section_road_test\", type: \"SECTION_HEADER\", order: 100 },\n      { label: \"Parking Brake\", fieldName: \"parking_brake\", type: \"RADIO\", required: true, order: 101, options: { choices: [\"Okay\", \"Adjust\", \"Repair\"] } },\n      { label: \"Steering Effort\", fieldName: \"steering_effort\", type: \"RADIO\", required: true, order: 102, options: { choices: [\"Normal\", \"Heavy\", \"Light\"] } },\n      { label: \"Tracking\", fieldName: \"tracking\", type: \"RADIO\", required: true, order: 103, options: { choices: [\"Okay\", \"Needs Alignment\"] } },\n      { label: \"Cruise Control\", fieldName: \"cruise_control\", type: \"RADIO\", required: true, order: 104, options: { choices: [\"Okay\", \"Not Working\", \"N/A\"] } },\n      { label: \"Odometer Matches\", fieldName: \"odometer_matches\", type: \"RADIO\", required: true, order: 105, options: { choices: [\"Yes\", \"No\"] } },\n      { label: \"Heaters Working\", fieldName: \"heaters\", type: \"RADIO\", required: true, order: 106, options: { choices: [\"Okay\", \"Not Working\"] } },\n      { label: \"Steering Vibration\", fieldName: \"steering_vibration\", type: \"RADIO\", required: true, order: 107, options: { choices: [\"None\", \"Minor\", \"Significant\"] } },\n      { label: \"Brake Wobble\", fieldName: \"brake_wobble\", type: \"RADIO\", required: true, order: 108, options: { choices: [\"None\", \"Minor\", \"Significant\"] } },\n      { label: \"Suspension\", fieldName: \"suspension\", type: \"RADIO\", required: true, order: 109, options: { choices: [\"Okay\", \"Noisy\", \"Repair\"] } },\n      { label: \"CV Joints\", fieldName: \"cv_joints\", type: \"RADIO\", required: true, order: 110, options: { choices: [\"Okay\", \"Clicking\", \"Replace\"] } },\n      { label: \"Clutch\", fieldName: \"clutch\", type: \"RADIO\", required: true, order: 111, options: { choices: [\"Okay\", \"Slipping\", \"N/A (Auto)\"] } },\n      { label: \"Gear Change\", fieldName: \"gear_change\", type: \"RADIO\", required: true, order: 112, options: { choices: [\"OK\", \"Repair\"] } },\n\n      // Section 7: Engine\n      { label: \"Engine Checks\", fieldName: \"_section_engine\", type: \"SECTION_HEADER\", order: 120 },\n      { label: \"Oil Level\", fieldName: \"oil_level\", type: \"RADIO\", required: true, order: 121, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n      { label: \"Brake Fluid\", fieldName: \"brake_fluid\", type: \"RADIO\", required: true, order: 122, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n      { label: \"Screen Wash\", fieldName: \"screen_wash\", type: \"RADIO\", required: true, order: 123, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n      { label: \"Coolant Level\", fieldName: \"coolant_level\", type: \"RADIO\", required: true, order: 124, options: { choices: [\"Okay\", \"Low\", \"Topped Up\"] } },\n      { label: \"Power Steering Fluid\", fieldName: \"power_steering\", type: \"RADIO\", required: true, order: 125, options: { choices: [\"Okay\", \"Low\", \"N/A (Electric)\"] } },\n      { label: \"Battery Condition\", fieldName: \"battery\", type: \"RADIO\", required: true, order: 126, options: { choices: [\"Good\", \"Weak\", \"Replace\"] } },\n      { label: \"Ignition\", fieldName: \"ignition\", type: \"RADIO\", required: true, order: 127, options: { choices: [\"Okay\", \"Issue\"] } },\n      { label: \"Fuel System\", fieldName: \"fuel_system\", type: \"RADIO\", required: true, order: 128, options: { choices: [\"Okay\", \"Leak\", \"Issue\"] } },\n      { label: \"Radiator\", fieldName: \"radiator\", type: \"RADIO\", required: true, order: 129, options: { choices: [\"Okay\", \"Leak\", \"Damage\"] } },\n      { label: \"Cooling Fan\", fieldName: \"cooling_fan\", type: \"RADIO\", required: true, order: 130, options: { choices: [\"Working\", \"Not Working\"] } },\n      { label: \"DPF Soot Level\", fieldName: \"dpf_soot\", type: \"RADIO\", required: false, order: 131, options: { choices: [\"OK\", \"Repair/Replace\"] } },\n\n      // Section 8: Issues Found (structured for automation)\n      { label: \"Issues Found\", fieldName: \"_section_issues\", type: \"SECTION_HEADER\", order: 133 },\n      { label: \"Add issues that need attention. These will be automatically added to the vehicle's issue list.\", fieldName: \"_issues_help\", type: \"PARAGRAPH\", order: 134 },\n      { label: \"Issues\", fieldName: \"pdi_issues\", type: \"PDI_ISSUES\", required: false, order: 135 },\n\n      // Section 9: Sign-off\n      { label: \"Sign-off\", fieldName: \"_section_signoff\", type: \"SECTION_HEADER\", order: 140 },\n      { label: \"Notes / Recommendations\", fieldName: \"notes\", type: \"TEXTAREA\", required: false, order: 141 },\n      { label: \"Photos\", fieldName: \"photos\", type: \"FILE\", required: false, order: 142 },\n      { label: \"PDI Carried Out By\", fieldName: \"inspector_name\", type: \"TEXT\", required: true, order: 143 },\n      { label: \"Date\", fieldName: \"pdi_date\", type: \"DATE\", required: true, order: 144 },\n      { label: \"Inspector Signature\", fieldName: \"inspector_signature\", type: \"SIGNATURE\", required: true, order: 145 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Test Drive Request\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Test Drive Request\",\n    type: \"TEST_DRIVE\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"test-drive\",\n    introText: \"Please complete this form to book a test drive. You must bring your valid driving licence on the day.\",\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] },\n    termsText: `By signing this form, I confirm that:\n- I hold a valid UK driving licence\n- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n- I will follow all road traffic laws\n- I am responsible for any parking or speeding fines incurred during the test drive\n- I will not allow any other person to drive the vehicle`,\n    fields: [\n      // Test Drive Details - date defaults to today, time defaults to current time (handled in frontend)\n      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 1 },\n      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 2 },\n      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 5 },\n      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 6 },\n      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 7 },\n      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 8 },\n      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 9 },\n      { label: \"Driving Licence\", fieldName: \"_section_licence\", type: \"SECTION_HEADER\", order: 15 },\n      { label: \"Upload Driving Licence (Front)\", fieldName: \"licence_photo\", type: \"FILE\", required: true, order: 16 },\n      { label: \"Address (if different from licence)\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: false, order: 21 },\n      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22 },\n      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: false, order: 23 },\n      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: false, order: 24 },\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 31, vrmLookup: true },\n      // Make and Model are hidden when vehicle is selected from stock (handled in frontend)\n      { label: \"Vehicle Make\", fieldName: \"vehicle_make\", type: \"TEXT\", required: false, order: 32, hiddenWhenStockSelected: true },\n      { label: \"Vehicle Model\", fieldName: \"vehicle_model\", type: \"TEXT\", required: false, order: 33, hiddenWhenStockSelected: true },\n      { label: \"Where did you find this vehicle?\", fieldName: \"source\", type: \"DROPDOWN\", required: true, order: 35, options: { choices: [\"AutoTrader\", \"eBay\", \"Facebook\", \"Google\", \"Referral\", \"Walk-in\", \"Other\"] } },\n      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"I agree to the Terms & Conditions\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n      { label: \"Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 42 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Courtesy Car Out\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Courtesy Car Out\",\n    type: \"COURTESY_OUT\",\n    visibility: \"INTERNAL\", // Staff only - requires login\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"courtesy-out\",\n    introText: \"Complete this form when issuing a courtesy vehicle to a customer.\",\n    vrmLookup: { enabled: true, statuses: [\"COURTESY\"], vehicleType: \"COURTESY\" },\n    termsText: `TERMS OF USE - COURTESY VEHICLE\n\n1. The vehicle must be returned with the same fuel level as when collected.\n2. The driver is responsible for any parking fines, speeding tickets, or congestion charges.\n3. The vehicle must not be driven outside the UK.\n4. Only named drivers on this form may drive the vehicle.\n5. Any damage must be reported immediately to {dealer.companyName}.\n6. The vehicle is covered by our insurance policy. Excess of £500 applies for any claims.\n7. The vehicle must be returned on the agreed date unless prior arrangement is made.\n\nFor emergencies, contact: {dealer.companyPhone}`,\n    fields: [\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Courtesy Vehicle Registration\", fieldName: \"courtesy_vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Current Mileage\", fieldName: \"mileage_out\", type: \"NUMBER\", required: true, order: 3 },\n      { label: \"Date/Time Out\", fieldName: \"datetime_out\", type: \"DATETIME\", required: true, order: 4 },\n      { label: \"Expected Return Date\", fieldName: \"date_due_back\", type: \"DATE\", required: true, order: 5 },\n      { label: \"Fuel Level\", fieldName: \"fuel_out\", type: \"RADIO\", required: true, order: 6, options: { choices: [\"Empty\", \"1/4\", \"1/2\", \"3/4\", \"Full\"] } },\n      { label: \"Customer Vehicle Registration\", fieldName: \"customer_vehicle_reg\", type: \"TEXT\", required: false, order: 7, placeholder: \"Customer's vehicle being repaired (if applicable)\" },\n\n      { label: \"Driver Information\", fieldName: \"_section_driver\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"First Name\", fieldName: \"driver_first_name\", type: \"TEXT\", required: true, order: 11 },\n      { label: \"Last Name\", fieldName: \"driver_last_name\", type: \"TEXT\", required: true, order: 12 },\n      { label: \"Mobile Number\", fieldName: \"driver_phone\", type: \"TEXT\", required: true, order: 13 },\n      { label: \"Date of Birth\", fieldName: \"driver_dob\", type: \"DATE\", required: true, order: 14 },\n      { label: \"Street Address\", fieldName: \"driver_address_street\", type: \"TEXT\", required: true, order: 15 },\n      { label: \"City\", fieldName: \"driver_address_city\", type: \"TEXT\", required: true, order: 16 },\n      { label: \"County\", fieldName: \"driver_address_county\", type: \"TEXT\", required: false, order: 17 },\n      { label: \"Post Code\", fieldName: \"driver_address_postcode\", type: \"TEXT\", required: true, order: 18 },\n\n      { label: \"Additional Driver (Optional)\", fieldName: \"_section_additional\", type: \"SECTION_HEADER\", order: 25 },\n      { label: \"Additional Driver Name\", fieldName: \"additional_driver_name\", type: \"TEXT\", required: false, order: 26 },\n      { label: \"Additional Driver Mobile\", fieldName: \"additional_driver_phone\", type: \"TEXT\", required: false, order: 27 },\n      { label: \"Additional Driver DOB\", fieldName: \"additional_driver_dob\", type: \"DATE\", required: false, order: 28 },\n\n      { label: \"Documents\", fieldName: \"_section_docs\", type: \"SECTION_HEADER\", order: 35 },\n      { label: \"Upload Driving Licence (Front & Back)\", fieldName: \"licence_photos\", type: \"FILE\", required: true, order: 36 },\n\n      { label: \"Condition Report\", fieldName: \"_section_condition\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"Existing Damage Notes\", fieldName: \"existing_damage\", type: \"TEXTAREA\", required: false, order: 41, placeholder: \"Note any existing scratches, dents, etc.\" },\n      { label: \"Condition Photos\", fieldName: \"condition_photos\", type: \"FILE\", required: false, order: 42 },\n\n      { label: \"Agreement\", fieldName: \"_section_agreement\", type: \"SECTION_HEADER\", order: 50 },\n      { label: \"I have read and agree to the terms of use\", fieldName: \"terms_accepted\", type: \"BOOLEAN\", required: true, order: 51 },\n      { label: \"I confirm the fuel level and mileage are correct\", fieldName: \"confirm_details\", type: \"BOOLEAN\", required: true, order: 52 },\n      { label: \"Driver Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 53 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Courtesy Car Return\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Courtesy Car Return\",\n    type: \"COURTESY_IN\",\n    visibility: \"INTERNAL\", // Staff only - requires login\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"courtesy-in\",\n    introText: \"Complete this form when a courtesy vehicle is returned.\",\n    vrmLookup: { enabled: true, statuses: [\"COURTESY\"], vehicleType: \"COURTESY\" },\n    fields: [\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Courtesy Vehicle Registration\", fieldName: \"courtesy_vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Date/Time Returned\", fieldName: \"datetime_returned\", type: \"DATETIME\", required: true, order: 3 },\n      { label: \"Mileage In\", fieldName: \"mileage_in\", type: \"NUMBER\", required: true, order: 4 },\n      { label: \"Fuel Level\", fieldName: \"fuel_in\", type: \"RADIO\", required: true, order: 5, options: { choices: [\"Empty\", \"1/4\", \"1/2\", \"3/4\", \"Full\"] } },\n      { label: \"Customer Vehicle Registration\", fieldName: \"customer_vehicle_reg\", type: \"TEXT\", required: false, order: 6, placeholder: \"Customer's vehicle being repaired (if applicable)\" },\n\n      { label: \"Driver Information\", fieldName: \"_section_driver\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"Driver Name\", fieldName: \"driver_name\", type: \"TEXT\", required: true, order: 11 },\n\n      { label: \"Return Condition\", fieldName: \"_section_condition\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Vehicle returned clean\", fieldName: \"returned_clean\", type: \"BOOLEAN\", required: true, order: 21 },\n      { label: \"No new damage\", fieldName: \"no_new_damage\", type: \"BOOLEAN\", required: true, order: 22 },\n      { label: \"All belongings removed\", fieldName: \"belongings_removed\", type: \"BOOLEAN\", required: true, order: 23 },\n      { label: \"Fuel level acceptable\", fieldName: \"fuel_acceptable\", type: \"BOOLEAN\", required: true, order: 24 },\n\n      { label: \"Issues / Disclosure\", fieldName: \"_section_issues\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Any damage or issues to report?\", fieldName: \"issues_notes\", type: \"TEXTAREA\", required: false, order: 31 },\n      { label: \"Damage Photos\", fieldName: \"damage_photos\", type: \"FILE\", required: false, order: 32 },\n\n      { label: \"Sign-off\", fieldName: \"_section_signoff\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"Driver Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 41 },\n      { label: \"Staff Member Name\", fieldName: \"staff_name\", type: \"TEXT\", required: true, order: 42 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Delivery Form\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Vehicle Delivery\",\n    type: \"DELIVERY\",\n    visibility: \"SHARE_LINK\", // Accessible via share link for 3rd parties (delivery drivers)\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"delivery\",\n    introText: \"Complete this form when handing over a vehicle to the customer.\",\n    vrmLookup: { enabled: true, statuses: [\"SOLD\", \"ADVERTISED\"] },\n    autoStatusChange: { newStatus: \"DELIVERED\" },\n    fields: [\n      { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Date\", fieldName: \"delivery_date\", type: \"DATE\", required: true, order: 3 },\n      { label: \"Time\", fieldName: \"delivery_time\", type: \"TIME\", required: true, order: 4 },\n\n      { label: \"Customer Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"Customer First Name\", fieldName: \"customer_first_name\", type: \"TEXT\", required: true, order: 11 },\n      { label: \"Customer Last Name\", fieldName: \"customer_last_name\", type: \"TEXT\", required: true, order: 12 },\n\n      { label: \"Documentation\", fieldName: \"_section_docs\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Photo of Invoice with ID\", fieldName: \"invoice_id_photo\", type: \"FILE\", required: true, order: 21 },\n      { label: \"Photo of Customer with Vehicle\", fieldName: \"customer_vehicle_photo\", type: \"FILE\", required: true, order: 22 },\n\n      { label: \"Consent\", fieldName: \"_section_consent\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Do you consent for the delivery photo to be used on our website/social media?\", fieldName: \"photo_consent\", type: \"RADIO\", required: true, order: 31, options: { choices: [\"Yes\", \"No\"] } },\n\n      { label: \"Sign-off\", fieldName: \"_section_signoff\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"Customer Signature\", fieldName: \"customer_signature\", type: \"SIGNATURE\", required: true, order: 41 },\n      { label: \"Staff Member Name\", fieldName: \"staff_name\", type: \"TEXT\", required: true, order: 42 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Service Receipt - Simplified layout matching PDF\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Service Receipt\",\n    type: \"SERVICE_RECEIPT\",\n    visibility: \"INTERNAL\", // Staff only - requires login\n    isPublic: false, // Deprecated - kept for backward compat\n    publicSlug: \"service-receipt\",\n    introText: null, // No intro text - clean header with dealer info\n    showDealerHeader: true, // Show dealer logo + address/phone in header\n    vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"SOLD\", \"DELIVERED\"] },\n    fields: [\n      // Row 1: Registration and Mileage side by side\n      { label: \"REGISTRATION\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 1, vrmLookup: true, gridGroup: \"row1\", uppercase: true },\n      { label: \"MILEAGE\", fieldName: \"mileage\", type: \"NUMBER\", required: true, order: 2, gridGroup: \"row1\", uppercase: true },\n\n      // Row 2: Make and Model side by side (auto-fill from VRM lookup)\n      { label: \"MAKE\", fieldName: \"make\", type: \"TEXT\", required: false, order: 3, gridGroup: \"row2\", uppercase: true },\n      { label: \"MODEL\", fieldName: \"model\", type: \"TEXT\", required: false, order: 4, gridGroup: \"row2\", uppercase: true },\n\n      // Work Carried Out section with checkboxes\n      { label: \"WORK CARRIED OUT\", fieldName: \"_section_work\", type: \"SECTION_HEADER\", order: 10, uppercase: true },\n      { label: \"OIL FILTER\", fieldName: \"oil_filter\", type: \"BOOLEAN\", required: false, order: 11, uppercase: true },\n      { label: \"AIR FILTER\", fieldName: \"air_filter\", type: \"BOOLEAN\", required: false, order: 12, uppercase: true },\n      { label: \"CABIN FILTER\", fieldName: \"cabin_filter\", type: \"BOOLEAN\", required: false, order: 13, uppercase: true },\n      { label: \"SPARK PLUGS\", fieldName: \"spark_plugs\", type: \"BOOLEAN\", required: false, order: 14, uppercase: true },\n      { label: \"PRE-DELIVERY INSPECTION\", fieldName: \"pdi_done\", type: \"BOOLEAN\", required: false, order: 15, uppercase: true },\n\n      // Additional Works section\n      { label: \"ADDITIONAL WORKS\", fieldName: \"_section_additional\", type: \"SECTION_HEADER\", order: 20, uppercase: true },\n      { label: \"ADDITIONAL WORKS\", fieldName: \"additional_works\", type: \"TEXTAREA\", required: false, order: 21, uppercase: true },\n\n      // Date Carried Out at the end\n      { label: \"DATE CARRIED OUT\", fieldName: \"service_date\", type: \"DATE\", required: true, order: 30, uppercase: true },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Warranty Claim\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Warranty Claim\",\n    type: \"WARRANTY_CLAIM\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"warranty-claim\",\n    introText: `Please fill out the form below in as much detail as possible. For more information about what is and isn't covered under your warranty please refer to page 5 of your warranty booklet.\n\nWe will only accept one claim per submission, submitting more than once may delay your claim being processed.\n\nPlease allow up to 48 hours for a response.\n\nPLEASE NOTE: ONLY THE PURCHASER OF THE VEHICLE CAN SUBMIT A CLAIM AND MUST HAVE REGISTERED THEIR WARRANTY.`,\n    vrmLookup: { enabled: true, statuses: [\"SOLD\", \"DELIVERED\"] },\n    termsText: `• I understand that I can use this form to report an issue however, it may not be a claimable issue.\n• I understand it may take up to 48 hours to receive a response to this claim form, and not to report the issue again as this may delay the claim further.\n• I understand that if I go ahead and undertake work without authorisation I am liable for the costs.`,\n    fields: [\n      // Section: Purchase Information\n      { label: \"Purchase Information\", fieldName: \"_section_purchase\", type: \"SECTION_HEADER\", order: 1 },\n      { label: \"Registration at time of purchase\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 2, vrmLookup: true },\n      { label: \"Purchase Date\", fieldName: \"purchase_date\", type: \"DATE\", required: true, order: 3 },\n      { label: \"Vehicle Make and Model\", fieldName: \"vehicle_make_model\", type: \"TEXT\", required: false, order: 4 },\n      { label: \"Exact Mileage\", fieldName: \"exact_mileage\", type: \"TEXT\", required: true, order: 5, placeholder: \"e.g. 23456\" },\n\n      // Section: Customer Details\n      { label: \"Customer Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },\n      { label: \"Customer Name\", fieldName: \"customer_name\", type: \"TEXT\", required: true, order: 11 },\n      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 12 },\n      { label: \"Phone Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 13, helpText: \"Please enter a valid phone number\" },\n      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: true, order: 14 },\n      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 15 },\n      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: true, order: 16 },\n      { label: \"County / State\", fieldName: \"address_county\", type: \"TEXT\", required: false, order: 17 },\n      { label: \"Postcode\", fieldName: \"address_postcode\", type: \"TEXT\", required: true, order: 18 },\n\n      // Section: Issue Description\n      { label: \"Issue Description\", fieldName: \"_section_issue\", type: \"SECTION_HEADER\", order: 20 },\n      { label: \"Please describe the issue in as much detail as possible\", fieldName: \"issue_description\", type: \"TEXTAREA\", required: true, order: 21, helpText: \"Include any warning lights on the dashboard, noises, symptoms, when the issue occurs, etc.\" },\n      { label: \"Upload Pictures / Videos\", fieldName: \"issue_media\", type: \"FILE\", required: false, order: 22, helpText: \"You can upload multiple files. Drag and drop or click to select.\" },\n\n      // Section: Warranty Type\n      { label: \"Warranty Information\", fieldName: \"_section_warranty\", type: \"SECTION_HEADER\", order: 30 },\n      { label: \"Warranty Type\", fieldName: \"warranty_type\", type: \"DROPDOWN\", required: true, order: 31, options: { choices: [\"Dealer Warranty\", \"External Warranty\"] }, placeholder: \"Please Select\" },\n\n      // Section: Terms & Conditions\n      { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },\n      { label: \"I agree and I have read the terms and condition details above.\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },\n    ],\n  },\n\n  // ═══════════════════════════════════════════════════════════════════════════════\n  // Review & Feedback\n  // ═══════════════════════════════════════════════════════════════════════════════\n  {\n    name: \"Review & Feedback\",\n    type: \"REVIEW_FEEDBACK\",\n    visibility: \"PUBLIC\", // Fully public - customers can access\n    isPublic: true, // Deprecated - kept for backward compat\n    publicSlug: \"review\",\n    introText: \"We'd love to hear about your experience! Your feedback helps us improve our service.\",\n    fields: [\n      { label: \"Your Name\", fieldName: \"name\", type: \"TEXT\", required: true, order: 1 },\n      { label: \"Email (optional)\", fieldName: \"email\", type: \"TEXT\", required: false, order: 2 },\n      { label: \"Overall Rating\", fieldName: \"rating\", type: \"RATING\", required: true, order: 3 },\n      { label: \"What did we do well?\", fieldName: \"positive_feedback\", type: \"TEXTAREA\", required: false, order: 4 },\n      { label: \"What could we improve?\", fieldName: \"improvement_feedback\", type: \"TEXTAREA\", required: false, order: 5 },\n      { label: \"Would you recommend us to friends and family?\", fieldName: \"would_recommend\", type: \"RADIO\", required: true, order: 6, options: { choices: [\"Definitely\", \"Probably\", \"Not Sure\", \"Probably Not\", \"Definitely Not\"] } },\n    ],\n  },\n];\n\n// List of form types that have been deprecated and should be removed\nexport const DEPRECATED_FORM_TYPES = [\"CAR_PREP\", \"BUYING_APPRAISAL\", \"CUSTOMER_PX_APPRAISAL\"];\n\n// Valid form types (for model enum)\nexport const VALID_FORM_TYPES = [\"PDI\", \"TEST_DRIVE\", \"WARRANTY_CLAIM\", \"COURTESY_OUT\", \"COURTESY_IN\", \"DELIVERY\", \"SERVICE_RECEIPT\", \"REVIEW_FEEDBACK\", \"OTHER\"];\n\n// Default intro/terms text that can be customized per dealer\nexport const DEFAULT_FORM_TEXT = {\n  WARRANTY_CLAIM: {\n    introText: `Please fill out the form below in as much detail as possible. We will only accept one claim per submission, submitting more than once may delay your claim being processed.\n\nPlease allow up to 48 hours for a response.`,\n  },\n  TEST_DRIVE: {\n    termsText: `By signing this form, I confirm that:\n- I hold a valid UK driving licence\n- I am covered by {dealer.companyName}'s insurance for the duration of the test drive\n- I will follow all road traffic laws\n- I am responsible for any parking or speeding fines incurred during the test drive\n- I will not allow any other person to drive the vehicle`,\n  },\n  COURTESY_OUT: {\n    termsText: `TERMS OF USE - COURTESY VEHICLE\n\n1. The vehicle must be returned with the same fuel level as when collected.\n2. The driver is responsible for any parking fines, speeding tickets, or congestion charges.\n3. The vehicle must not be driven outside the UK.\n4. Only named drivers on this form may drive the vehicle.\n5. Any damage must be reported immediately.\n6. The vehicle is covered by our insurance policy. Excess of £500 applies for any claims.\n7. The vehicle must be returned on the agreed date unless prior arrangement is made.`,\n  },\n};\n","structuredPatch":[{"oldStart":154,"oldLines":7,"newStart":154,"newLines":7,"lines":["     visibility: \"PUBLIC\", // Fully public - customers can access","     isPublic: true, // Deprecated - kept for backward compat","     publicSlug: \"test-drive\",","-    introText: \"Please complete this form to book a test drive. You must bring your valid driving licence on the day.\",","+    introText: \"Please complete this form to book a test drive. You can scan your driving licence to auto-fill your details.\",","     vrmLookup: { enabled: true, statuses: [\"IN_PREP\", \"ADVERTISED\", \"LIVE\"] },","     termsText: `By signing this form, I confirm that:"," - I hold a valid UK driving licence"]},{"oldStart":163,"oldLines":27,"newStart":163,"newLines":38,"lines":[" - I am responsible for any parking or speeding fines incurred during the test drive"," - I will not allow any other person to drive the vehicle`,","     fields: [","+      // Step 1: Scan Driving Licence (OCR extraction enabled)","+      { label: \"Scan Your Driving Licence\", fieldName: \"_section_licence_scan\", type: \"SECTION_HEADER\", order: 1 },","+      { label: \"Take a photo or upload your driving licence (front)\", fieldName: \"licence_photo\", type: \"LICENCE_SCAN\", required: true, order: 2, helpText: \"We'll automatically extract your details to speed up the process\" },","+","       // Test Drive Details - date defaults to today, time defaults to current time (handled in frontend)","-      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 1 },","-      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 2 },","-      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 5 },","-      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 6 },","-      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 7 },","-      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 8 },","-      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 9 },","-      { label: \"Driving Licence\", fieldName: \"_section_licence\", type: \"SECTION_HEADER\", order: 15 },","-      { label: \"Upload Driving Licence (Front)\", fieldName: \"licence_photo\", type: \"FILE\", required: true, order: 16 },","-      { label: \"Address (if different from licence)\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },","-      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: false, order: 21 },","-      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22 },","-      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: false, order: 23 },","-      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: false, order: 24 },","+      { label: \"Test Drive Details\", fieldName: \"_section_testdrive\", type: \"SECTION_HEADER\", order: 5 },","+      { label: \"Date of Test Drive\", fieldName: \"date\", type: \"DATE\", required: true, order: 6, defaultToday: true },","+      { label: \"Time\", fieldName: \"time\", type: \"TIME\", required: true, order: 7, defaultNow: true },","+","+      // Your Details - auto-filled from licence if scanned","+      { label: \"Your Details\", fieldName: \"_section_customer\", type: \"SECTION_HEADER\", order: 10 },","+      { label: \"First Name\", fieldName: \"first_name\", type: \"TEXT\", required: true, order: 11, autoFillFromLicence: \"firstName\" },","+      { label: \"Last Name\", fieldName: \"last_name\", type: \"TEXT\", required: true, order: 12, autoFillFromLicence: \"lastName\" },","+      { label: \"Email\", fieldName: \"email\", type: \"TEXT\", required: true, order: 13 },","+      { label: \"Contact Number\", fieldName: \"phone\", type: \"TEXT\", required: true, order: 14 },","+","+      // Address - auto-filled from licence if scanned","+      { label: \"Address\", fieldName: \"_section_address\", type: \"SECTION_HEADER\", order: 20 },","+      { label: \"Street Address\", fieldName: \"address_street\", type: \"TEXT\", required: true, order: 21, autoFillFromLicence: \"addressLine1\" },","+      { label: \"Address Line 2\", fieldName: \"address_line2\", type: \"TEXT\", required: false, order: 22, autoFillFromLicence: \"addressLine2\" },","+      { label: \"City\", fieldName: \"address_city\", type: \"TEXT\", required: true, order: 23, autoFillFromLicence: \"town\" },","+      { label: \"Post Code\", fieldName: \"address_postcode\", type: \"TEXT\", required: true, order: 24, autoFillFromLicence: \"postcode\" },","+","+      // Vehicle Details","       { label: \"Vehicle Details\", fieldName: \"_section_vehicle\", type: \"SECTION_HEADER\", order: 30 },","       { label: \"Vehicle Registration\", fieldName: \"vrm\", type: \"TEXT\", required: true, order: 31, vrmLookup: true },","       // Make and Model are hidden when vehicle is selected from stock (handled in frontend)","       { label: \"Vehicle Make\", fieldName: \"vehicle_make\", type: \"TEXT\", required: false, order: 32, hiddenWhenStockSelected: true },","       { label: \"Vehicle Model\", fieldName: \"vehicle_model\", type: \"TEXT\", required: false, order: 33, hiddenWhenStockSelected: true },","       { label: \"Where did you find this vehicle?\", fieldName: \"source\", type: \"DROPDOWN\", required: true, order: 35, options: { choices: [\"AutoTrader\", \"eBay\", \"Facebook\", \"Google\", \"Referral\", \"Walk-in\", \"Other\"] } },","+","+      // Terms & Conditions","       { label: \"Terms & Conditions\", fieldName: \"_section_terms\", type: \"SECTION_HEADER\", order: 40 },","       { label: \"I agree to the Terms & Conditions\", fieldName: \"agree_terms\", type: \"BOOLEAN\", required: true, order: 41 },","       { label: \"Signature\", fieldName: \"signature\", type: \"SIGNATURE\", required: true, order: 42 },"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"a8192373-5f89-43d2-ad6c-2c80cc5e585b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_013TWMaJNAcnvWmxMNLdXLF8","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to create the LicenceScan component that will handle the camera/upload and extraction logic. I also need to find the form filler page and update it to handle the new field type.\n\nLet me look for the form filler page:","signature":"EowDCkYICxgCKkC1rpoCcjfOgkQogk7oupFQgAPu2/trWhqJGalCWsMoM7zqA/+Ps2lU5jxZAUGBMKU52Ti85j6xi0GE0seK/YWPEgxr2Mthslo0SYzVTagaDGU72NemEglkEO9pfiIw7jlHOSM0crbAgtmYAIR/KyJuJujY+xsFpST2DRFOFrRmYZuVZiKQ28Zr59mO1SFUKvMB13aUxaVU9SkAo0du4wKyCD7wxD3zeBAmaYKS62TZMKIprvDHkZvMFgbK10WZNDTwqvwfjxfeZscoWXFnoRfQ/LTRwqqT9g0OUo1blqDJ+mOm0ut6ru39EBiyJmWA3n7Mby31Zl2jXQFLUrEfWHXc3W9yBPZtEk1uEBkyd6inXV5ukJm7UnM47HFHgPV8rONGws5KK4eeoQ4NI5s5pOhCa2Y4cLhQ+foSH1dRBx/qQuCnHRqPvXhEGgYFlEgAIrL3I1x0Q6hYZP4dWgiN3yR+gq4FB7dra76QIXV5vqZLgUDscpEVsurjwpoVsJeM+R8U37CPGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":4421,"cache_read_input_tokens":113918,"cache_creation":{"ephemeral_5m_input_tokens":4421,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9Dv7deM7kx9we289x5","type":"assistant","uuid":"ed4eea46-e92d-4d95-a21e-d8074a8d7369","timestamp":"2025-12-30T15:54:34.224Z"}
{"parentUuid":"ed4eea46-e92d-4d95-a21e-d8074a8d7369","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_013TWMaJNAcnvWmxMNLdXLF8","type":"message","role":"assistant","content":[{"type":"text","text":"Now I need to create the LicenceScan component. Let me first find the form filler page to understand how it renders fields:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":4421,"cache_read_input_tokens":113918,"cache_creation":{"ephemeral_5m_input_tokens":4421,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9Dv7deM7kx9we289x5","type":"assistant","uuid":"e5a0bbd8-05a6-4841-b855-2924afa022d8","timestamp":"2025-12-30T15:54:34.881Z"}
{"parentUuid":"e5a0bbd8-05a6-4841-b855-2924afa022d8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_013TWMaJNAcnvWmxMNLdXLF8","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HUA8Z5v9ug4kgy3zstqb6p","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","limit":150}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":4421,"cache_read_input_tokens":113918,"cache_creation":{"ephemeral_5m_input_tokens":4421,"ephemeral_1h_input_tokens":0},"output_tokens":181,"service_tier":"standard"}},"requestId":"req_011CWd9Dv7deM7kx9we289x5","type":"assistant","uuid":"3b3742c5-2f37-4a25-ae7f-1d36dd62eda0","timestamp":"2025-12-30T15:54:36.205Z"}
{"parentUuid":"3b3742c5-2f37-4a25-ae7f-1d36dd62eda0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HUA8Z5v9ug4kgy3zstqb6p","type":"tool_result","content":"     1→import { useState, useEffect, useCallback } from \"react\";\n     2→import Head from \"next/head\";\n     3→import Link from \"next/link\";\n     4→import { useRouter } from \"next/router\";\n     5→import dynamic from \"next/dynamic\";\n     6→import DashboardLayout from \"@/components/DashboardLayout\";\n     7→import toast from \"react-hot-toast\";\n     8→import { FORM_TEMPLATES } from \"@/libs/formTemplates\";\n     9→\n    10→// Dynamic import for signature pad (client-side only)\n    11→const DrawableSignature = dynamic(() => import(\"@/components/DrawableSignature\"), {\n    12→  ssr: false,\n    13→  loading: () => <div className=\"h-[150px] bg-base-200 rounded-lg animate-pulse\" />\n    14→});\n    15→\n    16→// Human-readable form type labels\n    17→const FORM_TYPE_LABELS = {\n    18→  PDI: \"PDI\",\n    19→  TEST_DRIVE: \"Test Drive\",\n    20→  WARRANTY_CLAIM: \"Warranty Claim\",\n    21→  COURTESY_OUT: \"Courtesy Car Out\",\n    22→  COURTESY_IN: \"Courtesy Car In\",\n    23→  DELIVERY: \"Delivery\",\n    24→  SERVICE_RECEIPT: \"Service Receipt\",\n    25→  REVIEW_FEEDBACK: \"Review & Feedback\",\n    26→  OTHER: \"Other\",\n    27→};\n    28→\n    29→export default function FillForm() {\n    30→  const router = useRouter();\n    31→  const { id } = router.query;\n    32→\n    33→  const [form, setForm] = useState(null);\n    34→  const [fields, setFields] = useState([]);\n    35→  const [formData, setFormData] = useState({});\n    36→  const [isLoading, setIsLoading] = useState(true);\n    37→  const [isSubmitting, setIsSubmitting] = useState(false);\n    38→  const [isLookingUp, setIsLookingUp] = useState(false);\n    39→  const [submittedId, setSubmittedId] = useState(null);\n    40→  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n    41→  const [stockVehicles, setStockVehicles] = useState([]);\n    42→  const [stockSearch, setStockSearch] = useState(\"\");\n    43→  // Smart VRM lookup state\n    44→  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n    45→  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n    46→  const [vrmLookupConfig, setVrmLookupConfig] = useState(null);\n    47→  // Dealer info for token replacement\n    48→  const [dealer, setDealer] = useState(null);\n    49→\n    50→  useEffect(() => {\n    51→    if (id) {\n    52→      loadForm();\n    53→      loadDealer();\n    54→    }\n    55→  }, [id]);\n    56→\n    57→  const loadDealer = async () => {\n    58→    try {\n    59→      const res = await fetch(\"/api/dealer\");\n    60→      const data = await res.json();\n    61→      setDealer(data);\n    62→    } catch (error) {\n    63→      console.error(\"Failed to load dealer:\", error);\n    64→    }\n    65→  };\n    66→\n    67→  // Replace tokens in text with dealer info\n    68→  const replaceTokens = (text) => {\n    69→    if (!text || !dealer) return text;\n    70→    return text\n    71→      .replace(/\\{companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n    72→      .replace(/\\{companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n    73→      .replace(/\\{companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n    74→      .replace(/\\{companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\")\n    75→      .replace(/\\{dealer\\.companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n    76→      .replace(/\\{dealer\\.companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n    77→      .replace(/\\{dealer\\.companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n    78→      .replace(/\\{dealer\\.companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\");\n    79→  };\n    80→\n    81→  // Format terms text as bullet list\n    82→  const formatTermsAsList = (text) => {\n    83→    if (!text) return null;\n    84→    const processedText = replaceTokens(text);\n    85→\n    86→    // Split by bullet points, dashes, or numbered items\n    87→    const lines = processedText\n    88→      .split(/(?:^|\\n)(?:•|●|-|\\d+\\.)\\s*/g)\n    89→      .map(line => line.trim())\n    90→      .filter(line => line.length > 0);\n    91→\n    92→    if (lines.length <= 1) {\n    93→      // If no bullet format detected, try splitting by newlines\n    94→      const newlineLines = processedText.split(\"\\n\").filter(line => line.trim());\n    95→      if (newlineLines.length > 1) {\n    96→        return (\n    97→          <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n    98→            {newlineLines.map((line, idx) => (\n    99→              <li key={idx}>{line.trim().replace(/^[-•●]\\s*/, \"\")}</li>\n   100→            ))}\n   101→          </ul>\n   102→        );\n   103→      }\n   104→      return <p className=\"text-sm text-base-content/80 whitespace-pre-wrap\">{processedText}</p>;\n   105→    }\n   106→\n   107→    return (\n   108→      <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n   109→        {lines.map((line, idx) => (\n   110→          <li key={idx}>{line}</li>\n   111→        ))}\n   112→      </ul>\n   113→    );\n   114→  };\n   115→\n   116→  useEffect(() => {\n   117→    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {\n   118→      fetchCourtesyVehicles();\n   119→    }\n   120→    if (form?.type === \"TEST_DRIVE\") {\n   121→      fetchStockVehicles();\n   122→    }\n   123→    // Get VRM lookup config from templates\n   124→    if (form?.type) {\n   125→      const template = FORM_TEMPLATES.find(t => t.type === form.type);\n   126→      if (template?.vrmLookup) {\n   127→        setVrmLookupConfig(template.vrmLookup);\n   128→      }\n   129→    }\n   130→  }, [form?.type]);\n   131→\n   132→  // Initialize default values for time/date fields\n   133→  useEffect(() => {\n   134→    if (!fields.length) return;\n   135→    const now = new Date();\n   136→    const updates = {};\n   137→\n   138→    // Test Drive form: default date and time\n   139→    if (form?.type === \"TEST_DRIVE\") {\n   140→      const timeField = fields.find(f => f.fieldName === \"time\" && f.type === \"TIME\");\n   141→      const dateField = fields.find(f => f.fieldName === \"date\" && f.type === \"DATE\");\n   142→\n   143→      // Set default time to current time (rounded to nearest 15 min)\n   144→      if (timeField && !formData.time) {\n   145→        const minutes = Math.round(now.getMinutes() / 15) * 15;\n   146→        const hours = now.getHours() + (minutes >= 60 ? 1 : 0);\n   147→        const adjustedMinutes = minutes >= 60 ? 0 : minutes;\n   148→        updates.time = `${String(hours).padStart(2, \"0\")}:${String(adjustedMinutes).padStart(2, \"0\")}`;\n   149→      }\n   150→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"668cb938-8125-48d1-bcac-455a94f0bad1","timestamp":"2025-12-30T15:54:37.698Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","content":"import { useState, useEffect, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";\nimport dynamic from \"next/dynamic\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport toast from \"react-hot-toast\";\nimport { FORM_TEMPLATES } from \"@/libs/formTemplates\";\n\n// Dynamic import for signature pad (client-side only)\nconst DrawableSignature = dynamic(() => import(\"@/components/DrawableSignature\"), {\n  ssr: false,\n  loading: () => <div className=\"h-[150px] bg-base-200 rounded-lg animate-pulse\" />\n});\n\n// Human-readable form type labels\nconst FORM_TYPE_LABELS = {\n  PDI: \"PDI\",\n  TEST_DRIVE: \"Test Drive\",\n  WARRANTY_CLAIM: \"Warranty Claim\",\n  COURTESY_OUT: \"Courtesy Car Out\",\n  COURTESY_IN: \"Courtesy Car In\",\n  DELIVERY: \"Delivery\",\n  SERVICE_RECEIPT: \"Service Receipt\",\n  REVIEW_FEEDBACK: \"Review & Feedback\",\n  OTHER: \"Other\",\n};\n\nexport default function FillForm() {\n  const router = useRouter();\n  const { id } = router.query;\n\n  const [form, setForm] = useState(null);\n  const [fields, setFields] = useState([]);\n  const [formData, setFormData] = useState({});\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [submittedId, setSubmittedId] = useState(null);\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [stockVehicles, setStockVehicles] = useState([]);\n  const [stockSearch, setStockSearch] = useState(\"\");\n  // Smart VRM lookup state\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  const [vrmLookupConfig, setVrmLookupConfig] = useState(null);\n  // Dealer info for token replacement\n  const [dealer, setDealer] = useState(null);\n\n  useEffect(() => {\n    if (id) {\n      loadForm();\n      loadDealer();\n    }\n  }, [id]);\n\n  const loadDealer = async () => {\n    try {\n      const res = await fetch(\"/api/dealer\");\n      const data = await res.json();\n      setDealer(data);\n    } catch (error) {\n      console.error(\"Failed to load dealer:\", error);\n    }\n  };\n\n  // Replace tokens in text with dealer info\n  const replaceTokens = (text) => {\n    if (!text || !dealer) return text;\n    return text\n      .replace(/\\{companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\")\n      .replace(/\\{dealer\\.companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{dealer\\.companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{dealer\\.companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{dealer\\.companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\");\n  };\n\n  // Format terms text as bullet list\n  const formatTermsAsList = (text) => {\n    if (!text) return null;\n    const processedText = replaceTokens(text);\n\n    // Split by bullet points, dashes, or numbered items\n    const lines = processedText\n      .split(/(?:^|\\n)(?:•|●|-|\\d+\\.)\\s*/g)\n      .map(line => line.trim())\n      .filter(line => line.length > 0);\n\n    if (lines.length <= 1) {\n      // If no bullet format detected, try splitting by newlines\n      const newlineLines = processedText.split(\"\\n\").filter(line => line.trim());\n      if (newlineLines.length > 1) {\n        return (\n          <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n            {newlineLines.map((line, idx) => (\n              <li key={idx}>{line.trim().replace(/^[-•●]\\s*/, \"\")}</li>\n            ))}\n          </ul>\n        );\n      }\n      return <p className=\"text-sm text-base-content/80 whitespace-pre-wrap\">{processedText}</p>;\n    }\n\n    return (\n      <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n        {lines.map((line, idx) => (\n          <li key={idx}>{line}</li>\n        ))}\n      </ul>\n    );\n  };\n\n  useEffect(() => {\n    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {\n      fetchCourtesyVehicles();\n    }\n    if (form?.type === \"TEST_DRIVE\") {\n      fetchStockVehicles();\n    }\n    // Get VRM lookup config from templates\n    if (form?.type) {\n      const template = FORM_TEMPLATES.find(t => t.type === form.type);\n      if (template?.vrmLookup) {\n        setVrmLookupConfig(template.vrmLookup);\n      }\n    }\n  }, [form?.type]);\n\n  // Initialize default values for time/date fields\n  useEffect(() => {\n    if (!fields.length) return;\n    const now = new Date();\n    const updates = {};\n\n    // Test Drive form: default date and time\n    if (form?.type === \"TEST_DRIVE\") {\n      const timeField = fields.find(f => f.fieldName === \"time\" && f.type === \"TIME\");\n      const dateField = fields.find(f => f.fieldName === \"date\" && f.type === \"DATE\");\n\n      // Set default time to current time (rounded to nearest 15 min)\n      if (timeField && !formData.time) {\n        const minutes = Math.round(now.getMinutes() / 15) * 15;\n        const hours = now.getHours() + (minutes >= 60 ? 1 : 0);\n        const adjustedMinutes = minutes >= 60 ? 0 : minutes;\n        updates.time = `${String(hours).padStart(2, \"0\")}:${String(adjustedMinutes).padStart(2, \"0\")}`;\n      }\n","numLines":150,"startLine":1,"totalLines":1132}}}
{"parentUuid":"668cb938-8125-48d1-bcac-455a94f0bad1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GjWJ8DvCjat4MY8b8DAWfc","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to see more of the form filler to understand how fields are rendered. Let me search for where field types are rendered:","signature":"EqcCCkYICxgCKkD5v5QwCbvLsVAn/QLQwTAac6579I2p1gqQQDDOLrH3WjZE4DQ+CvT3AV1tZuxcN5b3VF6y6hWbXyIkCgK2kktoEgxYDEXm8Z3v+QChLI8aDEn66XqHouyMnlf0uCIwQEOeZYWpC7eROCSft/Grs0t2tRtQOQn8+iMLS46QwjVO5lmzLAhRPKAldLHlasWUKo4Bp/oUWTf4PLjlNK8srE+TX2Tq3m1fyr0PFFggicQur0q6HNjTSt3MtEU9BbbKQvRVlKj62vUX3j5t4+PzxI5uArwUH5X9wOUBmnUw/BQVocLscNVwogcgL3SaWPqcSGYAc4lTzR9Suz0spUsaJR/ApRsZhdoGJNFlIq/czUmQFMcn/Myta7PLEj8XDboGaBgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2712,"cache_read_input_tokens":118339,"cache_creation":{"ephemeral_5m_input_tokens":2712,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd9EdK7tQxo51S43B7RH","type":"assistant","uuid":"20629f64-670a-4a57-90c3-6796a6aae462","timestamp":"2025-12-30T15:54:44.454Z"}
{"parentUuid":"20629f64-670a-4a57-90c3-6796a6aae462","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GjWJ8DvCjat4MY8b8DAWfc","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HxcvMHtF3pm5cLLuXLXSfr","name":"Grep","input":{"pattern":"type === \"FILE\"|type === \"TEXT\"|renderField","path":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","output_mode":"content","-n":true,"-C":2,"head_limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2712,"cache_read_input_tokens":118339,"cache_creation":{"ephemeral_5m_input_tokens":2712,"ephemeral_1h_input_tokens":0},"output_tokens":208,"service_tier":"standard"}},"requestId":"req_011CWd9EdK7tQxo51S43B7RH","type":"assistant","uuid":"78e335da-50c7-47bf-a1e8-f505accc3178","timestamp":"2025-12-30T15:54:47.059Z"}
{"parentUuid":"78e335da-50c7-47bf-a1e8-f505accc3178","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HxcvMHtF3pm5cLLuXLXSfr","type":"tool_result","content":"371-  };\r\n372-\r\n373:  const renderField = (field) => {\r\n374-    const value = formData[field.fieldName] || \"\";\r\n375-\r\n--\n436-\r\n437-    // VRM field with smart lookup (autocomplete from database + DVLA fallback)\r\n438:    if (isVrmField(field) && field.type === \"TEXT\") {\r\n439-      return (\r\n440-        <div className=\"relative\">\r\n--\n1077-                            </span>\r\n1078-                          </label>\r\n1079:                          {renderField(gField)}\r\n1080-                        </div>\r\n1081-                      ))}\r\n--\n1093-                      </span>\r\n1094-                    </label>\r\n1095:                    {renderField(field)}\r\n1096-                  </div>\r\n1097-                );\n\n[Showing results with pagination = limit: 50, offset: 0]"}]},"uuid":"4ed910b3-6577-49d8-aa9b-d24db7e9c882","timestamp":"2025-12-30T15:54:48.649Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"371-  };\r\n372-\r\n373:  const renderField = (field) => {\r\n374-    const value = formData[field.fieldName] || \"\";\r\n375-\r\n--\n436-\r\n437-    // VRM field with smart lookup (autocomplete from database + DVLA fallback)\r\n438:    if (isVrmField(field) && field.type === \"TEXT\") {\r\n439-      return (\r\n440-        <div className=\"relative\">\r\n--\n1077-                            </span>\r\n1078-                          </label>\r\n1079:                          {renderField(gField)}\r\n1080-                        </div>\r\n1081-                      ))}\r\n--\n1093-                      </span>\r\n1094-                    </label>\r\n1095:                    {renderField(field)}\r\n1096-                  </div>\r\n1097-                );","numLines":23,"appliedLimit":50}}
{"parentUuid":"4ed910b3-6577-49d8-aa9b-d24db7e9c882","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MbUs8GVpQMVRYjaLCYkwsF","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me read more of the renderField function to understand how different field types are handled:","signature":"EokCCkYICxgCKkDqHDGVkrIf2u68hDP8dK5AtM2GMCZqcfuiwU5AKgjKZ5Qp0NmJf5/zJ8Ei0s9uk6d45ruxCd3D3ogAGwjI86AZEgxw+e263DJ+waI6qJwaDIjVNVTV81PmhhC/jyIwppVp3KmgoXujhPfMzKlHqh9+CtV5s9u7rI+iW4e1BT/tzVEaQHMOTHYGD0ypgpMJKnGOisCeD5QSjy+Sa9BPcJMRcZ+/owDxWOSYPTOMgWhoFzHcbgzI4RrG//SPNGAXyLjITUMlzjxEcj5G5xVAYAfLAoH49P1bEzaFTF8BlWK2vhqWHcwTTjRT8EE1sv3Qo8L2P9K2KIJ1YKt9labIGtDmVxgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":448,"cache_read_input_tokens":121051,"cache_creation":{"ephemeral_5m_input_tokens":448,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9FQopUZgCn28sd1RLm","type":"assistant","uuid":"52e415a3-16f1-43d0-983a-90fd72944ae2","timestamp":"2025-12-30T15:54:53.517Z"}
{"parentUuid":"52e415a3-16f1-43d0-983a-90fd72944ae2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MbUs8GVpQMVRYjaLCYkwsF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EtRMNbYyQrxvK4jNM44vre","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","offset":370,"limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":448,"cache_read_input_tokens":121051,"cache_creation":{"ephemeral_5m_input_tokens":448,"ephemeral_1h_input_tokens":0},"output_tokens":132,"service_tier":"standard"}},"requestId":"req_011CWd9FQopUZgCn28sd1RLm","type":"assistant","uuid":"98b3b7e7-b1a0-4476-ace1-93879887cfb5","timestamp":"2025-12-30T15:54:54.509Z"}
{"parentUuid":"98b3b7e7-b1a0-4476-ace1-93879887cfb5","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EtRMNbYyQrxvK4jNM44vre","type":"tool_result","content":"   370→            field.label.toLowerCase().includes(\"vehicle of interest\"));\n   371→  };\n   372→\n   373→  const renderField = (field) => {\n   374→    const value = formData[field.fieldName] || \"\";\n   375→\n   376→    // Special handling for courtesy vehicle selection\n   377→    if (isCourtesyVehicleField(field)) {\n   378→      return (\n   379→        <div className=\"space-y-2\">\n   380→          <select\n   381→            className=\"select select-bordered w-full\"\n   382→            value={formData.courtesy_vehicle_id || \"\"}\n   383→            onChange={(e) => handleCourtesyVehicleSelect(e.target.value)}\n   384→            required={field.required}\n   385→          >\n   386→            <option value=\"\">Select courtesy vehicle...</option>\n   387→            {courtesyVehicles.map((v) => (\n   388→              <option key={v.id} value={v.id}>\n   389→                {v.regCurrent} - {v.make} {v.model} {v.colour ? `(${v.colour})` : \"\"}\n   390→              </option>\n   391→            ))}\n   392→          </select>\n   393→          {formData.courtesy_vehicle_display && (\n   394→            <div className=\"text-sm text-success\">Selected: {formData.courtesy_vehicle_display}</div>\n   395→          )}\n   396→        </div>\n   397→      );\n   398→    }\n   399→\n   400→    // Special handling for stock vehicle selection (test drive)\n   401→    if (isStockVehicleField(field)) {\n   402→      return (\n   403→        <div className=\"space-y-2\">\n   404→          <input\n   405→            type=\"text\"\n   406→            className=\"input input-bordered w-full\"\n   407→            placeholder=\"Search by VRM or Make/Model...\"\n   408→            value={stockSearch}\n   409→            onChange={(e) => {\n   410→              setStockSearch(e.target.value);\n   411→              fetchStockVehicles(e.target.value);\n   412→            }}\n   413→          />\n   414→          {stockVehicles.length > 0 && stockSearch && (\n   415→            <div className=\"dropdown dropdown-open w-full\">\n   416→              <ul className=\"dropdown-content menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto\">\n   417→                {stockVehicles.slice(0, 10).map((v) => (\n   418→                  <li key={v.id}>\n   419→                    <button type=\"button\" onClick={() => {\n   420→                      handleStockVehicleSelect(v.id);\n   421→                      setStockSearch(\"\");\n   422→                    }}>\n   423→                      {v.displayName}\n   424→                    </button>\n   425→                  </li>\n   426→                ))}\n   427→              </ul>\n   428→            </div>\n   429→          )}\n   430→          {formData.vehicle_interest && (\n   431→            <div className=\"text-sm text-success\">Selected: {formData.vehicle_interest}</div>\n   432→          )}\n   433→        </div>\n   434→      );\n   435→    }\n   436→\n   437→    // VRM field with smart lookup (autocomplete from database + DVLA fallback)\n   438→    if (isVrmField(field) && field.type === \"TEXT\") {\n   439→      return (\n   440→        <div className=\"relative\">\n   441→          <div className=\"flex gap-2\">\n   442→            <input\n   443→              type=\"text\"\n   444→              className=\"input input-bordered flex-1 uppercase font-mono\"\n   445→              value={value}\n   446→              onChange={(e) => {\n   447→                const newValue = e.target.value.toUpperCase();\n   448→                handleInputChange(field.fieldName, newValue);\n   449→                // Trigger smart search if VRM lookup is configured\n   450→                if (vrmLookupConfig?.enabled !== false) {\n   451→                  searchVehicles(newValue);\n   452→                  setVrmSearchActive(true);\n   453→                }\n   454→              }}\n   455→              onFocus={() => {\n   456→                if (vrmLookupConfig?.enabled !== false && value && value.length >= 2) {\n   457→                  searchVehicles(value);\n   458→                  setVrmSearchActive(true);\n   459→                }\n   460→              }}\n   461→              onBlur={() => {\n   462→                // Delay hiding to allow click on suggestion\n   463→                setTimeout(() => setVrmSearchActive(false), 200);\n   464→              }}\n   465→              required={field.required}\n   466→              placeholder={vrmLookupConfig ? \"Search or enter VRM...\" : \"AB12 CDE\"}\n   467→            />\n   468→            <button\n   469→              type=\"button\"\n   470→              className=\"btn btn-secondary\"\n   471→              onClick={() => handleVrmLookup(field.fieldName)}\n   472→              disabled={isLookingUp}\n   473→              title=\"DVLA Lookup\"\n   474→            >\n   475→              {isLookingUp ? <span className=\"loading loading-spinner loading-sm\"></span> : \"DVLA\"}\n   476→            </button>\n   477→          </div>\n   478→          {/* Smart VRM suggestions dropdown */}\n   479→          {vrmSearchActive && vrmSuggestions.length > 0 && (\n   480→            <div className=\"absolute z-50 w-full mt-1 bg-base-100 border border-base-300 rounded-lg shadow-lg max-h-60 overflow-y-auto\">\n   481→              <div className=\"text-xs text-base-content/60 px-3 py-1 border-b border-base-200 bg-base-200/50\">\n   482→                Select from your vehicles or press DVLA for external lookup\n   483→              </div>\n   484→              {vrmSuggestions.map((vehicle) => (\n   485→                <button\n   486→                  key={vehicle.id}\n   487→                  type=\"button\"\n   488→                  className=\"w-full px-3 py-2 text-left hover:bg-primary/10 border-b border-base-200 last:border-0\"\n   489→                  onClick={() => handleVehicleSelect(vehicle)}\n   490→                >\n   491→                  <div className=\"font-mono font-bold\">{vehicle.vrm}</div>\n   492→                  <div className=\"text-sm text-base-content/70\">\n   493→                    {vehicle.make} {vehicle.model} {vehicle.year ? `(${vehicle.year})` : \"\"} - {vehicle.colour || \"\"}\n   494→                  </div>\n   495→                  <div className=\"text-xs text-base-content/50\">\n   496→                    Status: {vehicle.status} {vehicle.mileage ? `| ${vehicle.mileage.toLocaleString()} miles` : \"\"}\n   497→                  </div>\n   498→                </button>\n   499→              ))}\n   500→            </div>\n   501→          )}\n   502→          {/* Show selected vehicle info */}\n   503→          {formData._selectedVehicle && (\n   504→            <div className=\"mt-2 text-sm text-success flex items-center gap-2\">\n   505→              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n   506→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n   507→              </svg>\n   508→              Selected: {formData._selectedVehicle.displayName}\n   509→            </div>\n   510→          )}\n   511→        </div>\n   512→      );\n   513→    }\n   514→\n   515→    // Standard field rendering\n   516→    const options = field.options?.values || field.options?.choices || [];\n   517→    const placeholder = field.placeholder || \"\";\n   518→    const helpText = field.helpText || \"\";\n   519→\n   520→    switch (field.type) {\n   521→      case \"SECTION_HEADER\":\n   522→        return null; // Section headers are rendered differently\n   523→\n   524→      case \"PARAGRAPH\":\n   525→        return (\n   526→          <p className=\"text-base-content/70 whitespace-pre-wrap\">{field.label}</p>\n   527→        );\n   528→\n   529→      case \"TEXT\":\n   530→        return (\n   531→          <div>\n   532→            <input\n   533→              type=\"text\"\n   534→              className=\"input input-bordered w-full\"\n   535→              value={value}\n   536→              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n   537→              required={field.required}\n   538→              placeholder={placeholder}\n   539→            />\n   540→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   541→          </div>\n   542→        );\n   543→\n   544→      case \"TEXTAREA\":\n   545→        return (\n   546→          <div>\n   547→            <textarea\n   548→              className=\"textarea textarea-bordered w-full\"\n   549→              rows={4}\n   550→              value={value}\n   551→              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n   552→              required={field.required}\n   553→              placeholder={placeholder}\n   554→            />\n   555→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   556→          </div>\n   557→        );\n   558→\n   559→      case \"NUMBER\":\n   560→        return (\n   561→          <div>\n   562→            <input\n   563→              type=\"number\"\n   564→              className=\"input input-bordered w-full\"\n   565→              value={value}\n   566→              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n   567→              required={field.required}\n   568→              placeholder={placeholder}\n   569→            />\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"cbfe7e4e-cc76-402f-b55f-0073a57c89e7","timestamp":"2025-12-30T15:54:55.921Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","content":"            field.label.toLowerCase().includes(\"vehicle of interest\"));\n  };\n\n  const renderField = (field) => {\n    const value = formData[field.fieldName] || \"\";\n\n    // Special handling for courtesy vehicle selection\n    if (isCourtesyVehicleField(field)) {\n      return (\n        <div className=\"space-y-2\">\n          <select\n            className=\"select select-bordered w-full\"\n            value={formData.courtesy_vehicle_id || \"\"}\n            onChange={(e) => handleCourtesyVehicleSelect(e.target.value)}\n            required={field.required}\n          >\n            <option value=\"\">Select courtesy vehicle...</option>\n            {courtesyVehicles.map((v) => (\n              <option key={v.id} value={v.id}>\n                {v.regCurrent} - {v.make} {v.model} {v.colour ? `(${v.colour})` : \"\"}\n              </option>\n            ))}\n          </select>\n          {formData.courtesy_vehicle_display && (\n            <div className=\"text-sm text-success\">Selected: {formData.courtesy_vehicle_display}</div>\n          )}\n        </div>\n      );\n    }\n\n    // Special handling for stock vehicle selection (test drive)\n    if (isStockVehicleField(field)) {\n      return (\n        <div className=\"space-y-2\">\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            placeholder=\"Search by VRM or Make/Model...\"\n            value={stockSearch}\n            onChange={(e) => {\n              setStockSearch(e.target.value);\n              fetchStockVehicles(e.target.value);\n            }}\n          />\n          {stockVehicles.length > 0 && stockSearch && (\n            <div className=\"dropdown dropdown-open w-full\">\n              <ul className=\"dropdown-content menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto\">\n                {stockVehicles.slice(0, 10).map((v) => (\n                  <li key={v.id}>\n                    <button type=\"button\" onClick={() => {\n                      handleStockVehicleSelect(v.id);\n                      setStockSearch(\"\");\n                    }}>\n                      {v.displayName}\n                    </button>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n          {formData.vehicle_interest && (\n            <div className=\"text-sm text-success\">Selected: {formData.vehicle_interest}</div>\n          )}\n        </div>\n      );\n    }\n\n    // VRM field with smart lookup (autocomplete from database + DVLA fallback)\n    if (isVrmField(field) && field.type === \"TEXT\") {\n      return (\n        <div className=\"relative\">\n          <div className=\"flex gap-2\">\n            <input\n              type=\"text\"\n              className=\"input input-bordered flex-1 uppercase font-mono\"\n              value={value}\n              onChange={(e) => {\n                const newValue = e.target.value.toUpperCase();\n                handleInputChange(field.fieldName, newValue);\n                // Trigger smart search if VRM lookup is configured\n                if (vrmLookupConfig?.enabled !== false) {\n                  searchVehicles(newValue);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onFocus={() => {\n                if (vrmLookupConfig?.enabled !== false && value && value.length >= 2) {\n                  searchVehicles(value);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onBlur={() => {\n                // Delay hiding to allow click on suggestion\n                setTimeout(() => setVrmSearchActive(false), 200);\n              }}\n              required={field.required}\n              placeholder={vrmLookupConfig ? \"Search or enter VRM...\" : \"AB12 CDE\"}\n            />\n            <button\n              type=\"button\"\n              className=\"btn btn-secondary\"\n              onClick={() => handleVrmLookup(field.fieldName)}\n              disabled={isLookingUp}\n              title=\"DVLA Lookup\"\n            >\n              {isLookingUp ? <span className=\"loading loading-spinner loading-sm\"></span> : \"DVLA\"}\n            </button>\n          </div>\n          {/* Smart VRM suggestions dropdown */}\n          {vrmSearchActive && vrmSuggestions.length > 0 && (\n            <div className=\"absolute z-50 w-full mt-1 bg-base-100 border border-base-300 rounded-lg shadow-lg max-h-60 overflow-y-auto\">\n              <div className=\"text-xs text-base-content/60 px-3 py-1 border-b border-base-200 bg-base-200/50\">\n                Select from your vehicles or press DVLA for external lookup\n              </div>\n              {vrmSuggestions.map((vehicle) => (\n                <button\n                  key={vehicle.id}\n                  type=\"button\"\n                  className=\"w-full px-3 py-2 text-left hover:bg-primary/10 border-b border-base-200 last:border-0\"\n                  onClick={() => handleVehicleSelect(vehicle)}\n                >\n                  <div className=\"font-mono font-bold\">{vehicle.vrm}</div>\n                  <div className=\"text-sm text-base-content/70\">\n                    {vehicle.make} {vehicle.model} {vehicle.year ? `(${vehicle.year})` : \"\"} - {vehicle.colour || \"\"}\n                  </div>\n                  <div className=\"text-xs text-base-content/50\">\n                    Status: {vehicle.status} {vehicle.mileage ? `| ${vehicle.mileage.toLocaleString()} miles` : \"\"}\n                  </div>\n                </button>\n              ))}\n            </div>\n          )}\n          {/* Show selected vehicle info */}\n          {formData._selectedVehicle && (\n            <div className=\"mt-2 text-sm text-success flex items-center gap-2\">\n              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n              </svg>\n              Selected: {formData._selectedVehicle.displayName}\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    // Standard field rendering\n    const options = field.options?.values || field.options?.choices || [];\n    const placeholder = field.placeholder || \"\";\n    const helpText = field.helpText || \"\";\n\n    switch (field.type) {\n      case \"SECTION_HEADER\":\n        return null; // Section headers are rendered differently\n\n      case \"PARAGRAPH\":\n        return (\n          <p className=\"text-base-content/70 whitespace-pre-wrap\">{field.label}</p>\n        );\n\n      case \"TEXT\":\n        return (\n          <div>\n            <input\n              type=\"text\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"TEXTAREA\":\n        return (\n          <div>\n            <textarea\n              className=\"textarea textarea-bordered w-full\"\n              rows={4}\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"NUMBER\":\n        return (\n          <div>\n            <input\n              type=\"number\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />","numLines":200,"startLine":370,"totalLines":1132}}}
{"parentUuid":"cbfe7e4e-cc76-402f-b55f-0073a57c89e7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RLunZk8FKrwS5u7AxoESVz","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to add the LICENCE_SCAN case to the switch statement. Let me find where the switch ends and also look for the FILE type handling:","signature":"ErECCkYICxgCKkD+lodOJeyfKLwVODvPPjeUC6221cQUW7vGntOz1Z3rX8Ho99R793Ic0qe/3qqftfYNWuyFoUKfBWNj9ZCo4+QlEgwwm6mbjAn0O/LuZA8aDOERuZ/qz+ElcsxPtCIw39qbVi004IbPO4Zs+1IgJroi8zbVPJ69x02vPF24+II6hSXJ8s9/pGXF2AXYCV9nKpgBttH+gppecZCdnFXGWyB4cOUTXuKCpwXfAVRnYh9H/F2i3IXSTtrvbRjcXfYNrn7FqFW21ah3FC3VZD7dMouueShWIMfETn5I+Q2crak1dBr6nu3eoKsdCay9EoUGJ2OqhbB6rP6pEQxrZLHbaegDVt9NnBicoPnbL9ubXRaW28DvmGfj7ifVYrHhl6t3VPul/y8Y6Kuw404YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2926,"cache_read_input_tokens":121499,"cache_creation":{"ephemeral_5m_input_tokens":2926,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9FxGRYjpHP1Jc6e8WS","type":"assistant","uuid":"645b0035-7432-492b-ae81-3a934cee2fa0","timestamp":"2025-12-30T15:55:02.967Z"}
{"parentUuid":"645b0035-7432-492b-ae81-3a934cee2fa0","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RLunZk8FKrwS5u7AxoESVz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019mv9XHbSrhNKyrQByZWTNG","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","offset":565,"limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2926,"cache_read_input_tokens":121499,"cache_creation":{"ephemeral_5m_input_tokens":2926,"ephemeral_1h_input_tokens":0},"output_tokens":146,"service_tier":"standard"}},"requestId":"req_011CWd9FxGRYjpHP1Jc6e8WS","type":"assistant","uuid":"5db36b3c-1c1a-47fc-9cd1-a322004a8370","timestamp":"2025-12-30T15:55:04.594Z"}
{"parentUuid":"5db36b3c-1c1a-47fc-9cd1-a322004a8370","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019mv9XHbSrhNKyrQByZWTNG","type":"tool_result","content":"   565→              value={value}\n   566→              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n   567→              required={field.required}\n   568→              placeholder={placeholder}\n   569→            />\n   570→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   571→          </div>\n   572→        );\n   573→\n   574→      case \"DATE\":\n   575→        return (\n   576→          <div>\n   577→            <input\n   578→              type=\"date\"\n   579→              className=\"input input-bordered w-full\"\n   580→              value={value}\n   581→              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n   582→              required={field.required}\n   583→            />\n   584→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   585→          </div>\n   586→        );\n   587→\n   588→      case \"TIME\":\n   589→        return (\n   590→          <div>\n   591→            <input\n   592→              type=\"time\"\n   593→              className=\"input input-bordered w-full\"\n   594→              value={value}\n   595→              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n   596→              required={field.required}\n   597→            />\n   598→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   599→          </div>\n   600→        );\n   601→\n   602→      case \"DATETIME\":\n   603→        return (\n   604→          <div>\n   605→            <input\n   606→              type=\"datetime-local\"\n   607→              className=\"input input-bordered w-full\"\n   608→              value={value}\n   609→              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n   610→              required={field.required}\n   611→            />\n   612→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   613→          </div>\n   614→        );\n   615→\n   616→      case \"DROPDOWN\":\n   617→        return (\n   618→          <div>\n   619→            <select\n   620→              className=\"select select-bordered w-full\"\n   621→              value={value}\n   622→              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n   623→              required={field.required}\n   624→            >\n   625→              <option value=\"\">Select...</option>\n   626→              {options.map((opt) => (\n   627→                <option key={opt} value={opt}>{opt}</option>\n   628→              ))}\n   629→            </select>\n   630→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   631→          </div>\n   632→        );\n   633→\n   634→      case \"RADIO\":\n   635→        return (\n   636→          <div>\n   637→            <div className=\"flex flex-wrap gap-4\">\n   638→              {options.map((opt) => (\n   639→                <label key={opt} className=\"label cursor-pointer gap-2\">\n   640→                  <input\n   641→                    type=\"radio\"\n   642→                    name={field.fieldName}\n   643→                    className=\"radio radio-primary\"\n   644→                    checked={value === opt}\n   645→                    onChange={() => handleInputChange(field.fieldName, opt)}\n   646→                    required={field.required && !value}\n   647→                  />\n   648→                  <span className=\"label-text\">{opt}</span>\n   649→                </label>\n   650→              ))}\n   651→            </div>\n   652→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   653→          </div>\n   654→        );\n   655→\n   656→      case \"BOOLEAN\":\n   657→        return (\n   658→          <div className=\"form-control\">\n   659→            <label className=\"label cursor-pointer justify-start gap-4\">\n   660→              <input\n   661→                type=\"checkbox\"\n   662→                className=\"checkbox checkbox-primary\"\n   663→                checked={value === true}\n   664→                onChange={(e) => handleInputChange(field.fieldName, e.target.checked)}\n   665→              />\n   666→              <span className=\"label-text\">Yes</span>\n   667→            </label>\n   668→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   669→          </div>\n   670→        );\n   671→\n   672→      case \"FILE\":\n   673→        return (\n   674→          <div>\n   675→            <input\n   676→              type=\"file\"\n   677→              className=\"file-input file-input-bordered w-full\"\n   678→              multiple\n   679→              accept=\"image/*,.pdf\"\n   680→              onChange={(e) => {\n   681→                const files = Array.from(e.target.files);\n   682→                handleInputChange(field.fieldName, files);\n   683→              }}\n   684→            />\n   685→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   686→            {!helpText && <p className=\"text-sm text-base-content/60 mt-1\">Accepts images and PDFs</p>}\n   687→            {value && value.length > 0 && (\n   688→              <div className=\"mt-2 flex flex-wrap gap-2\">\n   689→                {value.map((file, idx) => (\n   690→                  <span key={idx} className=\"badge badge-ghost\">{file.name}</span>\n   691→                ))}\n   692→              </div>\n   693→            )}\n   694→          </div>\n   695→        );\n   696→\n   697→      case \"RATING\":\n   698→        return (\n   699→          <div>\n   700→            <div className=\"rating rating-lg\">\n   701→              {[1, 2, 3, 4, 5].map((star) => (\n   702→                <input\n   703→                  key={star}\n   704→                  type=\"radio\"\n   705→                  name={`rating-${field.fieldName}`}\n   706→                  className=\"mask mask-star-2 bg-orange-400\"\n   707→                  checked={value === star}\n   708→                  onChange={() => handleInputChange(field.fieldName, star)}\n   709→                />\n   710→              ))}\n   711→            </div>\n   712→            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n   713→          </div>\n   714→        );\n   715→\n   716→      case \"SIGNATURE\":\n   717→        return (\n   718→          <DrawableSignature\n   719→            value={value || \"\"}\n   720→            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n   721→            required={field.required}\n   722→            label=\"\"\n   723→            helpText=\"Please sign in the box above\"\n   724→          />\n   725→        );\n   726→\n   727→      case \"PDI_ISSUES\":\n   728→        // PDI Issues - repeatable issue entry matching stock board Add Issue modal\n   729→        const issues = formData.pdi_issues || [];\n   730→        const addIssue = () => {\n   731→          setFormData(prev => ({\n   732→            ...prev,\n   733→            pdi_issues: [...(prev.pdi_issues || []), {\n   734→              category: \"\",\n   735→              subcategory: \"\",\n   736→              description: \"\",\n   737→              actionNeeded: \"\",\n   738→              status: \"outstanding\",\n   739→              notes: \"\",\n   740→            }]\n   741→          }));\n   742→        };\n   743→        const updateIssue = (index, key, val) => {\n   744→          setFormData(prev => {\n   745→            const newIssues = [...(prev.pdi_issues || [])];\n   746→            newIssues[index] = { ...newIssues[index], [key]: val };\n   747→            return { ...prev, pdi_issues: newIssues };\n   748→          });\n   749→        };\n   750→        const removeIssue = (index) => {\n   751→          setFormData(prev => ({\n   752→            ...prev,\n   753→            pdi_issues: prev.pdi_issues.filter((_, i) => i !== index)\n   754→          }));\n   755→        };\n   756→        // Same categories as stock board Add Issue modal\n   757→        const ISSUE_SUBCATEGORIES = {\n   758→          mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n   759→          electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n   760→          bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n   761→          interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n   762→          tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n   763→          mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n   764→          service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"0eac1855-afa0-4814-8b79-d9d2ba7f25ce","timestamp":"2025-12-30T15:55:06.141Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","content":"              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"DATE\":\n        return (\n          <div>\n            <input\n              type=\"date\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"TIME\":\n        return (\n          <div>\n            <input\n              type=\"time\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"DATETIME\":\n        return (\n          <div>\n            <input\n              type=\"datetime-local\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"DROPDOWN\":\n        return (\n          <div>\n            <select\n              className=\"select select-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            >\n              <option value=\"\">Select...</option>\n              {options.map((opt) => (\n                <option key={opt} value={opt}>{opt}</option>\n              ))}\n            </select>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"RADIO\":\n        return (\n          <div>\n            <div className=\"flex flex-wrap gap-4\">\n              {options.map((opt) => (\n                <label key={opt} className=\"label cursor-pointer gap-2\">\n                  <input\n                    type=\"radio\"\n                    name={field.fieldName}\n                    className=\"radio radio-primary\"\n                    checked={value === opt}\n                    onChange={() => handleInputChange(field.fieldName, opt)}\n                    required={field.required && !value}\n                  />\n                  <span className=\"label-text\">{opt}</span>\n                </label>\n              ))}\n            </div>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"BOOLEAN\":\n        return (\n          <div className=\"form-control\">\n            <label className=\"label cursor-pointer justify-start gap-4\">\n              <input\n                type=\"checkbox\"\n                className=\"checkbox checkbox-primary\"\n                checked={value === true}\n                onChange={(e) => handleInputChange(field.fieldName, e.target.checked)}\n              />\n              <span className=\"label-text\">Yes</span>\n            </label>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"FILE\":\n        return (\n          <div>\n            <input\n              type=\"file\"\n              className=\"file-input file-input-bordered w-full\"\n              multiple\n              accept=\"image/*,.pdf\"\n              onChange={(e) => {\n                const files = Array.from(e.target.files);\n                handleInputChange(field.fieldName, files);\n              }}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n            {!helpText && <p className=\"text-sm text-base-content/60 mt-1\">Accepts images and PDFs</p>}\n            {value && value.length > 0 && (\n              <div className=\"mt-2 flex flex-wrap gap-2\">\n                {value.map((file, idx) => (\n                  <span key={idx} className=\"badge badge-ghost\">{file.name}</span>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n\n      case \"RATING\":\n        return (\n          <div>\n            <div className=\"rating rating-lg\">\n              {[1, 2, 3, 4, 5].map((star) => (\n                <input\n                  key={star}\n                  type=\"radio\"\n                  name={`rating-${field.fieldName}`}\n                  className=\"mask mask-star-2 bg-orange-400\"\n                  checked={value === star}\n                  onChange={() => handleInputChange(field.fieldName, star)}\n                />\n              ))}\n            </div>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      case \"PDI_ISSUES\":\n        // PDI Issues - repeatable issue entry matching stock board Add Issue modal\n        const issues = formData.pdi_issues || [];\n        const addIssue = () => {\n          setFormData(prev => ({\n            ...prev,\n            pdi_issues: [...(prev.pdi_issues || []), {\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              status: \"outstanding\",\n              notes: \"\",\n            }]\n          }));\n        };\n        const updateIssue = (index, key, val) => {\n          setFormData(prev => {\n            const newIssues = [...(prev.pdi_issues || [])];\n            newIssues[index] = { ...newIssues[index], [key]: val };\n            return { ...prev, pdi_issues: newIssues };\n          });\n        };\n        const removeIssue = (index) => {\n          setFormData(prev => ({\n            ...prev,\n            pdi_issues: prev.pdi_issues.filter((_, i) => i !== index)\n          }));\n        };\n        // Same categories as stock board Add Issue modal\n        const ISSUE_SUBCATEGORIES = {\n          mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n          electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n          bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n          interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n          tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n          mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n          service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],","numLines":200,"startLine":565,"totalLines":1132}}}
{"parentUuid":"0eac1855-afa0-4814-8b79-d9d2ba7f25ce","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EvR4HwCAthkswJK5KmXx2K","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to find where the switch statement ends and also understand where the default case is. I also need to add state for the licence extraction. Let me find the default case first:","signature":"Et8CCkYICxgCKkD0nYyfYDAAZcmWjiSoSTs/+EsdDCcJwrj4Fev1a03OsNe7gQ5Ctx2rNlb/Ta5TezowOpRrT+b8C804VYXkxtiFEgygwU/IVgSwXIEiSWMaDM5Ch5Q+1z64dNJQByIwLqlkA3ZvG4kCfhhA1AAIaGGUxU3uY79Gu0b7ZH2imWek8dfqBg2q6oNBTx50T+EZKsYBoGyg4fP+d5TuSXof5JYXgSJOv8XeZ1MpRQSFebbHv37tdq5s2nH0EfJEZXJ6U5IItGhACCwodBLAeHSdQzaFevSt9n45f+meru4fXUpDQqpw91Rg/rIMNQoheU7K9dzLxdL3OEfJHZOxjD+G6L3zku+zmxUeZjQ2BCP6jQY+E9Q4Xtj4H+G85JiwJZ4jcQFInBR+bsNpK5pahbaurxjHNT/d+gFeEN3AWFAZeNuohhBV/TOTzg8Xo3NYBVpn6vplX/onRxcmGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2983,"cache_read_input_tokens":124425,"cache_creation":{"ephemeral_5m_input_tokens":2983,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9GjXEnd5zPMP77oBZG","type":"assistant","uuid":"14913b7f-deeb-43f6-8758-940bb3066e1d","timestamp":"2025-12-30T15:55:12.537Z"}
{"parentUuid":"14913b7f-deeb-43f6-8758-940bb3066e1d","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01EvR4HwCAthkswJK5KmXx2K","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PAdhLxzHnRL6HoMUBAJPhq","name":"Grep","input":{"pattern":"default:|case \"FILE\":","path":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":2983,"cache_read_input_tokens":124425,"cache_creation":{"ephemeral_5m_input_tokens":2983,"ephemeral_1h_input_tokens":0},"output_tokens":175,"service_tier":"standard"}},"requestId":"req_011CWd9GjXEnd5zPMP77oBZG","type":"assistant","uuid":"e65c6a16-8ad4-40f4-988e-5c76a1a2fc88","timestamp":"2025-12-30T15:55:14.616Z"}
{"parentUuid":"e65c6a16-8ad4-40f4-988e-5c76a1a2fc88","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PAdhLxzHnRL6HoMUBAJPhq","type":"tool_result","content":"672:      case \"FILE\":\r\n884:      default:"}]},"uuid":"9c8249a3-1262-4f78-86b8-14d38cb7f8e1","timestamp":"2025-12-30T15:55:15.960Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"672:      case \"FILE\":\r\n884:      default:","numLines":2}}
{"parentUuid":"9c8249a3-1262-4f78-86b8-14d38cb7f8e1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_014ZGyjdXTrac6VqLsG9rRcR","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I'll add the LICENCE_SCAN case before the default. I also need to add state variables for the licence extraction at the beginning of the component. Let me add the case statement first.","signature":"EuUCCkYICxgCKkBcpTHhFXYngv5k2QSlVB07kL/Wd5Em7LusrHHiwgiB9jDoe2TGog8A0guX1fm01nJ0/h8EGKlSKACMswsXzGibEgxZWnbdmhvkMN77NlkaDDQboChIikYS3nCd4yIwT5IriJ1foD6/J650EW6Wj8BbmJD0RICSIDFBzzJKSkEn0zawpMDDEXu+p1qJkzOKKswBf4DH08jn+y8Yg5mcx19rO8WatEe7c+zdneLexUxrN6eyuwKkESris9n0LkXSgLyAnHDSkWANKNIghyZgIKkUtx8AjQAQJwlEh+me1Gy6eKpPEktGOwLpehQWc/QDH3IGNwzbVdhcCpveu+jW144Fj8o1gT3lWF09kw/P9UIuMxKbxTCVIwQrqYB3FnxSqUHORqaGJfyDepdR4S39OB2kTRqpXVhL8VbzyRqEMcMB8tVojiFL/opMTmuSXLp5PUciC1Uco1v1kbShNgxRGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":206,"cache_read_input_tokens":127408,"cache_creation":{"ephemeral_5m_input_tokens":206,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9HRHQPsgTo6EeR35rJ","type":"assistant","uuid":"2fcf2673-18b6-4b90-9fcb-8bab0426fd54","timestamp":"2025-12-30T15:55:21.038Z"}
{"parentUuid":"2fcf2673-18b6-4b90-9fcb-8bab0426fd54","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_014ZGyjdXTrac6VqLsG9rRcR","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JP57n38SR9DLEsfZqUeCjS","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","offset":876,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":206,"cache_read_input_tokens":127408,"cache_creation":{"ephemeral_5m_input_tokens":206,"ephemeral_1h_input_tokens":0},"output_tokens":155,"service_tier":"standard"}},"requestId":"req_011CWd9HRHQPsgTo6EeR35rJ","type":"assistant","uuid":"6a9628cb-a279-416b-bd4a-42b0a21d66d9","timestamp":"2025-12-30T15:55:22.077Z"}
{"parentUuid":"6a9628cb-a279-416b-bd4a-42b0a21d66d9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JP57n38SR9DLEsfZqUeCjS","type":"tool_result","content":"   876→              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n   877→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n   878→              </svg>\n   879→              Add Issue\n   880→            </button>\n   881→          </div>\n   882→        );\n   883→\n   884→      default:\n   885→        return (\n   886→          <input\n   887→            type=\"text\"\n   888→            className=\"input input-bordered w-full\"\n   889→            value={value}\n   890→            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n   891→            required={field.required}\n   892→            placeholder={placeholder}\n   893→          />\n   894→        );\n   895→    }\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"f1019363-f866-458d-aabd-2dd9d3029696","timestamp":"2025-12-30T15:55:23.433Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","content":"              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n              </svg>\n              Add Issue\n            </button>\n          </div>\n        );\n\n      default:\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n            placeholder={placeholder}\n          />\n        );\n    }","numLines":20,"startLine":876,"totalLines":1132}}}
{"parentUuid":"f1019363-f866-458d-aabd-2dd9d3029696","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MsDfSTgfcNDbofz2QDp6zE","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the LICENCE_SCAN case before the default case. I also need to add state variables for the licence extraction. Let me first add the state variables at the top:","signature":"EtkCCkYICxgCKkBT/iaupBA1BY+8NBmv7Jfp8+MAYE8bBH7o/DC7dn8CXmJnW4+nAtv9IyyLLcvHDx5JhDw1q0D7lTcdtviXhEG4Egyl24ycoaQV4hCqGv0aDPTMCMrjleMU06hpTCIwc61upnOfarMj41A2CB04pYcS5hschPLzR2d0HENTTQtGfs8gbzqaZgZ6/SgS4pk/KsABYL2nb1zFNPBjp1UGsV+1jfCIiZKg0Fqy1+6AsPo7cZWBS6xYVTiX5V5yCZfSvBC5QQWYnDxvbqRGokSR0Fd6FQVUbUPbPyxk51TyqMFpBrma6SMZ3BDrRVKLvsNYBgzhRcbeLB2Yo8ND3PW6YI39Usn6VJfp0Sz+W5FgsO6OG0P3XF2ycZkwdGCApHtbm/8YnVihGBtzzgRJ7CmmowVi0hxFgFYFdIQF3PuYwnHcBQI0BK1LHu6g7ut1W/O2yPXHGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":506,"cache_read_input_tokens":127614,"cache_creation":{"ephemeral_5m_input_tokens":506,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd9Hydq74wqCJBnQs4P5","type":"assistant","uuid":"fcee187a-7e03-480a-96fa-191d8ef75573","timestamp":"2025-12-30T15:55:28.409Z"}
{"parentUuid":"fcee187a-7e03-480a-96fa-191d8ef75573","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MsDfSTgfcNDbofz2QDp6zE","type":"message","role":"assistant","content":[{"type":"text","text":"Now I'll add the LICENCE_SCAN case and the necessary state variables. First, let me add the state variables:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":506,"cache_read_input_tokens":127614,"cache_creation":{"ephemeral_5m_input_tokens":506,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CWd9Hydq74wqCJBnQs4P5","type":"assistant","uuid":"e3315dec-b8b4-4fb1-be9d-a96476a6dfc6","timestamp":"2025-12-30T15:55:29.303Z"}
{"parentUuid":"e3315dec-b8b4-4fb1-be9d-a96476a6dfc6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MsDfSTgfcNDbofz2QDp6zE","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012MQHz4uca4bVVTRmNVdCUh","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","old_string":"  const [stockSearch, setStockSearch] = useState(\"\");\n  // Smart VRM lookup state\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  const [vrmLookupConfig, setVrmLookupConfig] = useState(null);\n  // Dealer info for token replacement\n  const [dealer, setDealer] = useState(null);","new_string":"  const [stockSearch, setStockSearch] = useState(\"\");\n  // Smart VRM lookup state\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  const [vrmLookupConfig, setVrmLookupConfig] = useState(null);\n  // Dealer info for token replacement\n  const [dealer, setDealer] = useState(null);\n  // Licence extraction state\n  const [isExtractingLicence, setIsExtractingLicence] = useState(false);\n  const [licenceExtracted, setLicenceExtracted] = useState(false);\n  const [licenceExtractionError, setLicenceExtractionError] = useState(null);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":506,"cache_read_input_tokens":127614,"cache_creation":{"ephemeral_5m_input_tokens":506,"ephemeral_1h_input_tokens":0},"output_tokens":488,"service_tier":"standard"}},"requestId":"req_011CWd9Hydq74wqCJBnQs4P5","type":"assistant","uuid":"2caae030-cbb6-4fe1-b665-f36b7cacdf3c","timestamp":"2025-12-30T15:55:35.317Z"}
{"type":"file-history-snapshot","messageId":"2caae030-cbb6-4fe1-b665-f36b7cacdf3c","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"},"libs\\openai.js":{"backupFileName":"a8e7fe417f7ecf06@v1","version":1,"backupTime":"2025-12-30T15:50:12.398Z"},"components\\AISuggestionsPanel.js":{"backupFileName":"9b357355b418cc6f@v1","version":1,"backupTime":"2025-12-30T15:50:35.851Z"},"pages\\warranty.js":{"backupFileName":"a81b4f663f49afea@v1","version":1,"backupTime":"2025-12-30T15:51:31.630Z"},"pages\\api\\ai\\warranty-suggestions.js":{"backupFileName":"5b8ac4e37dc9954c@v1","version":1,"backupTime":"2025-12-30T15:52:02.934Z"},"pages\\api\\ai\\appraisal-issue-suggestions.js":{"backupFileName":"264b13f531a23f96@v1","version":1,"backupTime":"2025-12-30T15:52:13.361Z"},"pages\\api\\forms\\test-drive\\extract-licence.js":{"backupFileName":null,"version":1,"backupTime":"2025-12-30T15:53:38.201Z"},"libs\\formTemplates.js":{"backupFileName":"81e216fa5809acd6@v1","version":1,"backupTime":"2025-12-30T15:54:28.383Z"},"pages\\forms\\fill\\[id].js":{"backupFileName":"ddbb29a45524535a@v1","version":1,"backupTime":"2025-12-30T15:55:36.562Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"2caae030-cbb6-4fe1-b665-f36b7cacdf3c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012MQHz4uca4bVVTRmNVdCUh","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    38→  const [isLookingUp, setIsLookingUp] = useState(false);\n    39→  const [submittedId, setSubmittedId] = useState(null);\n    40→  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n    41→  const [stockVehicles, setStockVehicles] = useState([]);\n    42→  const [stockSearch, setStockSearch] = useState(\"\");\n    43→  // Smart VRM lookup state\n    44→  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n    45→  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n    46→  const [vrmLookupConfig, setVrmLookupConfig] = useState(null);\n    47→  // Dealer info for token replacement\n    48→  const [dealer, setDealer] = useState(null);\n    49→  // Licence extraction state\n    50→  const [isExtractingLicence, setIsExtractingLicence] = useState(false);\n    51→  const [licenceExtracted, setLicenceExtracted] = useState(false);\n    52→  const [licenceExtractionError, setLicenceExtractionError] = useState(null);\n    53→\n    54→  useEffect(() => {\n    55→    if (id) {\n    56→      loadForm();"}]},"uuid":"d2f1fa84-4026-46eb-98ca-bbe527d73a5a","timestamp":"2025-12-30T15:55:36.554Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","oldString":"  const [stockSearch, setStockSearch] = useState(\"\");\n  // Smart VRM lookup state\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  const [vrmLookupConfig, setVrmLookupConfig] = useState(null);\n  // Dealer info for token replacement\n  const [dealer, setDealer] = useState(null);","newString":"  const [stockSearch, setStockSearch] = useState(\"\");\n  // Smart VRM lookup state\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  const [vrmLookupConfig, setVrmLookupConfig] = useState(null);\n  // Dealer info for token replacement\n  const [dealer, setDealer] = useState(null);\n  // Licence extraction state\n  const [isExtractingLicence, setIsExtractingLicence] = useState(false);\n  const [licenceExtracted, setLicenceExtracted] = useState(false);\n  const [licenceExtractionError, setLicenceExtractionError] = useState(null);","originalFile":"import { useState, useEffect, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";\nimport dynamic from \"next/dynamic\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport toast from \"react-hot-toast\";\nimport { FORM_TEMPLATES } from \"@/libs/formTemplates\";\n\n// Dynamic import for signature pad (client-side only)\nconst DrawableSignature = dynamic(() => import(\"@/components/DrawableSignature\"), {\n  ssr: false,\n  loading: () => <div className=\"h-[150px] bg-base-200 rounded-lg animate-pulse\" />\n});\n\n// Human-readable form type labels\nconst FORM_TYPE_LABELS = {\n  PDI: \"PDI\",\n  TEST_DRIVE: \"Test Drive\",\n  WARRANTY_CLAIM: \"Warranty Claim\",\n  COURTESY_OUT: \"Courtesy Car Out\",\n  COURTESY_IN: \"Courtesy Car In\",\n  DELIVERY: \"Delivery\",\n  SERVICE_RECEIPT: \"Service Receipt\",\n  REVIEW_FEEDBACK: \"Review & Feedback\",\n  OTHER: \"Other\",\n};\n\nexport default function FillForm() {\n  const router = useRouter();\n  const { id } = router.query;\n\n  const [form, setForm] = useState(null);\n  const [fields, setFields] = useState([]);\n  const [formData, setFormData] = useState({});\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [submittedId, setSubmittedId] = useState(null);\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [stockVehicles, setStockVehicles] = useState([]);\n  const [stockSearch, setStockSearch] = useState(\"\");\n  // Smart VRM lookup state\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  const [vrmLookupConfig, setVrmLookupConfig] = useState(null);\n  // Dealer info for token replacement\n  const [dealer, setDealer] = useState(null);\n\n  useEffect(() => {\n    if (id) {\n      loadForm();\n      loadDealer();\n    }\n  }, [id]);\n\n  const loadDealer = async () => {\n    try {\n      const res = await fetch(\"/api/dealer\");\n      const data = await res.json();\n      setDealer(data);\n    } catch (error) {\n      console.error(\"Failed to load dealer:\", error);\n    }\n  };\n\n  // Replace tokens in text with dealer info\n  const replaceTokens = (text) => {\n    if (!text || !dealer) return text;\n    return text\n      .replace(/\\{companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\")\n      .replace(/\\{dealer\\.companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{dealer\\.companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{dealer\\.companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{dealer\\.companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\");\n  };\n\n  // Format terms text as bullet list\n  const formatTermsAsList = (text) => {\n    if (!text) return null;\n    const processedText = replaceTokens(text);\n\n    // Split by bullet points, dashes, or numbered items\n    const lines = processedText\n      .split(/(?:^|\\n)(?:•|●|-|\\d+\\.)\\s*/g)\n      .map(line => line.trim())\n      .filter(line => line.length > 0);\n\n    if (lines.length <= 1) {\n      // If no bullet format detected, try splitting by newlines\n      const newlineLines = processedText.split(\"\\n\").filter(line => line.trim());\n      if (newlineLines.length > 1) {\n        return (\n          <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n            {newlineLines.map((line, idx) => (\n              <li key={idx}>{line.trim().replace(/^[-•●]\\s*/, \"\")}</li>\n            ))}\n          </ul>\n        );\n      }\n      return <p className=\"text-sm text-base-content/80 whitespace-pre-wrap\">{processedText}</p>;\n    }\n\n    return (\n      <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n        {lines.map((line, idx) => (\n          <li key={idx}>{line}</li>\n        ))}\n      </ul>\n    );\n  };\n\n  useEffect(() => {\n    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {\n      fetchCourtesyVehicles();\n    }\n    if (form?.type === \"TEST_DRIVE\") {\n      fetchStockVehicles();\n    }\n    // Get VRM lookup config from templates\n    if (form?.type) {\n      const template = FORM_TEMPLATES.find(t => t.type === form.type);\n      if (template?.vrmLookup) {\n        setVrmLookupConfig(template.vrmLookup);\n      }\n    }\n  }, [form?.type]);\n\n  // Initialize default values for time/date fields\n  useEffect(() => {\n    if (!fields.length) return;\n    const now = new Date();\n    const updates = {};\n\n    // Test Drive form: default date and time\n    if (form?.type === \"TEST_DRIVE\") {\n      const timeField = fields.find(f => f.fieldName === \"time\" && f.type === \"TIME\");\n      const dateField = fields.find(f => f.fieldName === \"date\" && f.type === \"DATE\");\n\n      // Set default time to current time (rounded to nearest 15 min)\n      if (timeField && !formData.time) {\n        const minutes = Math.round(now.getMinutes() / 15) * 15;\n        const hours = now.getHours() + (minutes >= 60 ? 1 : 0);\n        const adjustedMinutes = minutes >= 60 ? 0 : minutes;\n        updates.time = `${String(hours).padStart(2, \"0\")}:${String(adjustedMinutes).padStart(2, \"0\")}`;\n      }\n\n      // Set default date to today\n      if (dateField && !formData.date) {\n        updates.date = now.toISOString().split(\"T\")[0];\n      }\n    }\n\n    // Service Receipt form: default service_date to today\n    if (form?.type === \"SERVICE_RECEIPT\") {\n      const serviceDateField = fields.find(f => f.fieldName === \"service_date\" && f.type === \"DATE\");\n      if (serviceDateField && !formData.service_date) {\n        updates.service_date = now.toISOString().split(\"T\")[0];\n      }\n    }\n\n    if (Object.keys(updates).length > 0) {\n      setFormData(prev => ({ ...prev, ...updates }));\n    }\n  }, [form?.type, fields]);\n\n  const loadForm = async () => {\n    try {\n      const res = await fetch(`/api/forms/${id}`);\n      const data = await res.json();\n\n      if (!res.ok || data.error) {\n        toast.error(\"Form not found\");\n        router.push(\"/forms\");\n        return;\n      }\n\n      setForm(data.form);\n      setFields(data.fields || []);\n      setIsLoading(false);\n    } catch (error) {\n      console.error(\"Failed to load form:\", error);\n      toast.error(\"Failed to load form\");\n      router.push(\"/forms\");\n    }\n  };\n\n  const fetchCourtesyVehicles = async () => {\n    try {\n      const res = await fetch(\"/api/vehicles/courtesy\");\n      const data = await res.json();\n      setCourtesyVehicles(data);\n    } catch (error) {\n      console.error(\"Failed to fetch courtesy vehicles:\", error);\n    }\n  };\n\n  const fetchStockVehicles = async (search = \"\") => {\n    try {\n      const res = await fetch(`/api/vehicles/stock?search=${encodeURIComponent(search)}`);\n      const data = await res.json();\n      setStockVehicles(data);\n    } catch (error) {\n      console.error(\"Failed to fetch stock vehicles:\", error);\n    }\n  };\n\n  // Smart VRM search with status filtering\n  const searchVehicles = useCallback(async (query) => {\n    if (!query || query.length < 2 || !vrmLookupConfig) {\n      setVrmSuggestions([]);\n      return;\n    }\n\n    try {\n      const params = new URLSearchParams({ q: query });\n      if (vrmLookupConfig.statuses) {\n        params.append(\"statuses\", vrmLookupConfig.statuses.join(\",\"));\n      }\n      if (vrmLookupConfig.vehicleType) {\n        params.append(\"vehicleType\", vrmLookupConfig.vehicleType);\n      }\n\n      const res = await fetch(`/api/vehicles/search?${params.toString()}`);\n      const data = await res.json();\n      setVrmSuggestions(data);\n    } catch (error) {\n      console.error(\"VRM search error:\", error);\n    }\n  }, [vrmLookupConfig]);\n\n  // Handle vehicle selection from suggestions\n  const handleVehicleSelect = (vehicle) => {\n    setFormData(prev => ({\n      ...prev,\n      vrm: vehicle.vrm,\n      make: vehicle.make,\n      model: vehicle.model,\n      colour: vehicle.colour,\n      mileage: vehicle.mileage,\n      year: vehicle.year,\n      vehicle_make: vehicle.make,\n      vehicle_model: vehicle.model,\n      _selectedVehicle: vehicle,\n    }));\n    setVrmSuggestions([]);\n    setVrmSearchActive(false);\n    toast.success(`Selected: ${vehicle.displayName}`);\n  };\n\n  const handleInputChange = (fieldName, value) => {\n    setFormData((prev) => ({\n      ...prev,\n      [fieldName]: value,\n    }));\n  };\n\n  const handleVrmLookup = async (fieldName) => {\n    const vrm = formData[fieldName];\n    if (!vrm) {\n      toast.error(\"Enter a registration number first\");\n      return;\n    }\n\n    setIsLookingUp(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: vrm }),\n      });\n      const data = await res.json();\n\n      if (res.ok && data.make) {\n        const updates = {};\n        if (data.make) updates.make = data.make;\n        if (data.model) updates.model = data.model;\n        if (data.year) updates.year = data.year;\n        if (data.colour) updates.colour = data.colour;\n        if (data.fuelType) updates.fuel_type = data.fuelType;\n\n        setFormData(prev => ({ ...prev, ...updates }));\n        toast.success(`Found: ${data.year || \"\"} ${data.make} ${data.model} - ${data.colour || \"\"}`);\n      } else {\n        toast.error(\"Vehicle not found or lookup failed\");\n      }\n    } catch (error) {\n      console.error(\"DVLA lookup error:\", error);\n      toast.error(\"Failed to lookup vehicle\");\n    } finally {\n      setIsLookingUp(false);\n    }\n  };\n\n  const handleCourtesyVehicleSelect = (vehicleId) => {\n    const vehicle = courtesyVehicles.find(v => v.id === vehicleId);\n    if (vehicle) {\n      setFormData(prev => ({\n        ...prev,\n        courtesy_vrm: vehicle.regCurrent,\n        courtesy_vehicle_id: vehicle.id,\n        courtesy_vehicle_display: `${vehicle.regCurrent} - ${vehicle.make} ${vehicle.model}`,\n      }));\n    }\n  };\n\n  const handleStockVehicleSelect = (vehicleId) => {\n    const vehicle = stockVehicles.find(v => v.id === vehicleId);\n    if (vehicle) {\n      setFormData(prev => ({\n        ...prev,\n        vrm: vehicle.regCurrent,\n        vehicle_interest: vehicle.displayName,\n        vehicle_id: vehicle.id,\n      }));\n    }\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsSubmitting(true);\n\n    try {\n      const res = await fetch(\"/api/forms/submissions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          formId: form.id || form._id,\n          rawAnswers: formData,\n        }),\n      });\n\n      const data = await res.json();\n\n      if (!res.ok) throw new Error(data.error || \"Submission failed\");\n\n      setSubmittedId(data.id || data._id);\n      toast.success(\"Form submitted successfully!\");\n    } catch (error) {\n      console.error(\"Submission error:\", error);\n      toast.error(\"Failed to submit form. Please try again.\");\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleSubmitAnother = () => {\n    setFormData({});\n    setSubmittedId(null);\n  };\n\n  const isVrmField = (field) => {\n    const vrmFieldNames = [\"vrm\", \"reg\", \"registration\", \"vehicle_reg\", \"regcurrent\", \"courtesy_vrm\"];\n    return vrmFieldNames.includes(field.fieldName.toLowerCase()) ||\n           field.label.toLowerCase().includes(\"registration\") ||\n           field.label.toLowerCase().includes(\"vrm\");\n  };\n\n  const isCourtesyVehicleField = (field) => {\n    return (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") &&\n           (field.fieldName === \"courtesy_vrm\" || field.label.toLowerCase().includes(\"courtesy vehicle\"));\n  };\n\n  const isStockVehicleField = (field) => {\n    return form?.type === \"TEST_DRIVE\" &&\n           (field.fieldName === \"vrm\" || field.fieldName === \"vehicle_interest\" ||\n            field.label.toLowerCase().includes(\"vehicle of interest\"));\n  };\n\n  const renderField = (field) => {\n    const value = formData[field.fieldName] || \"\";\n\n    // Special handling for courtesy vehicle selection\n    if (isCourtesyVehicleField(field)) {\n      return (\n        <div className=\"space-y-2\">\n          <select\n            className=\"select select-bordered w-full\"\n            value={formData.courtesy_vehicle_id || \"\"}\n            onChange={(e) => handleCourtesyVehicleSelect(e.target.value)}\n            required={field.required}\n          >\n            <option value=\"\">Select courtesy vehicle...</option>\n            {courtesyVehicles.map((v) => (\n              <option key={v.id} value={v.id}>\n                {v.regCurrent} - {v.make} {v.model} {v.colour ? `(${v.colour})` : \"\"}\n              </option>\n            ))}\n          </select>\n          {formData.courtesy_vehicle_display && (\n            <div className=\"text-sm text-success\">Selected: {formData.courtesy_vehicle_display}</div>\n          )}\n        </div>\n      );\n    }\n\n    // Special handling for stock vehicle selection (test drive)\n    if (isStockVehicleField(field)) {\n      return (\n        <div className=\"space-y-2\">\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            placeholder=\"Search by VRM or Make/Model...\"\n            value={stockSearch}\n            onChange={(e) => {\n              setStockSearch(e.target.value);\n              fetchStockVehicles(e.target.value);\n            }}\n          />\n          {stockVehicles.length > 0 && stockSearch && (\n            <div className=\"dropdown dropdown-open w-full\">\n              <ul className=\"dropdown-content menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto\">\n                {stockVehicles.slice(0, 10).map((v) => (\n                  <li key={v.id}>\n                    <button type=\"button\" onClick={() => {\n                      handleStockVehicleSelect(v.id);\n                      setStockSearch(\"\");\n                    }}>\n                      {v.displayName}\n                    </button>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n          {formData.vehicle_interest && (\n            <div className=\"text-sm text-success\">Selected: {formData.vehicle_interest}</div>\n          )}\n        </div>\n      );\n    }\n\n    // VRM field with smart lookup (autocomplete from database + DVLA fallback)\n    if (isVrmField(field) && field.type === \"TEXT\") {\n      return (\n        <div className=\"relative\">\n          <div className=\"flex gap-2\">\n            <input\n              type=\"text\"\n              className=\"input input-bordered flex-1 uppercase font-mono\"\n              value={value}\n              onChange={(e) => {\n                const newValue = e.target.value.toUpperCase();\n                handleInputChange(field.fieldName, newValue);\n                // Trigger smart search if VRM lookup is configured\n                if (vrmLookupConfig?.enabled !== false) {\n                  searchVehicles(newValue);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onFocus={() => {\n                if (vrmLookupConfig?.enabled !== false && value && value.length >= 2) {\n                  searchVehicles(value);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onBlur={() => {\n                // Delay hiding to allow click on suggestion\n                setTimeout(() => setVrmSearchActive(false), 200);\n              }}\n              required={field.required}\n              placeholder={vrmLookupConfig ? \"Search or enter VRM...\" : \"AB12 CDE\"}\n            />\n            <button\n              type=\"button\"\n              className=\"btn btn-secondary\"\n              onClick={() => handleVrmLookup(field.fieldName)}\n              disabled={isLookingUp}\n              title=\"DVLA Lookup\"\n            >\n              {isLookingUp ? <span className=\"loading loading-spinner loading-sm\"></span> : \"DVLA\"}\n            </button>\n          </div>\n          {/* Smart VRM suggestions dropdown */}\n          {vrmSearchActive && vrmSuggestions.length > 0 && (\n            <div className=\"absolute z-50 w-full mt-1 bg-base-100 border border-base-300 rounded-lg shadow-lg max-h-60 overflow-y-auto\">\n              <div className=\"text-xs text-base-content/60 px-3 py-1 border-b border-base-200 bg-base-200/50\">\n                Select from your vehicles or press DVLA for external lookup\n              </div>\n              {vrmSuggestions.map((vehicle) => (\n                <button\n                  key={vehicle.id}\n                  type=\"button\"\n                  className=\"w-full px-3 py-2 text-left hover:bg-primary/10 border-b border-base-200 last:border-0\"\n                  onClick={() => handleVehicleSelect(vehicle)}\n                >\n                  <div className=\"font-mono font-bold\">{vehicle.vrm}</div>\n                  <div className=\"text-sm text-base-content/70\">\n                    {vehicle.make} {vehicle.model} {vehicle.year ? `(${vehicle.year})` : \"\"} - {vehicle.colour || \"\"}\n                  </div>\n                  <div className=\"text-xs text-base-content/50\">\n                    Status: {vehicle.status} {vehicle.mileage ? `| ${vehicle.mileage.toLocaleString()} miles` : \"\"}\n                  </div>\n                </button>\n              ))}\n            </div>\n          )}\n          {/* Show selected vehicle info */}\n          {formData._selectedVehicle && (\n            <div className=\"mt-2 text-sm text-success flex items-center gap-2\">\n              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n              </svg>\n              Selected: {formData._selectedVehicle.displayName}\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    // Standard field rendering\n    const options = field.options?.values || field.options?.choices || [];\n    const placeholder = field.placeholder || \"\";\n    const helpText = field.helpText || \"\";\n\n    switch (field.type) {\n      case \"SECTION_HEADER\":\n        return null; // Section headers are rendered differently\n\n      case \"PARAGRAPH\":\n        return (\n          <p className=\"text-base-content/70 whitespace-pre-wrap\">{field.label}</p>\n        );\n\n      case \"TEXT\":\n        return (\n          <div>\n            <input\n              type=\"text\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"TEXTAREA\":\n        return (\n          <div>\n            <textarea\n              className=\"textarea textarea-bordered w-full\"\n              rows={4}\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"NUMBER\":\n        return (\n          <div>\n            <input\n              type=\"number\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"DATE\":\n        return (\n          <div>\n            <input\n              type=\"date\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"TIME\":\n        return (\n          <div>\n            <input\n              type=\"time\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"DATETIME\":\n        return (\n          <div>\n            <input\n              type=\"datetime-local\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"DROPDOWN\":\n        return (\n          <div>\n            <select\n              className=\"select select-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            >\n              <option value=\"\">Select...</option>\n              {options.map((opt) => (\n                <option key={opt} value={opt}>{opt}</option>\n              ))}\n            </select>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"RADIO\":\n        return (\n          <div>\n            <div className=\"flex flex-wrap gap-4\">\n              {options.map((opt) => (\n                <label key={opt} className=\"label cursor-pointer gap-2\">\n                  <input\n                    type=\"radio\"\n                    name={field.fieldName}\n                    className=\"radio radio-primary\"\n                    checked={value === opt}\n                    onChange={() => handleInputChange(field.fieldName, opt)}\n                    required={field.required && !value}\n                  />\n                  <span className=\"label-text\">{opt}</span>\n                </label>\n              ))}\n            </div>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"BOOLEAN\":\n        return (\n          <div className=\"form-control\">\n            <label className=\"label cursor-pointer justify-start gap-4\">\n              <input\n                type=\"checkbox\"\n                className=\"checkbox checkbox-primary\"\n                checked={value === true}\n                onChange={(e) => handleInputChange(field.fieldName, e.target.checked)}\n              />\n              <span className=\"label-text\">Yes</span>\n            </label>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"FILE\":\n        return (\n          <div>\n            <input\n              type=\"file\"\n              className=\"file-input file-input-bordered w-full\"\n              multiple\n              accept=\"image/*,.pdf\"\n              onChange={(e) => {\n                const files = Array.from(e.target.files);\n                handleInputChange(field.fieldName, files);\n              }}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n            {!helpText && <p className=\"text-sm text-base-content/60 mt-1\">Accepts images and PDFs</p>}\n            {value && value.length > 0 && (\n              <div className=\"mt-2 flex flex-wrap gap-2\">\n                {value.map((file, idx) => (\n                  <span key={idx} className=\"badge badge-ghost\">{file.name}</span>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n\n      case \"RATING\":\n        return (\n          <div>\n            <div className=\"rating rating-lg\">\n              {[1, 2, 3, 4, 5].map((star) => (\n                <input\n                  key={star}\n                  type=\"radio\"\n                  name={`rating-${field.fieldName}`}\n                  className=\"mask mask-star-2 bg-orange-400\"\n                  checked={value === star}\n                  onChange={() => handleInputChange(field.fieldName, star)}\n                />\n              ))}\n            </div>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      case \"PDI_ISSUES\":\n        // PDI Issues - repeatable issue entry matching stock board Add Issue modal\n        const issues = formData.pdi_issues || [];\n        const addIssue = () => {\n          setFormData(prev => ({\n            ...prev,\n            pdi_issues: [...(prev.pdi_issues || []), {\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              status: \"outstanding\",\n              notes: \"\",\n            }]\n          }));\n        };\n        const updateIssue = (index, key, val) => {\n          setFormData(prev => {\n            const newIssues = [...(prev.pdi_issues || [])];\n            newIssues[index] = { ...newIssues[index], [key]: val };\n            return { ...prev, pdi_issues: newIssues };\n          });\n        };\n        const removeIssue = (index) => {\n          setFormData(prev => ({\n            ...prev,\n            pdi_issues: prev.pdi_issues.filter((_, i) => i !== index)\n          }));\n        };\n        // Same categories as stock board Add Issue modal\n        const ISSUE_SUBCATEGORIES = {\n          mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n          electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n          bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n          interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n          tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n          mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n          service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n          fault_codes: [\"Engine\", \"Transmission\", \"ABS\", \"Airbag\", \"Emissions\", \"Other\"],\n          other: [\"General\", \"Misc\"],\n        };\n\n        return (\n          <div className=\"space-y-4\">\n            {issues.map((issue, idx) => (\n              <div key={idx} className=\"bg-base-200 rounded-lg p-4 space-y-3\">\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"font-semibold text-sm\">Issue #{idx + 1}</span>\n                  <button\n                    type=\"button\"\n                    className=\"btn btn-ghost btn-xs text-error\"\n                    onClick={() => removeIssue(idx)}\n                  >\n                    Remove\n                  </button>\n                </div>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                  <div className=\"form-control\">\n                    <label className=\"label py-1\"><span className=\"label-text text-xs\">Category *</span></label>\n                    <select\n                      className=\"select select-bordered select-sm w-full\"\n                      value={issue.category}\n                      onChange={(e) => {\n                        updateIssue(idx, \"category\", e.target.value);\n                        updateIssue(idx, \"subcategory\", \"\");\n                      }}\n                      required\n                    >\n                      <option value=\"\">Select category...</option>\n                      <option value=\"mechanical\">Mechanical</option>\n                      <option value=\"electrical\">Electrical</option>\n                      <option value=\"bodywork\">Bodywork</option>\n                      <option value=\"interior\">Interior</option>\n                      <option value=\"tyres\">Tyres</option>\n                      <option value=\"mot\">MOT</option>\n                      <option value=\"service\">Service</option>\n                      <option value=\"fault_codes\">Fault Codes</option>\n                      <option value=\"other\">Other</option>\n                    </select>\n                  </div>\n                  {issue.category && (\n                    <div className=\"form-control\">\n                      <label className=\"label py-1\"><span className=\"label-text text-xs\">Subcategory</span></label>\n                      <select\n                        className=\"select select-bordered select-sm w-full\"\n                        value={issue.subcategory}\n                        onChange={(e) => updateIssue(idx, \"subcategory\", e.target.value)}\n                      >\n                        <option value=\"\">Select subcategory...</option>\n                        {(ISSUE_SUBCATEGORIES[issue.category] || []).map(sub => (\n                          <option key={sub} value={sub}>{sub}</option>\n                        ))}\n                      </select>\n                    </div>\n                  )}\n                </div>\n                <div className=\"form-control\">\n                  <label className=\"label py-1\"><span className=\"label-text text-xs\">Description *</span></label>\n                  <textarea\n                    className=\"textarea textarea-bordered textarea-sm w-full\"\n                    rows={3}\n                    placeholder=\"Describe the issue...\"\n                    value={issue.description}\n                    onChange={(e) => updateIssue(idx, \"description\", e.target.value)}\n                    required\n                  />\n                </div>\n                <div className=\"form-control\">\n                  <label className=\"label py-1\"><span className=\"label-text text-xs\">Action Needed</span></label>\n                  <input\n                    type=\"text\"\n                    className=\"input input-bordered input-sm w-full\"\n                    placeholder=\"What needs to be done?\"\n                    value={issue.actionNeeded || \"\"}\n                    onChange={(e) => updateIssue(idx, \"actionNeeded\", e.target.value)}\n                  />\n                </div>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                  <div className=\"form-control\">\n                    <label className=\"label py-1\"><span className=\"label-text text-xs\">Status</span></label>\n                    <select\n                      className=\"select select-bordered select-sm w-full\"\n                      value={issue.status || \"outstanding\"}\n                      onChange={(e) => updateIssue(idx, \"status\", e.target.value)}\n                    >\n                      <option value=\"outstanding\">Outstanding</option>\n                      <option value=\"ordered\">Ordered</option>\n                      <option value=\"in_progress\">In Progress</option>\n                      <option value=\"resolved\">Resolved</option>\n                    </select>\n                  </div>\n                </div>\n                <div className=\"form-control\">\n                  <label className=\"label py-1\"><span className=\"label-text text-xs\">Notes</span></label>\n                  <textarea\n                    className=\"textarea textarea-bordered textarea-sm w-full\"\n                    rows={2}\n                    placeholder=\"Additional notes...\"\n                    value={issue.notes || \"\"}\n                    onChange={(e) => updateIssue(idx, \"notes\", e.target.value)}\n                  />\n                </div>\n              </div>\n            ))}\n            <button\n              type=\"button\"\n              className=\"btn btn-outline btn-primary w-full\"\n              onClick={addIssue}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n              </svg>\n              Add Issue\n            </button>\n          </div>\n        );\n\n      default:\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n            placeholder={placeholder}\n          />\n        );\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <DashboardLayout>\n        <div className=\"flex justify-center py-20\">\n          <span className=\"loading loading-spinner loading-lg\"></span>\n        </div>\n      </DashboardLayout>\n    );\n  }\n\n  // Success state after submission\n  if (submittedId) {\n    return (\n      <DashboardLayout>\n        <Head>\n          <title>Form Submitted | DealerFlow</title>\n        </Head>\n\n        <div className=\"max-w-2xl mx-auto py-12\">\n          <div className=\"card bg-base-100 shadow-xl\">\n            <div className=\"card-body text-center\">\n              <div className=\"text-6xl mb-4\">✓</div>\n              <h2 className=\"card-title justify-center text-2xl mb-2\">Thank You!</h2>\n              <p className=\"text-base-content/70 mb-6\">\n                Your submission was successful.\n              </p>\n\n              <div className=\"flex flex-wrap justify-center gap-3\">\n                <button\n                  className=\"btn btn-primary\"\n                  onClick={handleSubmitAnother}\n                >\n                  Submit Another\n                </button>\n                <Link\n                  href={`/forms?tab=submissions`}\n                  className=\"btn btn-outline\"\n                >\n                  View in Inbox\n                </Link>\n                <Link\n                  href=\"/dashboard\"\n                  className=\"btn btn-ghost\"\n                >\n                  Back to Dashboard\n                </Link>\n              </div>\n            </div>\n          </div>\n        </div>\n      </DashboardLayout>\n    );\n  }\n\n  return (\n    <DashboardLayout>\n      <Head>\n        <title>{form?.name || \"Fill Form\"} | DealerFlow</title>\n      </Head>\n\n      {/* Header - Special layout for Service Receipt */}\n      {form?.type === \"SERVICE_RECEIPT\" ? (\n        <div className=\"mb-6\">\n          <div className=\"flex items-center gap-2 text-sm text-base-content/60 mb-2\">\n            <Link href=\"/forms\" className=\"hover:text-primary\">Forms</Link>\n            <span>/</span>\n            <span>Fill Out</span>\n          </div>\n          <div className=\"card bg-base-100 shadow-xl mb-6\">\n            <div className=\"card-body pb-4\">\n              {dealer?.logoUrl && (\n                <div className=\"flex justify-center mb-2\">\n                  <img src={dealer.logoUrl} alt={dealer.name} className=\"h-16 w-auto object-contain\" />\n                </div>\n              )}\n              <h1 className=\"text-2xl font-bold text-center uppercase\">Service Receipt</h1>\n              {(dealer?.companyAddress || dealer?.companyPhone) && (\n                <p className=\"text-base-content/60 text-center text-sm\">\n                  {[dealer?.companyAddress, dealer?.companyPhone].filter(Boolean).join(\" | \")}\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n      ) : (\n        <div className=\"mb-6\">\n          <div className=\"flex items-center gap-2 text-sm text-base-content/60 mb-2\">\n            <Link href=\"/forms\" className=\"hover:text-primary\">Forms</Link>\n            <span>/</span>\n            <span>Fill Out</span>\n          </div>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-3xl font-bold\">{form?.name}</h1>\n              {dealer?.companyAddress && (\n                <p className=\"text-base-content/60 mt-1 text-sm\">{dealer.companyAddress}</p>\n              )}\n              <div className=\"badge badge-outline mt-2\">\n                {FORM_TYPE_LABELS[form?.type] || form?.type}\n              </div>\n            </div>\n            <div className=\"flex items-center gap-4\">\n              {dealer?.logoUrl && (\n                <img src={dealer.logoUrl} alt={dealer.name} className=\"h-12 w-auto object-contain\" />\n              )}\n              <Link href=\"/forms\" className=\"btn btn-ghost\">\n                Cancel\n              </Link>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Form */}\n      <form onSubmit={handleSubmit} className=\"max-w-3xl\">\n        <div className=\"card bg-base-100 shadow-xl\">\n          <div className=\"card-body space-y-6\">\n            {(() => {\n              // Group fields by gridGroup for side-by-side rendering\n              // Filter out fields with visible: false\n              const visibleFields = fields.filter(f => f.visible !== false);\n              const renderedGroups = new Set();\n              return visibleFields.map((field, index) => {\n                // If this field is part of a gridGroup and we've already rendered it, skip\n                if (field.gridGroup && renderedGroups.has(field.gridGroup)) {\n                  return null;\n                }\n\n                // SECTION_HEADER renders as a divider\n                if (field.type === \"SECTION_HEADER\") {\n                  // Skip empty section headers\n                  if (!field.label) {\n                    return (\n                      <div key={field.id || field._id || index} className=\"border-t border-base-200 mt-4 pt-4\" />\n                    );\n                  }\n                  // Check if this is the Terms section - render terms text from template\n                  if (field.fieldName === \"_section_terms\" && form?.type) {\n                    const template = FORM_TEMPLATES.find(t => t.type === form.type);\n                    if (template?.termsText) {\n                      return (\n                        <div key={field.id || field._id || index} className={index > 0 ? \"pt-4 mt-4 border-t border-base-200\" : \"\"}>\n                          <h3 className={`text-lg font-bold text-primary mb-4 ${field.uppercase ? \"uppercase\" : \"\"}`}>{field.label}</h3>\n                          <div className=\"bg-base-200/50 rounded-lg p-4\">\n                            {formatTermsAsList(template.termsText)}\n                          </div>\n                        </div>\n                      );\n                    }\n                  }\n                  return (\n                    <div key={field.id || field._id || index} className={index > 0 ? \"pt-4 mt-4 border-t border-base-200\" : \"\"}>\n                      <h3 className={`text-lg font-bold text-primary ${field.uppercase ? \"uppercase\" : \"\"}`}>{field.label}</h3>\n                    </div>\n                  );\n                }\n\n                // PARAGRAPH renders as text with token replacement\n                if (field.type === \"PARAGRAPH\") {\n                  return (\n                    <div key={field.id || field._id || index} className=\"text-base-content/70 whitespace-pre-wrap text-sm leading-relaxed\">\n                      {replaceTokens(field.label)}\n                    </div>\n                  );\n                }\n\n                // Handle gridGroup - render multiple fields side by side\n                if (field.gridGroup) {\n                  renderedGroups.add(field.gridGroup);\n                  const groupFields = visibleFields.filter(f => f.gridGroup === field.gridGroup);\n\n                  return (\n                    <div key={field.gridGroup} className=\"grid grid-cols-2 gap-4\">\n                      {groupFields.map((gField) => (\n                        <div key={gField.id || gField._id || gField.fieldName} className=\"form-control\">\n                          <label className=\"label\">\n                            <span className={`label-text font-semibold ${gField.uppercase ? \"uppercase\" : \"\"}`}>\n                              {gField.label}\n                              {gField.required && <span className=\"text-error ml-1\">*</span>}\n                            </span>\n                          </label>\n                          {renderField(gField)}\n                        </div>\n                      ))}\n                    </div>\n                  );\n                }\n\n                // Normal form fields\n                return (\n                  <div key={field.id || field._id || index} className=\"form-control\">\n                    <label className=\"label\">\n                      <span className={`label-text font-semibold ${field.uppercase ? \"uppercase\" : \"\"}`}>\n                        {field.label}\n                        {field.required && <span className=\"text-error ml-1\">*</span>}\n                      </span>\n                    </label>\n                    {renderField(field)}\n                  </div>\n                );\n              });\n            })()}\n\n            {fields.filter(f => f.visible !== false).length === 0 && (\n              <div className=\"text-center py-8 text-base-content/60\">\n                This form has no visible fields configured yet.\n              </div>\n            )}\n\n            <div className=\"card-actions justify-end mt-8 pt-4 border-t border-base-200\">\n              <Link href=\"/forms\" className=\"btn btn-ghost\">\n                Cancel\n              </Link>\n              <button\n                type=\"submit\"\n                className=\"btn btn-primary btn-lg\"\n                disabled={isSubmitting || fields.length === 0}\n              >\n                {isSubmitting ? (\n                  <>\n                    <span className=\"loading loading-spinner\"></span>\n                    Submitting...\n                  </>\n                ) : (\n                  \"Submit Form\"\n                )}\n              </button>\n            </div>\n          </div>\n        </div>\n      </form>\n    </DashboardLayout>\n  );\n}\n","structuredPatch":[{"oldStart":46,"oldLines":6,"newStart":46,"newLines":10,"lines":["   const [vrmLookupConfig, setVrmLookupConfig] = useState(null);","   // Dealer info for token replacement","   const [dealer, setDealer] = useState(null);","+  // Licence extraction state","+  const [isExtractingLicence, setIsExtractingLicence] = useState(false);","+  const [licenceExtracted, setLicenceExtracted] = useState(false);","+  const [licenceExtractionError, setLicenceExtractionError] = useState(null);"," ","   useEffect(() => {","     if (id) {"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"d2f1fa84-4026-46eb-98ca-bbe527d73a5a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01294iU54adqcbFxcfF93efM","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the LICENCE_SCAN case to the switch statement. Let me add it before the default case:","signature":"Eo8CCkYICxgCKkC5KoaeRdl0H9B6NVWh84n48sXaaZj5pHXnvd9VmtQl2V047d/xxf+VfZwC5boGzDjBkXKYAVxvldto4MIExgWHEgxQO914pLNeMh2VNxQaDL04FASTDC3rNRDLjCIwSDF7SH70+M9mQ1LKw5xRodhMRsQL4hMbeAydMAXr8xtb4DUcHhYYtBqhtPdG5N8zKnfF4FyqPd5I7yied7CYTEzynUAP6HtEzwZ+uJOuimlc7hE/Uk8JQhH08v+7+59evxwzXn6xfnuKzsn33fL82xv+6RT6C9th7HSZHrJ+Gt2HLgNCphFqaefJoSj+TypeUNz7FR5cdsvIC93n2Lk9EEye7a2u821W0hgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1092,"cache_read_input_tokens":128120,"cache_creation":{"ephemeral_5m_input_tokens":1092,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9JwaaeEgKVn3cACkaU","type":"assistant","uuid":"4dc7e1a0-7d1b-491b-bfd1-0c6e4bb3c785","timestamp":"2025-12-30T15:55:41.676Z"}
{"parentUuid":"4dc7e1a0-7d1b-491b-bfd1-0c6e4bb3c785","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01294iU54adqcbFxcfF93efM","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me add the LICENCE_SCAN case before the default case:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1092,"cache_read_input_tokens":128120,"cache_creation":{"ephemeral_5m_input_tokens":1092,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9JwaaeEgKVn3cACkaU","type":"assistant","uuid":"2b817401-c344-4991-924f-65fb5505410f","timestamp":"2025-12-30T15:55:42.072Z"}
{"parentUuid":"2b817401-c344-4991-924f-65fb5505410f","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01294iU54adqcbFxcfF93efM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AK8FXeYaJWtcr21Kb3v82V","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","old_string":"            </button>\n          </div>\n        );\n\n      default:\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n            placeholder={placeholder}\n          />\n        );\n    }","new_string":"            </button>\n          </div>\n        );\n\n      case \"LICENCE_SCAN\":\n        // Licence scan with OCR extraction\n        const handleLicenceCapture = async (file) => {\n          if (!file) return;\n\n          setIsExtractingLicence(true);\n          setLicenceExtractionError(null);\n          setLicenceExtracted(false);\n\n          try {\n            // Convert file to base64\n            const reader = new FileReader();\n            reader.onload = async () => {\n              const base64 = reader.result.split(\",\")[1]; // Remove data URL prefix\n              const mimeType = file.type || \"image/jpeg\";\n\n              // Store the image in form data\n              handleInputChange(field.fieldName, [file]);\n\n              // Call extraction API\n              const res = await fetch(\"/api/forms/test-drive/extract-licence\", {\n                method: \"POST\",\n                headers: { \"Content-Type\": \"application/json\" },\n                body: JSON.stringify({ image: base64, mimeType }),\n              });\n\n              const data = await res.json();\n\n              if (data.ok && data.data) {\n                // Auto-fill form fields from extracted data\n                const extracted = data.data;\n                const updates = {};\n\n                // Map extracted fields to form field names using autoFillFromLicence config\n                fields.forEach((f) => {\n                  if (f.autoFillFromLicence && extracted[f.autoFillFromLicence]) {\n                    updates[f.fieldName] = extracted[f.autoFillFromLicence];\n                  }\n                });\n\n                // Apply all updates at once\n                if (Object.keys(updates).length > 0) {\n                  setFormData((prev) => ({ ...prev, ...updates }));\n                  setLicenceExtracted(true);\n                  toast.success(\"Details captured from licence - please verify\");\n                } else {\n                  setLicenceExtractionError(\"Could not extract details. Please enter manually.\");\n                }\n              } else {\n                setLicenceExtractionError(data.error || \"Could not extract details. Please enter manually.\");\n              }\n\n              setIsExtractingLicence(false);\n            };\n\n            reader.onerror = () => {\n              setLicenceExtractionError(\"Failed to read file. Please try again.\");\n              setIsExtractingLicence(false);\n            };\n\n            reader.readAsDataURL(file);\n          } catch (error) {\n            console.error(\"Licence extraction error:\", error);\n            setLicenceExtractionError(\"Failed to process licence. Please enter details manually.\");\n            setIsExtractingLicence(false);\n          }\n        };\n\n        const clearLicenceData = () => {\n          // Clear the licence photo and reset extraction state\n          handleInputChange(field.fieldName, null);\n          setLicenceExtracted(false);\n          setLicenceExtractionError(null);\n\n          // Clear auto-filled fields\n          const fieldsToClear = {};\n          fields.forEach((f) => {\n            if (f.autoFillFromLicence) {\n              fieldsToClear[f.fieldName] = \"\";\n            }\n          });\n          setFormData((prev) => ({ ...prev, ...fieldsToClear }));\n        };\n\n        return (\n          <div className=\"space-y-3\">\n            {/* Success banner */}\n            {licenceExtracted && (\n              <div className=\"alert alert-success shadow-sm\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n                <div>\n                  <h3 className=\"font-bold text-sm\">Details captured from licence</h3>\n                  <p className=\"text-xs\">Please verify the information below is correct</p>\n                </div>\n                <button type=\"button\" className=\"btn btn-ghost btn-xs\" onClick={clearLicenceData}>\n                  Clear\n                </button>\n              </div>\n            )}\n\n            {/* Error banner */}\n            {licenceExtractionError && (\n              <div className=\"alert alert-warning shadow-sm\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                </svg>\n                <span className=\"text-sm\">{licenceExtractionError}</span>\n              </div>\n            )}\n\n            {/* File input with camera option */}\n            <div className=\"flex flex-col sm:flex-row gap-2\">\n              <label className=\"flex-1 cursor-pointer\">\n                <div className={`border-2 border-dashed rounded-xl p-4 text-center transition-colors ${\n                  isExtractingLicence ? \"border-primary bg-primary/5\" :\n                  value && value.length > 0 ? \"border-success bg-success/5\" :\n                  \"border-base-300 hover:border-primary hover:bg-primary/5\"\n                }`}>\n                  {isExtractingLicence ? (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <span className=\"loading loading-spinner loading-md text-primary\"></span>\n                      <span className=\"text-sm text-primary\">Extracting details...</span>\n                    </div>\n                  ) : value && value.length > 0 ? (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-success\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                      </svg>\n                      <span className=\"text-sm text-success font-medium\">Photo captured</span>\n                      <span className=\"text-xs text-base-content/60\">{value[0]?.name || \"licence_photo.jpg\"}</span>\n                    </div>\n                  ) : (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-base-content/40\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\" />\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 13a3 3 0 11-6 0 3 3 0 016 0z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Take photo or upload</span>\n                      <span className=\"text-xs text-base-content/60\">Tap to capture your driving licence</span>\n                    </div>\n                  )}\n                </div>\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  capture=\"environment\"\n                  className=\"hidden\"\n                  onChange={(e) => {\n                    const file = e.target.files?.[0];\n                    if (file) {\n                      handleLicenceCapture(file);\n                    }\n                  }}\n                  disabled={isExtractingLicence}\n                />\n              </label>\n            </div>\n\n            {helpText && <p className=\"text-sm text-base-content/60\">{helpText}</p>}\n          </div>\n        );\n\n      default:\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n            placeholder={placeholder}\n          />\n        );\n    }"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1092,"cache_read_input_tokens":128120,"cache_creation":{"ephemeral_5m_input_tokens":1092,"ephemeral_1h_input_tokens":0},"output_tokens":2613,"service_tier":"standard"}},"requestId":"req_011CWd9JwaaeEgKVn3cACkaU","type":"assistant","uuid":"242c35f7-b071-48df-8c1e-e5e52c878fa7","timestamp":"2025-12-30T15:56:21.100Z"}
{"parentUuid":"242c35f7-b071-48df-8c1e-e5e52c878fa7","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AK8FXeYaJWtcr21Kb3v82V","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   880→              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n   881→                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n   882→              </svg>\n   883→              Add Issue\n   884→            </button>\n   885→          </div>\n   886→        );\n   887→\n   888→      case \"LICENCE_SCAN\":\n   889→        // Licence scan with OCR extraction\n   890→        const handleLicenceCapture = async (file) => {\n   891→          if (!file) return;\n   892→\n   893→          setIsExtractingLicence(true);\n   894→          setLicenceExtractionError(null);\n   895→          setLicenceExtracted(false);\n   896→\n   897→          try {\n   898→            // Convert file to base64\n   899→            const reader = new FileReader();\n   900→            reader.onload = async () => {\n   901→              const base64 = reader.result.split(\",\")[1]; // Remove data URL prefix\n   902→              const mimeType = file.type || \"image/jpeg\";\n   903→\n   904→              // Store the image in form data\n   905→              handleInputChange(field.fieldName, [file]);\n   906→\n   907→              // Call extraction API\n   908→              const res = await fetch(\"/api/forms/test-drive/extract-licence\", {\n   909→                method: \"POST\",\n   910→                headers: { \"Content-Type\": \"application/json\" },\n   911→                body: JSON.stringify({ image: base64, mimeType }),\n   912→              });\n   913→\n   914→              const data = await res.json();\n   915→\n   916→              if (data.ok && data.data) {\n   917→                // Auto-fill form fields from extracted data\n   918→                const extracted = data.data;\n   919→                const updates = {};\n   920→\n   921→                // Map extracted fields to form field names using autoFillFromLicence config\n   922→                fields.forEach((f) => {\n   923→                  if (f.autoFillFromLicence && extracted[f.autoFillFromLicence]) {\n   924→                    updates[f.fieldName] = extracted[f.autoFillFromLicence];\n   925→                  }\n   926→                });\n   927→\n   928→                // Apply all updates at once\n   929→                if (Object.keys(updates).length > 0) {\n   930→                  setFormData((prev) => ({ ...prev, ...updates }));\n   931→                  setLicenceExtracted(true);\n   932→                  toast.success(\"Details captured from licence - please verify\");\n   933→                } else {\n   934→                  setLicenceExtractionError(\"Could not extract details. Please enter manually.\");\n   935→                }\n   936→              } else {\n   937→                setLicenceExtractionError(data.error || \"Could not extract details. Please enter manually.\");\n   938→              }\n   939→\n   940→              setIsExtractingLicence(false);\n   941→            };\n   942→\n   943→            reader.onerror = () => {\n   944→              setLicenceExtractionError(\"Failed to read file. Please try again.\");\n   945→              setIsExtractingLicence(false);\n   946→            };\n   947→\n   948→            reader.readAsDataURL(file);\n   949→          } catch (error) {\n   950→            console.error(\"Licence extraction error:\", error);\n   951→            setLicenceExtractionError(\"Failed to process licence. Please enter details manually.\");\n   952→            setIsExtractingLicence(false);\n   953→          }\n   954→        };\n   955→\n   956→        const clearLicenceData = () => {\n   957→          // Clear the licence photo and reset extraction state\n   958→          handleInputChange(field.fieldName, null);\n   959→          setLicenceExtracted(false);\n   960→          setLicenceExtractionError(null);\n   961→\n   962→          // Clear auto-filled fields\n   963→          const fieldsToClear = {};\n   964→          fields.forEach((f) => {\n   965→            if (f.autoFillFromLicence) {\n   966→              fieldsToClear[f.fieldName] = \"\";\n   967→            }\n   968→          });\n   969→          setFormData((prev) => ({ ...prev, ...fieldsToClear }));\n   970→        };\n   971→\n   972→        return (\n   973→          <div className=\"space-y-3\">\n   974→            {/* Success banner */}\n   975→            {licenceExtracted && (\n   976→              <div className=\"alert alert-success shadow-sm\">\n   977→                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n   978→                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n   979→                </svg>\n   980→                <div>\n   981→                  <h3 className=\"font-bold text-sm\">Details captured from licence</h3>\n   982→                  <p className=\"text-xs\">Please verify the information below is correct</p>\n   983→                </div>\n   984→                <button type=\"button\" className=\"btn btn-ghost btn-xs\" onClick={clearLicenceData}>\n   985→                  Clear\n   986→                </button>\n   987→              </div>\n   988→            )}\n   989→\n   990→            {/* Error banner */}\n   991→            {licenceExtractionError && (\n   992→              <div className=\"alert alert-warning shadow-sm\">\n   993→                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n   994→                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n   995→                </svg>\n   996→                <span className=\"text-sm\">{licenceExtractionError}</span>\n   997→              </div>\n   998→            )}\n   999→\n  1000→            {/* File input with camera option */}\n  1001→            <div className=\"flex flex-col sm:flex-row gap-2\">\n  1002→              <label className=\"flex-1 cursor-pointer\">\n  1003→                <div className={`border-2 border-dashed rounded-xl p-4 text-center transition-colors ${\n  1004→                  isExtractingLicence ? \"border-primary bg-primary/5\" :\n  1005→                  value && value.length > 0 ? \"border-success bg-success/5\" :\n  1006→                  \"border-base-300 hover:border-primary hover:bg-primary/5\"\n  1007→                }`}>\n  1008→                  {isExtractingLicence ? (\n  1009→                    <div className=\"flex flex-col items-center gap-2\">\n  1010→                      <span className=\"loading loading-spinner loading-md text-primary\"></span>\n  1011→                      <span className=\"text-sm text-primary\">Extracting details...</span>\n  1012→                    </div>\n  1013→                  ) : value && value.length > 0 ? (\n  1014→                    <div className=\"flex flex-col items-center gap-2\">\n  1015→                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-success\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n  1016→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n  1017→                      </svg>\n  1018→                      <span className=\"text-sm text-success font-medium\">Photo captured</span>\n  1019→                      <span className=\"text-xs text-base-content/60\">{value[0]?.name || \"licence_photo.jpg\"}</span>\n  1020→                    </div>\n  1021→                  ) : (\n  1022→                    <div className=\"flex flex-col items-center gap-2\">\n  1023→                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-base-content/40\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n  1024→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\" />\n  1025→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 13a3 3 0 11-6 0 3 3 0 016 0z\" />\n  1026→                      </svg>\n  1027→                      <span className=\"text-sm font-medium\">Take photo or upload</span>\n  1028→                      <span className=\"text-xs text-base-content/60\">Tap to capture your driving licence</span>\n  1029→                    </div>\n  1030→                  )}\n  1031→                </div>\n  1032→                <input\n  1033→                  type=\"file\"\n  1034→                  accept=\"image/*\"\n  1035→                  capture=\"environment\"\n  1036→                  className=\"hidden\"\n  1037→                  onChange={(e) => {\n  1038→                    const file = e.target.files?.[0];\n  1039→                    if (file) {\n  1040→                      handleLicenceCapture(file);\n  1041→                    }\n  1042→                  }}\n  1043→                  disabled={isExtractingLicence}\n  1044→                />\n  1045→              </label>\n  1046→            </div>\n  1047→\n  1048→            {helpText && <p className=\"text-sm text-base-content/60\">{helpText}</p>}\n  1049→          </div>\n  1050→        );\n  1051→\n  1052→      default:\n  1053→        return (\n  1054→          <input\n  1055→            type=\"text\"\n  1056→            className=\"input input-bordered w-full\"\n  1057→            value={value}\n  1058→            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n  1059→            required={field.required}\n  1060→            placeholder={placeholder}\n  1061→          />\n  1062→        );\n  1063→    }\n  1064→  };\n  1065→\n  1066→  if (isLoading) {\n  1067→    return ("}]},"uuid":"477432d9-2c3a-4f31-8143-76b9a099b581","timestamp":"2025-12-30T15:56:22.569Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\forms\\fill\\[id].js","oldString":"            </button>\n          </div>\n        );\n\n      default:\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n            placeholder={placeholder}\n          />\n        );\n    }","newString":"            </button>\n          </div>\n        );\n\n      case \"LICENCE_SCAN\":\n        // Licence scan with OCR extraction\n        const handleLicenceCapture = async (file) => {\n          if (!file) return;\n\n          setIsExtractingLicence(true);\n          setLicenceExtractionError(null);\n          setLicenceExtracted(false);\n\n          try {\n            // Convert file to base64\n            const reader = new FileReader();\n            reader.onload = async () => {\n              const base64 = reader.result.split(\",\")[1]; // Remove data URL prefix\n              const mimeType = file.type || \"image/jpeg\";\n\n              // Store the image in form data\n              handleInputChange(field.fieldName, [file]);\n\n              // Call extraction API\n              const res = await fetch(\"/api/forms/test-drive/extract-licence\", {\n                method: \"POST\",\n                headers: { \"Content-Type\": \"application/json\" },\n                body: JSON.stringify({ image: base64, mimeType }),\n              });\n\n              const data = await res.json();\n\n              if (data.ok && data.data) {\n                // Auto-fill form fields from extracted data\n                const extracted = data.data;\n                const updates = {};\n\n                // Map extracted fields to form field names using autoFillFromLicence config\n                fields.forEach((f) => {\n                  if (f.autoFillFromLicence && extracted[f.autoFillFromLicence]) {\n                    updates[f.fieldName] = extracted[f.autoFillFromLicence];\n                  }\n                });\n\n                // Apply all updates at once\n                if (Object.keys(updates).length > 0) {\n                  setFormData((prev) => ({ ...prev, ...updates }));\n                  setLicenceExtracted(true);\n                  toast.success(\"Details captured from licence - please verify\");\n                } else {\n                  setLicenceExtractionError(\"Could not extract details. Please enter manually.\");\n                }\n              } else {\n                setLicenceExtractionError(data.error || \"Could not extract details. Please enter manually.\");\n              }\n\n              setIsExtractingLicence(false);\n            };\n\n            reader.onerror = () => {\n              setLicenceExtractionError(\"Failed to read file. Please try again.\");\n              setIsExtractingLicence(false);\n            };\n\n            reader.readAsDataURL(file);\n          } catch (error) {\n            console.error(\"Licence extraction error:\", error);\n            setLicenceExtractionError(\"Failed to process licence. Please enter details manually.\");\n            setIsExtractingLicence(false);\n          }\n        };\n\n        const clearLicenceData = () => {\n          // Clear the licence photo and reset extraction state\n          handleInputChange(field.fieldName, null);\n          setLicenceExtracted(false);\n          setLicenceExtractionError(null);\n\n          // Clear auto-filled fields\n          const fieldsToClear = {};\n          fields.forEach((f) => {\n            if (f.autoFillFromLicence) {\n              fieldsToClear[f.fieldName] = \"\";\n            }\n          });\n          setFormData((prev) => ({ ...prev, ...fieldsToClear }));\n        };\n\n        return (\n          <div className=\"space-y-3\">\n            {/* Success banner */}\n            {licenceExtracted && (\n              <div className=\"alert alert-success shadow-sm\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n                <div>\n                  <h3 className=\"font-bold text-sm\">Details captured from licence</h3>\n                  <p className=\"text-xs\">Please verify the information below is correct</p>\n                </div>\n                <button type=\"button\" className=\"btn btn-ghost btn-xs\" onClick={clearLicenceData}>\n                  Clear\n                </button>\n              </div>\n            )}\n\n            {/* Error banner */}\n            {licenceExtractionError && (\n              <div className=\"alert alert-warning shadow-sm\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                </svg>\n                <span className=\"text-sm\">{licenceExtractionError}</span>\n              </div>\n            )}\n\n            {/* File input with camera option */}\n            <div className=\"flex flex-col sm:flex-row gap-2\">\n              <label className=\"flex-1 cursor-pointer\">\n                <div className={`border-2 border-dashed rounded-xl p-4 text-center transition-colors ${\n                  isExtractingLicence ? \"border-primary bg-primary/5\" :\n                  value && value.length > 0 ? \"border-success bg-success/5\" :\n                  \"border-base-300 hover:border-primary hover:bg-primary/5\"\n                }`}>\n                  {isExtractingLicence ? (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <span className=\"loading loading-spinner loading-md text-primary\"></span>\n                      <span className=\"text-sm text-primary\">Extracting details...</span>\n                    </div>\n                  ) : value && value.length > 0 ? (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-success\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                      </svg>\n                      <span className=\"text-sm text-success font-medium\">Photo captured</span>\n                      <span className=\"text-xs text-base-content/60\">{value[0]?.name || \"licence_photo.jpg\"}</span>\n                    </div>\n                  ) : (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-base-content/40\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\" />\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 13a3 3 0 11-6 0 3 3 0 016 0z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Take photo or upload</span>\n                      <span className=\"text-xs text-base-content/60\">Tap to capture your driving licence</span>\n                    </div>\n                  )}\n                </div>\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  capture=\"environment\"\n                  className=\"hidden\"\n                  onChange={(e) => {\n                    const file = e.target.files?.[0];\n                    if (file) {\n                      handleLicenceCapture(file);\n                    }\n                  }}\n                  disabled={isExtractingLicence}\n                />\n              </label>\n            </div>\n\n            {helpText && <p className=\"text-sm text-base-content/60\">{helpText}</p>}\n          </div>\n        );\n\n      default:\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n            placeholder={placeholder}\n          />\n        );\n    }","originalFile":"import { useState, useEffect, useCallback } from \"react\";\nimport Head from \"next/head\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/router\";\nimport dynamic from \"next/dynamic\";\nimport DashboardLayout from \"@/components/DashboardLayout\";\nimport toast from \"react-hot-toast\";\nimport { FORM_TEMPLATES } from \"@/libs/formTemplates\";\n\n// Dynamic import for signature pad (client-side only)\nconst DrawableSignature = dynamic(() => import(\"@/components/DrawableSignature\"), {\n  ssr: false,\n  loading: () => <div className=\"h-[150px] bg-base-200 rounded-lg animate-pulse\" />\n});\n\n// Human-readable form type labels\nconst FORM_TYPE_LABELS = {\n  PDI: \"PDI\",\n  TEST_DRIVE: \"Test Drive\",\n  WARRANTY_CLAIM: \"Warranty Claim\",\n  COURTESY_OUT: \"Courtesy Car Out\",\n  COURTESY_IN: \"Courtesy Car In\",\n  DELIVERY: \"Delivery\",\n  SERVICE_RECEIPT: \"Service Receipt\",\n  REVIEW_FEEDBACK: \"Review & Feedback\",\n  OTHER: \"Other\",\n};\n\nexport default function FillForm() {\n  const router = useRouter();\n  const { id } = router.query;\n\n  const [form, setForm] = useState(null);\n  const [fields, setFields] = useState([]);\n  const [formData, setFormData] = useState({});\n  const [isLoading, setIsLoading] = useState(true);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [submittedId, setSubmittedId] = useState(null);\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [stockVehicles, setStockVehicles] = useState([]);\n  const [stockSearch, setStockSearch] = useState(\"\");\n  // Smart VRM lookup state\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  const [vrmLookupConfig, setVrmLookupConfig] = useState(null);\n  // Dealer info for token replacement\n  const [dealer, setDealer] = useState(null);\n  // Licence extraction state\n  const [isExtractingLicence, setIsExtractingLicence] = useState(false);\n  const [licenceExtracted, setLicenceExtracted] = useState(false);\n  const [licenceExtractionError, setLicenceExtractionError] = useState(null);\n\n  useEffect(() => {\n    if (id) {\n      loadForm();\n      loadDealer();\n    }\n  }, [id]);\n\n  const loadDealer = async () => {\n    try {\n      const res = await fetch(\"/api/dealer\");\n      const data = await res.json();\n      setDealer(data);\n    } catch (error) {\n      console.error(\"Failed to load dealer:\", error);\n    }\n  };\n\n  // Replace tokens in text with dealer info\n  const replaceTokens = (text) => {\n    if (!text || !dealer) return text;\n    return text\n      .replace(/\\{companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\")\n      .replace(/\\{dealer\\.companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{dealer\\.companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{dealer\\.companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{dealer\\.companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\");\n  };\n\n  // Format terms text as bullet list\n  const formatTermsAsList = (text) => {\n    if (!text) return null;\n    const processedText = replaceTokens(text);\n\n    // Split by bullet points, dashes, or numbered items\n    const lines = processedText\n      .split(/(?:^|\\n)(?:•|●|-|\\d+\\.)\\s*/g)\n      .map(line => line.trim())\n      .filter(line => line.length > 0);\n\n    if (lines.length <= 1) {\n      // If no bullet format detected, try splitting by newlines\n      const newlineLines = processedText.split(\"\\n\").filter(line => line.trim());\n      if (newlineLines.length > 1) {\n        return (\n          <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n            {newlineLines.map((line, idx) => (\n              <li key={idx}>{line.trim().replace(/^[-•●]\\s*/, \"\")}</li>\n            ))}\n          </ul>\n        );\n      }\n      return <p className=\"text-sm text-base-content/80 whitespace-pre-wrap\">{processedText}</p>;\n    }\n\n    return (\n      <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n        {lines.map((line, idx) => (\n          <li key={idx}>{line}</li>\n        ))}\n      </ul>\n    );\n  };\n\n  useEffect(() => {\n    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {\n      fetchCourtesyVehicles();\n    }\n    if (form?.type === \"TEST_DRIVE\") {\n      fetchStockVehicles();\n    }\n    // Get VRM lookup config from templates\n    if (form?.type) {\n      const template = FORM_TEMPLATES.find(t => t.type === form.type);\n      if (template?.vrmLookup) {\n        setVrmLookupConfig(template.vrmLookup);\n      }\n    }\n  }, [form?.type]);\n\n  // Initialize default values for time/date fields\n  useEffect(() => {\n    if (!fields.length) return;\n    const now = new Date();\n    const updates = {};\n\n    // Test Drive form: default date and time\n    if (form?.type === \"TEST_DRIVE\") {\n      const timeField = fields.find(f => f.fieldName === \"time\" && f.type === \"TIME\");\n      const dateField = fields.find(f => f.fieldName === \"date\" && f.type === \"DATE\");\n\n      // Set default time to current time (rounded to nearest 15 min)\n      if (timeField && !formData.time) {\n        const minutes = Math.round(now.getMinutes() / 15) * 15;\n        const hours = now.getHours() + (minutes >= 60 ? 1 : 0);\n        const adjustedMinutes = minutes >= 60 ? 0 : minutes;\n        updates.time = `${String(hours).padStart(2, \"0\")}:${String(adjustedMinutes).padStart(2, \"0\")}`;\n      }\n\n      // Set default date to today\n      if (dateField && !formData.date) {\n        updates.date = now.toISOString().split(\"T\")[0];\n      }\n    }\n\n    // Service Receipt form: default service_date to today\n    if (form?.type === \"SERVICE_RECEIPT\") {\n      const serviceDateField = fields.find(f => f.fieldName === \"service_date\" && f.type === \"DATE\");\n      if (serviceDateField && !formData.service_date) {\n        updates.service_date = now.toISOString().split(\"T\")[0];\n      }\n    }\n\n    if (Object.keys(updates).length > 0) {\n      setFormData(prev => ({ ...prev, ...updates }));\n    }\n  }, [form?.type, fields]);\n\n  const loadForm = async () => {\n    try {\n      const res = await fetch(`/api/forms/${id}`);\n      const data = await res.json();\n\n      if (!res.ok || data.error) {\n        toast.error(\"Form not found\");\n        router.push(\"/forms\");\n        return;\n      }\n\n      setForm(data.form);\n      setFields(data.fields || []);\n      setIsLoading(false);\n    } catch (error) {\n      console.error(\"Failed to load form:\", error);\n      toast.error(\"Failed to load form\");\n      router.push(\"/forms\");\n    }\n  };\n\n  const fetchCourtesyVehicles = async () => {\n    try {\n      const res = await fetch(\"/api/vehicles/courtesy\");\n      const data = await res.json();\n      setCourtesyVehicles(data);\n    } catch (error) {\n      console.error(\"Failed to fetch courtesy vehicles:\", error);\n    }\n  };\n\n  const fetchStockVehicles = async (search = \"\") => {\n    try {\n      const res = await fetch(`/api/vehicles/stock?search=${encodeURIComponent(search)}`);\n      const data = await res.json();\n      setStockVehicles(data);\n    } catch (error) {\n      console.error(\"Failed to fetch stock vehicles:\", error);\n    }\n  };\n\n  // Smart VRM search with status filtering\n  const searchVehicles = useCallback(async (query) => {\n    if (!query || query.length < 2 || !vrmLookupConfig) {\n      setVrmSuggestions([]);\n      return;\n    }\n\n    try {\n      const params = new URLSearchParams({ q: query });\n      if (vrmLookupConfig.statuses) {\n        params.append(\"statuses\", vrmLookupConfig.statuses.join(\",\"));\n      }\n      if (vrmLookupConfig.vehicleType) {\n        params.append(\"vehicleType\", vrmLookupConfig.vehicleType);\n      }\n\n      const res = await fetch(`/api/vehicles/search?${params.toString()}`);\n      const data = await res.json();\n      setVrmSuggestions(data);\n    } catch (error) {\n      console.error(\"VRM search error:\", error);\n    }\n  }, [vrmLookupConfig]);\n\n  // Handle vehicle selection from suggestions\n  const handleVehicleSelect = (vehicle) => {\n    setFormData(prev => ({\n      ...prev,\n      vrm: vehicle.vrm,\n      make: vehicle.make,\n      model: vehicle.model,\n      colour: vehicle.colour,\n      mileage: vehicle.mileage,\n      year: vehicle.year,\n      vehicle_make: vehicle.make,\n      vehicle_model: vehicle.model,\n      _selectedVehicle: vehicle,\n    }));\n    setVrmSuggestions([]);\n    setVrmSearchActive(false);\n    toast.success(`Selected: ${vehicle.displayName}`);\n  };\n\n  const handleInputChange = (fieldName, value) => {\n    setFormData((prev) => ({\n      ...prev,\n      [fieldName]: value,\n    }));\n  };\n\n  const handleVrmLookup = async (fieldName) => {\n    const vrm = formData[fieldName];\n    if (!vrm) {\n      toast.error(\"Enter a registration number first\");\n      return;\n    }\n\n    setIsLookingUp(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: vrm }),\n      });\n      const data = await res.json();\n\n      if (res.ok && data.make) {\n        const updates = {};\n        if (data.make) updates.make = data.make;\n        if (data.model) updates.model = data.model;\n        if (data.year) updates.year = data.year;\n        if (data.colour) updates.colour = data.colour;\n        if (data.fuelType) updates.fuel_type = data.fuelType;\n\n        setFormData(prev => ({ ...prev, ...updates }));\n        toast.success(`Found: ${data.year || \"\"} ${data.make} ${data.model} - ${data.colour || \"\"}`);\n      } else {\n        toast.error(\"Vehicle not found or lookup failed\");\n      }\n    } catch (error) {\n      console.error(\"DVLA lookup error:\", error);\n      toast.error(\"Failed to lookup vehicle\");\n    } finally {\n      setIsLookingUp(false);\n    }\n  };\n\n  const handleCourtesyVehicleSelect = (vehicleId) => {\n    const vehicle = courtesyVehicles.find(v => v.id === vehicleId);\n    if (vehicle) {\n      setFormData(prev => ({\n        ...prev,\n        courtesy_vrm: vehicle.regCurrent,\n        courtesy_vehicle_id: vehicle.id,\n        courtesy_vehicle_display: `${vehicle.regCurrent} - ${vehicle.make} ${vehicle.model}`,\n      }));\n    }\n  };\n\n  const handleStockVehicleSelect = (vehicleId) => {\n    const vehicle = stockVehicles.find(v => v.id === vehicleId);\n    if (vehicle) {\n      setFormData(prev => ({\n        ...prev,\n        vrm: vehicle.regCurrent,\n        vehicle_interest: vehicle.displayName,\n        vehicle_id: vehicle.id,\n      }));\n    }\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsSubmitting(true);\n\n    try {\n      const res = await fetch(\"/api/forms/submissions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          formId: form.id || form._id,\n          rawAnswers: formData,\n        }),\n      });\n\n      const data = await res.json();\n\n      if (!res.ok) throw new Error(data.error || \"Submission failed\");\n\n      setSubmittedId(data.id || data._id);\n      toast.success(\"Form submitted successfully!\");\n    } catch (error) {\n      console.error(\"Submission error:\", error);\n      toast.error(\"Failed to submit form. Please try again.\");\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const handleSubmitAnother = () => {\n    setFormData({});\n    setSubmittedId(null);\n  };\n\n  const isVrmField = (field) => {\n    const vrmFieldNames = [\"vrm\", \"reg\", \"registration\", \"vehicle_reg\", \"regcurrent\", \"courtesy_vrm\"];\n    return vrmFieldNames.includes(field.fieldName.toLowerCase()) ||\n           field.label.toLowerCase().includes(\"registration\") ||\n           field.label.toLowerCase().includes(\"vrm\");\n  };\n\n  const isCourtesyVehicleField = (field) => {\n    return (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") &&\n           (field.fieldName === \"courtesy_vrm\" || field.label.toLowerCase().includes(\"courtesy vehicle\"));\n  };\n\n  const isStockVehicleField = (field) => {\n    return form?.type === \"TEST_DRIVE\" &&\n           (field.fieldName === \"vrm\" || field.fieldName === \"vehicle_interest\" ||\n            field.label.toLowerCase().includes(\"vehicle of interest\"));\n  };\n\n  const renderField = (field) => {\n    const value = formData[field.fieldName] || \"\";\n\n    // Special handling for courtesy vehicle selection\n    if (isCourtesyVehicleField(field)) {\n      return (\n        <div className=\"space-y-2\">\n          <select\n            className=\"select select-bordered w-full\"\n            value={formData.courtesy_vehicle_id || \"\"}\n            onChange={(e) => handleCourtesyVehicleSelect(e.target.value)}\n            required={field.required}\n          >\n            <option value=\"\">Select courtesy vehicle...</option>\n            {courtesyVehicles.map((v) => (\n              <option key={v.id} value={v.id}>\n                {v.regCurrent} - {v.make} {v.model} {v.colour ? `(${v.colour})` : \"\"}\n              </option>\n            ))}\n          </select>\n          {formData.courtesy_vehicle_display && (\n            <div className=\"text-sm text-success\">Selected: {formData.courtesy_vehicle_display}</div>\n          )}\n        </div>\n      );\n    }\n\n    // Special handling for stock vehicle selection (test drive)\n    if (isStockVehicleField(field)) {\n      return (\n        <div className=\"space-y-2\">\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            placeholder=\"Search by VRM or Make/Model...\"\n            value={stockSearch}\n            onChange={(e) => {\n              setStockSearch(e.target.value);\n              fetchStockVehicles(e.target.value);\n            }}\n          />\n          {stockVehicles.length > 0 && stockSearch && (\n            <div className=\"dropdown dropdown-open w-full\">\n              <ul className=\"dropdown-content menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto\">\n                {stockVehicles.slice(0, 10).map((v) => (\n                  <li key={v.id}>\n                    <button type=\"button\" onClick={() => {\n                      handleStockVehicleSelect(v.id);\n                      setStockSearch(\"\");\n                    }}>\n                      {v.displayName}\n                    </button>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n          {formData.vehicle_interest && (\n            <div className=\"text-sm text-success\">Selected: {formData.vehicle_interest}</div>\n          )}\n        </div>\n      );\n    }\n\n    // VRM field with smart lookup (autocomplete from database + DVLA fallback)\n    if (isVrmField(field) && field.type === \"TEXT\") {\n      return (\n        <div className=\"relative\">\n          <div className=\"flex gap-2\">\n            <input\n              type=\"text\"\n              className=\"input input-bordered flex-1 uppercase font-mono\"\n              value={value}\n              onChange={(e) => {\n                const newValue = e.target.value.toUpperCase();\n                handleInputChange(field.fieldName, newValue);\n                // Trigger smart search if VRM lookup is configured\n                if (vrmLookupConfig?.enabled !== false) {\n                  searchVehicles(newValue);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onFocus={() => {\n                if (vrmLookupConfig?.enabled !== false && value && value.length >= 2) {\n                  searchVehicles(value);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onBlur={() => {\n                // Delay hiding to allow click on suggestion\n                setTimeout(() => setVrmSearchActive(false), 200);\n              }}\n              required={field.required}\n              placeholder={vrmLookupConfig ? \"Search or enter VRM...\" : \"AB12 CDE\"}\n            />\n            <button\n              type=\"button\"\n              className=\"btn btn-secondary\"\n              onClick={() => handleVrmLookup(field.fieldName)}\n              disabled={isLookingUp}\n              title=\"DVLA Lookup\"\n            >\n              {isLookingUp ? <span className=\"loading loading-spinner loading-sm\"></span> : \"DVLA\"}\n            </button>\n          </div>\n          {/* Smart VRM suggestions dropdown */}\n          {vrmSearchActive && vrmSuggestions.length > 0 && (\n            <div className=\"absolute z-50 w-full mt-1 bg-base-100 border border-base-300 rounded-lg shadow-lg max-h-60 overflow-y-auto\">\n              <div className=\"text-xs text-base-content/60 px-3 py-1 border-b border-base-200 bg-base-200/50\">\n                Select from your vehicles or press DVLA for external lookup\n              </div>\n              {vrmSuggestions.map((vehicle) => (\n                <button\n                  key={vehicle.id}\n                  type=\"button\"\n                  className=\"w-full px-3 py-2 text-left hover:bg-primary/10 border-b border-base-200 last:border-0\"\n                  onClick={() => handleVehicleSelect(vehicle)}\n                >\n                  <div className=\"font-mono font-bold\">{vehicle.vrm}</div>\n                  <div className=\"text-sm text-base-content/70\">\n                    {vehicle.make} {vehicle.model} {vehicle.year ? `(${vehicle.year})` : \"\"} - {vehicle.colour || \"\"}\n                  </div>\n                  <div className=\"text-xs text-base-content/50\">\n                    Status: {vehicle.status} {vehicle.mileage ? `| ${vehicle.mileage.toLocaleString()} miles` : \"\"}\n                  </div>\n                </button>\n              ))}\n            </div>\n          )}\n          {/* Show selected vehicle info */}\n          {formData._selectedVehicle && (\n            <div className=\"mt-2 text-sm text-success flex items-center gap-2\">\n              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n              </svg>\n              Selected: {formData._selectedVehicle.displayName}\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    // Standard field rendering\n    const options = field.options?.values || field.options?.choices || [];\n    const placeholder = field.placeholder || \"\";\n    const helpText = field.helpText || \"\";\n\n    switch (field.type) {\n      case \"SECTION_HEADER\":\n        return null; // Section headers are rendered differently\n\n      case \"PARAGRAPH\":\n        return (\n          <p className=\"text-base-content/70 whitespace-pre-wrap\">{field.label}</p>\n        );\n\n      case \"TEXT\":\n        return (\n          <div>\n            <input\n              type=\"text\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"TEXTAREA\":\n        return (\n          <div>\n            <textarea\n              className=\"textarea textarea-bordered w-full\"\n              rows={4}\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"NUMBER\":\n        return (\n          <div>\n            <input\n              type=\"number\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n              placeholder={placeholder}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"DATE\":\n        return (\n          <div>\n            <input\n              type=\"date\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"TIME\":\n        return (\n          <div>\n            <input\n              type=\"time\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"DATETIME\":\n        return (\n          <div>\n            <input\n              type=\"datetime-local\"\n              className=\"input input-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"DROPDOWN\":\n        return (\n          <div>\n            <select\n              className=\"select select-bordered w-full\"\n              value={value}\n              onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n              required={field.required}\n            >\n              <option value=\"\">Select...</option>\n              {options.map((opt) => (\n                <option key={opt} value={opt}>{opt}</option>\n              ))}\n            </select>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"RADIO\":\n        return (\n          <div>\n            <div className=\"flex flex-wrap gap-4\">\n              {options.map((opt) => (\n                <label key={opt} className=\"label cursor-pointer gap-2\">\n                  <input\n                    type=\"radio\"\n                    name={field.fieldName}\n                    className=\"radio radio-primary\"\n                    checked={value === opt}\n                    onChange={() => handleInputChange(field.fieldName, opt)}\n                    required={field.required && !value}\n                  />\n                  <span className=\"label-text\">{opt}</span>\n                </label>\n              ))}\n            </div>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"BOOLEAN\":\n        return (\n          <div className=\"form-control\">\n            <label className=\"label cursor-pointer justify-start gap-4\">\n              <input\n                type=\"checkbox\"\n                className=\"checkbox checkbox-primary\"\n                checked={value === true}\n                onChange={(e) => handleInputChange(field.fieldName, e.target.checked)}\n              />\n              <span className=\"label-text\">Yes</span>\n            </label>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"FILE\":\n        return (\n          <div>\n            <input\n              type=\"file\"\n              className=\"file-input file-input-bordered w-full\"\n              multiple\n              accept=\"image/*,.pdf\"\n              onChange={(e) => {\n                const files = Array.from(e.target.files);\n                handleInputChange(field.fieldName, files);\n              }}\n            />\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n            {!helpText && <p className=\"text-sm text-base-content/60 mt-1\">Accepts images and PDFs</p>}\n            {value && value.length > 0 && (\n              <div className=\"mt-2 flex flex-wrap gap-2\">\n                {value.map((file, idx) => (\n                  <span key={idx} className=\"badge badge-ghost\">{file.name}</span>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n\n      case \"RATING\":\n        return (\n          <div>\n            <div className=\"rating rating-lg\">\n              {[1, 2, 3, 4, 5].map((star) => (\n                <input\n                  key={star}\n                  type=\"radio\"\n                  name={`rating-${field.fieldName}`}\n                  className=\"mask mask-star-2 bg-orange-400\"\n                  checked={value === star}\n                  onChange={() => handleInputChange(field.fieldName, star)}\n                />\n              ))}\n            </div>\n            {helpText && <p className=\"text-sm text-base-content/60 mt-1\">{helpText}</p>}\n          </div>\n        );\n\n      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      case \"PDI_ISSUES\":\n        // PDI Issues - repeatable issue entry matching stock board Add Issue modal\n        const issues = formData.pdi_issues || [];\n        const addIssue = () => {\n          setFormData(prev => ({\n            ...prev,\n            pdi_issues: [...(prev.pdi_issues || []), {\n              category: \"\",\n              subcategory: \"\",\n              description: \"\",\n              actionNeeded: \"\",\n              status: \"outstanding\",\n              notes: \"\",\n            }]\n          }));\n        };\n        const updateIssue = (index, key, val) => {\n          setFormData(prev => {\n            const newIssues = [...(prev.pdi_issues || [])];\n            newIssues[index] = { ...newIssues[index], [key]: val };\n            return { ...prev, pdi_issues: newIssues };\n          });\n        };\n        const removeIssue = (index) => {\n          setFormData(prev => ({\n            ...prev,\n            pdi_issues: prev.pdi_issues.filter((_, i) => i !== index)\n          }));\n        };\n        // Same categories as stock board Add Issue modal\n        const ISSUE_SUBCATEGORIES = {\n          mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n          electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n          bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n          interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n          tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n          mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n          service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n          fault_codes: [\"Engine\", \"Transmission\", \"ABS\", \"Airbag\", \"Emissions\", \"Other\"],\n          other: [\"General\", \"Misc\"],\n        };\n\n        return (\n          <div className=\"space-y-4\">\n            {issues.map((issue, idx) => (\n              <div key={idx} className=\"bg-base-200 rounded-lg p-4 space-y-3\">\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"font-semibold text-sm\">Issue #{idx + 1}</span>\n                  <button\n                    type=\"button\"\n                    className=\"btn btn-ghost btn-xs text-error\"\n                    onClick={() => removeIssue(idx)}\n                  >\n                    Remove\n                  </button>\n                </div>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                  <div className=\"form-control\">\n                    <label className=\"label py-1\"><span className=\"label-text text-xs\">Category *</span></label>\n                    <select\n                      className=\"select select-bordered select-sm w-full\"\n                      value={issue.category}\n                      onChange={(e) => {\n                        updateIssue(idx, \"category\", e.target.value);\n                        updateIssue(idx, \"subcategory\", \"\");\n                      }}\n                      required\n                    >\n                      <option value=\"\">Select category...</option>\n                      <option value=\"mechanical\">Mechanical</option>\n                      <option value=\"electrical\">Electrical</option>\n                      <option value=\"bodywork\">Bodywork</option>\n                      <option value=\"interior\">Interior</option>\n                      <option value=\"tyres\">Tyres</option>\n                      <option value=\"mot\">MOT</option>\n                      <option value=\"service\">Service</option>\n                      <option value=\"fault_codes\">Fault Codes</option>\n                      <option value=\"other\">Other</option>\n                    </select>\n                  </div>\n                  {issue.category && (\n                    <div className=\"form-control\">\n                      <label className=\"label py-1\"><span className=\"label-text text-xs\">Subcategory</span></label>\n                      <select\n                        className=\"select select-bordered select-sm w-full\"\n                        value={issue.subcategory}\n                        onChange={(e) => updateIssue(idx, \"subcategory\", e.target.value)}\n                      >\n                        <option value=\"\">Select subcategory...</option>\n                        {(ISSUE_SUBCATEGORIES[issue.category] || []).map(sub => (\n                          <option key={sub} value={sub}>{sub}</option>\n                        ))}\n                      </select>\n                    </div>\n                  )}\n                </div>\n                <div className=\"form-control\">\n                  <label className=\"label py-1\"><span className=\"label-text text-xs\">Description *</span></label>\n                  <textarea\n                    className=\"textarea textarea-bordered textarea-sm w-full\"\n                    rows={3}\n                    placeholder=\"Describe the issue...\"\n                    value={issue.description}\n                    onChange={(e) => updateIssue(idx, \"description\", e.target.value)}\n                    required\n                  />\n                </div>\n                <div className=\"form-control\">\n                  <label className=\"label py-1\"><span className=\"label-text text-xs\">Action Needed</span></label>\n                  <input\n                    type=\"text\"\n                    className=\"input input-bordered input-sm w-full\"\n                    placeholder=\"What needs to be done?\"\n                    value={issue.actionNeeded || \"\"}\n                    onChange={(e) => updateIssue(idx, \"actionNeeded\", e.target.value)}\n                  />\n                </div>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                  <div className=\"form-control\">\n                    <label className=\"label py-1\"><span className=\"label-text text-xs\">Status</span></label>\n                    <select\n                      className=\"select select-bordered select-sm w-full\"\n                      value={issue.status || \"outstanding\"}\n                      onChange={(e) => updateIssue(idx, \"status\", e.target.value)}\n                    >\n                      <option value=\"outstanding\">Outstanding</option>\n                      <option value=\"ordered\">Ordered</option>\n                      <option value=\"in_progress\">In Progress</option>\n                      <option value=\"resolved\">Resolved</option>\n                    </select>\n                  </div>\n                </div>\n                <div className=\"form-control\">\n                  <label className=\"label py-1\"><span className=\"label-text text-xs\">Notes</span></label>\n                  <textarea\n                    className=\"textarea textarea-bordered textarea-sm w-full\"\n                    rows={2}\n                    placeholder=\"Additional notes...\"\n                    value={issue.notes || \"\"}\n                    onChange={(e) => updateIssue(idx, \"notes\", e.target.value)}\n                  />\n                </div>\n              </div>\n            ))}\n            <button\n              type=\"button\"\n              className=\"btn btn-outline btn-primary w-full\"\n              onClick={addIssue}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n              </svg>\n              Add Issue\n            </button>\n          </div>\n        );\n\n      default:\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n            placeholder={placeholder}\n          />\n        );\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <DashboardLayout>\n        <div className=\"flex justify-center py-20\">\n          <span className=\"loading loading-spinner loading-lg\"></span>\n        </div>\n      </DashboardLayout>\n    );\n  }\n\n  // Success state after submission\n  if (submittedId) {\n    return (\n      <DashboardLayout>\n        <Head>\n          <title>Form Submitted | DealerFlow</title>\n        </Head>\n\n        <div className=\"max-w-2xl mx-auto py-12\">\n          <div className=\"card bg-base-100 shadow-xl\">\n            <div className=\"card-body text-center\">\n              <div className=\"text-6xl mb-4\">✓</div>\n              <h2 className=\"card-title justify-center text-2xl mb-2\">Thank You!</h2>\n              <p className=\"text-base-content/70 mb-6\">\n                Your submission was successful.\n              </p>\n\n              <div className=\"flex flex-wrap justify-center gap-3\">\n                <button\n                  className=\"btn btn-primary\"\n                  onClick={handleSubmitAnother}\n                >\n                  Submit Another\n                </button>\n                <Link\n                  href={`/forms?tab=submissions`}\n                  className=\"btn btn-outline\"\n                >\n                  View in Inbox\n                </Link>\n                <Link\n                  href=\"/dashboard\"\n                  className=\"btn btn-ghost\"\n                >\n                  Back to Dashboard\n                </Link>\n              </div>\n            </div>\n          </div>\n        </div>\n      </DashboardLayout>\n    );\n  }\n\n  return (\n    <DashboardLayout>\n      <Head>\n        <title>{form?.name || \"Fill Form\"} | DealerFlow</title>\n      </Head>\n\n      {/* Header - Special layout for Service Receipt */}\n      {form?.type === \"SERVICE_RECEIPT\" ? (\n        <div className=\"mb-6\">\n          <div className=\"flex items-center gap-2 text-sm text-base-content/60 mb-2\">\n            <Link href=\"/forms\" className=\"hover:text-primary\">Forms</Link>\n            <span>/</span>\n            <span>Fill Out</span>\n          </div>\n          <div className=\"card bg-base-100 shadow-xl mb-6\">\n            <div className=\"card-body pb-4\">\n              {dealer?.logoUrl && (\n                <div className=\"flex justify-center mb-2\">\n                  <img src={dealer.logoUrl} alt={dealer.name} className=\"h-16 w-auto object-contain\" />\n                </div>\n              )}\n              <h1 className=\"text-2xl font-bold text-center uppercase\">Service Receipt</h1>\n              {(dealer?.companyAddress || dealer?.companyPhone) && (\n                <p className=\"text-base-content/60 text-center text-sm\">\n                  {[dealer?.companyAddress, dealer?.companyPhone].filter(Boolean).join(\" | \")}\n                </p>\n              )}\n            </div>\n          </div>\n        </div>\n      ) : (\n        <div className=\"mb-6\">\n          <div className=\"flex items-center gap-2 text-sm text-base-content/60 mb-2\">\n            <Link href=\"/forms\" className=\"hover:text-primary\">Forms</Link>\n            <span>/</span>\n            <span>Fill Out</span>\n          </div>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h1 className=\"text-3xl font-bold\">{form?.name}</h1>\n              {dealer?.companyAddress && (\n                <p className=\"text-base-content/60 mt-1 text-sm\">{dealer.companyAddress}</p>\n              )}\n              <div className=\"badge badge-outline mt-2\">\n                {FORM_TYPE_LABELS[form?.type] || form?.type}\n              </div>\n            </div>\n            <div className=\"flex items-center gap-4\">\n              {dealer?.logoUrl && (\n                <img src={dealer.logoUrl} alt={dealer.name} className=\"h-12 w-auto object-contain\" />\n              )}\n              <Link href=\"/forms\" className=\"btn btn-ghost\">\n                Cancel\n              </Link>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Form */}\n      <form onSubmit={handleSubmit} className=\"max-w-3xl\">\n        <div className=\"card bg-base-100 shadow-xl\">\n          <div className=\"card-body space-y-6\">\n            {(() => {\n              // Group fields by gridGroup for side-by-side rendering\n              // Filter out fields with visible: false\n              const visibleFields = fields.filter(f => f.visible !== false);\n              const renderedGroups = new Set();\n              return visibleFields.map((field, index) => {\n                // If this field is part of a gridGroup and we've already rendered it, skip\n                if (field.gridGroup && renderedGroups.has(field.gridGroup)) {\n                  return null;\n                }\n\n                // SECTION_HEADER renders as a divider\n                if (field.type === \"SECTION_HEADER\") {\n                  // Skip empty section headers\n                  if (!field.label) {\n                    return (\n                      <div key={field.id || field._id || index} className=\"border-t border-base-200 mt-4 pt-4\" />\n                    );\n                  }\n                  // Check if this is the Terms section - render terms text from template\n                  if (field.fieldName === \"_section_terms\" && form?.type) {\n                    const template = FORM_TEMPLATES.find(t => t.type === form.type);\n                    if (template?.termsText) {\n                      return (\n                        <div key={field.id || field._id || index} className={index > 0 ? \"pt-4 mt-4 border-t border-base-200\" : \"\"}>\n                          <h3 className={`text-lg font-bold text-primary mb-4 ${field.uppercase ? \"uppercase\" : \"\"}`}>{field.label}</h3>\n                          <div className=\"bg-base-200/50 rounded-lg p-4\">\n                            {formatTermsAsList(template.termsText)}\n                          </div>\n                        </div>\n                      );\n                    }\n                  }\n                  return (\n                    <div key={field.id || field._id || index} className={index > 0 ? \"pt-4 mt-4 border-t border-base-200\" : \"\"}>\n                      <h3 className={`text-lg font-bold text-primary ${field.uppercase ? \"uppercase\" : \"\"}`}>{field.label}</h3>\n                    </div>\n                  );\n                }\n\n                // PARAGRAPH renders as text with token replacement\n                if (field.type === \"PARAGRAPH\") {\n                  return (\n                    <div key={field.id || field._id || index} className=\"text-base-content/70 whitespace-pre-wrap text-sm leading-relaxed\">\n                      {replaceTokens(field.label)}\n                    </div>\n                  );\n                }\n\n                // Handle gridGroup - render multiple fields side by side\n                if (field.gridGroup) {\n                  renderedGroups.add(field.gridGroup);\n                  const groupFields = visibleFields.filter(f => f.gridGroup === field.gridGroup);\n\n                  return (\n                    <div key={field.gridGroup} className=\"grid grid-cols-2 gap-4\">\n                      {groupFields.map((gField) => (\n                        <div key={gField.id || gField._id || gField.fieldName} className=\"form-control\">\n                          <label className=\"label\">\n                            <span className={`label-text font-semibold ${gField.uppercase ? \"uppercase\" : \"\"}`}>\n                              {gField.label}\n                              {gField.required && <span className=\"text-error ml-1\">*</span>}\n                            </span>\n                          </label>\n                          {renderField(gField)}\n                        </div>\n                      ))}\n                    </div>\n                  );\n                }\n\n                // Normal form fields\n                return (\n                  <div key={field.id || field._id || index} className=\"form-control\">\n                    <label className=\"label\">\n                      <span className={`label-text font-semibold ${field.uppercase ? \"uppercase\" : \"\"}`}>\n                        {field.label}\n                        {field.required && <span className=\"text-error ml-1\">*</span>}\n                      </span>\n                    </label>\n                    {renderField(field)}\n                  </div>\n                );\n              });\n            })()}\n\n            {fields.filter(f => f.visible !== false).length === 0 && (\n              <div className=\"text-center py-8 text-base-content/60\">\n                This form has no visible fields configured yet.\n              </div>\n            )}\n\n            <div className=\"card-actions justify-end mt-8 pt-4 border-t border-base-200\">\n              <Link href=\"/forms\" className=\"btn btn-ghost\">\n                Cancel\n              </Link>\n              <button\n                type=\"submit\"\n                className=\"btn btn-primary btn-lg\"\n                disabled={isSubmitting || fields.length === 0}\n              >\n                {isSubmitting ? (\n                  <>\n                    <span className=\"loading loading-spinner\"></span>\n                    Submitting...\n                  </>\n                ) : (\n                  \"Submit Form\"\n                )}\n              </button>\n            </div>\n          </div>\n        </div>\n      </form>\n    </DashboardLayout>\n  );\n}\n","structuredPatch":[{"oldStart":885,"oldLines":6,"newStart":885,"newLines":170,"lines":["           </div>","         );"," ","+      case \"LICENCE_SCAN\":","+        // Licence scan with OCR extraction","+        const handleLicenceCapture = async (file) => {","+          if (!file) return;","+","+          setIsExtractingLicence(true);","+          setLicenceExtractionError(null);","+          setLicenceExtracted(false);","+","+          try {","+            // Convert file to base64","+            const reader = new FileReader();","+            reader.onload = async () => {","+              const base64 = reader.result.split(\",\")[1]; // Remove data URL prefix","+              const mimeType = file.type || \"image/jpeg\";","+","+              // Store the image in form data","+              handleInputChange(field.fieldName, [file]);","+","+              // Call extraction API","+              const res = await fetch(\"/api/forms/test-drive/extract-licence\", {","+                method: \"POST\",","+                headers: { \"Content-Type\": \"application/json\" },","+                body: JSON.stringify({ image: base64, mimeType }),","+              });","+","+              const data = await res.json();","+","+              if (data.ok && data.data) {","+                // Auto-fill form fields from extracted data","+                const extracted = data.data;","+                const updates = {};","+","+                // Map extracted fields to form field names using autoFillFromLicence config","+                fields.forEach((f) => {","+                  if (f.autoFillFromLicence && extracted[f.autoFillFromLicence]) {","+                    updates[f.fieldName] = extracted[f.autoFillFromLicence];","+                  }","+                });","+","+                // Apply all updates at once","+                if (Object.keys(updates).length > 0) {","+                  setFormData((prev) => ({ ...prev, ...updates }));","+                  setLicenceExtracted(true);","+                  toast.success(\"Details captured from licence - please verify\");","+                } else {","+                  setLicenceExtractionError(\"Could not extract details. Please enter manually.\");","+                }","+              } else {","+                setLicenceExtractionError(data.error || \"Could not extract details. Please enter manually.\");","+              }","+","+              setIsExtractingLicence(false);","+            };","+","+            reader.onerror = () => {","+              setLicenceExtractionError(\"Failed to read file. Please try again.\");","+              setIsExtractingLicence(false);","+            };","+","+            reader.readAsDataURL(file);","+          } catch (error) {","+            console.error(\"Licence extraction error:\", error);","+            setLicenceExtractionError(\"Failed to process licence. Please enter details manually.\");","+            setIsExtractingLicence(false);","+          }","+        };","+","+        const clearLicenceData = () => {","+          // Clear the licence photo and reset extraction state","+          handleInputChange(field.fieldName, null);","+          setLicenceExtracted(false);","+          setLicenceExtractionError(null);","+","+          // Clear auto-filled fields","+          const fieldsToClear = {};","+          fields.forEach((f) => {","+            if (f.autoFillFromLicence) {","+              fieldsToClear[f.fieldName] = \"\";","+            }","+          });","+          setFormData((prev) => ({ ...prev, ...fieldsToClear }));","+        };","+","+        return (","+          <div className=\"space-y-3\">","+            {/* Success banner */}","+            {licenceExtracted && (","+              <div className=\"alert alert-success shadow-sm\">","+                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">","+                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />","+                </svg>","+                <div>","+                  <h3 className=\"font-bold text-sm\">Details captured from licence</h3>","+                  <p className=\"text-xs\">Please verify the information below is correct</p>","+                </div>","+                <button type=\"button\" className=\"btn btn-ghost btn-xs\" onClick={clearLicenceData}>","+                  Clear","+                </button>","+              </div>","+            )}","+","+            {/* Error banner */}","+            {licenceExtractionError && (","+              <div className=\"alert alert-warning shadow-sm\">","+                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">","+                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />","+                </svg>","+                <span className=\"text-sm\">{licenceExtractionError}</span>","+              </div>","+            )}","+","+            {/* File input with camera option */}","+            <div className=\"flex flex-col sm:flex-row gap-2\">","+              <label className=\"flex-1 cursor-pointer\">","+                <div className={`border-2 border-dashed rounded-xl p-4 text-center transition-colors ${","+                  isExtractingLicence ? \"border-primary bg-primary/5\" :","+                  value && value.length > 0 ? \"border-success bg-success/5\" :","+                  \"border-base-300 hover:border-primary hover:bg-primary/5\"","+                }`}>","+                  {isExtractingLicence ? (","+                    <div className=\"flex flex-col items-center gap-2\">","+                      <span className=\"loading loading-spinner loading-md text-primary\"></span>","+                      <span className=\"text-sm text-primary\">Extracting details...</span>","+                    </div>","+                  ) : value && value.length > 0 ? (","+                    <div className=\"flex flex-col items-center gap-2\">","+                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-success\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">","+                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />","+                      </svg>","+                      <span className=\"text-sm text-success font-medium\">Photo captured</span>","+                      <span className=\"text-xs text-base-content/60\">{value[0]?.name || \"licence_photo.jpg\"}</span>","+                    </div>","+                  ) : (","+                    <div className=\"flex flex-col items-center gap-2\">","+                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-base-content/40\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">","+                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\" />","+                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 13a3 3 0 11-6 0 3 3 0 016 0z\" />","+                      </svg>","+                      <span className=\"text-sm font-medium\">Take photo or upload</span>","+                      <span className=\"text-xs text-base-content/60\">Tap to capture your driving licence</span>","+                    </div>","+                  )}","+                </div>","+                <input","+                  type=\"file\"","+                  accept=\"image/*\"","+                  capture=\"environment\"","+                  className=\"hidden\"","+                  onChange={(e) => {","+                    const file = e.target.files?.[0];","+                    if (file) {","+                      handleLicenceCapture(file);","+                    }","+                  }}","+                  disabled={isExtractingLicence}","+                />","+              </label>","+            </div>","+","+            {helpText && <p className=\"text-sm text-base-content/60\">{helpText}</p>}","+          </div>","+        );","+","       default:","         return (","           <input"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"477432d9-2c3a-4f31-8143-76b9a099b581","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KuTUehgToBTvKy328UFLjn","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"The LICENCE_SCAN field type is now implemented. Let me update the todo list to complete the final task. I should also verify that the public form filler page also supports this new field type. Let me check if there's a public form filler page:","signature":"EpwDCkYICxgCKkArqwhN80fby4l2a3nEDwTLDeqUifMjxCREhBgVifhEg1b39UCiEXGU5mqAsgiD4UV/e84ByyVHaKwfkd4ojY1SEgwWFIHWQMnd3Ced2VoaDIjlYoxAfImdrb6zGCIwuSqPhstneda4u6HGKcEkuVcm6l5LRboswxcOW98a6mPOxIkvtJ0RRslo9bggFdnyKoMCzOOzenR+SBoxs7Zbsc7ar5CTWYKYD5gXvUDgzjHHv89/9J3tC+FoKUuSfgEHBz1mdu0+j73GpyHuK6vHm1Cpu/kc8Qs8M87mMARuV/MlUvKFkT11VFDgdGnrRDBx/RiGDsgSysAuvku/74r3ylz5esvBTB/atNsvXu/MudnNUD6hklViWkr/XcFEXqdc0METWbWKjKVgwYNT4aXph4qQAX3j1CS2rsmVGvH6e1hvvMySt/NydyR48MzSMTA7UkbmxLPkZwqkymLRfSwAadB5XkFPWeTmboJdzMsum/34ab57LWyJkFFafBbq4L+FqXlCtxPhH2V4cAfooaAzKnhmkWpFChgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":5801,"cache_read_input_tokens":129212,"cache_creation":{"ephemeral_5m_input_tokens":5801,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9NLginGtmXRNc6anmt","type":"assistant","uuid":"6ae1e49d-3ebf-4b48-9b69-61c4be8e8061","timestamp":"2025-12-30T15:56:28.429Z"}
{"parentUuid":"6ae1e49d-3ebf-4b48-9b69-61c4be8e8061","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KuTUehgToBTvKy328UFLjn","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check if there's a public form page that also needs updating:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":5801,"cache_read_input_tokens":129212,"cache_creation":{"ephemeral_5m_input_tokens":5801,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9NLginGtmXRNc6anmt","type":"assistant","uuid":"fa515818-8c9a-4db3-a364-9988ccc0ab77","timestamp":"2025-12-30T15:56:29.037Z"}
{"parentUuid":"fa515818-8c9a-4db3-a364-9988ccc0ab77","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KuTUehgToBTvKy328UFLjn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01278eNRLVMssnpfEsbR9LTR","name":"Glob","input":{"pattern":"pages/public/forms/**/*.js"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":5801,"cache_read_input_tokens":129212,"cache_creation":{"ephemeral_5m_input_tokens":5801,"ephemeral_1h_input_tokens":0},"output_tokens":139,"service_tier":"standard"}},"requestId":"req_011CWd9NLginGtmXRNc6anmt","type":"assistant","uuid":"ca8b6529-78ec-4271-ae25-d86ea62f4f10","timestamp":"2025-12-30T15:56:29.621Z"}
{"parentUuid":"ca8b6529-78ec-4271-ae25-d86ea62f4f10","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01278eNRLVMssnpfEsbR9LTR","type":"tool_result","content":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\thank-you.js\nC:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js"}]},"uuid":"58f3e10d-a0ee-4c1b-9ed0-350353b5d75c","timestamp":"2025-12-30T15:56:31.157Z","toolUseResult":{"filenames":["C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\thank-you.js","C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js"],"durationMs":361,"numFiles":2,"truncated":false}}
{"parentUuid":"58f3e10d-a0ee-4c1b-9ed0-350353b5d75c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LaWqjeouJpjZaiNMVgL8DD","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Let me check the public form page to see if it needs the same LICENCE_SCAN implementation:","signature":"EoICCkYICxgCKkDkErakdBk8euJ3m8py8WazWBQScIr39rogSMePk3UU/UufH5/DDHXC6Jd/Vi8CaYUulRm2KMiBel3ysWVK0DObEgyVje8EByplBVh3YRwaDNaLIijT0w6umO/fiSIwyfM9273IqGdfpxewzWColEpGrrxSrP55+X9Dbi2KBshgvPDu1JJzSmLskAqY2pSxKmq9Pc7PxViDfTVU8xuzpHyWArVeT1aplMx0Iii/HrZdfoGje/fOCepWMSEH5jyOgJMsYHoZLaF+HMbpgzk/eTzcqorOn31daNqDfDgW7nAsWvYqKczzpla4fodZ7DYpOQeMkmNouAQvwv6WGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":81657,"cache_read_input_tokens":18223,"cache_creation":{"ephemeral_5m_input_tokens":81657,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWd9NxJqz32dTdXjEnNWp","type":"assistant","uuid":"e86c38f7-6ea2-4117-b264-bb56635df194","timestamp":"2025-12-30T15:56:39.341Z"}
{"parentUuid":"e86c38f7-6ea2-4117-b264-bb56635df194","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LaWqjeouJpjZaiNMVgL8DD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Wr8m2LmrAy5SJUUJkDowVN","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":81657,"cache_read_input_tokens":18223,"cache_creation":{"ephemeral_5m_input_tokens":81657,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWd9NxJqz32dTdXjEnNWp","type":"assistant","uuid":"0cf8773b-8e13-4d20-9acc-2514bcd254c1","timestamp":"2025-12-30T15:56:39.975Z"}
{"parentUuid":"0cf8773b-8e13-4d20-9acc-2514bcd254c1","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Wr8m2LmrAy5SJUUJkDowVN","type":"tool_result","content":"     1→import { useState, useEffect, useRef } from \"react\";\n     2→import Head from \"next/head\";\n     3→import { useRouter } from \"next/router\";\n     4→import dynamic from \"next/dynamic\";\n     5→import connectMongo from \"@/libs/mongoose\";\n     6→import Form from \"@/models/Form\";\n     7→import FormField from \"@/models/FormField\";\n     8→import Dealer from \"@/models/Dealer\";\n     9→import toast from \"react-hot-toast\";\n    10→\n    11→// Dynamic import for signature pad (client-side only)\n    12→const DrawableSignature = dynamic(() => import(\"@/components/DrawableSignature\"), {\n    13→  ssr: false,\n    14→  loading: () => <div className=\"h-[150px] bg-base-200 rounded-lg animate-pulse\" />\n    15→});\n    16→\n    17→export default function PublicForm({ form, fields, dealer }) {\n    18→  const router = useRouter();\n    19→  const [formData, setFormData] = useState({});\n    20→  const [isSubmitting, setIsSubmitting] = useState(false);\n    21→  const [isLookingUp, setIsLookingUp] = useState(false);\n    22→  const [uploadedFiles, setUploadedFiles] = useState([]); // Track uploaded files for submission\n    23→  const [uploadingField, setUploadingField] = useState(null); // Track which field is currently uploading\n    24→  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n    25→  const [stockVehicles, setStockVehicles] = useState([]);\n    26→  const [stockSearch, setStockSearch] = useState(\"\");\n    27→  const [showNoCourtesyVehicles, setShowNoCourtesyVehicles] = useState(false);\n    28→  const [selectedFromStock, setSelectedFromStock] = useState(false);\n    29→  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n    30→  // VRM suggestions for PDI/Delivery forms\n    31→  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n    32→  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n    33→\n    34→  // Load courtesy vehicles for courtesy car forms\n    35→  useEffect(() => {\n    36→    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {\n    37→      fetchCourtesyVehicles();\n    38→    }\n    39→    if (form?.type === \"TEST_DRIVE\") {\n    40→      fetchStockVehicles();\n    41→    }\n    42→  }, [form?.type]);\n    43→\n    44→  // Search vehicles for VRM suggestions (PDI/Delivery)\n    45→  const searchVrmVehicles = async (query) => {\n    46→    if (!query || query.length < 2) {\n    47→      setVrmSuggestions([]);\n    48→      return;\n    49→    }\n    50→    try {\n    51→      // Get statuses based on form type\n    52→      let statuses = [];\n    53→      if (form?.type === \"PDI\") {\n    54→        statuses = [\"IN_PREP\", \"ADVERTISED\"];\n    55→      } else if (form?.type === \"DELIVERY\") {\n    56→        statuses = [\"SOLD\", \"ADVERTISED\", \"RESERVED\"];\n    57→      }\n    58→      const params = new URLSearchParams({ q: query });\n    59→      if (statuses.length > 0) {\n    60→        params.append(\"statuses\", statuses.join(\",\"));\n    61→      }\n    62→      const res = await fetch(`/api/vehicles/search?${params.toString()}`);\n    63→      const data = await res.json();\n    64→      setVrmSuggestions(data);\n    65→    } catch (error) {\n    66→      console.error(\"VRM search error:\", error);\n    67→    }\n    68→  };\n    69→\n    70→  // Handle vehicle selection from VRM suggestions\n    71→  const handleVrmVehicleSelect = (vehicle) => {\n    72→    setFormData(prev => ({\n    73→      ...prev,\n    74→      vrm: vehicle.vrm || vehicle.regCurrent,\n    75→      make: vehicle.make,\n    76→      model: vehicle.model,\n    77→      colour: vehicle.colour,\n    78→      mileage: vehicle.mileage,\n    79→      _selectedVehicleId: vehicle.id,\n    80→    }));\n    81→    setVrmSuggestions([]);\n    82→    setVrmSearchActive(false);\n    83→    setSelectedFromStock(true);\n    84→    toast.success(`Selected: ${vehicle.make} ${vehicle.model} (${vehicle.vrm || vehicle.regCurrent})`);\n    85→  };\n    86→\n    87→  const fetchCourtesyVehicles = async () => {\n    88→    try {\n    89→      const res = await fetch(\"/api/vehicles/courtesy\");\n    90→      const data = await res.json();\n    91→      setCourtesyVehicles(data);\n    92→      if (data.length === 0) {\n    93→        setShowNoCourtesyVehicles(true);\n    94→      }\n    95→    } catch (error) {\n    96→      console.error(\"Failed to fetch courtesy vehicles:\", error);\n    97→    }\n    98→  };\n    99→\n   100→  const fetchStockVehicles = async (search = \"\") => {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"db1e19ba-9810-45e5-b355-58d8436d9d70","timestamp":"2025-12-30T15:56:41.498Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","content":"import { useState, useEffect, useRef } from \"react\";\nimport Head from \"next/head\";\nimport { useRouter } from \"next/router\";\nimport dynamic from \"next/dynamic\";\nimport connectMongo from \"@/libs/mongoose\";\nimport Form from \"@/models/Form\";\nimport FormField from \"@/models/FormField\";\nimport Dealer from \"@/models/Dealer\";\nimport toast from \"react-hot-toast\";\n\n// Dynamic import for signature pad (client-side only)\nconst DrawableSignature = dynamic(() => import(\"@/components/DrawableSignature\"), {\n  ssr: false,\n  loading: () => <div className=\"h-[150px] bg-base-200 rounded-lg animate-pulse\" />\n});\n\nexport default function PublicForm({ form, fields, dealer }) {\n  const router = useRouter();\n  const [formData, setFormData] = useState({});\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [uploadedFiles, setUploadedFiles] = useState([]); // Track uploaded files for submission\n  const [uploadingField, setUploadingField] = useState(null); // Track which field is currently uploading\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [stockVehicles, setStockVehicles] = useState([]);\n  const [stockSearch, setStockSearch] = useState(\"\");\n  const [showNoCourtesyVehicles, setShowNoCourtesyVehicles] = useState(false);\n  const [selectedFromStock, setSelectedFromStock] = useState(false);\n  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n  // VRM suggestions for PDI/Delivery forms\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n\n  // Load courtesy vehicles for courtesy car forms\n  useEffect(() => {\n    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {\n      fetchCourtesyVehicles();\n    }\n    if (form?.type === \"TEST_DRIVE\") {\n      fetchStockVehicles();\n    }\n  }, [form?.type]);\n\n  // Search vehicles for VRM suggestions (PDI/Delivery)\n  const searchVrmVehicles = async (query) => {\n    if (!query || query.length < 2) {\n      setVrmSuggestions([]);\n      return;\n    }\n    try {\n      // Get statuses based on form type\n      let statuses = [];\n      if (form?.type === \"PDI\") {\n        statuses = [\"IN_PREP\", \"ADVERTISED\"];\n      } else if (form?.type === \"DELIVERY\") {\n        statuses = [\"SOLD\", \"ADVERTISED\", \"RESERVED\"];\n      }\n      const params = new URLSearchParams({ q: query });\n      if (statuses.length > 0) {\n        params.append(\"statuses\", statuses.join(\",\"));\n      }\n      const res = await fetch(`/api/vehicles/search?${params.toString()}`);\n      const data = await res.json();\n      setVrmSuggestions(data);\n    } catch (error) {\n      console.error(\"VRM search error:\", error);\n    }\n  };\n\n  // Handle vehicle selection from VRM suggestions\n  const handleVrmVehicleSelect = (vehicle) => {\n    setFormData(prev => ({\n      ...prev,\n      vrm: vehicle.vrm || vehicle.regCurrent,\n      make: vehicle.make,\n      model: vehicle.model,\n      colour: vehicle.colour,\n      mileage: vehicle.mileage,\n      _selectedVehicleId: vehicle.id,\n    }));\n    setVrmSuggestions([]);\n    setVrmSearchActive(false);\n    setSelectedFromStock(true);\n    toast.success(`Selected: ${vehicle.make} ${vehicle.model} (${vehicle.vrm || vehicle.regCurrent})`);\n  };\n\n  const fetchCourtesyVehicles = async () => {\n    try {\n      const res = await fetch(\"/api/vehicles/courtesy\");\n      const data = await res.json();\n      setCourtesyVehicles(data);\n      if (data.length === 0) {\n        setShowNoCourtesyVehicles(true);\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch courtesy vehicles:\", error);\n    }\n  };\n\n  const fetchStockVehicles = async (search = \"\") => {","numLines":100,"startLine":1,"totalLines":1161}}}
{"parentUuid":"db1e19ba-9810-45e5-b355-58d8436d9d70","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Hs73QHnStq7Vvcvbws33ic","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to also add the LICENCE_SCAN functionality to the public form page. Let me search for where the field types are rendered in this file:","signature":"ErYCCkYICxgCKkCgD+3Z7kkfoJTLpB/sT1augX6mC/u3YKXfhs0EBNcVpRklcBZakbYjdnrb98PrRIMSdGNK+AxhxLYntj6QkKgxEgwXZBWrIb2LNI6xo/waDCIgSQKB1xnIqQRECSIwbZUCwJlQyOR5I7whdFpluTMK090xLqjlOarseOgx0o0cpfPUP4XNsc12bEBnnS7TKp0BIY3HF2Kc23lhYTJhpjeI7x8I6RsyQpeJwTOaYPMGPCJQRxV7uKzCDE4QMOJtkuOg5xxXyIF2SCV+0gQvhOR79OSqB2xEOu/H84Ecgm4yCQg4HKPs4slwlu4qQKKH0rYw7fAAMxl+OhWdznl8rna3XTQg32oLqawGW5FErvgxgntCS6S9o17YILQBobBE+ocKWd7xPXXMx+DDBXb42hgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1679,"cache_read_input_tokens":99880,"cache_creation":{"ephemeral_5m_input_tokens":1679,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWd9PiNyCuiYKtSbDyzAp","type":"assistant","uuid":"63b39e4c-9645-4232-a0ab-fca543174c8b","timestamp":"2025-12-30T15:56:48.486Z"}
{"parentUuid":"63b39e4c-9645-4232-a0ab-fca543174c8b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Hs73QHnStq7Vvcvbws33ic","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CfW9YWiXMnjshRZm5dqg1U","name":"Grep","input":{"pattern":"case \"FILE\":|case \"SIGNATURE\":|switch","path":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","output_mode":"content","-n":true}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1679,"cache_read_input_tokens":99880,"cache_creation":{"ephemeral_5m_input_tokens":1679,"ephemeral_1h_input_tokens":0},"output_tokens":176,"service_tier":"standard"}},"requestId":"req_011CWd9PiNyCuiYKtSbDyzAp","type":"assistant","uuid":"d8f3e82c-87ef-4162-af03-9cca2f2000ee","timestamp":"2025-12-30T15:56:49.873Z"}
{"parentUuid":"d8f3e82c-87ef-4162-af03-9cca2f2000ee","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CfW9YWiXMnjshRZm5dqg1U","type":"tool_result","content":"650:    switch (field.type) {\r\n785:      case \"FILE\":\r\n829:      case \"SIGNATURE\":"}]},"uuid":"d202d93e-aaad-4093-b8b3-9b0ee2e3f2da","timestamp":"2025-12-30T15:56:51.275Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"650:    switch (field.type) {\r\n785:      case \"FILE\":\r\n829:      case \"SIGNATURE\":","numLines":3}}
{"parentUuid":"d202d93e-aaad-4093-b8b3-9b0ee2e3f2da","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_017jpWBFXoP669nZtAYq8aAo","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to add the LICENCE_SCAN state variables and the case statement to the public form page as well. Let me read around line 785 to see the FILE case and where to add the LICENCE_SCAN case:","signature":"EugCCkYICxgCKkA0fb02z8Sm3NwVqlqTVeLxJHmzYW9Wk1kDOd/rtR6uxfUJL8Sfl/Qch//WUXZgejZp+J1chNhyf4yItIT24tqAEgyOV/iJRbvh+G/GFJwaDNocFnhn04eYs4gRGSIwipt6i6sjJRbsdoaMdBmCF/N9FI4aXSH+V8ipRDnIeNmWO1caOgiACQs6YIWMbOeeKs8BpXH4JikuFT+8CwSrBOAwl3cOPRwDshESGbcElspwJaQcMBpJNej+Tk+FEBEQxoFMUfFrd/lay1QN3KuNsqK7meQ9YwG/p/EuZ7BeBJnk1IBUt8bbRN+W7siXmjXo7HX4wwHKVHfWHX/tZvO3dT4yBbq3ubuKwvFwHriR23puIqxmeapmPUl2BXJcgjZAUDcise58W7bCQ8JT8t8cvWOPbAcrfO260+302VDF3C3tkuuVeU7DuZYaGw5W0nJKeWQ2loZXsf5Re/Rm5hAnLd7TGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":222,"cache_read_input_tokens":101559,"cache_creation":{"ephemeral_5m_input_tokens":222,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9QQqos217wMbNbqNuG","type":"assistant","uuid":"88604a10-570c-4f26-99d9-73eebdc7befa","timestamp":"2025-12-30T15:56:58.541Z"}
{"parentUuid":"88604a10-570c-4f26-99d9-73eebdc7befa","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_017jpWBFXoP669nZtAYq8aAo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Cc81iwtMbktL7omcxL5EvY","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","offset":17,"limit":20}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":222,"cache_read_input_tokens":101559,"cache_creation":{"ephemeral_5m_input_tokens":222,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9QQqos217wMbNbqNuG","type":"assistant","uuid":"524e1ada-7b5c-45d4-bb36-ce63c1d8abf6","timestamp":"2025-12-30T15:56:59.085Z"}
{"parentUuid":"524e1ada-7b5c-45d4-bb36-ce63c1d8abf6","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Cc81iwtMbktL7omcxL5EvY","type":"tool_result","content":"    17→export default function PublicForm({ form, fields, dealer }) {\n    18→  const router = useRouter();\n    19→  const [formData, setFormData] = useState({});\n    20→  const [isSubmitting, setIsSubmitting] = useState(false);\n    21→  const [isLookingUp, setIsLookingUp] = useState(false);\n    22→  const [uploadedFiles, setUploadedFiles] = useState([]); // Track uploaded files for submission\n    23→  const [uploadingField, setUploadingField] = useState(null); // Track which field is currently uploading\n    24→  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n    25→  const [stockVehicles, setStockVehicles] = useState([]);\n    26→  const [stockSearch, setStockSearch] = useState(\"\");\n    27→  const [showNoCourtesyVehicles, setShowNoCourtesyVehicles] = useState(false);\n    28→  const [selectedFromStock, setSelectedFromStock] = useState(false);\n    29→  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n    30→  // VRM suggestions for PDI/Delivery forms\n    31→  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n    32→  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n    33→\n    34→  // Load courtesy vehicles for courtesy car forms\n    35→  useEffect(() => {\n    36→    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e41d8f2f-2614-4853-9409-1e1513019d31","timestamp":"2025-12-30T15:57:00.638Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","content":"export default function PublicForm({ form, fields, dealer }) {\n  const router = useRouter();\n  const [formData, setFormData] = useState({});\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [uploadedFiles, setUploadedFiles] = useState([]); // Track uploaded files for submission\n  const [uploadingField, setUploadingField] = useState(null); // Track which field is currently uploading\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [stockVehicles, setStockVehicles] = useState([]);\n  const [stockSearch, setStockSearch] = useState(\"\");\n  const [showNoCourtesyVehicles, setShowNoCourtesyVehicles] = useState(false);\n  const [selectedFromStock, setSelectedFromStock] = useState(false);\n  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n  // VRM suggestions for PDI/Delivery forms\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n\n  // Load courtesy vehicles for courtesy car forms\n  useEffect(() => {\n    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {","numLines":20,"startLine":17,"totalLines":1161}}}
{"parentUuid":"e41d8f2f-2614-4853-9409-1e1513019d31","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01A63pyG53EVbXMDpQm1TPeZ","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the licence extraction state variables and the case statement to the public form page. Let me add the state variables first:","signature":"ErcCCkYICxgCKkD2qGn3zatoqEvdxM7ICm/uKxRXCs7eMCkTZHkrc4uKl1gOD0TzStteIGFGTHrjinh+AhSkRezrnpLriQtrHlvZEgzOMjy8uixxjf9PTNkaDAQc/2OkV2haV19SbyIwW2u2vQzxM/4DkIEg5u7plJIs7FXD6VIroY57XcYF7YtJ/lyNWPRjN2+JYFQ/OocDKp4BSLEW7ZDzBUmzonzduums+x9imXKxogWemRKmbucxIUY7OgsRHPNN8r9W1v6Bc+kByeEtaUtaJfQMPiZX5XNGZTohRcpU3eNQDdbw94r7Ct4cpzPoFJ28P3Bjkmh6TKfNzv7V7E1hig+MHbKfT8aAEfuEamEDpLbSWxIeH/Xew/VqRA/uzR6CELdwBu7ZIbAmhEduZ/6UXZmpmgpVOJUYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":862,"cache_read_input_tokens":101781,"cache_creation":{"ephemeral_5m_input_tokens":862,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWd9R8JB2Z9NPLciQHKCA","type":"assistant","uuid":"bd1bf9d4-b7a1-40c0-b984-a9c2f9b4319a","timestamp":"2025-12-30T15:57:08.210Z"}
{"parentUuid":"bd1bf9d4-b7a1-40c0-b984-a9c2f9b4319a","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01A63pyG53EVbXMDpQm1TPeZ","type":"message","role":"assistant","content":[{"type":"text","text":"Let me add the licence extraction state variables and case to the public form page:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":862,"cache_read_input_tokens":101781,"cache_creation":{"ephemeral_5m_input_tokens":862,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWd9R8JB2Z9NPLciQHKCA","type":"assistant","uuid":"66db6954-6cf2-4cf5-be13-36d6efb136e9","timestamp":"2025-12-30T15:57:08.781Z"}
{"parentUuid":"66db6954-6cf2-4cf5-be13-36d6efb136e9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01A63pyG53EVbXMDpQm1TPeZ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CDno9xk5797vPAAL3Nuzss","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","old_string":"  const [selectedFromStock, setSelectedFromStock] = useState(false);\n  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n  // VRM suggestions for PDI/Delivery forms\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);","new_string":"  const [selectedFromStock, setSelectedFromStock] = useState(false);\n  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n  // VRM suggestions for PDI/Delivery forms\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  // Licence extraction state\n  const [isExtractingLicence, setIsExtractingLicence] = useState(false);\n  const [licenceExtracted, setLicenceExtracted] = useState(false);\n  const [licenceExtractionError, setLicenceExtractionError] = useState(null);"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":862,"cache_read_input_tokens":101781,"cache_creation":{"ephemeral_5m_input_tokens":862,"ephemeral_1h_input_tokens":0},"output_tokens":430,"service_tier":"standard"}},"requestId":"req_011CWd9R8JB2Z9NPLciQHKCA","type":"assistant","uuid":"b83ccf9a-69e5-4f0b-b1fd-e7eab36310ec","timestamp":"2025-12-30T15:57:11.436Z"}
{"type":"file-history-snapshot","messageId":"b83ccf9a-69e5-4f0b-b1fd-e7eab36310ec","snapshot":{"messageId":"e7b8b7f9-0997-49f5-ab65-1f4c39aaeb9a","trackedFileBackups":{"components\\DashboardLayout.js":{"backupFileName":"7077fab175200d91@v1","version":1,"backupTime":"2025-12-30T15:48:23.403Z"},"pages\\sales-prep.js":{"backupFileName":"5f4a0d2cbf004e71@v1","version":1,"backupTime":"2025-12-30T15:48:52.385Z"},"pages\\api\\ai\\health.js":{"backupFileName":"c3255e459a553bc5@v1","version":1,"backupTime":"2025-12-30T15:49:48.768Z"},"libs\\openai.js":{"backupFileName":"a8e7fe417f7ecf06@v1","version":1,"backupTime":"2025-12-30T15:50:12.398Z"},"components\\AISuggestionsPanel.js":{"backupFileName":"9b357355b418cc6f@v1","version":1,"backupTime":"2025-12-30T15:50:35.851Z"},"pages\\warranty.js":{"backupFileName":"a81b4f663f49afea@v1","version":1,"backupTime":"2025-12-30T15:51:31.630Z"},"pages\\api\\ai\\warranty-suggestions.js":{"backupFileName":"5b8ac4e37dc9954c@v1","version":1,"backupTime":"2025-12-30T15:52:02.934Z"},"pages\\api\\ai\\appraisal-issue-suggestions.js":{"backupFileName":"264b13f531a23f96@v1","version":1,"backupTime":"2025-12-30T15:52:13.361Z"},"pages\\api\\forms\\test-drive\\extract-licence.js":{"backupFileName":null,"version":1,"backupTime":"2025-12-30T15:53:38.201Z"},"libs\\formTemplates.js":{"backupFileName":"81e216fa5809acd6@v1","version":1,"backupTime":"2025-12-30T15:54:28.383Z"},"pages\\forms\\fill\\[id].js":{"backupFileName":"ddbb29a45524535a@v1","version":1,"backupTime":"2025-12-30T15:55:36.562Z"},"pages\\public\\forms\\[slug].js":{"backupFileName":"491dc2f13ef634bc@v1","version":1,"backupTime":"2025-12-30T15:57:12.832Z"}},"timestamp":"2025-12-30T15:41:12.729Z"},"isSnapshotUpdate":true}
{"parentUuid":"b83ccf9a-69e5-4f0b-b1fd-e7eab36310ec","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CDno9xk5797vPAAL3Nuzss","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n    24→  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n    25→  const [stockVehicles, setStockVehicles] = useState([]);\n    26→  const [stockSearch, setStockSearch] = useState(\"\");\n    27→  const [showNoCourtesyVehicles, setShowNoCourtesyVehicles] = useState(false);\n    28→  const [selectedFromStock, setSelectedFromStock] = useState(false);\n    29→  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n    30→  // VRM suggestions for PDI/Delivery forms\n    31→  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n    32→  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n    33→  // Licence extraction state\n    34→  const [isExtractingLicence, setIsExtractingLicence] = useState(false);\n    35→  const [licenceExtracted, setLicenceExtracted] = useState(false);\n    36→  const [licenceExtractionError, setLicenceExtractionError] = useState(null);\n    37→\n    38→  // Load courtesy vehicles for courtesy car forms\n    39→  useEffect(() => {\n    40→    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {"}]},"uuid":"0d0adfc3-bf48-4826-a902-54476a79fb12","timestamp":"2025-12-30T15:57:12.822Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","oldString":"  const [selectedFromStock, setSelectedFromStock] = useState(false);\n  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n  // VRM suggestions for PDI/Delivery forms\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);","newString":"  const [selectedFromStock, setSelectedFromStock] = useState(false);\n  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n  // VRM suggestions for PDI/Delivery forms\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  // Licence extraction state\n  const [isExtractingLicence, setIsExtractingLicence] = useState(false);\n  const [licenceExtracted, setLicenceExtracted] = useState(false);\n  const [licenceExtractionError, setLicenceExtractionError] = useState(null);","originalFile":"import { useState, useEffect, useRef } from \"react\";\nimport Head from \"next/head\";\nimport { useRouter } from \"next/router\";\nimport dynamic from \"next/dynamic\";\nimport connectMongo from \"@/libs/mongoose\";\nimport Form from \"@/models/Form\";\nimport FormField from \"@/models/FormField\";\nimport Dealer from \"@/models/Dealer\";\nimport toast from \"react-hot-toast\";\n\n// Dynamic import for signature pad (client-side only)\nconst DrawableSignature = dynamic(() => import(\"@/components/DrawableSignature\"), {\n  ssr: false,\n  loading: () => <div className=\"h-[150px] bg-base-200 rounded-lg animate-pulse\" />\n});\n\nexport default function PublicForm({ form, fields, dealer }) {\n  const router = useRouter();\n  const [formData, setFormData] = useState({});\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [uploadedFiles, setUploadedFiles] = useState([]); // Track uploaded files for submission\n  const [uploadingField, setUploadingField] = useState(null); // Track which field is currently uploading\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [stockVehicles, setStockVehicles] = useState([]);\n  const [stockSearch, setStockSearch] = useState(\"\");\n  const [showNoCourtesyVehicles, setShowNoCourtesyVehicles] = useState(false);\n  const [selectedFromStock, setSelectedFromStock] = useState(false);\n  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n  // VRM suggestions for PDI/Delivery forms\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n\n  // Load courtesy vehicles for courtesy car forms\n  useEffect(() => {\n    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {\n      fetchCourtesyVehicles();\n    }\n    if (form?.type === \"TEST_DRIVE\") {\n      fetchStockVehicles();\n    }\n  }, [form?.type]);\n\n  // Search vehicles for VRM suggestions (PDI/Delivery)\n  const searchVrmVehicles = async (query) => {\n    if (!query || query.length < 2) {\n      setVrmSuggestions([]);\n      return;\n    }\n    try {\n      // Get statuses based on form type\n      let statuses = [];\n      if (form?.type === \"PDI\") {\n        statuses = [\"IN_PREP\", \"ADVERTISED\"];\n      } else if (form?.type === \"DELIVERY\") {\n        statuses = [\"SOLD\", \"ADVERTISED\", \"RESERVED\"];\n      }\n      const params = new URLSearchParams({ q: query });\n      if (statuses.length > 0) {\n        params.append(\"statuses\", statuses.join(\",\"));\n      }\n      const res = await fetch(`/api/vehicles/search?${params.toString()}`);\n      const data = await res.json();\n      setVrmSuggestions(data);\n    } catch (error) {\n      console.error(\"VRM search error:\", error);\n    }\n  };\n\n  // Handle vehicle selection from VRM suggestions\n  const handleVrmVehicleSelect = (vehicle) => {\n    setFormData(prev => ({\n      ...prev,\n      vrm: vehicle.vrm || vehicle.regCurrent,\n      make: vehicle.make,\n      model: vehicle.model,\n      colour: vehicle.colour,\n      mileage: vehicle.mileage,\n      _selectedVehicleId: vehicle.id,\n    }));\n    setVrmSuggestions([]);\n    setVrmSearchActive(false);\n    setSelectedFromStock(true);\n    toast.success(`Selected: ${vehicle.make} ${vehicle.model} (${vehicle.vrm || vehicle.regCurrent})`);\n  };\n\n  const fetchCourtesyVehicles = async () => {\n    try {\n      const res = await fetch(\"/api/vehicles/courtesy\");\n      const data = await res.json();\n      setCourtesyVehicles(data);\n      if (data.length === 0) {\n        setShowNoCourtesyVehicles(true);\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch courtesy vehicles:\", error);\n    }\n  };\n\n  const fetchStockVehicles = async (search = \"\") => {\n    try {\n      const res = await fetch(`/api/vehicles/stock?search=${encodeURIComponent(search)}`);\n      const data = await res.json();\n      setStockVehicles(data);\n    } catch (error) {\n      console.error(\"Failed to fetch stock vehicles:\", error);\n    }\n  };\n\n  // Initialize default values for time fields (Test Drive form)\n  useEffect(() => {\n    if (form?.type === \"TEST_DRIVE\" && fields.length > 0) {\n      const now = new Date();\n      const timeField = fields.find(f => f.fieldName === \"time\" && f.type === \"TIME\");\n      const dateField = fields.find(f => f.fieldName === \"date\" && f.type === \"DATE\");\n\n      const updates = {};\n\n      // Set default time to current time (rounded to nearest 15 min)\n      if (timeField && !formData.time) {\n        const minutes = Math.round(now.getMinutes() / 15) * 15;\n        const hours = now.getHours() + (minutes >= 60 ? 1 : 0);\n        const adjustedMinutes = minutes >= 60 ? 0 : minutes;\n        updates.time = `${String(hours).padStart(2, \"0\")}:${String(adjustedMinutes).padStart(2, \"0\")}`;\n      }\n\n      // Set default date to today\n      if (dateField && !formData.date) {\n        updates.date = now.toISOString().split(\"T\")[0];\n      }\n\n      if (Object.keys(updates).length > 0) {\n        setFormData(prev => ({ ...prev, ...updates }));\n      }\n    }\n  }, [form?.type, fields]);\n\n  // Replace tokens in text with dealer info\n  const replaceTokens = (text) => {\n    if (!text || !dealer) return text;\n    return text\n      .replace(/\\{companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\")\n      .replace(/\\{dealer\\.companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{dealer\\.companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{dealer\\.companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{dealer\\.companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\");\n  };\n\n  // Format terms text as bullet list\n  const formatTermsAsList = (text) => {\n    if (!text) return null;\n    const processedText = replaceTokens(text);\n\n    // Split by bullet points, dashes, or numbered items\n    const lines = processedText\n      .split(/(?:^|\\n)(?:•|●|-|\\d+\\.)\\s*/g)\n      .map(line => line.trim())\n      .filter(line => line.length > 0);\n\n    if (lines.length <= 1) {\n      // If no bullet format detected, try splitting by newlines\n      const newlineLines = processedText.split(\"\\n\").filter(line => line.trim());\n      if (newlineLines.length > 1) {\n        return (\n          <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n            {newlineLines.map((line, idx) => (\n              <li key={idx}>{line.trim().replace(/^[-•●]\\s*/, \"\")}</li>\n            ))}\n          </ul>\n        );\n      }\n      return <p className=\"text-sm text-base-content/80 whitespace-pre-wrap\">{processedText}</p>;\n    }\n\n    return (\n      <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n        {lines.map((line, idx) => (\n          <li key={idx}>{line}</li>\n        ))}\n      </ul>\n    );\n  };\n\n  if (!form) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-base-200\">\n        <div className=\"text-center\">\n          <h1 className=\"text-4xl font-bold mb-4\">Form Not Found</h1>\n          <p className=\"text-base-content/60\">This form does not exist or is not publicly available.</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Show no courtesy vehicles message\n  if (showNoCourtesyVehicles && (form.type === \"COURTESY_OUT\" || form.type === \"COURTESY_IN\")) {\n    return (\n      <>\n        <Head><title>{form.name} | DealerFlow</title></Head>\n        <div className=\"min-h-screen bg-base-200 flex items-center justify-center p-4\">\n          <div className=\"card bg-base-100 shadow-xl max-w-md\">\n            <div className=\"card-body text-center\">\n              <h2 className=\"card-title justify-center text-xl mb-2\">No Courtesy Vehicles Set Up</h2>\n              <p className=\"text-base-content/70 mb-4\">\n                You need at least one vehicle marked as a courtesy car to use this form.\n              </p>\n              <p className=\"text-sm text-base-content/60\">\n                Go to Sales & Prep and add a vehicle with type \"Courtesy\" to get started.\n              </p>\n            </div>\n          </div>\n        </div>\n      </>\n    );\n  }\n\n  const handleInputChange = (fieldName, value) => {\n    setFormData((prev) => ({\n      ...prev,\n      [fieldName]: value,\n    }));\n  };\n\n  const handleVrmLookup = async (fieldName) => {\n    const vrm = formData[fieldName];\n    if (!vrm) {\n      toast.error(\"Enter a registration number first\");\n      return;\n    }\n\n    setIsLookingUp(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: vrm }),\n      });\n      const data = await res.json();\n\n      if (res.ok && data.make) {\n        // Auto-fill related fields if they exist in the form\n        const updates = {};\n        if (data.make) updates.make = data.make;\n        if (data.model) updates.model = data.model;\n        if (data.year) updates.year = data.year;\n        if (data.colour) updates.colour = data.colour;\n        if (data.fuelType) updates.fuel_type = data.fuelType;\n\n        setFormData(prev => ({ ...prev, ...updates }));\n        toast.success(`Found: ${data.year || \"\"} ${data.make} ${data.model} - ${data.colour || \"\"}`);\n      } else {\n        toast.error(\"Vehicle not found or lookup failed\");\n      }\n    } catch (error) {\n      console.error(\"DVLA lookup error:\", error);\n      toast.error(\"Failed to lookup vehicle\");\n    } finally {\n      setIsLookingUp(false);\n    }\n  };\n\n  const handleCourtesyVehicleSelect = (vehicleId) => {\n    const vehicle = courtesyVehicles.find(v => v.id === vehicleId);\n    if (vehicle) {\n      setFormData(prev => ({\n        ...prev,\n        courtesy_vrm: vehicle.regCurrent,\n        courtesy_vehicle_id: vehicle.id,\n        courtesy_vehicle_display: `${vehicle.regCurrent} - ${vehicle.make} ${vehicle.model}`,\n      }));\n    }\n  };\n\n  const handleStockVehicleSelect = (vehicleId) => {\n    const vehicle = stockVehicles.find(v => v.id === vehicleId);\n    if (vehicle) {\n      setFormData(prev => ({\n        ...prev,\n        vrm: vehicle.regCurrent,\n        vehicle_make: vehicle.make,\n        vehicle_model: vehicle.model,\n        vehicle_interest: vehicle.displayName,\n        vehicle_id: vehicle.id,\n      }));\n      setSelectedFromStock(true);\n    }\n  };\n\n  // Check if a field should be hidden when vehicle is selected from stock\n  const shouldHideField = (field) => {\n    // Show make/model fields only if manual entry is enabled or no stock selection\n    if (manualVrmEntry) return false; // Show all fields for manual entry\n    if (!selectedFromStock) return false;\n    // Hide make/model fields when vehicle selected from stock (for TEST_DRIVE, PDI, DELIVERY)\n    const hideFields = [\"vehicle_make\", \"vehicle_model\", \"make\", \"model\"];\n    return hideFields.includes(field.fieldName);\n  };\n\n  // Upload file to server and return URL\n  const handleFileUpload = async (file, fieldName) => {\n    setUploadingField(fieldName);\n    try {\n      const formDataUpload = new FormData();\n      formDataUpload.append(\"file\", file);\n\n      const res = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: formDataUpload,\n      });\n\n      if (!res.ok) {\n        const err = await res.json();\n        throw new Error(err.error || \"Upload failed\");\n      }\n\n      const data = await res.json();\n\n      // Store S3 key (permanent) if available, otherwise use URL (for local dev)\n      const storedUrl = data.key || data.url;\n\n      // Store file metadata for submission\n      setUploadedFiles((prev) => [\n        ...prev.filter((f) => f.fieldName !== fieldName), // Replace if same field\n        {\n          fieldName,\n          url: storedUrl,\n          key: data.key, // S3 key for signed URL regeneration\n          filename: data.filename || file.name,\n          mimeType: data.type || file.type,\n          size: data.size || file.size,\n        },\n      ]);\n\n      // Also store URL/key in formData for database storage\n      handleInputChange(fieldName, storedUrl);\n      toast.success(\"File uploaded\");\n      return storedUrl;\n    } catch (error) {\n      console.error(\"Upload error:\", error);\n      toast.error(error.message || \"Failed to upload file\");\n      return null;\n    } finally {\n      setUploadingField(null);\n    }\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsSubmitting(true);\n\n    try {\n      const res = await fetch(\"/api/forms/submissions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          formId: form._id,\n          rawAnswers: formData,\n          files: uploadedFiles, // Include uploaded files\n        }),\n      });\n\n      if (!res.ok) throw new Error(\"Submission failed\");\n\n      toast.success(\"Form submitted successfully!\");\n      setFormData({});\n      setUploadedFiles([]);\n\n      setTimeout(() => {\n        router.push(\"/public/forms/thank-you\");\n      }, 1500);\n    } catch (error) {\n      console.error(\"Submission error:\", error);\n      toast.error(\"Failed to submit form. Please try again.\");\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  // Check if field is a VRM/registration field\n  const isVrmField = (field) => {\n    const vrmFieldNames = [\"vrm\", \"reg\", \"registration\", \"vehicle_reg\", \"regcurrent\", \"courtesy_vrm\"];\n    return vrmFieldNames.includes(field.fieldName.toLowerCase()) ||\n           field.label.toLowerCase().includes(\"registration\") ||\n           field.label.toLowerCase().includes(\"vrm\");\n  };\n\n  // Check if field is a courtesy vehicle selection field\n  const isCourtesyVehicleField = (field) => {\n    return (form.type === \"COURTESY_OUT\" || form.type === \"COURTESY_IN\") &&\n           (field.fieldName === \"courtesy_vrm\" || field.label.toLowerCase().includes(\"courtesy vehicle\"));\n  };\n\n  // Check if field is a stock vehicle selection field (for test drive)\n  const isStockVehicleField = (field) => {\n    return form.type === \"TEST_DRIVE\" &&\n           (field.fieldName === \"vrm\" || field.fieldName === \"vehicle_interest\" ||\n            field.label.toLowerCase().includes(\"vehicle of interest\"));\n  };\n\n  const renderField = (field) => {\n    const value = formData[field.fieldName] || \"\";\n\n    // Special handling for courtesy vehicle selection\n    if (isCourtesyVehicleField(field)) {\n      return (\n        <div className=\"space-y-2\">\n          <select\n            className=\"select select-bordered w-full\"\n            value={formData.courtesy_vehicle_id || \"\"}\n            onChange={(e) => handleCourtesyVehicleSelect(e.target.value)}\n            required={field.required}\n          >\n            <option value=\"\">Select courtesy vehicle...</option>\n            {courtesyVehicles.map((v) => (\n              <option key={v.id} value={v.id}>\n                {v.regCurrent} - {v.make} {v.model} {v.colour ? `(${v.colour})` : \"\"}\n              </option>\n            ))}\n          </select>\n          {formData.courtesy_vehicle_display && (\n            <div className=\"text-sm text-success\">Selected: {formData.courtesy_vehicle_display}</div>\n          )}\n        </div>\n      );\n    }\n\n    // Special handling for stock vehicle selection (test drive)\n    if (isStockVehicleField(field)) {\n      // If vehicle already selected from stock, show summary\n      if (selectedFromStock && formData.vehicle_interest) {\n        return (\n          <div className=\"space-y-2\">\n            <div className=\"bg-success/10 border border-success/30 rounded-lg p-4\">\n              <div className=\"flex items-center gap-2 text-success mb-2\">\n                <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                </svg>\n                <span className=\"font-semibold\">Vehicle Selected</span>\n              </div>\n              <p className=\"text-base-content font-medium\">{formData.vehicle_interest}</p>\n              {formData.vrm && (\n                <p className=\"text-sm text-base-content/70 font-mono\">{formData.vrm}</p>\n              )}\n              <button\n                type=\"button\"\n                className=\"btn btn-sm btn-ghost text-primary mt-2\"\n                onClick={() => {\n                  setSelectedFromStock(false);\n                  setManualVrmEntry(false);\n                  setFormData(prev => ({\n                    ...prev,\n                    vrm: \"\",\n                    vehicle_make: \"\",\n                    vehicle_model: \"\",\n                    vehicle_interest: \"\",\n                    vehicle_id: \"\",\n                  }));\n                }}\n              >\n                Change Vehicle\n              </button>\n            </div>\n          </div>\n        );\n      }\n\n      // Manual VRM entry mode - show plain text input\n      if (manualVrmEntry) {\n        return (\n          <div className=\"space-y-2\">\n            <input\n              type=\"text\"\n              className=\"input input-bordered w-full uppercase font-mono\"\n              placeholder=\"Enter registration (e.g. AB12 CDE)\"\n              value={formData.vrm || \"\"}\n              onChange={(e) => handleInputChange(\"vrm\", e.target.value.toUpperCase())}\n              required={field.required}\n            />\n            <div className=\"text-xs text-base-content/60\">\n              <button\n                type=\"button\"\n                className=\"link link-primary\"\n                onClick={() => {\n                  setManualVrmEntry(false);\n                  setFormData(prev => ({ ...prev, vrm: \"\", vehicle_make: \"\", vehicle_model: \"\" }));\n                }}\n              >\n                ← Search from our stock instead\n              </button>\n            </div>\n          </div>\n        );\n      }\n\n      // Stock search mode\n      return (\n        <div className=\"space-y-2\">\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            placeholder=\"Search by VRM or Make/Model...\"\n            value={stockSearch}\n            onChange={(e) => {\n              setStockSearch(e.target.value);\n              fetchStockVehicles(e.target.value);\n            }}\n          />\n          {stockVehicles.length > 0 && stockSearch && (\n            <div className=\"dropdown dropdown-open w-full\">\n              <ul className=\"dropdown-content menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto\">\n                {stockVehicles.slice(0, 10).map((v) => (\n                  <li key={v.id}>\n                    <button type=\"button\" onClick={() => {\n                      handleStockVehicleSelect(v.id);\n                      setStockSearch(\"\");\n                    }}>\n                      {v.displayName}\n                    </button>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n          <div className=\"text-xs text-base-content/60\">\n            <button\n              type=\"button\"\n              className=\"link link-primary\"\n              onClick={() => {\n                setManualVrmEntry(true);\n                setStockSearch(\"\");\n              }}\n            >\n              Vehicle not listed? Enter registration manually\n            </button>\n          </div>\n        </div>\n      );\n    }\n\n    // VRM field with suggestions for PDI/Delivery, lookup button for others\n    if (isVrmField(field) && field.type === \"TEXT\") {\n      const showVrmSuggestions = form?.type === \"PDI\" || form?.type === \"DELIVERY\";\n\n      // Show selected vehicle info if vehicle was selected from suggestions\n      if (showVrmSuggestions && selectedFromStock && formData._selectedVehicleId) {\n        return (\n          <div className=\"space-y-2\">\n            <div className=\"bg-success/10 border border-success/30 rounded-lg p-4\">\n              <div className=\"flex items-center gap-2 text-success mb-2\">\n                <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                </svg>\n                <span className=\"font-semibold\">Vehicle Selected</span>\n              </div>\n              <p className=\"font-mono font-bold text-lg\">{formData.vrm}</p>\n              {formData.make && formData.model && (\n                <p className=\"text-sm text-base-content/70\">{formData.make} {formData.model}</p>\n              )}\n              <button\n                type=\"button\"\n                className=\"btn btn-sm btn-ghost text-primary mt-2\"\n                onClick={() => {\n                  setSelectedFromStock(false);\n                  setFormData(prev => ({\n                    ...prev,\n                    vrm: \"\",\n                    make: \"\",\n                    model: \"\",\n                    colour: \"\",\n                    mileage: \"\",\n                    _selectedVehicleId: \"\",\n                  }));\n                }}\n              >\n                Change Vehicle\n              </button>\n            </div>\n          </div>\n        );\n      }\n\n      return (\n        <div className=\"relative\">\n          <div className=\"flex gap-2\">\n            <input\n              type=\"text\"\n              className=\"input input-bordered flex-1 uppercase font-mono\"\n              value={value}\n              onChange={(e) => {\n                const newValue = e.target.value.toUpperCase();\n                handleInputChange(field.fieldName, newValue);\n                // Trigger VRM suggestions for PDI/Delivery\n                if (showVrmSuggestions) {\n                  searchVrmVehicles(newValue);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onFocus={() => {\n                if (showVrmSuggestions && value && value.length >= 2) {\n                  searchVrmVehicles(value);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onBlur={() => {\n                // Delay hiding to allow click on suggestion\n                setTimeout(() => setVrmSearchActive(false), 200);\n              }}\n              required={field.required}\n              placeholder={showVrmSuggestions ? \"Search or enter VRM...\" : \"AB12 CDE\"}\n            />\n            <button\n              type=\"button\"\n              className=\"btn btn-secondary\"\n              onClick={() => handleVrmLookup(field.fieldName)}\n              disabled={isLookingUp}\n              title=\"DVLA Lookup\"\n            >\n              {isLookingUp ? <span className=\"loading loading-spinner loading-sm\"></span> : \"Lookup\"}\n            </button>\n          </div>\n          {/* VRM suggestions dropdown for PDI/Delivery */}\n          {showVrmSuggestions && vrmSearchActive && vrmSuggestions.length > 0 && (\n            <div className=\"absolute z-50 w-full mt-1 bg-base-100 border border-base-300 rounded-lg shadow-lg max-h-60 overflow-y-auto\">\n              <div className=\"text-xs text-base-content/60 px-3 py-1 border-b border-base-200 bg-base-200/50\">\n                Select from stock or use Lookup for external search\n              </div>\n              {vrmSuggestions.map((vehicle) => (\n                <button\n                  key={vehicle.id}\n                  type=\"button\"\n                  className=\"w-full px-3 py-2 text-left hover:bg-primary/10 border-b border-base-200 last:border-0\"\n                  onClick={() => handleVrmVehicleSelect(vehicle)}\n                >\n                  <div className=\"font-mono font-bold\">{vehicle.vrm || vehicle.regCurrent}</div>\n                  <div className=\"text-sm text-base-content/70\">\n                    {vehicle.make} {vehicle.model} {vehicle.year ? `(${vehicle.year})` : \"\"} - {vehicle.colour || \"\"}\n                  </div>\n                </button>\n              ))}\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    // Standard field rendering\n    switch (field.type) {\n      case \"TEXT\":\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"TEXTAREA\":\n        return (\n          <textarea\n            className=\"textarea textarea-bordered w-full\"\n            rows={4}\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"NUMBER\":\n        return (\n          <input\n            type=\"number\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"DATE\":\n        return (\n          <input\n            type=\"date\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"DATETIME\":\n        return (\n          <input\n            type=\"datetime-local\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"TIME\":\n        return (\n          <input\n            type=\"time\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"DROPDOWN\":\n        const dropdownOptions = field.options?.values || field.options?.choices || [];\n        return (\n          <select\n            className=\"select select-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          >\n            <option value=\"\">Select...</option>\n            {dropdownOptions.map((opt) => (\n              <option key={opt} value={opt}>{opt}</option>\n            ))}\n          </select>\n        );\n\n      case \"RADIO\":\n        const radioOptions = field.options?.values || field.options?.choices || [];\n        return (\n          <div className=\"flex flex-wrap gap-4\">\n            {radioOptions.map((opt) => (\n              <label key={opt} className=\"label cursor-pointer gap-2\">\n                <input\n                  type=\"radio\"\n                  name={field.fieldName}\n                  className=\"radio radio-primary\"\n                  value={opt}\n                  checked={value === opt}\n                  onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n                  required={field.required && !value}\n                />\n                <span className=\"label-text\">{opt}</span>\n              </label>\n            ))}\n          </div>\n        );\n\n      case \"BOOLEAN\":\n        return (\n          <div className=\"form-control\">\n            <label className=\"label cursor-pointer justify-start gap-4\">\n              <input\n                type=\"checkbox\"\n                className=\"checkbox checkbox-primary\"\n                checked={value === true}\n                onChange={(e) => handleInputChange(field.fieldName, e.target.checked)}\n              />\n              <span className=\"label-text\">Yes</span>\n            </label>\n          </div>\n        );\n\n      case \"RATING\":\n        return (\n          <div className=\"rating rating-lg\">\n            {[1, 2, 3, 4, 5].map((star) => (\n              <input\n                key={star}\n                type=\"radio\"\n                name={`rating-${field.fieldName}`}\n                className=\"mask mask-star-2 bg-orange-400\"\n                checked={value === star}\n                onChange={() => handleInputChange(field.fieldName, star)}\n              />\n            ))}\n          </div>\n        );\n\n      case \"FILE\":\n        const isUploading = uploadingField === field.fieldName;\n        const uploadedUrl = formData[field.fieldName];\n        const isImage = uploadedUrl && (uploadedUrl.includes(\"image\") || /\\.(jpg|jpeg|png|gif|webp)$/i.test(uploadedUrl));\n\n        return (\n          <div className=\"space-y-2\">\n            <input\n              type=\"file\"\n              className=\"file-input file-input-bordered w-full\"\n              disabled={isUploading}\n              accept=\"image/*,video/*,.pdf,.doc,.docx\"\n              onChange={(e) => {\n                const file = e.target.files[0];\n                if (file) {\n                  handleFileUpload(file, field.fieldName);\n                }\n              }}\n            />\n            {isUploading && (\n              <div className=\"flex items-center gap-2 text-sm text-base-content/60\">\n                <span className=\"loading loading-spinner loading-sm\"></span>\n                Uploading...\n              </div>\n            )}\n            {uploadedUrl && !isUploading && (\n              <div className=\"mt-2\">\n                {isImage ? (\n                  <img src={uploadedUrl} alt=\"Uploaded\" className=\"max-h-32 rounded-lg border\" />\n                ) : (\n                  <a\n                    href={uploadedUrl}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"link link-primary text-sm\"\n                  >\n                    View uploaded file\n                  </a>\n                )}\n              </div>\n            )}\n          </div>\n        );\n\n      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      default:\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n    }\n  };\n\n  return (\n    <>\n      <Head>\n        <title>{form.name} | DealerFlow</title>\n      </Head>\n\n      <div className=\"min-h-screen bg-base-200 py-12 px-4\">\n        <div className=\"max-w-3xl mx-auto\">\n          {/* Header */}\n          <div className=\"card bg-base-100 shadow-xl mb-6\">\n            <div className=\"card-body\">\n              {/* Dealer Logo */}\n              {dealer?.logoUrl && (\n                <div className=\"flex justify-center mb-4\">\n                  <img\n                    src={dealer.logoUrl}\n                    alt={dealer.name || \"Dealer Logo\"}\n                    className=\"h-16 object-contain\"\n                  />\n                </div>\n              )}\n              <h1 className=\"text-3xl font-bold text-center\">{form.name}</h1>\n              {dealer?.name && !dealer?.logoUrl && (\n                <p className=\"text-center text-base-content/60 mt-1\">{dealer.name}</p>\n              )}\n            </div>\n          </div>\n\n          {/* Intro Text */}\n          {form.introText && (\n            <div className=\"card bg-base-100 shadow-xl mb-6\">\n              <div className=\"card-body\">\n                <p className=\"text-base-content/80 whitespace-pre-wrap\">{replaceTokens(form.introText)}</p>\n              </div>\n            </div>\n          )}\n\n          {/* Form */}\n          <form onSubmit={handleSubmit}>\n            <div className=\"card bg-base-100 shadow-xl\">\n              <div className=\"card-body space-y-6\">\n                {fields.filter(field => field.visible !== false).map((field) => {\n                  // Handle SECTION_HEADER type\n                  if (field.type === \"SECTION_HEADER\") {\n                    // Check if this is the Terms section - render terms text\n                    if (field.fieldName === \"_section_terms\" && form.termsText) {\n                      return (\n                        <div key={field._id} className=\"pt-4 mt-4 border-t border-base-200\">\n                          <h3 className=\"text-lg font-bold text-primary mb-4\">{field.label}</h3>\n                          <div className=\"bg-base-200/50 rounded-lg p-4\">\n                            {formatTermsAsList(form.termsText)}\n                          </div>\n                        </div>\n                      );\n                    }\n                    return (\n                      <div key={field._id} className=\"pt-4 mt-4 border-t border-base-200\">\n                        <h3 className=\"text-lg font-bold text-primary\">{field.label}</h3>\n                      </div>\n                    );\n                  }\n\n                  // Handle PARAGRAPH type (display-only text)\n                  if (field.type === \"PARAGRAPH\") {\n                    return (\n                      <div key={field._id} className=\"text-sm text-base-content/70 -mt-2\">\n                        {field.label}\n                      </div>\n                    );\n                  }\n\n                  // Handle PDI_ISSUES type (repeatable issue entry - matches stock board Add Issue modal)\n                  if (field.type === \"PDI_ISSUES\") {\n                    const issues = formData.pdi_issues || [];\n                    const addIssue = () => {\n                      setFormData(prev => ({\n                        ...prev,\n                        pdi_issues: [...(prev.pdi_issues || []), {\n                          category: \"\",\n                          subcategory: \"\",\n                          description: \"\",\n                          actionNeeded: \"\",\n                          status: \"outstanding\",\n                          notes: \"\",\n                        }]\n                      }));\n                    };\n                    const updateIssue = (index, key, value) => {\n                      setFormData(prev => {\n                        const newIssues = [...(prev.pdi_issues || [])];\n                        newIssues[index] = { ...newIssues[index], [key]: value };\n                        return { ...prev, pdi_issues: newIssues };\n                      });\n                    };\n                    const removeIssue = (index) => {\n                      setFormData(prev => ({\n                        ...prev,\n                        pdi_issues: prev.pdi_issues.filter((_, i) => i !== index)\n                      }));\n                    };\n                    // Exact same categories as stock board Add Issue modal\n                    const ISSUE_SUBCATEGORIES = {\n                      mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n                      electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n                      bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n                      interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n                      tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n                      mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n                      service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n                      fault_codes: [\"Engine\", \"Transmission\", \"ABS\", \"Airbag\", \"Emissions\", \"Other\"],\n                      other: [\"General\", \"Misc\"],\n                    };\n\n                    return (\n                      <div key={field._id} className=\"space-y-4\">\n                        {issues.map((issue, idx) => (\n                          <div key={idx} className=\"bg-base-200 rounded-lg p-4 space-y-3\">\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"font-semibold text-sm\">Issue #{idx + 1}</span>\n                              <button\n                                type=\"button\"\n                                className=\"btn btn-ghost btn-xs text-error\"\n                                onClick={() => removeIssue(idx)}\n                              >\n                                Remove\n                              </button>\n                            </div>\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                              <div className=\"form-control\">\n                                <label className=\"label py-1\"><span className=\"label-text text-xs\">Category *</span></label>\n                                <select\n                                  className=\"select select-bordered select-sm w-full\"\n                                  value={issue.category}\n                                  onChange={(e) => {\n                                    updateIssue(idx, \"category\", e.target.value);\n                                    updateIssue(idx, \"subcategory\", \"\"); // Reset subcategory\n                                  }}\n                                  required\n                                >\n                                  <option value=\"\">Select category...</option>\n                                  <option value=\"mechanical\">Mechanical</option>\n                                  <option value=\"electrical\">Electrical</option>\n                                  <option value=\"bodywork\">Bodywork</option>\n                                  <option value=\"interior\">Interior</option>\n                                  <option value=\"tyres\">Tyres</option>\n                                  <option value=\"mot\">MOT</option>\n                                  <option value=\"service\">Service</option>\n                                  <option value=\"fault_codes\">Fault Codes</option>\n                                  <option value=\"other\">Other</option>\n                                </select>\n                              </div>\n                              {issue.category && (\n                                <div className=\"form-control\">\n                                  <label className=\"label py-1\"><span className=\"label-text text-xs\">Subcategory</span></label>\n                                  <select\n                                    className=\"select select-bordered select-sm w-full\"\n                                    value={issue.subcategory}\n                                    onChange={(e) => updateIssue(idx, \"subcategory\", e.target.value)}\n                                  >\n                                    <option value=\"\">Select subcategory...</option>\n                                    {(ISSUE_SUBCATEGORIES[issue.category] || []).map(sub => (\n                                      <option key={sub} value={sub}>{sub}</option>\n                                    ))}\n                                  </select>\n                                </div>\n                              )}\n                            </div>\n                            <div className=\"form-control\">\n                              <label className=\"label py-1\"><span className=\"label-text text-xs\">Description *</span></label>\n                              <textarea\n                                className=\"textarea textarea-bordered textarea-sm w-full\"\n                                rows={3}\n                                placeholder=\"Describe the issue...\"\n                                value={issue.description}\n                                onChange={(e) => updateIssue(idx, \"description\", e.target.value)}\n                                required\n                              />\n                            </div>\n                            <div className=\"form-control\">\n                              <label className=\"label py-1\"><span className=\"label-text text-xs\">Action Needed</span></label>\n                              <input\n                                type=\"text\"\n                                className=\"input input-bordered input-sm w-full\"\n                                placeholder=\"What needs to be done?\"\n                                value={issue.actionNeeded || \"\"}\n                                onChange={(e) => updateIssue(idx, \"actionNeeded\", e.target.value)}\n                              />\n                            </div>\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                              <div className=\"form-control\">\n                                <label className=\"label py-1\"><span className=\"label-text text-xs\">Status</span></label>\n                                <select\n                                  className=\"select select-bordered select-sm w-full\"\n                                  value={issue.status || \"outstanding\"}\n                                  onChange={(e) => updateIssue(idx, \"status\", e.target.value)}\n                                >\n                                  <option value=\"outstanding\">Outstanding</option>\n                                  <option value=\"ordered\">Ordered</option>\n                                  <option value=\"in_progress\">In Progress</option>\n                                  <option value=\"resolved\">Resolved</option>\n                                </select>\n                              </div>\n                            </div>\n                            <div className=\"form-control\">\n                              <label className=\"label py-1\"><span className=\"label-text text-xs\">Notes</span></label>\n                              <textarea\n                                className=\"textarea textarea-bordered textarea-sm w-full\"\n                                rows={2}\n                                placeholder=\"Additional notes...\"\n                                value={issue.notes || \"\"}\n                                onChange={(e) => updateIssue(idx, \"notes\", e.target.value)}\n                              />\n                            </div>\n                          </div>\n                        ))}\n                        <button\n                          type=\"button\"\n                          className=\"btn btn-outline btn-primary w-full\"\n                          onClick={addIssue}\n                        >\n                          <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                          </svg>\n                          Add Issue\n                        </button>\n                      </div>\n                    );\n                  }\n\n                  // Hide make/model fields when vehicle selected from stock\n                  if (shouldHideField(field)) {\n                    return null;\n                  }\n\n                  return (\n                    <div key={field._id} className=\"form-control\">\n                      <label className=\"label\">\n                        <span className=\"label-text font-semibold\">\n                          {field.label}\n                          {field.required && !shouldHideField(field) && <span className=\"text-error ml-1\">*</span>}\n                        </span>\n                      </label>\n                      {renderField(field)}\n                    </div>\n                  );\n                })}\n\n                <div className=\"card-actions justify-end mt-8\">\n                  <button\n                    type=\"submit\"\n                    className=\"btn btn-primary btn-lg\"\n                    disabled={isSubmitting}\n                  >\n                    {isSubmitting ? (\n                      <>\n                        <span className=\"loading loading-spinner\"></span>\n                        Submitting...\n                      </>\n                    ) : (\n                      \"Submit\"\n                    )}\n                  </button>\n                </div>\n              </div>\n            </div>\n          </form>\n        </div>\n      </div>\n    </>\n  );\n}\n\nexport async function getServerSideProps({ params }) {\n  try {\n    await connectMongo();\n\n    // Find form by slug - allow SHARE_LINK and PUBLIC visibility (or legacy isPublic: true)\n    const form = await Form.findOne({\n      publicSlug: params.slug,\n      $or: [\n        { visibility: { $in: [\"SHARE_LINK\", \"PUBLIC\"] } },\n        { visibility: { $exists: false }, isPublic: true }, // Legacy compatibility\n      ]\n    }).lean();\n\n    if (!form) {\n      return { props: { form: null, fields: [], dealer: null } };\n    }\n\n    const fields = await FormField.find({ formId: form._id })\n      .sort({ order: 1 })\n      .lean();\n\n    // Get dealer info for logo\n    const dealer = await Dealer.findOne().lean();\n\n    return {\n      props: {\n        form: JSON.parse(JSON.stringify(form)),\n        fields: JSON.parse(JSON.stringify(fields)),\n        dealer: dealer ? JSON.parse(JSON.stringify(dealer)) : null,\n      },\n    };\n  } catch (error) {\n    console.error(\"Error loading form:\", error);\n    return { props: { form: null, fields: [], dealer: null } };\n  }\n}\n","structuredPatch":[{"oldStart":30,"oldLines":6,"newStart":30,"newLines":10,"lines":["   // VRM suggestions for PDI/Delivery forms","   const [vrmSuggestions, setVrmSuggestions] = useState([]);","   const [vrmSearchActive, setVrmSearchActive] = useState(false);","+  // Licence extraction state","+  const [isExtractingLicence, setIsExtractingLicence] = useState(false);","+  const [licenceExtracted, setLicenceExtracted] = useState(false);","+  const [licenceExtractionError, setLicenceExtractionError] = useState(null);"," ","   // Load courtesy vehicles for courtesy car forms","   useEffect(() => {"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"0d0adfc3-bf48-4826-a902-54476a79fb12","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UMRrUgedqzmHYpmHJ6Edv4","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Now I need to add the LICENCE_SCAN case to the switch statement in the public form. Let me read around where the FILE case ends:","signature":"EqkCCkYICxgCKkAKEWBmqS5FKAsLGh4gMHJ8N1jaImL9N8rLo6ldGUmuXRJUcPunojEi9t2pr8+WUGx3IGnWAb1MMO9KXQ9LTBkpEgxdNAUFYY41guKSxPoaDJU+Buglcds3Jg8TWiIweIp3SwCp7Wn9AX5wN+hjZehG7wz5TXG4MlQ2n/PPtpz5Q2GAHiciPmPLS8XOiitPKpABFBNlnnSKbLnyUFEiOhxKqSCOQHRcREA/UCoL8TRVbApqmq9uhZTBRgibP8murrOC3laY3fTIKaU1w7qsZ3KqRxOcrdE8//Y9QThINaVqMTL/ji2G+JHWAg0rI5NIX5UTELkebjgv8CLZwY4qKTTnoxFPee6qj946gXnf6GG06smv3mK61Q1R/r98P5Xq6YWFGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":853,"cache_read_input_tokens":102643,"cache_creation":{"ephemeral_5m_input_tokens":853,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWd9S2QzGbP3UjgKvrVEp","type":"assistant","uuid":"b5d5bb50-203d-4786-a5d2-a386bf211c5e","timestamp":"2025-12-30T15:57:19.372Z"}
{"parentUuid":"b5d5bb50-203d-4786-a5d2-a386bf211c5e","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UMRrUgedqzmHYpmHJ6Edv4","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read around the FILE case to find where to add the LICENCE_SCAN case:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":853,"cache_read_input_tokens":102643,"cache_creation":{"ephemeral_5m_input_tokens":853,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWd9S2QzGbP3UjgKvrVEp","type":"assistant","uuid":"8cd9e57f-7916-41c2-a3ce-edc024bff2c9","timestamp":"2025-12-30T15:57:19.781Z"}
{"parentUuid":"8cd9e57f-7916-41c2-a3ce-edc024bff2c9","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UMRrUgedqzmHYpmHJ6Edv4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JqSUQdGMo1AofeVidkBzUQ","name":"Read","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","offset":785,"limit":60}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":853,"cache_read_input_tokens":102643,"cache_creation":{"ephemeral_5m_input_tokens":853,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWd9S2QzGbP3UjgKvrVEp","type":"assistant","uuid":"81abbc88-d9b2-4c58-bcdf-8f9d035e70da","timestamp":"2025-12-30T15:57:20.394Z"}
{"parentUuid":"81abbc88-d9b2-4c58-bcdf-8f9d035e70da","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JqSUQdGMo1AofeVidkBzUQ","type":"tool_result","content":"   785→            ))}\n   786→          </div>\n   787→        );\n   788→\n   789→      case \"FILE\":\n   790→        const isUploading = uploadingField === field.fieldName;\n   791→        const uploadedUrl = formData[field.fieldName];\n   792→        const isImage = uploadedUrl && (uploadedUrl.includes(\"image\") || /\\.(jpg|jpeg|png|gif|webp)$/i.test(uploadedUrl));\n   793→\n   794→        return (\n   795→          <div className=\"space-y-2\">\n   796→            <input\n   797→              type=\"file\"\n   798→              className=\"file-input file-input-bordered w-full\"\n   799→              disabled={isUploading}\n   800→              accept=\"image/*,video/*,.pdf,.doc,.docx\"\n   801→              onChange={(e) => {\n   802→                const file = e.target.files[0];\n   803→                if (file) {\n   804→                  handleFileUpload(file, field.fieldName);\n   805→                }\n   806→              }}\n   807→            />\n   808→            {isUploading && (\n   809→              <div className=\"flex items-center gap-2 text-sm text-base-content/60\">\n   810→                <span className=\"loading loading-spinner loading-sm\"></span>\n   811→                Uploading...\n   812→              </div>\n   813→            )}\n   814→            {uploadedUrl && !isUploading && (\n   815→              <div className=\"mt-2\">\n   816→                {isImage ? (\n   817→                  <img src={uploadedUrl} alt=\"Uploaded\" className=\"max-h-32 rounded-lg border\" />\n   818→                ) : (\n   819→                  <a\n   820→                    href={uploadedUrl}\n   821→                    target=\"_blank\"\n   822→                    rel=\"noopener noreferrer\"\n   823→                    className=\"link link-primary text-sm\"\n   824→                  >\n   825→                    View uploaded file\n   826→                  </a>\n   827→                )}\n   828→              </div>\n   829→            )}\n   830→          </div>\n   831→        );\n   832→\n   833→      case \"SIGNATURE\":\n   834→        return (\n   835→          <DrawableSignature\n   836→            value={value || \"\"}\n   837→            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n   838→            required={field.required}\n   839→            label=\"\"\n   840→            helpText=\"Please sign in the box above\"\n   841→          />\n   842→        );\n   843→\n   844→      default:\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"e068ee42-a190-4bf2-8887-dd205ec05bcd","timestamp":"2025-12-30T15:57:21.786Z","toolUseResult":{"type":"text","file":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","content":"            ))}\n          </div>\n        );\n\n      case \"FILE\":\n        const isUploading = uploadingField === field.fieldName;\n        const uploadedUrl = formData[field.fieldName];\n        const isImage = uploadedUrl && (uploadedUrl.includes(\"image\") || /\\.(jpg|jpeg|png|gif|webp)$/i.test(uploadedUrl));\n\n        return (\n          <div className=\"space-y-2\">\n            <input\n              type=\"file\"\n              className=\"file-input file-input-bordered w-full\"\n              disabled={isUploading}\n              accept=\"image/*,video/*,.pdf,.doc,.docx\"\n              onChange={(e) => {\n                const file = e.target.files[0];\n                if (file) {\n                  handleFileUpload(file, field.fieldName);\n                }\n              }}\n            />\n            {isUploading && (\n              <div className=\"flex items-center gap-2 text-sm text-base-content/60\">\n                <span className=\"loading loading-spinner loading-sm\"></span>\n                Uploading...\n              </div>\n            )}\n            {uploadedUrl && !isUploading && (\n              <div className=\"mt-2\">\n                {isImage ? (\n                  <img src={uploadedUrl} alt=\"Uploaded\" className=\"max-h-32 rounded-lg border\" />\n                ) : (\n                  <a\n                    href={uploadedUrl}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"link link-primary text-sm\"\n                  >\n                    View uploaded file\n                  </a>\n                )}\n              </div>\n            )}\n          </div>\n        );\n\n      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      default:","numLines":60,"startLine":785,"totalLines":1165}}}
{"parentUuid":"e068ee42-a190-4bf2-8887-dd205ec05bcd","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J6zVcmUsZGGj9ocsyWJnW1","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"I need to add the LICENCE_SCAN case before the default case. The public form uses a different file upload mechanism that uploads to a URL rather than storing locally. Let me also check how handleFileUpload works:","signature":"Ev0CCkYICxgCKkBL/QPH9JNfoa8qMJleU4tYvr2735hepVDMw5f7yQWtYm+c1kgPG/OS+70nSt6M72AsDeMW7tupgvfsGWK0Yt36Egyy0xd+s2LD10N5CqwaDAWUb1e+j+eQ6pwXVCIwLQdF9mFJtHDltxsTXPov/oTCHPJWpYeDHuy85yrUgcbPpPvfLR6Cwis9wzrIdHpLKuQBVohZDnmtB5oGyZFkO0Gd8BofRU/U7hmQXUd6ZTi298/4+oxavGLIFyMUC6A/MEClZn7uSuePV62UBaFbOazLvhikQ+bJyqM/qrpigWCGXjXcKf7JaWE7TjijEy7NjLcCkAqO1gCpWO1j9M2DlqK15ajY8u5PMgOFZeXXPYKrsweQB9eCkLEOXkQvG6Ws13LtyKjuYb7xh8avbXb/z5ZOPmGSK4qyHCnsbGruHNF8iWAAREzhhH/WdFlhTfba3REOwWd2uVVwwgOmGi39O2aBWViEMD9wEvI9+Sg4d6EnwjwXSlZ6GAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1137,"cache_read_input_tokens":103496,"cache_creation":{"ephemeral_5m_input_tokens":1137,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWd9SgsGngcCVkjqwC7gP","type":"assistant","uuid":"09c60b06-cf8b-423b-954e-2715bb2e6db2","timestamp":"2025-12-30T15:57:29.130Z"}
{"parentUuid":"09c60b06-cf8b-423b-954e-2715bb2e6db2","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01J6zVcmUsZGGj9ocsyWJnW1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01PDuc2GNYCMCKpGXQAGLuEP","name":"Grep","input":{"pattern":"handleFileUpload","path":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","output_mode":"content","-n":true,"-C":10}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":1137,"cache_read_input_tokens":103496,"cache_creation":{"ephemeral_5m_input_tokens":1137,"ephemeral_1h_input_tokens":0},"output_tokens":200,"service_tier":"standard"}},"requestId":"req_011CWd9SgsGngcCVkjqwC7gP","type":"assistant","uuid":"c505f8a3-889b-44a8-9c0e-11b12a29dbdc","timestamp":"2025-12-30T15:57:30.171Z"}
{"parentUuid":"c505f8a3-889b-44a8-9c0e-11b12a29dbdc","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01PDuc2GNYCMCKpGXQAGLuEP","type":"tool_result","content":"297-  const shouldHideField = (field) => {\r\n298-    // Show make/model fields only if manual entry is enabled or no stock selection\r\n299-    if (manualVrmEntry) return false; // Show all fields for manual entry\r\n300-    if (!selectedFromStock) return false;\r\n301-    // Hide make/model fields when vehicle selected from stock (for TEST_DRIVE, PDI, DELIVERY)\r\n302-    const hideFields = [\"vehicle_make\", \"vehicle_model\", \"make\", \"model\"];\r\n303-    return hideFields.includes(field.fieldName);\r\n304-  };\r\n305-\r\n306-  // Upload file to server and return URL\r\n307:  const handleFileUpload = async (file, fieldName) => {\r\n308-    setUploadingField(fieldName);\r\n309-    try {\r\n310-      const formDataUpload = new FormData();\r\n311-      formDataUpload.append(\"file\", file);\r\n312-\r\n313-      const res = await fetch(\"/api/vehicles/upload\", {\r\n314-        method: \"POST\",\r\n315-        body: formDataUpload,\r\n316-      });\r\n317-\r\n--\n794-        return (\r\n795-          <div className=\"space-y-2\">\r\n796-            <input\r\n797-              type=\"file\"\r\n798-              className=\"file-input file-input-bordered w-full\"\r\n799-              disabled={isUploading}\r\n800-              accept=\"image/*,video/*,.pdf,.doc,.docx\"\r\n801-              onChange={(e) => {\r\n802-                const file = e.target.files[0];\r\n803-                if (file) {\r\n804:                  handleFileUpload(file, field.fieldName);\r\n805-                }\r\n806-              }}\r\n807-            />\r\n808-            {isUploading && (\r\n809-              <div className=\"flex items-center gap-2 text-sm text-base-content/60\">\r\n810-                <span className=\"loading loading-spinner loading-sm\"></span>\r\n811-                Uploading...\r\n812-              </div>\r\n813-            )}\r\n814-            {uploadedUrl && !isUploading && ("}]},"uuid":"7017811f-94ad-4181-8c8a-8cc40a219aa8","timestamp":"2025-12-30T15:57:31.615Z","toolUseResult":{"mode":"content","numFiles":0,"filenames":[],"content":"297-  const shouldHideField = (field) => {\r\n298-    // Show make/model fields only if manual entry is enabled or no stock selection\r\n299-    if (manualVrmEntry) return false; // Show all fields for manual entry\r\n300-    if (!selectedFromStock) return false;\r\n301-    // Hide make/model fields when vehicle selected from stock (for TEST_DRIVE, PDI, DELIVERY)\r\n302-    const hideFields = [\"vehicle_make\", \"vehicle_model\", \"make\", \"model\"];\r\n303-    return hideFields.includes(field.fieldName);\r\n304-  };\r\n305-\r\n306-  // Upload file to server and return URL\r\n307:  const handleFileUpload = async (file, fieldName) => {\r\n308-    setUploadingField(fieldName);\r\n309-    try {\r\n310-      const formDataUpload = new FormData();\r\n311-      formDataUpload.append(\"file\", file);\r\n312-\r\n313-      const res = await fetch(\"/api/vehicles/upload\", {\r\n314-        method: \"POST\",\r\n315-        body: formDataUpload,\r\n316-      });\r\n317-\r\n--\n794-        return (\r\n795-          <div className=\"space-y-2\">\r\n796-            <input\r\n797-              type=\"file\"\r\n798-              className=\"file-input file-input-bordered w-full\"\r\n799-              disabled={isUploading}\r\n800-              accept=\"image/*,video/*,.pdf,.doc,.docx\"\r\n801-              onChange={(e) => {\r\n802-                const file = e.target.files[0];\r\n803-                if (file) {\r\n804:                  handleFileUpload(file, field.fieldName);\r\n805-                }\r\n806-              }}\r\n807-            />\r\n808-            {isUploading && (\r\n809-              <div className=\"flex items-center gap-2 text-sm text-base-content/60\">\r\n810-                <span className=\"loading loading-spinner loading-sm\"></span>\r\n811-                Uploading...\r\n812-              </div>\r\n813-            )}\r\n814-            {uploadedUrl && !isUploading && (","numLines":43}}
{"parentUuid":"7017811f-94ad-4181-8c8a-8cc40a219aa8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_016WPiaKGGFfi4g4U2WfsgSj","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"Good. Now I understand how the public form handles file uploads. For the LICENCE_SCAN case in the public form, I'll need to:\n1. Upload the file first using the existing handleFileUpload mechanism\n2. Also send the base64 to the extraction endpoint\n3. Auto-fill the fields\n\nLet me add the LICENCE_SCAN case. The public form uses handleInputChange to set form data.","signature":"Eo8ECkYICxgCKkAa90Uzm+d4xOBUbRXQEYKIAcOmxSsvf1IkLb2C6jCmt8s+MYENpGFaqe3c5H9NDd0wLUIVR4lL7WjodeCWNKwVEgzcE7Didt1og6j9mbQaDLtQKFOQ/CH7+JOrdyIw//yd5Vy58tZF50QF8FGrl69XoJ7pE7YBO8jJ+O2yBKFjl5tXYql5hiiWBAeAdx1tKvYCpf1RN1gmQepo9zLMkabY6rhRf63/paEIZegX5rDzL8BHmXidxoWHa1w8FhvHdu45JHosWimtXafttYRAyPENCOTqEMSheldYZMOVUeWY1Wjqi11EhXPkmz4M/YP4u4daV3lvpCTtUz9tjq6H1t81ulmZ4zcCifmgcJMKxhnu4aOJe09l5UQoelu2jhYrrue+5C+8qR5gIjtSX5KUGH1dWIAnjM03NHOVaN9HvLbf1ryB/WopxMdgqjZIuZf495eD1nKNza4WcgO2g5Q0BFqM/zPhovJgZFPQA1+srm0aqHc33QGR+xO+TWWtTXMHAHWjYJVKACASfgr5rHqu07cR0oYtaRBKgi2teYehJ7m78Lu6V91YtaUf8mWzpggjMMvwTBwBcMNmjgYWnoBZ+ExE36/aHjkzNO8qXxcls5YUAqUPBO5avJe3/iWLQfvI+9WdtdJKvplU0T6tXjPL1usthOHt0ZlgMqjKIrRnyMxKHABn3Mv7EvwYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":732,"cache_read_input_tokens":104633,"cache_creation":{"ephemeral_5m_input_tokens":732,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9TPWXNTdW1yDYn778z","type":"assistant","uuid":"a1f791db-5f40-4b9a-810b-5d4a71be62d8","timestamp":"2025-12-30T15:57:40.308Z"}
{"parentUuid":"a1f791db-5f40-4b9a-810b-5d4a71be62d8","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_016WPiaKGGFfi4g4U2WfsgSj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LTSMXVoyfH3orkpttfox3z","name":"Edit","input":{"file_path":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","old_string":"      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      default:","new_string":"      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      case \"LICENCE_SCAN\":\n        // Licence scan with OCR extraction\n        const isLicenceUploading = uploadingField === field.fieldName;\n\n        const handleLicenceCapture = async (file) => {\n          if (!file) return;\n\n          setIsExtractingLicence(true);\n          setLicenceExtractionError(null);\n          setLicenceExtracted(false);\n\n          // First upload the file\n          await handleFileUpload(file, field.fieldName);\n\n          try {\n            // Convert file to base64 for extraction\n            const reader = new FileReader();\n            reader.onload = async () => {\n              const base64 = reader.result.split(\",\")[1];\n              const mimeType = file.type || \"image/jpeg\";\n\n              // Call extraction API\n              const res = await fetch(\"/api/forms/test-drive/extract-licence\", {\n                method: \"POST\",\n                headers: { \"Content-Type\": \"application/json\" },\n                body: JSON.stringify({ image: base64, mimeType }),\n              });\n\n              const data = await res.json();\n\n              if (data.ok && data.data) {\n                const extracted = data.data;\n                const updates = {};\n\n                // Map extracted fields to form field names using autoFillFromLicence config\n                fields.forEach((f) => {\n                  if (f.autoFillFromLicence && extracted[f.autoFillFromLicence]) {\n                    updates[f.fieldName] = extracted[f.autoFillFromLicence];\n                  }\n                });\n\n                if (Object.keys(updates).length > 0) {\n                  setFormData((prev) => ({ ...prev, ...updates }));\n                  setLicenceExtracted(true);\n                  toast.success(\"Details captured from licence - please verify\");\n                } else {\n                  setLicenceExtractionError(\"Could not extract details. Please enter manually.\");\n                }\n              } else {\n                setLicenceExtractionError(data.error || \"Could not extract details. Please enter manually.\");\n              }\n\n              setIsExtractingLicence(false);\n            };\n\n            reader.onerror = () => {\n              setLicenceExtractionError(\"Failed to read file. Please try again.\");\n              setIsExtractingLicence(false);\n            };\n\n            reader.readAsDataURL(file);\n          } catch (error) {\n            console.error(\"Licence extraction error:\", error);\n            setLicenceExtractionError(\"Failed to process licence. Please enter details manually.\");\n            setIsExtractingLicence(false);\n          }\n        };\n\n        const clearLicenceDataPublic = () => {\n          handleInputChange(field.fieldName, null);\n          setLicenceExtracted(false);\n          setLicenceExtractionError(null);\n\n          const fieldsToClear = {};\n          fields.forEach((f) => {\n            if (f.autoFillFromLicence) {\n              fieldsToClear[f.fieldName] = \"\";\n            }\n          });\n          setFormData((prev) => ({ ...prev, ...fieldsToClear }));\n        };\n\n        const licenceUploadedUrl = formData[field.fieldName];\n\n        return (\n          <div className=\"space-y-3\">\n            {licenceExtracted && (\n              <div className=\"alert alert-success shadow-sm\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n                <div>\n                  <h3 className=\"font-bold text-sm\">Details captured from licence</h3>\n                  <p className=\"text-xs\">Please verify the information below is correct</p>\n                </div>\n                <button type=\"button\" className=\"btn btn-ghost btn-xs\" onClick={clearLicenceDataPublic}>\n                  Clear\n                </button>\n              </div>\n            )}\n\n            {licenceExtractionError && (\n              <div className=\"alert alert-warning shadow-sm\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                </svg>\n                <span className=\"text-sm\">{licenceExtractionError}</span>\n              </div>\n            )}\n\n            <div className=\"flex flex-col sm:flex-row gap-2\">\n              <label className=\"flex-1 cursor-pointer\">\n                <div className={`border-2 border-dashed rounded-xl p-4 text-center transition-colors ${\n                  isExtractingLicence || isLicenceUploading ? \"border-primary bg-primary/5\" :\n                  licenceUploadedUrl ? \"border-success bg-success/5\" :\n                  \"border-base-300 hover:border-primary hover:bg-primary/5\"\n                }`}>\n                  {isExtractingLicence || isLicenceUploading ? (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <span className=\"loading loading-spinner loading-md text-primary\"></span>\n                      <span className=\"text-sm text-primary\">\n                        {isLicenceUploading ? \"Uploading...\" : \"Extracting details...\"}\n                      </span>\n                    </div>\n                  ) : licenceUploadedUrl ? (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-success\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                      </svg>\n                      <span className=\"text-sm text-success font-medium\">Photo captured</span>\n                      <img src={licenceUploadedUrl} alt=\"Licence\" className=\"max-h-20 rounded-lg border mt-1\" />\n                    </div>\n                  ) : (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-base-content/40\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\" />\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 13a3 3 0 11-6 0 3 3 0 016 0z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Take photo or upload</span>\n                      <span className=\"text-xs text-base-content/60\">Tap to capture your driving licence</span>\n                    </div>\n                  )}\n                </div>\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  capture=\"environment\"\n                  className=\"hidden\"\n                  onChange={(e) => {\n                    const file = e.target.files?.[0];\n                    if (file) {\n                      handleLicenceCapture(file);\n                    }\n                  }}\n                  disabled={isExtractingLicence || isLicenceUploading}\n                />\n              </label>\n            </div>\n\n            {helpText && <p className=\"text-sm text-base-content/60\">{helpText}</p>}\n          </div>\n        );\n\n      default:"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":732,"cache_read_input_tokens":104633,"cache_creation":{"ephemeral_5m_input_tokens":732,"ephemeral_1h_input_tokens":0},"output_tokens":2649,"service_tier":"standard"}},"requestId":"req_011CWd9TPWXNTdW1yDYn778z","type":"assistant","uuid":"d379dd1e-5405-42d3-b5c5-903c025c4a86","timestamp":"2025-12-30T15:58:04.638Z"}
{"parentUuid":"d379dd1e-5405-42d3-b5c5-903c025c4a86","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LTSMXVoyfH3orkpttfox3z","type":"tool_result","content":"The file C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n   829→            )}\n   830→          </div>\n   831→        );\n   832→\n   833→      case \"SIGNATURE\":\n   834→        return (\n   835→          <DrawableSignature\n   836→            value={value || \"\"}\n   837→            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n   838→            required={field.required}\n   839→            label=\"\"\n   840→            helpText=\"Please sign in the box above\"\n   841→          />\n   842→        );\n   843→\n   844→      case \"LICENCE_SCAN\":\n   845→        // Licence scan with OCR extraction\n   846→        const isLicenceUploading = uploadingField === field.fieldName;\n   847→\n   848→        const handleLicenceCapture = async (file) => {\n   849→          if (!file) return;\n   850→\n   851→          setIsExtractingLicence(true);\n   852→          setLicenceExtractionError(null);\n   853→          setLicenceExtracted(false);\n   854→\n   855→          // First upload the file\n   856→          await handleFileUpload(file, field.fieldName);\n   857→\n   858→          try {\n   859→            // Convert file to base64 for extraction\n   860→            const reader = new FileReader();\n   861→            reader.onload = async () => {\n   862→              const base64 = reader.result.split(\",\")[1];\n   863→              const mimeType = file.type || \"image/jpeg\";\n   864→\n   865→              // Call extraction API\n   866→              const res = await fetch(\"/api/forms/test-drive/extract-licence\", {\n   867→                method: \"POST\",\n   868→                headers: { \"Content-Type\": \"application/json\" },\n   869→                body: JSON.stringify({ image: base64, mimeType }),\n   870→              });\n   871→\n   872→              const data = await res.json();\n   873→\n   874→              if (data.ok && data.data) {\n   875→                const extracted = data.data;\n   876→                const updates = {};\n   877→\n   878→                // Map extracted fields to form field names using autoFillFromLicence config\n   879→                fields.forEach((f) => {\n   880→                  if (f.autoFillFromLicence && extracted[f.autoFillFromLicence]) {\n   881→                    updates[f.fieldName] = extracted[f.autoFillFromLicence];\n   882→                  }\n   883→                });\n   884→\n   885→                if (Object.keys(updates).length > 0) {\n   886→                  setFormData((prev) => ({ ...prev, ...updates }));\n   887→                  setLicenceExtracted(true);\n   888→                  toast.success(\"Details captured from licence - please verify\");\n   889→                } else {\n   890→                  setLicenceExtractionError(\"Could not extract details. Please enter manually.\");\n   891→                }\n   892→              } else {\n   893→                setLicenceExtractionError(data.error || \"Could not extract details. Please enter manually.\");\n   894→              }\n   895→\n   896→              setIsExtractingLicence(false);\n   897→            };\n   898→\n   899→            reader.onerror = () => {\n   900→              setLicenceExtractionError(\"Failed to read file. Please try again.\");\n   901→              setIsExtractingLicence(false);\n   902→            };\n   903→\n   904→            reader.readAsDataURL(file);\n   905→          } catch (error) {\n   906→            console.error(\"Licence extraction error:\", error);\n   907→            setLicenceExtractionError(\"Failed to process licence. Please enter details manually.\");\n   908→            setIsExtractingLicence(false);\n   909→          }\n   910→        };\n   911→\n   912→        const clearLicenceDataPublic = () => {\n   913→          handleInputChange(field.fieldName, null);\n   914→          setLicenceExtracted(false);\n   915→          setLicenceExtractionError(null);\n   916→\n   917→          const fieldsToClear = {};\n   918→          fields.forEach((f) => {\n   919→            if (f.autoFillFromLicence) {\n   920→              fieldsToClear[f.fieldName] = \"\";\n   921→            }\n   922→          });\n   923→          setFormData((prev) => ({ ...prev, ...fieldsToClear }));\n   924→        };\n   925→\n   926→        const licenceUploadedUrl = formData[field.fieldName];\n   927→\n   928→        return (\n   929→          <div className=\"space-y-3\">\n   930→            {licenceExtracted && (\n   931→              <div className=\"alert alert-success shadow-sm\">\n   932→                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n   933→                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n   934→                </svg>\n   935→                <div>\n   936→                  <h3 className=\"font-bold text-sm\">Details captured from licence</h3>\n   937→                  <p className=\"text-xs\">Please verify the information below is correct</p>\n   938→                </div>\n   939→                <button type=\"button\" className=\"btn btn-ghost btn-xs\" onClick={clearLicenceDataPublic}>\n   940→                  Clear\n   941→                </button>\n   942→              </div>\n   943→            )}\n   944→\n   945→            {licenceExtractionError && (\n   946→              <div className=\"alert alert-warning shadow-sm\">\n   947→                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n   948→                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n   949→                </svg>\n   950→                <span className=\"text-sm\">{licenceExtractionError}</span>\n   951→              </div>\n   952→            )}\n   953→\n   954→            <div className=\"flex flex-col sm:flex-row gap-2\">\n   955→              <label className=\"flex-1 cursor-pointer\">\n   956→                <div className={`border-2 border-dashed rounded-xl p-4 text-center transition-colors ${\n   957→                  isExtractingLicence || isLicenceUploading ? \"border-primary bg-primary/5\" :\n   958→                  licenceUploadedUrl ? \"border-success bg-success/5\" :\n   959→                  \"border-base-300 hover:border-primary hover:bg-primary/5\"\n   960→                }`}>\n   961→                  {isExtractingLicence || isLicenceUploading ? (\n   962→                    <div className=\"flex flex-col items-center gap-2\">\n   963→                      <span className=\"loading loading-spinner loading-md text-primary\"></span>\n   964→                      <span className=\"text-sm text-primary\">\n   965→                        {isLicenceUploading ? \"Uploading...\" : \"Extracting details...\"}\n   966→                      </span>\n   967→                    </div>\n   968→                  ) : licenceUploadedUrl ? (\n   969→                    <div className=\"flex flex-col items-center gap-2\">\n   970→                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-success\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n   971→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n   972→                      </svg>\n   973→                      <span className=\"text-sm text-success font-medium\">Photo captured</span>\n   974→                      <img src={licenceUploadedUrl} alt=\"Licence\" className=\"max-h-20 rounded-lg border mt-1\" />\n   975→                    </div>\n   976→                  ) : (\n   977→                    <div className=\"flex flex-col items-center gap-2\">\n   978→                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-base-content/40\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n   979→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\" />\n   980→                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 13a3 3 0 11-6 0 3 3 0 016 0z\" />\n   981→                      </svg>\n   982→                      <span className=\"text-sm font-medium\">Take photo or upload</span>\n   983→                      <span className=\"text-xs text-base-content/60\">Tap to capture your driving licence</span>\n   984→                    </div>\n   985→                  )}\n   986→                </div>\n   987→                <input\n   988→                  type=\"file\"\n   989→                  accept=\"image/*\"\n   990→                  capture=\"environment\"\n   991→                  className=\"hidden\"\n   992→                  onChange={(e) => {\n   993→                    const file = e.target.files?.[0];\n   994→                    if (file) {\n   995→                      handleLicenceCapture(file);\n   996→                    }\n   997→                  }}\n   998→                  disabled={isExtractingLicence || isLicenceUploading}\n   999→                />\n  1000→              </label>\n  1001→            </div>\n  1002→\n  1003→            {helpText && <p className=\"text-sm text-base-content/60\">{helpText}</p>}\n  1004→          </div>\n  1005→        );\n  1006→\n  1007→      default:\n  1008→        return (\n  1009→          <input\n  1010→            type=\"text\"\n  1011→            className=\"input input-bordered w-full\""}]},"uuid":"ba0b83c0-d1d7-4e04-9f88-6e122d5f1f3b","timestamp":"2025-12-30T15:58:05.778Z","toolUseResult":{"filePath":"C:\\Users\\georg\\dealerflow\\pages\\public\\forms\\[slug].js","oldString":"      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      default:","newString":"      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      case \"LICENCE_SCAN\":\n        // Licence scan with OCR extraction\n        const isLicenceUploading = uploadingField === field.fieldName;\n\n        const handleLicenceCapture = async (file) => {\n          if (!file) return;\n\n          setIsExtractingLicence(true);\n          setLicenceExtractionError(null);\n          setLicenceExtracted(false);\n\n          // First upload the file\n          await handleFileUpload(file, field.fieldName);\n\n          try {\n            // Convert file to base64 for extraction\n            const reader = new FileReader();\n            reader.onload = async () => {\n              const base64 = reader.result.split(\",\")[1];\n              const mimeType = file.type || \"image/jpeg\";\n\n              // Call extraction API\n              const res = await fetch(\"/api/forms/test-drive/extract-licence\", {\n                method: \"POST\",\n                headers: { \"Content-Type\": \"application/json\" },\n                body: JSON.stringify({ image: base64, mimeType }),\n              });\n\n              const data = await res.json();\n\n              if (data.ok && data.data) {\n                const extracted = data.data;\n                const updates = {};\n\n                // Map extracted fields to form field names using autoFillFromLicence config\n                fields.forEach((f) => {\n                  if (f.autoFillFromLicence && extracted[f.autoFillFromLicence]) {\n                    updates[f.fieldName] = extracted[f.autoFillFromLicence];\n                  }\n                });\n\n                if (Object.keys(updates).length > 0) {\n                  setFormData((prev) => ({ ...prev, ...updates }));\n                  setLicenceExtracted(true);\n                  toast.success(\"Details captured from licence - please verify\");\n                } else {\n                  setLicenceExtractionError(\"Could not extract details. Please enter manually.\");\n                }\n              } else {\n                setLicenceExtractionError(data.error || \"Could not extract details. Please enter manually.\");\n              }\n\n              setIsExtractingLicence(false);\n            };\n\n            reader.onerror = () => {\n              setLicenceExtractionError(\"Failed to read file. Please try again.\");\n              setIsExtractingLicence(false);\n            };\n\n            reader.readAsDataURL(file);\n          } catch (error) {\n            console.error(\"Licence extraction error:\", error);\n            setLicenceExtractionError(\"Failed to process licence. Please enter details manually.\");\n            setIsExtractingLicence(false);\n          }\n        };\n\n        const clearLicenceDataPublic = () => {\n          handleInputChange(field.fieldName, null);\n          setLicenceExtracted(false);\n          setLicenceExtractionError(null);\n\n          const fieldsToClear = {};\n          fields.forEach((f) => {\n            if (f.autoFillFromLicence) {\n              fieldsToClear[f.fieldName] = \"\";\n            }\n          });\n          setFormData((prev) => ({ ...prev, ...fieldsToClear }));\n        };\n\n        const licenceUploadedUrl = formData[field.fieldName];\n\n        return (\n          <div className=\"space-y-3\">\n            {licenceExtracted && (\n              <div className=\"alert alert-success shadow-sm\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n                <div>\n                  <h3 className=\"font-bold text-sm\">Details captured from licence</h3>\n                  <p className=\"text-xs\">Please verify the information below is correct</p>\n                </div>\n                <button type=\"button\" className=\"btn btn-ghost btn-xs\" onClick={clearLicenceDataPublic}>\n                  Clear\n                </button>\n              </div>\n            )}\n\n            {licenceExtractionError && (\n              <div className=\"alert alert-warning shadow-sm\">\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                </svg>\n                <span className=\"text-sm\">{licenceExtractionError}</span>\n              </div>\n            )}\n\n            <div className=\"flex flex-col sm:flex-row gap-2\">\n              <label className=\"flex-1 cursor-pointer\">\n                <div className={`border-2 border-dashed rounded-xl p-4 text-center transition-colors ${\n                  isExtractingLicence || isLicenceUploading ? \"border-primary bg-primary/5\" :\n                  licenceUploadedUrl ? \"border-success bg-success/5\" :\n                  \"border-base-300 hover:border-primary hover:bg-primary/5\"\n                }`}>\n                  {isExtractingLicence || isLicenceUploading ? (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <span className=\"loading loading-spinner loading-md text-primary\"></span>\n                      <span className=\"text-sm text-primary\">\n                        {isLicenceUploading ? \"Uploading...\" : \"Extracting details...\"}\n                      </span>\n                    </div>\n                  ) : licenceUploadedUrl ? (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-success\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                      </svg>\n                      <span className=\"text-sm text-success font-medium\">Photo captured</span>\n                      <img src={licenceUploadedUrl} alt=\"Licence\" className=\"max-h-20 rounded-lg border mt-1\" />\n                    </div>\n                  ) : (\n                    <div className=\"flex flex-col items-center gap-2\">\n                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-base-content/40\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\" />\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 13a3 3 0 11-6 0 3 3 0 016 0z\" />\n                      </svg>\n                      <span className=\"text-sm font-medium\">Take photo or upload</span>\n                      <span className=\"text-xs text-base-content/60\">Tap to capture your driving licence</span>\n                    </div>\n                  )}\n                </div>\n                <input\n                  type=\"file\"\n                  accept=\"image/*\"\n                  capture=\"environment\"\n                  className=\"hidden\"\n                  onChange={(e) => {\n                    const file = e.target.files?.[0];\n                    if (file) {\n                      handleLicenceCapture(file);\n                    }\n                  }}\n                  disabled={isExtractingLicence || isLicenceUploading}\n                />\n              </label>\n            </div>\n\n            {helpText && <p className=\"text-sm text-base-content/60\">{helpText}</p>}\n          </div>\n        );\n\n      default:","originalFile":"import { useState, useEffect, useRef } from \"react\";\nimport Head from \"next/head\";\nimport { useRouter } from \"next/router\";\nimport dynamic from \"next/dynamic\";\nimport connectMongo from \"@/libs/mongoose\";\nimport Form from \"@/models/Form\";\nimport FormField from \"@/models/FormField\";\nimport Dealer from \"@/models/Dealer\";\nimport toast from \"react-hot-toast\";\n\n// Dynamic import for signature pad (client-side only)\nconst DrawableSignature = dynamic(() => import(\"@/components/DrawableSignature\"), {\n  ssr: false,\n  loading: () => <div className=\"h-[150px] bg-base-200 rounded-lg animate-pulse\" />\n});\n\nexport default function PublicForm({ form, fields, dealer }) {\n  const router = useRouter();\n  const [formData, setFormData] = useState({});\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isLookingUp, setIsLookingUp] = useState(false);\n  const [uploadedFiles, setUploadedFiles] = useState([]); // Track uploaded files for submission\n  const [uploadingField, setUploadingField] = useState(null); // Track which field is currently uploading\n  const [courtesyVehicles, setCourtesyVehicles] = useState([]);\n  const [stockVehicles, setStockVehicles] = useState([]);\n  const [stockSearch, setStockSearch] = useState(\"\");\n  const [showNoCourtesyVehicles, setShowNoCourtesyVehicles] = useState(false);\n  const [selectedFromStock, setSelectedFromStock] = useState(false);\n  const [manualVrmEntry, setManualVrmEntry] = useState(false);\n  // VRM suggestions for PDI/Delivery forms\n  const [vrmSuggestions, setVrmSuggestions] = useState([]);\n  const [vrmSearchActive, setVrmSearchActive] = useState(false);\n  // Licence extraction state\n  const [isExtractingLicence, setIsExtractingLicence] = useState(false);\n  const [licenceExtracted, setLicenceExtracted] = useState(false);\n  const [licenceExtractionError, setLicenceExtractionError] = useState(null);\n\n  // Load courtesy vehicles for courtesy car forms\n  useEffect(() => {\n    if (form?.type === \"COURTESY_OUT\" || form?.type === \"COURTESY_IN\") {\n      fetchCourtesyVehicles();\n    }\n    if (form?.type === \"TEST_DRIVE\") {\n      fetchStockVehicles();\n    }\n  }, [form?.type]);\n\n  // Search vehicles for VRM suggestions (PDI/Delivery)\n  const searchVrmVehicles = async (query) => {\n    if (!query || query.length < 2) {\n      setVrmSuggestions([]);\n      return;\n    }\n    try {\n      // Get statuses based on form type\n      let statuses = [];\n      if (form?.type === \"PDI\") {\n        statuses = [\"IN_PREP\", \"ADVERTISED\"];\n      } else if (form?.type === \"DELIVERY\") {\n        statuses = [\"SOLD\", \"ADVERTISED\", \"RESERVED\"];\n      }\n      const params = new URLSearchParams({ q: query });\n      if (statuses.length > 0) {\n        params.append(\"statuses\", statuses.join(\",\"));\n      }\n      const res = await fetch(`/api/vehicles/search?${params.toString()}`);\n      const data = await res.json();\n      setVrmSuggestions(data);\n    } catch (error) {\n      console.error(\"VRM search error:\", error);\n    }\n  };\n\n  // Handle vehicle selection from VRM suggestions\n  const handleVrmVehicleSelect = (vehicle) => {\n    setFormData(prev => ({\n      ...prev,\n      vrm: vehicle.vrm || vehicle.regCurrent,\n      make: vehicle.make,\n      model: vehicle.model,\n      colour: vehicle.colour,\n      mileage: vehicle.mileage,\n      _selectedVehicleId: vehicle.id,\n    }));\n    setVrmSuggestions([]);\n    setVrmSearchActive(false);\n    setSelectedFromStock(true);\n    toast.success(`Selected: ${vehicle.make} ${vehicle.model} (${vehicle.vrm || vehicle.regCurrent})`);\n  };\n\n  const fetchCourtesyVehicles = async () => {\n    try {\n      const res = await fetch(\"/api/vehicles/courtesy\");\n      const data = await res.json();\n      setCourtesyVehicles(data);\n      if (data.length === 0) {\n        setShowNoCourtesyVehicles(true);\n      }\n    } catch (error) {\n      console.error(\"Failed to fetch courtesy vehicles:\", error);\n    }\n  };\n\n  const fetchStockVehicles = async (search = \"\") => {\n    try {\n      const res = await fetch(`/api/vehicles/stock?search=${encodeURIComponent(search)}`);\n      const data = await res.json();\n      setStockVehicles(data);\n    } catch (error) {\n      console.error(\"Failed to fetch stock vehicles:\", error);\n    }\n  };\n\n  // Initialize default values for time fields (Test Drive form)\n  useEffect(() => {\n    if (form?.type === \"TEST_DRIVE\" && fields.length > 0) {\n      const now = new Date();\n      const timeField = fields.find(f => f.fieldName === \"time\" && f.type === \"TIME\");\n      const dateField = fields.find(f => f.fieldName === \"date\" && f.type === \"DATE\");\n\n      const updates = {};\n\n      // Set default time to current time (rounded to nearest 15 min)\n      if (timeField && !formData.time) {\n        const minutes = Math.round(now.getMinutes() / 15) * 15;\n        const hours = now.getHours() + (minutes >= 60 ? 1 : 0);\n        const adjustedMinutes = minutes >= 60 ? 0 : minutes;\n        updates.time = `${String(hours).padStart(2, \"0\")}:${String(adjustedMinutes).padStart(2, \"0\")}`;\n      }\n\n      // Set default date to today\n      if (dateField && !formData.date) {\n        updates.date = now.toISOString().split(\"T\")[0];\n      }\n\n      if (Object.keys(updates).length > 0) {\n        setFormData(prev => ({ ...prev, ...updates }));\n      }\n    }\n  }, [form?.type, fields]);\n\n  // Replace tokens in text with dealer info\n  const replaceTokens = (text) => {\n    if (!text || !dealer) return text;\n    return text\n      .replace(/\\{companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\")\n      .replace(/\\{dealer\\.companyName\\}/g, dealer.companyName || dealer.name || \"Our Dealership\")\n      .replace(/\\{dealer\\.companyPhone\\}/g, dealer.companyPhone || dealer.phone || \"\")\n      .replace(/\\{dealer\\.companyAddress\\}/g, dealer.companyAddress || dealer.address || \"\")\n      .replace(/\\{dealer\\.companyEmail\\}/g, dealer.companyEmail || dealer.email || \"\");\n  };\n\n  // Format terms text as bullet list\n  const formatTermsAsList = (text) => {\n    if (!text) return null;\n    const processedText = replaceTokens(text);\n\n    // Split by bullet points, dashes, or numbered items\n    const lines = processedText\n      .split(/(?:^|\\n)(?:•|●|-|\\d+\\.)\\s*/g)\n      .map(line => line.trim())\n      .filter(line => line.length > 0);\n\n    if (lines.length <= 1) {\n      // If no bullet format detected, try splitting by newlines\n      const newlineLines = processedText.split(\"\\n\").filter(line => line.trim());\n      if (newlineLines.length > 1) {\n        return (\n          <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n            {newlineLines.map((line, idx) => (\n              <li key={idx}>{line.trim().replace(/^[-•●]\\s*/, \"\")}</li>\n            ))}\n          </ul>\n        );\n      }\n      return <p className=\"text-sm text-base-content/80 whitespace-pre-wrap\">{processedText}</p>;\n    }\n\n    return (\n      <ul className=\"list-disc pl-5 space-y-2 text-sm text-base-content/80\">\n        {lines.map((line, idx) => (\n          <li key={idx}>{line}</li>\n        ))}\n      </ul>\n    );\n  };\n\n  if (!form) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-base-200\">\n        <div className=\"text-center\">\n          <h1 className=\"text-4xl font-bold mb-4\">Form Not Found</h1>\n          <p className=\"text-base-content/60\">This form does not exist or is not publicly available.</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Show no courtesy vehicles message\n  if (showNoCourtesyVehicles && (form.type === \"COURTESY_OUT\" || form.type === \"COURTESY_IN\")) {\n    return (\n      <>\n        <Head><title>{form.name} | DealerFlow</title></Head>\n        <div className=\"min-h-screen bg-base-200 flex items-center justify-center p-4\">\n          <div className=\"card bg-base-100 shadow-xl max-w-md\">\n            <div className=\"card-body text-center\">\n              <h2 className=\"card-title justify-center text-xl mb-2\">No Courtesy Vehicles Set Up</h2>\n              <p className=\"text-base-content/70 mb-4\">\n                You need at least one vehicle marked as a courtesy car to use this form.\n              </p>\n              <p className=\"text-sm text-base-content/60\">\n                Go to Sales & Prep and add a vehicle with type \"Courtesy\" to get started.\n              </p>\n            </div>\n          </div>\n        </div>\n      </>\n    );\n  }\n\n  const handleInputChange = (fieldName, value) => {\n    setFormData((prev) => ({\n      ...prev,\n      [fieldName]: value,\n    }));\n  };\n\n  const handleVrmLookup = async (fieldName) => {\n    const vrm = formData[fieldName];\n    if (!vrm) {\n      toast.error(\"Enter a registration number first\");\n      return;\n    }\n\n    setIsLookingUp(true);\n    try {\n      const res = await fetch(\"/api/dvla-lookup\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ vehicleReg: vrm }),\n      });\n      const data = await res.json();\n\n      if (res.ok && data.make) {\n        // Auto-fill related fields if they exist in the form\n        const updates = {};\n        if (data.make) updates.make = data.make;\n        if (data.model) updates.model = data.model;\n        if (data.year) updates.year = data.year;\n        if (data.colour) updates.colour = data.colour;\n        if (data.fuelType) updates.fuel_type = data.fuelType;\n\n        setFormData(prev => ({ ...prev, ...updates }));\n        toast.success(`Found: ${data.year || \"\"} ${data.make} ${data.model} - ${data.colour || \"\"}`);\n      } else {\n        toast.error(\"Vehicle not found or lookup failed\");\n      }\n    } catch (error) {\n      console.error(\"DVLA lookup error:\", error);\n      toast.error(\"Failed to lookup vehicle\");\n    } finally {\n      setIsLookingUp(false);\n    }\n  };\n\n  const handleCourtesyVehicleSelect = (vehicleId) => {\n    const vehicle = courtesyVehicles.find(v => v.id === vehicleId);\n    if (vehicle) {\n      setFormData(prev => ({\n        ...prev,\n        courtesy_vrm: vehicle.regCurrent,\n        courtesy_vehicle_id: vehicle.id,\n        courtesy_vehicle_display: `${vehicle.regCurrent} - ${vehicle.make} ${vehicle.model}`,\n      }));\n    }\n  };\n\n  const handleStockVehicleSelect = (vehicleId) => {\n    const vehicle = stockVehicles.find(v => v.id === vehicleId);\n    if (vehicle) {\n      setFormData(prev => ({\n        ...prev,\n        vrm: vehicle.regCurrent,\n        vehicle_make: vehicle.make,\n        vehicle_model: vehicle.model,\n        vehicle_interest: vehicle.displayName,\n        vehicle_id: vehicle.id,\n      }));\n      setSelectedFromStock(true);\n    }\n  };\n\n  // Check if a field should be hidden when vehicle is selected from stock\n  const shouldHideField = (field) => {\n    // Show make/model fields only if manual entry is enabled or no stock selection\n    if (manualVrmEntry) return false; // Show all fields for manual entry\n    if (!selectedFromStock) return false;\n    // Hide make/model fields when vehicle selected from stock (for TEST_DRIVE, PDI, DELIVERY)\n    const hideFields = [\"vehicle_make\", \"vehicle_model\", \"make\", \"model\"];\n    return hideFields.includes(field.fieldName);\n  };\n\n  // Upload file to server and return URL\n  const handleFileUpload = async (file, fieldName) => {\n    setUploadingField(fieldName);\n    try {\n      const formDataUpload = new FormData();\n      formDataUpload.append(\"file\", file);\n\n      const res = await fetch(\"/api/vehicles/upload\", {\n        method: \"POST\",\n        body: formDataUpload,\n      });\n\n      if (!res.ok) {\n        const err = await res.json();\n        throw new Error(err.error || \"Upload failed\");\n      }\n\n      const data = await res.json();\n\n      // Store S3 key (permanent) if available, otherwise use URL (for local dev)\n      const storedUrl = data.key || data.url;\n\n      // Store file metadata for submission\n      setUploadedFiles((prev) => [\n        ...prev.filter((f) => f.fieldName !== fieldName), // Replace if same field\n        {\n          fieldName,\n          url: storedUrl,\n          key: data.key, // S3 key for signed URL regeneration\n          filename: data.filename || file.name,\n          mimeType: data.type || file.type,\n          size: data.size || file.size,\n        },\n      ]);\n\n      // Also store URL/key in formData for database storage\n      handleInputChange(fieldName, storedUrl);\n      toast.success(\"File uploaded\");\n      return storedUrl;\n    } catch (error) {\n      console.error(\"Upload error:\", error);\n      toast.error(error.message || \"Failed to upload file\");\n      return null;\n    } finally {\n      setUploadingField(null);\n    }\n  };\n\n  const handleSubmit = async (e) => {\n    e.preventDefault();\n    setIsSubmitting(true);\n\n    try {\n      const res = await fetch(\"/api/forms/submissions\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          formId: form._id,\n          rawAnswers: formData,\n          files: uploadedFiles, // Include uploaded files\n        }),\n      });\n\n      if (!res.ok) throw new Error(\"Submission failed\");\n\n      toast.success(\"Form submitted successfully!\");\n      setFormData({});\n      setUploadedFiles([]);\n\n      setTimeout(() => {\n        router.push(\"/public/forms/thank-you\");\n      }, 1500);\n    } catch (error) {\n      console.error(\"Submission error:\", error);\n      toast.error(\"Failed to submit form. Please try again.\");\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  // Check if field is a VRM/registration field\n  const isVrmField = (field) => {\n    const vrmFieldNames = [\"vrm\", \"reg\", \"registration\", \"vehicle_reg\", \"regcurrent\", \"courtesy_vrm\"];\n    return vrmFieldNames.includes(field.fieldName.toLowerCase()) ||\n           field.label.toLowerCase().includes(\"registration\") ||\n           field.label.toLowerCase().includes(\"vrm\");\n  };\n\n  // Check if field is a courtesy vehicle selection field\n  const isCourtesyVehicleField = (field) => {\n    return (form.type === \"COURTESY_OUT\" || form.type === \"COURTESY_IN\") &&\n           (field.fieldName === \"courtesy_vrm\" || field.label.toLowerCase().includes(\"courtesy vehicle\"));\n  };\n\n  // Check if field is a stock vehicle selection field (for test drive)\n  const isStockVehicleField = (field) => {\n    return form.type === \"TEST_DRIVE\" &&\n           (field.fieldName === \"vrm\" || field.fieldName === \"vehicle_interest\" ||\n            field.label.toLowerCase().includes(\"vehicle of interest\"));\n  };\n\n  const renderField = (field) => {\n    const value = formData[field.fieldName] || \"\";\n\n    // Special handling for courtesy vehicle selection\n    if (isCourtesyVehicleField(field)) {\n      return (\n        <div className=\"space-y-2\">\n          <select\n            className=\"select select-bordered w-full\"\n            value={formData.courtesy_vehicle_id || \"\"}\n            onChange={(e) => handleCourtesyVehicleSelect(e.target.value)}\n            required={field.required}\n          >\n            <option value=\"\">Select courtesy vehicle...</option>\n            {courtesyVehicles.map((v) => (\n              <option key={v.id} value={v.id}>\n                {v.regCurrent} - {v.make} {v.model} {v.colour ? `(${v.colour})` : \"\"}\n              </option>\n            ))}\n          </select>\n          {formData.courtesy_vehicle_display && (\n            <div className=\"text-sm text-success\">Selected: {formData.courtesy_vehicle_display}</div>\n          )}\n        </div>\n      );\n    }\n\n    // Special handling for stock vehicle selection (test drive)\n    if (isStockVehicleField(field)) {\n      // If vehicle already selected from stock, show summary\n      if (selectedFromStock && formData.vehicle_interest) {\n        return (\n          <div className=\"space-y-2\">\n            <div className=\"bg-success/10 border border-success/30 rounded-lg p-4\">\n              <div className=\"flex items-center gap-2 text-success mb-2\">\n                <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                </svg>\n                <span className=\"font-semibold\">Vehicle Selected</span>\n              </div>\n              <p className=\"text-base-content font-medium\">{formData.vehicle_interest}</p>\n              {formData.vrm && (\n                <p className=\"text-sm text-base-content/70 font-mono\">{formData.vrm}</p>\n              )}\n              <button\n                type=\"button\"\n                className=\"btn btn-sm btn-ghost text-primary mt-2\"\n                onClick={() => {\n                  setSelectedFromStock(false);\n                  setManualVrmEntry(false);\n                  setFormData(prev => ({\n                    ...prev,\n                    vrm: \"\",\n                    vehicle_make: \"\",\n                    vehicle_model: \"\",\n                    vehicle_interest: \"\",\n                    vehicle_id: \"\",\n                  }));\n                }}\n              >\n                Change Vehicle\n              </button>\n            </div>\n          </div>\n        );\n      }\n\n      // Manual VRM entry mode - show plain text input\n      if (manualVrmEntry) {\n        return (\n          <div className=\"space-y-2\">\n            <input\n              type=\"text\"\n              className=\"input input-bordered w-full uppercase font-mono\"\n              placeholder=\"Enter registration (e.g. AB12 CDE)\"\n              value={formData.vrm || \"\"}\n              onChange={(e) => handleInputChange(\"vrm\", e.target.value.toUpperCase())}\n              required={field.required}\n            />\n            <div className=\"text-xs text-base-content/60\">\n              <button\n                type=\"button\"\n                className=\"link link-primary\"\n                onClick={() => {\n                  setManualVrmEntry(false);\n                  setFormData(prev => ({ ...prev, vrm: \"\", vehicle_make: \"\", vehicle_model: \"\" }));\n                }}\n              >\n                ← Search from our stock instead\n              </button>\n            </div>\n          </div>\n        );\n      }\n\n      // Stock search mode\n      return (\n        <div className=\"space-y-2\">\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            placeholder=\"Search by VRM or Make/Model...\"\n            value={stockSearch}\n            onChange={(e) => {\n              setStockSearch(e.target.value);\n              fetchStockVehicles(e.target.value);\n            }}\n          />\n          {stockVehicles.length > 0 && stockSearch && (\n            <div className=\"dropdown dropdown-open w-full\">\n              <ul className=\"dropdown-content menu p-2 shadow bg-base-100 rounded-box w-full max-h-48 overflow-y-auto\">\n                {stockVehicles.slice(0, 10).map((v) => (\n                  <li key={v.id}>\n                    <button type=\"button\" onClick={() => {\n                      handleStockVehicleSelect(v.id);\n                      setStockSearch(\"\");\n                    }}>\n                      {v.displayName}\n                    </button>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          )}\n          <div className=\"text-xs text-base-content/60\">\n            <button\n              type=\"button\"\n              className=\"link link-primary\"\n              onClick={() => {\n                setManualVrmEntry(true);\n                setStockSearch(\"\");\n              }}\n            >\n              Vehicle not listed? Enter registration manually\n            </button>\n          </div>\n        </div>\n      );\n    }\n\n    // VRM field with suggestions for PDI/Delivery, lookup button for others\n    if (isVrmField(field) && field.type === \"TEXT\") {\n      const showVrmSuggestions = form?.type === \"PDI\" || form?.type === \"DELIVERY\";\n\n      // Show selected vehicle info if vehicle was selected from suggestions\n      if (showVrmSuggestions && selectedFromStock && formData._selectedVehicleId) {\n        return (\n          <div className=\"space-y-2\">\n            <div className=\"bg-success/10 border border-success/30 rounded-lg p-4\">\n              <div className=\"flex items-center gap-2 text-success mb-2\">\n                <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                </svg>\n                <span className=\"font-semibold\">Vehicle Selected</span>\n              </div>\n              <p className=\"font-mono font-bold text-lg\">{formData.vrm}</p>\n              {formData.make && formData.model && (\n                <p className=\"text-sm text-base-content/70\">{formData.make} {formData.model}</p>\n              )}\n              <button\n                type=\"button\"\n                className=\"btn btn-sm btn-ghost text-primary mt-2\"\n                onClick={() => {\n                  setSelectedFromStock(false);\n                  setFormData(prev => ({\n                    ...prev,\n                    vrm: \"\",\n                    make: \"\",\n                    model: \"\",\n                    colour: \"\",\n                    mileage: \"\",\n                    _selectedVehicleId: \"\",\n                  }));\n                }}\n              >\n                Change Vehicle\n              </button>\n            </div>\n          </div>\n        );\n      }\n\n      return (\n        <div className=\"relative\">\n          <div className=\"flex gap-2\">\n            <input\n              type=\"text\"\n              className=\"input input-bordered flex-1 uppercase font-mono\"\n              value={value}\n              onChange={(e) => {\n                const newValue = e.target.value.toUpperCase();\n                handleInputChange(field.fieldName, newValue);\n                // Trigger VRM suggestions for PDI/Delivery\n                if (showVrmSuggestions) {\n                  searchVrmVehicles(newValue);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onFocus={() => {\n                if (showVrmSuggestions && value && value.length >= 2) {\n                  searchVrmVehicles(value);\n                  setVrmSearchActive(true);\n                }\n              }}\n              onBlur={() => {\n                // Delay hiding to allow click on suggestion\n                setTimeout(() => setVrmSearchActive(false), 200);\n              }}\n              required={field.required}\n              placeholder={showVrmSuggestions ? \"Search or enter VRM...\" : \"AB12 CDE\"}\n            />\n            <button\n              type=\"button\"\n              className=\"btn btn-secondary\"\n              onClick={() => handleVrmLookup(field.fieldName)}\n              disabled={isLookingUp}\n              title=\"DVLA Lookup\"\n            >\n              {isLookingUp ? <span className=\"loading loading-spinner loading-sm\"></span> : \"Lookup\"}\n            </button>\n          </div>\n          {/* VRM suggestions dropdown for PDI/Delivery */}\n          {showVrmSuggestions && vrmSearchActive && vrmSuggestions.length > 0 && (\n            <div className=\"absolute z-50 w-full mt-1 bg-base-100 border border-base-300 rounded-lg shadow-lg max-h-60 overflow-y-auto\">\n              <div className=\"text-xs text-base-content/60 px-3 py-1 border-b border-base-200 bg-base-200/50\">\n                Select from stock or use Lookup for external search\n              </div>\n              {vrmSuggestions.map((vehicle) => (\n                <button\n                  key={vehicle.id}\n                  type=\"button\"\n                  className=\"w-full px-3 py-2 text-left hover:bg-primary/10 border-b border-base-200 last:border-0\"\n                  onClick={() => handleVrmVehicleSelect(vehicle)}\n                >\n                  <div className=\"font-mono font-bold\">{vehicle.vrm || vehicle.regCurrent}</div>\n                  <div className=\"text-sm text-base-content/70\">\n                    {vehicle.make} {vehicle.model} {vehicle.year ? `(${vehicle.year})` : \"\"} - {vehicle.colour || \"\"}\n                  </div>\n                </button>\n              ))}\n            </div>\n          )}\n        </div>\n      );\n    }\n\n    // Standard field rendering\n    switch (field.type) {\n      case \"TEXT\":\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"TEXTAREA\":\n        return (\n          <textarea\n            className=\"textarea textarea-bordered w-full\"\n            rows={4}\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"NUMBER\":\n        return (\n          <input\n            type=\"number\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"DATE\":\n        return (\n          <input\n            type=\"date\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"DATETIME\":\n        return (\n          <input\n            type=\"datetime-local\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"TIME\":\n        return (\n          <input\n            type=\"time\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n\n      case \"DROPDOWN\":\n        const dropdownOptions = field.options?.values || field.options?.choices || [];\n        return (\n          <select\n            className=\"select select-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          >\n            <option value=\"\">Select...</option>\n            {dropdownOptions.map((opt) => (\n              <option key={opt} value={opt}>{opt}</option>\n            ))}\n          </select>\n        );\n\n      case \"RADIO\":\n        const radioOptions = field.options?.values || field.options?.choices || [];\n        return (\n          <div className=\"flex flex-wrap gap-4\">\n            {radioOptions.map((opt) => (\n              <label key={opt} className=\"label cursor-pointer gap-2\">\n                <input\n                  type=\"radio\"\n                  name={field.fieldName}\n                  className=\"radio radio-primary\"\n                  value={opt}\n                  checked={value === opt}\n                  onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n                  required={field.required && !value}\n                />\n                <span className=\"label-text\">{opt}</span>\n              </label>\n            ))}\n          </div>\n        );\n\n      case \"BOOLEAN\":\n        return (\n          <div className=\"form-control\">\n            <label className=\"label cursor-pointer justify-start gap-4\">\n              <input\n                type=\"checkbox\"\n                className=\"checkbox checkbox-primary\"\n                checked={value === true}\n                onChange={(e) => handleInputChange(field.fieldName, e.target.checked)}\n              />\n              <span className=\"label-text\">Yes</span>\n            </label>\n          </div>\n        );\n\n      case \"RATING\":\n        return (\n          <div className=\"rating rating-lg\">\n            {[1, 2, 3, 4, 5].map((star) => (\n              <input\n                key={star}\n                type=\"radio\"\n                name={`rating-${field.fieldName}`}\n                className=\"mask mask-star-2 bg-orange-400\"\n                checked={value === star}\n                onChange={() => handleInputChange(field.fieldName, star)}\n              />\n            ))}\n          </div>\n        );\n\n      case \"FILE\":\n        const isUploading = uploadingField === field.fieldName;\n        const uploadedUrl = formData[field.fieldName];\n        const isImage = uploadedUrl && (uploadedUrl.includes(\"image\") || /\\.(jpg|jpeg|png|gif|webp)$/i.test(uploadedUrl));\n\n        return (\n          <div className=\"space-y-2\">\n            <input\n              type=\"file\"\n              className=\"file-input file-input-bordered w-full\"\n              disabled={isUploading}\n              accept=\"image/*,video/*,.pdf,.doc,.docx\"\n              onChange={(e) => {\n                const file = e.target.files[0];\n                if (file) {\n                  handleFileUpload(file, field.fieldName);\n                }\n              }}\n            />\n            {isUploading && (\n              <div className=\"flex items-center gap-2 text-sm text-base-content/60\">\n                <span className=\"loading loading-spinner loading-sm\"></span>\n                Uploading...\n              </div>\n            )}\n            {uploadedUrl && !isUploading && (\n              <div className=\"mt-2\">\n                {isImage ? (\n                  <img src={uploadedUrl} alt=\"Uploaded\" className=\"max-h-32 rounded-lg border\" />\n                ) : (\n                  <a\n                    href={uploadedUrl}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"link link-primary text-sm\"\n                  >\n                    View uploaded file\n                  </a>\n                )}\n              </div>\n            )}\n          </div>\n        );\n\n      case \"SIGNATURE\":\n        return (\n          <DrawableSignature\n            value={value || \"\"}\n            onChange={(signatureData) => handleInputChange(field.fieldName, signatureData)}\n            required={field.required}\n            label=\"\"\n            helpText=\"Please sign in the box above\"\n          />\n        );\n\n      default:\n        return (\n          <input\n            type=\"text\"\n            className=\"input input-bordered w-full\"\n            value={value}\n            onChange={(e) => handleInputChange(field.fieldName, e.target.value)}\n            required={field.required}\n          />\n        );\n    }\n  };\n\n  return (\n    <>\n      <Head>\n        <title>{form.name} | DealerFlow</title>\n      </Head>\n\n      <div className=\"min-h-screen bg-base-200 py-12 px-4\">\n        <div className=\"max-w-3xl mx-auto\">\n          {/* Header */}\n          <div className=\"card bg-base-100 shadow-xl mb-6\">\n            <div className=\"card-body\">\n              {/* Dealer Logo */}\n              {dealer?.logoUrl && (\n                <div className=\"flex justify-center mb-4\">\n                  <img\n                    src={dealer.logoUrl}\n                    alt={dealer.name || \"Dealer Logo\"}\n                    className=\"h-16 object-contain\"\n                  />\n                </div>\n              )}\n              <h1 className=\"text-3xl font-bold text-center\">{form.name}</h1>\n              {dealer?.name && !dealer?.logoUrl && (\n                <p className=\"text-center text-base-content/60 mt-1\">{dealer.name}</p>\n              )}\n            </div>\n          </div>\n\n          {/* Intro Text */}\n          {form.introText && (\n            <div className=\"card bg-base-100 shadow-xl mb-6\">\n              <div className=\"card-body\">\n                <p className=\"text-base-content/80 whitespace-pre-wrap\">{replaceTokens(form.introText)}</p>\n              </div>\n            </div>\n          )}\n\n          {/* Form */}\n          <form onSubmit={handleSubmit}>\n            <div className=\"card bg-base-100 shadow-xl\">\n              <div className=\"card-body space-y-6\">\n                {fields.filter(field => field.visible !== false).map((field) => {\n                  // Handle SECTION_HEADER type\n                  if (field.type === \"SECTION_HEADER\") {\n                    // Check if this is the Terms section - render terms text\n                    if (field.fieldName === \"_section_terms\" && form.termsText) {\n                      return (\n                        <div key={field._id} className=\"pt-4 mt-4 border-t border-base-200\">\n                          <h3 className=\"text-lg font-bold text-primary mb-4\">{field.label}</h3>\n                          <div className=\"bg-base-200/50 rounded-lg p-4\">\n                            {formatTermsAsList(form.termsText)}\n                          </div>\n                        </div>\n                      );\n                    }\n                    return (\n                      <div key={field._id} className=\"pt-4 mt-4 border-t border-base-200\">\n                        <h3 className=\"text-lg font-bold text-primary\">{field.label}</h3>\n                      </div>\n                    );\n                  }\n\n                  // Handle PARAGRAPH type (display-only text)\n                  if (field.type === \"PARAGRAPH\") {\n                    return (\n                      <div key={field._id} className=\"text-sm text-base-content/70 -mt-2\">\n                        {field.label}\n                      </div>\n                    );\n                  }\n\n                  // Handle PDI_ISSUES type (repeatable issue entry - matches stock board Add Issue modal)\n                  if (field.type === \"PDI_ISSUES\") {\n                    const issues = formData.pdi_issues || [];\n                    const addIssue = () => {\n                      setFormData(prev => ({\n                        ...prev,\n                        pdi_issues: [...(prev.pdi_issues || []), {\n                          category: \"\",\n                          subcategory: \"\",\n                          description: \"\",\n                          actionNeeded: \"\",\n                          status: \"outstanding\",\n                          notes: \"\",\n                        }]\n                      }));\n                    };\n                    const updateIssue = (index, key, value) => {\n                      setFormData(prev => {\n                        const newIssues = [...(prev.pdi_issues || [])];\n                        newIssues[index] = { ...newIssues[index], [key]: value };\n                        return { ...prev, pdi_issues: newIssues };\n                      });\n                    };\n                    const removeIssue = (index) => {\n                      setFormData(prev => ({\n                        ...prev,\n                        pdi_issues: prev.pdi_issues.filter((_, i) => i !== index)\n                      }));\n                    };\n                    // Exact same categories as stock board Add Issue modal\n                    const ISSUE_SUBCATEGORIES = {\n                      mechanical: [\"Engine\", \"Transmission\", \"Suspension\", \"Brakes\", \"Exhaust\", \"Other\"],\n                      electrical: [\"Battery\", \"Lights\", \"Starter Motor\", \"Alternator\", \"Sensors\", \"Other\"],\n                      bodywork: [\"Panel Damage\", \"Scratches\", \"Dents\", \"Bumper\", \"Windscreen\", \"Other\"],\n                      interior: [\"Seats\", \"Dashboard\", \"Trim\", \"Carpet\", \"Controls\", \"Other\"],\n                      tyres: [\"Tread Depth\", \"Puncture\", \"Alloys\", \"Alignment\", \"Other\"],\n                      mot: [\"Advisory\", \"Failed Item\", \"Due Soon\", \"Other\"],\n                      service: [\"Oil Change\", \"Filters\", \"Fluids\", \"Timing Belt\", \"Other\"],\n                      fault_codes: [\"Engine\", \"Transmission\", \"ABS\", \"Airbag\", \"Emissions\", \"Other\"],\n                      other: [\"General\", \"Misc\"],\n                    };\n\n                    return (\n                      <div key={field._id} className=\"space-y-4\">\n                        {issues.map((issue, idx) => (\n                          <div key={idx} className=\"bg-base-200 rounded-lg p-4 space-y-3\">\n                            <div className=\"flex justify-between items-center\">\n                              <span className=\"font-semibold text-sm\">Issue #{idx + 1}</span>\n                              <button\n                                type=\"button\"\n                                className=\"btn btn-ghost btn-xs text-error\"\n                                onClick={() => removeIssue(idx)}\n                              >\n                                Remove\n                              </button>\n                            </div>\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                              <div className=\"form-control\">\n                                <label className=\"label py-1\"><span className=\"label-text text-xs\">Category *</span></label>\n                                <select\n                                  className=\"select select-bordered select-sm w-full\"\n                                  value={issue.category}\n                                  onChange={(e) => {\n                                    updateIssue(idx, \"category\", e.target.value);\n                                    updateIssue(idx, \"subcategory\", \"\"); // Reset subcategory\n                                  }}\n                                  required\n                                >\n                                  <option value=\"\">Select category...</option>\n                                  <option value=\"mechanical\">Mechanical</option>\n                                  <option value=\"electrical\">Electrical</option>\n                                  <option value=\"bodywork\">Bodywork</option>\n                                  <option value=\"interior\">Interior</option>\n                                  <option value=\"tyres\">Tyres</option>\n                                  <option value=\"mot\">MOT</option>\n                                  <option value=\"service\">Service</option>\n                                  <option value=\"fault_codes\">Fault Codes</option>\n                                  <option value=\"other\">Other</option>\n                                </select>\n                              </div>\n                              {issue.category && (\n                                <div className=\"form-control\">\n                                  <label className=\"label py-1\"><span className=\"label-text text-xs\">Subcategory</span></label>\n                                  <select\n                                    className=\"select select-bordered select-sm w-full\"\n                                    value={issue.subcategory}\n                                    onChange={(e) => updateIssue(idx, \"subcategory\", e.target.value)}\n                                  >\n                                    <option value=\"\">Select subcategory...</option>\n                                    {(ISSUE_SUBCATEGORIES[issue.category] || []).map(sub => (\n                                      <option key={sub} value={sub}>{sub}</option>\n                                    ))}\n                                  </select>\n                                </div>\n                              )}\n                            </div>\n                            <div className=\"form-control\">\n                              <label className=\"label py-1\"><span className=\"label-text text-xs\">Description *</span></label>\n                              <textarea\n                                className=\"textarea textarea-bordered textarea-sm w-full\"\n                                rows={3}\n                                placeholder=\"Describe the issue...\"\n                                value={issue.description}\n                                onChange={(e) => updateIssue(idx, \"description\", e.target.value)}\n                                required\n                              />\n                            </div>\n                            <div className=\"form-control\">\n                              <label className=\"label py-1\"><span className=\"label-text text-xs\">Action Needed</span></label>\n                              <input\n                                type=\"text\"\n                                className=\"input input-bordered input-sm w-full\"\n                                placeholder=\"What needs to be done?\"\n                                value={issue.actionNeeded || \"\"}\n                                onChange={(e) => updateIssue(idx, \"actionNeeded\", e.target.value)}\n                              />\n                            </div>\n                            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                              <div className=\"form-control\">\n                                <label className=\"label py-1\"><span className=\"label-text text-xs\">Status</span></label>\n                                <select\n                                  className=\"select select-bordered select-sm w-full\"\n                                  value={issue.status || \"outstanding\"}\n                                  onChange={(e) => updateIssue(idx, \"status\", e.target.value)}\n                                >\n                                  <option value=\"outstanding\">Outstanding</option>\n                                  <option value=\"ordered\">Ordered</option>\n                                  <option value=\"in_progress\">In Progress</option>\n                                  <option value=\"resolved\">Resolved</option>\n                                </select>\n                              </div>\n                            </div>\n                            <div className=\"form-control\">\n                              <label className=\"label py-1\"><span className=\"label-text text-xs\">Notes</span></label>\n                              <textarea\n                                className=\"textarea textarea-bordered textarea-sm w-full\"\n                                rows={2}\n                                placeholder=\"Additional notes...\"\n                                value={issue.notes || \"\"}\n                                onChange={(e) => updateIssue(idx, \"notes\", e.target.value)}\n                              />\n                            </div>\n                          </div>\n                        ))}\n                        <button\n                          type=\"button\"\n                          className=\"btn btn-outline btn-primary w-full\"\n                          onClick={addIssue}\n                        >\n                          <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4v16m8-8H4\" />\n                          </svg>\n                          Add Issue\n                        </button>\n                      </div>\n                    );\n                  }\n\n                  // Hide make/model fields when vehicle selected from stock\n                  if (shouldHideField(field)) {\n                    return null;\n                  }\n\n                  return (\n                    <div key={field._id} className=\"form-control\">\n                      <label className=\"label\">\n                        <span className=\"label-text font-semibold\">\n                          {field.label}\n                          {field.required && !shouldHideField(field) && <span className=\"text-error ml-1\">*</span>}\n                        </span>\n                      </label>\n                      {renderField(field)}\n                    </div>\n                  );\n                })}\n\n                <div className=\"card-actions justify-end mt-8\">\n                  <button\n                    type=\"submit\"\n                    className=\"btn btn-primary btn-lg\"\n                    disabled={isSubmitting}\n                  >\n                    {isSubmitting ? (\n                      <>\n                        <span className=\"loading loading-spinner\"></span>\n                        Submitting...\n                      </>\n                    ) : (\n                      \"Submit\"\n                    )}\n                  </button>\n                </div>\n              </div>\n            </div>\n          </form>\n        </div>\n      </div>\n    </>\n  );\n}\n\nexport async function getServerSideProps({ params }) {\n  try {\n    await connectMongo();\n\n    // Find form by slug - allow SHARE_LINK and PUBLIC visibility (or legacy isPublic: true)\n    const form = await Form.findOne({\n      publicSlug: params.slug,\n      $or: [\n        { visibility: { $in: [\"SHARE_LINK\", \"PUBLIC\"] } },\n        { visibility: { $exists: false }, isPublic: true }, // Legacy compatibility\n      ]\n    }).lean();\n\n    if (!form) {\n      return { props: { form: null, fields: [], dealer: null } };\n    }\n\n    const fields = await FormField.find({ formId: form._id })\n      .sort({ order: 1 })\n      .lean();\n\n    // Get dealer info for logo\n    const dealer = await Dealer.findOne().lean();\n\n    return {\n      props: {\n        form: JSON.parse(JSON.stringify(form)),\n        fields: JSON.parse(JSON.stringify(fields)),\n        dealer: dealer ? JSON.parse(JSON.stringify(dealer)) : null,\n      },\n    };\n  } catch (error) {\n    console.error(\"Error loading form:\", error);\n    return { props: { form: null, fields: [], dealer: null } };\n  }\n}\n","structuredPatch":[{"oldStart":841,"oldLines":6,"newStart":841,"newLines":169,"lines":["           />","         );"," ","+      case \"LICENCE_SCAN\":","+        // Licence scan with OCR extraction","+        const isLicenceUploading = uploadingField === field.fieldName;","+","+        const handleLicenceCapture = async (file) => {","+          if (!file) return;","+","+          setIsExtractingLicence(true);","+          setLicenceExtractionError(null);","+          setLicenceExtracted(false);","+","+          // First upload the file","+          await handleFileUpload(file, field.fieldName);","+","+          try {","+            // Convert file to base64 for extraction","+            const reader = new FileReader();","+            reader.onload = async () => {","+              const base64 = reader.result.split(\",\")[1];","+              const mimeType = file.type || \"image/jpeg\";","+","+              // Call extraction API","+              const res = await fetch(\"/api/forms/test-drive/extract-licence\", {","+                method: \"POST\",","+                headers: { \"Content-Type\": \"application/json\" },","+                body: JSON.stringify({ image: base64, mimeType }),","+              });","+","+              const data = await res.json();","+","+              if (data.ok && data.data) {","+                const extracted = data.data;","+                const updates = {};","+","+                // Map extracted fields to form field names using autoFillFromLicence config","+                fields.forEach((f) => {","+                  if (f.autoFillFromLicence && extracted[f.autoFillFromLicence]) {","+                    updates[f.fieldName] = extracted[f.autoFillFromLicence];","+                  }","+                });","+","+                if (Object.keys(updates).length > 0) {","+                  setFormData((prev) => ({ ...prev, ...updates }));","+                  setLicenceExtracted(true);","+                  toast.success(\"Details captured from licence - please verify\");","+                } else {","+                  setLicenceExtractionError(\"Could not extract details. Please enter manually.\");","+                }","+              } else {","+                setLicenceExtractionError(data.error || \"Could not extract details. Please enter manually.\");","+              }","+","+              setIsExtractingLicence(false);","+            };","+","+            reader.onerror = () => {","+              setLicenceExtractionError(\"Failed to read file. Please try again.\");","+              setIsExtractingLicence(false);","+            };","+","+            reader.readAsDataURL(file);","+          } catch (error) {","+            console.error(\"Licence extraction error:\", error);","+            setLicenceExtractionError(\"Failed to process licence. Please enter details manually.\");","+            setIsExtractingLicence(false);","+          }","+        };","+","+        const clearLicenceDataPublic = () => {","+          handleInputChange(field.fieldName, null);","+          setLicenceExtracted(false);","+          setLicenceExtractionError(null);","+","+          const fieldsToClear = {};","+          fields.forEach((f) => {","+            if (f.autoFillFromLicence) {","+              fieldsToClear[f.fieldName] = \"\";","+            }","+          });","+          setFormData((prev) => ({ ...prev, ...fieldsToClear }));","+        };","+","+        const licenceUploadedUrl = formData[field.fieldName];","+","+        return (","+          <div className=\"space-y-3\">","+            {licenceExtracted && (","+              <div className=\"alert alert-success shadow-sm\">","+                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">","+                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />","+                </svg>","+                <div>","+                  <h3 className=\"font-bold text-sm\">Details captured from licence</h3>","+                  <p className=\"text-xs\">Please verify the information below is correct</p>","+                </div>","+                <button type=\"button\" className=\"btn btn-ghost btn-xs\" onClick={clearLicenceDataPublic}>","+                  Clear","+                </button>","+              </div>","+            )}","+","+            {licenceExtractionError && (","+              <div className=\"alert alert-warning shadow-sm\">","+                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"stroke-current shrink-0 h-5 w-5\" fill=\"none\" viewBox=\"0 0 24 24\">","+                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />","+                </svg>","+                <span className=\"text-sm\">{licenceExtractionError}</span>","+              </div>","+            )}","+","+            <div className=\"flex flex-col sm:flex-row gap-2\">","+              <label className=\"flex-1 cursor-pointer\">","+                <div className={`border-2 border-dashed rounded-xl p-4 text-center transition-colors ${","+                  isExtractingLicence || isLicenceUploading ? \"border-primary bg-primary/5\" :","+                  licenceUploadedUrl ? \"border-success bg-success/5\" :","+                  \"border-base-300 hover:border-primary hover:bg-primary/5\"","+                }`}>","+                  {isExtractingLicence || isLicenceUploading ? (","+                    <div className=\"flex flex-col items-center gap-2\">","+                      <span className=\"loading loading-spinner loading-md text-primary\"></span>","+                      <span className=\"text-sm text-primary\">","+                        {isLicenceUploading ? \"Uploading...\" : \"Extracting details...\"}","+                      </span>","+                    </div>","+                  ) : licenceUploadedUrl ? (","+                    <div className=\"flex flex-col items-center gap-2\">","+                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-success\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">","+                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />","+                      </svg>","+                      <span className=\"text-sm text-success font-medium\">Photo captured</span>","+                      <img src={licenceUploadedUrl} alt=\"Licence\" className=\"max-h-20 rounded-lg border mt-1\" />","+                    </div>","+                  ) : (","+                    <div className=\"flex flex-col items-center gap-2\">","+                      <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-8 w-8 text-base-content/40\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">","+                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z\" />","+                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 13a3 3 0 11-6 0 3 3 0 016 0z\" />","+                      </svg>","+                      <span className=\"text-sm font-medium\">Take photo or upload</span>","+                      <span className=\"text-xs text-base-content/60\">Tap to capture your driving licence</span>","+                    </div>","+                  )}","+                </div>","+                <input","+                  type=\"file\"","+                  accept=\"image/*\"","+                  capture=\"environment\"","+                  className=\"hidden\"","+                  onChange={(e) => {","+                    const file = e.target.files?.[0];","+                    if (file) {","+                      handleLicenceCapture(file);","+                    }","+                  }}","+                  disabled={isExtractingLicence || isLicenceUploading}","+                />","+              </label>","+            </div>","+","+            {helpText && <p className=\"text-sm text-base-content/60\">{helpText}</p>}","+          </div>","+        );","+","       default:","         return (","           <input"]}],"userModified":false,"replaceAll":false}}
{"parentUuid":"ba0b83c0-d1d7-4e04-9f88-6e122d5f1f3b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_014vZXL3afs5zLAz6wvhxhPC","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"All the implementation is done. Now let me update the todo list to mark all tasks as completed.","signature":"EocCCkYICxgCKkDGp2eLmasQj4hEsi7Bfv4+16jUNpQiwNeNeB1JJQVOP50r4fP3hL/8oG6H9V4KNi4QfWt6aa2EgDXy65OwnamFEgzzh67rZxgTJVbaTtUaDNXkBrjQaEWVO9jIMyIwFk5mhfKn9/ZhYIgU/3rTeq6Q+VLJH9j4hW6qBkKG8HqL6JI9uD3O3q0UL8VKHI3OKm8DKy5DBTYLc0zNYcQ1i0R4fx1U/mhixyVHvkPehjZugk31FZXWtpFqpWycoMU47HgJlGd1GLCMWdm2JhzHuWDtBnvSseO9rOnSuzz8maaGiYQwvnQ3iVphh04J8bAZb/W5hkIh5rpV1kH77+xA5AAYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":5696,"cache_read_input_tokens":105365,"cache_creation":{"ephemeral_5m_input_tokens":5696,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9VxHJa2JMhAPeSPPbh","type":"assistant","uuid":"53d37e33-adf3-49de-a25c-58fe96e80a4b","timestamp":"2025-12-30T15:58:13.986Z"}
{"parentUuid":"53d37e33-adf3-49de-a25c-58fe96e80a4b","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_014vZXL3afs5zLAz6wvhxhPC","type":"message","role":"assistant","content":[{"type":"text","text":"All tasks are now complete. Let me update the todo list:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":5696,"cache_read_input_tokens":105365,"cache_creation":{"ephemeral_5m_input_tokens":5696,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWd9VxHJa2JMhAPeSPPbh","type":"assistant","uuid":"d1737185-1496-4a13-b56a-785d3bb82ae3","timestamp":"2025-12-30T15:58:14.399Z"}
{"parentUuid":"d1737185-1496-4a13-b56a-785d3bb82ae3","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_014vZXL3afs5zLAz6wvhxhPC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01FfUzYtsk1F5h2Mtre8ztV5","name":"TodoWrite","input":{"todos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"completed","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"completed","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"completed","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"completed","activeForm":"Implementing Test Drive licence OCR extraction"}]}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":5696,"cache_read_input_tokens":105365,"cache_creation":{"ephemeral_5m_input_tokens":5696,"ephemeral_1h_input_tokens":0},"output_tokens":240,"service_tier":"standard"}},"requestId":"req_011CWd9VxHJa2JMhAPeSPPbh","type":"assistant","uuid":"266a09a4-bca9-4d9d-897d-7409a9a24799","timestamp":"2025-12-30T15:58:17.272Z"}
{"parentUuid":"266a09a4-bca9-4d9d-897d-7409a9a24799","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01FfUzYtsk1F5h2Mtre8ztV5","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"uuid":"fa123303-a6f2-4ffe-8dc5-7863fd662338","timestamp":"2025-12-30T15:58:17.340Z","toolUseResult":{"oldTodos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"completed","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"completed","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"completed","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"in_progress","activeForm":"Implementing Test Drive licence OCR extraction"}],"newTodos":[{"content":"Fix Quick Add menu z-index/layout bug","status":"completed","activeForm":"Fixing Quick Add menu z-index/layout bug"},{"content":"Add New Appraisal and Add Vehicle to Quick Add menu","status":"completed","activeForm":"Adding new Quick Add menu items"},{"content":"Debug and fix AI service issues + update error styling","status":"completed","activeForm":"Debugging and fixing AI service issues"},{"content":"Implement Test Drive licence OCR extraction","status":"completed","activeForm":"Implementing Test Drive licence OCR extraction"}]}}
{"parentUuid":"fa123303-a6f2-4ffe-8dc5-7863fd662338","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UG8c3wxSduhMspZCTKjrLb","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"All tasks have been completed. Let me provide a summary of all the changes made.","signature":"EvgBCkYICxgCKkDaiV0HaIsuqYsgk0QJStFOBbxHQXMGPFSi9CnHCgHbuPENYFyr7ljgRmWi/+d4hGR1GvWUvaIiyAFKQe2PplHDEgy+6z3Za+O1UTPWqf0aDC0HU+ytdoL2Jrc+hyIwu0HK2gBzSd29EPJlkQSMx7KkNGkK+RPAB5aPoW7DUHpN4KYZArKtrpDLR1cHTpuMKmDjcNJ/PVtWvnPj1MoIX9yOorrJrlifyn0O/16A9RqLv6elRNcM2DvG9ZRK1aP5CxHx3YqqTcpcaQxgkbL265R1XKsMnEKpbyPOnyNj9wD2YR/HXxBa4j8MF5iTcGEvi0gYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":289,"cache_read_input_tokens":111061,"cache_creation":{"ephemeral_5m_input_tokens":289,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWd9WnVDdn86CFf1Y6oVA","type":"assistant","uuid":"23402f1e-e8ac-4119-97ae-95f39cdbb83c","timestamp":"2025-12-30T15:58:24.261Z"}
{"parentUuid":"23402f1e-e8ac-4119-97ae-95f39cdbb83c","isSidechain":false,"userType":"external","cwd":"C:\\Users\\georg\\dealerflow","sessionId":"9abfc40b-fb9d-411c-b020-2ca4919865cf","version":"2.0.76","gitBranch":"main","slug":"cosmic-nibbling-axolotl","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UG8c3wxSduhMspZCTKjrLb","type":"message","role":"assistant","content":[{"type":"text","text":"## Summary\n\nI've completed all 4 tasks:\n\n### 1. Quick Add Menu Z-Index/Layout Bug Fix\n- Updated `components/DashboardLayout.js:494` - Changed dropdown z-index from `z-50` to `z-[9999]` to ensure it renders above all page content\n\n### 2. New Quick Add Items\n- Added \"New Appraisal\" and \"Add Vehicle\" items to the Quick Add menu in `components/DashboardLayout.js:496-508`\n- Updated `pages/sales-prep.js` to handle `?addVehicle=1` query parameter, automatically opening the Add Vehicle modal\n\n### 3. AI Service Issues + Error Styling\n- **Health endpoint**: Updated `pages/api/ai/health.js` to use `withDealerContext` for authentication and return structured error codes\n- **OpenAI library**: Enhanced `libs/openai.js` with better error handling for rate limits (429), service unavailable (500/502/503), and bad requests (400)\n- **AI Suggestions Panel**: Updated `components/AISuggestionsPanel.js` with proper error display using DaisyUI `alert` styling and user-friendly error messages based on error codes\n- **Warranty page**: Updated `pages/warranty.js` to pass error codes to the AI panel and handle auth errors (401/403) separately\n- **API endpoints**: Updated `warranty-suggestions.js` and `appraisal-issue-suggestions.js` to return `errorCode` in responses\n\n### 4. Test Drive Licence OCR Extraction\n- **New API endpoint**: Created `pages/api/forms/test-drive/extract-licence.js` that uses OpenAI Vision (gpt-4o-mini) to extract UK driving licence details\n- **Updated form template**: Modified `libs/formTemplates.js` to add the new `LICENCE_SCAN` field type with `autoFillFromLicence` mapping for form fields\n- **Internal form filler**: Added `LICENCE_SCAN` field type handling in `pages/forms/fill/[id].js` with:\n  - Camera/upload UI with drag-and-drop styling\n  - Auto-fill of form fields (name, address, postcode)\n  - Success/error banners\n  - Clear scanned data option\n- **Public form filler**: Added the same `LICENCE_SCAN` functionality to `pages/public/forms/[slug].js` for customer-facing forms\n\nThe licence OCR extracts: full name, first name, last name, date of birth, address lines, town, postcode, licence number, issue date, expiry date, and confidence level."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":289,"cache_read_input_tokens":111061,"cache_creation":{"ephemeral_5m_input_tokens":289,"ephemeral_1h_input_tokens":0},"output_tokens":642,"service_tier":"standard"}},"requestId":"req_011CWd9WnVDdn86CFf1Y6oVA","type":"assistant","uuid":"ebb76308-6c79-4563-8c61-e2345b08efc4","timestamp":"2025-12-30T15:58:36.492Z"}
