     1→/**
     2→ * DVLA Vehicle Enquiry Service API Integration
     3→ *
     4→ * Uses the official DVLA VES API to lookup vehicle details by registration number.
     5→ * API Documentation: https://developer-portal.driver-vehicle-licensing.api.gov.uk/
     6→ *
     7→ * Returns normalized vehicle data using shared normalizer.
     8→ */
     9→
    10→import { normalizeVrm, normalizeDvlaResponse } from "@/libs/vehicle/normalizeVrmLookup";
    11→
    12→export default async function handler(req, res) {
    13→  if (req.method !== "POST") {
    14→    return res.status(405).json({ error: "Method not allowed" });
    15→  }
    16→
    17→  const { vehicleReg } = req.body;
    18→  if (!vehicleReg) {
    19→    return res.status(400).json({ error: "Vehicle registration required" });
    20→  }
    21→
    22→  // Normalize VRM: trim, uppercase, remove all spaces
    23→  const cleanReg = vehicleReg.trim().toUpperCase().replace(/\s+/g, "");
    24→
    25→  // Basic format validation
    26→  if (cleanReg.length < 2 || cleanReg.length > 8) {
    27→    return res.status(400).json({
    28→      error: "Invalid registration format",
    29→      errorCode: "INVALID_FORMAT",
    30→      message: "Registration number must be between 2 and 8 characters",
    31→    });
    32→  }
    33→
    34→  const apiKey = process.env.DVLA_API_KEY;
    35→
    36→  // If no API key, return dummy data for development
    37→  if (!apiKey) {
    38→    if (process.env.NODE_ENV === "development") {
    39→      console.warn("[DVLA] API key not configured - returning dummy data");
    40→      return res.status(200).json(generateDummyData(cleanReg));
    41→    }
    42→    // In production, return proper error
    43→    return res.status(503).json({
    44→      error: "DVLA integration not configured",
    45→      errorCode: "NOT_CONFIGURED",
    46→      message: "DVLA lookup is not available. Please contact support.",
    47→    });
    48→  }
    49→
    50→  try {
    51→    const response = await fetch(
    52→      "https://driver-vehicle-licensing.api.gov.uk/vehicle-enquiry/v1/vehicles",
    53→      {
    54→        method: "POST",
    55→        headers: {
    56→          "Content-Type": "application/json",
    57→          "x-api-key": apiKey,
    58→        },
    59→        body: JSON.stringify({
    60→          registrationNumber: cleanReg,
    61→        }),
    62→      }
    63→    );
    64→
    65→    if (!response.ok) {
    66→      const errorText = await response.text();
    67→      if (process.env.NODE_ENV === "development") {
    68→        console.log(`[DVLA] Response status: ${response.status}`);
    69→      }
    70→      console.error("[DVLA] API error:", response.status, errorText);
    71→
    72→      // Handle specific error codes
    73→      if (response.status === 404) {
    74→        return res.status(404).json({
    75→          error: "VRM not found",
    76→          errorCode: "NOT_FOUND",
    77→          message: "No vehicle found with this registration number. Please check the VRM and try again.",
    78→        });
    79→      }
    80→
    81→      if (response.status === 400) {
    82→        return res.status(400).json({
    83→          error: "Invalid registration",
    84→          errorCode: "INVALID_FORMAT",
    85→          message: "The registration number format is invalid.",
    86→        });
    87→      }
    88→
    89→      if (response.status === 401) {
    90→        return res.status(503).json({
    91→          error: "DVLA integration not configured",
    92→          errorCode: "AUTH_FAILED",
    93→          message: "DVLA API authentication failed. Please contact support.",
    94→        });
    95→      }
    96→
    97→      if (response.status === 403) {
    98→        return res.status(503).json({
    99→          error: "DVLA integration not configured",
   100→          errorCode: "ACCESS_DENIED",
   101→          message: "DVLA API access denied. Please contact support.",
   102→        });
   103→      }
   104→
   105→      return res.status(503).json({
   106→        error: "DVLA service unavailable",
   107→        errorCode: "SERVICE_ERROR",
   108→        message: "Unable to retrieve vehicle details. Please try again later.",
   109→      });
   110→    }
   111→
   112→    if (process.env.NODE_ENV === "development") {
   113→      console.log(`[DVLA] Response status: ${response.status} - Success`);
   114→    }
   115→
   116→    const data = await response.json();
   117→
   118→    // Use shared normalizer for consistent response shape
   119→    const normalizedData = normalizeDvlaResponse(data);
   120→
   121→    // Build dvlaDetails object for storage
   122→    const dvlaDetails = {
   123→      co2Emissions: data.co2Emissions || null,
   124→      engineCapacity: data.engineCapacity || null,
   125→      fuelType: data.fuelType || null,
   126→      markedForExport: data.markedForExport || false,
   127→      monthOfFirstRegistration: data.monthOfFirstRegistration || null,
   128→      motStatus: data.motStatus || null,
   129→      motExpiryDate: data.motExpiryDate || null,
   130→      revenueWeight: data.revenueWeight || null,
   131→      taxDueDate: data.taxDueDate || null,
   132→      taxStatus: data.taxStatus || null,
   133→      yearOfManufacture: data.yearOfManufacture || null,
   134→      euroStatus: data.euroStatus || null,
   135→      dateOfLastV5CIssued: data.dateOfLastV5CIssued || null,
   136→      wheelplan: data.wheelplan || null,
   137→      typeApproval: data.typeApproval || null,
   138→    };
   139→
   140→    // Also include legacy field names for backwards compatibility
   141→    const vehicleData = {
   142→      ...normalizedData,
   143→      // Legacy field mappings
   144→      isDummy: false,
   145→      registrationNumber: normalizedData.vrm,
   146→      yearOfManufacture: normalizedData.year,
   147→      // Flag if model is missing (needs manual entry)
   148→      modelMissing: !normalizedData.model || normalizedData.model.trim() === "",
   149→      // Full DVLA details for storage
   150→      dvlaDetails,
   151→      lastDvlaFetchAt: new Date().toISOString(),
   152→    };
   153→
   154→    return res.status(200).json(vehicleData);
   155→  } catch (error) {
   156→    console.error("[DVLA] Network error:", error.message);
   157→
   158→    // In development, fall back to dummy data
   159→    if (process.env.NODE_ENV === "development") {
   160→      console.warn("[DVLA] Falling back to dummy data due to connection error");
   161→      return res.status(200).json(generateDummyData(cleanReg));
   162→    }
   163→
   164→    // In production, return service unavailable
   165→    return res.status(503).json({
   166→      error: "DVLA service unavailable",
   167→      errorCode: "NETWORK_ERROR",
   168→      message: "Unable to connect to DVLA service. Please try again later.",
   169→    });
   170→  }
   171→}
   172→
   173→/**
   174→ * Generate dummy data for development when API key is not configured
   175→ */
   176→function generateDummyData(vehicleReg) {
   177→  // Generate varied MOT dates for testing
   178→  const rand = Math.random();
   179→  let daysOffset;
   180→  let motStatus;
   181→
   182→  if (rand < 0.3) {
   183→    daysOffset = -Math.floor(Math.random() * 90);
   184→    motStatus = "Not valid";
   185→  } else if (rand < 0.5) {
   186→    daysOffset = Math.floor(Math.random() * 30);
   187→    motStatus = "Valid";
   188→  } else {
   189→    daysOffset = Math.floor(Math.random() * 365) + 30;
   190→    motStatus = "Valid";
   191→  }
   192→
   193→  const motExpiryDate = new Date();
   194→  motExpiryDate.setDate(motExpiryDate.getDate() + daysOffset);
   195→  const motExpiryStr = motExpiryDate.toISOString().split("T")[0];
   196→
   197→  // Create raw DVLA-like data
   198→  const rawData = {
   199→    registrationNumber: vehicleReg,
   200→    make: "FORD",
   201→    model: "FOCUS",
   202→    colour: "BLUE",
   203→    yearOfManufacture: 2019,
   204→    engineCapacity: 1500,
   205→    fuelType: "PETROL",
   206→    transmission: "MANUAL",
   207→    taxStatus: "Taxed",
   208→    taxDueDate: "2025-03-01",
   209→    motStatus: motStatus,
   210→    motExpiryDate: motExpiryStr,
   211→  };
   212→
   213→  // Normalize using shared normalizer
   214→  const normalizedData = normalizeDvlaResponse(rawData);
   215→
   216→  // Build dvlaDetails object
   217→  const dvlaDetails = {
   218→    co2Emissions: rawData.co2Emissions || null,
   219→    engineCapacity: rawData.engineCapacity || null,
   220→    fuelType: rawData.fuelType || null,
   221→    markedForExport: rawData.markedForExport || false,
   222→    monthOfFirstRegistration: rawData.monthOfFirstRegistration || null,
   223→    motStatus: rawData.motStatus || null,
   224→    motExpiryDate: rawData.motExpiryDate || null,
   225→    revenueWeight: rawData.revenueWeight || null,
   226→    taxDueDate: rawData.taxDueDate || null,
   227→    taxStatus: rawData.taxStatus || null,
   228→    yearOfManufacture: rawData.yearOfManufacture || null,
   229→    euroStatus: rawData.euroStatus || null,
   230→    dateOfLastV5CIssued: rawData.dateOfLastV5CIssued || null,
   231→    wheelplan: rawData.wheelplan || null,
   232→    typeApproval: rawData.typeApproval || null,
   233→  };
   234→
   235→  return {
   236→    ...normalizedData,
   237→    isDummy: true,
   238→    message: "DVLA API not configured - showing demo data",
   239→    // Legacy field mappings
   240→    registrationNumber: normalizedData.vrm,
   241→    yearOfManufacture: normalizedData.year,
   242→    modelMissing: false,
   243→    // Full DVLA details for storage
   244→    dvlaDetails,
   245→    lastDvlaFetchAt: new Date().toISOString(),
   246→  };
   247→}
   248→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
