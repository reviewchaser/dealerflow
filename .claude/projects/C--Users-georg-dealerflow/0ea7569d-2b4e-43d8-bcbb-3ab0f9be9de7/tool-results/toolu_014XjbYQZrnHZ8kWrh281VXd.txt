   800→          <div className="flex items-center justify-center h-full">
   801→            <span className="loading loading-spinner loading-lg text-[#0066CC]"></span>
   802→          </div>
   803→        ) : fetchError ? (
   804→          <div className="flex flex-col items-center justify-center h-full p-6">
   805→            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
   806→              <svg className="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   807→                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
   808→              </svg>
   809→            </div>
   810→            <p className="text-lg font-semibold text-slate-900 mb-1">Failed to load deal</p>
   811→            <p className="text-sm text-slate-500 text-center mb-4">{fetchError}</p>
   812→            <div className="flex gap-2">
   813→              <button className="btn btn-ghost" onClick={onClose}>
   814→                Close
   815→              </button>
   816→              <button className="btn bg-[#0066CC] hover:bg-[#0052a3] text-white border-none" onClick={fetchDeal}>
   817→                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   818→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
   819→                </svg>
   820→                Retry
   821→              </button>
   822→            </div>
   823→          </div>
   824→        ) : !deal ? (
   825→          <div className="flex flex-col items-center justify-center h-full p-6">
   826→            <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
   827→              <svg className="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   828→                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   829→              </svg>
   830→            </div>
   831→            <p className="text-lg font-semibold text-slate-900 mb-1">Deal not found</p>
   832→            <p className="text-sm text-slate-500 text-center mb-4">This deal may have been deleted or you may not have access</p>
   833→            <button className="btn btn-ghost" onClick={onClose}>
   834→              Close
   835→            </button>
   836→          </div>
   837→        ) : (
   838→          <>
   839→            {/* Header */}
   840→            <div className="sticky top-0 bg-white border-b border-slate-100 px-4 md:px-6 py-4 md:py-5 z-10 shrink-0 shadow-sm">
   841→              <div className="flex items-center justify-between">
   842→                <div className="flex items-center gap-3">
   843→                  <button
   844→                    className="flex items-center justify-center w-9 h-9 rounded-xl bg-slate-100 hover:bg-[#0066CC]/10 text-slate-500 hover:text-[#0066CC] transition-all"
   845→                    onClick={onClose}
   846→                  >
   847→                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   848→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
   849→                    </svg>
   850→                  </button>
   851→                  <div>
   852→                    <h2 className="text-lg md:text-xl font-bold text-slate-900">
   853→                      Deal #{deal.dealNumber || "—"}
   854→                    </h2>
   855→                    <div className="flex items-center gap-2 mt-1">
   856→                      <span className={`inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-semibold ${statusConfig.color}`}>
   857→                        {statusConfig.label}
   858→                      </span>
   859→                      {deal.vehicle && (
   860→                        <span className="inline-flex items-center px-2.5 py-1 rounded-lg bg-slate-900 text-white text-xs font-mono font-bold tracking-wider">
   861→                          {deal.vehicle.regCurrent}
   862→                        </span>
   863→                      )}
   864→                    </div>
   865→                  </div>
   866→                </div>
   867→                {/* Document buttons */}
   868→                <div className="flex items-center gap-2">
   869→                  {documents.depositReceipt && (
   870→                    <a
   871→                      href={documents.depositReceipt.shareUrl}
   872→                      target="_blank"
   873→                      rel="noopener noreferrer"
   874→                      className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-amber-100 hover:bg-amber-200 text-amber-700 text-xs font-medium transition-colors"
   875→                      title="View Deposit Receipt"
   876→                    >
   877→                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   878→                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   879→                      </svg>
   880→                      <span className="hidden md:inline">Receipt</span>
   881→                    </a>
   882→                  )}
   883→                  {documents.invoice && (
   884→                    <a
   885→                      href={documents.invoice.shareUrl}
   886→                      target="_blank"
   887→                      rel="noopener noreferrer"
   888→                      className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs font-medium transition-colors"
   889→                      title="View Invoice"
   890→                    >
   891→                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   892→                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   893→                      </svg>
   894→                      <span className="hidden md:inline">Invoice</span>
   895→                    </a>
   896→                  )}
   897→                  {documents.invoice && (
   898→                    <button
   899→                      onClick={handleOpenHandover}
   900→                      className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-emerald-100 hover:bg-emerald-200 text-emerald-700 text-xs font-medium transition-colors"
   901→                      title="Generate Handover Pack"
   902→                    >
   903→                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   904→                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
   905→                      </svg>
   906→                      <span className="hidden md:inline">Handover</span>
   907→                    </button>
   908→                  )}
   909→                  <button
   910→                    className="flex items-center justify-center w-9 h-9 rounded-xl bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 transition-all"
   911→                    onClick={onClose}
   912→                  >
   913→                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   914→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   915→                    </svg>
   916→                  </button>
   917→                </div>
   918→              </div>
   919→            </div>
   920→
   921→            {/* Tabs */}
   922→            <div className="sticky top-[73px] md:top-[89px] bg-white border-b border-slate-100 px-4 py-3 z-10 shrink-0">
   923→              {/* Mobile: Dropdown selector */}
   924→              <div className="md:hidden">
   925→                <select
   926→                  value={activeTab}
   927→                  onChange={(e) => setActiveTab(e.target.value)}
   928→                  className="select select-bordered w-full font-medium"
   929→                >
   930→                  <option value="overview">Summary</option>
   931→                  <option value="customer">Customer</option>
   932→                  <option value="addons">Add-ons ({deal.addOns?.length || 0})</option>
   933→                  <option value="payments">Payments ({deal.payments?.length || 0})</option>
   934→                </select>
   935→              </div>
   936→
   937→              {/* Desktop: Pill tabs */}
   938→              <div className="hidden md:flex items-center gap-2 overflow-x-auto pb-1 -mb-1">
   939→                {[
   940→                  { id: "overview", label: "Summary" },
   941→                  { id: "customer", label: "Customer" },
   942→                  { id: "addons", label: "Add-ons", count: deal.addOns?.length },
   943→                  { id: "payments", label: "Payments", count: deal.payments?.length },
   944→                ].map((tab) => (
   945→                  <button
   946→                    key={tab.id}
   947→                    onClick={() => setActiveTab(tab.id)}
   948→                    className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${
   949→                      activeTab === tab.id
   950→                        ? "bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25"
   951→                        : "bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-slate-900"
   952→                    }`}
   953→                  >
   954→                    <span>{tab.label}</span>
   955→                    {tab.count > 0 && (
   956→                      <span className={`inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold ${
   957→                        activeTab === tab.id
   958→                          ? "bg-white/20 text-white"
   959→                          : "bg-slate-200 text-slate-600"
   960→                      }`}>
   961→                        {tab.count}
   962→                      </span>
   963→                    )}
   964→                  </button>
   965→                ))}
   966→              </div>
   967→            </div>
   968→
   969→            {/* Content */}
   970→            <div
   971→              className="p-4 md:p-6 space-y-4 md:space-y-6 flex-1 overflow-y-auto overflow-x-hidden min-w-0 overscroll-contain"
   972→              style={{ paddingBottom: "calc(96px + env(safe-area-inset-bottom, 0px))" }}
   973→            >
   974→              {/* Overview Tab */}
   975→              {activeTab === "overview" && (
   976→                <div className="space-y-4">
   977→                  {/* Deal Readiness - Show for Draft deals */}
   978→                  {deal.status === "DRAFT" && (() => {
   979→                    const checks = getReadinessChecks();
   980→                    const passedCount = checks.filter(c => c.passed).length;
   981→                    const allPassed = passedCount === checks.length;
   982→                    return (
   983→                      <div className={`rounded-2xl border shadow-sm overflow-hidden ${
   984→                        allPassed ? "bg-emerald-50 border-emerald-200" : "bg-amber-50 border-amber-200"
   985→                      }`}>
   986→                        <div className="px-4 py-3 border-b border-inherit">
   987→                          <div className="flex items-center justify-between">
   988→                            <h3 className="text-sm font-bold text-slate-800">Deal Readiness</h3>
   989→                            <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${
   990→                              allPassed ? "bg-emerald-100 text-emerald-700" : "bg-amber-100 text-amber-700"
   991→                            }`}>
   992→                              {passedCount}/{checks.length} complete
   993→                            </span>
   994→                          </div>
   995→                        </div>
   996→                        <div className="p-4 grid grid-cols-2 gap-2">
   997→                          {checks.map((check) => (
   998→                            <div
   999→                              key={check.id}
  1000→                              className={`flex items-center gap-2 text-sm ${
  1001→                                check.passed ? "text-emerald-700" : "text-amber-700"
  1002→                              }`}
  1003→                            >
  1004→                              {check.passed ? (
  1005→                                <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  1006→                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
  1007→                                </svg>
  1008→                              ) : (
  1009→                                <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  1010→                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  1011→                                </svg>
  1012→                              )}
  1013→                              <span className={check.passed ? "" : "font-medium"}>
  1014→                                {check.tab && !check.passed ? (
  1015→                                  <button
  1016→                                    onClick={() => setActiveTab(check.tab)}
  1017→                                    className="underline hover:no-underline"
  1018→                                  >
  1019→                                    {check.label}
  1020→                                  </button>
  1021→                                ) : (
  1022→                                  check.label
  1023→                                )}
  1024→                              </span>
  1025→                            </div>
  1026→                          ))}
  1027→                        </div>
  1028→                      </div>
  1029→                    );
  1030→                  })()}
  1031→
  1032→                  {/* Sale Classification Section */}
  1033→                  {deal.status === "DRAFT" && (
  1034→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
  1035→                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
  1036→                        <h3 className="text-sm font-bold text-slate-800">Sale Classification</h3>
  1037→                      </div>
  1038→                      <div className="p-4 space-y-4">
  1039→                        {/* Step 1: Sale Type */}
  1040→                        <div>
  1041→                          <label className="block text-xs font-medium text-slate-500 mb-1.5">Sale Type</label>
  1042→                          <div className="flex flex-wrap gap-2">
  1043→                            {SALE_TYPE_OPTIONS.map((opt) => (
  1044→                              <button
  1045→                                key={opt.value}
  1046→                                onClick={() => handleUpdateField({
  1047→                                  saleType: opt.value,
  1048→                                  // Reset dependent fields when sale type changes
  1049→                                  ...(opt.value !== "RETAIL" ? { buyerUse: null, saleChannel: null } : {})
  1050→                                })}
  1051→                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
  1052→                                  deal.saleType === opt.value
  1053→                                    ? "bg-[#0066CC] text-white"
  1054→                                    : "bg-slate-100 text-slate-600 hover:bg-slate-200"
  1055→                                }`}
  1056→                                title={opt.description}
  1057→                              >
  1058→                                {opt.label}
  1059→                              </button>
  1060→                            ))}
  1061→                          </div>
  1062→                        </div>
  1063→
  1064→                        {/* Step 2: Buyer Use - Only for Retail */}
  1065→                        {deal.saleType === "RETAIL" && (
  1066→                          <div>
  1067→                            <label className="block text-xs font-medium text-slate-500 mb-1.5">Buyer Use</label>
  1068→                            <div className="flex flex-wrap gap-2">
  1069→                              {BUYER_USE_OPTIONS.map((opt) => (
  1070→                                <button
  1071→                                  key={opt.value}
  1072→                                  onClick={() => handleUpdateField({ buyerUse: opt.value })}
  1073→                                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
  1074→                                    deal.buyerUse === opt.value
  1075→                                      ? "bg-[#0066CC] text-white"
  1076→                                      : "bg-slate-100 text-slate-600 hover:bg-slate-200"
  1077→                                  }`}
  1078→                                  title={opt.description}
  1079→                                >
  1080→                                  {opt.label}
  1081→                                </button>
  1082→                              ))}
  1083→                            </div>
  1084→                          </div>
  1085→                        )}
  1086→
  1087→                        {/* Step 3: Sale Channel - Only for Retail */}
  1088→                        {deal.saleType === "RETAIL" && (
  1089→                          <div>
  1090→                            <label className="block text-xs font-medium text-slate-500 mb-1.5">Sale Channel</label>
  1091→                            <div className="flex flex-wrap gap-2">
  1092→                              {SALE_CHANNEL_OPTIONS.map((opt) => (
  1093→                                <button
  1094→                                  key={opt.value}
  1095→                                  onClick={() => handleUpdateField({ saleChannel: opt.value })}
  1096→                                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
  1097→                                    deal.saleChannel === opt.value
  1098→                                      ? "bg-[#0066CC] text-white"
  1099→                                      : "bg-slate-100 text-slate-600 hover:bg-slate-200"
  1100→                                  }`}
  1101→                                  title={opt.description}
  1102→                                >
  1103→                                  {opt.label}
  1104→                                </button>
  1105→                              ))}
  1106→                            </div>
  1107→                            {deal.saleChannel === "DISTANCE" && (
  1108→                              <p className="text-xs text-amber-600 mt-2 flex items-center gap-1">
  1109→                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  1110→                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
  1111→                                </svg>
  1112→                                14-day cooling off period applies
  1113→                              </p>
  1114→                            )}
  1115→                          </div>
  1116→                        )}
  1117→
  1118→                        {/* Step 4: Business Details - For Trade or Business buyers */}
  1119→                        {(deal.saleType === "TRADE" || deal.buyerUse === "BUSINESS") && (
  1120→                          <div className="border-t border-slate-100 pt-4 space-y-3">
  1121→                            <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide">Business Details</h4>
  1122→                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
  1123→                              <div>
  1124→                                <label className="block text-xs text-slate-500 mb-1">Company Name</label>
  1125→                                <input
  1126→                                  type="text"
  1127→                                  className="input input-sm input-bordered w-full"
  1128→                                  placeholder="Company name"
  1129→                                  value={deal.businessDetails?.companyName || ""}
  1130→                                  onChange={(e) => handleUpdateField({
  1131→                                    businessDetails: { ...deal.businessDetails, companyName: e.target.value }
  1132→                                  })}
  1133→                                />
  1134→                              </div>
  1135→                              <div>
  1136→                                <label className="block text-xs text-slate-500 mb-1">Company Reg Number</label>
  1137→                                <input
  1138→                                  type="text"
  1139→                                  className="input input-sm input-bordered w-full"
  1140→                                  placeholder="e.g., 12345678"
  1141→                                  value={deal.businessDetails?.companyRegNumber || ""}
  1142→                                  onChange={(e) => handleUpdateField({
  1143→                                    businessDetails: { ...deal.businessDetails, companyRegNumber: e.target.value }
  1144→                                  })}
  1145→                                />
  1146→                              </div>
  1147→                              <div className="md:col-span-2">
  1148→                                <label className="block text-xs text-slate-500 mb-1">VAT Number</label>
  1149→                                <input
  1150→                                  type="text"
  1151→                                  className="input input-sm input-bordered w-full"
  1152→                                  placeholder="e.g., GB 123 4567 89"
  1153→                                  value={deal.businessDetails?.vatNumber || ""}
  1154→                                  onChange={(e) => handleUpdateField({
  1155→                                    businessDetails: { ...deal.businessDetails, vatNumber: e.target.value }
  1156→                                  })}
  1157→                                />
  1158→                              </div>
  1159→                            </div>
  1160→                          </div>
  1161→                        )}
  1162→
  1163→                        {/* VAT Treatment */}
  1164→                        <div className="border-t border-slate-100 pt-4">
  1165→                          <label className="block text-xs font-medium text-slate-500 mb-1.5">VAT Treatment</label>
  1166→                          <div className="flex flex-wrap gap-2">
  1167→                            {[
  1168→                              { value: "MARGIN", label: "Margin Scheme" },
  1169→                              { value: "VAT_QUALIFYING", label: "Standard VAT" },
  1170→                              { value: "NO_VAT", label: "Zero-rated / No VAT" },
  1171→                            ].map((opt) => (
  1172→                              <button
  1173→                                key={opt.value}
  1174→                                onClick={() => handleUpdateField({ vatScheme: opt.value })}
  1175→                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
  1176→                                  deal.vatScheme === opt.value
  1177→                                    ? "bg-[#0066CC] text-white"
  1178→                                    : "bg-slate-100 text-slate-600 hover:bg-slate-200"
  1179→                                }`}
  1180→                              >
  1181→                                {opt.label}
  1182→                              </button>
  1183→                            ))}
  1184→                          </div>
  1185→                        </div>
  1186→
  1187→                        {/* Settlement Method */}
  1188→                        <div className="border-t border-slate-100 pt-4">
  1189→                          <label className="block text-xs font-medium text-slate-500 mb-1.5">How will this be paid?</label>
  1190→                          <div className="flex flex-wrap gap-2">
  1191→                            {PAYMENT_TYPE_OPTIONS.map((opt) => (
  1192→                              <button
  1193→                                key={opt.value}
  1194→                                onClick={() => handleUpdateField({ paymentType: opt.value })}
  1195→                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
  1196→                                  deal.paymentType === opt.value
  1197→                                    ? "bg-[#0066CC] text-white"
  1198→                                    : "bg-slate-100 text-slate-600 hover:bg-slate-200"
  1199→                                }`}

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
