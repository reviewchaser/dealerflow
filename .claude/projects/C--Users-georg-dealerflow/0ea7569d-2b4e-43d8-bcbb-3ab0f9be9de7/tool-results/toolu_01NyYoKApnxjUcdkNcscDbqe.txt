  4630→      </BottomSheet>
  4631→
  4632→      {/* VRM Search Dropdown - Portal for proper positioning outside overflow containers */}
  4633→      {showVrmDropdown && (
  4634→        <Portal>
  4635→          <div
  4636→            ref={vrmDropdownRef}
  4637→            className="fixed bg-white rounded-xl shadow-2xl border border-slate-200 overflow-hidden"
  4638→            style={{
  4639→              top: getVrmDropdownPosition().top,
  4640→              left: getVrmDropdownPosition().left,
  4641→              width: Math.min(getVrmDropdownPosition().width, window.innerWidth - 32),
  4642→              maxWidth: 'calc(100vw - 2rem)',
  4643→              zIndex: 99999,
  4644→            }}
  4645→          >
  4646→            {vrmSearchResults.length > 0 ? (
  4647→              <>
  4648→                <ul className="py-1 max-h-64 overflow-y-auto">
  4649→                  {vrmSearchResults.map((vehicle, idx) => {
  4650→                    const vrm = (vehicle.regCurrent || "").toUpperCase();
  4651→                    const duplicateCount = vrmSearchResults.filter(v => (v.regCurrent || "").toUpperCase() === vrm).length;
  4652→                    const isFirstOfDuplicate = idx === vrmSearchResults.findIndex(v => (v.regCurrent || "").toUpperCase() === vrm);
  4653→                    const isSelected = idx === vrmSelectedIndex;
  4654→
  4655→                    return (
  4656→                      <li key={vehicle.id || vehicle._id}>
  4657→                        <button
  4658→                          className={`w-full px-4 py-3 text-left transition-colors border-b border-slate-50 last:border-0 ${isSelected ? "bg-blue-50" : "hover:bg-slate-50"}`}
  4659→                          onClick={() => handleVrmSelect(vehicle)}
  4660→                          onMouseEnter={() => setVrmSelectedIndex(idx)}
  4661→                        >
  4662→                          <div className="flex items-center justify-between gap-2 mb-1">
  4663→                            <div className="flex items-center gap-2">
  4664→                              <span className="font-mono font-bold text-slate-900 text-sm">{vehicle.regCurrent || vehicle.vrm}</span>
  4665→                              {duplicateCount > 1 && isFirstOfDuplicate && (
  4666→                                <span className="text-[10px] px-1.5 py-0.5 rounded bg-green-100 text-green-700 font-semibold">
  4667→                                  Latest
  4668→                                </span>
  4669→                              )}
  4670→                            </div>
  4671→                            <span className="text-[10px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 font-medium">
  4672→                              {getStatusLabel(vehicle.status)}
  4673→                            </span>
  4674→                          </div>
  4675→                          <div className="flex items-center justify-between text-xs">
  4676→                            <span className="text-slate-600">{vehicle.make} {vehicle.model} {vehicle.year || ""}</span>
  4677→                            <span className="text-slate-400">
  4678→                              Added: {formatStockDate(vehicle.createdAt)}
  4679→                            </span>
  4680→                          </div>
  4681→                        </button>
  4682→                      </li>
  4683→                    );
  4684→                  })}
  4685→                </ul>
  4686→                <div className="px-3 py-2 bg-slate-50 border-t text-xs text-slate-500 flex items-center justify-between">
  4687→                  <span>Click to select vehicle</span>
  4688→                  <span className="text-slate-400">↑↓ Navigate • Enter to select</span>
  4689→                </div>
  4690→              </>
  4691→            ) : vrmSearch.length >= 2 ? (
  4692→              <div className="px-4 py-6 text-center">
  4693→                <svg className="w-8 h-8 mx-auto text-slate-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
  4694→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  4695→                </svg>
  4696→                <p className="text-sm text-slate-500">No vehicles found</p>
  4697→              </div>
  4698→            ) : (
  4699→              <div className="px-4 py-4 text-center">
  4700→                <p className="text-sm text-slate-500">Type 2+ characters to search</p>
  4701→              </div>
  4702→            )}
  4703→          </div>
  4704→        </Portal>
  4705→      )}
  4706→    </DashboardLayout>
  4707→  );
  4708→}
  4709→
  4710→function AddVehicleModal({ onClose, onSuccess }) {
  4711→  const [isLoading, setIsLoading] = useState(false);
  4712→  const [isLookingUp, setIsLookingUp] = useState(false);
  4713→  const [locations, setLocations] = useState([]);
  4714→  const [prepTemplates, setPrepTemplates] = useState([]);
  4715→  const [formData, setFormData] = useState({
  4716→    regCurrent: "", make: "", model: "", year: "", mileageCurrent: "",
  4717→    fuelType: "", transmission: "", colour: "", notes: "", locationId: "",
  4718→    motExpiryDate: "", // MOT expiry date (autofilled from lookup or manual entry)
  4719→    engineCapacity: "", // Engine capacity in cc (autofilled from lookup or manual entry)
  4720→    type: "STOCK", // STOCK, COURTESY, FLEET_OTHER
  4721→    saleType: "RETAIL", // RETAIL, TRADE - only used when type is STOCK
  4722→    dvlaDetails: null, // DVLA VES extended details
  4723→    lastDvlaFetchAt: null, // When DVLA lookup was performed
  4724→  });
  4725→
  4726→  // Appraisal lookup state
  4727→  const [matchedAppraisal, setMatchedAppraisal] = useState(null);
  4728→  const [isCheckingAppraisal, setIsCheckingAppraisal] = useState(false);
  4729→  const [appraisalDismissed, setAppraisalDismissed] = useState(false);

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
