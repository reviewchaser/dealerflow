     1→import { useState, useEffect } from "react";
     2→import { useRouter } from "next/router";
     3→import { useSession, signIn } from "next-auth/react";
     4→import Head from "next/head";
     5→import Link from "next/link";
     6→import toast from "react-hot-toast";
     7→
     8→export default function CreateDealer() {
     9→  const router = useRouter();
    10→  const { data: session, status } = useSession();
    11→  const [formData, setFormData] = useState({
    12→    name: "",
    13→    logoUrl: "",
    14→  });
    15→  const [loading, setLoading] = useState(false);
    16→  const [uploading, setUploading] = useState(false);
    17→  const [logoPreview, setLogoPreview] = useState(null);
    18→  const [checkingMembership, setCheckingMembership] = useState(true);
    19→
    20→  // Redirect to sign-in if not authenticated
    21→  useEffect(() => {
    22→    if (status === "unauthenticated") {
    23→      signIn(undefined, { callbackUrl: "/onboarding/create-dealer" });
    24→    }
    25→  }, [status]);
    26→
    27→  // Check if user already has a dealer
    28→  useEffect(() => {
    29→    if (status !== "authenticated") return;
    30→
    31→    fetch("/api/dealer")
    32→      .then((res) => res.json())
    33→      .then((data) => {
    34→        if (data && data._id) {
    35→          // User already has a dealer, redirect to onboarding or dashboard
    36→          if (data.completedOnboarding) {
    37→            router.replace("/dashboard");
    38→          } else {
    39→            router.replace("/onboarding");
    40→          }
    41→        } else {
    42→          setCheckingMembership(false);
    43→        }
    44→      })
    45→      .catch(() => {
    46→        setCheckingMembership(false);
    47→      });
    48→  }, [status, router]);
    49→
    50→  const handleLogoUpload = async (e) => {
    51→    const file = e.target.files?.[0];
    52→    if (!file) return;
    53→
    54→    // Client-side validation
    55→    const allowedTypes = ["image/png", "image/jpeg", "image/jpg", "image/webp", "image/gif"];
    56→    if (!allowedTypes.includes(file.type)) {
    57→      toast.error("Please upload an image file (PNG, JPEG, WebP, or GIF)");
    58→      return;
    59→    }
    60→
    61→    const maxSize = 5 * 1024 * 1024; // 5MB
    62→    if (file.size > maxSize) {
    63→      toast.error(`File too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Maximum is 5MB.`);
    64→      return;
    65→    }
    66→
    67→    setUploading(true);
    68→    const formDataUpload = new FormData();
    69→    formDataUpload.append("file", file);
    70→
    71→    try {
    72→      const res = await fetch("/api/vehicles/upload", { method: "POST", body: formDataUpload });
    73→
    74→      const contentType = res.headers.get("content-type") || "";
    75→      if (!contentType.includes("application/json")) {
    76→        if (process.env.NODE_ENV !== "production") {
    77→          console.error("[Logo Upload] Non-JSON response:", res.status);
    78→        }
    79→        toast.error("Upload failed (LOGO_UPLOAD_SERVER_ERROR)");
    80→        return;
    81→      }
    82→
    83→      const data = await res.json();
    84→
    85→      if (res.ok) {
    86→        setLogoPreview(data.url);
    87→        setFormData({ ...formData, logoUrl: data.url });
    88→        toast.success("Logo uploaded!");
    89→      } else {
    90→        const errorMsg = data.error || "Failed to upload logo";
    91→        const errorCode = data.code || "UNKNOWN";
    92→        if (process.env.NODE_ENV !== "production") {
    93→          console.error("[Logo Upload] Error:", errorCode, errorMsg, data.details);
    94→        }
    95→        toast.error(`${errorMsg} (${errorCode})`);
    96→      }
    97→    } catch (err) {
    98→      if (process.env.NODE_ENV !== "production") {
    99→        console.error("[Logo Upload] Exception:", err);
   100→      }
   101→      toast.error("Upload failed (LOGO_UPLOAD_NETWORK_ERROR)");
   102→    } finally {
   103→      setUploading(false);
   104→    }
   105→  };
   106→
   107→  const handleSubmit = async (e) => {
   108→    e.preventDefault();
   109→
   110→    if (!formData.name.trim()) {
   111→      toast.error("Please enter a dealership name");
   112→      return;
   113→    }
   114→
   115→    setLoading(true);
   116→
   117→    try {
   118→      const res = await fetch("/api/onboarding/create-dealer", {
   119→        method: "POST",
   120→        headers: { "Content-Type": "application/json" },
   121→        body: JSON.stringify({
   122→          name: formData.name.trim(),
   123→          logoUrl: formData.logoUrl,
   124→        }),
   125→      });
   126→
   127→      const data = await res.json();
   128→
   129→      if (res.ok) {
   130→        toast.success("Dealership created!");
   131→        // Redirect to main onboarding to complete setup
   132→        router.push("/onboarding");
   133→      } else {
   134→        toast.error(data.error || "Failed to create dealership");
   135→        setLoading(false);
   136→      }
   137→    } catch {
   138→      toast.error("An error occurred");
   139→      setLoading(false);
   140→    }
   141→  };
   142→
   143→  // Show loading while checking auth or membership
   144→  if (status === "loading" || checkingMembership) {
   145→    return (
   146→      <div className="min-h-screen flex items-center justify-center bg-base-200">
   147→        <Head><title>Create Dealership | DealerHQ</title></Head>
   148→        <span className="loading loading-spinner loading-lg text-primary"></span>
   149→      </div>
   150→    );
   151→  }
   152→
   153→  // Don't render if not authenticated
   154→  if (status === "unauthenticated") {
   155→    return (
   156→      <div className="min-h-screen flex items-center justify-center bg-base-200">
   157→        <span className="loading loading-spinner loading-lg text-primary"></span>
   158→      </div>
   159→    );
   160→  }
   161→
   162→  return (
   163→    <>
   164→      <Head>
   165→        <title>Create Your Dealership | DealerHQ</title>
   166→      </Head>
   167→
   168→      <div className="min-h-screen bg-base-200 flex items-center justify-center p-4">
   169→        <div className="card bg-base-100 shadow-xl w-full max-w-md">
   170→          <div className="card-body">
   171→            {/* Header */}
   172→            <div className="text-center mb-6">
   173→              <div className="flex items-center justify-center gap-2 mb-2">
   174→                <svg className="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   175→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
   176→                </svg>
   177→                <span className="text-xl font-bold">DealerHQ</span>
   178→              </div>
   179→              <h1 className="text-2xl font-bold">Create Your Dealership</h1>
   180→              <p className="text-sm text-base-content/60 mt-1">
   181→                Welcome, {session?.user?.name || session?.user?.email}! Let's set up your dealership.
   182→              </p>
   183→            </div>
   184→
   185→            <form onSubmit={handleSubmit} className="space-y-6">
   186→              {/* Logo Upload */}
   187→              <div className="form-control">
   188→                <label className="label">
   189→                  <span className="label-text font-medium">Dealership Logo</span>
   190→                  <span className="label-text-alt text-base-content/50">Optional</span>
   191→                </label>
   192→                <div className="flex items-center gap-4">
   193→                  <div className="w-20 h-20 rounded-xl bg-base-200 flex items-center justify-center overflow-hidden border-2 border-dashed border-base-300">
   194→                    {logoPreview ? (
   195→                      <img src={logoPreview} alt="Logo" className="w-full h-full object-contain" />
   196→                    ) : (
   197→                      <svg className="w-8 h-8 text-base-content/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   198→                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
   199→                      </svg>
   200→                    )}
   201→                  </div>
   202→                  <label className="btn btn-outline btn-sm">
   203→                    {uploading ? <span className="loading loading-spinner loading-xs"></span> : "Upload Logo"}
   204→                    <input type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} disabled={uploading} />
   205→                  </label>
   206→                </div>
   207→              </div>
   208→
   209→              {/* Dealership Name */}
   210→              <div className="form-control">
   211→                <label className="label">
   212→                  <span className="label-text font-medium">Dealership Name *</span>
   213→                </label>
   214→                <input
   215→                  type="text"
   216→                  className="input input-bordered"
   217→                  placeholder="e.g. Smith's Motor Company"
   218→                  value={formData.name}
   219→                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
   220→                  required
   221→                  autoFocus
   222→                />
   223→                <label className="label">
   224→                  <span className="label-text-alt text-base-content/50">This will appear on your forms and documents</span>
   225→                </label>
   226→              </div>
   227→
   228→              <button
   229→                type="submit"
   230→                className="btn btn-primary btn-block"
   231→                disabled={loading || !formData.name.trim()}
   232→              >
   233→                {loading ? (
   234→                  <>
   235→                    <span className="loading loading-spinner loading-sm"></span>
   236→                    Creating...
   237→                  </>
   238→                ) : (
   239→                  <>
   240→                    Create Dealership
   241→                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   242→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" />
   243→                    </svg>
   244→                  </>
   245→                )}
   246→              </button>
   247→            </form>
   248→
   249→            {/* Info */}
   250→            <div className="mt-6 p-4 bg-base-200 rounded-lg">
   251→              <p className="text-xs text-base-content/60">
   252→                <strong>What happens next?</strong><br />
   253→                After creating your dealership, you'll be able to:
   254→              </p>
   255→              <ul className="text-xs text-base-content/60 mt-2 space-y-1 list-disc list-inside">
   256→                <li>Choose which modules to enable</li>
   257→                <li>Configure your workflow settings</li>
   258→                <li>Add your first vehicle</li>
   259→                <li>Invite team members</li>
   260→              </ul>
   261→            </div>
   262→
   263→            {/* Back link */}
   264→            <div className="text-center mt-4">
   265→              <Link href="/" className="text-sm text-base-content/50 hover:text-base-content">
   266→                &larr; Back to home
   267→              </Link>
   268→            </div>
   269→          </div>
   270→        </div>
   271→      </div>
   272→    </>
   273→  );
   274→}
   275→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
