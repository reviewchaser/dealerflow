     1→import { useEffect, useState, useRef, useCallback, useMemo } from "react";
     2→import Head from "next/head";
     3→import Link from "next/link";
     4→import { useRouter } from "next/router";
     5→import DashboardLayout from "@/components/DashboardLayout";
     6→import { toast } from "react-hot-toast";
     7→import { showDummyNotification } from "@/utils/notifications";
     8→import { BottomSheet } from "@/components/ui/BottomSheet";
     9→import { Portal } from "@/components/ui/Portal";
    10→import { MobileStageSelector } from "@/components/ui/PageShell";
    11→import useDealerRedirect from "@/hooks/useDealerRedirect";
    12→import VehicleImage from "@/components/VehicleImage";
    13→
    14→const COLUMNS = [
    15→  { key: "in_stock", label: "Not Advertised", gradient: "from-orange-100/60", accent: "border-l-orange-400", accentBg: "bg-orange-400" },
    16→  { key: "in_prep", label: "Advertised", gradient: "from-blue-100/60", accent: "border-l-blue-400", accentBg: "bg-blue-400" },
    17→  { key: "live", label: "Sold In Progress", gradient: "from-cyan-100/60", accent: "border-l-cyan-400", accentBg: "bg-cyan-400" },
    18→  { key: "reserved", label: "Completed", gradient: "from-emerald-100/60", accent: "border-l-emerald-400", accentBg: "bg-emerald-400" },
    19→  { key: "delivered", label: "Delivered", gradient: "from-teal-100/60", accent: "border-l-teal-400", accentBg: "bg-teal-400" },
    20→];
    21→
    22→const ISSUE_SUBCATEGORIES = {
    23→  mechanical: ["Engine", "Transmission", "Suspension", "Brakes", "Exhaust", "Other"],
    24→  electrical: ["Battery", "Lights", "Starter Motor", "Alternator", "Sensors", "Other"],
    25→  bodywork: ["Panel Damage", "Scratches", "Dents", "Bumper", "Windscreen", "Other"],
    26→  interior: ["Seats", "Dashboard", "Trim", "Carpet", "Controls", "Other"],
    27→  tyres: ["Tread Depth", "Puncture", "Alloys", "Alignment", "Other"],
    28→  mot: ["Advisory", "Failed Item", "Due Soon", "Other"],
    29→  service: ["Oil Change", "Filters", "Fluids", "Timing Belt", "Other"],
    30→  fault_codes: ["Engine", "Transmission", "ABS", "Airbag", "Emissions", "Other"],
    31→  other: ["General", "Misc"],
    32→};
    33→
    34→// Sold statuses - these show "Sold X days" instead of "In stock X days"
    35→const SOLD_STATUSES = ["live", "reserved", "delivered"];
    36→
    37→// Helper to compute duration label based on status
    38→const getVehicleDuration = (vehicle) => {
    39→  const isSold = SOLD_STATUSES.includes(vehicle.status);
    40→
    41→  if (isSold) {
    42→    if (vehicle.soldAt) {
    43→      const daysSold = Math.floor((Date.now() - new Date(vehicle.soldAt).getTime()) / (1000 * 60 * 60 * 24));
    44→      return { days: daysSold, label: `Sold ${daysSold}d`, isSold: true };
    45→    }
    46→    // Legacy sold vehicle without soldAt - just show "Sold"
    47→    return { days: 0, label: "Sold", isSold: true };
    48→  }
    49→
    50→  const daysInStock = vehicle.createdAt
    51→    ? Math.floor((Date.now() - new Date(vehicle.createdAt).getTime()) / (1000 * 60 * 60 * 24))
    52→    : 0;
    53→  return { days: daysInStock, label: `${daysInStock}d in stock`, isSold: false };
    54→};
    55→
    56→export default function SalesPrep() {
    57→  const router = useRouter();
    58→  const { isRedirecting } = useDealerRedirect();
    59→  const [vehicles, setVehicles] = useState([]);
    60→  const [isLoading, setIsLoading] = useState(true);
    61→  const [selectedVehicle, setSelectedVehicle] = useState(null);
    62→  const [isLookingUpDrawer, setIsLookingUpDrawer] = useState(false);
    63→  const [showAddModal, setShowAddModal] = useState(false);
    64→  const [draggedCard, setDraggedCard] = useState(null);
    65→  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });
    66→  const [newTaskName, setNewTaskName] = useState("");
    67→  const [activeTab, setActiveTab] = useState("overview");
    68→  const [editingTaskId, setEditingTaskId] = useState(null);
    69→  const [editingTaskName, setEditingTaskName] = useState("");
    70→
    71→  // Parts ordering state
    72→  const [showPartsOrderModal, setShowPartsOrderModal] = useState(false);
    73→  const [partsOrderTaskId, setPartsOrderTaskId] = useState(null);
    74→  const [partsOrderForm, setPartsOrderForm] = useState({
    75→    supplierType: "EURO_CAR_PARTS",
    76→    supplierName: "",
    77→    orderRef: "",
    78→    expectedAt: "",
    79→    notes: "",
    80→  });
    81→  const [editingPartsOrderId, setEditingPartsOrderId] = useState(null);
    82→
    83→  // Column sorting state
    84→  const [columnSortOptions, setColumnSortOptions] = useState({});
    85→
    86→  // Job sheet share state
    87→  const [showJobSheetModal, setShowJobSheetModal] = useState(false);
    88→  const [jobSheetLink, setJobSheetLink] = useState(null);
    89→  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);
    90→
    91→  // Prep summary share state
    92→  const [showPrepSummaryModal, setShowPrepSummaryModal] = useState(false);
    93→  const [prepSummaryLink, setPrepSummaryLink] = useState(null);
    94→  const [isGeneratingPrepSummary, setIsGeneratingPrepSummary] = useState(false);
    95→
    96→  // Manual share fallback modal
    97→  const [showManualShareModal, setShowManualShareModal] = useState(false);
    98→  const [manualShareUrl, setManualShareUrl] = useState("");
    99→
   100→  // Mobile move bottom sheet

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
