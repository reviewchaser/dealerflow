     1â†’import { useEffect, useState } from "react";
     2â†’import Head from "next/head";
     3â†’import Link from "next/link";
     4â†’import { useRouter } from "next/router";
     5â†’import { useSession } from "next-auth/react";
     6â†’import DashboardLayout from "@/components/DashboardLayout";
     7â†’import StatsCard from "@/components/StatsCard";
     8â†’import useDealerRedirect from "@/hooks/useDealerRedirect";
     9â†’import { useDealer } from "@/contexts/DealerContext";
    10â†’import { appPath } from "@/libs/appPath";
    11â†’import { PageHint } from "@/components/ui";
    12â†’
    13â†’// Human-readable form type labels
    14â†’const FORM_TYPE_LABELS = {
    15â†’  PDI: "PDI",
    16â†’  TEST_DRIVE: "Test Drive",
    17â†’  WARRANTY_CLAIM: "Warranty Claim",
    18â†’  COURTESY_OUT: "Courtesy Out",
    19â†’  COURTESY_IN: "Courtesy In",
    20â†’  SERVICE_RECEIPT: "Service",
    21â†’  REVIEW_FEEDBACK: "Feedback",
    22â†’  OTHER: "Other",
    23â†’};
    24â†’
    25â†’// Purpose-led icons for each form type (rounded, modern, single-weight)
    26â†’const FormTypeIcon = ({ type, className = "w-6 h-6" }) => {
    27â†’  const icons = {
    28â†’    // PDI - Checklist icon
    29â†’    PDI: (
    30â†’      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    31â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
    32â†’      </svg>
    33â†’    ),
    34â†’    // Test Drive - Steering wheel
    35â†’    TEST_DRIVE: (
    36â†’      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    37â†’        <circle cx="12" cy="12" r="9" strokeWidth={1.5} />
    38â†’        <circle cx="12" cy="12" r="3" strokeWidth={1.5} />
    39â†’        <path strokeLinecap="round" strokeWidth={1.5} d="M12 3v6M12 15v6M3 12h6M15 12h6" />
    40â†’      </svg>
    41â†’    ),
    42â†’    // Courtesy Out - Car with outward arrow
    43â†’    COURTESY_OUT: (
    44â†’      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    45â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 17a2 2 0 100-4 2 2 0 000 4zM16 17a2 2 0 100-4 2 2 0 000 4z" />
    46â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 13V11a1 1 0 011-1h2l2-3h6l2 3h2a1 1 0 011 1v2M6 13h12M17 6l3 3m0 0l-3 3m3-3H13" />
    47â†’      </svg>
    48â†’    ),
    49â†’    // Courtesy In - Car with inward arrow
    50â†’    COURTESY_IN: (
    51â†’      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    52â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 17a2 2 0 100-4 2 2 0 000 4zM16 17a2 2 0 100-4 2 2 0 000 4z" />
    53â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 13V11a1 1 0 011-1h2l2-3h6l2 3h2a1 1 0 011 1v2M6 13h12M13 6l-3 3m0 0l3 3m-3-3h7" />
    54â†’      </svg>
    55â†’    ),
    56â†’    // Service Receipt - Wrench/spanner
    57â†’    SERVICE_RECEIPT: (
    58â†’      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    59â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
    60â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    61â†’      </svg>
    62â†’    ),
    63â†’    // Feedback - Star rating
    64â†’    REVIEW_FEEDBACK: (
    65â†’      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    66â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
    67â†’      </svg>
    68â†’    ),
    69â†’    // Delivery - Truck/handover
    70â†’    DELIVERY: (
    71â†’      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    72â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
    73â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
    74â†’      </svg>
    75â†’    ),
    76â†’    // Default - Generic form icon (for OTHER and unknown types)
    77â†’    DEFAULT: (
    78â†’      <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
    79â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    80â†’      </svg>
    81â†’    ),
    82â†’  };
    83â†’  return icons[type] || icons.DEFAULT;
    84â†’};
    85â†’
    86â†’// Default priority forms - PDI is always first as it's the most common daily task
    87â†’// COURTESY_OUT is prioritized as it's frequently used when handing out courtesy cars
    88â†’const DEFAULT_PRIORITY_FORM_TYPES = ["PDI", "TEST_DRIVE", "COURTESY_OUT"];
    89â†’const ALWAYS_FIRST_FORM_TYPE = "PDI";
    90â†’// Customer-facing forms that should NOT appear in internal dashboard/quick forms
    91â†’const CUSTOMER_FACING_FORM_TYPES = ["WARRANTY_CLAIM"];
    92â†’
    93â†’// Needs Attention item configurations
    94â†’const NEEDS_ATTENTION_ITEMS = [
    95â†’  {
    96â†’    key: "soldInProgress",
    97â†’    label: "Sold in progress",
    98â†’    href: "/sales-prep",
    99â†’    color: "warning",
   100â†’    icon: (
   101â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   102â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
   103â†’      </svg>
   104â†’    ),
   105â†’    description: "vehicles awaiting delivery"
   106â†’  },
   107â†’  {
   108â†’    key: "warrantyNotBookedIn",
   109â†’    label: "Warranty not booked in",
   110â†’    href: "/warranty",
   111â†’    color: "danger",
   112â†’    icon: (
   113â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   114â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
   115â†’      </svg>
   116â†’    ),
   117â†’    description: "cases need scheduling"
   118â†’  },
   119â†’  {
   120â†’    key: "eventsToday",
   121â†’    label: "Events today",
   122â†’    href: "/calendar",
   123â†’    color: "info",
   124â†’    icon: (
   125â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   126â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
   127â†’      </svg>
   128â†’    ),
   129â†’    description: "on your calendar"
   130â†’  },
   131â†’  {
   132â†’    key: "courtesyDueBack",
   133â†’    label: "Courtesy due back",
   134â†’    href: "/warranty",
   135â†’    color: "warning",
   136â†’    icon: (
   137â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   138â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
   139â†’      </svg>
   140â†’    ),
   141â†’    description: "vehicles due today or overdue"
   142â†’  },
   143â†’  {
   144â†’    key: "motExpiringSoon",
   145â†’    label: "MOT expiring soon",
   146â†’    href: "/sales-prep",
   147â†’    color: "danger",
   148â†’    icon: (
   149â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   150â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
   151â†’      </svg>
   152â†’    ),
   153â†’    description: "within 14 days"
   154â†’  },
   155â†’  {
   156â†’    key: "contactDue",
   157â†’    label: "Contact due",
   158â†’    href: "/warranty",
   159â†’    color: "warning",
   160â†’    icon: (
   161â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   162â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
   163â†’      </svg>
   164â†’    ),
   165â†’    description: "warranty cases need follow-up"
   166â†’  },
   167â†’  {
   168â†’    key: "newWarrantyCases",
   169â†’    label: "New warranty cases",
   170â†’    href: "/warranty",
   171â†’    color: "info",
   172â†’    icon: (
   173â†’      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   174â†’        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
   175â†’      </svg>
   176â†’    ),
   177â†’    description: "created in last 48 hours"
   178â†’  }
   179â†’];
   180â†’
   181â†’// Color mappings for needs attention
   182â†’const ATTENTION_COLORS = {
   183â†’  warning: {
   184â†’    bg: "bg-gradient-to-br from-amber-50 to-orange-50",
   185â†’    border: "border-amber-200",
   186â†’    icon: "bg-amber-100 text-amber-600",
   187â†’    badge: "bg-amber-500 text-white",
   188â†’    text: "text-amber-900"
   189â†’  },
   190â†’  danger: {
   191â†’    bg: "bg-gradient-to-br from-red-50 to-rose-50",
   192â†’    border: "border-red-200",
   193â†’    icon: "bg-red-100 text-red-600",
   194â†’    badge: "bg-red-500 text-white",
   195â†’    text: "text-red-900"
   196â†’  },
   197â†’  info: {
   198â†’    bg: "bg-gradient-to-br from-blue-50 to-cyan-50",
   199â†’    border: "border-blue-200",
   200â†’    icon: "bg-blue-100 text-blue-600",
   201â†’    badge: "bg-blue-500 text-white",
   202â†’    text: "text-blue-900"
   203â†’  }
   204â†’};
   205â†’
   206â†’export default function Dashboard() {
   207â†’  const router = useRouter();
   208â†’  const { data: session, status } = useSession();
   209â†’  const { isRedirecting } = useDealerRedirect();
   210â†’  const { dealerSlug } = useDealer(); // Get dealer slug for tenant-aware links
   211â†’  const getPath = (path) => appPath(dealerSlug, path); // Helper for tenant-aware paths
   212â†’  const [stats, setStats] = useState(null);
   213â†’  const [forms, setForms] = useState([]);
   214â†’  const [isLoading, setIsLoading] = useState(true);
   215â†’  // KPI display mode: "net" (default) or "gross"
   216â†’  const [kpiDisplayMode, setKpiDisplayMode] = useState("net");
   217â†’
   218â†’  const defaultStats = {
   219â†’    appraisals: { total: 0, pending: 0 },
   220â†’    vehicles: { total: 0, inStock: 0, inPrep: 0, live: 0, delivered: 0 },
   221â†’    aftercare: { total: 0, open: 0 },
   222â†’    reviews: { count: 0, avgRating: "N/A", lastReviewDays: null },
   223â†’    forms: { total: 0, submissions: 0 },
   224â†’    recent: { appraisals: [], vehicles: [], formSubmissions: [] },
   225â†’    needsAttention: { soldInProgress: 0, warrantyNotBookedIn: 0, eventsToday: 0, courtesyDueBack: 0, motExpiringSoon: 0, contactDue: 0, newWarrantyCases: 0 },
   226â†’    today: { events: 0, deliveries: 0, testDrives: 0, courtesyDueBack: 0 },
   227â†’    topForms: [],
   228â†’    oldestAppraisalDays: null,
   229â†’    aftersalesCosts: {
   230â†’      thisMonth: { totalNet: 0, totalGross: 0, partsNet: 0, labourNet: 0, caseCount: 0, avgPerCase: 0 },
   231â†’      lastMonth: { totalNet: 0, totalGross: 0, partsNet: 0, labourNet: 0, caseCount: 0, avgPerCase: 0 },
   232â†’      ytd: { totalNet: 0, totalGross: 0, partsNet: 0, labourNet: 0, caseCount: 0, avgPerCase: 0 }
   233â†’    },
   234â†’  };
   235â†’
   236â†’  // Only fetch stats after redirect check is complete (prevents double fetch)
   237â†’  useEffect(() => {
   238â†’    // Skip if we're still checking for redirects or going to redirect
   239â†’    if (isRedirecting) return;
   240â†’
   241â†’    const safeJsonParse = async (res) => {
   242â†’      const contentType = res.headers.get("content-type") || "";
   243â†’      if (!contentType.includes("application/json")) {
   244â†’        console.error("[Dashboard] Non-JSON response:", res.status, contentType);
   245â†’        return null;
   246â†’      }
   247â†’      return res.json();
   248â†’    };
   249â†’
   250â†’    fetch("/api/dashboard/stats")
   251â†’      .then(async (res) => {
   252â†’        if (res.status === 403) return { error: "No dealer context" };
   253â†’        if (!res.ok) return { error: "Failed to fetch stats" };
   254â†’        return await safeJsonParse(res) || { error: "Invalid response" };
   255â†’      })
   256â†’      .then((statsData) => {
   257â†’        if (statsData?.error) {
   258â†’          console.error("Dashboard stats error:", statsData.error);
   259â†’          setStats(defaultStats);
   260â†’          setForms([]);
   261â†’        } else {
   262â†’          setStats(statsData || defaultStats);
   263â†’          setForms(Array.isArray(statsData?.formsList) ? statsData.formsList : []);
   264â†’        }
   265â†’        setIsLoading(false);
   266â†’      })
   267â†’      .catch((err) => {
   268â†’        console.error("Dashboard fetch error:", err);
   269â†’        setStats(defaultStats);
   270â†’        setForms([]);
   271â†’        setIsLoading(false);
   272â†’      });
   273â†’  }, [isRedirecting]);
   274â†’
   275â†’  const handleFormClick = (form) => {
   276â†’    if (form.isPublic && form.publicSlug) {
   277â†’      window.open(`/public/forms/${form.publicSlug}`, '_blank');
   278â†’    } else {
   279â†’      router.push(getPath(`/forms/fill/${form.id || form._id}`));
   280â†’    }
   281â†’  };
   282â†’
   283â†’  // Filter out customer-facing forms from internal dashboard
   284â†’  const internalForms = forms.filter(f => !CUSTOMER_FACING_FORM_TYPES.includes(f.type));
   285â†’
   286â†’  const getTopForms = () => {
   287â†’    const pdiForm = internalForms.find(f => f.type === ALWAYS_FIRST_FORM_TYPE);
   288â†’    let otherTopForms = [];
   289â†’    if (stats?.topForms?.length > 0) {
   290â†’      otherTopForms = stats.topForms
   291â†’        .map(tf => internalForms.find(f => (f.id || f._id?.toString?.() || f._id) === (tf.formId?.toString?.() || tf.formId)))
   292â†’        .filter(f => f && f.type !== ALWAYS_FIRST_FORM_TYPE)
   293â†’        .slice(0, 2);
   294â†’    } else {
   295â†’      otherTopForms = internalForms.filter(f => DEFAULT_PRIORITY_FORM_TYPES.includes(f.type) && f.type !== ALWAYS_FIRST_FORM_TYPE).slice(0, 2);
   296â†’    }
   297â†’    return pdiForm ? [pdiForm, ...otherTopForms] : otherTopForms;
   298â†’  };
   299â†’
   300â†’  const topForms = getTopForms();
   301â†’  const otherForms = internalForms.filter(f => !topForms.find(tf => (tf.id || tf._id?.toString?.() || tf._id) === (f.id || f._id?.toString?.() || f._id)));
   302â†’
   303â†’  const activeNeedsAttention = NEEDS_ATTENTION_ITEMS.filter(item =>
   304â†’    stats?.needsAttention?.[item.key] > 0
   305â†’  );
   306â†’
   307â†’  const hasTodayData = stats?.today && (
   308â†’    stats.today.events > 0 ||
   309â†’    stats.today.deliveries > 0 ||
   310â†’    stats.today.testDrives > 0 ||
   311â†’    stats.today.courtesyDueBack > 0
   312â†’  );
   313â†’
   314â†’  // Show loading while checking for dealer redirect
   315â†’  if (isRedirecting) {
   316â†’    return (
   317â†’      <div className="min-h-screen flex items-center justify-center bg-slate-50">
   318â†’        <div className="flex flex-col items-center gap-4">
   319â†’          <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin" />
   320â†’          <p className="text-sm text-slate-500 font-medium">Loading...</p>
   321â†’        </div>
   322â†’      </div>
   323â†’    );
   324â†’  }
   325â†’
   326â†’  return (
   327â†’    <DashboardLayout>
   328â†’      <Head><title>Dashboard | DealerHQ</title></Head>
   329â†’
   330â†’      {/* Hero Header with Rich Gradient */}
   331â†’      <div className="relative -mx-4 -mt-4 md:-mx-6 md:-mt-6 px-4 md:px-6 pt-8 pb-10 mb-8 hero-gradient border-b border-slate-200/50">
   332â†’        <div className="max-w-7xl mx-auto">
   333â†’          <div className="flex items-start justify-between">
   334â†’            <div>
   335â†’              <h1 className="text-2xl md:text-3xl font-extrabold text-slate-900 tracking-tight">
   336â†’                Good {new Date().getHours() < 12 ? 'morning' : new Date().getHours() < 17 ? 'afternoon' : 'evening'}
   337â†’              </h1>
   338â†’              <p className="text-slate-600 mt-1.5 text-base">Here's what's happening with your dealership today</p>
   339â†’              <div className="mt-2"><PageHint id="dashboard">Your daily overview. See key stats, quick actions, and things needing attention at a glance.</PageHint></div>
   340â†’            </div>
   341â†’            <div className="hidden md:flex items-center gap-3">
   342â†’              <div className="text-right">
   343â†’                <p className="text-sm font-bold text-slate-800">
   344â†’                  {new Date().toLocaleDateString('en-GB', { weekday: 'long' })}
   345â†’                </p>
   346â†’                <p className="text-xs text-slate-500">
   347â†’                  {new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
   348â†’                </p>
   349â†’              </div>
   350â†’              <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-[#0066CC] to-[#14B8A6] flex items-center justify-center text-white shadow-lg">
   351â†’                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   352â†’                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
   353â†’                </svg>
   354â†’              </div>
   355â†’            </div>
   356â†’          </div>
   357â†’
   358â†’          {/* Today's Activity Pills */}
   359â†’          {hasTodayData && (
   360â†’            <div className="mt-6 flex items-center gap-3 flex-wrap">
   361â†’              <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">Today</span>
   362â†’              <div className="h-4 w-px bg-slate-300" />
   363â†’              <div className="flex items-center gap-2 flex-wrap">
   364â†’                {(stats?.today?.events ?? 0) > 0 && (
   365â†’                  <Link href={getPath("/calendar")} className="inline-flex items-center gap-2 px-4 py-2 bg-white border border-[#0066CC]/20 text-[#0066CC] rounded-xl text-sm font-semibold hover:bg-[#0066CC]/5 hover:border-[#0066CC]/40 transition-all shadow-sm">
   366â†’                    <span className="w-2.5 h-2.5 rounded-full bg-[#0066CC] animate-pulse" />
   367â†’                    {stats.today.events} event{stats.today.events !== 1 ? "s" : ""}
   368â†’                  </Link>
   369â†’                )}
   370â†’                {(stats?.today?.deliveries ?? 0) > 0 && (
   371â†’                  <Link href={getPath("/calendar")} className="inline-flex items-center gap-2 px-4 py-2 bg-white border border-emerald-200 text-emerald-700 rounded-xl text-sm font-semibold hover:bg-emerald-50 transition-all shadow-sm">
   372â†’                    <span className="w-2.5 h-2.5 rounded-full bg-emerald-500" />
   373â†’                    {stats.today.deliveries} deliver{stats.today.deliveries !== 1 ? "ies" : "y"}
   374â†’                  </Link>
   375â†’                )}
   376â†’                {(stats?.today?.testDrives ?? 0) > 0 && (
   377â†’                  <Link href={getPath("/calendar")} className="inline-flex items-center gap-2 px-4 py-2 bg-white border border-cyan-200 text-cyan-700 rounded-xl text-sm font-semibold hover:bg-cyan-50 transition-all shadow-sm">
   378â†’                    <span className="w-2.5 h-2.5 rounded-full bg-cyan-500" />
   379â†’                    {stats.today.testDrives} test drive{stats.today.testDrives !== 1 ? "s" : ""}
   380â†’                  </Link>
   381â†’                )}
   382â†’                {(stats?.today?.courtesyDueBack ?? 0) > 0 && (
   383â†’                  <Link href={getPath("/warranty")} className="inline-flex items-center gap-2 px-4 py-2 bg-white border border-amber-200 text-amber-700 rounded-xl text-sm font-semibold hover:bg-amber-50 transition-all shadow-sm">
   384â†’                    <span className="w-2.5 h-2.5 rounded-full bg-amber-500" />
   385â†’                    {stats.today.courtesyDueBack} courtesy due
   386â†’                  </Link>
   387â†’                )}
   388â†’              </div>
   389â†’            </div>
   390â†’          )}
   391â†’        </div>
   392â†’      </div>
   393â†’
   394â†’      {isLoading ? (
   395â†’        <div className="flex justify-center py-20">
   396â†’          <div className="flex flex-col items-center gap-4">
   397â†’            <div className="w-12 h-12 border-4 border-[#0066CC]/20 border-t-[#0066CC] rounded-full animate-spin" />
   398â†’            <p className="text-sm text-slate-500 font-medium">Loading dashboard...</p>
   399â†’          </div>
   400â†’        </div>
   401â†’      ) : (
   402â†’        <div className="space-y-8">
   403â†’
   404â†’          {/* KPI Cards Row - Mixed Variants */}
   405â†’          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
   406â†’            <StatsCard
   407â†’              title="Pending Appraisals"
   408â†’              value={stats?.appraisals?.pending ?? 0}
   409â†’              trend={typeof stats?.oldestAppraisalDays === "number" ? `Oldest: ${stats.oldestAppraisalDays}d` : null}
   410â†’              icon="ðŸ“‹"
   411â†’              color="primary"
   412â†’              variant="gradient"
   413â†’            />
   414â†’            <StatsCard
   415â†’              title="Total Stock"
   416â†’              value={(stats?.vehicles?.inStock ?? 0) + (stats?.vehicles?.inPrep ?? 0)}
   417â†’              trend={stats?.vehicles?.inPrep > 0 ? `${stats.vehicles.inPrep} in prep` : null}
   418â†’              icon="ðŸš—"
   419â†’              color="secondary"
   420â†’              variant="gradient"
   421â†’            />
   422â†’            <StatsCard
   423â†’              title="Sold in Progress"
   424â†’              value={stats?.vehicles?.live ?? 0}
   425â†’              trend="Awaiting delivery"
   426â†’              icon="ðŸ“¦"
   427â†’              color="warning"
   428â†’              variant="outlined"
   429â†’            />
   430â†’            <StatsCard
   431â†’              title="Total Sold"
   432â†’              value={stats?.vehicles?.delivered ?? 0}
   433â†’              trend="Delivered to customers"
   434â†’              icon="ðŸ†"
   435â†’              color="success"
   436â†’              variant="gradient"
   437â†’            />
   438â†’          </div>
   439â†’
   440â†’          {/* Aftersales KPI Row */}
   441â†’          <div className="space-y-2">
   442â†’            {/* Net/Gross Toggle */}
   443â†’            <div className="flex items-center justify-between">
   444â†’              <h3 className="text-sm font-semibold text-slate-700">Aftersales Costs</h3>
   445â†’              <div className="flex items-center gap-2 text-xs">
   446â†’                <span className="text-slate-500">Show:</span>
   447â†’                <div className="flex rounded-lg border border-slate-200 overflow-hidden">
   448â†’                  <button
   449â†’                    className={`px-2.5 py-1 font-medium transition-colors ${kpiDisplayMode === "net" ? "bg-[#0066CC] text-white" : "bg-white text-slate-600 hover:bg-slate-50"}`}
   450â†’                    onClick={() => setKpiDisplayMode("net")}
   451â†’                  >
   452â†’                    Net
   453â†’                  </button>
   454â†’                  <button
   455â†’                    className={`px-2.5 py-1 font-medium transition-colors border-l border-slate-200 ${kpiDisplayMode === "gross" ? "bg-[#0066CC] text-white" : "bg-white text-slate-600 hover:bg-slate-50"}`}
   456â†’                    onClick={() => setKpiDisplayMode("gross")}
   457â†’                  >
   458â†’                    Gross
   459â†’                  </button>
   460â†’                </div>
   461â†’              </div>
   462â†’            </div>
   463â†’            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
   464â†’              <Link href={getPath("/warranty")} className="block">
   465â†’                <div className="bg-white rounded-xl border border-slate-200 p-5 hover:shadow-lg hover:border-[#0066CC]/30 transition-all cursor-pointer group">
   466â†’                  <div className="flex items-start justify-between">
   467â†’                    <div>
   468â†’                      <p className="text-sm font-medium text-slate-500">Open Cases</p>
   469â†’                      <p className="text-3xl font-bold text-slate-900 mt-1">{stats?.aftercare?.open ?? 0}</p>
   470â†’                      <p className="text-xs text-slate-400 mt-1">Warranty & aftercare</p>
   471â†’                    </div>
   472â†’                    <div className="w-12 h-12 rounded-xl bg-amber-100 text-amber-600 flex items-center justify-center group-hover:bg-amber-500 group-hover:text-white transition-colors">
   473â†’                      <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   474â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
   475â†’                      </svg>
   476â†’                    </div>
   477â†’                  </div>
   478â†’                </div>
   479â†’              </Link>
   480â†’              <div className="bg-white rounded-xl border border-slate-200 p-5">
   481â†’                <div className="flex items-start justify-between">
   482â†’                  <div>
   483â†’                    <p className="text-sm font-medium text-slate-500">This Month{kpiDisplayMode === "gross" ? " (Gross)" : ""}</p>
   484â†’                    <p className="text-3xl font-bold text-slate-900 mt-1">Â£{(kpiDisplayMode === "gross" ? stats?.aftersalesCosts?.thisMonth?.totalGross : stats?.aftersalesCosts?.thisMonth?.totalNet ?? 0)?.toLocaleString("en-GB", { minimumFractionDigits: 0, maximumFractionDigits: 0 }) || "0"}</p>
   485â†’                    <p className="text-xs text-slate-400 mt-1">{stats?.aftersalesCosts?.thisMonth?.caseCount ?? 0} cases</p>
   486â†’                  </div>
   487â†’                  <div className="w-12 h-12 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center">
   488â†’                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   489â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
   490â†’                    </svg>
   491â†’                  </div>
   492â†’                </div>
   493â†’              </div>
   494â†’              <div className="bg-white rounded-xl border border-slate-200 p-5">
   495â†’                <div className="flex items-start justify-between">
   496â†’                  <div>
   497â†’                    <p className="text-sm font-medium text-slate-500">Last Month{kpiDisplayMode === "gross" ? " (Gross)" : ""}</p>
   498â†’                    <p className="text-3xl font-bold text-slate-900 mt-1">Â£{(kpiDisplayMode === "gross" ? stats?.aftersalesCosts?.lastMonth?.totalGross : stats?.aftersalesCosts?.lastMonth?.totalNet ?? 0)?.toLocaleString("en-GB", { minimumFractionDigits: 0, maximumFractionDigits: 0 }) || "0"}</p>
   499â†’                    <p className="text-xs text-slate-400 mt-1">{stats?.aftersalesCosts?.lastMonth?.caseCount ?? 0} cases</p>
   500â†’                  </div>
   501â†’                  <div className="w-12 h-12 rounded-xl bg-slate-100 text-slate-500 flex items-center justify-center">
   502â†’                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   503â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
   504â†’                    </svg>
   505â†’                  </div>
   506â†’                </div>
   507â†’              </div>
   508â†’              <div className="bg-white rounded-xl border border-slate-200 p-5">
   509â†’                <div className="flex items-start justify-between">
   510â†’                  <div>
   511â†’                    <p className="text-sm font-medium text-slate-500">Year to Date{kpiDisplayMode === "gross" ? " (Gross)" : ""}</p>
   512â†’                    <p className="text-3xl font-bold text-slate-900 mt-1">Â£{(kpiDisplayMode === "gross" ? stats?.aftersalesCosts?.ytd?.totalGross : stats?.aftersalesCosts?.ytd?.totalNet ?? 0)?.toLocaleString("en-GB", { minimumFractionDigits: 0, maximumFractionDigits: 0 }) || "0"}</p>
   513â†’                    <p className="text-xs text-slate-400 mt-1">{stats?.aftersalesCosts?.ytd?.caseCount ?? 0} cases â€¢ Avg Â£{(kpiDisplayMode === "gross" ? stats?.aftersalesCosts?.ytd?.avgPerCaseGross : stats?.aftersalesCosts?.ytd?.avgPerCase ?? 0)?.toLocaleString("en-GB", { minimumFractionDigits: 0, maximumFractionDigits: 0 }) || "0"}</p>
   514â†’                  </div>
   515â†’                  <div className="w-12 h-12 rounded-xl bg-emerald-100 text-emerald-600 flex items-center justify-center">
   516â†’                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   517â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
   518â†’                    </svg>
   519â†’                  </div>
   520â†’                </div>
   521â†’              </div>
   522â†’            </div>
   523â†’          </div>
   524â†’
   525â†’          {/* Quick Forms Section */}
   526â†’          {forms.length > 0 && (
   527â†’            <div className="bg-white rounded-2xl shadow-md border border-slate-100 p-6">
   528â†’              <div className="flex items-center justify-between mb-5">
   529â†’                <div className="flex items-center gap-3">
   530â†’                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center text-white shadow-lg">
   531â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   532â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   533â†’                    </svg>
   534â†’                  </div>
   535â†’                  <div>
   536â†’                    <h2 className="text-lg font-bold text-slate-900">Quick Forms</h2>
   537â†’                    <p className="text-xs text-slate-500">Launch frequently used forms</p>
   538â†’                  </div>
   539â†’                </div>
   540â†’                <Link href={getPath("/forms")} className="text-sm text-[#0066CC] hover:text-[#0055BB] font-semibold transition-colors flex items-center gap-1">
   541â†’                  All Submissions
   542â†’                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   543â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
   544â†’                  </svg>
   545â†’                </Link>
   546â†’              </div>
   547â†’              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
   548â†’                {topForms.map((form) => (
   549â†’                  <button
   550â†’                    key={form.id || form._id}
   551â†’                    onClick={() => handleFormClick(form)}
   552â†’                    className="group bg-gradient-to-br from-slate-50 to-white border-2 border-slate-200 p-5 rounded-xl flex flex-col items-center gap-3 hover:border-[#0066CC] hover:shadow-lg hover:scale-[1.02] transition-all cursor-pointer"
   553â†’                  >
   554â†’                    <div className="w-12 h-12 rounded-xl bg-[#0066CC]/10 text-[#0066CC] flex items-center justify-center group-hover:bg-[#0066CC] group-hover:text-white transition-colors">
   555â†’                      <FormTypeIcon type={form.type} className="w-6 h-6" />
   556â†’                    </div>
   557â†’                    <span className="font-bold text-slate-700 text-sm text-center">
   558â†’                      {FORM_TYPE_LABELS[form.type] || form.name}
   559â†’                    </span>
   560â†’                  </button>
   561â†’                ))}
   562â†’                {otherForms.length > 0 && (
   563â†’                  <div className="dropdown dropdown-end">
   564â†’                    <label
   565â†’                      tabIndex={0}
   566â†’                      className="group bg-slate-100 border-2 border-dashed border-slate-300 p-5 rounded-xl flex flex-col items-center gap-3 hover:border-slate-400 hover:bg-slate-50 transition-all cursor-pointer w-full"
   567â†’                    >
   568â†’                      <div className="w-12 h-12 rounded-xl bg-slate-200 text-slate-500 flex items-center justify-center">
   569â†’                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   570â†’                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
   571â†’                        </svg>
   572â†’                      </div>
   573â†’                      <span className="font-bold text-slate-500 text-sm">+{otherForms.length} More</span>
   574â†’                    </label>
   575â†’                    <div tabIndex={0} className="dropdown-content z-20 shadow-2xl bg-white rounded-xl w-64 border border-slate-200 mt-2 overflow-hidden">
   576â†’                      <div className="px-4 py-3 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white">
   577â†’                        <p className="text-xs font-bold text-slate-500 uppercase tracking-wide">All Forms</p>
   578â†’                      </div>
   579â†’                      <div className="max-h-64 overflow-y-auto">
   580â†’                        {otherForms.map((form) => (
   581â†’                          <button
   582â†’                            key={form.id || form._id}
   583â†’                            onClick={() => handleFormClick(form)}
   584â†’                            className="w-full flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-[#0066CC]/5 hover:text-[#0066CC] transition-colors border-b border-slate-50 last:border-0"
   585â†’                          >
   586â†’                            <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center flex-shrink-0 text-slate-500">
   587â†’                              <FormTypeIcon type={form.type} className="w-4 h-4" />
   588â†’                            </div>
   589â†’                            <span className="truncate">{FORM_TYPE_LABELS[form.type] || form.name}</span>
   590â†’                          </button>
   591â†’                        ))}
   592â†’                      </div>
   593â†’                    </div>
   594â†’                  </div>
   595â†’                )}
   596â†’              </div>
   597â†’            </div>
   598â†’          )}
   599â†’
   600â†’          {/* Middle Row - Needs Attention + Quick Actions */}
   601â†’          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
   602â†’            {/* Needs Attention - Modern Card Layout */}
   603â†’            <div className="lg:col-span-2">
   604â†’              <div className="bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden">
   605â†’                <div className="flex items-center gap-3 px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-red-50/50 to-amber-50/50">
   606â†’                  <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-amber-500 flex items-center justify-center text-white shadow-lg">
   607â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   608â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
   609â†’                    </svg>
   610â†’                  </div>
   611â†’                  <div>
   612â†’                    <h2 className="text-lg font-bold text-slate-900">Needs Attention</h2>
   613â†’                    <p className="text-xs text-slate-500">Items requiring your immediate action</p>
   614â†’                  </div>
   615â†’                </div>
   616â†’                {activeNeedsAttention.length > 0 ? (
   617â†’                  <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
   618â†’                    {activeNeedsAttention.map((item) => {
   619â†’                      const colors = ATTENTION_COLORS[item.color];
   620â†’                      return (
   621â†’                        <Link
   622â†’                          key={item.key}
   623â†’                          href={getPath(item.href)}
   624â†’                          className={`${colors.bg} ${colors.border} border rounded-xl p-4 hover:shadow-md transition-all group`}
   625â†’                        >
   626â†’                          <div className="flex items-start gap-3">
   627â†’                            <div className={`w-10 h-10 rounded-xl ${colors.icon} flex items-center justify-center flex-shrink-0`}>
   628â†’                              {item.icon}
   629â†’                            </div>
   630â†’                            <div className="flex-1 min-w-0">
   631â†’                              <div className="flex items-center gap-2 mb-1">
   632â†’                                <span className={`${colors.badge} px-2 py-0.5 rounded-full text-xs font-bold`}>
   633â†’                                  {stats?.needsAttention?.[item.key] ?? 0}
   634â†’                                </span>
   635â†’                                <span className={`text-sm font-bold ${colors.text}`}>{item.label}</span>
   636â†’                              </div>
   637â†’                              <p className="text-xs text-slate-600">{item.description}</p>
   638â†’                            </div>
   639â†’                            <svg className="w-5 h-5 text-slate-300 group-hover:text-slate-500 transition-colors flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   640â†’                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
   641â†’                            </svg>
   642â†’                          </div>
   643â†’                        </Link>
   644â†’                      );
   645â†’                    })}
   646â†’                  </div>
   647â†’                ) : (
   648â†’                  <div className="p-8 flex items-center justify-center">
   649â†’                    <div className="text-center">
   650â†’                      <div className="w-16 h-16 bg-gradient-to-br from-emerald-100 to-teal-100 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-inner">
   651â†’                        <svg className="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   652â†’                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   653â†’                        </svg>
   654â†’                      </div>
   655â†’                      <p className="text-lg font-bold text-emerald-700">All clear!</p>
   656â†’                      <p className="text-sm text-emerald-600/70 mt-1">Nothing needs attention right now</p>
   657â†’                    </div>
   658â†’                  </div>
   659â†’                )}
   660â†’              </div>
   661â†’            </div>
   662â†’
   663â†’            {/* Quick Actions - Command Palette Style */}
   664â†’            <div className="bg-white rounded-2xl shadow-md border border-slate-100 p-6">
   665â†’              <div className="flex items-center gap-3 mb-5">
   666â†’                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-[#0066CC] to-[#0EA5E9] flex items-center justify-center text-white shadow-lg">
   667â†’                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   668â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
   669â†’                  </svg>
   670â†’                </div>
   671â†’                <div>
   672â†’                  <h2 className="text-lg font-bold text-slate-900">Quick Actions</h2>
   673â†’                  <p className="text-xs text-slate-500">Shortcuts to common tasks</p>
   674â†’                </div>
   675â†’              </div>
   676â†’              <div className="space-y-3">
   677â†’                <Link href={getPath("/sales-prep")} className="action-card">
   678â†’                  <div className="w-10 h-10 rounded-xl bg-[#0066CC]/10 text-[#0066CC] flex items-center justify-center">
   679â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   680â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
   681â†’                    </svg>
   682â†’                  </div>
   683â†’                  <div className="flex-1">
   684â†’                    <span className="font-bold text-slate-800 block">Add Vehicle</span>
   685â†’                    <span className="text-xs text-slate-500">Add to stock</span>
   686â†’                  </div>
   687â†’                </Link>
   688â†’
   689â†’                <Link href={getPath("/appraisals/new")} className="action-card">
   690â†’                  <div className="w-10 h-10 rounded-xl bg-[#14B8A6]/10 text-[#14B8A6] flex items-center justify-center">
   691â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   692â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   693â†’                    </svg>
   694â†’                  </div>
   695â†’                  <div className="flex-1">
   696â†’                    <span className="font-bold text-slate-800 block">New Appraisal</span>
   697â†’                    <span className="text-xs text-slate-500">Value a vehicle</span>
   698â†’                  </div>
   699â†’                </Link>
   700â†’
   701â†’                <Link href={getPath("/forms")} className="action-card">
   702â†’                  <div className="w-10 h-10 rounded-xl bg-amber-100 text-amber-600 flex items-center justify-center">
   703â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   704â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
   705â†’                    </svg>
   706â†’                  </div>
   707â†’                  <div className="flex-1">
   708â†’                    <span className="font-bold text-slate-800 block">View Submissions</span>
   709â†’                    <span className="text-xs text-slate-500">Review form data</span>
   710â†’                  </div>
   711â†’                </Link>
   712â†’
   713â†’                <Link href={getPath("/warranty?addCase=1")} className="action-card">
   714â†’                  <div className="w-10 h-10 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center">
   715â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   716â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
   717â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
   718â†’                    </svg>
   719â†’                  </div>
   720â†’                  <div className="flex-1">
   721â†’                    <span className="font-bold text-slate-800 block">Add Aftersales Case</span>
   722â†’                    <span className="text-xs text-slate-500">Log warranty issue</span>
   723â†’                  </div>
   724â†’                </Link>
   725â†’              </div>
   726â†’            </div>
   727â†’          </div>
   728â†’
   729â†’          {/* Bottom Row - Recent Activity Cards */}
   730â†’          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
   731â†’            {/* Recent Appraisals */}
   732â†’            <div className="bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden">
   733â†’              <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100">
   734â†’                <div className="flex items-center gap-3">
   735â†’                  <div className="w-10 h-10 rounded-xl bg-[#0066CC]/10 text-[#0066CC] flex items-center justify-center">
   736â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   737â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   738â†’                    </svg>
   739â†’                  </div>
   740â†’                  <h3 className="text-lg font-bold text-slate-900">Recent Appraisals</h3>
   741â†’                </div>
   742â†’                <Link href={getPath("/appraisals")} className="text-xs font-bold text-[#0066CC] uppercase tracking-wide hover:underline flex items-center gap-1">
   743â†’                  View All
   744â†’                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   745â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
   746â†’                  </svg>
   747â†’                </Link>
   748â†’              </div>
   749â†’
   750â†’              {stats?.recent?.appraisals?.length > 0 ? (
   751â†’                <div className="divide-y divide-slate-100">
   752â†’                  {stats.recent.appraisals.slice(0, 5).map((a) => (
   753â†’                    <div
   754â†’                      key={a.id}
   755â†’                      onClick={() => router.push(getPath(`/appraisals/${a.id}`))}
   756â†’                      className="flex items-center gap-4 px-6 py-4 hover:bg-slate-50 transition-colors cursor-pointer"
   757â†’                    >
   758â†’                      <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-slate-100 to-slate-50 flex items-center justify-center border border-slate-200">
   759â†’                        <span className="font-mono text-xs font-bold text-slate-600">{a.vehicleReg?.slice(0, 4)}</span>
   760â†’                      </div>
   761â†’                      <div className="flex-1 min-w-0">
   762â†’                        <p className="font-bold text-slate-800 text-sm">{a.vehicleReg}</p>
   763â†’                        <p className="text-xs text-slate-500 truncate">{a.contactId?.name || "No contact"}</p>
   764â†’                      </div>
   765â†’                      <span className={`px-3 py-1 rounded-full text-xs font-bold ${
   766â†’                        a.decision === "purchased" || a.decision === "converted"
   767â†’                          ? "bg-emerald-100 text-emerald-700"
   768â†’                          : a.decision === "not_purchased" || a.decision === "declined"
   769â†’                          ? "bg-red-100 text-red-700"
   770â†’                          : "bg-amber-100 text-amber-700"
   771â†’                      }`}>
   772â†’                        {a.decision}
   773â†’                      </span>
   774â†’                    </div>
   775â†’                  ))}
   776â†’                </div>
   777â†’              ) : (
   778â†’                <div className="flex items-center justify-center py-12">
   779â†’                  <div className="text-center">
   780â†’                    <div className="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center mx-auto mb-3">
   781â†’                      <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   782â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   783â†’                      </svg>
   784â†’                    </div>
   785â†’                    <p className="text-slate-500 text-sm font-medium">No appraisals yet</p>
   786â†’                  </div>
   787â†’                </div>
   788â†’              )}
   789â†’            </div>
   790â†’
   791â†’            {/* Prep Priorities - Actionable widget */}
   792â†’            <div className="bg-white rounded-2xl shadow-md border border-slate-100 overflow-hidden">
   793â†’              <div className="flex items-center justify-between px-6 py-4 border-b border-slate-100">
   794â†’                <div className="flex items-center gap-3">
   795â†’                  <div className="w-10 h-10 rounded-xl bg-amber-500/10 text-amber-600 flex items-center justify-center">
   796â†’                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   797â†’                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
   798â†’                    </svg>
   799â†’                  </div>
   800â†’                  <h3 className="text-lg font-bold text-slate-900">Prep Priorities</h3>
   801â†’                </div>
   802â†’                <Link href={getPath("/sales-prep")} className="text-xs font-bold text-[#0066CC] uppercase tracking-wide hover:underline flex items-center gap-1">
   803â†’                  View Board
   804â†’                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   805â†’                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
   806â†’                  </svg>
   807â†’                </Link>
   808â†’              </div>
   809â†’
   810â†’              {stats?.prepPriorities?.length > 0 ? (
   811â†’                <div className="divide-y divide-slate-100">
   812â†’                  {stats.prepPriorities.map((v) => (
   813â†’                    <div
   814â†’                      key={v.id}
   815â†’                      onClick={() => router.push(getPath("/sales-prep"))}
   816â†’                      className="px-6 py-4 hover:bg-slate-50 transition-colors cursor-pointer"
   817â†’                    >
   818â†’                      {/* Top row - VRM, Make/Model, Status */}
   819â†’                      <div className="flex items-center justify-between mb-2">
   820â†’                        <div className="flex items-center gap-3">
   821â†’                          <span className="font-mono font-bold text-slate-900 text-sm bg-slate-100 px-2 py-0.5 rounded">
   822â†’                            {v.regCurrent || "No VRM"}
   823â†’                          </span>
   824â†’                          <span className="text-sm text-slate-600">{v.make} {v.model}</span>
   825â†’                        </div>
   826â†’                        <span className={`px-2.5 py-1 rounded-full text-xs font-bold ${
   827â†’                          v.status === "live"
   828â†’                            ? "bg-cyan-100 text-cyan-700"
   829â†’                            : v.status === "in_prep"
   830â†’                            ? "bg-blue-100 text-blue-700"
   831â†’                            : "bg-amber-100 text-amber-700"
   832â†’                        }`}>
   833â†’                          {v.status === "live" ? "Sold in Progress" : v.status === "in_prep" ? "Advertised" : "Not Advertised"}
   834â†’                        </span>
   835â†’                      </div>
   836â†’
   837â†’                      {/* Bottom row - Stats */}
   838â†’                      <div className="flex items-center gap-4 text-xs">
   839â†’                        {/* Days in stock */}
   840â†’                        <span className="flex items-center gap-1 text-slate-500">
   841â†’                          <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   842â†’                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
   843â†’                          </svg>
   844â†’                          {v.daysInStock}d
   845â†’                        </span>
   846â†’
   847â†’                        {/* Tasks remaining */}
   848â†’                        {v.totalTasks > 0 && (
   849â†’                          <span className={`flex items-center gap-1 ${v.tasksRemaining > 0 ? "text-amber-600" : "text-emerald-600"}`}>
   850â†’                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   851â†’                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
   852â†’                            </svg>
   853â†’                            {v.completedTasks}/{v.totalTasks} tasks
   854â†’                          </span>
   855â†’                        )}
   856â†’
   857â†’                        {/* Awaiting parts */}
   858â†’                        {v.awaitingParts > 0 && (
   859â†’                          <span className="flex items-center gap-1 text-orange-600">
   860â†’                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   861â†’                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
   862â†’                            </svg>
   863â†’                            {v.awaitingParts} parts
   864â†’                          </span>
   865â†’                        )}
   866â†’
   867â†’                        {/* Open issues */}
   868â†’                        {v.openIssues > 0 && (
   869â†’                          <span className={`flex items-center gap-1 ${v.mechanicalIssues > 0 ? "text-red-600 font-semibold" : "text-slate-500"}`}>
   870â†’                            <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   871â†’                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
   872â†’                            </svg>
   873â†’                            {v.openIssues} issue{v.openIssues !== 1 ? "s" : ""}
   874â†’                            {v.mechanicalIssues > 0 && ` (${v.mechanicalIssues} mech)`}
   875â†’                          </span>
   876â†’                        )}
   877â†’                      </div>
   878â†’                    </div>
   879â†’                  ))}
   880â†’                </div>
   881â†’              ) : (
   882â†’                <div className="flex items-center justify-center py-12">
   883â†’                  <div className="text-center">
   884â†’                    <div className="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center mx-auto mb-3">
   885â†’                      <svg className="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   886â†’                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
   887â†’                      </svg>
   888â†’                    </div>
   889â†’                    <p className="text-slate-500 text-sm font-medium">All prep complete!</p>
   890â†’                    <p className="text-slate-400 text-xs mt-1">No vehicles need attention right now</p>
   891â†’                  </div>
   892â†’                </div>
   893â†’              )}
   894â†’            </div>
   895â†’          </div>
   896â†’        </div>
   897â†’      )}
   898â†’    </DashboardLayout>
   899â†’  );
   900â†’}
   901â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
