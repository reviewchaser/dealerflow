     1→import { useState, useEffect, useCallback } from "react";
     2→import { toast } from "react-hot-toast";
     3→
     4→// Format currency
     5→const formatCurrency = (amount) => {
     6→  if (amount === null || amount === undefined) return "—";
     7→  return new Intl.NumberFormat("en-GB", {
     8→    style: "currency",
     9→    currency: "GBP",
    10→  }).format(amount);
    11→};
    12→
    13→// Format date helper
    14→const formatDate = (date) => {
    15→  if (!date) return "";
    16→  return new Date(date).toLocaleDateString("en-GB", {
    17→    day: "numeric",
    18→    month: "short",
    19→    year: "numeric",
    20→  });
    21→};
    22→
    23→// Format datetime helper
    24→const formatDateTime = (date) => {
    25→  if (!date) return "";
    26→  return new Date(date).toLocaleString("en-GB", {
    27→    day: "numeric",
    28→    month: "short",
    29→    year: "numeric",
    30→    hour: "2-digit",
    31→    minute: "2-digit",
    32→  });
    33→};
    34→
    35→// Status labels and colors
    36→const STATUS_CONFIG = {
    37→  DRAFT: { label: "Draft", color: "bg-slate-100 text-slate-600" },
    38→  DEPOSIT_TAKEN: { label: "Deposit Taken", color: "bg-amber-100 text-amber-700" },
    39→  INVOICED: { label: "Invoiced", color: "bg-blue-100 text-blue-700" },
    40→  DELIVERED: { label: "Delivered", color: "bg-purple-100 text-purple-700" },
    41→  COMPLETED: { label: "Completed", color: "bg-emerald-100 text-emerald-700" },
    42→  CANCELLED: { label: "Cancelled", color: "bg-red-100 text-red-700" },
    43→};
    44→
    45→const VAT_SCHEME_LABELS = {
    46→  MARGIN: "Margin Scheme",
    47→  VAT_QUALIFYING: "VAT Qualifying",
    48→  NO_VAT: "No VAT",
    49→};
    50→
    51→/**
    52→ * DealDrawer - Display and manage deal details
    53→ *
    54→ * Props:
    55→ * - dealId: The ID of the deal to display
    56→ * - isOpen: Whether the drawer is open
    57→ * - onClose: Function to call when closing the drawer
    58→ * - onUpdate: Function to call when deal is updated
    59→ */
    60→export default function DealDrawer({
    61→  dealId,
    62→  isOpen,
    63→  onClose,
    64→  onUpdate,
    65→}) {
    66→  const [deal, setDeal] = useState(null);
    67→  const [isLoading, setIsLoading] = useState(false);
    68→  const [activeTab, setActiveTab] = useState("overview");
    69→  const [actionLoading, setActionLoading] = useState(null);
    70→
    71→  // Deposit modal state
    72→  const [showDepositModal, setShowDepositModal] = useState(false);
    73→  const [depositAmount, setDepositAmount] = useState("");
    74→  const [depositMethod, setDepositMethod] = useState("CARD");
    75→  const [depositReference, setDepositReference] = useState("");
    76→
    77→  // Lock body scroll when drawer is open
    78→  useEffect(() => {
    79→    if (isOpen) {
    80→      const scrollY = window.scrollY;
    81→      const html = document.documentElement;
    82→
    83→      document.body.style.position = "fixed";
    84→      document.body.style.top = `-${scrollY}px`;
    85→      document.body.style.left = "0";
    86→      document.body.style.right = "0";
    87→      document.body.style.width = "100%";
    88→      document.body.style.overflow = "hidden";
    89→      document.body.style.touchAction = "none";
    90→
    91→      html.style.overflow = "hidden";
    92→
    93→      return () => {
    94→        document.body.style.position = "";
    95→        document.body.style.top = "";
    96→        document.body.style.left = "";
    97→        document.body.style.right = "";
    98→        document.body.style.width = "";
    99→        document.body.style.overflow = "";
   100→        document.body.style.touchAction = "";
   101→
   102→        html.style.overflow = "";
   103→
   104→        window.scrollTo(0, scrollY);
   105→      };
   106→    }
   107→  }, [isOpen]);
   108→
   109→  useEffect(() => {
   110→    if (isOpen && dealId) {
   111→      fetchDeal();
   112→    }
   113→  }, [isOpen, dealId]);
   114→
   115→  const fetchDeal = async () => {
   116→    setIsLoading(true);
   117→    try {
   118→      const res = await fetch(`/api/deals/${dealId}`);
   119→      if (!res.ok) throw new Error("Failed to load deal");
   120→      const data = await res.json();
   121→      setDeal(data);
   122→    } catch (error) {
   123→      toast.error("Failed to load deal details");
   124→      console.error(error);
   125→    } finally {
   126→      setIsLoading(false);
   127→    }
   128→  };
   129→
   130→  // Calculate totals
   131→  const calculateTotals = () => {
   132→    if (!deal) return {};
   133→
   134→    const addOnsNetTotal = (deal.addOns || []).reduce(
   135→      (sum, a) => sum + (a.unitPriceNet * (a.qty || 1)),
   136→      0
   137→    );
   138→    const addOnsVatTotal = (deal.addOns || []).reduce((sum, a) => {
   139→      if (a.vatTreatment === "STANDARD") {
   140→        return sum + a.unitPriceNet * (a.qty || 1) * (a.vatRate || 0.2);
   141→      }
   142→      return sum;
   143→    }, 0);
   144→
   145→    let subtotal, totalVat, grandTotal;
   146→
   147→    if (deal.vatScheme === "VAT_QUALIFYING") {
   148→      subtotal = (deal.vehiclePriceNet || 0) + addOnsNetTotal;
   149→      totalVat = (deal.vehicleVatAmount || 0) + addOnsVatTotal;
   150→      grandTotal = subtotal + totalVat;
   151→    } else {
   152→      subtotal = (deal.vehiclePriceGross || 0) + addOnsNetTotal + addOnsVatTotal;
   153→      totalVat = 0;
   154→      grandTotal = subtotal;
   155→    }
   156→
   157→    const totalPaid = (deal.payments || [])
   158→      .filter((p) => !p.isRefunded)
   159→      .reduce((sum, p) => sum + p.amount, 0);
   160→
   161→    const pxNetValue = deal.partExchange
   162→      ? (deal.partExchange.allowance || 0) - (deal.partExchange.settlement || 0)
   163→      : 0;
   164→
   165→    const balanceDue = grandTotal - totalPaid - pxNetValue;
   166→
   167→    return {
   168→      addOnsNetTotal,
   169→      addOnsVatTotal,
   170→      subtotal,
   171→      totalVat,
   172→      grandTotal,
   173→      totalPaid,
   174→      pxNetValue,
   175→      balanceDue,
   176→    };
   177→  };
   178→
   179→  // Deal actions
   180→  const handleTakeDeposit = async () => {
   181→    if (!depositAmount || parseFloat(depositAmount) <= 0) {
   182→      toast.error("Please enter a valid deposit amount");
   183→      return;
   184→    }
   185→
   186→    setActionLoading("deposit");
   187→    try {
   188→      const res = await fetch(`/api/deals/${dealId}/take-deposit`, {
   189→        method: "POST",
   190→        headers: { "Content-Type": "application/json" },
   191→        body: JSON.stringify({
   192→          amount: parseFloat(depositAmount),
   193→          method: depositMethod,
   194→          reference: depositReference,
   195→        }),
   196→      });
   197→
   198→      if (!res.ok) {
   199→        const err = await res.json();
   200→        throw new Error(err.error || "Failed to record deposit");
   201→      }
   202→
   203→      const result = await res.json();
   204→      toast.success(`Deposit recorded: ${result.documentNumber}`);
   205→      setShowDepositModal(false);
   206→      setDepositAmount("");
   207→      setDepositReference("");
   208→      fetchDeal();
   209→      onUpdate?.();
   210→    } catch (error) {
   211→      toast.error(error.message);
   212→    } finally {
   213→      setActionLoading(null);
   214→    }
   215→  };
   216→
   217→  const handleGenerateInvoice = async () => {
   218→    setActionLoading("invoice");
   219→    try {
   220→      const res = await fetch(`/api/deals/${dealId}/generate-invoice`, {
   221→        method: "POST",
   222→        headers: { "Content-Type": "application/json" },
   223→      });
   224→
   225→      if (!res.ok) {
   226→        const err = await res.json();
   227→        throw new Error(err.error || "Failed to generate invoice");
   228→      }
   229→
   230→      const result = await res.json();
   231→      toast.success(`Invoice generated: ${result.documentNumber}`);
   232→      fetchDeal();
   233→      onUpdate?.();
   234→    } catch (error) {
   235→      toast.error(error.message);
   236→    } finally {
   237→      setActionLoading(null);
   238→    }
   239→  };
   240→
   241→  const handleMarkDelivered = async () => {
   242→    setActionLoading("delivered");
   243→    try {
   244→      const res = await fetch(`/api/deals/${dealId}/mark-delivered`, {
   245→        method: "POST",
   246→        headers: { "Content-Type": "application/json" },
   247→      });
   248→
   249→      if (!res.ok) {
   250→        const err = await res.json();
   251→        throw new Error(err.error || "Failed to mark as delivered");
   252→      }
   253→
   254→      toast.success("Deal marked as delivered");
   255→      fetchDeal();
   256→      onUpdate?.();
   257→    } catch (error) {
   258→      toast.error(error.message);
   259→    } finally {
   260→      setActionLoading(null);
   261→    }
   262→  };
   263→
   264→  const handleMarkCompleted = async () => {
   265→    setActionLoading("completed");
   266→    try {
   267→      const res = await fetch(`/api/deals/${dealId}/mark-completed`, {
   268→        method: "POST",
   269→        headers: { "Content-Type": "application/json" },
   270→      });
   271→
   272→      if (!res.ok) {
   273→        const err = await res.json();
   274→        throw new Error(err.error || "Failed to complete deal");
   275→      }
   276→
   277→      toast.success("Deal completed");
   278→      fetchDeal();
   279→      onUpdate?.();
   280→    } catch (error) {
   281→      toast.error(error.message);
   282→    } finally {
   283→      setActionLoading(null);
   284→    }
   285→  };
   286→
   287→  const handleCancelDeal = async () => {
   288→    if (!confirm("Are you sure you want to cancel this deal?")) return;
   289→
   290→    setActionLoading("cancel");
   291→    try {
   292→      const res = await fetch(`/api/deals/${dealId}`, {
   293→        method: "DELETE",
   294→        headers: { "Content-Type": "application/json" },
   295→        body: JSON.stringify({ cancelReason: "Cancelled by user" }),
   296→      });
   297→
   298→      if (!res.ok) {
   299→        const err = await res.json();
   300→        throw new Error(err.error || "Failed to cancel deal");
   301→      }
   302→
   303→      toast.success("Deal cancelled");
   304→      fetchDeal();
   305→      onUpdate?.();
   306→    } catch (error) {
   307→      toast.error(error.message);
   308→    } finally {
   309→      setActionLoading(null);
   310→    }
   311→  };
   312→
   313→  if (!isOpen) return null;
   314→
   315→  const totals = calculateTotals();
   316→  const statusConfig = STATUS_CONFIG[deal?.status] || STATUS_CONFIG.DRAFT;
   317→
   318→  return (
   319→    <div
   320→      className="fixed inset-0 flex justify-end z-50 drawer-locked"
   321→      style={{ touchAction: "none", overscrollBehavior: "none" }}
   322→    >
   323→      {/* Backdrop */}
   324→      <div
   325→        className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity duration-300"
   326→        onClick={onClose}
   327→      />
   328→
   329→      {/* Drawer */}
   330→      <div
   331→        className="relative bg-[#f8fafc] flex flex-col w-full max-w-3xl min-w-0 translate-x-0 overflow-x-hidden shadow-2xl"
   332→        style={{
   333→          height: "100dvh",
   334→          maxHeight: "100dvh",
   335→          touchAction: "pan-y",
   336→        }}
   337→      >
   338→        {isLoading ? (
   339→          <div className="flex items-center justify-center h-full">
   340→            <span className="loading loading-spinner loading-lg"></span>
   341→          </div>
   342→        ) : !deal ? (
   343→          <div className="flex flex-col items-center justify-center h-full">
   344→            <p className="text-base-content/60">Deal not found</p>
   345→            <button className="btn btn-ghost btn-sm mt-2" onClick={onClose}>
   346→              Close
   347→            </button>
   348→          </div>
   349→        ) : (
   350→          <>
   351→            {/* Header */}
   352→            <div className="sticky top-0 bg-white border-b border-slate-100 px-4 md:px-6 py-4 md:py-5 z-10 shrink-0 shadow-sm">
   353→              <div className="flex items-center justify-between">
   354→                <div className="flex items-center gap-3">
   355→                  <button
   356→                    className="flex items-center justify-center w-9 h-9 rounded-xl bg-slate-100 hover:bg-[#0066CC]/10 text-slate-500 hover:text-[#0066CC] transition-all"
   357→                    onClick={onClose}
   358→                  >
   359→                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   360→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
   361→                    </svg>
   362→                  </button>
   363→                  <div>
   364→                    <h2 className="text-lg md:text-xl font-bold text-slate-900">
   365→                      Deal #{deal.dealNumber || "—"}
   366→                    </h2>
   367→                    <div className="flex items-center gap-2 mt-1">
   368→                      <span className={`inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-semibold ${statusConfig.color}`}>
   369→                        {statusConfig.label}
   370→                      </span>
   371→                      {deal.vehicle && (
   372→                        <span className="inline-flex items-center px-2.5 py-1 rounded-lg bg-slate-900 text-white text-xs font-mono font-bold tracking-wider">
   373→                          {deal.vehicle.regCurrent}
   374→                        </span>
   375→                      )}
   376→                    </div>
   377→                  </div>
   378→                </div>
   379→                <button
   380→                  className="flex items-center justify-center w-9 h-9 rounded-xl bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 transition-all"
   381→                  onClick={onClose}
   382→                >
   383→                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   384→                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   385→                  </svg>
   386→                </button>
   387→              </div>
   388→            </div>
   389→
   390→            {/* Tabs */}
   391→            <div className="sticky top-[73px] md:top-[89px] bg-white border-b border-slate-100 px-4 py-3 z-10 shrink-0">
   392→              {/* Mobile: Dropdown selector */}
   393→              <div className="md:hidden">
   394→                <select
   395→                  value={activeTab}
   396→                  onChange={(e) => setActiveTab(e.target.value)}
   397→                  className="select select-bordered w-full font-medium"
   398→                >
   399→                  <option value="overview">Overview</option>
   400→                  <option value="customer">Customer</option>
   401→                  <option value="addons">Add-ons ({deal.addOns?.length || 0})</option>
   402→                  <option value="payments">Payments ({deal.payments?.length || 0})</option>
   403→                </select>
   404→              </div>
   405→
   406→              {/* Desktop: Pill tabs */}
   407→              <div className="hidden md:flex items-center gap-2 overflow-x-auto pb-1 -mb-1">
   408→                {[
   409→                  { id: "overview", label: "Overview" },
   410→                  { id: "customer", label: "Customer" },
   411→                  { id: "addons", label: "Add-ons", count: deal.addOns?.length },
   412→                  { id: "payments", label: "Payments", count: deal.payments?.length },
   413→                ].map((tab) => (
   414→                  <button
   415→                    key={tab.id}
   416→                    onClick={() => setActiveTab(tab.id)}
   417→                    className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${
   418→                      activeTab === tab.id
   419→                        ? "bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25"
   420→                        : "bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-slate-900"
   421→                    }`}
   422→                  >
   423→                    <span>{tab.label}</span>
   424→                    {tab.count > 0 && (
   425→                      <span className={`inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold ${
   426→                        activeTab === tab.id
   427→                          ? "bg-white/20 text-white"
   428→                          : "bg-slate-200 text-slate-600"
   429→                      }`}>
   430→                        {tab.count}
   431→                      </span>
   432→                    )}
   433→                  </button>
   434→                ))}
   435→              </div>
   436→            </div>
   437→
   438→            {/* Content */}
   439→            <div
   440→              className="p-4 md:p-6 space-y-4 md:space-y-6 flex-1 overflow-y-auto overflow-x-hidden min-w-0 overscroll-contain"
   441→              style={{ paddingBottom: "calc(96px + env(safe-area-inset-bottom, 0px))" }}
   442→            >
   443→              {/* Overview Tab */}
   444→              {activeTab === "overview" && (
   445→                <div className="space-y-4">
   446→                  {/* Action Buttons */}
   447→                  {deal.status !== "COMPLETED" && deal.status !== "CANCELLED" && (
   448→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   449→                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   450→                        <h3 className="text-sm font-bold text-slate-800">Actions</h3>
   451→                      </div>
   452→                      <div className="p-4 flex flex-wrap gap-2">
   453→                        {deal.status === "DRAFT" && (
   454→                          <button
   455→                            onClick={() => setShowDepositModal(true)}
   456→                            disabled={actionLoading}
   457→                            className="btn btn-sm bg-amber-500 hover:bg-amber-600 text-white border-none"
   458→                          >
   459→                            {actionLoading === "deposit" ? (
   460→                              <span className="loading loading-spinner loading-xs"></span>
   461→                            ) : (
   462→                              "Take Deposit"
   463→                            )}
   464→                          </button>
   465→                        )}
   466→                        {(deal.status === "DEPOSIT_TAKEN" || deal.status === "DRAFT") && deal.soldToContactId && deal.vehiclePriceGross && (
   467→                          <button
   468→                            onClick={handleGenerateInvoice}
   469→                            disabled={actionLoading}
   470→                            className="btn btn-sm bg-blue-500 hover:bg-blue-600 text-white border-none"
   471→                          >
   472→                            {actionLoading === "invoice" ? (
   473→                              <span className="loading loading-spinner loading-xs"></span>
   474→                            ) : (
   475→                              "Generate Invoice"
   476→                            )}
   477→                          </button>
   478→                        )}
   479→                        {deal.status === "INVOICED" && (
   480→                          <button
   481→                            onClick={handleMarkDelivered}
   482→                            disabled={actionLoading}
   483→                            className="btn btn-sm bg-purple-500 hover:bg-purple-600 text-white border-none"
   484→                          >
   485→                            {actionLoading === "delivered" ? (
   486→                              <span className="loading loading-spinner loading-xs"></span>
   487→                            ) : (
   488→                              "Mark Delivered"
   489→                            )}
   490→                          </button>
   491→                        )}
   492→                        {deal.status === "DELIVERED" && (
   493→                          <button
   494→                            onClick={handleMarkCompleted}
   495→                            disabled={actionLoading}
   496→                            className="btn btn-sm bg-emerald-500 hover:bg-emerald-600 text-white border-none"
   497→                          >
   498→                            {actionLoading === "completed" ? (
   499→                              <span className="loading loading-spinner loading-xs"></span>
   500→                            ) : (
   501→                              "Complete Deal"
   502→                            )}
   503→                          </button>
   504→                        )}
   505→                        <button
   506→                          onClick={handleCancelDeal}
   507→                          disabled={actionLoading}
   508→                          className="btn btn-sm btn-ghost text-red-500 hover:bg-red-50"
   509→                        >
   510→                          Cancel Deal
   511→                        </button>
   512→                      </div>
   513→                    </div>
   514→                  )}
   515→
   516→                  {/* Vehicle Section */}
   517→                  {deal.vehicle && (
   518→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   519→                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   520→                        <div className="flex items-center gap-2">
   521→                          <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
   522→                            <svg className="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   523→                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h8m-8 5h8m-4-9a9 9 0 110 18 9 9 0 010-18z" />
   524→                            </svg>
   525→                          </div>
   526→                          <h3 className="text-sm font-bold text-slate-800">Vehicle</h3>
   527→                        </div>
   528→                      </div>
   529→                      <div className="p-4">
   530→                        <div className="flex items-start gap-4">
   531→                          {deal.vehicle.primaryImageUrl && (
   532→                            <img
   533→                              src={deal.vehicle.primaryImageUrl}
   534→                              alt={`${deal.vehicle.make} ${deal.vehicle.model}`}
   535→                              className="w-20 h-20 object-cover rounded-xl"
   536→                            />
   537→                          )}
   538→                          <div className="flex-1">
   539→                            <p className="font-semibold text-slate-900">
   540→                              {deal.vehicle.year} {deal.vehicle.make} {deal.vehicle.model}
   541→                            </p>
   542→                            <p className="text-sm text-slate-500 mt-1">
   543→                              {deal.vehicle.regCurrent}
   544→                            </p>
   545→                          </div>
   546→                        </div>
   547→                      </div>
   548→                    </div>
   549→                  )}
   550→
   551→                  {/* Pricing Summary */}
   552→                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   553→                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   554→                      <div className="flex items-center justify-between">
   555→                        <div className="flex items-center gap-2">
   556→                          <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
   557→                            <svg className="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   558→                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
   559→                            </svg>
   560→                          </div>
   561→                          <h3 className="text-sm font-bold text-slate-800">Pricing</h3>
   562→                        </div>
   563→                        <span className={`inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium ${
   564→                          deal.vatScheme === "VAT_QUALIFYING"
   565→                            ? "bg-blue-100 text-blue-700"
   566→                            : "bg-slate-100 text-slate-600"
   567→                        }`}>
   568→                          {VAT_SCHEME_LABELS[deal.vatScheme] || deal.vatScheme}
   569→                        </span>
   570→                      </div>
   571→                    </div>
   572→                    <div className="p-4 space-y-3">
   573→                      {/* Vehicle Price */}
   574→                      <div className="flex justify-between items-center">
   575→                        <span className="text-sm text-slate-600">Vehicle</span>
   576→                        <span className="font-semibold text-slate-900">
   577→                          {deal.vatScheme === "VAT_QUALIFYING"
   578→                            ? formatCurrency(deal.vehiclePriceNet)
   579→                            : formatCurrency(deal.vehiclePriceGross)}
   580→                        </span>
   581→                      </div>
   582→
   583→                      {/* Add-ons */}
   584→                      {totals.addOnsNetTotal > 0 && (
   585→                        <div className="flex justify-between items-center">
   586→                          <span className="text-sm text-slate-600">Add-ons</span>
   587→                          <span className="font-semibold text-slate-900">
   588→                            {formatCurrency(totals.addOnsNetTotal)}
   589→                          </span>
   590→                        </div>
   591→                      )}
   592→
   593→                      {/* VAT (only for VAT Qualifying) */}
   594→                      {deal.vatScheme === "VAT_QUALIFYING" && totals.totalVat > 0 && (
   595→                        <div className="flex justify-between items-center">
   596→                          <span className="text-sm text-slate-600">VAT @ 20%</span>
   597→                          <span className="font-semibold text-slate-900">
   598→                            {formatCurrency(totals.totalVat)}
   599→                          </span>
   600→                        </div>
   601→                      )}
   602→
   603→                      <div className="border-t border-slate-100 pt-3">
   604→                        <div className="flex justify-between items-center">
   605→                          <span className="text-sm font-semibold text-slate-700">Total</span>
   606→                          <span className="text-lg font-bold text-slate-900">
   607→                            {formatCurrency(totals.grandTotal)}
   608→                          </span>
   609→                        </div>
   610→                      </div>
   611→
   612→                      {/* Part Exchange */}
   613→                      {totals.pxNetValue > 0 && (
   614→                        <div className="flex justify-between items-center text-emerald-600">
   615→                          <span className="text-sm">Part Exchange</span>
   616→                          <span className="font-semibold">-{formatCurrency(totals.pxNetValue)}</span>
   617→                        </div>
   618→                      )}
   619→
   620→                      {/* Payments */}
   621→                      {totals.totalPaid > 0 && (
   622→                        <div className="flex justify-between items-center text-emerald-600">
   623→                          <span className="text-sm">Paid</span>
   624→                          <span className="font-semibold">-{formatCurrency(totals.totalPaid)}</span>
   625→                        </div>
   626→                      )}
   627→
   628→                      {/* Balance Due */}
   629→                      <div className="border-t border-slate-100 pt-3">
   630→                        <div className="flex justify-between items-center">
   631→                          <span className="text-sm font-semibold text-slate-700">Balance Due</span>
   632→                          <span className={`text-lg font-bold ${
   633→                            totals.balanceDue <= 0 ? "text-emerald-600" : "text-slate-900"
   634→                          }`}>
   635→                            {formatCurrency(Math.max(0, totals.balanceDue))}
   636→                          </span>
   637→                        </div>
   638→                      </div>
   639→                    </div>
   640→                  </div>
   641→
   642→                  {/* Timeline */}
   643→                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   644→                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   645→                      <div className="flex items-center gap-2">
   646→                        <div className="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center">
   647→                          <svg className="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   648→                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
   649→                          </svg>
   650→                        </div>
   651→                        <h3 className="text-sm font-bold text-slate-800">Timeline</h3>
   652→                      </div>
   653→                    </div>
   654→                    <div className="p-4 space-y-3 text-sm">
   655→                      <div className="flex justify-between">
   656→                        <span className="text-slate-500">Created</span>
   657→                        <span className="text-slate-900">{formatDateTime(deal.createdAt)}</span>
   658→                      </div>
   659→                      {deal.depositTakenAt && (
   660→                        <div className="flex justify-between">
   661→                          <span className="text-slate-500">Deposit Taken</span>
   662→                          <span className="text-slate-900">{formatDateTime(deal.depositTakenAt)}</span>
   663→                        </div>
   664→                      )}
   665→                      {deal.invoicedAt && (
   666→                        <div className="flex justify-between">
   667→                          <span className="text-slate-500">Invoiced</span>
   668→                          <span className="text-slate-900">{formatDateTime(deal.invoicedAt)}</span>
   669→                        </div>
   670→                      )}
   671→                      {deal.deliveredAt && (
   672→                        <div className="flex justify-between">
   673→                          <span className="text-slate-500">Delivered</span>
   674→                          <span className="text-slate-900">{formatDateTime(deal.deliveredAt)}</span>
   675→                        </div>
   676→                      )}
   677→                      {deal.completedAt && (
   678→                        <div className="flex justify-between">
   679→                          <span className="text-slate-500">Completed</span>
   680→                          <span className="text-slate-900">{formatDateTime(deal.completedAt)}</span>
   681→                        </div>
   682→                      )}
   683→                      {deal.cancelledAt && (
   684→                        <div className="flex justify-between text-red-600">
   685→                          <span>Cancelled</span>
   686→                          <span>{formatDateTime(deal.cancelledAt)}</span>
   687→                        </div>
   688→                      )}
   689→                    </div>
   690→                  </div>
   691→
   692→                  {/* Notes */}
   693→                  {(deal.notes || deal.internalNotes) && (
   694→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   695→                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   696→                        <h3 className="text-sm font-bold text-slate-800">Notes</h3>
   697→                      </div>
   698→                      <div className="p-4 space-y-3">
   699→                        {deal.notes && (
   700→                          <div>
   701→                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Customer Notes</span>
   702→                            <p className="text-sm text-slate-700 mt-1">{deal.notes}</p>
   703→                          </div>
   704→                        )}
   705→                        {deal.internalNotes && (
   706→                          <div>
   707→                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Internal Notes</span>
   708→                            <p className="text-sm text-slate-700 mt-1">{deal.internalNotes}</p>
   709→                          </div>
   710→                        )}
   711→                      </div>
   712→                    </div>
   713→                  )}
   714→                </div>
   715→              )}
   716→
   717→              {/* Customer Tab */}
   718→              {activeTab === "customer" && (
   719→                <div className="space-y-4">
   720→                  {deal.customer ? (
   721→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   722→                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   723→                        <div className="flex items-center gap-2">
   724→                          <div className="w-8 h-8 rounded-lg bg-[#0066CC]/10 flex items-center justify-center">
   725→                            <svg className="w-4 h-4 text-[#0066CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   726→                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
   727→                            </svg>
   728→                          </div>
   729→                          <h3 className="text-sm font-bold text-slate-800">Sold To</h3>
   730→                        </div>
   731→                      </div>
   732→                      <div className="p-4 space-y-3">
   733→                        <div>
   734→                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Name</span>
   735→                          <p className="font-semibold text-slate-900 mt-0.5">{deal.customer.displayName}</p>
   736→                        </div>
   737→                        {deal.customer.companyName && (
   738→                          <div>
   739→                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Company</span>
   740→                            <p className="text-slate-700 mt-0.5">{deal.customer.companyName}</p>
   741→                          </div>
   742→                        )}
   743→                        {deal.customer.email && (
   744→                          <div>
   745→                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Email</span>
   746→                            <p className="text-slate-700 mt-0.5">{deal.customer.email}</p>
   747→                          </div>
   748→                        )}
   749→                        {deal.customer.phone && (
   750→                          <div>
   751→                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Phone</span>
   752→                            <p className="text-slate-700 mt-0.5">{deal.customer.phone}</p>
   753→                          </div>
   754→                        )}
   755→                      </div>
   756→                    </div>
   757→                  ) : (
   758→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center">
   759→                      <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
   760→                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   761→                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
   762→                        </svg>
   763→                      </div>
   764→                      <p className="text-sm font-medium text-slate-600">No customer assigned</p>
   765→                      <p className="text-xs text-slate-400 mt-1">Add a customer to proceed with the deal</p>
   766→                    </div>
   767→                  )}
   768→
   769→                  {/* Invoice To (if different) */}
   770→                  {deal.invoiceTo && deal.invoiceTo.id !== deal.customer?.id && (
   771→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   772→                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   773→                        <div className="flex items-center gap-2">
   774→                          <div className="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center">
   775→                            <svg className="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   776→                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   777→                            </svg>
   778→                          </div>
   779→                          <h3 className="text-sm font-bold text-slate-800">Invoice To</h3>
   780→                        </div>
   781→                      </div>
   782→                      <div className="p-4 space-y-3">
   783→                        <div>
   784→                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Name</span>
   785→                          <p className="font-semibold text-slate-900 mt-0.5">{deal.invoiceTo.displayName}</p>
   786→                        </div>
   787→                        {deal.invoiceTo.companyName && (
   788→                          <div>
   789→                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Company</span>
   790→                            <p className="text-slate-700 mt-0.5">{deal.invoiceTo.companyName}</p>
   791→                          </div>
   792→                        )}
   793→                      </div>
   794→                    </div>
   795→                  )}
   796→
   797→                  {/* Part Exchange */}
   798→                  {deal.partExchange && (
   799→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   800→                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   801→                        <div className="flex items-center gap-2">
   802→                          <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
   803→                            <svg className="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   804→                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
   805→                            </svg>
   806→                          </div>
   807→                          <h3 className="text-sm font-bold text-slate-800">Part Exchange</h3>
   808→                        </div>
   809→                      </div>
   810→                      <div className="p-4 space-y-3">
   811→                        <div>
   812→                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Vehicle</span>
   813→                          <p className="font-semibold text-slate-900 mt-0.5">
   814→                            {deal.partExchange.vrm} - {deal.partExchange.make} {deal.partExchange.model}
   815→                          </p>
   816→                        </div>
   817→                        <div className="grid grid-cols-2 gap-4">
   818→                          <div>
   819→                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Allowance</span>
   820→                            <p className="font-semibold text-slate-900 mt-0.5">
   821→                              {formatCurrency(deal.partExchange.allowance)}
   822→                            </p>
   823→                          </div>
   824→                          {deal.partExchange.settlement > 0 && (
   825→                            <div>
   826→                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Settlement</span>
   827→                              <p className="font-semibold text-red-600 mt-0.5">
   828→                                -{formatCurrency(deal.partExchange.settlement)}
   829→                              </p>
   830→                            </div>
   831→                          )}
   832→                        </div>
   833→                        <div className="pt-2 border-t border-slate-100">
   834→                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Net Value</span>
   835→                          <p className="font-bold text-emerald-600 mt-0.5">
   836→                            {formatCurrency(totals.pxNetValue)}
   837→                          </p>
   838→                        </div>
   839→                      </div>
   840→                    </div>
   841→                  )}
   842→                </div>
   843→              )}
   844→
   845→              {/* Add-ons Tab */}
   846→              {activeTab === "addons" && (
   847→                <div className="space-y-4">
   848→                  {deal.addOns?.length > 0 ? (
   849→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   850→                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   851→                        <h3 className="text-sm font-bold text-slate-800">Add-ons</h3>
   852→                      </div>
   853→                      <div className="divide-y divide-slate-100">
   854→                        {deal.addOns.map((addon, idx) => (
   855→                          <div key={idx} className="p-4 flex items-center justify-between">
   856→                            <div>
   857→                              <p className="font-medium text-slate-900">{addon.name}</p>
   858→                              <p className="text-sm text-slate-500">
   859→                                {addon.qty > 1 && `${addon.qty} x `}
   860→                                {formatCurrency(addon.unitPriceNet)}
   861→                                {addon.vatTreatment === "STANDARD" && " + VAT"}
   862→                              </p>
   863→                            </div>
   864→                            <span className="font-semibold text-slate-900">
   865→                              {formatCurrency(addon.unitPriceNet * (addon.qty || 1))}
   866→                            </span>
   867→                          </div>
   868→                        ))}
   869→                      </div>
   870→                      <div className="px-4 py-3 bg-slate-50 border-t border-slate-100 flex justify-between">
   871→                        <span className="font-medium text-slate-700">Total</span>
   872→                        <span className="font-bold text-slate-900">
   873→                          {formatCurrency(totals.addOnsNetTotal + totals.addOnsVatTotal)}
   874→                        </span>
   875→                      </div>
   876→                    </div>
   877→                  ) : (
   878→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center">
   879→                      <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
   880→                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   881→                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
   882→                        </svg>
   883→                      </div>
   884→                      <p className="text-sm font-medium text-slate-600">No add-ons</p>
   885→                      <p className="text-xs text-slate-400 mt-1">Add products like warranties or accessories</p>
   886→                    </div>
   887→                  )}
   888→                </div>
   889→              )}
   890→
   891→              {/* Payments Tab */}
   892→              {activeTab === "payments" && (
   893→                <div className="space-y-4">
   894→                  {deal.payments?.length > 0 ? (
   895→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
   896→                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
   897→                        <h3 className="text-sm font-bold text-slate-800">Payments</h3>
   898→                      </div>
   899→                      <div className="divide-y divide-slate-100">
   900→                        {deal.payments.map((payment, idx) => (
   901→                          <div key={idx} className="p-4">
   902→                            <div className="flex items-center justify-between">
   903→                              <div>
   904→                                <div className="flex items-center gap-2">
   905→                                  <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${
   906→                                    payment.type === "DEPOSIT"
   907→                                      ? "bg-amber-100 text-amber-700"
   908→                                      : payment.type === "BALANCE"
   909→                                      ? "bg-emerald-100 text-emerald-700"
   910→                                      : "bg-slate-100 text-slate-600"
   911→                                  }`}>
   912→                                    {payment.type}
   913→                                  </span>
   914→                                  <span className="text-sm text-slate-500">{payment.method}</span>
   915→                                </div>
   916→                                <p className="text-xs text-slate-400 mt-1">
   917→                                  {formatDateTime(payment.paidAt)}
   918→                                  {payment.reference && ` • ${payment.reference}`}
   919→                                </p>
   920→                              </div>
   921→                              <span className={`font-semibold ${
   922→                                payment.isRefunded ? "text-red-500 line-through" : "text-emerald-600"
   923→                              }`}>
   924→                                {formatCurrency(payment.amount)}
   925→                              </span>
   926→                            </div>
   927→                          </div>
   928→                        ))}
   929→                      </div>
   930→                      <div className="px-4 py-3 bg-slate-50 border-t border-slate-100 flex justify-between">
   931→                        <span className="font-medium text-slate-700">Total Paid</span>
   932→                        <span className="font-bold text-emerald-600">
   933→                          {formatCurrency(totals.totalPaid)}
   934→                        </span>
   935→                      </div>
   936→                    </div>
   937→                  ) : (
   938→                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center">
   939→                      <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
   940→                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   941→                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
   942→                        </svg>
   943→                      </div>
   944→                      <p className="text-sm font-medium text-slate-600">No payments recorded</p>
   945→                      <p className="text-xs text-slate-400 mt-1">Take a deposit to get started</p>
   946→                    </div>
   947→                  )}
   948→                </div>
   949→              )}
   950→            </div>
   951→          </>
   952→        )}
   953→      </div>
   954→
   955→      {/* Deposit Modal */}
   956→      {showDepositModal && (
   957→        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
   958→          <div className="absolute inset-0 bg-black/50" onClick={() => setShowDepositModal(false)} />
   959→          <div className="relative bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
   960→            <h3 className="text-lg font-bold text-slate-900 mb-4">Take Deposit</h3>
   961→
   962→            <div className="space-y-4">
   963→              <div>
   964→                <label className="block text-sm font-medium text-slate-700 mb-1">
   965→                  Amount
   966→                </label>
   967→                <div className="relative">
   968→                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">£</span>
   969→                  <input
   970→                    type="number"
   971→                    value={depositAmount}
   972→                    onChange={(e) => setDepositAmount(e.target.value)}
   973→                    className="input input-bordered w-full pl-7"
   974→                    placeholder="0.00"
   975→                    step="0.01"
   976→                    min="0"
   977→                  />
   978→                </div>
   979→              </div>
   980→
   981→              <div>
   982→                <label className="block text-sm font-medium text-slate-700 mb-1">
   983→                  Payment Method
   984→                </label>
   985→                <select
   986→                  value={depositMethod}
   987→                  onChange={(e) => setDepositMethod(e.target.value)}
   988→                  className="select select-bordered w-full"
   989→                >
   990→                  <option value="CARD">Card</option>
   991→                  <option value="CASH">Cash</option>
   992→                  <option value="BANK_TRANSFER">Bank Transfer</option>
   993→                  <option value="FINANCE">Finance</option>
   994→                </select>
   995→              </div>
   996→
   997→              <div>
   998→                <label className="block text-sm font-medium text-slate-700 mb-1">
   999→                  Reference (optional)
  1000→                </label>
  1001→                <input
  1002→                  type="text"
  1003→                  value={depositReference}
  1004→                  onChange={(e) => setDepositReference(e.target.value)}
  1005→                  className="input input-bordered w-full"
  1006→                  placeholder="e.g., Transaction ID"
  1007→                />
  1008→              </div>
  1009→            </div>
  1010→
  1011→            <div className="flex gap-3 mt-6">
  1012→              <button
  1013→                onClick={() => setShowDepositModal(false)}
  1014→                className="btn btn-ghost flex-1"
  1015→              >
  1016→                Cancel
  1017→              </button>
  1018→              <button
  1019→                onClick={handleTakeDeposit}
  1020→                disabled={actionLoading === "deposit"}
  1021→                className="btn bg-amber-500 hover:bg-amber-600 text-white border-none flex-1"
  1022→              >
  1023→                {actionLoading === "deposit" ? (
  1024→                  <span className="loading loading-spinner loading-sm"></span>
  1025→                ) : (
  1026→                  "Record Deposit"
  1027→                )}
  1028→              </button>
  1029→            </div>
  1030→          </div>
  1031→        </div>
  1032→      )}
  1033→    </div>
  1034→  );
  1035→}
  1036→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
