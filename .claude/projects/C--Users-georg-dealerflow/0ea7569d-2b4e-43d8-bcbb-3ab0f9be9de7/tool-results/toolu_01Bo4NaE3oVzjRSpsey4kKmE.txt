     1→import { useEffect, useState, useCallback } from "react";
     2→import Head from "next/head";
     3→import { useRouter } from "next/router";
     4→import DashboardLayout from "@/components/DashboardLayout";
     5→import { toast } from "react-hot-toast";
     6→import useDealerRedirect from "@/hooks/useDealerRedirect";
     7→
     8→// Format currency
     9→const formatCurrency = (amount) => {
    10→  if (amount === null || amount === undefined) return "—";
    11→  return new Intl.NumberFormat("en-GB", {
    12→    style: "currency",
    13→    currency: "GBP",
    14→  }).format(amount);
    15→};
    16→
    17→// Format date
    18→const formatDate = (date) => {
    19→  if (!date) return "";
    20→  return new Date(date).toLocaleDateString("en-GB", {
    21→    day: "numeric",
    22→    month: "short",
    23→    year: "numeric",
    24→  });
    25→};
    26→
    27→export default function VATReport() {
    28→  const router = useRouter();
    29→  const { isRedirecting } = useDealerRedirect();
    30→  const [deals, setDeals] = useState([]);
    31→  const [isLoading, setIsLoading] = useState(true);
    32→
    33→  // Date range state
    34→  const [periodType, setPeriodType] = useState("quarter");
    35→  const [customFrom, setCustomFrom] = useState("");
    36→  const [customTo, setCustomTo] = useState("");
    37→
    38→  // Calculate period dates
    39→  const getPeriodDates = useCallback(() => {
    40→    const now = new Date();
    41→    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    42→
    43→    switch (periodType) {
    44→      case "this_month":
    45→        return {
    46→          from: new Date(now.getFullYear(), now.getMonth(), 1),
    47→          to: new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59),
    48→        };
    49→      case "last_month":
    50→        return {
    51→          from: new Date(now.getFullYear(), now.getMonth() - 1, 1),
    52→          to: new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59),
    53→        };
    54→      case "quarter":
    55→        const quarterStart = Math.floor(now.getMonth() / 3) * 3;
    56→        return {
    57→          from: new Date(now.getFullYear(), quarterStart, 1),
    58→          to: new Date(now.getFullYear(), quarterStart + 3, 0, 23, 59, 59),
    59→        };
    60→      case "last_quarter":
    61→        const lastQuarterStart = Math.floor(now.getMonth() / 3) * 3 - 3;
    62→        return {
    63→          from: new Date(now.getFullYear(), lastQuarterStart, 1),
    64→          to: new Date(now.getFullYear(), lastQuarterStart + 3, 0, 23, 59, 59),
    65→        };
    66→      case "ytd":
    67→        return {
    68→          from: new Date(now.getFullYear(), 0, 1),
    69→          to: today,
    70→        };
    71→      case "custom":
    72→        return {
    73→          from: customFrom ? new Date(customFrom) : null,
    74→          to: customTo ? new Date(customTo + "T23:59:59") : null,
    75→        };
    76→      default:
    77→        return { from: null, to: null };
    78→    }
    79→  }, [periodType, customFrom, customTo]);
    80→
    81→  // Fetch deals
    82→  const fetchDeals = useCallback(async () => {
    83→    setIsLoading(true);
    84→    try {
    85→      const res = await fetch("/api/deals");
    86→      if (!res.ok) throw new Error("Failed to fetch deals");
    87→      const data = await res.json();
    88→      setDeals(data);
    89→    } catch (error) {
    90→      console.error(error);
    91→      toast.error("Failed to load deals");
    92→    } finally {
    93→      setIsLoading(false);
    94→    }
    95→  }, []);
    96→
    97→  useEffect(() => {
    98→    if (!isRedirecting) {
    99→      fetchDeals();
   100→    }
   101→  }, [isRedirecting, fetchDeals]);
   102→
   103→  // Calculate VAT figures
   104→  const calculateVAT = useCallback(() => {
   105→    const { from, to } = getPeriodDates();
   106→    if (!from || !to) {
   107→      return {
   108→        vatQualifyingDeals: [],
   109→        marginDeals: [],
   110→        totalOutputVAT: 0,
   111→        totalSalesGross: 0,
   112→        totalSalesNet: 0,
   113→      };
   114→    }
   115→
   116→    // Filter deals by invoiced date
   117→    const invoicedDeals = deals.filter((deal) => {
   118→      if (!["INVOICED", "DELIVERED", "COMPLETED"].includes(deal.status)) return false;
   119→      if (!deal.invoicedAt) return false;
   120→      const invoiceDate = new Date(deal.invoicedAt);
   121→      return invoiceDate >= from && invoiceDate <= to;
   122→    });
   123→
   124→    // Separate by VAT scheme
   125→    const vatQualifyingDeals = invoicedDeals.filter(d => d.vatScheme === "VAT_QUALIFYING");
   126→    const marginDeals = invoicedDeals.filter(d => d.vatScheme === "MARGIN");
   127→
   128→    // Calculate totals
   129→    let totalOutputVAT = 0;
   130→    let totalSalesGross = 0;
   131→    let totalSalesNet = 0;
   132→
   133→    vatQualifyingDeals.forEach((deal) => {
   134→      totalOutputVAT += deal.vehicleVatAmount || 0;
   135→      totalSalesGross += deal.vehiclePriceGross || 0;
   136→      totalSalesNet += deal.vehiclePriceNet || 0;
   137→    });
   138→
   139→    marginDeals.forEach((deal) => {
   140→      totalSalesGross += deal.vehiclePriceGross || 0;
   141→    });
   142→
   143→    return {
   144→      vatQualifyingDeals,
   145→      marginDeals,
   146→      totalOutputVAT,
   147→      totalSalesGross,
   148→      totalSalesNet,
   149→      totalMarginGross: marginDeals.reduce((sum, d) => sum + (d.vehiclePriceGross || 0), 0),
   150→    };
   151→  }, [deals, getPeriodDates]);
   152→
   153→  const vatData = calculateVAT();
   154→  const { from, to } = getPeriodDates();
   155→
   156→  // Export to CSV
   157→  const handleExportCSV = () => {
   158→    const headers = [
   159→      "Invoice Date",
   160→      "Deal #",
   161→      "VRM",
   162→      "Make",
   163→      "Model",
   164→      "Customer",
   165→      "VAT Scheme",
   166→      "Net",
   167→      "VAT",
   168→      "Gross",
   169→    ];
   170→
   171→    const allDeals = [...vatData.vatQualifyingDeals, ...vatData.marginDeals];
   172→    const rows = allDeals.map((d) => [
   173→      formatDate(d.invoicedAt),
   174→      d.dealNumber || "",
   175→      d.vehicle?.regCurrent || "",
   176→      d.vehicle?.make || "",
   177→      d.vehicle?.model || "",
   178→      d.customer?.displayName || "",
   179→      d.vatScheme || "",
   180→      (d.vehiclePriceNet || 0).toFixed(2),
   181→      (d.vehicleVatAmount || 0).toFixed(2),
   182→      (d.vehiclePriceGross || 0).toFixed(2),
   183→    ]);
   184→
   185→    const csvContent = [headers, ...rows]
   186→      .map((row) => row.map((cell) => `"${cell}"`).join(","))
   187→      .join("\n");
   188→
   189→    const blob = new Blob([csvContent], { type: "text/csv" });
   190→    const url = URL.createObjectURL(blob);
   191→    const a = document.createElement("a");
   192→    a.href = url;
   193→    a.download = `vat-report-${new Date().toISOString().split("T")[0]}.csv`;
   194→    a.click();
   195→    URL.revokeObjectURL(url);
   196→    toast.success("Report downloaded");
   197→  };
   198→
   199→  if (isRedirecting) {
   200→    return (
   201→      <DashboardLayout>
   202→        <div className="flex items-center justify-center min-h-screen">
   203→          <span className="loading loading-spinner loading-lg"></span>
   204→        </div>
   205→      </DashboardLayout>
   206→    );
   207→  }
   208→
   209→  return (
   210→    <DashboardLayout>
   211→      <Head>
   212→        <title>VAT Report | DealerHQ</title>
   213→      </Head>
   214→
   215→      <div className="min-h-screen bg-slate-50 pb-20">
   216→        {/* Header */}
   217→        <div className="sticky top-0 z-20 bg-white border-b border-slate-200 shadow-sm">
   218→          <div className="px-4 py-4 md:px-6 md:py-5">
   219→            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
   220→              <div className="flex items-center gap-3">
   221→                <button
   222→                  onClick={() => router.back()}
   223→                  className="flex items-center justify-center w-9 h-9 rounded-xl bg-slate-100 hover:bg-[#0066CC]/10 text-slate-500 hover:text-[#0066CC] transition-all"
   224→                >
   225→                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   226→                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
   227→                  </svg>
   228→                </button>
   229→                <div>
   230→                  <h1 className="text-xl md:text-2xl font-bold text-slate-900">VAT Report</h1>
   231→                  <p className="text-sm text-slate-500 mt-0.5">
   232→                    Output VAT summary for {from && to ? `${formatDate(from)} - ${formatDate(to)}` : "selected period"}
   233→                  </p>
   234→                </div>
   235→              </div>
   236→
   237→              <button
   238→                onClick={handleExportCSV}
   239→                className="btn bg-[#0066CC] hover:bg-[#0052a3] text-white border-none"
   240→              >
   241→                <svg className="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   242→                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
   243→                </svg>
   244→                Export CSV
   245→              </button>
   246→            </div>
   247→          </div>
   248→        </div>
   249→
   250→        {/* Period Selector */}
   251→        <div className="px-4 md:px-6 py-4 bg-white border-b border-slate-200">
   252→          <div className="flex items-center gap-4 flex-wrap">
   253→            <span className="text-sm text-slate-500">Period:</span>
   254→            <select
   255→              value={periodType}
   256→              onChange={(e) => setPeriodType(e.target.value)}
   257→              className="select select-sm select-bordered bg-white"
   258→            >
   259→              <option value="this_month">This Month</option>
   260→              <option value="last_month">Last Month</option>
   261→              <option value="quarter">This Quarter</option>
   262→              <option value="last_quarter">Last Quarter</option>
   263→              <option value="ytd">Year to Date</option>
   264→              <option value="custom">Custom Range</option>
   265→            </select>
   266→
   267→            {periodType === "custom" && (
   268→              <div className="flex items-center gap-2">
   269→                <input
   270→                  type="date"
   271→                  value={customFrom}
   272→                  onChange={(e) => setCustomFrom(e.target.value)}
   273→                  className="input input-sm input-bordered bg-white w-36"
   274→                />
   275→                <span className="text-slate-400">to</span>
   276→                <input
   277→                  type="date"
   278→                  value={customTo}
   279→                  onChange={(e) => setCustomTo(e.target.value)}
   280→                  className="input input-sm input-bordered bg-white w-36"
   281→                />
   282→              </div>
   283→            )}
   284→          </div>
   285→        </div>
   286→
   287→        {/* Content */}
   288→        <div className="p-4 md:p-6 space-y-6">
   289→          {isLoading ? (
   290→            <div className="flex items-center justify-center py-20">
   291→              <span className="loading loading-spinner loading-lg text-[#0066CC]"></span>
   292→            </div>
   293→          ) : (
   294→            <>
   295→              {/* Summary Cards */}
   296→              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
   297→                <div className="bg-white rounded-2xl border border-blue-200 p-5">
   298→                  <p className="text-sm text-blue-600 font-medium">Output VAT Due</p>
   299→                  <p className="text-2xl font-bold text-blue-600 mt-1">
   300→                    {formatCurrency(vatData.totalOutputVAT)}
   301→                  </p>
   302→                  <p className="text-xs text-slate-400 mt-1">from VAT qualifying sales</p>
   303→                </div>
   304→                <div className="bg-white rounded-2xl border border-slate-200 p-5">
   305→                  <p className="text-sm text-slate-500 font-medium">Total Sales (Gross)</p>
   306→                  <p className="text-2xl font-bold text-slate-900 mt-1">
   307→                    {formatCurrency(vatData.totalSalesGross)}
   308→                  </p>
   309→                  <p className="text-xs text-slate-400 mt-1">all invoiced sales</p>
   310→                </div>
   311→                <div className="bg-white rounded-2xl border border-slate-200 p-5">
   312→                  <p className="text-sm text-slate-500 font-medium">VAT Qualifying</p>
   313→                  <p className="text-2xl font-bold text-slate-900 mt-1">
   314→                    {vatData.vatQualifyingDeals.length}
   315→                  </p>
   316→                  <p className="text-xs text-slate-400 mt-1">{formatCurrency(vatData.totalSalesNet)} net</p>
   317→                </div>
   318→                <div className="bg-white rounded-2xl border border-slate-200 p-5">
   319→                  <p className="text-sm text-slate-500 font-medium">Margin Scheme</p>
   320→                  <p className="text-2xl font-bold text-slate-900 mt-1">
   321→                    {vatData.marginDeals.length}
   322→                  </p>
   323→                  <p className="text-xs text-slate-400 mt-1">{formatCurrency(vatData.totalMarginGross)} gross</p>
   324→                </div>
   325→              </div>
   326→
   327→              {/* VAT Qualifying Sales Table */}
   328→              {vatData.vatQualifyingDeals.length > 0 && (
   329→                <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden">
   330→                  <div className="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
   331→                    <h2 className="text-lg font-bold text-slate-900">VAT Qualifying Sales</h2>
   332→                    <span className="text-sm text-blue-600 font-medium">
   333→                      VAT: {formatCurrency(vatData.totalOutputVAT)}
   334→                    </span>
   335→                  </div>
   336→                  <div className="overflow-x-auto">
   337→                    <table className="w-full">
   338→                      <thead className="bg-slate-50">
   339→                        <tr>
   340→                          <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Invoice Date</th>
   341→                          <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Deal #</th>
   342→                          <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Vehicle</th>
   343→                          <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Customer</th>
   344→                          <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Net</th>
   345→                          <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">VAT</th>
   346→                          <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Gross</th>
   347→                        </tr>
   348→                      </thead>
   349→                      <tbody className="divide-y divide-slate-100">
   350→                        {vatData.vatQualifyingDeals.map((deal) => (
   351→                          <tr key={deal.id} className="hover:bg-slate-50">
   352→                            <td className="px-5 py-3 text-sm text-slate-600">{formatDate(deal.invoicedAt)}</td>
   353→                            <td className="px-5 py-3 text-sm font-medium text-slate-900">#{deal.dealNumber}</td>
   354→                            <td className="px-5 py-3 text-sm text-slate-600">
   355→                              {deal.vehicle?.regCurrent} - {deal.vehicle?.make} {deal.vehicle?.model}
   356→                            </td>
   357→                            <td className="px-5 py-3 text-sm text-slate-600">{deal.customer?.displayName || "—"}</td>
   358→                            <td className="px-5 py-3 text-sm text-right text-slate-600">{formatCurrency(deal.vehiclePriceNet)}</td>
   359→                            <td className="px-5 py-3 text-sm text-right font-medium text-blue-600">{formatCurrency(deal.vehicleVatAmount)}</td>
   360→                            <td className="px-5 py-3 text-sm text-right font-medium text-slate-900">{formatCurrency(deal.vehiclePriceGross)}</td>
   361→                          </tr>
   362→                        ))}
   363→                      </tbody>
   364→                      <tfoot className="bg-blue-50">
   365→                        <tr>
   366→                          <td colSpan={4} className="px-5 py-3 text-sm font-semibold text-slate-700">Total</td>
   367→                          <td className="px-5 py-3 text-sm text-right font-semibold text-slate-700">{formatCurrency(vatData.totalSalesNet)}</td>
   368→                          <td className="px-5 py-3 text-sm text-right font-bold text-blue-600">{formatCurrency(vatData.totalOutputVAT)}</td>
   369→                          <td className="px-5 py-3 text-sm text-right font-semibold text-slate-700">
   370→                            {formatCurrency(vatData.vatQualifyingDeals.reduce((sum, d) => sum + (d.vehiclePriceGross || 0), 0))}
   371→                          </td>
   372→                        </tr>
   373→                      </tfoot>
   374→                    </table>
   375→                  </div>
   376→                </div>
   377→              )}
   378→
   379→              {/* Margin Scheme Sales Table */}
   380→              {vatData.marginDeals.length > 0 && (
   381→                <div className="bg-white rounded-2xl border border-slate-200 overflow-hidden">
   382→                  <div className="px-5 py-4 border-b border-slate-100 flex items-center justify-between">
   383→                    <h2 className="text-lg font-bold text-slate-900">Margin Scheme Sales</h2>
   384→                    <span className="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">No VAT breakdown</span>
   385→                  </div>
   386→                  <div className="overflow-x-auto">
   387→                    <table className="w-full">
   388→                      <thead className="bg-slate-50">
   389→                        <tr>
   390→                          <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Invoice Date</th>
   391→                          <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Deal #</th>
   392→                          <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Vehicle</th>
   393→                          <th className="text-left text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Customer</th>
   394→                          <th className="text-right text-xs font-semibold text-slate-500 uppercase tracking-wider px-5 py-3">Gross Sale</th>
   395→                        </tr>
   396→                      </thead>
   397→                      <tbody className="divide-y divide-slate-100">
   398→                        {vatData.marginDeals.map((deal) => (
   399→                          <tr key={deal.id} className="hover:bg-slate-50">
   400→                            <td className="px-5 py-3 text-sm text-slate-600">{formatDate(deal.invoicedAt)}</td>
   401→                            <td className="px-5 py-3 text-sm font-medium text-slate-900">#{deal.dealNumber}</td>
   402→                            <td className="px-5 py-3 text-sm text-slate-600">
   403→                              {deal.vehicle?.regCurrent} - {deal.vehicle?.make} {deal.vehicle?.model}
   404→                            </td>
   405→                            <td className="px-5 py-3 text-sm text-slate-600">{deal.customer?.displayName || "—"}</td>
   406→                            <td className="px-5 py-3 text-sm text-right font-medium text-slate-900">{formatCurrency(deal.vehiclePriceGross)}</td>
   407→                          </tr>
   408→                        ))}
   409→                      </tbody>
   410→                      <tfoot className="bg-slate-50">
   411→                        <tr>
   412→                          <td colSpan={4} className="px-5 py-3 text-sm font-semibold text-slate-700">Total</td>
   413→                          <td className="px-5 py-3 text-sm text-right font-semibold text-slate-700">{formatCurrency(vatData.totalMarginGross)}</td>
   414→                        </tr>
   415→                      </tfoot>
   416→                    </table>
   417→                  </div>
   418→                </div>
   419→              )}
   420→
   421→              {/* Empty State */}
   422→              {vatData.vatQualifyingDeals.length === 0 && vatData.marginDeals.length === 0 && (
   423→                <div className="bg-white rounded-2xl border border-slate-200 p-12 text-center">
   424→                  <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
   425→                    <svg className="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   426→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
   427→                    </svg>
   428→                  </div>
   429→                  <h3 className="text-lg font-semibold text-slate-900 mb-1">No invoiced sales</h3>
   430→                  <p className="text-slate-500">
   431→                    No invoiced deals found for the selected period
   432→                  </p>
   433→                </div>
   434→              )}
   435→            </>
   436→          )}
   437→        </div>
   438→      </div>
   439→    </DashboardLayout>
   440→  );
   441→}
   442→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
