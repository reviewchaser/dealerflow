     1→import { useState, useEffect, useCallback, useRef } from "react";
     2→import { toast } from "react-hot-toast";
     3→
     4→/**
     5→ * ContactPicker - Searchable contact picker with inline creation
     6→ *
     7→ * Props:
     8→ * - value: Selected contact ID
     9→ * - onChange: (contactId, contact) => void
    10→ * - filterTypeTags: Array of type tags to filter by (e.g., ["customer"])
    11→ * - placeholder: Input placeholder text
    12→ * - label: Optional label for the field
    13→ * - disabled: Whether the picker is disabled
    14→ * - allowCreate: Whether to allow creating new contacts (default true)
    15→ */
    16→export default function ContactPicker({
    17→  value,
    18→  onChange,
    19→  filterTypeTags = [],
    20→  placeholder = "Search contacts...",
    21→  label,
    22→  disabled = false,
    23→  allowCreate = true,
    24→}) {
    25→  const [isOpen, setIsOpen] = useState(false);
    26→  const [searchQuery, setSearchQuery] = useState("");
    27→  const [contacts, setContacts] = useState([]);
    28→  const [isLoading, setIsLoading] = useState(false);
    29→  const [selectedContact, setSelectedContact] = useState(null);
    30→  const [showCreateForm, setShowCreateForm] = useState(false);
    31→  const containerRef = useRef(null);
    32→  const inputRef = useRef(null);
    33→
    34→  // Create form state
    35→  const [createForm, setCreateForm] = useState({
    36→    contactType: "individual",
    37→    firstName: "",
    38→    lastName: "",
    39→    companyName: "",
    40→    email: "",
    41→    phone: "",
    42→  });
    43→  const [isCreating, setIsCreating] = useState(false);
    44→
    45→  // Load selected contact details
    46→  useEffect(() => {
    47→    if (value && !selectedContact) {
    48→      fetch(`/api/contacts/${value}`)
    49→        .then((res) => res.ok ? res.json() : null)
    50→        .then((data) => {
    51→          if (data) setSelectedContact(data);
    52→        })
    53→        .catch(() => {});
    54→    } else if (!value) {
    55→      setSelectedContact(null);
    56→    }
    57→  }, [value]);
    58→
    59→  // Search contacts
    60→  const searchContacts = useCallback(async () => {
    61→    setIsLoading(true);
    62→    try {
    63→      let url = `/api/contacts?search=${encodeURIComponent(searchQuery)}`;
    64→      if (filterTypeTags.length > 0) {
    65→        url += `&typeTag=${filterTypeTags[0]}`;
    66→      }
    67→      const res = await fetch(url);
    68→      if (!res.ok) throw new Error("Failed to search contacts");
    69→      const data = await res.json();
    70→      setContacts(data);
    71→    } catch (error) {
    72→      console.error(error);
    73→    } finally {
    74→      setIsLoading(false);
    75→    }
    76→  }, [searchQuery, filterTypeTags]);
    77→
    78→  useEffect(() => {
    79→    if (isOpen) {
    80→      searchContacts();
    81→    }
    82→  }, [isOpen, searchContacts]);
    83→
    84→  // Click outside handler
    85→  useEffect(() => {
    86→    const handleClickOutside = (e) => {
    87→      if (containerRef.current && !containerRef.current.contains(e.target)) {
    88→        setIsOpen(false);
    89→        setShowCreateForm(false);
    90→      }
    91→    };
    92→
    93→    document.addEventListener("mousedown", handleClickOutside);
    94→    return () => document.removeEventListener("mousedown", handleClickOutside);
    95→  }, []);
    96→
    97→  const handleSelect = (contact) => {
    98→    setSelectedContact(contact);
    99→    onChange?.(contact.id || contact._id, contact);
   100→    setIsOpen(false);
   101→    setSearchQuery("");
   102→  };
   103→
   104→  const handleClear = () => {
   105→    setSelectedContact(null);
   106→    onChange?.(null, null);
   107→    setSearchQuery("");
   108→  };
   109→
   110→  const handleCreate = async (e) => {
   111→    e.preventDefault();
   112→    setIsCreating(true);
   113→
   114→    try {
   115→      const payload = {
   116→        contactType: createForm.contactType,
   117→        firstName: createForm.firstName,
   118→        lastName: createForm.lastName,
   119→        companyName: createForm.companyName,
   120→        email: createForm.email,
   121→        phone: createForm.phone,
   122→        typeTags: filterTypeTags.length > 0 ? filterTypeTags : ["customer"],
   123→      };
   124→
   125→      const res = await fetch("/api/contacts", {
   126→        method: "POST",
   127→        headers: { "Content-Type": "application/json" },
   128→        body: JSON.stringify(payload),
   129→      });
   130→
   131→      if (!res.ok) {
   132→        const err = await res.json();
   133→        throw new Error(err.error || "Failed to create contact");
   134→      }
   135→
   136→      const newContact = await res.json();
   137→      toast.success("Contact created");
   138→      handleSelect(newContact);
   139→      setShowCreateForm(false);
   140→      setCreateForm({
   141→        contactType: "individual",
   142→        firstName: "",
   143→        lastName: "",
   144→        companyName: "",
   145→        email: "",
   146→        phone: "",
   147→      });
   148→    } catch (error) {
   149→      toast.error(error.message);
   150→    } finally {
   151→      setIsCreating(false);
   152→    }
   153→  };
   154→
   155→  return (
   156→    <div ref={containerRef} className="relative">
   157→      {label && (
   158→        <label className="block text-sm font-medium text-slate-700 mb-1">
   159→          {label}
   160→        </label>
   161→      )}
   162→
   163→      {/* Selected contact display or search input */}
   164→      {selectedContact ? (
   165→        <div className="flex items-center gap-2 p-3 bg-white border border-slate-200 rounded-xl">
   166→          <div className="w-10 h-10 bg-[#0066CC]/10 rounded-full flex items-center justify-center shrink-0">
   167→            <span className="text-sm font-bold text-[#0066CC]">
   168→              {(selectedContact.displayName || "?")[0].toUpperCase()}
   169→            </span>
   170→          </div>
   171→          <div className="flex-1 min-w-0">
   172→            <p className="font-medium text-slate-900 truncate">
   173→              {selectedContact.displayName}
   174→            </p>
   175→            {selectedContact.email && (
   176→              <p className="text-sm text-slate-500 truncate">
   177→                {selectedContact.email}
   178→              </p>
   179→            )}
   180→          </div>
   181→          {!disabled && (
   182→            <button
   183→              type="button"
   184→              onClick={handleClear}
   185→              className="btn btn-ghost btn-sm btn-circle text-slate-400 hover:text-red-500"
   186→            >
   187→              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   188→                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   189→              </svg>
   190→            </button>
   191→          )}
   192→        </div>
   193→      ) : (
   194→        <div className="relative">
   195→          <svg
   196→            className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"
   197→            fill="none"
   198→            stroke="currentColor"
   199→            viewBox="0 0 24 24"
   200→          >
   201→            <path
   202→              strokeLinecap="round"
   203→              strokeLinejoin="round"
   204→              strokeWidth={2}
   205→              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
   206→            />
   207→          </svg>
   208→          <input
   209→            ref={inputRef}
   210→            type="text"
   211→            value={searchQuery}
   212→            onChange={(e) => setSearchQuery(e.target.value)}
   213→            onFocus={() => setIsOpen(true)}
   214→            placeholder={placeholder}
   215→            disabled={disabled}
   216→            className="input input-bordered w-full pl-10"
   217→          />
   218→        </div>
   219→      )}
   220→
   221→      {/* Dropdown */}
   222→      {isOpen && !selectedContact && (
   223→        <div className="absolute z-50 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-xl max-h-80 overflow-hidden">
   224→          {showCreateForm ? (
   225→            <form onSubmit={handleCreate} className="p-4 space-y-3">
   226→              <div className="flex items-center justify-between mb-2">
   227→                <h4 className="font-semibold text-slate-900">New Contact</h4>
   228→                <button
   229→                  type="button"
   230→                  onClick={() => setShowCreateForm(false)}
   231→                  className="text-slate-400 hover:text-slate-600"
   232→                >
   233→                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   234→                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
   235→                  </svg>
   236→                </button>
   237→              </div>
   238→
   239→              <div className="flex gap-2">
   240→                <button
   241→                  type="button"
   242→                  onClick={() => setCreateForm((p) => ({ ...p, contactType: "individual" }))}
   243→                  className={`flex-1 btn btn-sm ${createForm.contactType === "individual" ? "btn-primary" : "btn-ghost"}`}
   244→                >
   245→                  Individual
   246→                </button>
   247→                <button
   248→                  type="button"
   249→                  onClick={() => setCreateForm((p) => ({ ...p, contactType: "company" }))}
   250→                  className={`flex-1 btn btn-sm ${createForm.contactType === "company" ? "btn-primary" : "btn-ghost"}`}
   251→                >
   252→                  Business
   253→                </button>
   254→              </div>
   255→
   256→              {createForm.contactType === "individual" ? (
   257→                <div className="grid grid-cols-2 gap-2">
   258→                  <input
   259→                    type="text"
   260→                    placeholder="First name"
   261→                    value={createForm.firstName}
   262→                    onChange={(e) => setCreateForm((p) => ({ ...p, firstName: e.target.value }))}
   263→                    className="input input-bordered input-sm"
   264→                    required
   265→                  />
   266→                  <input
   267→                    type="text"
   268→                    placeholder="Last name"
   269→                    value={createForm.lastName}
   270→                    onChange={(e) => setCreateForm((p) => ({ ...p, lastName: e.target.value }))}
   271→                    className="input input-bordered input-sm"
   272→                    required
   273→                  />
   274→                </div>
   275→              ) : (
   276→                <input
   277→                  type="text"
   278→                  placeholder="Company name"
   279→                  value={createForm.companyName}
   280→                  onChange={(e) => setCreateForm((p) => ({ ...p, companyName: e.target.value }))}
   281→                  className="input input-bordered input-sm w-full"
   282→                  required
   283→                />
   284→              )}
   285→
   286→              <input
   287→                type="email"
   288→                placeholder="Email (optional)"
   289→                value={createForm.email}
   290→                onChange={(e) => setCreateForm((p) => ({ ...p, email: e.target.value }))}
   291→                className="input input-bordered input-sm w-full"
   292→              />
   293→
   294→              <input
   295→                type="tel"
   296→                placeholder="Phone (optional)"
   297→                value={createForm.phone}
   298→                onChange={(e) => setCreateForm((p) => ({ ...p, phone: e.target.value }))}
   299→                className="input input-bordered input-sm w-full"
   300→              />
   301→
   302→              <div className="flex gap-2 pt-2">
   303→                <button
   304→                  type="button"
   305→                  onClick={() => setShowCreateForm(false)}
   306→                  className="btn btn-ghost btn-sm flex-1"
   307→                >
   308→                  Cancel
   309→                </button>
   310→                <button
   311→                  type="submit"
   312→                  disabled={isCreating}
   313→                  className="btn btn-primary btn-sm flex-1"
   314→                >
   315→                  {isCreating ? (
   316→                    <span className="loading loading-spinner loading-xs"></span>
   317→                  ) : (
   318→                    "Create"
   319→                  )}
   320→                </button>
   321→              </div>
   322→            </form>
   323→          ) : (
   324→            <>
   325→              {/* Search results */}
   326→              <div className="max-h-60 overflow-y-auto">
   327→                {isLoading ? (
   328→                  <div className="flex items-center justify-center py-8">
   329→                    <span className="loading loading-spinner loading-sm text-[#0066CC]"></span>
   330→                  </div>
   331→                ) : contacts.length === 0 ? (
   332→                  <div className="p-4 text-center">
   333→                    <p className="text-sm text-slate-500">
   334→                      {searchQuery ? "No contacts found" : "Type to search contacts"}
   335→                    </p>
   336→                  </div>
   337→                ) : (
   338→                  <div className="py-1">
   339→                    {contacts.slice(0, 10).map((contact) => (
   340→                      <button
   341→                        key={contact.id || contact._id}
   342→                        type="button"
   343→                        onClick={() => handleSelect(contact)}
   344→                        className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-slate-50 transition-colors text-left"
   345→                      >
   346→                        <div className="w-9 h-9 bg-[#0066CC]/10 rounded-full flex items-center justify-center shrink-0">
   347→                          <span className="text-sm font-bold text-[#0066CC]">
   348→                            {(contact.displayName || "?")[0].toUpperCase()}
   349→                          </span>
   350→                        </div>
   351→                        <div className="flex-1 min-w-0">
   352→                          <p className="font-medium text-slate-900 truncate">
   353→                            {contact.displayName}
   354→                          </p>
   355→                          <p className="text-xs text-slate-500 truncate">
   356→                            {contact.email || contact.phone || "No contact info"}
   357→                          </p>
   358→                        </div>
   359→                        {contact.typeTags?.includes("customer") && (
   360→                          <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-medium rounded">
   361→                            Customer
   362→                          </span>
   363→                        )}
   364→                      </button>
   365→                    ))}
   366→                  </div>
   367→                )}
   368→              </div>
   369→
   370→              {/* Create new option */}
   371→              {allowCreate && (
   372→                <div className="border-t border-slate-100 p-2">
   373→                  <button
   374→                    type="button"
   375→                    onClick={() => setShowCreateForm(true)}
   376→                    className="w-full flex items-center gap-2 px-3 py-2 text-sm font-medium text-[#0066CC] hover:bg-[#0066CC]/5 rounded-lg transition-colors"
   377→                  >
   378→                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   379→                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
   380→                    </svg>
   381→                    Create new contact
   382→                  </button>
   383→                </div>
   384→              )}
   385→            </>
   386→          )}
   387→        </div>
   388→      )}
   389→    </div>
   390→  );
   391→}
   392→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
