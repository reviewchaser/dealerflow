     1→import { useEffect, useState } from "react";
     2→import Head from "next/head";
     3→import { useRouter } from "next/router";
     4→
     5→// Format currency
     6→const formatCurrency = (amount) => {
     7→  if (amount === null || amount === undefined) return "—";
     8→  return new Intl.NumberFormat("en-GB", {
     9→    style: "currency",
    10→    currency: "GBP",
    11→  }).format(amount);
    12→};
    13→
    14→// Format date
    15→const formatDate = (date) => {
    16→  if (!date) return "";
    17→  return new Date(date).toLocaleDateString("en-GB", {
    18→    day: "numeric",
    19→    month: "long",
    20→    year: "numeric",
    21→  });
    22→};
    23→
    24→export default function InvoicePage() {
    25→  const router = useRouter();
    26→  const { token } = router.query;
    27→  const [document, setDocument] = useState(null);
    28→  const [isLoading, setIsLoading] = useState(true);
    29→  const [error, setError] = useState(null);
    30→
    31→  useEffect(() => {
    32→    if (!token) return;
    33→
    34→    const fetchDocument = async () => {
    35→      setIsLoading(true);
    36→      try {
    37→        const res = await fetch(`/api/public/invoice/${token}`);
    38→        if (!res.ok) {
    39→          const err = await res.json();
    40→          throw new Error(err.error || "Document not found");
    41→        }
    42→        const data = await res.json();
    43→        setDocument(data);
    44→      } catch (error) {
    45→        setError(error.message);
    46→      } finally {
    47→        setIsLoading(false);
    48→      }
    49→    };
    50→
    51→    fetchDocument();
    52→  }, [token]);
    53→
    54→  const handlePrint = () => {
    55→    window.print();
    56→  };
    57→
    58→  if (isLoading) {
    59→    return (
    60→      <div className="min-h-screen flex items-center justify-center bg-slate-100">
    61→        <div className="loading loading-spinner loading-lg text-blue-600"></div>
    62→      </div>
    63→    );
    64→  }
    65→
    66→  if (error) {
    67→    return (
    68→      <div className="min-h-screen flex items-center justify-center bg-slate-100">
    69→        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md text-center">
    70→          <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
    71→            <svg className="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    72→              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    73→            </svg>
    74→          </div>
    75→          <h1 className="text-xl font-bold text-slate-900 mb-2">Invoice Not Found</h1>
    76→          <p className="text-slate-500">{error}</p>
    77→        </div>
    78→      </div>
    79→    );
    80→  }
    81→
    82→  const snap = document.snapshotData;
    83→  const isMargin = snap.vatScheme === "MARGIN";
    84→  const invoiceTo = snap.invoiceTo?.name ? snap.invoiceTo : snap.customer;
    85→
    86→  return (
    87→    <>
    88→      <Head>
    89→        <title>Invoice {document.documentNumber} | DealerHQ</title>
    90→      </Head>
    91→
    92→      {/* Print controls - hidden when printing */}
    93→      <div className="print:hidden bg-slate-100 p-4 sticky top-0 z-10 border-b border-slate-200">
    94→        <div className="max-w-[800px] mx-auto flex items-center justify-between">
    95→          <h1 className="text-lg font-bold text-slate-900">Invoice</h1>
    96→          <button
    97→            onClick={handlePrint}
    98→            className="btn bg-blue-600 hover:bg-blue-700 text-white border-none"
    99→          >
   100→            <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
   101→              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
   102→            </svg>
   103→            Print / Download PDF
   104→          </button>
   105→        </div>
   106→      </div>
   107→
   108→      {/* Document */}
   109→      <div className="min-h-screen bg-slate-100 print:bg-white p-4 print:p-0">
   110→        <div className="max-w-[800px] mx-auto bg-white shadow-xl print:shadow-none rounded-2xl print:rounded-none overflow-hidden">
   111→          {/* Header with Logo */}
   112→          <div className="bg-white p-6 print:p-6 border-b border-slate-200">
   113→            <div className="flex items-start justify-between">
   114→              <div className="flex items-center gap-4">
   115→                {snap.dealer?.logoUrl && (
   116→                  <img
   117→                    src={snap.dealer.logoUrl}
   118→                    alt={snap.dealer.companyName || snap.dealer.name}
   119→                    className="h-16 w-auto object-contain"
   120→                  />
   121→                )}
   122→                <div>
   123→                  <p className="font-bold text-xl text-slate-900">{snap.dealer?.companyName || snap.dealer?.name}</p>
   124→                  {snap.dealer?.address && (
   125→                    <p className="text-slate-500 text-sm mt-1 whitespace-pre-line">{snap.dealer.address}</p>
   126→                  )}
   127→                  {snap.dealer?.phone && <p className="text-slate-500 text-sm">{snap.dealer.phone}</p>}
   128→                </div>
   129→              </div>
   130→              <div className="text-right">
   131→                <h1 className="text-3xl font-bold text-slate-900">INVOICE</h1>
   132→                <p className="text-slate-500 mt-1 text-lg">{document.documentNumber}</p>
   133→                <p className="text-slate-500 text-sm mt-2">{formatDate(document.issuedAt)}</p>
   134→                {snap.dealer?.vatNumber && (
   135→                  <p className="text-slate-400 text-sm mt-2">VAT: {snap.dealer.vatNumber}</p>
   136→                )}
   137→              </div>
   138→            </div>
   139→          </div>
   140→
   141→          {/* Details */}
   142→          <div className="p-8 print:p-6 space-y-8 print:space-y-6">
   143→            {/* Invoice Info Row */}
   144→            <div className="grid grid-cols-3 gap-6">
   145→              <div>
   146→                <p className="text-sm text-slate-500 uppercase tracking-wide font-medium">Invoice Date</p>
   147→                <p className="text-lg font-semibold text-slate-900 mt-1">{formatDate(document.issuedAt)}</p>
   148→              </div>
   149→              <div>
   150→                <p className="text-sm text-slate-500 uppercase tracking-wide font-medium">Invoice Number</p>
   151→                <p className="text-lg font-semibold text-slate-900 mt-1">{document.documentNumber}</p>
   152→              </div>
   153→              <div>
   154→                <p className="text-sm text-slate-500 uppercase tracking-wide font-medium">VAT Treatment</p>
   155→                <p className="text-lg font-semibold text-slate-900 mt-1">
   156→                  {isMargin ? "Margin Scheme" : snap.vatScheme === "VAT_QUALIFYING" ? "Standard VAT" : "Zero-rated"}
   157→                </p>
   158→              </div>
   159→            </div>
   160→
   161→            {/* Invoice To / Deliver To */}
   162→            <div className="grid grid-cols-2 gap-6">
   163→              <div className="bg-slate-50 rounded-xl p-5 print:bg-slate-50">
   164→                <p className="text-sm text-slate-500 uppercase tracking-wide font-medium mb-2">Invoice To</p>
   165→                <p className="text-lg font-bold text-slate-900">{invoiceTo?.name}</p>
   166→                {invoiceTo?.companyName && (
   167→                  <p className="text-slate-600">{invoiceTo.companyName}</p>
   168→                )}
   169→                {invoiceTo?.address && (
   170→                  <p className="text-slate-500 text-sm mt-1 whitespace-pre-line">
   171→                    {[invoiceTo.address.line1, invoiceTo.address.line2, invoiceTo.address.town, invoiceTo.address.county, invoiceTo.address.postcode].filter(Boolean).join("\n")}
   172→                  </p>
   173→                )}
   174→                {invoiceTo?.email && <p className="text-slate-500 text-sm mt-2">{invoiceTo.email}</p>}
   175→              </div>
   176→
   177→              {/* Deliver To (shown if customer is different or delivery address provided) */}
   178→              {snap.deliverTo && (
   179→                <div className="bg-emerald-50 rounded-xl p-5 print:bg-emerald-50">
   180→                  <p className="text-sm text-emerald-600 uppercase tracking-wide font-medium mb-2">Deliver To</p>
   181→                  <p className="text-lg font-bold text-slate-900">{snap.deliverTo.name}</p>
   182→                  {snap.deliverTo.companyName && (
   183→                    <p className="text-slate-600">{snap.deliverTo.companyName}</p>
   184→                  )}
   185→                  {snap.deliverTo.address && (
   186→                    <p className="text-slate-500 text-sm mt-1 whitespace-pre-line">
   187→                      {[snap.deliverTo.address.line1, snap.deliverTo.address.line2, snap.deliverTo.address.town, snap.deliverTo.address.county, snap.deliverTo.address.postcode].filter(Boolean).join("\n")}
   188→                    </p>
   189→                  )}
   190→                  {snap.deliverTo.phone && <p className="text-slate-500 text-sm mt-2">{snap.deliverTo.phone}</p>}
   191→                </div>
   192→              )}
   193→            </div>
   194→
   195→            {/* Line Items */}
   196→            <div>
   197→              <p className="text-sm text-slate-500 uppercase tracking-wide font-medium mb-3">Items</p>
   198→              <div className="border border-slate-200 rounded-xl overflow-hidden">
   199→                <table className="w-full">
   200→                  <thead className="bg-slate-50">
   201→                    <tr>
   202→                      <th className="text-left px-4 py-3 text-sm font-semibold text-slate-600">Description</th>
   203→                      <th className="text-right px-4 py-3 text-sm font-semibold text-slate-600 w-24">Qty</th>
   204→                      {!isMargin && <th className="text-right px-4 py-3 text-sm font-semibold text-slate-600 w-28">Net</th>}
   205→                      {!isMargin && <th className="text-right px-4 py-3 text-sm font-semibold text-slate-600 w-24">VAT</th>}
   206→                      <th className="text-right px-4 py-3 text-sm font-semibold text-slate-600 w-28">{isMargin ? "Price" : "Gross"}</th>
   207→                    </tr>
   208→                  </thead>
   209→                  <tbody className="divide-y divide-slate-100">
   210→                    {/* Vehicle */}
   211→                    <tr>
   212→                      <td className="px-4 py-3">
   213→                        <p className="font-semibold text-slate-900">{snap.vehicle?.year} {snap.vehicle?.make} {snap.vehicle?.model}</p>
   214→                        <p className="text-sm text-slate-500">{snap.vehicle?.regCurrent}{snap.vehicle?.vin ? ` | VIN: ${snap.vehicle.vin}` : ""}</p>
   215→                        <p className="text-sm text-slate-400">
   216→                          {[snap.vehicle?.colour, snap.vehicle?.mileage ? `${snap.vehicle.mileage.toLocaleString()} miles` : null].filter(Boolean).join(" | ")}
   217→                        </p>
   218→                      </td>
   219→                      <td className="px-4 py-3 text-right text-slate-600">1</td>
   220→                      {!isMargin && <td className="px-4 py-3 text-right text-slate-900">{formatCurrency(snap.vehiclePriceNet)}</td>}
   221→                      {!isMargin && <td className="px-4 py-3 text-right text-slate-600">{formatCurrency(snap.vehicleVatAmount)}</td>}
   222→                      <td className="px-4 py-3 text-right font-semibold text-slate-900">{formatCurrency(snap.vehiclePriceGross)}</td>
   223→                    </tr>
   224→
   225→                    {/* Add-ons */}
   226→                    {snap.addOns?.map((addon, idx) => {
   227→                      const addonVat = addon.vatTreatment === "STANDARD" ? addon.unitPriceNet * addon.qty * (addon.vatRate || 0.2) : 0;
   228→                      const addonGross = addon.unitPriceNet * addon.qty + addonVat;
   229→                      return (
   230→                        <tr key={idx}>
   231→                          <td className="px-4 py-3 text-slate-900">{addon.name}</td>
   232→                          <td className="px-4 py-3 text-right text-slate-600">{addon.qty}</td>
   233→                          {!isMargin && <td className="px-4 py-3 text-right text-slate-900">{formatCurrency(addon.unitPriceNet * addon.qty)}</td>}
   234→                          {!isMargin && <td className="px-4 py-3 text-right text-slate-600">{formatCurrency(addonVat)}</td>}
   235→                          <td className="px-4 py-3 text-right font-semibold text-slate-900">{formatCurrency(addonGross)}</td>
   236→                        </tr>
   237→                      );
   238→                    })}
   239→                  </tbody>
   240→                </table>
   241→              </div>
   242→            </div>
   243→
   244→            {/* Totals */}
   245→            <div className="flex justify-end">
   246→              <div className="w-72">
   247→                <div className="border border-slate-200 rounded-xl overflow-hidden">
   248→                  <table className="w-full">
   249→                    <tbody className="divide-y divide-slate-100">
   250→                      {!isMargin && (
   251→                        <>
   252→                          <tr>
   253→                            <td className="px-4 py-2 text-slate-600">Subtotal</td>
   254→                            <td className="px-4 py-2 text-right font-semibold text-slate-900">{formatCurrency(snap.subtotal)}</td>
   255→                          </tr>
   256→                          <tr>
   257→                            <td className="px-4 py-2 text-slate-600">VAT @ 20%</td>
   258→                            <td className="px-4 py-2 text-right font-semibold text-slate-900">{formatCurrency(snap.totalVat)}</td>
   259→                          </tr>
   260→                        </>
   261→                      )}
   262→                      <tr className="bg-slate-800 text-white">
   263→                        <td className="px-4 py-3 font-semibold">Total</td>
   264→                        <td className="px-4 py-3 text-right text-xl font-bold">{formatCurrency(snap.grandTotal)}</td>
   265→                      </tr>
   266→                      {snap.partExchangeNet > 0 && (
   267→                        <tr>
   268→                          <td className="px-4 py-2 text-emerald-600">Part Exchange</td>
   269→                          <td className="px-4 py-2 text-right font-semibold text-emerald-600">-{formatCurrency(snap.partExchangeNet)}</td>
   270→                        </tr>
   271→                      )}
   272→                      {snap.totalPaid > 0 && (
   273→                        <tr>
   274→                          <td className="px-4 py-2 text-emerald-600">Payments Received</td>
   275→                          <td className="px-4 py-2 text-right font-semibold text-emerald-600">-{formatCurrency(snap.totalPaid)}</td>
   276→                        </tr>
   277→                      )}
   278→                      <tr className="bg-blue-50">
   279→                        <td className="px-4 py-3 font-bold text-blue-900">Balance Due</td>
   280→                        <td className="px-4 py-3 text-right text-xl font-bold text-blue-900">{formatCurrency(snap.balanceDue)}</td>
   281→                      </tr>
   282→                    </tbody>
   283→                  </table>
   284→                </div>
   285→              </div>
   286→            </div>
   287→
   288→            {/* Margin Scheme Notice */}
   289→            {isMargin && (
   290→              <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 text-center">
   291→                <p className="text-amber-800 font-medium">Sold under the VAT margin scheme. No VAT is recoverable.</p>
   292→              </div>
   293→            )}
   294→
   295→            {/* Part Exchange Details */}
   296→            {snap.partExchange && (
   297→              <div className="bg-slate-50 rounded-xl p-5">
   298→                <p className="text-sm text-slate-500 uppercase tracking-wide font-medium mb-2">Part Exchange</p>
   299→                <div className="flex items-center justify-between">
   300→                  <div>
   301→                    <p className="font-semibold text-slate-900">{snap.partExchange.vrm} - {snap.partExchange.make} {snap.partExchange.model}</p>
   302→                    {snap.partExchange.settlement > 0 && (
   303→                      <p className="text-sm text-slate-500">Settlement: {formatCurrency(snap.partExchange.settlement)}</p>
   304→                    )}
   305→                  </div>
   306→                  <div className="text-right">
   307→                    <p className="text-sm text-slate-500">Allowance</p>
   308→                    <p className="text-lg font-bold text-emerald-600">{formatCurrency(snap.partExchange.allowance)}</p>
   309→                  </div>
   310→                </div>
   311→              </div>
   312→            )}
   313→
   314→            {/* Bank Details */}
   315→            {snap.bankDetails?.accountNumber && (
   316→              <div className="bg-blue-50 rounded-xl p-5 print:bg-blue-50">
   317→                <p className="text-sm text-blue-600 uppercase tracking-wide font-medium mb-3">Payment Details</p>
   318→                <div className="grid grid-cols-3 gap-4 text-sm">
   319→                  <div>
   320→                    <p className="text-blue-500">Account Name</p>
   321→                    <p className="font-semibold text-blue-900">{snap.bankDetails.accountName}</p>
   322→                  </div>
   323→                  <div>
   324→                    <p className="text-blue-500">Sort Code</p>
   325→                    <p className="font-semibold text-blue-900">{snap.bankDetails.sortCode}</p>
   326→                  </div>
   327→                  <div>
   328→                    <p className="text-blue-500">Account Number</p>
   329→                    <p className="font-semibold text-blue-900">{snap.bankDetails.accountNumber}</p>
   330→                  </div>
   331→                </div>
   332→              </div>
   333→            )}
   334→
   335→            {/* Terms */}
   336→            {snap.termsText && (
   337→              <div className="border-t border-slate-200 pt-6 print:break-before-page">
   338→                <p className="text-xs text-slate-400 uppercase tracking-wide font-medium mb-2">Terms & Conditions</p>
   339→                <p className="text-xs text-slate-500 whitespace-pre-line">{snap.termsText}</p>
   340→              </div>
   341→            )}
   342→
   343→            {/* Signature Section */}
   344→            <div className="border-t border-slate-200 pt-6">
   345→              <p className="text-sm text-slate-500 uppercase tracking-wide font-medium mb-6">Acknowledgement</p>
   346→              <div className="grid grid-cols-2 gap-8">
   347→                <div className="space-y-3">
   348→                  <p className="text-sm text-slate-600">I confirm receipt of the above vehicle and agree to the terms and conditions stated.</p>
   349→                  <div className="border-b-2 border-slate-300 pt-12 mt-4">
   350→                    <p className="text-xs text-slate-400 -mb-1">Customer Signature</p>
   351→                  </div>
   352→                  <div className="border-b border-slate-200 pt-6">
   353→                    <p className="text-xs text-slate-400 -mb-1">Print Name</p>
   354→                  </div>
   355→                  <div className="border-b border-slate-200 pt-6">
   356→                    <p className="text-xs text-slate-400 -mb-1">Date</p>
   357→                  </div>
   358→                </div>
   359→                <div className="space-y-3">
   360→                  <p className="text-sm text-slate-600">Authorised on behalf of {snap.dealer?.companyName || snap.dealer?.name}</p>
   361→                  <div className="border-b-2 border-slate-300 pt-12 mt-4">
   362→                    <p className="text-xs text-slate-400 -mb-1">Dealer Signature</p>
   363→                  </div>
   364→                  <div className="border-b border-slate-200 pt-6">
   365→                    <p className="text-xs text-slate-400 -mb-1">Print Name</p>
   366→                  </div>
   367→                  <div className="border-b border-slate-200 pt-6">
   368→                    <p className="text-xs text-slate-400 -mb-1">Date</p>
   369→                  </div>
   370→                </div>
   371→              </div>
   372→            </div>
   373→
   374→            {/* Footer */}
   375→            <div className="border-t border-slate-200 pt-6 text-center">
   376→              {snap.dealer?.companyNumber && (
   377→                <p className="text-sm text-slate-500">Registered Company: {snap.dealer.companyNumber}</p>
   378→              )}
   379→              <p className="text-xs text-slate-400 mt-4">Thank you for your business.</p>
   380→            </div>
   381→          </div>
   382→        </div>
   383→      </div>
   384→
   385→      <style jsx global>{`
   386→        @media print {
   387→          @page {
   388→            size: A4;
   389→            margin: 0;
   390→          }
   391→          body {
   392→            print-color-adjust: exact;
   393→            -webkit-print-color-adjust: exact;
   394→          }
   395→        }
   396→      `}</style>
   397→    </>
   398→  );
   399→}
   400→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
