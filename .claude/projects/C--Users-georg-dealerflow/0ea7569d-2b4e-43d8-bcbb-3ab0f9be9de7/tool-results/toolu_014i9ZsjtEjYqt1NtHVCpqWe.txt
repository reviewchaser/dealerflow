     1→import { useEffect, useState, useCallback } from "react";
     2→import Head from "next/head";
     3→import { useRouter } from "next/router";
     4→import DashboardLayout from "@/components/DashboardLayout";
     5→import DealDrawer from "@/components/DealDrawer";
     6→import { toast } from "react-hot-toast";
     7→import useDealerRedirect from "@/hooks/useDealerRedirect";
     8→
     9→// Status configuration
    10→const STATUS_TABS = [
    11→  { key: "all", label: "All" },
    12→  { key: "DRAFT", label: "Draft" },
    13→  { key: "DEPOSIT_TAKEN", label: "Deposit Taken" },
    14→  { key: "INVOICED", label: "Invoiced" },
    15→  { key: "DELIVERED", label: "Delivered" },
    16→  { key: "COMPLETED", label: "Completed" },
    17→  { key: "CANCELLED", label: "Cancelled" },
    18→];
    19→
    20→const STATUS_CONFIG = {
    21→  DRAFT: { label: "Draft", color: "bg-slate-100 text-slate-600" },
    22→  DEPOSIT_TAKEN: { label: "Deposit Taken", color: "bg-amber-100 text-amber-700" },
    23→  INVOICED: { label: "Invoiced", color: "bg-blue-100 text-blue-700" },
    24→  DELIVERED: { label: "Delivered", color: "bg-purple-100 text-purple-700" },
    25→  COMPLETED: { label: "Completed", color: "bg-emerald-100 text-emerald-700" },
    26→  CANCELLED: { label: "Cancelled", color: "bg-red-100 text-red-700" },
    27→};
    28→
    29→// Format currency
    30→const formatCurrency = (amount) => {
    31→  if (amount === null || amount === undefined) return "—";
    32→  return new Intl.NumberFormat("en-GB", {
    33→    style: "currency",
    34→    currency: "GBP",
    35→  }).format(amount);
    36→};
    37→
    38→// Format date helper
    39→const formatDate = (date) => {
    40→  if (!date) return "";
    41→  return new Date(date).toLocaleDateString("en-GB", {
    42→    day: "numeric",
    43→    month: "short",
    44→    year: "numeric",
    45→  });
    46→};
    47→
    48→export default function Sales() {
    49→  const router = useRouter();
    50→  const { isRedirecting } = useDealerRedirect();
    51→  const [deals, setDeals] = useState([]);
    52→  const [isLoading, setIsLoading] = useState(true);
    53→  const [selectedDealId, setSelectedDealId] = useState(null);
    54→  const [activeStatus, setActiveStatus] = useState("all");
    55→  const [searchQuery, setSearchQuery] = useState("");
    56→
    57→  // Load deals
    58→  const fetchDeals = useCallback(async () => {
    59→    setIsLoading(true);
    60→    try {
    61→      const statusParam = activeStatus !== "all" ? `?status=${activeStatus}` : "";
    62→      const response = await fetch(`/api/deals${statusParam}`);
    63→      if (!response.ok) throw new Error("Failed to fetch deals");
    64→      const data = await response.json();
    65→      setDeals(data);
    66→    } catch (error) {
    67→      console.error(error);
    68→      toast.error("Failed to load deals");
    69→    } finally {
    70→      setIsLoading(false);
    71→    }
    72→  }, [activeStatus]);
    73→
    74→  useEffect(() => {
    75→    if (!isRedirecting) {
    76→      fetchDeals();
    77→    }
    78→  }, [isRedirecting, fetchDeals]);
    79→
    80→  // Handle deal selection from URL
    81→  useEffect(() => {
    82→    if (router.query.id) {
    83→      setSelectedDealId(router.query.id);
    84→    }
    85→  }, [router.query.id]);
    86→
    87→  // Filter deals by search
    88→  const filteredDeals = deals.filter((deal) => {
    89→    if (!searchQuery) return true;
    90→    const query = searchQuery.toLowerCase();
    91→    return (
    92→      deal.vehicle?.regCurrent?.toLowerCase().includes(query) ||
    93→      deal.vehicle?.make?.toLowerCase().includes(query) ||
    94→      deal.vehicle?.model?.toLowerCase().includes(query) ||
    95→      deal.customer?.displayName?.toLowerCase().includes(query) ||
    96→      deal.customer?.companyName?.toLowerCase().includes(query) ||
    97→      deal.dealNumber?.toString().includes(query)
    98→    );
    99→  });
   100→
   101→  // Count by status
   102→  const statusCounts = deals.reduce((acc, deal) => {
   103→    acc[deal.status] = (acc[deal.status] || 0) + 1;
   104→    return acc;
   105→  }, {});
   106→
   107→  const handleDealClick = (dealId) => {
   108→    setSelectedDealId(dealId);
   109→    router.push(`/sales?id=${dealId}`, undefined, { shallow: true });
   110→  };
   111→
   112→  const handleDrawerClose = () => {
   113→    setSelectedDealId(null);
   114→    router.push("/sales", undefined, { shallow: true });
   115→  };
   116→
   117→  if (isRedirecting) {
   118→    return (
   119→      <DashboardLayout>
   120→        <div className="flex items-center justify-center min-h-screen">
   121→          <span className="loading loading-spinner loading-lg"></span>
   122→        </div>
   123→      </DashboardLayout>
   124→    );
   125→  }
   126→
   127→  return (
   128→    <DashboardLayout>
   129→      <Head>
   130→        <title>Sales | DealerHQ</title>
   131→      </Head>
   132→
   133→      <div className="min-h-screen bg-slate-50 pb-20">
   134→        {/* Header */}
   135→        <div className="sticky top-0 z-20 bg-white border-b border-slate-200 shadow-sm">
   136→          <div className="px-4 py-4 md:px-6 md:py-5">
   137→            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
   138→              <div>
   139→                <h1 className="text-xl md:text-2xl font-bold text-slate-900">Deals</h1>
   140→                <p className="text-sm text-slate-500 mt-0.5">
   141→                  {deals.length} deal{deals.length !== 1 ? "s" : ""} total
   142→                </p>
   143→              </div>
   144→
   145→              {/* Search */}
   146→              <div className="relative w-full md:w-72">
   147→                <svg
   148→                  className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"
   149→                  fill="none"
   150→                  stroke="currentColor"
   151→                  viewBox="0 0 24 24"
   152→                >
   153→                  <path
   154→                    strokeLinecap="round"
   155→                    strokeLinejoin="round"
   156→                    strokeWidth={2}
   157→                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
   158→                  />
   159→                </svg>
   160→                <input
   161→                  type="text"
   162→                  placeholder="Search by VRM, customer..."
   163→                  value={searchQuery}
   164→                  onChange={(e) => setSearchQuery(e.target.value)}
   165→                  className="input input-bordered w-full pl-10 h-10"
   166→                />
   167→              </div>
   168→            </div>
   169→
   170→            {/* Status Tabs */}
   171→            <div className="mt-4 -mb-px flex gap-1 overflow-x-auto pb-1 scrollbar-hide">
   172→              {STATUS_TABS.map((tab) => {
   173→                const count = tab.key === "all" ? deals.length : statusCounts[tab.key] || 0;
   174→                return (
   175→                  <button
   176→                    key={tab.key}
   177→                    onClick={() => setActiveStatus(tab.key)}
   178→                    className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${
   179→                      activeStatus === tab.key
   180→                        ? "bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25"
   181→                        : "bg-slate-100 text-slate-600 hover:bg-slate-200"
   182→                    }`}
   183→                  >
   184→                    {tab.label}
   185→                    {count > 0 && (
   186→                      <span
   187→                        className={`inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold ${
   188→                          activeStatus === tab.key
   189→                            ? "bg-white/20 text-white"
   190→                            : "bg-slate-200 text-slate-600"
   191→                        }`}
   192→                      >
   193→                        {count}
   194→                      </span>
   195→                    )}
   196→                  </button>
   197→                );
   198→              })}
   199→            </div>
   200→          </div>

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
