import { useEffect, useState, useRef, useCallback } from "react";
import Head from "next/head";
import Link from "next/link";
import { useRouter } from "next/router";
import DashboardLayout from "@/components/DashboardLayout";
import { toast } from "react-hot-toast";
import { showDummyNotification } from "@/utils/notifications";
import { BottomSheet } from "@/components/ui/BottomSheet";
import { Portal } from "@/components/ui/Portal";
import { MobileStageSelector } from "@/components/ui/PageShell";

const COLUMNS = [
  { key: "in_stock", label: "In Stock", gradient: "from-orange-100/60", accent: "border-l-orange-400", accentBg: "bg-orange-400" },
  { key: "in_prep", label: "Advertised", gradient: "from-blue-100/60", accent: "border-l-blue-400", accentBg: "bg-blue-400" },
  { key: "live", label: "Sold In Progress", gradient: "from-cyan-100/60", accent: "border-l-cyan-400", accentBg: "bg-cyan-400" },
  { key: "reserved", label: "Completed", gradient: "from-emerald-100/60", accent: "border-l-emerald-400", accentBg: "bg-emerald-400" },
  { key: "delivered", label: "Delivered", gradient: "from-teal-100/60", accent: "border-l-teal-400", accentBg: "bg-teal-400" },
];

const ISSUE_SUBCATEGORIES = {
  mechanical: ["Engine", "Transmission", "Suspension", "Brakes", "Exhaust", "Other"],
  electrical: ["Battery", "Lights", "Starter Motor", "Alternator", "Sensors", "Other"],
  bodywork: ["Panel Damage", "Scratches", "Dents", "Bumper", "Windscreen", "Other"],
  interior: ["Seats", "Dashboard", "Trim", "Carpet", "Controls", "Other"],
  tyres: ["Tread Depth", "Puncture", "Alloys", "Alignment", "Other"],
  mot: ["Advisory", "Failed Item", "Due Soon", "Other"],
  service: ["Oil Change", "Filters", "Fluids", "Timing Belt", "Other"],
  fault_codes: ["Engine", "Transmission", "ABS", "Airbag", "Emissions", "Other"],
  other: ["General", "Misc"],
};

// Sold statuses - these show "Sold X days" instead of "In stock X days"
const SOLD_STATUSES = ["live", "reserved", "delivered"];

// Helper to compute duration label based on status
const getVehicleDuration = (vehicle) => {
  const isSold = SOLD_STATUSES.includes(vehicle.status);

  if (isSold) {
    if (vehicle.soldAt) {
      const daysSold = Math.floor((Date.now() - new Date(vehicle.soldAt).getTime()) / (1000 * 60 * 60 * 24));
      return { days: daysSold, label: `Sold ${daysSold}d`, isSold: true };
    }
    // Legacy sold vehicle without soldAt - just show "Sold"
    return { days: 0, label: "Sold", isSold: true };
  }

  const daysInStock = vehicle.createdAt
    ? Math.floor((Date.now() - new Date(vehicle.createdAt).getTime()) / (1000 * 60 * 60 * 24))
    : 0;
  return { days: daysInStock, label: `${daysInStock}d in stock`, isSold: false };
};

export default function SalesPrep() {
  const router = useRouter();
  const [vehicles, setVehicles] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedVehicle, setSelectedVehicle] = useState(null);
  const [isLookingUpDrawer, setIsLookingUpDrawer] = useState(false);
  const [showAddModal, setShowAddModal] = useState(false);
  const [draggedCard, setDraggedCard] = useState(null);
  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });
  const [newTaskName, setNewTaskName] = useState("");
  const [activeTab, setActiveTab] = useState("overview");
  const [editingTaskId, setEditingTaskId] = useState(null);
  const [editingTaskName, setEditingTaskName] = useState("");

  // Parts ordering state
  const [showPartsOrderModal, setShowPartsOrderModal] = useState(false);
  const [partsOrderTaskId, setPartsOrderTaskId] = useState(null);
  const [partsOrderForm, setPartsOrderForm] = useState({
    supplierType: "EURO_CAR_PARTS",
    supplierName: "",
    orderRef: "",
    expectedAt: "",
    notes: "",
  });
  const [editingPartsOrderId, setEditingPartsOrderId] = useState(null);

  // Column sorting state
  const [columnSortOptions, setColumnSortOptions] = useState({});

  // Job sheet share state
  const [showJobSheetModal, setShowJobSheetModal] = useState(false);
  const [jobSheetLink, setJobSheetLink] = useState(null);
  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);

  // Prep summary share state
  const [showPrepSummaryModal, setShowPrepSummaryModal] = useState(false);
  const [prepSummaryLink, setPrepSummaryLink] = useState(null);
  const [isGeneratingPrepSummary, setIsGeneratingPrepSummary] = useState(false);

  // Manual share fallback modal
  const [showManualShareModal, setShowManualShareModal] = useState(false);
  const [manualShareUrl, setManualShareUrl] = useState("");

  // Issues state
  const [showAddIssueModal, setShowAddIssueModal] = useState(false);
  const [editingIssue, setEditingIssue] = useState(null); // For edit mode
  const [issueForm, setIssueForm] = useState({
    category: "",
    subcategory: "",
    description: "",
    actionNeeded: "",
    priority: "medium",
    location: "",
    status: "outstanding",
    notes: "",
    photos: [],
    partsRequired: false,
    partsDetails: "",
  });
  const [issueUpdateContent, setIssueUpdateContent] = useState({});
  const [expandedIssues, setExpandedIssues] = useState({});

  // Filters state - with localStorage persistence
  const [activeFilters, setActiveFilters] = useState([]);
  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);
  const filterButtonRef = useRef(null);
  const [filterPopoverPos, setFilterPopoverPos] = useState({ top: 0, right: 0 });

  // Calculate popover position when opening
  const openFiltersDropdown = useCallback(() => {
    if (filterButtonRef.current) {
      const rect = filterButtonRef.current.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      const viewportWidth = window.innerWidth;

      // Position below the button, aligned to right edge
      let top = rect.bottom + 8;
      let right = viewportWidth - rect.right;

      // Ensure popover doesn't go below viewport (max 70vh height + 16px padding)
      const popoverHeight = Math.min(viewportHeight * 0.7, 600);
      if (top + popoverHeight > viewportHeight - 16) {
        top = Math.max(16, viewportHeight - popoverHeight - 16);
      }

      // Ensure popover doesn't go off right edge
      right = Math.max(16, right);

      setFilterPopoverPos({ top, right });
    }
    setShowFiltersDropdown(true);
  }, []);

  // Load filters from localStorage on mount
  useEffect(() => {
    try {
      const savedFilters = localStorage.getItem("salesPrepFilters");
      if (savedFilters) {
        setActiveFilters(JSON.parse(savedFilters));
      }
    } catch (e) {
      console.warn("Failed to load saved filters:", e);
    }
  }, []);

  // Save filters to localStorage when they change
  useEffect(() => {
    try {
      localStorage.setItem("salesPrepFilters", JSON.stringify(activeFilters));
    } catch (e) {
      console.warn("Failed to save filters:", e);
    }
  }, [activeFilters]);

  // Documents state
  const [showAddDocumentModal, setShowAddDocumentModal] = useState(false);
  const [documentForm, setDocumentForm] = useState({
    name: "",
    type: "other",
    file: null,
  });

  // Location state
  const [locations, setLocations] = useState([]);
  const [showAddLocationModal, setShowAddLocationModal] = useState(false);

  // Vehicle Labels state
  const [availableLabels, setAvailableLabels] = useState([]);
  const [showLabelsDropdown, setShowLabelsDropdown] = useState(false);
  const [showAddLabelModal, setShowAddLabelModal] = useState(false);
  const [newLabelForm, setNewLabelForm] = useState({ name: "", colour: "#6366f1" });

  // Activity log state
  const [activityData, setActivityData] = useState({ activities: [], total: 0, hasMore: false });
  const [activityLoading, setActivityLoading] = useState(false);

  // VRM Search state
  const [vrmSearch, setVrmSearch] = useState("");
  const [showVrmDropdown, setShowVrmDropdown] = useState(false);

  // Mobile state
  const [mobileActiveColumn, setMobileActiveColumn] = useState("in_stock");

  useEffect(() => {
    fetchVehicles();
    fetchLocations();
    fetchLabels();
  }, []);

  // Handle addVehicle query param (from Quick Add menu)
  useEffect(() => {
    if (router.query.addVehicle === "1") {
      setShowAddModal(true);
      // Remove the query param from URL without reload
      router.replace("/sales-prep", undefined, { shallow: true });
    }
  }, [router.query.addVehicle]);

  const fetchVehicles = async () => {
    try {
      const res = await fetch("/api/vehicles");
      if (!res.ok) {
        throw new Error(`API error: ${res.status}`);
      }
      const data = await res.json();
      setVehicles(Array.isArray(data) ? data : []);
    } catch (error) {
      console.error("Failed to load vehicles:", error);
      toast.error("Failed to load vehicles");
      setVehicles([]);
    } finally {
      setIsLoading(false);
    }
  };

  const fetchLocations = async () => {
    try {
      const res = await fetch("/api/locations");
      const data = await res.json();
      setLocations(data);
    } catch (error) {
      console.error("Failed to load locations:", error);
    }
  };

  const fetchLabels = async () => {
    try {
      const res = await fetch("/api/labels");
      const data = await res.json();
      setAvailableLabels(Array.isArray(data) ? data : []);
    } catch (error) {
      console.error("Failed to load labels:", error);
    }
  };

  // Fetch vehicle activity log
  const fetchActivity = async (vehicleId, loadMore = false) => {
    if (!vehicleId) return;
    setActivityLoading(true);
    try {
      const offset = loadMore ? activityData.activities.length : 0;
      const res = await fetch(`/api/vehicles/${vehicleId}/activity?limit=25&offset=${offset}`);
      const data = await res.json();
      if (loadMore) {
        setActivityData(prev => ({
          activities: [...prev.activities, ...data.activities],
          total: data.total,
          hasMore: data.hasMore,
        }));
      } else {
        setActivityData(data);
      }
    } catch (error) {
      console.error("Failed to load activity:", error);
    } finally {
      setActivityLoading(false);
    }
  };

  // Format relative time for activity log
  const formatRelativeTime = (dateStr) => {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return "just now";
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString("en-GB", { day: "numeric", month: "short" });
  };

  // Toggle a label on/off for a vehicle
  const toggleVehicleLabel = async (vehicleId, labelId) => {
    try {
      const res = await fetch(`/api/vehicles/${vehicleId}/labels/${labelId}`, {
        method: "POST",
      });
      if (res.ok) {
        const updatedData = await res.json();
        // Update selected vehicle if it's the same one
        if (selectedVehicle?.id === vehicleId) {
          setSelectedVehicle(prev => ({
            ...prev,
            labels: updatedData.labels || [],
          }));
        }
        fetchVehicles();
      }
    } catch (error) {
      toast.error("Failed to update label");
    }
  };

  // Create a new label
  const createLabel = async () => {
    if (!newLabelForm.name.trim()) {
      toast.error("Label name is required");
      return;
    }
    try {
      const res = await fetch("/api/labels", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newLabelForm),
      });
      if (res.ok) {
        const newLabel = await res.json();
        setAvailableLabels(prev => [...prev, newLabel]);
        setNewLabelForm({ name: "", colour: "#6366f1" });
        setShowAddLabelModal(false);
        toast.success("Label created");
      }
    } catch (error) {
      toast.error("Failed to create label");
    }
  };

  // Open vehicle drawer - vehicle from grid already has tasks, issues, documents
  const openVehicleDrawer = (vehicle) => {
    setSelectedVehicle({ ...vehicle, id: vehicle.id || vehicle._id });
    setActiveTab("overview");
    setShowLabelsDropdown(false); // Close labels dropdown when opening new vehicle
    setActivityData({ activities: [], total: 0, hasMore: false }); // Reset activity when opening new vehicle
  };

  const updateVehicleStatus = async (vehicleId, newStatus) => {
    try {
      await fetch(`/api/vehicles/${vehicleId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus }),
      });
      fetchVehicles();
      toast.success(`Moved to ${newStatus.replace("_", " ")}`);
    } catch (error) {
      toast.error("Failed to update");
    }
  };

  // DVLA lookup for existing vehicle in drawer
  const lookupVehicleDVLA = async () => {
    if (!selectedVehicle?.regCurrent) {
      toast.error("No registration to lookup");
      return;
    }
    setIsLookingUpDrawer(true);
    try {
      const res = await fetch("/api/dvla-lookup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ vehicleReg: selectedVehicle.regCurrent }),
      });
      const data = await res.json();

      if (!res.ok || data.error) {
        toast.error(data.message || data.error || "Vehicle not found");
        return;
      }

      if (data.isDummy) showDummyNotification("DVLA API");

      // Update the vehicle with DVLA data
      const updatePayload = {
        make: data.make || selectedVehicle.make,
        model: data.model || selectedVehicle.model,
        year: data.yearOfManufacture || data.year || selectedVehicle.year,
        colour: data.colour || selectedVehicle.colour,
        fuelType: data.fuelType || selectedVehicle.fuelType,
        transmission: data.transmission || selectedVehicle.transmission,
        motExpiryDate: data.motExpiryDate || selectedVehicle.motExpiryDate,
        dvlaDetails: data.dvlaDetails || null,
        lastDvlaFetchAt: data.lastDvlaFetchAt || new Date().toISOString(),
      };

      await fetch(`/api/vehicles/${selectedVehicle.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updatePayload),
      });

      // Refresh vehicle data
      const updatedRes = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const updatedVehicle = await updatedRes.json();
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();

      toast.success(`Updated: ${data.make} ${data.model || ""} (${data.yearOfManufacture || ""})`);
    } catch (error) {
      toast.error("Lookup failed - please try again");
    } finally {
      setIsLookingUpDrawer(false);
    }
  };

  const updateTaskStatus = async (taskId, newStatus) => {
    try {
      const payload = { status: newStatus };
      if (newStatus === "done") {
        payload.completedAt = new Date().toISOString();
      }
      // Clear progress when changing status (optional: keep if staying in_progress)
      if (newStatus !== "in_progress") {
        payload.progress = "NONE";
        payload.progressNote = "";
      }
      await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
    } catch (error) {
      toast.error("Failed to update task");
    }
  };

  // Update task progress sub-status (for parts ordering, booking, etc.)
  const updateTaskProgress = async (taskId, progress, progressNote = null) => {
    try {
      const payload = { progress };
      if (progressNote !== null) {
        payload.progressNote = progressNote;
      }
      await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
    } catch (error) {
      toast.error("Failed to update task progress");
    }
  };

  // Parts order management functions
  const openPartsOrderModal = (taskId, existingOrder = null) => {
    setPartsOrderTaskId(taskId);
    if (existingOrder) {
      setEditingPartsOrderId(existingOrder._id || existingOrder.id);
      setPartsOrderForm({
        supplierType: existingOrder.supplierType || "EURO_CAR_PARTS",
        supplierName: existingOrder.supplierName || "",
        orderRef: existingOrder.orderRef || "",
        expectedAt: existingOrder.expectedAt ? existingOrder.expectedAt.split("T")[0] : "",
        notes: existingOrder.notes || "",
      });
    } else {
      setEditingPartsOrderId(null);
      setPartsOrderForm({
        supplierType: "EURO_CAR_PARTS",
        supplierName: "",
        orderRef: "",
        expectedAt: "",
        notes: "",
      });
    }
    setShowPartsOrderModal(true);
  };

  const closePartsOrderModal = () => {
    setShowPartsOrderModal(false);
    setPartsOrderTaskId(null);
    setEditingPartsOrderId(null);
    setPartsOrderForm({
      supplierType: "EURO_CAR_PARTS",
      supplierName: "",
      orderRef: "",
      expectedAt: "",
      notes: "",
    });
  };

  const addPartsOrder = async () => {
    if (!partsOrderTaskId) return;
    try {
      const orderData = {
        supplierType: partsOrderForm.supplierType,
        ...(partsOrderForm.supplierType === "OTHER" && partsOrderForm.supplierName && { supplierName: partsOrderForm.supplierName }),
        ...(partsOrderForm.orderRef && { orderRef: partsOrderForm.orderRef }),
        ...(partsOrderForm.expectedAt && { expectedAt: partsOrderForm.expectedAt }),
        ...(partsOrderForm.notes && { notes: partsOrderForm.notes }),
      };

      await fetch(`/api/tasks/${partsOrderTaskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ addPartsOrder: orderData }),
      });

      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
      closePartsOrderModal();
      toast.success("Parts order added");
    } catch (error) {
      toast.error("Failed to add parts order");
    }
  };

  const updatePartsOrder = async () => {
    if (!partsOrderTaskId || !editingPartsOrderId) return;
    try {
      const orderData = {
        orderId: editingPartsOrderId,
        supplierType: partsOrderForm.supplierType,
        supplierName: partsOrderForm.supplierType === "OTHER" ? partsOrderForm.supplierName : null,
        orderRef: partsOrderForm.orderRef || null,
        expectedAt: partsOrderForm.expectedAt || null,
        notes: partsOrderForm.notes || null,
      };

      await fetch(`/api/tasks/${partsOrderTaskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ updatePartsOrder: orderData }),
      });

      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
      closePartsOrderModal();
      toast.success("Parts order updated");
    } catch (error) {
      toast.error("Failed to update parts order");
    }
  };

  const removePartsOrder = async (taskId, orderId) => {
    if (!confirm("Remove this parts order?")) return;
    try {
      await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ removePartsOrderId: orderId }),
      });

      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
      toast.success("Parts order removed");
    } catch (error) {
      toast.error("Failed to remove parts order");
    }
  };

  const markPartsReceived = async (taskId, orderId) => {
    try {
      await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          updatePartsOrder: {
            orderId,
            status: "RECEIVED",
            receivedAt: new Date().toISOString(),
          },
        }),
      });

      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
      toast.success("Parts marked as received");
    } catch (error) {
      toast.error("Failed to update parts order");
    }
  };

  // Helper to get supplier display name
  const getSupplierDisplay = (order) => {
    const labels = {
      EURO_CAR_PARTS: "Euro Car Parts",
      TPS: "TPS",
      MAIN_DEALER: "Main Dealer",
      LOCAL_FACTOR: "Local Factor",
      ONLINE: "Online",
      OTHER: order.supplierName || "Other",
    };
    return labels[order.supplierType] || order.supplierType;
  };

  const updateTaskName = async (taskId, newName) => {
    if (!newName.trim()) {
      toast.error("Task name cannot be empty");
      return;
    }
    try {
      await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newName }),
      });
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
      setEditingTaskId(null);
      setEditingTaskName("");
      toast.success("Task updated");
    } catch (error) {
      toast.error("Failed to update task");
    }
  };

  const addTask = async () => {
    if (!newTaskName.trim()) return toast.error("Task name is required");
    try {
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/tasks`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newTaskName }),
      });
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || "Failed to add task");
      }
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      setNewTaskName("");
      fetchVehicles();
      toast.success("Task added");
    } catch (error) {
      console.error("Add task error:", error);
      toast.error(error.message || "Failed to add task");
    }
  };

  const deleteTask = async (taskId) => {
    try {
      await fetch(`/api/tasks/${taskId}`, { method: "DELETE" });
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Task removed");
    } catch (error) {
      toast.error("Failed to delete task");
    }
  };

  // Issue functions
  const addIssue = async (photoUrls = []) => {
    if (!issueForm.category || !issueForm.subcategory || !issueForm.description) {
      return toast.error("Category, subcategory, and description are required");
    }
    try {
      const issueData = {
        ...issueForm,
        photos: [...(issueForm.photos || []), ...photoUrls],
      };
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/issues`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(issueData),
      });
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || "Failed to add issue");
      }
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      setShowAddIssueModal(false);
      setIssueForm({
        category: "",
        subcategory: "",
        description: "",
        actionNeeded: "",
        status: "outstanding",
        notes: "",
        photos: [],
      });
      toast.success("Issue added");
    } catch (error) {
      console.error("Add issue error:", error);
      toast.error(error.message || "Failed to add issue");
    }
  };

  const updateIssue = async (issueId, updates) => {
    try {
      const res = await fetch(`/api/issues/${issueId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates),
      });
      if (!res.ok) throw new Error("Failed to update issue");
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Issue updated");
    } catch (error) {
      toast.error("Failed to update issue");
    }
  };

  // Open edit issue modal with prefilled data
  const openEditIssue = (issue) => {
    setEditingIssue(issue);
    setIssueForm({
      category: issue.category?.toLowerCase() || "",
      subcategory: issue.subcategory || "",
      description: issue.description || "",
      actionNeeded: issue.actionNeeded || "",
      priority: issue.priority || "medium",
      location: issue.location || "",
      status: issue.status?.toLowerCase().replace(" ", "_") || "outstanding",
      notes: issue.notes || "",
      photos: issue.photos || [],
      partsRequired: issue.partsRequired || false,
      partsDetails: issue.partsDetails || "",
    });
    setShowAddIssueModal(true);
  };

  // Save edited issue
  const saveEditedIssue = async (photoUrls = []) => {
    if (!editingIssue) return;
    try {
      const updates = {
        ...issueForm,
        photos: [...(issueForm.photos || []), ...photoUrls],
      };
      await updateIssue(editingIssue.id, updates);
      setShowAddIssueModal(false);
      setEditingIssue(null);
      setIssueForm({
        category: "",
        subcategory: "",
        description: "",
        actionNeeded: "",
        priority: "medium",
        location: "",
        status: "outstanding",
        notes: "",
        photos: [],
        partsRequired: false,
        partsDetails: "",
      });
    } catch (error) {
      toast.error("Failed to save issue");
    }
  };

  const deleteIssue = async (issueId) => {
    try {
      await fetch(`/api/issues/${issueId}`, { method: "DELETE" });
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Issue removed");
    } catch (error) {
      toast.error("Failed to delete issue");
    }
  };

  const addIssueUpdate = async (issueId, content) => {
    if (!content?.trim()) {
      return toast.error("Update content cannot be empty");
    }

    try {
      await fetch(`/api/issues/${issueId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: content.trim(),
          userName: "Current User" // TODO: Replace with actual user name from auth
        }),
      });

      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      setIssueUpdateContent(prev => ({ ...prev, [issueId]: "" }));
      toast.success("Update added");
    } catch (error) {
      toast.error("Failed to add update");
    }
  };

  // Document functions
  const uploadDocument = async (file, name, type) => {
    if (!file) return;

    try {
      // First upload the file
      const uploadFormData = new FormData();
      uploadFormData.append("file", file);

      const uploadRes = await fetch("/api/vehicles/upload", {
        method: "POST",
        body: uploadFormData,
      });
      if (!uploadRes.ok) throw new Error("File upload failed");
      const uploadData = await uploadRes.json();

      // Then create the document record with the URL
      const docRes = await fetch(`/api/vehicles/${selectedVehicle.id}/documents`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, type, url: uploadData.url }),
      });
      if (!docRes.ok) throw new Error("Document creation failed");

      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      setShowAddDocumentModal(false);
      setDocumentForm({ name: "", type: "other", file: null });
      toast.success("Document uploaded");
    } catch (error) {
      console.error("Upload error:", error);
      toast.error("Failed to upload document");
    }
  };

  const deleteDocument = async (documentId) => {
    try {
      await fetch(`/api/documents/${documentId}`, { method: "DELETE" });
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Document removed");
    } catch (error) {
      toast.error("Failed to delete document");
    }
  };

  const handleDragStart = (e, vehicle) => {
    setDraggedCard(vehicle);
    setDragPosition({ x: e.clientX, y: e.clientY });
    e.dataTransfer.effectAllowed = "move";
    // Create invisible drag image (we'll render our own preview)
    const emptyImg = new Image();
    emptyImg.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
    e.dataTransfer.setDragImage(emptyImg, 0, 0);
  };

  const handleDrag = (e) => {
    if (e.clientX !== 0 && e.clientY !== 0) {
      setDragPosition({ x: e.clientX, y: e.clientY });
    }
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  const handleDragEnd = () => {
    setDraggedCard(null);
  };

  const handleDrop = async (e, newStatus) => {
    e.preventDefault();
    if (!draggedCard || draggedCard.status === newStatus) {
      setDraggedCard(null);
      return;
    }
    const vehicleId = draggedCard.id || draggedCard._id;
    await updateVehicleStatus(vehicleId, newStatus);
    setDraggedCard(null);
  };

  const uploadV5 = async (file) => {
    if (!file) return;

    try {
      // First upload the file
      const formData = new FormData();
      formData.append("file", file);

      const uploadRes = await fetch("/api/vehicles/upload", {
        method: "POST",
        body: formData,
      });
      if (!uploadRes.ok) throw new Error("Upload failed");
      const uploadData = await uploadRes.json();

      // Then update the vehicle with the V5 URL
      await fetch(`/api/vehicles/${selectedVehicle.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ v5Url: uploadData.url }),
      });

      const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updated);
      fetchVehicles();
      toast.success("V5 uploaded");
    } catch (error) {
      console.error("V5 upload error:", error);
      toast.error("Failed to upload V5");
    }
  };

  const formatDate = (date) => {
    if (!date) return "‚Äî";
    return new Date(date).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
  };

  const toggleFilter = (filter) => {
    setActiveFilters(prev =>
      prev.includes(filter)
        ? prev.filter(f => f !== filter)
        : [...prev, filter]
    );
  };

  const getFilteredVehicles = (vehicleList) => {
    if (activeFilters.length === 0) return vehicleList;

    return vehicleList.filter(vehicle => {
      return activeFilters.every(filter => {
        const tasks = vehicle.tasks || [];
        const issues = vehicle.issues || [];
        const activeIssues = issues.filter(i => {
          const status = (i.status || "").toLowerCase();
          return ["outstanding", "ordered", "in progress", "in_progress"].includes(status);
        });

        // Prep task filters
        if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
        if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
        if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
        if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");

        // Issue filters
        if (filter === "needs_paint") return activeIssues.some(i => {
          const cat = (i.category || "").toLowerCase();
          return cat === "bodywork" || cat === "cosmetic";
        });
        if (filter === "needs_mechanical") return activeIssues.some(i => {
          const cat = (i.category || "").toLowerCase();
          return cat === "mechanical";
        });
        if (filter === "needs_electrical") return activeIssues.some(i => {
          const cat = (i.category || "").toLowerCase();
          return cat === "electrical";
        });

        // Location filter
        if (filter === "offsite") return vehicle.locationId != null;

        // MOT filters
        if (filter === "mot_due_soon") {
          if (!vehicle.motExpiryDate) return false;
          const expiry = new Date(vehicle.motExpiryDate);
          const now = new Date();
          const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
          return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
        }
        if (filter === "mot_expired") {
          if (!vehicle.motExpiryDate) return false;
          const expiry = new Date(vehicle.motExpiryDate);
          const now = new Date();
          return expiry < now;
        }

        // Sale type filters
        if (filter === "trade_only") return vehicle.saleType === "TRADE";
        if (filter === "retail_only") return vehicle.saleType === "RETAIL" || !vehicle.saleType;

        // Vehicle type filters
        if (filter === "type_stock") return vehicle.type === "STOCK" || !vehicle.type;
        if (filter === "type_courtesy") return vehicle.type === "COURTESY";
        if (filter === "type_fleet") return vehicle.type === "FLEET_OTHER";

        return true;
      });
    });
  };

  const getVehiclesByStatus = (status) => {
    const statusVehicles = vehicles.filter(v => v.status === status);
    const filtered = getFilteredVehicles(statusVehicles);

    // Apply sorting based on columnSortOptions
    const sortOption = columnSortOptions[status] || "oldest_first";

    return [...filtered].sort((a, b) => {
      const daysA = a.createdAt ? Math.floor((new Date() - new Date(a.createdAt)) / (1000 * 60 * 60 * 24)) : 0;
      const daysB = b.createdAt ? Math.floor((new Date() - new Date(b.createdAt)) / (1000 * 60 * 60 * 24)) : 0;

      switch (sortOption) {
        case "oldest_first":
          return daysB - daysA; // More days = older = first
        case "newest_first":
          return daysA - daysB; // Fewer days = newer = first
        case "alphabetical":
          const nameA = `${a.make || ""} ${a.model || ""}`.toLowerCase();
          const nameB = `${b.make || ""} ${b.model || ""}`.toLowerCase();
          return nameA.localeCompare(nameB);
        default:
          return daysB - daysA;
      }
    });
  };

  const getFilterCount = (filter) => {
    const allFiltered = getFilteredVehicles(vehicles.filter(v => {
      const tasks = v.tasks || [];
      const issues = v.issues || [];
      const activeIssues = issues.filter(i => {
        const status = (i.status || "").toLowerCase();
        return ["outstanding", "ordered", "in progress", "in_progress"].includes(status);
      });

      if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
      if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
      if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
      if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");
      if (filter === "needs_paint") return activeIssues.some(i => {
        const cat = (i.category || "").toLowerCase();
        return cat === "bodywork" || cat === "cosmetic";
      });
      if (filter === "needs_mechanical") return activeIssues.some(i => {
        const cat = (i.category || "").toLowerCase();
        return cat === "mechanical";
      });
      if (filter === "needs_electrical") return activeIssues.some(i => {
        const cat = (i.category || "").toLowerCase();
        return cat === "electrical";
      });
      if (filter === "offsite") return v.locationId != null;
      if (filter === "mot_due_soon") {
        if (!v.motExpiryDate) return false;
        const expiry = new Date(v.motExpiryDate);
        const now = new Date();
        const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
        return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
      }
      if (filter === "mot_expired") {
        if (!v.motExpiryDate) return false;
        const expiry = new Date(v.motExpiryDate);
        return expiry < new Date();
      }
      if (filter === "trade_only") return v.saleType === "TRADE";
      if (filter === "retail_only") return v.saleType === "RETAIL" || !v.saleType;
      if (filter === "type_stock") return v.type === "STOCK" || !v.type;
      if (filter === "type_courtesy") return v.type === "COURTESY";
      if (filter === "type_fleet") return v.type === "FLEET_OTHER";
      return false;
    }));
    return allFiltered.length;
  };

  // VRM Search functions
  const getVrmSearchResults = () => {
    if (vrmSearch.length < 2) return [];
    const searchTerm = vrmSearch.toUpperCase().replace(/\s/g, "");
    return vehicles.filter(v => {
      const reg = (v.regCurrent || "").toUpperCase().replace(/\s/g, "");
      return reg.includes(searchTerm);
    }).slice(0, 8); // Limit to 8 results
  };

  const handleVrmSelect = (vehicle) => {
    // Close dropdown and clear search
    setVrmSearch("");
    setShowVrmDropdown(false);

    // Find which column this vehicle is in and scroll to it
    const columnIndex = COLUMNS.findIndex(col => col.key === vehicle.status);
    if (columnIndex >= 0) {
      // Scroll the column into view
      const columnElements = document.querySelectorAll('[data-column-key]');
      if (columnElements[columnIndex]) {
        columnElements[columnIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    }

    // Open the vehicle drawer with full details
    openVehicleDrawer(vehicle);
  };

  const getStatusLabel = (statusKey) => {
    const col = COLUMNS.find(c => c.key === statusKey);
    return col ? col.label : statusKey;
  };

  const handlePrintVehicle = () => {
    if (!selectedVehicle) return;

    const vehicle = selectedVehicle;
    const tasks = vehicle.tasks || [];
    const issues = vehicle.issues || [];
    const documents = vehicle.documents || [];
    const completedTasks = tasks.filter(t => t.status === "done").length;
    const daysInStock = vehicle.createdAt
      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
      : 0;

    // Get status label from COLUMNS
    const statusColumn = COLUMNS.find(col => col.key === vehicle.status);
    const statusLabel = statusColumn ? statusColumn.label : vehicle.status;

    // Generate HTML for print
    const printContent = `
<!DOCTYPE html>
<html>
<head>
  <title>${vehicle.year || ""} ${vehicle.make} ${vehicle.model} - ${vehicle.regCurrent}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }
    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
    .reg { font-size: 18px; font-family: monospace; color: #64748b; }
    .section { margin-bottom: 30px; }
    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .field { margin-bottom: 12px; }
    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
    .field-value { font-size: 14px; color: #1e293b; }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .badge-status { background: #e0e7ff; color: #4338ca; }
    .badge-days { background: ${daysInStock > 30 ? '#fef2f2' : '#f1f5f9'}; color: ${daysInStock > 30 ? '#dc2626' : '#475569'}; }
    .task-list { list-style: none; }
    .task-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
    .task-status { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .task-done { background: #dcfce7; color: #16a34a; }
    .task-pending { background: #fef3c7; color: #d97706; }
    .task-progress { background: #dbeafe; color: #2563eb; }
    .issue-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; }
    .issue-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .issue-desc { font-size: 14px; color: #1e293b; }
    .doc-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }
    @media print {
      body { padding: 20px; }
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">${vehicle.year || ""} ${vehicle.make} ${vehicle.model}</div>
    <div class="reg">${vehicle.regCurrent}</div>
  </div>

  <div class="section">
    <div class="section-title">Overview</div>
    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
      <span class="badge badge-status">${statusLabel}</span>
      <span class="badge badge-days">Days in Stock: ${daysInStock}</span>
      ${vehicle.locationId ? `<span class="badge" style="background:#eef2ff;color:#4f46e5;">üìç ${vehicle.locationId.name || 'Offsite'}</span>` : '<span class="badge" style="background:#f0fdf4;color:#16a34a;">üìç On Site</span>'}
    </div>
  </div>

  <div class="section">
    <div class="section-title">Vehicle Details</div>
    <div class="grid">
      <div class="field">
        <div class="field-label">Registration</div>
        <div class="field-value">${vehicle.regCurrent || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">VIN</div>
        <div class="field-value">${vehicle.vin || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Make</div>
        <div class="field-value">${vehicle.make || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Model</div>
        <div class="field-value">${vehicle.model || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Year</div>
        <div class="field-value">${vehicle.year || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Mileage</div>
        <div class="field-value">${vehicle.mileageCurrent ? vehicle.mileageCurrent.toLocaleString() + ' miles' : '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Colour</div>
        <div class="field-value">${vehicle.colour || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Fuel Type</div>
        <div class="field-value">${vehicle.fuelType || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">MOT Expiry</div>
        <div class="field-value">${vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : '‚Äî'}</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Prep Checklist (${completedTasks}/${tasks.length} complete)</div>
    ${tasks.length > 0 ? `
    <ul class="task-list">
      ${tasks.map(task => `
        <li class="task-item">
          <span class="task-status ${task.status === 'done' ? 'task-done' : task.status === 'in_progress' ? 'task-progress' : 'task-pending'}">
            ${task.status === 'done' ? '‚úì' : task.status === 'in_progress' ? '‚Üí' : '‚óã'}
          </span>
          <span style="${task.status === 'done' ? 'text-decoration: line-through; color: #94a3b8;' : ''}">${task.name}</span>
          ${task.completedAt ? `<span style="font-size: 11px; color: #94a3b8; margin-left: auto;">${new Date(task.completedAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</span>` : ''}
        </li>
      `).join('')}
    </ul>
    ` : '<p style="color: #94a3b8; font-size: 14px;">No tasks</p>'}
  </div>

  <div class="section">
    <div class="section-title">Issues (${issues.length})</div>
    ${issues.length > 0 ? issues.map(issue => `
      <div class="issue-card">
        <div class="issue-header">
          <span class="issue-badge">${issue.category}</span>
          ${issue.subcategory ? `<span class="issue-badge">${issue.subcategory}</span>` : ''}
          <span class="issue-badge" style="margin-left: auto;">${issue.status || 'Outstanding'}</span>
        </div>
        <div class="issue-desc">${issue.description}</div>
        ${issue.actionNeeded ? `<div style="font-size: 12px; color: #64748b; margin-top: 6px;">Action: ${issue.actionNeeded}</div>` : ''}
      </div>
    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No issues recorded</p>'}
  </div>

  <div class="section">
    <div class="section-title">Documents (${documents.length})</div>
    ${documents.length > 0 ? documents.map(doc => `
      <div class="doc-item">
        <span style="font-weight: 500;">${doc.name}</span>
        <span style="font-size: 12px; color: #94a3b8; margin-left: 8px;">(${doc.type.replace(/_/g, ' ')})</span>
      </div>
    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No documents uploaded</p>'}
    ${vehicle.v5Url ? '<div class="doc-item"><span style="font-weight: 500;">V5 Document</span> <span style="font-size: 12px; color: #16a34a;">‚úì Uploaded</span></div>' : ''}
  </div>

  ${vehicle.notes ? `
  <div class="section">
    <div class="section-title">Notes</div>
    <p style="font-size: 14px; white-space: pre-wrap;">${vehicle.notes}</p>
  </div>
  ` : ''}

  <div class="footer">
    Printed from DealerFlow on ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
  </div>
</body>
</html>
    `;

    // Open in new tab
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
  };

  // Share utility with fallback chain: Web Share API ‚Üí Clipboard ‚Üí Manual modal
  // SSR-safe: only runs client-side, with guards for browser API availability
  const shareWithFallback = async (url, title, text) => {
    // Guard against SSR - this should only run client-side
    if (typeof window === "undefined" || typeof navigator === "undefined") {
      return false;
    }

    // 1. Try Web Share API (native sharing on mobile/supported browsers)
    if (typeof navigator.share === "function") {
      try {
        await navigator.share({ title, text, url });
        return true;
      } catch (error) {
        // User cancelled or share failed - continue to fallback
        if (error.name !== "AbortError") {
          console.log("Web Share API failed, trying clipboard fallback");
        }
      }
    }

    // 2. Try Clipboard API
    if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
      try {
        await navigator.clipboard.writeText(url);
        toast.success("Link copied to clipboard!");
        return true;
      } catch (error) {
        console.log("Clipboard API failed, showing manual modal");
      }
    }

    // 3. Fallback to manual modal
    setManualShareUrl(url);
    setShowManualShareModal(true);
    return false;
  };

  // Job sheet share handlers
  const handleGenerateJobSheet = async () => {
    if (!selectedVehicle) return;
    setIsGeneratingJobSheet(true);
    try {
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/job-sheet`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ expiresInDays: 60 }),
      });
      if (!res.ok) throw new Error("Failed to generate share link");
      const data = await res.json();
      const fullUrl = `${window.location.origin}${data.shareUrl}`;
      setJobSheetLink({
        url: fullUrl,
        expiresAt: data.expiresAt,
      });
      setShowJobSheetModal(true);
    } catch (error) {
      toast.error(error.message);
    } finally {
      setIsGeneratingJobSheet(false);
    }
  };

  const copyJobSheetLink = async () => {
    if (jobSheetLink?.url) {
      await shareWithFallback(
        jobSheetLink.url,
        `Job Sheet - ${selectedVehicle?.regCurrent || "Vehicle"}`,
        `Job sheet for ${selectedVehicle?.regCurrent}: ${jobSheetLink.url}`
      );
    }
  };

  const shareViaWhatsApp = () => {
    if (typeof window === "undefined") return;
    if (jobSheetLink?.url) {
      const text = `Job sheet for ${selectedVehicle?.regCurrent || "Vehicle"}: ${jobSheetLink.url}`;
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
    }
  };

  // Prep summary share handlers
  const handleGeneratePrepSummary = async () => {
    if (!selectedVehicle) return;
    setIsGeneratingPrepSummary(true);
    try {
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/prep-summary`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ expiresInDays: 60 }),
      });
      if (!res.ok) throw new Error("Failed to generate share link");
      const data = await res.json();
      const fullUrl = `${window.location.origin}${data.shareUrl}`;
      setPrepSummaryLink({
        url: fullUrl,
        expiresAt: data.expiresAt,
      });
      setShowPrepSummaryModal(true);
    } catch (error) {
      toast.error(error.message);
    } finally {
      setIsGeneratingPrepSummary(false);
    }
  };

  const copyPrepSummaryLink = async () => {
    if (prepSummaryLink?.url) {
      await shareWithFallback(
        prepSummaryLink.url,
        `Prep Summary - ${selectedVehicle?.regCurrent || "Vehicle"}`,
        `Prep summary for ${selectedVehicle?.regCurrent}: ${prepSummaryLink.url}`
      );
    }
  };

  const sharePrepSummaryViaWhatsApp = () => {
    if (typeof window === "undefined") return;
    if (prepSummaryLink?.url) {
      const text = `Prep summary for ${selectedVehicle?.regCurrent || "Vehicle"}: ${prepSummaryLink.url}`;
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
    }
  };

  const getMOTStatus = (motExpiryDate) => {
    if (!motExpiryDate) {
      return { type: "unknown", label: "Unknown", days: null, class: "bg-slate-100 text-slate-500 border border-slate-200" };
    }
    const expiry = new Date(motExpiryDate);
    const now = new Date();
    const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));

    if (daysUntilExpiry < 0) {
      const daysOverdue = Math.abs(daysUntilExpiry);
      return { type: "expired", label: `Expired ${daysOverdue}d`, days: daysOverdue, class: "bg-red-50 text-red-700 border border-red-200" };
    }
    if (daysUntilExpiry <= 30) {
      return { type: "due_soon", label: `${daysUntilExpiry}d`, days: daysUntilExpiry, class: "bg-amber-50 text-amber-700 border border-amber-200" };
    }
    return { type: "valid", label: `${daysUntilExpiry}d`, days: daysUntilExpiry, class: null };
  };

  const getActiveIssuesByCategory = (issues = []) => {
    const activeIssues = issues.filter(i => {
      const status = (i.status || "").toLowerCase();
      return ["outstanding", "ordered", "in_progress", "in progress"].includes(status);
    });
    const categoryCounts = {};
    activeIssues.forEach(issue => {
      categoryCounts[issue.category] = (categoryCounts[issue.category] || 0) + 1;
    });
    return categoryCounts;
  };

  return (
    <DashboardLayout>
      <Head><title>Stock & Prep | DealerFlow</title></Head>

      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-3xl font-bold">Stock & Prep Board</h1>
          <p className="text-base-content/60 mt-1">Manage vehicle prep and sales pipeline &bull; Drag cards to move between stages</p>
        </div>
        <button className="btn btn-primary" onClick={() => setShowAddModal(true)}>
          + Add Vehicle
        </button>
      </div>

      {/* Consolidated Filters */}
      <div className="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-slate-200 mb-4 -mx-6 px-6 py-4">
        <div className="flex gap-2 items-center">
            {/* VRM Search */}
            <div className="relative">
              <div className="relative">
                <svg className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  placeholder="Search VRM..."
                  className="input input-sm input-bordered pl-9 pr-8 w-44 font-mono uppercase"
                  value={vrmSearch}
                  onChange={(e) => {
                    setVrmSearch(e.target.value.toUpperCase());
                    setShowVrmDropdown(e.target.value.length >= 2);
                  }}
                  onFocus={() => vrmSearch.length >= 2 && setShowVrmDropdown(true)}
                  onKeyDown={(e) => {
                    if (e.key === "Escape") {
                      setShowVrmDropdown(false);
                      e.target.blur();
                    }
                  }}
                />
                {vrmSearch && (
                  <button
                    className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                    onClick={() => {
                      setVrmSearch("");
                      setShowVrmDropdown(false);
                    }}
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                )}
              </div>

              {/* VRM Search Dropdown */}
              {showVrmDropdown && (
                <>
                  <div className="fixed inset-0 z-10" onClick={() => setShowVrmDropdown(false)}></div>
                  <div className="absolute top-full left-0 mt-1 w-72 bg-white rounded-xl shadow-xl border border-slate-200 z-20 overflow-hidden">
                    {getVrmSearchResults().length > 0 ? (
                      <ul className="py-1 max-h-64 overflow-y-auto">
                        {getVrmSearchResults().map((vehicle) => (
                          <li key={vehicle.id || vehicle._id}>
                            <button
                              className="w-full px-4 py-2.5 text-left hover:bg-slate-50 flex items-center justify-between gap-2 transition-colors"
                              onClick={() => handleVrmSelect(vehicle)}
                            >
                              <div className="flex items-center gap-3">
                                <span className="font-mono font-bold text-slate-900">{vehicle.regCurrent}</span>
                                <span className="text-sm text-slate-500">{vehicle.make} {vehicle.model}</span>
                              </div>
                              <span className="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">
                                {getStatusLabel(vehicle.status)}
                              </span>
                            </button>
                          </li>
                        ))}
                      </ul>
                    ) : (
                      <div className="px-4 py-6 text-center">
                        <svg className="w-8 h-8 mx-auto text-slate-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm text-slate-500">No vehicles found</p>
                        <p className="text-xs text-slate-400 mt-1">Try a different registration</p>
                      </div>
                    )}
                  </div>
                </>
              )}
            </div>

            <div className="divider divider-horizontal mx-1"></div>

            {/* All Vehicles Button */}
            <button
              className={`btn btn-sm ${activeFilters.length === 0 ? "btn-primary" : "btn-outline"}`}
              onClick={() => setActiveFilters([])}
            >
              All Vehicles ({vehicles.length})
            </button>

            <div className="divider divider-horizontal mx-1"></div>

            {/* Consolidated Filters - Strictly Separated Desktop/Mobile */}
            <div className="shrink-0">
              {/* Trigger Button */}
              <button
                ref={filterButtonRef}
                className={`flex items-center gap-2 px-3 py-2 rounded-lg shrink-0 whitespace-nowrap text-sm font-medium transition-all ${
                  activeFilters.length > 0
                    ? "bg-blue-600 text-white"
                    : "bg-white border border-slate-200 text-slate-700 hover:border-slate-300"
                }`}
                onClick={() => showFiltersDropdown ? setShowFiltersDropdown(false) : openFiltersDropdown()}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                <span className="hidden sm:inline">Filters</span>
                {activeFilters.length > 0 && (
                  <span className={`text-xs px-1.5 py-0.5 rounded-full ${
                    activeFilters.length > 0 ? "bg-white/20 text-white" : "bg-slate-100 text-slate-600"
                  }`}>{activeFilters.length}</span>
                )}
              </button>

              {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
              {/* DESKTOP: Fixed Popover via Portal (lg: and up) */}
              {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
              {showFiltersDropdown && (
                <Portal>
                  <div className="hidden lg:block fixed inset-0 z-[9998]">
                    {/* Backdrop */}
                    <div
                      className="fixed inset-0"
                      onClick={() => setShowFiltersDropdown(false)}
                    />

                    {/* Desktop Filter Panel - Fixed position, viewport-clamped */}
                    <div
                      className="fixed w-[360px] max-h-[70vh] bg-white rounded-xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden"
                      style={{ top: filterPopoverPos.top, right: filterPopoverPos.right }}
                    >
                      {/* Sticky Header */}
                      <div className="flex items-center justify-between px-4 py-3 border-b border-slate-200 bg-white shrink-0">
                        <h3 className="font-semibold text-slate-900">Filters</h3>
                        <button
                          onClick={() => setShowFiltersDropdown(false)}
                          className="p-1 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-colors"
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>

                      {/* Scrollable Content */}
                      <div className="flex-1 overflow-y-auto p-4 space-y-5">
                        {/* Prep Tasks Section */}
                        <div>
                          <h5 className="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2">Prep Tasks</h5>
                          <div className="space-y-1.5">
                            {[
                              { key: "awaiting_pdi", label: "Awaiting PDI" },
                              { key: "awaiting_valet", label: "Awaiting Valet" },
                              { key: "awaiting_photos", label: "Awaiting Photos" },
                              { key: "awaiting_mot", label: "Awaiting MOT" },
                            ].map(filter => {
                              const isActive = activeFilters.includes(filter.key);
                              const count = getFilterCount(filter.key);
                              return (
                                <button
                                  key={filter.key}
                                  onClick={() => toggleFilter(filter.key)}
                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                    isActive
                                      ? "bg-blue-50 text-blue-700 ring-1 ring-blue-200"
                                      : "text-slate-600 hover:bg-slate-50"
                                  }`}
                                >
                                  <span>{filter.label}</span>
                                  <span className={`text-xs px-1.5 py-0.5 rounded ${
                                    isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                  }`}>{count}</span>
                                </button>
                              );
                            })}
                          </div>
                        </div>

                        {/* Issues Section */}
                        <div>
                          <h5 className="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2">Issues</h5>
                          <div className="space-y-1.5">
                            {[
                              { key: "needs_paint", label: "Needs Paint" },
                              { key: "needs_mechanical", label: "Needs Mechanical" },
                              { key: "needs_electrical", label: "Needs Electrical" },
                            ].map(filter => {
                              const isActive = activeFilters.includes(filter.key);
                              const count = getFilterCount(filter.key);
                              return (
                                <button
                                  key={filter.key}
                                  onClick={() => toggleFilter(filter.key)}
                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                    isActive
                                      ? "bg-blue-50 text-blue-700 ring-1 ring-blue-200"
                                      : "text-slate-600 hover:bg-slate-50"
                                  }`}
                                >
                                  <span>{filter.label}</span>
                                  <span className={`text-xs px-1.5 py-0.5 rounded ${
                                    isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                  }`}>{count}</span>
                                </button>
                              );
                            })}
                          </div>
                        </div>

                        {/* Location Section */}
                        <div>
                          <h5 className="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2">Location</h5>
                          <div className="space-y-1.5">
                            {(() => {
                              const isActive = activeFilters.includes("offsite");
                              const count = getFilterCount("offsite");
                              return (
                                <button
                                  onClick={() => toggleFilter("offsite")}
                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                    isActive
                                      ? "bg-blue-50 text-blue-700 ring-1 ring-blue-200"
                                      : "text-slate-600 hover:bg-slate-50"
                                  }`}
                                >
                                  <span>Offsite Only</span>
                                  <span className={`text-xs px-1.5 py-0.5 rounded ${
                                    isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                  }`}>{count}</span>
                                </button>
                              );
                            })()}
                          </div>
                        </div>

                        {/* Vehicle Type Section */}
                        <div>
                          <h5 className="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2">Vehicle Type</h5>
                          <div className="space-y-1.5">
                            {[
                              { key: "type_stock", label: "Stock Vehicles" },
                              { key: "type_courtesy", label: "Courtesy Vehicles" },
                              { key: "type_fleet", label: "Fleet Vehicles" },
                            ].map(filter => {
                              const isActive = activeFilters.includes(filter.key);
                              const count = getFilterCount(filter.key);
                              return (
                                <button
                                  key={filter.key}
                                  onClick={() => toggleFilter(filter.key)}
                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                    isActive
                                      ? "bg-blue-50 text-blue-700 ring-1 ring-blue-200"
                                      : "text-slate-600 hover:bg-slate-50"
                                  }`}
                                >
                                  <span>{filter.label}</span>
                                  <span className={`text-xs px-1.5 py-0.5 rounded ${
                                    isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                  }`}>{count}</span>
                                </button>
                              );
                            })}
                          </div>
                        </div>

                        {/* Sale Type Section */}
                        <div>
                          <h5 className="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2">Sale Type</h5>
                          <div className="space-y-1.5">
                            {[
                              { key: "trade_only", label: "Trade Only" },
                              { key: "retail_only", label: "Retail Only" },
                            ].map(filter => {
                              const isActive = activeFilters.includes(filter.key);
                              const count = getFilterCount(filter.key);
                              return (
                                <button
                                  key={filter.key}
                                  onClick={() => toggleFilter(filter.key)}
                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                    isActive
                                      ? "bg-blue-50 text-blue-700 ring-1 ring-blue-200"
                                      : "text-slate-600 hover:bg-slate-50"
                                  }`}
                                >
                                  <span>{filter.label}</span>
                                  <span className={`text-xs px-1.5 py-0.5 rounded ${
                                    isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                  }`}>{count}</span>
                                </button>
                              );
                            })}
                          </div>
                        </div>

                        {/* MOT Status Section */}
                        <div>
                          <h5 className="text-[11px] font-bold text-slate-500 uppercase tracking-wide mb-2">MOT Status</h5>
                          <div className="space-y-1.5">
                            {[
                              { key: "mot_expired", label: "MOT Expired" },
                              { key: "mot_due_soon", label: "MOT Due Soon" },
                            ].map(filter => {
                              const isActive = activeFilters.includes(filter.key);
                              const count = getFilterCount(filter.key);
                              return (
                                <button
                                  key={filter.key}
                                  onClick={() => toggleFilter(filter.key)}
                                  className={`w-full flex justify-between items-center px-3 py-2 rounded-lg text-sm font-medium transition-all ${
                                    isActive
                                      ? "bg-blue-50 text-blue-700 ring-1 ring-blue-200"
                                      : "text-slate-600 hover:bg-slate-50"
                                  }`}
                                >
                                  <span>{filter.label}</span>
                                  <span className={`text-xs px-1.5 py-0.5 rounded ${
                                    isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                  }`}>{count}</span>
                                </button>
                              );
                            })}
                          </div>
                        </div>
                      </div>

                      {/* Sticky Footer */}
                      <div className="border-t border-slate-200 p-3 bg-white flex gap-2 shrink-0">
                        <button
                          onClick={() => setActiveFilters([])}
                          className="flex-1 px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-100 rounded-lg transition-colors"
                        >
                          Clear
                        </button>
                        <button
                          onClick={() => setShowFiltersDropdown(false)}
                          className="flex-1 bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-800 transition-colors"
                        >
                          Apply
                        </button>
                      </div>
                    </div>
                  </div>
                </Portal>
              )}

              {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
              {/* MOBILE/TABLET: Bottom Sheet (< lg screens) */}
              {/* Uses its own internal Portal for correct positioning */}
              {/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */}
              <BottomSheet
                    isOpen={showFiltersDropdown}
                    onClose={() => setShowFiltersDropdown(false)}
                    hideAbove="lg"
                    title="Filters"
                    footer={
                      <div className="flex gap-3">
                        <button
                          onClick={() => setActiveFilters([])}
                          className="flex-1 px-4 py-3 text-base font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-xl transition-colors"
                        >
                          Clear
                        </button>
                        <button
                          onClick={() => setShowFiltersDropdown(false)}
                          className="flex-1 bg-slate-900 text-white py-3 rounded-xl text-base font-bold hover:bg-slate-800 transition-colors"
                        >
                          Apply {activeFilters.length > 0 && `(${activeFilters.length})`}
                        </button>
                      </div>
                    }
                  >
                    {/* Prep Tasks */}
                    <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Prep Tasks</h5>
                    {[
                      { key: "awaiting_pdi", label: "Awaiting PDI" },
                      { key: "awaiting_valet", label: "Awaiting Valet" },
                      { key: "awaiting_photos", label: "Awaiting Photos" },
                      { key: "awaiting_mot", label: "Awaiting MOT" },
                    ].map(filter => {
                      const isActive = activeFilters.includes(filter.key);
                      const count = getFilterCount(filter.key);
                      return (
                        <button
                          key={filter.key}
                          onClick={() => toggleFilter(filter.key)}
                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                            isActive
                              ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                              : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                          }`}
                        >
                          <span>{filter.label}</span>
                          <span className={`text-sm px-2.5 py-1 rounded-lg ${
                            isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                          }`}>{count}</span>
                        </button>
                      );
                    })}

                    {/* Issues */}
                    <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6">Issues</h5>
                    {[
                      { key: "needs_paint", label: "Needs Paint" },
                      { key: "needs_mechanical", label: "Needs Mechanical" },
                      { key: "needs_electrical", label: "Needs Electrical" },
                    ].map(filter => {
                      const isActive = activeFilters.includes(filter.key);
                      const count = getFilterCount(filter.key);
                      return (
                        <button
                          key={filter.key}
                          onClick={() => toggleFilter(filter.key)}
                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                            isActive
                              ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                              : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                          }`}
                        >
                          <span>{filter.label}</span>
                          <span className={`text-sm px-2.5 py-1 rounded-lg ${
                            isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                          }`}>{count}</span>
                        </button>
                      );
                    })}

                    {/* Location */}
                    <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6">Location</h5>
                    {(() => {
                      const isActive = activeFilters.includes("offsite");
                      const count = getFilterCount("offsite");
                      return (
                        <button
                          onClick={() => toggleFilter("offsite")}
                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                            isActive
                              ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                              : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                          }`}
                        >
                          <span>Offsite Only</span>
                          <span className={`text-sm px-2.5 py-1 rounded-lg ${
                            isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                          }`}>{count}</span>
                        </button>
                      );
                    })()}

                    {/* Vehicle Type */}
                    <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6">Vehicle Type</h5>
                    {[
                      { key: "type_stock", label: "Stock Vehicles" },
                      { key: "type_courtesy", label: "Courtesy Vehicles" },
                      { key: "type_fleet", label: "Fleet Vehicles" },
                    ].map(filter => {
                      const isActive = activeFilters.includes(filter.key);
                      const count = getFilterCount(filter.key);
                      return (
                        <button
                          key={filter.key}
                          onClick={() => toggleFilter(filter.key)}
                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                            isActive
                              ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                              : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                          }`}
                        >
                          <span>{filter.label}</span>
                          <span className={`text-sm px-2.5 py-1 rounded-lg ${
                            isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                          }`}>{count}</span>
                        </button>
                      );
                    })}

                    {/* Sale Type */}
                    <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6">Sale Type</h5>
                    {[
                      { key: "trade_only", label: "Trade Only" },
                      { key: "retail_only", label: "Retail Only" },
                    ].map(filter => {
                      const isActive = activeFilters.includes(filter.key);
                      const count = getFilterCount(filter.key);
                      return (
                        <button
                          key={filter.key}
                          onClick={() => toggleFilter(filter.key)}
                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                            isActive
                              ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                              : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                          }`}
                        >
                          <span>{filter.label}</span>
                          <span className={`text-sm px-2.5 py-1 rounded-lg ${
                            isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                          }`}>{count}</span>
                        </button>
                      );
                    })}

                    {/* MOT Status */}
                    <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6">MOT Status</h5>
                    {[
                      { key: "mot_expired", label: "MOT Expired" },
                      { key: "mot_due_soon", label: "MOT Due Soon" },
                    ].map(filter => {
                      const isActive = activeFilters.includes(filter.key);
                      const count = getFilterCount(filter.key);
                      return (
                        <button
                          key={filter.key}
                          onClick={() => toggleFilter(filter.key)}
                          className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                            isActive
                              ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                              : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                          }`}
                        >
                          <span>{filter.label}</span>
                          <span className={`text-sm px-2.5 py-1 rounded-lg ${
                            isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                          }`}>{count}</span>
                        </button>
                      );
                    })}
                  </BottomSheet>
            </div>
          </div>
      </div>

      {isLoading ? (
        <div className="flex justify-center py-20">
          <span className="loading loading-spinner loading-lg"></span>
        </div>
      ) : (
        <>
          {/* Mobile Column Tabs - Dropdown for clearer UX */}
          <div className="md:hidden mb-4">
            <MobileStageSelector
              stages={COLUMNS.map((col) => ({
                value: col.key,
                label: col.label,
                count: getVehiclesByStatus(col.key).length,
              }))}
              activeStage={mobileActiveColumn}
              onStageChange={setMobileActiveColumn}
            />
          </div>

          {/* Mobile Single Column View */}
          <div className="md:hidden">
            {COLUMNS.filter(col => col.key === mobileActiveColumn).map((col) => {
              const columnVehicles = getVehiclesByStatus(col.key);

              // Issue category styling with icons (mobile)
              const issueCategoryStyles = {
                Mechanical: { bg: "bg-red-50", text: "text-red-700", border: "border-red-100", icon: (
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                )},
                Cosmetic: { bg: "bg-teal-50", text: "text-teal-700", border: "border-teal-100", icon: (
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                  </svg>
                )},
                Electrical: { bg: "bg-yellow-50", text: "text-yellow-800", border: "border-yellow-100", icon: (
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                )},
                Other: { bg: "bg-blue-50", text: "text-blue-700", border: "border-blue-100", icon: (
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                )},
              };

              return (
                <div key={col.key} className="space-y-3">
                  {columnVehicles.map((vehicle) => {
                    const tasks = vehicle.tasks || [];
                    const completedTasks = tasks.filter(t => t.status === "done").length;
                    const motStatus = getMOTStatus(vehicle.motExpiryDate);
                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);
                    const duration = getVehicleDuration(vehicle);

                    return (
                      <div
                        key={vehicle.id}
                        className="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100/50 overflow-hidden active:scale-[0.98]"
                        onClick={() => openVehicleDrawer(vehicle)}
                      >
                        <div className="p-4">
                          {/* Title with Registration Badge */}
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 flex-wrap mb-1">
                                <p className="font-bold text-slate-900 text-base">
                                  {vehicle.year || ""} {vehicle.make} {vehicle.model}
                                </p>
                                <span className="font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md">
                                  {vehicle.regCurrent}
                                </span>
                              </div>
                            </div>
                            {/* Duration badge - Sold or In Stock */}
                            <span className={`inline-flex items-center gap-1 text-xs ${
                              duration.isSold ? "text-emerald-600" : duration.days > 30 ? "text-red-500" : "text-slate-400"
                            }`}>
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              {duration.label}
                            </span>
                          </div>

                          {/* Tags - Modern Pill Style */}
                          <div className="flex gap-1.5 flex-wrap mb-3">
                            {vehicle.locationId && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-[#0066CC]/10 text-[#0066CC] border border-[#0066CC]/20">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                {vehicle.locationId.name || "Offsite"}
                              </span>
                            )}
                            {vehicle.saleType === "TRADE" && (
                              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase">
                                Trade
                              </span>
                            )}
                            {vehicle.type === "COURTESY" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-cyan-600 text-white uppercase">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                </svg>
                                Courtesy
                              </span>
                            )}
                            {vehicle.type === "FLEET_OTHER" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-[#0066CC] text-white uppercase">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Fleet
                              </span>
                            )}
                            {motStatus?.type === "expired" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                MOT {motStatus.label}
                              </span>
                            )}
                            {motStatus?.type === "due_soon" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                MOT {motStatus.label}
                              </span>
                            )}
                            {motStatus?.type === "valid" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                MOT {vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : motStatus.label}
                              </span>
                            )}
                            {motStatus?.type === "unknown" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-slate-100 text-slate-500 border border-slate-200">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                MOT ?
                              </span>
                            )}
                            {/* Issue Pills with Icons */}
                            {Object.entries(issueCounts).map(([category, count]) => {
                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;
                              return (
                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>
                                  {style.icon}
                                  {count} {category}
                                </span>
                              );
                            })}
                            {/* Custom Labels */}
                            {vehicle.labels?.map((label) => (
                              <span
                                key={label.id}
                                className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border"
                                style={{
                                  backgroundColor: `${label.colour}10`,
                                  color: label.colour,
                                  borderColor: `${label.colour}30`,
                                }}
                              >
                                <span className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: label.colour }}></span>
                                {label.name}
                              </span>
                            ))}
                          </div>

                          {/* Slick Progress Bar */}
                          {tasks.length > 0 && (
                            <div>
                              <span className="text-xs text-slate-400 mb-1 block">
                                {completedTasks}/{tasks.length} tasks
                              </span>
                              <div className="w-full bg-slate-100 rounded-full h-2">
                                <div
                                  className="h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400"
                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}
                                ></div>
                              </div>
                            </div>
                          )}

                          {/* Mobile Move Button */}
                          <div className="mt-3 pt-3 border-t border-slate-100 flex justify-end">
                            <div className="dropdown dropdown-end">
                              <label
                                tabIndex={0}
                                className="btn btn-sm btn-ghost gap-1 text-slate-500 hover:text-[#0066CC] hover:bg-[#0066CC]/5"
                                onClick={(e) => e.stopPropagation()}
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                </svg>
                                Move
                              </label>
                              <ul
                                tabIndex={0}
                                className="dropdown-content z-[100] menu p-2 shadow-xl bg-white rounded-xl w-48 border border-slate-100"
                                onClick={(e) => e.stopPropagation()}
                              >
                                {COLUMNS.filter(c => c.key !== col.key).map((targetCol) => (
                                  <li key={targetCol.key}>
                                    <button
                                      className="flex items-center gap-2 text-sm py-2.5"
                                      onClick={async (e) => {
                                        e.stopPropagation();
                                        await updateVehicleStatus(vehicle.id, targetCol.key);
                                        toast.success(`Moved to ${targetCol.label}`);
                                        // Close dropdown by blurring
                                        document.activeElement?.blur();
                                      }}
                                    >
                                      <span className={`w-2 h-2 rounded-full ${targetCol.accentBg}`}></span>
                                      {targetCol.label}
                                    </button>
                                  </li>
                                ))}
                              </ul>
                            </div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                  {columnVehicles.length === 0 && (
                    <div className="text-center py-12 text-slate-400">
                      <p className="text-sm">No vehicles in {col.label}</p>
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* Mobile Floating Action Button */}
          <button
            onClick={() => setShowAddModal(true)}
            className="md:hidden fixed fab-safe right-4 z-40 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all active:scale-95"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </button>

          {/* Desktop Multi-Column View */}
          <div className="hidden md:flex gap-4 overflow-x-auto pb-6">
            {COLUMNS.map((col) => {
              const columnVehicles = getVehiclesByStatus(col.key);
              return (
                <div
                  key={col.key}
                  data-column-key={col.key}
                  className={`flex-shrink-0 w-64 bg-gradient-to-b ${col.gradient} to-transparent rounded-2xl p-3 min-h-[400px]`}
                  onDragOver={handleDragOver}
                onDrop={(e) => handleDrop(e, col.key)}
              >
                {/* Integrated Header */}
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <h3 className="font-semibold text-slate-700 text-sm">
                      {col.label}
                    </h3>
                    <span className="bg-slate-900/10 text-slate-700 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center">
                      {columnVehicles.length}
                    </span>
                  </div>
                  <div className="dropdown dropdown-end">
                    <label tabIndex={0} className="btn btn-ghost btn-xs gap-1 bg-white/30 backdrop-blur-sm hover:bg-white/50 rounded-full">
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                      </svg>
                      <span className="text-xs">
                        {columnSortOptions[col.key] === "newest_first" ? "Newest" :
                         columnSortOptions[col.key] === "alphabetical" ? "A-Z" : "Oldest"}
                      </span>
                    </label>
                    <ul tabIndex={0} className="dropdown-content z-30 menu p-2 shadow-lg bg-white rounded-xl w-44 mt-2">
                      <li>
                        <button
                          className={`rounded-lg ${columnSortOptions[col.key] === "oldest_first" || !columnSortOptions[col.key] ? "active bg-slate-100" : ""}`}
                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "oldest_first" }))}
                        >
                          Oldest First
                        </button>
                      </li>
                      <li>
                        <button
                          className={`rounded-lg ${columnSortOptions[col.key] === "newest_first" ? "active bg-slate-100" : ""}`}
                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "newest_first" }))}
                        >
                          Newest First
                        </button>
                      </li>
                      <li>
                        <button
                          className={`rounded-lg ${columnSortOptions[col.key] === "alphabetical" ? "active bg-slate-100" : ""}`}
                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "alphabetical" }))}
                        >
                          Alphabetical (Make/Model)
                        </button>
                      </li>
                    </ul>
                  </div>
                </div>

                {/* Cards Container */}
                <div className="space-y-3">
                  {columnVehicles.map((vehicle) => {
                    const tasks = vehicle.tasks || [];
                    const completedTasks = tasks.filter(t => t.status === "done").length;
                    const motStatus = getMOTStatus(vehicle.motExpiryDate);
                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);
                    const duration = getVehicleDuration(vehicle);

                    // Issue category styling with icons
                    const issueCategoryStyles = {
                      Mechanical: { bg: "bg-red-50", text: "text-red-700", border: "border-red-100", icon: (
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      )},
                      Cosmetic: { bg: "bg-teal-50", text: "text-teal-700", border: "border-teal-100", icon: (
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                        </svg>
                      )},
                      Electrical: { bg: "bg-yellow-50", text: "text-yellow-800", border: "border-yellow-100", icon: (
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                      )},
                      Other: { bg: "bg-blue-50", text: "text-blue-700", border: "border-blue-100", icon: (
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      )},
                    };

                    return (
                      <div
                        key={vehicle.id}
                        draggable
                        onDragStart={(e) => handleDragStart(e, vehicle)}
                        onDrag={handleDrag}
                        onDragEnd={handleDragEnd}
                        className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all cursor-grab active:cursor-grabbing border border-slate-100/50 overflow-hidden ${draggedCard?.id === vehicle.id ? "opacity-40 scale-95" : ""}`}
                        onClick={() => openVehicleDrawer(vehicle)}
                      >
                        <div className="p-3">
                          {/* Title with Registration Badge */}
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 flex-wrap">
                                <p className="font-bold text-slate-900 text-sm leading-tight">
                                  {vehicle.year || ""} {vehicle.make} {vehicle.model}
                                </p>
                                <span className="font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md">
                                  {vehicle.regCurrent}
                                </span>
                              </div>
                            </div>
                          </div>

                          {/* Tags - Modern Pill Style */}
                          <div className="flex gap-1.5 flex-wrap mb-2">
                            {/* Trade badge */}
                            {vehicle.saleType === "TRADE" && (
                              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase">
                                Trade
                              </span>
                            )}
                            {/* Courtesy/Fleet badges */}
                            {vehicle.type === "COURTESY" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-cyan-600 text-white uppercase">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                                </svg>
                                Courtesy
                              </span>
                            )}
                            {vehicle.type === "FLEET_OTHER" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-[#0066CC] text-white uppercase">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                </svg>
                                Fleet
                              </span>
                            )}
                            {motStatus?.type === "expired" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                MOT {motStatus.label}
                              </span>
                            )}
                            {motStatus?.type === "due_soon" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                MOT {motStatus.label}
                              </span>
                            )}
                            {motStatus?.type === "valid" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                MOT {vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : motStatus.label}
                              </span>
                            )}
                            {motStatus?.type === "unknown" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-slate-100 text-slate-500 border border-slate-200">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                MOT ?
                              </span>
                            )}
                            {/* Issue Pills with Icons */}
                            {Object.entries(issueCounts).map(([category, count]) => {
                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;
                              return (
                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>
                                  {style.icon}
                                  {count} {category}
                                </span>
                              );
                            })}
                            {vehicle.locationId && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-[#0066CC]/10 text-[#0066CC] border border-[#0066CC]/20">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                {vehicle.locationId.name}
                              </span>
                            )}
                            {/* Custom Labels */}
                            {vehicle.labels?.map((label) => (
                              <span
                                key={label.id}
                                className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border"
                                style={{
                                  backgroundColor: `${label.colour}10`,
                                  color: label.colour,
                                  borderColor: `${label.colour}30`,
                                }}
                              >
                                <span className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: label.colour }}></span>
                                {label.name}
                              </span>
                            ))}
                          </div>

                          {/* Slick Progress Bar */}
                          {tasks.length > 0 && (
                            <div className="mb-2">
                              <span className="text-xs text-slate-400 mb-1 block">
                                {completedTasks}/{tasks.length} tasks
                              </span>
                              <div className="w-full bg-slate-100 rounded-full h-2">
                                <div
                                  className="h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400"
                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}
                                ></div>
                              </div>
                            </div>
                          )}

                          {/* Footer - Duration (Sold or In Stock) */}
                          <div className="pt-2 border-t border-slate-100 flex items-center justify-between">
                            <span className={`inline-flex items-center gap-1 text-[10px] font-medium ${
                              duration.isSold ? "text-emerald-600" : duration.days > 30 ? "text-red-500" : "text-slate-400"
                            }`}>
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              {duration.label}
                            </span>
                            {!duration.isSold && duration.days > 30 && (
                              <span className="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-500 border border-red-100">
                                Aging
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}

                  {/* Empty State */}
                  {columnVehicles.length === 0 && (
                    <div className="text-center py-8 px-4">
                      <div className="w-12 h-12 mx-auto mb-3 rounded-full bg-white/50 flex items-center justify-center">
                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                      </div>
                      <p className="text-sm text-slate-500 font-medium">No vehicles</p>
                      <p className="text-xs text-slate-400 mt-1">Drag cards here to move</p>
                    </div>
                  )}
                </div>
              </div>
            );
          })}
          </div>
        </>
      )}

      {/* Vehicle Detail Drawer - Full Screen on Mobile */}
      {selectedVehicle && (
        <div className="fixed inset-0 z-50 flex justify-end">
          <div className="bg-black/50 absolute inset-0 hidden md:block" onClick={() => setSelectedVehicle(null)}></div>
          <div className="relative bg-white w-full md:max-w-3xl h-full overflow-y-auto flex flex-col">
            {/* Sticky Header */}
            <div className="sticky top-0 bg-white border-b border-slate-200 px-4 md:px-6 py-3 md:py-4 flex justify-between items-center z-10">
              <div className="flex items-center gap-3">
                {/* Back button on mobile */}
                <button className="md:hidden btn btn-ghost btn-sm btn-circle" onClick={() => setSelectedVehicle(null)}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <div>
                  <h2 className="text-lg md:text-xl font-bold text-slate-900">
                    {selectedVehicle.year || ""} {selectedVehicle.make} {selectedVehicle.model}
                  </h2>
                  <p className="text-xs md:text-sm text-slate-500 font-mono mt-0.5">{selectedVehicle.regCurrent}</p>
                </div>
              </div>
              <div className="flex items-center gap-1 md:gap-2">
                <button
                  className="hidden md:flex btn btn-outline btn-sm"
                  onClick={handleGenerateJobSheet}
                  disabled={isGeneratingJobSheet}
                  title="Share job sheet with mechanic"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                  </svg>
                  {isGeneratingJobSheet ? "..." : "Share"}
                </button>
                <button
                  className="hidden md:flex btn btn-outline btn-sm"
                  onClick={handleGeneratePrepSummary}
                  disabled={isGeneratingPrepSummary}
                  title="Export prep summary PDF"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  {isGeneratingPrepSummary ? "..." : "Prep PDF"}
                </button>
                <button className="hidden md:flex btn btn-outline btn-sm" onClick={handlePrintVehicle} title="Print vehicle details">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                  </svg>
                  Print
                </button>
                <button
                  className="btn btn-ghost btn-sm text-error"
                  onClick={async () => {
                    if (confirm("Delete this vehicle?")) {
                      await fetch(`/api/vehicles/${selectedVehicle.id}`, { method: "DELETE" });
                      setSelectedVehicle(null);
                      fetchVehicles();
                      toast.success("Vehicle deleted");
                    }
                  }}
                  title="Delete vehicle"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
                <button className="hidden md:flex btn btn-ghost btn-sm" onClick={() => setSelectedVehicle(null)}>
                  ‚úï
                </button>
              </div>
            </div>

            {/* Tabs - Using DaisyUI tabs */}
            <div className="bg-base-100 border-b border-base-300 px-4">
              <div className="tabs tabs-bordered">
                <button
                  className={`tab ${activeTab === "overview" ? "tab-active" : ""}`}
                  onClick={() => setActiveTab("overview")}
                >
                  Overview
                </button>
                <button
                  className={`tab ${activeTab === "checklist" ? "tab-active" : ""}`}
                  onClick={() => setActiveTab("checklist")}
                >
                  Checklist {selectedVehicle.tasks?.length > 0 && `(${selectedVehicle.tasks.length})`}
                </button>
                <button
                  className={`tab ${activeTab === "issues" ? "tab-active" : ""}`}
                  onClick={() => setActiveTab("issues")}
                >
                  Issues {selectedVehicle.issues?.length > 0 && `(${selectedVehicle.issues.length})`}
                </button>
                <button
                  className={`tab ${activeTab === "documents" ? "tab-active" : ""}`}
                  onClick={() => setActiveTab("documents")}
                >
                  Documents {selectedVehicle.documents?.length > 0 && `(${selectedVehicle.documents.length})`}
                </button>
                <button
                  className={`tab ${activeTab === "activity" ? "tab-active" : ""}`}
                  onClick={() => {
                    setActiveTab("activity");
                    if (selectedVehicle?.id) {
                      fetchActivity(selectedVehicle.id);
                    }
                  }}
                >
                  Activity
                </button>
              </div>
            </div>

            <div className="p-6 space-y-6">
              {/* Overview Tab */}
              {activeTab === "overview" && (
                <div className="space-y-6">
                  {/* Identity Section */}
                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <h3 className="text-sm font-semibold text-slate-900 mb-4">Identity</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Registration</label>
                        <div className="flex gap-2">
                          <input
                            type="text"
                            className="input input-sm bg-slate-50 border-slate-200 text-slate-900 flex-1 font-mono uppercase"
                            value={selectedVehicle.regCurrent || ""}
                            onChange={(e) => setSelectedVehicle({ ...selectedVehicle, regCurrent: e.target.value.toUpperCase() })}
                            onBlur={async () => {
                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ regCurrent: selectedVehicle.regCurrent }),
                              });
                              fetchVehicles();
                            }}
                          />
                          <button
                            type="button"
                            className="btn btn-sm btn-primary"
                            onClick={lookupVehicleDVLA}
                            disabled={isLookingUpDrawer}
                            title="Lookup DVLA data for this registration"
                          >
                            {isLookingUpDrawer ? (
                              <span className="loading loading-spinner loading-xs"></span>
                            ) : (
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                              </svg>
                            )}
                          </button>
                        </div>
                        <p className="text-xs text-slate-400 mt-1">Click lookup to refresh DVLA data</p>
                      </div>
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">VIN</label>
                        <input
                          type="text"
                          className="input input-sm bg-slate-50 border-slate-200 text-slate-900"
                          value={selectedVehicle.vin || ""}
                          onChange={(e) => setSelectedVehicle({ ...selectedVehicle, vin: e.target.value })}
                          onBlur={async () => {
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ vin: selectedVehicle.vin }),
                            });
                            fetchVehicles();
                          }}
                        />
                      </div>
                    </div>
                  </div>

                  {/* Custom Labels Section */}
                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <h3 className="text-sm font-semibold text-slate-900 mb-3">Custom Labels</h3>

                    {/* Applied Labels Display */}
                    {selectedVehicle.labels?.length > 0 && (
                      <div className="flex flex-wrap gap-2 mb-3">
                        {selectedVehicle.labels.map((label) => (
                          <span
                            key={label.id}
                            className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold"
                            style={{
                              backgroundColor: `${label.colour}20`,
                              color: label.colour,
                            }}
                          >
                            <span className="w-2 h-2 rounded-full" style={{ backgroundColor: label.colour }}></span>
                            {label.name}
                            <button
                              type="button"
                              onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}
                              className="ml-0.5 hover:opacity-70"
                            >
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </span>
                        ))}
                      </div>
                    )}

                    {/* Labels Dropdown */}
                    <div className="relative">
                      <button
                        type="button"
                        onClick={() => setShowLabelsDropdown(!showLabelsDropdown)}
                        className="w-full flex items-center justify-between px-3 py-2 border border-slate-300 rounded-lg bg-white text-sm hover:border-slate-400 transition-colors"
                      >
                        <span className="text-slate-600">
                          {selectedVehicle.labels?.length > 0
                            ? `${selectedVehicle.labels.length} label${selectedVehicle.labels.length > 1 ? 's' : ''} selected`
                            : "Select labels..."
                          }
                        </span>
                        <svg className={`w-4 h-4 text-slate-400 transition-transform ${showLabelsDropdown ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>

                      {showLabelsDropdown && (
                        <div className="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-auto">
                          {availableLabels.map((label) => {
                            const isApplied = selectedVehicle.labels?.some(l => l.id === label.id);
                            return (
                              <button
                                key={label.id}
                                type="button"
                                onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}
                                className="w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left"
                              >
                                <span
                                  className="w-3 h-3 rounded-full flex-shrink-0"
                                  style={{ backgroundColor: label.colour }}
                                ></span>
                                <span className="flex-1 text-sm text-slate-700">{label.name}</span>
                                {isApplied && (
                                  <svg className="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                  </svg>
                                )}
                              </button>
                            );
                          })}

                          {/* Add New Label Option */}
                          <div className="border-t border-slate-100">
                            <button
                              type="button"
                              onClick={() => {
                                setShowLabelsDropdown(false);
                                setShowAddLabelModal(true);
                              }}
                              className="w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left text-[#0066CC]"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                              </svg>
                              <span className="text-sm font-medium">Add new label</span>
                            </button>
                          </div>
                        </div>
                      )}
                    </div>

                    {availableLabels.length === 0 && (
                      <button
                        type="button"
                        onClick={() => setShowAddLabelModal(true)}
                        className="w-full flex items-center justify-center gap-2 px-3 py-2 border border-dashed border-slate-300 rounded-lg text-sm text-slate-500 hover:border-slate-400 hover:text-slate-600 transition-colors"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        Create your first label
                      </button>
                    )}
                  </div>

                  {/* Status & Location Section - Now below Identity */}
                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <h3 className="text-sm font-semibold text-slate-900 mb-4">Status & Location</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Vehicle Type</label>
                        <select
                          className="select select-sm select-bordered w-full"
                          value={selectedVehicle.type || "STOCK"}
                          onChange={async (e) => {
                            const newType = e.target.value;
                            const updates = { type: newType };
                            // Clear saleType if not Stock
                            if (newType !== "STOCK") {
                              updates.saleType = null;
                            }
                            setSelectedVehicle({ ...selectedVehicle, ...updates });
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify(updates),
                            });
                            fetchVehicles();
                            toast.success("Vehicle type updated");
                          }}
                        >
                          <option value="STOCK">Stock</option>
                          <option value="COURTESY">Courtesy</option>
                          <option value="FLEET_OTHER">Fleet</option>
                        </select>
                      </div>
                      {/* Sale Type - Only show for Stock vehicles */}
                      {(selectedVehicle.type === "STOCK" || !selectedVehicle.type) && (
                        <div className="form-control">
                          <label className="text-xs font-medium text-slate-600 mb-1 block">Sale Type</label>
                          <select
                            className="select select-sm select-bordered w-full"
                            value={selectedVehicle.saleType || "RETAIL"}
                            onChange={async (e) => {
                              const newSaleType = e.target.value;
                              setSelectedVehicle({ ...selectedVehicle, saleType: newSaleType });
                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ saleType: newSaleType }),
                              });
                              fetchVehicles();
                              toast.success("Sale type updated");
                            }}
                          >
                            <option value="RETAIL">Retail</option>
                            <option value="TRADE">Trade</option>
                          </select>
                        </div>
                      )}
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Status</label>
                        <select
                          className="select select-sm select-bordered w-full"
                          value={selectedVehicle.status || "in_stock"}
                          onChange={async (e) => {
                            const newStatus = e.target.value;
                            setSelectedVehicle({ ...selectedVehicle, status: newStatus });
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ status: newStatus }),
                            });
                            fetchVehicles();
                            toast.success(`Status updated to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);
                          }}
                        >
                          {COLUMNS.map(col => (
                            <option key={col.key} value={col.key}>{col.label}</option>
                          ))}
                        </select>
                      </div>
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Location</label>
                        <select
                          className="select select-sm select-bordered w-full"
                          value={selectedVehicle.locationId?.id || selectedVehicle.locationId?._id || selectedVehicle.locationId || ""}
                          onChange={async (e) => {
                            const value = e.target.value;
                            if (value === "__add_new__") {
                              setShowAddLocationModal(true);
                              return;
                            }
                            const locationId = value || null;
                            setSelectedVehicle({ ...selectedVehicle, locationId: locationId });
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ locationId }),
                            });
                            const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
                            setSelectedVehicle(updated);
                            fetchVehicles();
                            toast.success("Location updated");
                          }}
                        >
                          <option value="">On Site</option>
                          {locations.map(loc => (
                            <option key={loc.id || loc._id} value={loc.id || loc._id}>{loc.name}</option>
                          ))}
                          <option value="__add_new__">+ Add Location</option>
                        </select>
                      </div>
                    </div>
                  </div>

                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                      <h3 className="text-sm font-semibold text-slate-900 mb-4">Specs</h3>
                      <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-3">
                          <div className="form-control">
                            <label className="label label-text text-xs">Make</label>
                            <input
                              type="text"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.make || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, make: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ make: selectedVehicle.make }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>

                          <div className="form-control">
                            <label className="label label-text text-xs">Model</label>
                            <input
                              type="text"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.model || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, model: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ model: selectedVehicle.model }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div className="form-control">
                            <label className="label label-text text-xs">Year</label>
                            <input
                              type="number"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.year || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, year: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ year: selectedVehicle.year }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>

                          <div className="form-control">
                            <label className="label label-text text-xs">Mileage</label>
                            <input
                              type="number"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.mileageCurrent || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, mileageCurrent: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ mileageCurrent: selectedVehicle.mileageCurrent }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div className="form-control">
                            <label className="label label-text text-xs">Colour</label>
                            <input
                              type="text"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.colour || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, colour: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ colour: selectedVehicle.colour }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>

                          <div className="form-control">
                            <label className="label label-text text-xs">Fuel Type</label>
                            <select
                              className="select select-sm select-bordered"
                              value={selectedVehicle.fuelType || ""}
                              onChange={async (e) => {
                                const newValue = e.target.value;
                                setSelectedVehicle({ ...selectedVehicle, fuelType: newValue });
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ fuelType: newValue }),
                                });
                                fetchVehicles();
                              }}
                            >
                              <option value="">Select...</option>
                              <option value="Petrol">Petrol</option>
                              <option value="Diesel">Diesel</option>
                              <option value="Hybrid">Hybrid</option>
                              <option value="Electric">Electric</option>
                            </select>
                          </div>
                        </div>

                        <div className="form-control">
                          <label className="label label-text text-xs">MOT Expiry Date</label>
                          <input
                            type="date"
                            className="input input-sm input-bordered"
                            value={selectedVehicle.motExpiryDate ? new Date(selectedVehicle.motExpiryDate).toISOString().split('T')[0] : ""}
                            onChange={async (e) => {
                              const newValue = e.target.value;
                              setSelectedVehicle({ ...selectedVehicle, motExpiryDate: newValue });
                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ motExpiryDate: newValue }),
                              });
                              fetchVehicles();
                            }}
                          />
                        </div>
                      </div>
                    </div>

                  <div className="card bg-base-200">
                    <div className="card-body p-4">
                      <h3 className="font-semibold mb-2">V5 Document</h3>
                      {selectedVehicle.v5Url ? (
                        <div>
                          <a href={selectedVehicle.v5Url} target="_blank" rel="noopener noreferrer" className="btn btn-sm btn-outline w-full mb-2">
                            View V5 Document
                          </a>
                          <label className="btn btn-sm btn-ghost w-full">
                            Replace V5
                            <input type="file" accept="image/*,.pdf" className="hidden" onChange={(e) => uploadV5(e.target.files[0])} />
                          </label>
                        </div>
                      ) : (
                        <label className="btn btn-primary btn-sm w-full">
                          Upload V5
                          <input type="file" accept="image/*,.pdf" className="hidden" onChange={(e) => uploadV5(e.target.files[0])} />
                        </label>
                      )}
                    </div>
                  </div>

                  {selectedVehicle.notes && (
                    <div className="card bg-base-200">
                      <div className="card-body p-4">
                        <h3 className="font-semibold mb-2">Notes</h3>
                        <p className="text-sm whitespace-pre-wrap">{selectedVehicle.notes}</p>
                      </div>
                    </div>
                  )}
                </div>
              )}


              {/* Prep Checklist Tab */}
              {activeTab === "checklist" && (
                <div className="card bg-base-200">
                  <div className="card-body p-4">
                    <h3 className="font-semibold mb-3">Prep Checklist</h3>
                    <div className="space-y-2">
                      {selectedVehicle.tasks?.map((task) => (
                        <div key={task.id} className="p-2 rounded hover:bg-base-300 group">
                          <div className="flex items-center gap-2">
                            <select
                              className="select select-bordered select-xs"
                              value={task.status || "pending"}
                              onChange={(e) => updateTaskStatus(task.id, e.target.value)}
                              onClick={(e) => e.stopPropagation()}
                            >
                              <option value="pending">Pending</option>
                              <option value="in_progress">In Progress</option>
                              <option value="done">Done</option>
                              <option value="not_required">Not Required</option>
                            </select>
                            {editingTaskId === task.id ? (
                              <input
                                type="text"
                                className="input input-bordered input-xs flex-1"
                                value={editingTaskName}
                                onChange={(e) => setEditingTaskName(e.target.value)}
                                onBlur={() => {
                                  if (editingTaskName.trim() && editingTaskName !== task.name) {
                                    updateTaskName(task.id, editingTaskName);
                                  } else {
                                    setEditingTaskId(null);
                                    setEditingTaskName("");
                                  }
                                }}
                                onKeyPress={(e) => {
                                  if (e.key === "Enter") {
                                    if (editingTaskName.trim() && editingTaskName !== task.name) {
                                      updateTaskName(task.id, editingTaskName);
                                    } else {
                                      setEditingTaskId(null);
                                      setEditingTaskName("");
                                    }
                                  }
                                }}
                                onKeyDown={(e) => {
                                  if (e.key === "Escape") {
                                    setEditingTaskId(null);
                                    setEditingTaskName("");
                                  }
                                }}
                                autoFocus
                              />
                            ) : (
                              <span
                                className={`flex-1 text-sm cursor-pointer ${task.status === "done" ? "line-through text-base-content/50" : ""}`}
                                onClick={() => {
                                  setEditingTaskId(task.id);
                                  setEditingTaskName(task.name);
                                }}
                                title="Click to edit"
                              >
                                {task.name}
                                {/* Show parts status chip next to task name */}
                                {task.partsOrders?.length > 0 && (
                                  <span className={`ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${
                                    task.partsOrders.every(o => o.status === "RECEIVED")
                                      ? "bg-green-100 text-green-800 border border-green-200"
                                      : task.partsOrders.some(o => o.status === "RECEIVED")
                                        ? "bg-blue-100 text-blue-800 border border-blue-200"
                                        : "bg-amber-100 text-amber-800 border border-amber-200"
                                  }`}>
                                    {task.partsOrders.every(o => o.status === "RECEIVED")
                                      ? `‚úì Parts Received (${task.partsOrders.length})`
                                      : task.partsOrders.some(o => o.status === "RECEIVED")
                                        ? `Parts: ${task.partsOrders.filter(o => o.status === "RECEIVED").length}/${task.partsOrders.length} Received`
                                        : `Parts Ordered (${task.partsOrders.length})`
                                    }
                                  </span>
                                )}
                              </span>
                            )}
                            {task.completedAt && !editingTaskId && (
                              <span className="text-xs text-base-content/50">
                                {formatDate(task.completedAt)}
                              </span>
                            )}
                            {/* Order Parts button - show for pending/in_progress tasks */}
                            {task.status !== "done" && task.status !== "not_required" && (
                              <button
                                className="btn btn-ghost btn-xs text-amber-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  openPartsOrderModal(task.id);
                                }}
                                title="Order Parts"
                              >
                                + Parts
                              </button>
                            )}
                            <button
                              className="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity"
                              onClick={() => deleteTask(task.id)}
                            >
                              ‚úï
                            </button>
                          </div>
                          {/* Parts orders section - show if task has parts orders */}
                          {task.partsOrders?.length > 0 && (
                            <div className="mt-2 ml-6 pl-2 border-l-2 border-amber-300 space-y-1">
                              {task.partsOrders.map((order) => (
                                <div key={order._id || order.id} className="flex items-center gap-2 text-xs">
                                  <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium ${
                                    order.status === "RECEIVED"
                                      ? "bg-green-100 text-green-700"
                                      : "bg-amber-100 text-amber-700"
                                  }`}>
                                    {order.status === "RECEIVED" ? "‚úì" : "‚è≥"}
                                  </span>
                                  <span className="text-base-content/80">{getSupplierDisplay(order)}</span>
                                  {order.orderRef && (
                                    <span className="text-base-content/50">Ref: {order.orderRef}</span>
                                  )}
                                  {order.expectedAt && order.status !== "RECEIVED" && (
                                    <span className="text-base-content/50">
                                      ETA: {formatDate(order.expectedAt)}
                                    </span>
                                  )}
                                  {order.status !== "RECEIVED" && (
                                    <button
                                      className="btn btn-ghost btn-xs text-green-600"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        markPartsReceived(task.id, order._id || order.id);
                                      }}
                                      title="Mark as Received"
                                    >
                                      ‚úì Received
                                    </button>
                                  )}
                                  <button
                                    className="btn btn-ghost btn-xs"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      openPartsOrderModal(task.id, order);
                                    }}
                                    title="Edit"
                                  >
                                    ‚úé
                                  </button>
                                  <button
                                    className="btn btn-ghost btn-xs text-error"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      removePartsOrder(task.id, order._id || order.id);
                                    }}
                                    title="Remove"
                                  >
                                    ‚úï
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                    <div className="flex gap-2 mt-3">
                      <input
                        type="text"
                        className="input input-bordered input-sm flex-1"
                        placeholder="Add new task..."
                        value={newTaskName}
                        onChange={(e) => setNewTaskName(e.target.value)}
                        onKeyPress={(e) => e.key === "Enter" && addTask()}
                      />
                      <button className="btn btn-primary btn-sm" onClick={addTask}>
                        Add
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Issues Tab */}
              {activeTab === "issues" && (
                <div className="space-y-4">
                  <button
                    className="flex items-center justify-center gap-2 w-full px-4 py-2.5 bg-[#0066CC] hover:bg-[#0055AA] text-white text-sm font-medium rounded-xl shadow-sm shadow-[#0066CC]/25 hover:shadow-md transition-all"
                    onClick={() => setShowAddIssueModal(true)}
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                    </svg>
                    Add Issue
                  </button>

                  {selectedVehicle.issues && selectedVehicle.issues.length > 0 ? (
                    <div className="space-y-3">
                      {selectedVehicle.issues.map((issue) => (
                        <div key={issue.id} className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                          {/* Issue Header with Status Bar */}
                          <div className={`px-4 py-3 border-b border-slate-100 ${
                            issue.status === "Complete" ? "bg-emerald-50/50" :
                            issue.status === "In Progress" ? "bg-amber-50/50" :
                            issue.status === "Ordered" ? "bg-blue-50/50" :
                            "bg-red-50/50"
                          }`}>
                            <div className="flex items-center justify-between gap-3">
                              <div className="flex items-center gap-2 flex-wrap min-w-0">
                                <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-[#0066CC]/10 text-[#0066CC]">
                                  {issue.category}
                                </span>
                                {issue.subcategory && (
                                  <span className="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-600">
                                    {issue.subcategory}
                                  </span>
                                )}
                              </div>
                              <select
                                className={`text-xs font-semibold px-2.5 py-1.5 rounded-lg border-0 cursor-pointer transition-colors ${
                                  issue.status === "Complete" ? "bg-emerald-100 text-emerald-700" :
                                  issue.status === "In Progress" ? "bg-amber-100 text-amber-700" :
                                  issue.status === "Ordered" ? "bg-blue-100 text-blue-700" :
                                  "bg-red-100 text-red-700"
                                }`}
                                value={issue.status || "Outstanding"}
                                onChange={(e) => updateIssue(issue.id, { status: e.target.value })}
                              >
                                <option value="Outstanding">Outstanding</option>
                                <option value="Ordered">Ordered</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Complete">Complete</option>
                              </select>
                            </div>
                          </div>

                          {/* Issue Body */}
                          <div className="p-4 space-y-3">
                            {/* Description */}
                            <p className="text-sm font-medium text-slate-800">{issue.description}</p>

                            {/* Details Grid */}
                            <div className="space-y-2">
                              {issue.actionNeeded && (
                                <div className="flex items-start gap-2">
                                  <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pt-0.5 w-14">Action</span>
                                  <p className="text-sm text-slate-600">{issue.actionNeeded}</p>
                                </div>
                              )}
                              {issue.notes && (
                                <div className="flex items-start gap-2">
                                  <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wide shrink-0 pt-0.5 w-14">Notes</span>
                                  <p className="text-sm text-slate-600">{issue.notes}</p>
                                </div>
                              )}
                            </div>

                            {/* Parts Details */}
                            {issue.partsRequired && (
                              <div className="flex items-start gap-2 p-3 bg-[#0066CC]/5 rounded-xl border border-[#0066CC]/10">
                                <div className="w-7 h-7 rounded-lg bg-[#0066CC]/10 flex items-center justify-center shrink-0">
                                  <svg className="w-4 h-4 text-[#0066CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                                  </svg>
                                </div>
                                <div className="flex-1 min-w-0">
                                  <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-[#0066CC]/10 text-[#0066CC]">
                                    Parts Required
                                  </span>
                                  {issue.partsDetails && (
                                    <p className="text-sm text-slate-600 mt-1">{issue.partsDetails}</p>
                                  )}
                                </div>
                              </div>
                            )}

                            {/* Photos */}
                            {issue.photos && issue.photos.length > 0 && (
                              <div className="pt-2">
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wide mb-2">
                                  Photos ({issue.photos.length})
                                </p>
                                <div className="flex flex-wrap gap-2">
                                  {issue.photos.map((photo, idx) => (
                                    <a key={idx} href={photo} target="_blank" rel="noopener noreferrer" className="group">
                                      <img
                                        src={photo}
                                        alt={`Issue photo ${idx + 1}`}
                                        className="w-16 h-16 object-cover rounded-xl border-2 border-slate-200 group-hover:border-[#0066CC] group-hover:scale-105 transition-all"
                                      />
                                    </a>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>

                          {/* Updates Accordion */}
                          <div className="border-t border-slate-100">
                            <button
                              className="w-full flex items-center justify-between px-4 py-2.5 text-sm font-medium text-slate-600 hover:bg-slate-50 transition-colors"
                              onClick={() => setExpandedIssues(prev => ({
                                ...prev,
                                [issue.id]: !prev[issue.id]
                              }))}
                            >
                              <span className="flex items-center gap-2">
                                <svg className="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                                Updates {issue.updates?.length > 0 && `(${issue.updates.length})`}
                              </span>
                              <svg
                                className={`w-4 h-4 text-slate-400 transition-transform duration-200 ${expandedIssues[issue.id] ? "rotate-180" : ""}`}
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                              >
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                              </svg>
                            </button>

                            {expandedIssues[issue.id] && (
                              <div className="px-4 pb-4 space-y-3 bg-slate-50/50">
                                {/* Creation timestamp */}
                                <div className="flex gap-3 text-xs">
                                  <div className="w-1 bg-slate-200 rounded-full"></div>
                                  <p className="text-slate-500">
                                    Created {formatDate(issue.createdAt)}
                                  </p>
                                </div>

                                {/* Updates timeline */}
                                {issue.updates && issue.updates.length > 0 ? (
                                  issue.updates.map((update, idx) => (
                                    <div key={idx} className="flex gap-3">
                                      <div className="w-1 bg-[#0066CC]/30 rounded-full"></div>
                                      <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2 mb-1">
                                          <p className="text-sm font-semibold text-slate-700">{update.userName || "User"}</p>
                                          <span className="text-xs text-slate-400">{formatDate(update.createdAt)}</span>
                                        </div>
                                        <p className="text-sm text-slate-600">{update.content}</p>
                                      </div>
                                    </div>
                                  ))
                                ) : (
                                  <p className="text-xs text-slate-400 text-center py-2">No updates yet</p>
                                )}

                                {/* Add update input */}
                                <div className="flex gap-2 pt-2">
                                  <input
                                    type="text"
                                    className="flex-1 px-3 py-2 text-sm bg-white border border-slate-200 rounded-xl focus:border-[#0066CC] focus:ring-1 focus:ring-[#0066CC]/20 outline-none transition-all"
                                    placeholder="Add an update..."
                                    value={issueUpdateContent[issue.id] || ""}
                                    onChange={(e) => setIssueUpdateContent(prev => ({
                                      ...prev,
                                      [issue.id]: e.target.value
                                    }))}
                                    onKeyPress={(e) => {
                                      if (e.key === "Enter") {
                                        addIssueUpdate(issue.id, issueUpdateContent[issue.id]);
                                      }
                                    }}
                                  />
                                  <button
                                    className="px-4 py-2 bg-[#0066CC] hover:bg-[#0055AA] text-white text-sm font-medium rounded-xl transition-colors"
                                    onClick={() => addIssueUpdate(issue.id, issueUpdateContent[issue.id])}
                                  >
                                    Add
                                  </button>
                                </div>
                              </div>
                            )}
                          </div>

                          {/* Actions Footer */}
                          <div className="flex items-center justify-end gap-2 px-4 py-3 bg-slate-50/50 border-t border-slate-100">
                            <button
                              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-slate-600 hover:text-[#0066CC] hover:bg-[#0066CC]/5 rounded-lg transition-colors"
                              onClick={() => openEditIssue(issue)}
                            >
                              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                              </svg>
                              Edit
                            </button>
                            <button
                              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                              onClick={() => {
                                if (confirm("Delete this issue?")) deleteIssue(issue.id);
                              }}
                            >
                              <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                              Delete
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center">
                      <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      </div>
                      <p className="text-sm font-medium text-slate-600">No issues recorded</p>
                      <p className="text-xs text-slate-400 mt-1">Add an issue to track problems with this vehicle</p>
                    </div>
                  )}
                </div>
              )}

              {/* Documents Tab */}
              {activeTab === "documents" && (
                <div className="space-y-4">
                  <button
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => setShowAddDocumentModal(true)}
                  >
                    + Add Document/Image
                  </button>

                  {selectedVehicle.documents && selectedVehicle.documents.length > 0 ? (
                    <div className="space-y-3">
                      {selectedVehicle.documents.map((doc) => (
                        <div key={doc.id} className="card bg-base-200">
                          <div className="card-body p-4">
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <p className="text-sm font-medium">{doc.name}</p>
                                <span className="badge badge-sm mt-1">
                                  {doc.type === "v5" && "V5"}
                                  {doc.type === "service_history" && "Service History"}
                                  {doc.type === "fault_codes" && "Fault Codes"}
                                  {doc.type === "other" && "Other"}
                                </span>
                              </div>
                              <div className="flex gap-1">
                                <a
                                  href={doc.url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="btn btn-ghost btn-xs"
                                  onClick={(e) => e.stopPropagation()}
                                >
                                  View
                                </a>
                                <button
                                  className="btn btn-ghost btn-xs text-error"
                                  onClick={() => {
                                    if (confirm("Delete this document?")) deleteDocument(doc.id);
                                  }}
                                >
                                  Delete
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-8 text-base-content/60">
                      No documents uploaded
                    </div>
                  )}
                </div>
              )}

              {/* Activity Tab */}
              {activeTab === "activity" && (
                <div className="space-y-4">
                  <h3 className="text-sm font-semibold text-slate-900">Activity Log</h3>

                  {activityLoading && activityData.activities.length === 0 ? (
                    <div className="flex justify-center py-8">
                      <div className="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    </div>
                  ) : activityData.activities.length === 0 ? (
                    <div className="text-center py-8 text-base-content/60">
                      No activity recorded yet
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {activityData.activities.map((activity) => (
                        <div
                          key={activity._id || activity.id}
                          className="flex items-start gap-3 p-3 bg-slate-50 rounded-lg border border-slate-100"
                        >
                          <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${
                            activity.type === "VEHICLE_CREATED" ? "bg-green-100" :
                            activity.type === "STATUS_CHANGED" ? "bg-blue-100" :
                            activity.type === "TYPE_CHANGED" ? "bg-[#0066CC]/10" :
                            activity.type === "LOCATION_CHANGED" ? "bg-[#0066CC]/10" :
                            activity.type === "TASK_COMPLETED" ? "bg-emerald-100" :
                            activity.type === "TASK_STATUS_UPDATED" ? "bg-amber-100" :
                            activity.type === "TASK_PROGRESS_UPDATED" ? "bg-orange-100" :
                            activity.type === "TASK_PARTS_STATUS_CHANGED" || activity.type === "TASK_PARTS_ORDER_ADDED" ? "bg-amber-100" :
                            activity.type === "TASK_PARTS_ORDER_UPDATED" ? "bg-blue-100" :
                            activity.type === "TASK_PARTS_ORDER_REMOVED" ? "bg-red-100" :
                            activity.type === "TASK_ADDED" || activity.type === "TASK_DELETED" ? "bg-slate-100" :
                            activity.type === "ISSUE_ADDED" ? "bg-red-100" :
                            activity.type === "ISSUE_RESOLVED" ? "bg-green-100" :
                            activity.type === "ISSUE_UPDATED" || activity.type === "ISSUE_COMMENT_ADDED" ? "bg-yellow-100" :
                            "bg-slate-100"
                          }`}>
                            {/* Vehicle lifecycle */}
                            {activity.type === "VEHICLE_CREATED" && (
                              <svg className="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                            )}
                            {activity.type === "STATUS_CHANGED" && (
                              <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
                              </svg>
                            )}
                            {activity.type === "TYPE_CHANGED" && (
                              <svg className="w-4 h-4 text-[#0066CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                              </svg>
                            )}
                            {activity.type === "LOCATION_CHANGED" && (
                              <svg className="w-4 h-4 text-[#0066CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                              </svg>
                            )}
                            {activity.type === "DETAILS_UPDATED" && (
                              <svg className="w-4 h-4 text-[#14B8A6]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                              </svg>
                            )}
                            {/* Task events */}
                            {activity.type === "TASK_COMPLETED" && (
                              <svg className="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                            )}
                            {activity.type === "TASK_STATUS_UPDATED" && (
                              <svg className="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                              </svg>
                            )}
                            {activity.type === "TASK_PROGRESS_UPDATED" && (
                              <svg className="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                              </svg>
                            )}
                            {(activity.type === "TASK_ADDED" || activity.type === "TASK_UPDATED") && (
                              <svg className="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                              </svg>
                            )}
                            {activity.type === "TASK_DELETED" && (
                              <svg className="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            )}
                            {/* Parts ordering events */}
                            {(activity.type === "TASK_PARTS_STATUS_CHANGED" || activity.type === "TASK_PARTS_ORDER_ADDED") && (
                              <svg className="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                              </svg>
                            )}
                            {activity.type === "TASK_PARTS_ORDER_UPDATED" && (
                              <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                              </svg>
                            )}
                            {activity.type === "TASK_PARTS_ORDER_REMOVED" && (
                              <svg className="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            )}
                            {/* Issue events */}
                            {activity.type === "ISSUE_ADDED" && (
                              <svg className="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                              </svg>
                            )}
                            {activity.type === "ISSUE_RESOLVED" && (
                              <svg className="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                              </svg>
                            )}
                            {(activity.type === "ISSUE_UPDATED" || activity.type === "ISSUE_COMMENT_ADDED") && (
                              <svg className="w-4 h-4 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                              </svg>
                            )}
                            {activity.type === "ISSUE_DELETED" && (
                              <svg className="w-4 h-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                              </svg>
                            )}
                            {/* Document events */}
                            {(activity.type === "DOC_UPLOADED" || activity.type === "DOC_DELETED") && (
                              <svg className="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                            )}
                            {/* Fallback for any unhandled types */}
                            {!["VEHICLE_CREATED", "STATUS_CHANGED", "TYPE_CHANGED", "LOCATION_CHANGED", "DETAILS_UPDATED",
                               "TASK_COMPLETED", "TASK_STATUS_UPDATED", "TASK_PROGRESS_UPDATED", "TASK_ADDED", "TASK_UPDATED", "TASK_DELETED",
                               "TASK_PARTS_STATUS_CHANGED", "TASK_PARTS_ORDER_ADDED", "TASK_PARTS_ORDER_UPDATED", "TASK_PARTS_ORDER_REMOVED",
                               "ISSUE_ADDED", "ISSUE_RESOLVED", "ISSUE_UPDATED", "ISSUE_COMMENT_ADDED", "ISSUE_DELETED",
                               "DOC_UPLOADED", "DOC_DELETED"].includes(activity.type) && (
                              <svg className="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                            )}
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="text-sm text-slate-900">{activity.message}</p>
                            <p className="text-xs text-slate-500 mt-0.5">
                              by {activity.actorName || "Unknown"} &middot; {formatRelativeTime(activity.createdAt)}
                            </p>
                          </div>
                        </div>
                      ))}

                      {activityData.hasMore && (
                        <button
                          onClick={() => fetchActivity(selectedVehicle.id, true)}
                          disabled={activityLoading}
                          className="w-full btn btn-ghost btn-sm text-slate-600"
                        >
                          {activityLoading ? (
                            <span className="flex items-center gap-2">
                              <div className="w-4 h-4 border-2 border-slate-400 border-t-transparent rounded-full animate-spin"></div>
                              Loading...
                            </span>
                          ) : (
                            "Load more"
                          )}
                        </button>
                      )}
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Drag Preview - floating card that follows cursor */}
      {draggedCard && (
        <div
          className="fixed pointer-events-none z-50"
          style={{
            left: dragPosition.x - 120,
            top: dragPosition.y - 30,
            transform: "rotate(3deg)",
          }}
        >
          <div className="bg-white rounded-xl shadow-2xl border-2 border-blue-400 w-60 p-3 opacity-90">
            <div className="flex items-center gap-2">
              <p className="font-bold text-slate-900 text-sm truncate">
                {draggedCard.year} {draggedCard.make} {draggedCard.model}
              </p>
            </div>
            <span className="font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md inline-block mt-1">
              {draggedCard.regCurrent}
            </span>
          </div>
        </div>
      )}

      {showAddModal && (
        <AddVehicleModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchVehicles(); }} />
      )}

      {showAddIssueModal && (
        <AddIssueModal
          issueForm={issueForm}
          setIssueForm={setIssueForm}
          isEditing={!!editingIssue}
          onClose={() => {
            setShowAddIssueModal(false);
            setEditingIssue(null);
            setIssueForm({
              category: "",
              subcategory: "",
              description: "",
              actionNeeded: "",
              priority: "medium",
              location: "",
              status: "outstanding",
              notes: "",
              photos: [],
              partsRequired: false,
              partsDetails: "",
            });
          }}
          onSubmit={editingIssue ? saveEditedIssue : addIssue}
        />
      )}

      {showAddDocumentModal && (
        <AddDocumentModal
          documentForm={documentForm}
          setDocumentForm={setDocumentForm}
          onClose={() => {
            setShowAddDocumentModal(false);
            setDocumentForm({ name: "", type: "other", file: null });
          }}
          onSubmit={() => {
            if (!documentForm.file) {
              return toast.error("File is required");
            }
            if (documentForm.type === "other" && !documentForm.name) {
              return toast.error("Document name is required for 'Other' type");
            }
            // Generate default name based on type if not "other"
            const docName = documentForm.type === "other"
              ? documentForm.name
              : documentForm.type.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
            uploadDocument(documentForm.file, docName, documentForm.type);
          }}
        />
      )}

      {showAddLocationModal && (
        <AddLocationModal
          onClose={() => setShowAddLocationModal(false)}
          onSuccess={(newLocation) => {
            setLocations([...locations, newLocation]);
            setSelectedVehicle({ ...selectedVehicle, locationId: newLocation.id || newLocation._id });
            fetch(`/api/vehicles/${selectedVehicle.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ locationId: newLocation.id || newLocation._id }),
            }).then(() => {
              fetchVehicles();
              setShowAddLocationModal(false);
            });
          }}
        />
      )}

      {/* Parts Order Modal */}
      {showPartsOrderModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div className="flex items-center justify-between p-4 border-b border-slate-200">
              <h3 className="text-lg font-bold text-slate-900">
                {editingPartsOrderId ? "Edit Parts Order" : "Add Parts Order"}
              </h3>
              <button
                onClick={closePartsOrderModal}
                className="btn btn-ghost btn-sm btn-circle"
              >
                ‚úï
              </button>
            </div>
            <div className="p-4 space-y-4">
              <div className="form-control">
                <label className="label">
                  <span className="label-text font-medium">Supplier</span>
                </label>
                <select
                  className="select select-bordered w-full"
                  value={partsOrderForm.supplierType}
                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, supplierType: e.target.value })}
                >
                  <option value="EURO_CAR_PARTS">Euro Car Parts</option>
                  <option value="TPS">TPS</option>
                  <option value="MAIN_DEALER">Main Dealer</option>
                  <option value="LOCAL_FACTOR">Local Factor</option>
                  <option value="ONLINE">Online</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>
              {partsOrderForm.supplierType === "OTHER" && (
                <div className="form-control">
                  <label className="label">
                    <span className="label-text font-medium">Supplier Name</span>
                  </label>
                  <input
                    type="text"
                    placeholder="Enter supplier name"
                    className="input input-bordered w-full"
                    value={partsOrderForm.supplierName}
                    onChange={(e) => setPartsOrderForm({ ...partsOrderForm, supplierName: e.target.value })}
                  />
                </div>
              )}
              <div className="form-control">
                <label className="label">
                  <span className="label-text font-medium">Order Reference (Optional)</span>
                </label>
                <input
                  type="text"
                  placeholder="e.g., ORD-123456"
                  className="input input-bordered w-full"
                  value={partsOrderForm.orderRef}
                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, orderRef: e.target.value })}
                />
              </div>
              <div className="form-control">
                <label className="label">
                  <span className="label-text font-medium">Expected Delivery (Optional)</span>
                </label>
                <input
                  type="date"
                  className="input input-bordered w-full"
                  value={partsOrderForm.expectedAt}
                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, expectedAt: e.target.value })}
                />
              </div>
              <div className="form-control">
                <label className="label">
                  <span className="label-text font-medium">Notes (Optional)</span>
                </label>
                <input
                  type="text"
                  placeholder="e.g., Oil filter + air filter"
                  className="input input-bordered w-full"
                  value={partsOrderForm.notes}
                  onChange={(e) => setPartsOrderForm({ ...partsOrderForm, notes: e.target.value })}
                />
              </div>
            </div>
            <div className="flex justify-end gap-2 p-4 border-t border-slate-200">
              <button
                className="btn btn-ghost"
                onClick={closePartsOrderModal}
              >
                Cancel
              </button>
              <button
                className="btn btn-primary"
                onClick={editingPartsOrderId ? updatePartsOrder : addPartsOrder}
              >
                {editingPartsOrderId ? "Update" : "Add Order"}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add Label Modal */}
      {showAddLabelModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div className="flex items-center justify-between p-4 border-b border-slate-200">
              <h3 className="text-lg font-bold text-slate-900">Create New Label</h3>
              <button
                onClick={() => {
                  setShowAddLabelModal(false);
                  setNewLabelForm({ name: "", colour: "#6366f1" });
                }}
                className="btn btn-ghost btn-sm btn-circle"
              >
                ‚úï
              </button>
            </div>
            <div className="p-4 space-y-4">
              <div className="form-control">
                <label className="label">
                  <span className="label-text font-medium">Label Name</span>
                </label>
                <input
                  type="text"
                  placeholder="e.g., Hot Lead, Awaiting Finance"
                  className="input input-bordered w-full"
                  value={newLabelForm.name}
                  onChange={(e) => setNewLabelForm({ ...newLabelForm, name: e.target.value })}
                  autoFocus
                />
              </div>
              <div className="form-control">
                <label className="label">
                  <span className="label-text font-medium">Colour</span>
                </label>
                <div className="flex items-center gap-3">
                  <input
                    type="color"
                    className="w-12 h-10 rounded cursor-pointer border border-slate-300"
                    value={newLabelForm.colour}
                    onChange={(e) => setNewLabelForm({ ...newLabelForm, colour: e.target.value })}
                  />
                  <div className="flex gap-2">
                    {["#ef4444", "#f59e0b", "#22c55e", "#3b82f6", "#8b5cf6", "#ec4899", "#6b7280"].map(color => (
                      <button
                        key={color}
                        type="button"
                        onClick={() => setNewLabelForm({ ...newLabelForm, colour: color })}
                        className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${newLabelForm.colour === color ? 'border-slate-900 scale-110' : 'border-transparent'}`}
                        style={{ backgroundColor: color }}
                      />
                    ))}
                  </div>
                </div>
              </div>
              {/* Preview */}
              {newLabelForm.name && (
                <div className="pt-2">
                  <label className="label">
                    <span className="label-text font-medium">Preview</span>
                  </label>
                  <span
                    className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold"
                    style={{
                      backgroundColor: `${newLabelForm.colour}20`,
                      color: newLabelForm.colour,
                    }}
                  >
                    <span className="w-2 h-2 rounded-full" style={{ backgroundColor: newLabelForm.colour }}></span>
                    {newLabelForm.name}
                  </span>
                </div>
              )}
            </div>
            <div className="flex justify-end gap-2 p-4 border-t border-slate-200">
              <button
                className="btn btn-ghost"
                onClick={() => {
                  setShowAddLabelModal(false);
                  setNewLabelForm({ name: "", colour: "#6366f1" });
                }}
              >
                Cancel
              </button>
              <button
                className="btn btn-primary"
                onClick={createLabel}
                disabled={!newLabelForm.name.trim()}
              >
                Create Label
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Job Sheet Share Modal */}
      {showJobSheetModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div className="flex items-center justify-between p-4 border-b border-slate-200">
              <h3 className="text-lg font-bold text-slate-900">Share Job Sheet</h3>
              <button
                onClick={() => {
                  setShowJobSheetModal(false);
                  setJobSheetLink(null);
                }}
                className="btn btn-ghost btn-sm btn-circle"
              >
                ‚úï
              </button>
            </div>
            <div className="p-4">
              {isGeneratingJobSheet ? (
                <div className="flex flex-col items-center py-8">
                  <div className="w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3"></div>
                  <p className="text-slate-600">Generating share link...</p>
                </div>
              ) : jobSheetLink ? (
                <div className="space-y-4">
                  <div className="bg-slate-50 rounded-lg p-3">
                    <p className="text-xs text-slate-500 mb-1">Shareable Link</p>
                    <p className="text-sm font-mono text-slate-900 break-all">{jobSheetLink}</p>
                  </div>
                  <p className="text-xs text-slate-500">
                    This link expires in 60 days. Anyone with this link can view the job sheet.
                  </p>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={copyJobSheetLink}
                      className="btn btn-outline btn-sm gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      Copy Link
                    </button>
                    <button
                      onClick={shareViaWhatsApp}
                      className="btn btn-success btn-sm gap-2 text-white"
                    >
                      <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                      </svg>
                      WhatsApp
                    </button>
                    <button
                      onClick={() => {
                        const subject = `Job Sheet - ${selectedVehicle?.regCurrent || 'Vehicle'}`;
                        const body = `Here is the job sheet for ${selectedVehicle?.regCurrent || 'the vehicle'}:\n\n${jobSheetLink}`;
                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
                      }}
                      className="btn btn-outline btn-sm gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                      Email
                    </button>
                    <button
                      onClick={() => window.open(jobSheetLink, '_blank')}
                      className="btn btn-outline btn-sm gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                      </svg>
                      Print / PDF
                    </button>
                  </div>
                </div>
              ) : (
                <div className="text-center py-8 text-slate-500">
                  No link generated yet
                </div>
              )}
            </div>
            <div className="flex justify-end p-4 border-t border-slate-200">
              <button
                className="btn btn-ghost"
                onClick={() => {
                  setShowJobSheetModal(false);
                  setJobSheetLink(null);
                }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Prep Summary Share Modal */}
      {showPrepSummaryModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div className="flex items-center justify-between p-4 border-b border-slate-200">
              <h3 className="text-lg font-bold text-slate-900">Prep Summary PDF</h3>
              <button
                onClick={() => {
                  setShowPrepSummaryModal(false);
                  setPrepSummaryLink(null);
                }}
                className="btn btn-ghost btn-sm btn-circle"
              >
                ‚úï
              </button>
            </div>
            <div className="p-4">
              {isGeneratingPrepSummary ? (
                <div className="flex flex-col items-center py-8">
                  <div className="w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3"></div>
                  <p className="text-slate-600">Generating prep summary...</p>
                </div>
              ) : prepSummaryLink ? (
                <div className="space-y-4">
                  <div className="bg-slate-50 rounded-lg p-3">
                    <p className="text-xs text-slate-500 mb-1">Shareable Link</p>
                    <p className="text-sm font-mono text-slate-900 break-all">{prepSummaryLink.url}</p>
                  </div>
                  <p className="text-xs text-slate-500">
                    This link expires in 60 days. Click Print/PDF to save a PDF of the prep summary.
                  </p>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={copyPrepSummaryLink}
                      className="btn btn-outline btn-sm gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      Copy Link
                    </button>
                    <button
                      onClick={sharePrepSummaryViaWhatsApp}
                      className="btn btn-success btn-sm gap-2 text-white"
                    >
                      <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                      </svg>
                      WhatsApp
                    </button>
                    <button
                      onClick={() => {
                        const subject = `Prep Summary - ${selectedVehicle?.regCurrent || 'Vehicle'}`;
                        const body = `Here is the prep summary for ${selectedVehicle?.regCurrent || 'the vehicle'}:\n\n${prepSummaryLink.url}`;
                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
                      }}
                      className="btn btn-outline btn-sm gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                      Email
                    </button>
                    <button
                      onClick={() => window.open(prepSummaryLink.url, '_blank')}
                      className="btn btn-primary btn-sm gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                      </svg>
                      Print / PDF
                    </button>
                  </div>
                </div>
              ) : (
                <div className="text-center py-8 text-slate-500">
                  No link generated yet
                </div>
              )}
            </div>
            <div className="flex justify-end p-4 border-t border-slate-200">
              <button
                className="btn btn-ghost"
                onClick={() => {
                  setShowPrepSummaryModal(false);
                  setPrepSummaryLink(null);
                }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Manual Share Fallback Modal */}
      {showManualShareModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
            <div className="flex items-center justify-between p-4 border-b border-slate-200">
              <h3 className="text-lg font-bold text-slate-900">Share Link</h3>
              <button
                onClick={() => {
                  setShowManualShareModal(false);
                  setManualShareUrl("");
                }}
                className="btn btn-ghost btn-sm btn-circle"
              >
                ‚úï
              </button>
            </div>
            <div className="p-4 space-y-4">
              <p className="text-sm text-slate-600">
                Copy the link below to share:
              </p>
              <div className="bg-slate-50 rounded-lg p-3 relative">
                <input
                  type="text"
                  value={manualShareUrl}
                  readOnly
                  className="w-full bg-transparent text-sm font-mono text-slate-900 border-none focus:outline-none pr-10"
                  onClick={(e) => e.target.select()}
                />
                <button
                  onClick={async () => {
                    try {
                      await navigator.clipboard.writeText(manualShareUrl);
                      toast.success("Link copied!");
                    } catch {
                      // If clipboard still fails, user can manually copy
                      toast.info("Select and copy the link manually");
                    }
                  }}
                  className="absolute right-2 top-1/2 -translate-y-1/2 p-2 hover:bg-slate-200 rounded transition-colors"
                  title="Copy to clipboard"
                >
                  <svg className="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                  </svg>
                </button>
              </div>
              <p className="text-xs text-slate-500">
                Click the link to select it, then use Ctrl+C (or Cmd+C on Mac) to copy.
              </p>
            </div>
            <div className="flex justify-end p-4 border-t border-slate-200">
              <button
                className="btn btn-primary"
                onClick={() => {
                  setShowManualShareModal(false);
                  setManualShareUrl("");
                }}
              >
                Done
              </button>
            </div>
          </div>
        </div>
      )}
    </DashboardLayout>
  );
}

function AddVehicleModal({ onClose, onSuccess }) {
  const [isLoading, setIsLoading] = useState(false);
  const [isLookingUp, setIsLookingUp] = useState(false);
  const [locations, setLocations] = useState([]);
  const [prepTemplates, setPrepTemplates] = useState([]);
  const [formData, setFormData] = useState({
    regCurrent: "", make: "", model: "", year: "", mileageCurrent: "",
    fuelType: "", transmission: "", colour: "", notes: "", locationId: "",
    motExpiryDate: "", // MOT expiry date (autofilled from lookup or manual entry)
    engineCapacity: "", // Engine capacity in cc (autofilled from lookup or manual entry)
    type: "STOCK", // STOCK, COURTESY, FLEET_OTHER
    saleType: "RETAIL", // RETAIL, TRADE - only used when type is STOCK
    dvlaDetails: null, // DVLA VES extended details
    lastDvlaFetchAt: null, // When DVLA lookup was performed
  });

  // Appraisal lookup state
  const [matchedAppraisal, setMatchedAppraisal] = useState(null);
  const [isCheckingAppraisal, setIsCheckingAppraisal] = useState(false);
  const [appraisalDismissed, setAppraisalDismissed] = useState(false);

  // VRM appraisal suggestions
  const [appraisalSuggestions, setAppraisalSuggestions] = useState([]);
  const [showAppraisalDropdown, setShowAppraisalDropdown] = useState(false);
  const [isSearchingAppraisals, setIsSearchingAppraisals] = useState(false);

  // Document uploads
  const [v5File, setV5File] = useState(null);
  const [serviceHistoryFile, setServiceHistoryFile] = useState(null);
  const [faultCodesFile, setFaultCodesFile] = useState(null);
  const [otherDocuments, setOtherDocuments] = useState([]);

  // Initial issues (array of issues to create with the vehicle)
  const [initialIssues, setInitialIssues] = useState([]);
  const [showAddIssueInVehicleModal, setShowAddIssueInVehicleModal] = useState(false);
  const [newIssueForm, setNewIssueForm] = useState({
    category: "",
    subcategory: "",
    description: "",
    actionNeeded: "",
    status: "Outstanding",
    notes: "",
    photos: [],
  });

  // Prep checklist template
  const [selectedTemplate, setSelectedTemplate] = useState("default");

  useEffect(() => {
    fetchLocations();
    fetchPrepTemplates();
  }, []);

  const fetchLocations = async () => {
    try {
      const res = await fetch("/api/locations");
      const data = await res.json();
      setLocations(data);
    } catch (error) {
      console.error("Failed to fetch locations");
    }
  };

  const fetchPrepTemplates = async () => {
    try {
      const res = await fetch("/api/prep-tasks");
      const data = await res.json();
      setPrepTemplates(data);
      // Auto-select first template if available
      if (data.length > 0) setSelectedTemplate("default");
    } catch (error) {
      console.error("Failed to fetch prep templates");
    }
  };

  // Search unconverted appraisals as user types VRM
  const searchAppraisals = async (vrm) => {
    if (!vrm || vrm.length < 2) {
      setAppraisalSuggestions([]);
      setShowAppraisalDropdown(false);
      return;
    }
    setIsSearchingAppraisals(true);
    try {
      const res = await fetch(`/api/appraisals/search-unconverted?q=${encodeURIComponent(vrm)}`);
      if (res.ok) {
        const results = await res.json();
        setAppraisalSuggestions(results);
        setShowAppraisalDropdown(results.length > 0);
      } else {
        setAppraisalSuggestions([]);
        setShowAppraisalDropdown(false);
      }
    } catch (error) {
      setAppraisalSuggestions([]);
      setShowAppraisalDropdown(false);
    } finally {
      setIsSearchingAppraisals(false);
    }
  };

  // Handle selecting an appraisal from suggestions
  const handleSelectAppraisalSuggestion = (appraisal) => {
    setFormData(prev => ({
      ...prev,
      regCurrent: appraisal.vehicleReg || prev.regCurrent,
      make: appraisal.vehicleMake || prev.make,
      model: appraisal.vehicleModel || prev.model,
      year: appraisal.vehicleYear || prev.year,
      mileageCurrent: appraisal.mileage || prev.mileageCurrent,
    }));
    setMatchedAppraisal(appraisal);
    setAppraisalDismissed(false);
    setShowAppraisalDropdown(false);
    setAppraisalSuggestions([]);
    toast.success(`Loaded appraisal for ${appraisal.vehicleReg}`);
  };

  // Check for existing appraisal when VRM changes
  const checkForAppraisal = async (vrm) => {
    if (!vrm || vrm.length < 2) {
      setMatchedAppraisal(null);
      return;
    }
    setIsCheckingAppraisal(true);
    try {
      const res = await fetch(`/api/appraisals/by-vrm?vrm=${encodeURIComponent(vrm)}`);
      if (res.ok) {
        const appraisal = await res.json();
        setMatchedAppraisal(appraisal);
        setAppraisalDismissed(false);
      } else {
        setMatchedAppraisal(null);
      }
    } catch (error) {
      setMatchedAppraisal(null);
    } finally {
      setIsCheckingAppraisal(false);
    }
  };

  // Import data from matched appraisal
  const importFromAppraisal = () => {
    if (!matchedAppraisal) return;
    setFormData(prev => ({
      ...prev,
      regCurrent: matchedAppraisal.vehicleReg || prev.regCurrent,
      make: matchedAppraisal.vehicleMake || prev.make,
      model: matchedAppraisal.vehicleModel || prev.model,
      year: matchedAppraisal.vehicleYear || prev.year,
      mileageCurrent: matchedAppraisal.mileage || prev.mileageCurrent,
      notes: matchedAppraisal.conditionNotes || prev.notes,
    }));
    setAppraisalDismissed(true);
    toast.success("Imported data from appraisal");
  };

  // Convert appraisal directly to stock (uses the convert API)
  const convertAppraisalToStock = async () => {
    if (!matchedAppraisal) return;
    setIsLoading(true);
    try {
      // Determine the API endpoint based on appraisal type
      const endpoint = matchedAppraisal.type === "customer_px"
        ? `/api/customer-px/${matchedAppraisal.id}/convert`
        : `/api/appraisals/${matchedAppraisal.id}/convert`;

      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initialStatus: "in_stock" }),
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || "Failed to convert appraisal");
      }

      toast.success("Appraisal converted to stock!");
      onSuccess();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setIsLoading(false);
    }
  };

  const handleLookup = async () => {
    if (!formData.regCurrent) return toast.error("Enter registration first");
    setIsLookingUp(true);
    try {
      const res = await fetch("/api/dvla-lookup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ vehicleReg: formData.regCurrent }),
      });
      const data = await res.json();

      // Check for error response
      if (!res.ok || data.error) {
        toast.error(data.message || data.error || "Vehicle not found");
        return;
      }

      if (data.isDummy) showDummyNotification("DVLA API");

      // Update form with DVLA data
      setFormData(prev => ({
        ...prev,
        make: data.make || prev.make,
        model: data.model || prev.model,
        year: data.yearOfManufacture || data.year || prev.year,
        colour: data.colour || prev.colour,
        fuelType: data.fuelType || prev.fuelType,
        transmission: data.transmission || prev.transmission,
        motExpiryDate: data.motExpiryDate || prev.motExpiryDate,
        // Engine capacity from DVLA (in cc)
        engineCapacity: data.engineCapacity || data.dvlaDetails?.engineCapacity || prev.engineCapacity,
        // Store full DVLA details for API persistence
        dvlaDetails: data.dvlaDetails || null,
        lastDvlaFetchAt: data.lastDvlaFetchAt || null,
      }));

      toast.success(`Found: ${data.make} ${data.model || ""} (${data.yearOfManufacture || ""})`);
    } catch (error) {
      toast.error("Lookup failed - please try again");
    } finally {
      setIsLookingUp(false);
    }
  };

  const uploadFile = async (file) => {
    if (!file) return null;
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch("/api/vehicles/upload", {
      method: "POST",
      body: formData,
    });
    if (!res.ok) throw new Error("Upload failed");
    const data = await res.json();
    // Store S3 key (permanent) if available, otherwise use URL (for local dev)
    return data.key || data.url;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!formData.regCurrent || !formData.make || !formData.model) {
      return toast.error("Reg, make and model are required");
    }
    setIsLoading(true);
    try {
      // Create vehicle first
      // If "None" is selected, skip default tasks
      // If "default" is selected, create default tasks (don't skip)
      const skipDefault = selectedTemplate === "";
      const vehicleRes = await fetch("/api/vehicles", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...formData, skipDefaultTasks: skipDefault }),
      });
      if (!vehicleRes.ok) {
        const errorData = await vehicleRes.json();
        throw new Error(errorData.error || "Failed to create vehicle");
      }
      const vehicle = await vehicleRes.json();

      // Upload documents
      if (v5File) {
        const v5Url = await uploadFile(v5File);
        await fetch(`/api/vehicles/${vehicle.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ v5Url }),
        });
      }

      if (serviceHistoryFile) {
        const url = await uploadFile(serviceHistoryFile);
        await fetch(`/api/vehicles/${vehicle.id}/documents`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: "Service History", type: "service_history", url }),
        });
      }

      if (faultCodesFile) {
        const url = await uploadFile(faultCodesFile);
        await fetch(`/api/vehicles/${vehicle.id}/documents`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: "Fault Codes", type: "fault_codes", url }),
        });
      }

      // Upload other documents
      for (const doc of otherDocuments) {
        if (doc.file) {
          const url = await uploadFile(doc.file);
          await fetch(`/api/vehicles/${vehicle.id}/documents`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: doc.name || "Document", type: "other", url }),
          });
        }
      }

      // Create initial issues from the array
      for (const issue of initialIssues) {
        await fetch(`/api/vehicles/${vehicle.id}/issues`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: issue.category,
            subcategory: issue.subcategory,
            description: issue.description,
            actionNeeded: issue.actionNeeded,
            status: issue.status || "Outstanding",
            notes: issue.notes,
          }),
        });
      }

      // Create prep tasks based on template
      // Only create from prepTemplates if a custom template is selected (not "default" which is handled by API)
      if (selectedTemplate && selectedTemplate !== "default" && prepTemplates.length > 0) {
        for (const template of prepTemplates) {
          await fetch(`/api/vehicles/${vehicle.id}/tasks`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: template.name }),
          });
        }
      }

      // Link appraisal to vehicle if one was matched
      if (matchedAppraisal && matchedAppraisal.id) {
        await fetch(`/api/appraisals/${matchedAppraisal.id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            decision: "converted",
            vehicleId: vehicle.id,
            decidedAt: new Date(),
          }),
        });
      }

      toast.success("Vehicle added!");
      onSuccess();
    } catch (error) {
      console.error("Error:", error);
      toast.error(error.message);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box max-w-4xl max-h-[90vh] overflow-y-auto bg-white">
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-xl font-bold text-slate-900">Add Vehicle</h3>
          <button
            type="button"
            onClick={onClose}
            className="p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form onSubmit={handleSubmit}>
          {/* Vehicle Details Section */}
          <div className="mb-6 pb-6 border-b border-slate-100">
            <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Vehicle Details</h4>
            <div className="relative flex gap-2 mb-4">
              <div className="relative flex-1">
                <input
                  type="text"
                  placeholder="Registration"
                  className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg uppercase font-mono text-slate-900 placeholder-slate-400 focus:bg-white focus:border-transparent focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
                  value={formData.regCurrent}
                  onChange={(e) => {
                    const newValue = e.target.value.toUpperCase();
                    setFormData({ ...formData, regCurrent: newValue });
                    searchAppraisals(newValue);
                  }}
                  onFocus={() => {
                    if (appraisalSuggestions.length > 0) setShowAppraisalDropdown(true);
                  }}
                  onBlur={(e) => {
                    // Delay hiding dropdown so click on suggestion can register
                    setTimeout(() => setShowAppraisalDropdown(false), 200);
                    checkForAppraisal(e.target.value);
                  }}
                />
                {isSearchingAppraisals && (
                  <span className="absolute right-3 top-1/2 -translate-y-1/2 loading loading-spinner loading-sm"></span>
                )}
                {/* Appraisal Suggestions Dropdown */}
                {showAppraisalDropdown && appraisalSuggestions.length > 0 && (
                  <div className="absolute top-full left-0 right-0 z-50 mt-1 bg-base-100 border border-base-300 rounded-lg shadow-xl max-h-64 overflow-y-auto">
                    <div className="px-3 py-2 text-xs text-base-content/60 border-b border-base-200 bg-base-200/50">
                      Unconverted Appraisals
                    </div>
                    {appraisalSuggestions.map((appraisal) => (
                      <button
                        key={appraisal.id}
                        type="button"
                        className="w-full px-3 py-2 text-left hover:bg-base-200 border-b border-base-200 last:border-b-0 flex items-center gap-3"
                        onClick={() => handleSelectAppraisalSuggestion(appraisal)}
                      >
                        <div className="flex-1">
                          <div className="font-mono font-bold">{appraisal.vehicleReg}</div>
                          <div className="text-sm text-base-content/70">
                            {appraisal.vehicleMake} {appraisal.vehicleModel} {appraisal.vehicleYear ? `(${appraisal.vehicleYear})` : ""}
                          </div>
                        </div>
                        <span className={`badge badge-sm ${appraisal.type === "dealer" ? "badge-primary" : "badge-secondary"}`}>
                          {appraisal.type === "dealer" ? "Dealer" : "Customer PX"}
                        </span>
                      </button>
                    ))}
                  </div>
                )}
              </div>
              <button
                type="button"
                className="px-5 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-lg transition-all duration-200 disabled:opacity-50 flex items-center gap-2"
                onClick={handleLookup}
                disabled={isLookingUp}
              >
                {isLookingUp ? <span className="loading loading-spinner loading-sm"></span> : <><span>üîç</span><span>Lookup</span></>}
              </button>
            </div>

            {/* Appraisal Match Alert */}
            {isCheckingAppraisal && (
              <div className="alert mb-4">
                <span className="loading loading-spinner loading-sm"></span>
                <span>Checking for existing appraisals...</span>
              </div>
            )}
            {matchedAppraisal && !appraisalDismissed && (
              <div className="alert alert-success mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div className="flex-1">
                  <p className="font-semibold">
                    {matchedAppraisal.type === "customer_px" ? "Customer PX" : "Dealer"} Appraisal Found: {matchedAppraisal.vehicleReg}
                  </p>
                  <p className="text-sm opacity-80">
                    {matchedAppraisal.vehicleMake} {matchedAppraisal.vehicleModel} {matchedAppraisal.vehicleYear ? `(${matchedAppraisal.vehicleYear})` : ""}
                    {matchedAppraisal.mileage ? ` ‚Ä¢ ${matchedAppraisal.mileage.toLocaleString()} miles` : ""}
                  </p>
                </div>
                <div className="flex flex-col sm:flex-row gap-2">
                  <button type="button" className="btn btn-sm btn-primary" onClick={convertAppraisalToStock} disabled={isLoading}>
                    {isLoading ? <span className="loading loading-spinner loading-sm"></span> : "Convert to Stock"}
                  </button>
                  <button type="button" className="btn btn-sm btn-ghost" onClick={importFromAppraisal}>
                    Import Data Only
                  </button>
                  <button type="button" className="btn btn-sm btn-ghost" onClick={() => setAppraisalDismissed(true)}>
                    Dismiss
                  </button>
                </div>
              </div>
            )}

            <div className="grid grid-cols-2 gap-4">
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Make *</label>
                <input type="text" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.make}
                  onChange={(e) => setFormData({ ...formData, make: e.target.value })} required />
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Model *</label>
                <input type="text" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.model}
                  onChange={(e) => setFormData({ ...formData, model: e.target.value })} required />
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Year</label>
                <input type="number" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.year}
                  onChange={(e) => setFormData({ ...formData, year: e.target.value })} />
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Mileage</label>
                <input type="number" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.mileageCurrent}
                  onChange={(e) => setFormData({ ...formData, mileageCurrent: e.target.value })} />
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Colour</label>
                <input type="text" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" value={formData.colour}
                  onChange={(e) => setFormData({ ...formData, colour: e.target.value })} />
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Fuel Type</label>
                <select className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer" value={formData.fuelType?.toUpperCase() || ""}
                  onChange={(e) => setFormData({ ...formData, fuelType: e.target.value })}>
                  <option value="">Select...</option>
                  <option value="PETROL">Petrol</option>
                  <option value="DIESEL">Diesel</option>
                  <option value="HYBRID">Hybrid</option>
                  <option value="ELECTRIC">Electric</option>
                  <option value="LPG">LPG</option>
                  <option value="CNG">CNG</option>
                </select>
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">MOT Expiry Date</label>
                <input
                  type="date"
                  className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
                  value={formData.motExpiryDate ? formData.motExpiryDate.split("T")[0] : ""}
                  onChange={(e) => setFormData({ ...formData, motExpiryDate: e.target.value })}
                />
                <p className="text-xs text-slate-400 mt-1.5">
                  {formData.motExpiryDate ? "" : "Auto-filled by VRM lookup or enter manually"}
                </p>
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Transmission</label>
                <select className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer" value={formData.transmission?.toUpperCase() || ""}
                  onChange={(e) => setFormData({ ...formData, transmission: e.target.value })}>
                  <option value="">Select...</option>
                  <option value="MANUAL">Manual</option>
                  <option value="AUTOMATIC">Automatic</option>
                  <option value="SEMI-AUTO">Semi-Auto</option>
                  <option value="CVT">CVT</option>
                </select>
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Engine Capacity (cc)</label>
                <input
                  type="number"
                  className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
                  placeholder="e.g., 1500"
                  value={formData.engineCapacity || ""}
                  onChange={(e) => setFormData({ ...formData, engineCapacity: e.target.value })}
                />
                <p className="text-xs text-slate-400 mt-1.5">
                  {formData.engineCapacity ? "" : "Auto-filled by VRM lookup"}
                </p>
              </div>
            </div>
          </div>

          {/* Vehicle Type Section */}
          <div className="mb-6 pb-6 border-b border-slate-100">
            <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Vehicle Type</h4>
            <div className="grid grid-cols-2 gap-4">
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Vehicle Type</label>
                <select
                  className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer"
                  value={formData.type}
                  onChange={(e) => {
                    const newType = e.target.value;
                    setFormData({
                      ...formData,
                      type: newType,
                      // Clear saleType if not Stock
                      saleType: newType === "STOCK" ? (formData.saleType || "RETAIL") : undefined
                    });
                  }}
                >
                  <option value="STOCK">Stock - For sale</option>
                  <option value="COURTESY">Courtesy - Loan vehicle</option>
                  <option value="FLEET_OTHER">Fleet/Other - Company vehicle</option>
                </select>
              </div>
              {/* Sale Type - Only show for Stock vehicles */}
              {formData.type === "STOCK" && (
                <div className="form-control">
                  <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Sale Type</label>
                  <select
                    className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer"
                    value={formData.saleType || "RETAIL"}
                    onChange={(e) => setFormData({ ...formData, saleType: e.target.value })}
                  >
                    <option value="RETAIL">Retail - Customer sale</option>
                    <option value="TRADE">Trade - Dealer sale</option>
                  </select>
                </div>
              )}
            </div>
            <p className="text-xs text-slate-400 mt-3">
              {formData.type === "COURTESY" && "This vehicle will be available in courtesy car forms"}
              {formData.type === "FLEET_OTHER" && "This vehicle will not appear in sales board"}
              {formData.type === "STOCK" && formData.saleType === "TRADE" && "Trade vehicles are marked separately and can be filtered"}
              {formData.type === "STOCK" && formData.saleType !== "TRADE" && "This vehicle will go through the normal sales prep flow"}
            </p>
          </div>

          {/* Location Section */}
          <div className="mb-6 pb-6 border-b border-slate-100">
            <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Location</h4>
            <div className="form-control">
              <select
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer"
                value={formData.locationId}
                onChange={(e) => setFormData({ ...formData, locationId: e.target.value })}
              >
                <option value="">On Site</option>
                {locations.map(loc => (
                  <option key={loc.id} value={loc.id}>{loc.name}</option>
                ))}
              </select>
            </div>
          </div>

          {/* Document Uploads Section */}
          <div className="mb-6 pb-6 border-b border-slate-100">
            <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Document Uploads (Optional)</h4>
            <div className="space-y-4">
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">V5 Document</label>
                <input type="file" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" accept="image/*,.pdf"
                  onChange={(e) => setV5File(e.target.files[0])} />
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Service History</label>
                <input type="file" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" accept="image/*,.pdf"
                  onChange={(e) => setServiceHistoryFile(e.target.files[0])} />
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Fault Codes</label>
                <input type="file" className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none" accept="image/*,.pdf"
                  onChange={(e) => setFaultCodesFile(e.target.files[0])} />
              </div>
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Other Documents</label>
                <button
                  type="button"
                  className="px-4 py-2.5 bg-slate-50 border border-slate-200 hover:border-slate-300 hover:bg-slate-100 text-slate-700 text-sm font-medium rounded-lg transition-all duration-200"
                  onClick={() => setOtherDocuments([...otherDocuments, { name: "", file: null }])}
                >
                  + Add Document/Image
                </button>
                {otherDocuments.map((doc, idx) => (
                  <div key={idx} className="flex gap-2 mt-3">
                    <input
                      type="text"
                      placeholder="Document name"
                      className="flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 text-sm placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
                      value={doc.name}
                      onChange={(e) => {
                        const updated = [...otherDocuments];
                        updated[idx].name = e.target.value;
                        setOtherDocuments(updated);
                      }}
                    />
                    <input
                      type="file"
                      className="flex-1 px-3 py-2 bg-slate-50 border border-transparent rounded-lg text-slate-900 text-sm file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium file:text-xs hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] transition-all duration-200 outline-none"
                      onChange={(e) => {
                        const updated = [...otherDocuments];
                        updated[idx].file = e.target.files[0];
                        setOtherDocuments(updated);
                      }}
                    />
                    <button
                      type="button"
                      className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all duration-200"
                      onClick={() => setOtherDocuments(otherDocuments.filter((_, i) => i !== idx))}
                    >
                      ‚úï
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Initial Issues Section */}
          <div className="mb-6 pb-6 border-b border-slate-100">
            <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Initial Issues (Optional)</h4>

            {/* Add Issue Button */}
            <button
              type="button"
              className="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 hover:border-slate-300 hover:bg-slate-100 text-slate-700 text-sm font-medium rounded-lg transition-all duration-200 mb-3"
              onClick={() => setShowAddIssueInVehicleModal(true)}
            >
              + Add Issue
            </button>

            {/* Issue Summary Cards */}
            {initialIssues.length > 0 && (
              <div className="space-y-2">
                {initialIssues.map((issue, index) => (
                  <div key={index} className="card bg-base-200">
                    <div className="card-body p-3">
                      <div className="flex justify-between items-start gap-2">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="badge badge-sm">{issue.category}</span>
                            {issue.subcategory && (
                              <span className="badge badge-sm badge-ghost">{issue.subcategory}</span>
                            )}
                          </div>
                          <p className="text-sm font-medium truncate">{issue.description}</p>
                          {issue.actionNeeded && (
                            <p className="text-xs text-base-content/60 mt-1">Action: {issue.actionNeeded}</p>
                          )}
                        </div>
                        <button
                          type="button"
                          className="btn btn-ghost btn-xs text-error"
                          onClick={() => {
                            setInitialIssues(initialIssues.filter((_, i) => i !== index));
                          }}
                        >
                          ‚úï
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Prep Checklist Template Section */}
          <div className="mb-6 pb-6 border-b border-slate-100">
            <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4">Prep Checklist Template</h4>
            <div className="form-control">
              <select
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer"
                value={selectedTemplate}
                onChange={(e) => setSelectedTemplate(e.target.value)}
              >
                <option value="">None - add tasks manually</option>
                <option value="default">Standard Prep (5 tasks)</option>
              </select>
            </div>

            {/* Task Preview for Standard Prep */}
            {selectedTemplate === "default" && (
              <div className="mt-3 p-4 bg-slate-50 rounded-lg border border-slate-100">
                <p className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Tasks included:</p>
                <div className="text-sm text-slate-600 space-y-2">
                  {["PDI", "Valet", "Photos", "MOT Check", "Advert"].map((task, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <span className="text-[#0066CC]">‚úì</span>
                      <span>{task}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Notes Section */}
          <div className="mb-8">
            <div className="form-control">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Additional Notes</label>
              <textarea
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none"
                rows={4}
                value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
              ></textarea>
            </div>
          </div>

          <div className="flex items-center justify-end gap-3 pt-4 border-t border-slate-100">
            <button
              type="button"
              className="px-5 py-2.5 border border-slate-200 text-slate-600 hover:text-slate-800 hover:border-slate-300 hover:bg-slate-50 font-medium rounded-lg transition-all duration-200"
              onClick={onClose}
            >
              Cancel
            </button>
            <button
              type="submit"
              className="px-6 py-2.5 bg-[#0066CC] hover:bg-[#0055BB] text-white font-medium rounded-lg shadow-sm hover:shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
              disabled={isLoading}
            >
              {isLoading ? <><span className="loading loading-spinner loading-sm"></span><span>Saving...</span></> : "Add Vehicle"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>

      {/* Nested Add Issue Modal */}
      {showAddIssueInVehicleModal && (
        <AddIssueModal
          issueForm={newIssueForm}
          setIssueForm={setNewIssueForm}
          onClose={() => {
            setShowAddIssueInVehicleModal(false);
            setNewIssueForm({
              category: "",
              subcategory: "",
              description: "",
              actionNeeded: "",
              status: "Outstanding",
              notes: "",
              photos: [],
            });
          }}
          onSubmit={() => {
            // Validate required fields
            if (!newIssueForm.category || !newIssueForm.subcategory || !newIssueForm.description) {
              return toast.error("Category, subcategory, and description are required");
            }

            // Add issue to the array
            setInitialIssues([...initialIssues, { ...newIssueForm }]);

            // Close modal and reset form
            setShowAddIssueInVehicleModal(false);
            setNewIssueForm({
              category: "",
              subcategory: "",
              description: "",
              actionNeeded: "",
              status: "Outstanding",
              notes: "",
              photos: [],
            });
            toast.success("Issue added");
          }}
        />
      )}
    </div>
  );
}

function AddIssueModal({ issueForm, setIssueForm, onClose, onSubmit, isEditing = false }) {
  const [isLoading, setIsLoading] = useState(false);
  const [photoFiles, setPhotoFiles] = useState([]);
  const [photoPreviews, setPhotoPreviews] = useState([]);
  const [isUploadingPhotos, setIsUploadingPhotos] = useState(false);

  const handlePhotoChange = (e) => {
    const files = Array.from(e.target.files);
    setPhotoFiles(prev => [...prev, ...files]);

    // Create previews
    files.forEach(file => {
      const reader = new FileReader();
      reader.onloadend = () => {
        setPhotoPreviews(prev => [...prev, reader.result]);
      };
      reader.readAsDataURL(file);
    });
  };

  const removePhoto = (index) => {
    setPhotoFiles(prev => prev.filter((_, i) => i !== index));
    setPhotoPreviews(prev => prev.filter((_, i) => i !== index));
  };

  const uploadPhotos = async () => {
    const uploadedUrls = [];
    for (const file of photoFiles) {
      const formData = new FormData();
      formData.append("file", file);
      const res = await fetch("/api/vehicles/upload", {
        method: "POST",
        body: formData,
      });
      if (res.ok) {
        const data = await res.json();
        // Store S3 key (permanent) if available, otherwise use URL (for local dev)
        uploadedUrls.push(data.key || data.url);
      }
    }
    return uploadedUrls;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    try {
      // Upload photos first if any
      let photoUrls = [];
      if (photoFiles.length > 0) {
        setIsUploadingPhotos(true);
        photoUrls = await uploadPhotos();
        setIsUploadingPhotos(false);
      }
      // Pass photo URLs/keys to onSubmit
      await onSubmit(photoUrls);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box max-w-2xl bg-white">
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-xl font-bold text-slate-900">{isEditing ? "Edit Issue" : "Add Issue"}</h3>
          <button
            type="button"
            onClick={onClose}
            className="p-2 rounded-lg text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form onSubmit={handleSubmit}>
          <div className="grid grid-cols-2 gap-4">
            <div className="form-control">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Category *</label>
              <select
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer"
                value={issueForm.category}
                onChange={(e) => {
                  setIssueForm({ ...issueForm, category: e.target.value, subcategory: "" });
                }}
                required
              >
                <option value="">Select category...</option>
                <option value="mechanical">Mechanical</option>
                <option value="electrical">Electrical</option>
                <option value="bodywork">Bodywork</option>
                <option value="interior">Interior</option>
                <option value="tyres">Tyres</option>
                <option value="mot">MOT</option>
                <option value="service">Service</option>
                <option value="fault_codes">Fault Codes</option>
                <option value="other">Other</option>
              </select>
            </div>

            {issueForm.category && (
              <div className="form-control">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Subcategory</label>
                <select
                  className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer"
                  value={issueForm.subcategory}
                  onChange={(e) => setIssueForm({ ...issueForm, subcategory: e.target.value })}
                >
                  <option value="">Select subcategory...</option>
                  {ISSUE_SUBCATEGORIES[issueForm.category]?.map((sub) => (
                    <option key={sub} value={sub}>{sub}</option>
                  ))}
                </select>
              </div>
            )}

            {/* Fault Codes field - only show for fault_codes category */}
            {issueForm.category === "fault_codes" && (
              <div className="form-control col-span-2">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Fault Codes</label>
                <input
                  type="text"
                  className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 font-mono placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
                  value={issueForm.faultCodes || ""}
                  onChange={(e) => setIssueForm({ ...issueForm, faultCodes: e.target.value })}
                  placeholder="e.g. P0301, P0420, C1234"
                />
                <p className="text-xs text-slate-400 mt-1.5">Enter codes separated by commas</p>
              </div>
            )}

            <div className="form-control col-span-2">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Description *</label>
              <textarea
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none"
                value={issueForm.description}
                onChange={(e) => setIssueForm({ ...issueForm, description: e.target.value })}
                placeholder={issueForm.category === "fault_codes" ? "Describe what the fault codes indicate..." : "Describe the issue..."}
                required
                rows="3"
              ></textarea>
            </div>

            <div className="form-control col-span-2">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Action Needed</label>
              <input
                type="text"
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
                value={issueForm.actionNeeded}
                onChange={(e) => setIssueForm({ ...issueForm, actionNeeded: e.target.value })}
                placeholder="What needs to be done?"
              />
            </div>

            <div className="form-control">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Priority</label>
              <select
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer"
                value={issueForm.priority || "medium"}
                onChange={(e) => setIssueForm({ ...issueForm, priority: e.target.value })}
              >
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>

            <div className="form-control">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Location</label>
              <input
                type="text"
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
                value={issueForm.location || ""}
                onChange={(e) => setIssueForm({ ...issueForm, location: e.target.value })}
                placeholder="e.g., Front Left, Rear Bumper"
              />
            </div>

            <div className="form-control">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Status</label>
              <select
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none appearance-none cursor-pointer"
                value={issueForm.status}
                onChange={(e) => setIssueForm({ ...issueForm, status: e.target.value })}
              >
                <option value="outstanding">Outstanding</option>
                <option value="ordered">Ordered</option>
                <option value="in_progress">In Progress</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>

            {/* Parts Required Section */}
            <div className="form-control flex items-center">
              <label className="flex items-center gap-3 cursor-pointer mt-6">
                <div className="relative">
                  <input
                    type="checkbox"
                    className="sr-only peer"
                    checked={issueForm.partsRequired || false}
                    onChange={(e) => setIssueForm({ ...issueForm, partsRequired: e.target.checked })}
                  />
                  <div className="w-5 h-5 rounded border-2 border-slate-300 peer-checked:border-[#0066CC] peer-checked:bg-[#0066CC] transition-all duration-200 flex items-center justify-center">
                    <svg className="w-3 h-3 text-white opacity-0 peer-checked:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                    </svg>
                  </div>
                </div>
                <span className="text-sm font-medium text-slate-700">Parts Required</span>
              </label>
            </div>

            {issueForm.partsRequired && (
              <div className="form-control col-span-2">
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Parts Details</label>
                <textarea
                  className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none"
                  value={issueForm.partsDetails || ""}
                  onChange={(e) => setIssueForm({ ...issueForm, partsDetails: e.target.value })}
                  placeholder="Supplier, part numbers, who ordered, ETA..."
                  rows="2"
                ></textarea>
              </div>
            )}

            <div className="form-control col-span-2">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Notes</label>
              <textarea
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 placeholder-slate-400 focus:bg-white focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none resize-none"
                value={issueForm.notes}
                onChange={(e) => setIssueForm({ ...issueForm, notes: e.target.value })}
                placeholder="Additional notes..."
                rows="2"
              ></textarea>
            </div>

            {/* Photo Upload */}
            <div className="form-control col-span-2">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Photos</label>
              <input
                type="file"
                accept="image/*"
                multiple
                onChange={handlePhotoChange}
                className="w-full px-4 py-3 bg-slate-50 border border-transparent rounded-lg text-slate-900 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#0066CC]/10 file:text-[#0066CC] file:font-medium hover:file:bg-[#0066CC]/20 focus:ring-2 focus:ring-[#0066CC] focus:shadow-sm transition-all duration-200 outline-none"
              />
              {photoPreviews.length > 0 && (
                <div className="flex flex-wrap gap-2 mt-3">
                  {photoPreviews.map((preview, idx) => (
                    <div key={idx} className="relative">
                      <img src={preview} alt={`Preview ${idx + 1}`} className="w-20 h-20 object-cover rounded-lg" />
                      <button
                        type="button"
                        onClick={() => removePhoto(idx)}
                        className="absolute -top-2 -right-2 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs flex items-center justify-center transition-colors"
                      >
                        ‚úï
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          <div className="flex items-center justify-end gap-3 pt-6 mt-6 border-t border-slate-100">
            <button
              type="button"
              className="px-5 py-2.5 border border-slate-200 text-slate-600 hover:text-slate-800 hover:border-slate-300 hover:bg-slate-50 font-medium rounded-lg transition-all duration-200"
              onClick={onClose}
            >
              Cancel
            </button>
            <button
              type="submit"
              className="px-6 py-2.5 bg-[#0066CC] hover:bg-[#0055BB] text-white font-medium rounded-lg shadow-sm hover:shadow transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
              disabled={isLoading || isUploadingPhotos}
            >
              {isLoading || isUploadingPhotos ? (
                <>
                  <span className="loading loading-spinner loading-sm"></span>
                  <span>{isUploadingPhotos ? "Uploading photos..." : "Saving..."}</span>
                </>
              ) : "Add Issue"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}

function AddDocumentModal({ documentForm, setDocumentForm, onClose, onSubmit }) {
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    try {
      await onSubmit();
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box">
        <h3 className="font-bold text-lg mb-4">Add Document/Image</h3>
        <form onSubmit={handleSubmit}>
          <div className="space-y-4">
            <div className="form-control">
              <label className="label"><span className="label-text">Document Type</span></label>
              <select
                className="select select-bordered"
                value={documentForm.type}
                onChange={(e) => setDocumentForm({ ...documentForm, type: e.target.value })}
              >
                <option value="v5">V5</option>
                <option value="service_history">Service History</option>
                <option value="fault_codes">Fault Codes</option>
                <option value="other">Other</option>
              </select>
            </div>

            {/* Only show Document Name field when "Other" is selected */}
            {documentForm.type === "other" && (
              <div className="form-control">
                <label className="label"><span className="label-text">Document Name *</span></label>
                <input
                  type="text"
                  className="input input-bordered"
                  value={documentForm.name}
                  onChange={(e) => setDocumentForm({ ...documentForm, name: e.target.value })}
                  placeholder="e.g., MOT Certificate, Insurance"
                  required
                />
              </div>
            )}

            <div className="form-control">
              <label className="label"><span className="label-text">File *</span></label>
              <input
                type="file"
                className="file-input file-input-bordered w-full"
                onChange={(e) => setDocumentForm({ ...documentForm, file: e.target.files[0] })}
                accept="image/*,.pdf,.doc,.docx"
                required
              />
            </div>
          </div>

          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
            <button type="submit" className="btn btn-primary" disabled={isLoading}>
              {isLoading ? <span className="loading loading-spinner"></span> : "Upload Document/Image"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}

function AddLocationModal({ onClose, onSuccess }) {
  const [name, setName] = useState("");
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!name.trim()) return toast.error("Location name is required");

    setIsLoading(true);
    try {
      const res = await fetch("/api/locations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name.trim(), type: "offsite" }),
      });
      if (!res.ok) throw new Error("Failed to create location");
      const newLocation = await res.json();
      toast.success("Location added");
      onSuccess(newLocation);
    } catch (error) {
      toast.error("Failed to add location");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box">
        <h3 className="font-bold text-lg mb-4">Add New Location</h3>
        <form onSubmit={handleSubmit}>
          <div className="form-control">
            <label className="label">
              <span className="label-text">Location Name *</span>
            </label>
            <input
              type="text"
              className="input input-bordered w-full"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g., ABC Body Shop, Paint Centre"
              required
              autoFocus
            />
          </div>
          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>
              Cancel
            </button>
            <button type="submit" className="btn btn-primary" disabled={isLoading}>
              {isLoading ? <span className="loading loading-spinner"></span> : "Add Location"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}
