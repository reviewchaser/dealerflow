import connectMongo from "@/libs/mongoose";
import AftercareCase from "@/models/AftercareCase";
import AftercareCaseComment from "@/models/AftercareCaseComment";
import Contact from "@/models/Contact";
import { withDealerContext } from "@/libs/authContext";

async function handler(req, res, ctx) {
  await connectMongo();
  const { dealerId } = ctx;

  if (req.method === "GET") {
    const { boardStatus, status } = req.query;
    let query = { dealerId };
    if (boardStatus && boardStatus !== "all") query.boardStatus = boardStatus;
    if (status && status !== "all") query.status = status;

    const cases = await AftercareCase.find(query)
      .populate("contactId")
      .populate("vehicleId")
      .populate("vehicleSaleId")
      .sort({ createdAt: -1 })
      .lean();

    return res.status(200).json(cases);
  }

  if (req.method === "POST") {
    const {
      customerName, customerEmail, customerPhone,
      vehicleReg, regAtPurchase, summary, details, source = "manual",
      priority = "normal"
    } = req.body;

    if (!customerName) {
      return res.status(400).json({ error: "Customer name required" });
    }

    // Create or find contact - scoped by dealer
    let contact = null;
    if (customerEmail || customerPhone) {
      const conditions = [];
      if (customerEmail) conditions.push({ email: customerEmail });
      if (customerPhone) conditions.push({ phone: customerPhone });
      contact = await Contact.findOne({ dealerId, $or: conditions });
    }

    if (!contact) {
      contact = await Contact.create({
        dealerId,
        name: customerName,
        email: customerEmail || undefined,
        phone: customerPhone || undefined,
      });
    }

    const aftercareCase = await AftercareCase.create({
      dealerId,
      contactId: contact._id,
      summary,
      details: { ...details, vehicleReg, regAtPurchase },
      source,
      priority,
      regAtPurchase,
      boardStatus: "not_booked_in",
      status: "new",
    });

    // Create initial comment with claim details
    if (summary || details) {
      await AftercareCaseComment.create({
        aftercareCaseId: aftercareCase._id,
        authorType: source === "warranty_claim_form" ? "customer" : "staff",
        content: summary || "Case created",
      });
    }

    const populated = await AftercareCase.findById(aftercareCase._id)
      .populate("contactId").lean();
    return res.status(201).json(populated);
  }

  return res.status(405).json({ error: "Method not allowed" });
}

export default withDealerContext(handler);
