/**
 * Migration API: Convert User.dealerId to DealerMembership
 *
 * POST /api/admin/run-migration
 *
 * This is a one-time migration endpoint. Delete after use.
 */

import connectMongo from "@/libs/mongoose";
import User from "@/models/User";
import Dealer from "@/models/Dealer";
import DealerMembership from "@/models/DealerMembership";

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  // Simple protection - require a secret key
  const { secret, deleteOrphanedDealers } = req.body;
  if (secret !== process.env.MIGRATION_SECRET && secret !== "run-migration-dev") {
    return res.status(403).json({ error: "Invalid secret" });
  }

  await connectMongo();

  const log = [];
  const addLog = (msg) => {
    console.log(msg);
    log.push(msg);
  };

  try {
    addLog("Starting membership migration...");

    // Get all dealers
    const dealers = await Dealer.find().lean();
    addLog(`Found ${dealers.length} dealer(s)`);

    let totalCreated = 0;
    let totalSkipped = 0;

    for (const dealer of dealers) {
      addLog(`Processing dealer: ${dealer.name} (${dealer._id})`);

      // Find all users linked to this dealer (sorted by createdAt)
      const users = await User.find({ dealerId: dealer._id })
        .sort({ createdAt: 1 })
        .lean();

      addLog(`  Found ${users.length} user(s) with dealerId`);

      // Check if dealer already has an owner
      const existingOwnerCount = await DealerMembership.countDocuments({
        dealerId: dealer._id,
        role: "OWNER",
        removedAt: null,
      });

      let isFirstOwnerAssigned = existingOwnerCount > 0;

      for (let i = 0; i < users.length; i++) {
        const user = users[i];

        // First user for this dealer becomes OWNER (if no owner exists)
        const role = !isFirstOwnerAssigned ? "OWNER" : "STAFF";

        // Use upsert for true idempotency - atomic operation
        // $setOnInsert ensures we only set fields on creation, not on update
        const result = await DealerMembership.updateOne(
          { dealerId: dealer._id, userId: user._id },
          {
            $setOnInsert: {
              dealerId: dealer._id,
              userId: user._id,
              role,
              lastActiveAt: new Date(),
            },
          },
          { upsert: true }
        );

        if (result.upsertedCount > 0) {
          addLog(`  Created: ${user.email || user.name} as ${role}`);
          totalCreated++;
          if (role === "OWNER") {
            isFirstOwnerAssigned = true;
          }
        } else {
          addLog(`  Skipped: ${user.email || user.name} (membership exists)`);
          totalSkipped++;
          // Check if existing membership is OWNER (for tracking)
          if (!isFirstOwnerAssigned) {
            const existing = await DealerMembership.findOne({
              dealerId: dealer._id,
              userId: user._id,
              role: "OWNER",
            });
            if (existing) isFirstOwnerAssigned = true;
          }
        }
      }

      // If dealer still has no owner after processing users, promote any member
      if (!isFirstOwnerAssigned) {
        const anyMembership = await DealerMembership.findOne({
          dealerId: dealer._id,
          removedAt: null,
        });

        if (anyMembership) {
          anyMembership.role = "OWNER";
          await anyMembership.save();
          addLog(`  Promoted existing member to OWNER`);
        } else {
          addLog(`  Warning: Dealer has no users/members!`);
        }
      }
    }

    addLog(`Summary: Created ${totalCreated}, Skipped ${totalSkipped}`);

    // Verify invariant: every dealer has at least one owner
    addLog("Verifying all dealers have at least one OWNER...");
    const dealersWithoutOwner = [];

    for (const dealer of dealers) {
      const ownerCount = await DealerMembership.countDocuments({
        dealerId: dealer._id,
        role: "OWNER",
        removedAt: null,
      });

      if (ownerCount === 0) {
        addLog(`  FAIL: ${dealer.name} has NO OWNER`);
        dealersWithoutOwner.push(dealer.name);
      } else {
        addLog(`  OK: ${dealer.name} has ${ownerCount} owner(s)`);
      }
    }

    // Handle dealers without owners
    if (dealersWithoutOwner.length > 0) {
      if (deleteOrphanedDealers) {
        // Delete orphaned dealers (dev only)
        for (const dealerName of dealersWithoutOwner) {
          const dealer = dealers.find(d => d.name === dealerName);
          if (dealer) {
            await Dealer.findByIdAndDelete(dealer._id);
            addLog(`  DELETED orphaned dealer: ${dealerName}`);
          }
        }
        addLog(`Deleted ${dealersWithoutOwner.length} orphaned dealer(s)`);
      } else {
        // ABORT - this is a critical invariant
        return res.status(500).json({
          success: false,
          error: `CRITICAL: ${dealersWithoutOwner.length} dealer(s) have no OWNER: ${dealersWithoutOwner.join(", ")}. Pass deleteOrphanedDealers:true to remove them.`,
          log,
        });
      }
    }

    addLog("Migration complete!");

    return res.status(200).json({
      success: true,
      created: totalCreated,
      skipped: totalSkipped,
      log,
    });
  } catch (error) {
    addLog(`Error: ${error.message}`);
    return res.status(500).json({
      success: false,
      error: error.message,
      log,
    });
  }
}
