// Tenant-aware Dashboard
// This page wraps the main dashboard with tenant context from URL

import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';
import Head from 'next/head';
import DashboardLayout from '@/components/DashboardLayout';
import StatsCard from '@/components/StatsCard';

// Re-use the same form type labels
const FORM_TYPE_LABELS = {
  PDI: "PDI",
  TEST_DRIVE: "Test Drive",
  WARRANTY_CLAIM: "Warranty Claim",
  COURTESY_OUT: "Courtesy Out",
  COURTESY_IN: "Courtesy In",
  SERVICE_RECEIPT: "Service",
  REVIEW_FEEDBACK: "Feedback",
  OTHER: "Other",
};

export default function TenantDashboard() {
  const router = useRouter();
  const { dealerSlug } = router.query;

  const [stats, setStats] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [dealer, setDealer] = useState(null);
  const [error, setError] = useState(null);

  useEffect(() => {
    if (!dealerSlug) return;

    const fetchData = async () => {
      try {
        // Verify dealer exists and user has access
        const dealerRes = await fetch(`/api/dealer?slug=${dealerSlug}`);
        if (!dealerRes.ok) {
          if (dealerRes.status === 404) {
            setError('Dealer not found');
          } else if (dealerRes.status === 403) {
            setError('You do not have access to this dealer');
          } else {
            setError('Failed to load dealer');
          }
          setIsLoading(false);
          return;
        }

        const dealerData = await dealerRes.json();
        setDealer(dealerData);

        // Fetch dashboard stats with tenant context
        const statsRes = await fetch(`/api/dashboard/stats?dealerSlug=${dealerSlug}`);
        if (statsRes.ok) {
          const statsData = await statsRes.json();
          setStats(statsData);
        }

        setIsLoading(false);
      } catch (err) {
        console.error('Error loading dashboard:', err);
        setError('Failed to load dashboard');
        setIsLoading(false);
      }
    };

    fetchData();
  }, [dealerSlug]);

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50">
        <div className="text-center">
          <h1 className="text-2xl font-bold text-slate-900 mb-2">Error</h1>
          <p className="text-slate-600">{error}</p>
          <button
            onClick={() => router.push('/dashboard')}
            className="mt-4 px-4 py-2 bg-[#0066CC] text-white rounded-lg hover:bg-[#0055BB]"
          >
            Go to Default Dashboard
          </button>
        </div>
      </div>
    );
  }

  return (
    <DashboardLayout dealerSlug={dealerSlug}>
      <Head>
        <title>Dashboard | {dealer?.name || 'DealerFlow'}</title>
      </Head>

      <div className="mb-8">
        <h1 className="text-3xl font-bold">Dashboard</h1>
        {dealer && (
          <p className="text-base-content/60 mt-1">{dealer.name}</p>
        )}
      </div>

      {isLoading ? (
        <div className="flex justify-center py-20">
          <span className="loading loading-spinner loading-lg"></span>
        </div>
      ) : (
        <>
          {/* Stats Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <StatsCard
              title="Stock Vehicles"
              value={stats?.stockCount || 0}
              icon="truck"
              color="primary"
            />
            <StatsCard
              title="Sold Awaiting Delivery"
              value={stats?.soldInProgressCount || 0}
              icon="clock"
              color="warning"
            />
            <StatsCard
              title="Active Warranty Cases"
              value={stats?.activeWarrantyCount || 0}
              icon="wrench"
              color="error"
            />
            <StatsCard
              title="Submissions This Week"
              value={stats?.submissionsThisWeek || 0}
              icon="document"
              color="success"
            />
          </div>

          {/* Placeholder for other dashboard sections */}
          <div className="alert alert-info">
            <span>
              You are viewing the tenant-specific dashboard for <strong>{dealerSlug}</strong>.
              All data shown is scoped to this dealer.
            </span>
          </div>
        </>
      )}
    </DashboardLayout>
  );
}
