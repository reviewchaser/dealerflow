import { useEffect, useState } from "react";
import Head from "next/head";
import Link from "next/link";
import { useRouter } from "next/router";
import DashboardLayout from "@/components/DashboardLayout";
import ShareFormModal from "@/components/ShareFormModal";
import { useSession } from "next-auth/react";
import { toast } from "react-hot-toast";

// Human-readable form type labels
const FORM_TYPE_LABELS = {
  PDI: "PDI",
  CAR_PREP: "Car Prep",
  TEST_DRIVE: "Test Drive",
  WARRANTY_CLAIM: "Warranty Claim",
  COURTESY_OUT: "Courtesy Car Out",
  COURTESY_IN: "Courtesy Car In",
  DELIVERY: "Delivery",
  SERVICE_RECEIPT: "Service Receipt",
  BUYING_APPRAISAL: "Buying Appraisal",
  CUSTOMER_PX_APPRAISAL: "Customer PX Appraisal",
  REVIEW_FEEDBACK: "Review & Feedback",
  OTHER: "Other",
};

// Time ago helper
const timeAgo = (date) => {
  const now = new Date();
  const then = new Date(date);
  const seconds = Math.floor((now - then) / 1000);

  if (seconds < 60) return "Just now";
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
  return then.toLocaleDateString();
};

export default function Forms() {
  const router = useRouter();
  const { data: session, status } = useSession();
  const [activeTab, setActiveTab] = useState(router.query.tab || "submissions");
  const [forms, setForms] = useState([]);
  const [filteredForms, setFilteredForms] = useState([]);
  const [submissions, setSubmissions] = useState([]);
  const [filteredSubmissions, setFilteredSubmissions] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [shareForm, setShareForm] = useState(null);
  const [selectedSubmission, setSelectedSubmission] = useState(null);
  const [submissionDetail, setSubmissionDetail] = useState(null);
  const [isLoadingDetail, setIsLoadingDetail] = useState(false);
  const [error, setError] = useState(null);
  const [isEditing, setIsEditing] = useState(false);
  const [editFormData, setEditFormData] = useState({});
  const [isSavingEdit, setIsSavingEdit] = useState(false);

  // Filters for templates
  const [templateTypeFilter, setTemplateTypeFilter] = useState(router.query.type || "");

  // Filters for submissions
  const [filterFormType, setFilterFormType] = useState("");
  const [searchQuery, setSearchQuery] = useState("");
  const [vrmSearch, setVrmSearch] = useState("");
  const [selectedFormId, setSelectedFormId] = useState("");
  const [statusFilter, setStatusFilter] = useState("");

  const dealerId = session?.user?.dealerId || "000000000000000000000000";

  useEffect(() => {
    if (status === "loading") return;
    loadForms();
    loadSubmissions();
  }, [status]);

  useEffect(() => {
    if (router.query.tab) setActiveTab(router.query.tab);
    if (router.query.type) setTemplateTypeFilter(router.query.type);
  }, [router.query]);

  useEffect(() => {
    applyFilters();
  }, [submissions, filterFormType, searchQuery, vrmSearch, selectedFormId, statusFilter]);

  useEffect(() => {
    applyTemplateFilters();
  }, [forms, templateTypeFilter]);

  // Load submission detail when selected
  useEffect(() => {
    if (selectedSubmission) {
      // Use id or _id depending on what's available (toJSON plugin transforms _id to id)
      const submissionId = selectedSubmission.id || selectedSubmission._id;
      loadSubmissionDetail(submissionId);
    } else {
      setSubmissionDetail(null);
    }
  }, [selectedSubmission]);

  const loadForms = async () => {
    try {
      setError(null);
      const res = await fetch(`/api/forms?dealerId=${dealerId}`);
      const data = await res.json();
      if (res.ok && Array.isArray(data)) {
        setForms(data);
      } else if (data.error) {
        setError(data.error);
        setForms([]);
      } else {
        setForms([]);
      }
      setIsLoading(false);
    } catch (err) {
      console.error("Failed to load forms:", err);
      setError("Failed to load forms");
      setForms([]);
      setIsLoading(false);
    }
  };

  const loadSubmissions = async () => {
    try {
      setIsLoading(true);
      const res = await fetch(`/api/forms/submissions?dealerId=${dealerId}`);
      const data = await res.json();
      if (Array.isArray(data)) {
        setSubmissions(data);
      } else {
        console.error("API returned non-array:", data);
        setSubmissions([]);
      }
      setIsLoading(false);
    } catch (error) {
      console.error("Failed to load submissions:", error);
      setSubmissions([]);
      setIsLoading(false);
    }
  };

  const loadSubmissionDetail = async (id) => {
    try {
      setIsLoadingDetail(true);
      console.log("Loading submission detail for ID:", id);
      const res = await fetch(`/api/forms/submissions/${id}`);
      const data = await res.json();
      console.log("API response:", res.status, data);

      // Check for errors or missing submission
      if (!res.ok || data.error || !data.submission) {
        console.error("Failed to load submission:", data.error || "No submission data", data);
        setSubmissionDetail(null);
        return;
      }

      setSubmissionDetail(data);

      // Mark as viewed if it's new
      const submission = submissions.find(s => (s.id || s._id) === id);
      if (submission && !submission.viewed) {
        markAsViewed(id);
      }
    } catch (error) {
      console.error("Failed to load submission detail:", error);
      setSubmissionDetail(null);
    } finally {
      setIsLoadingDetail(false);
    }
  };

  const markAsViewed = async (id) => {
    try {
      await fetch(`/api/forms/submissions/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ viewed: true, status: "viewed" }),
      });
      // Update local state
      setSubmissions(prev => prev.map(s =>
        (s.id || s._id) === id ? { ...s, viewed: true, status: "viewed" } : s
      ));
    } catch (error) {
      console.error("Failed to mark as viewed:", error);
    }
  };

  const applyFilters = () => {
    let filtered = [...submissions];

    if (filterFormType) {
      filtered = filtered.filter((s) => s.formId?.type === filterFormType);
    }

    if (selectedFormId) {
      filtered = filtered.filter((s) => s.formId?._id === selectedFormId);
    }

    if (statusFilter) {
      if (statusFilter === "new") {
        filtered = filtered.filter((s) => !s.viewed && s.status !== "viewed");
      } else {
        filtered = filtered.filter((s) => s.status === statusFilter);
      }
    }

    if (vrmSearch) {
      const vrmQuery = vrmSearch.toLowerCase().replace(/\s/g, "");
      filtered = filtered.filter((s) => {
        const answers = s.rawAnswers || {};
        const vrmFields = [
          answers.vrm,
          answers.reg,
          answers.registration,
          answers.vehicle_reg,
          answers.regCurrent,
          answers.courtesy_vrm,
        ];
        return vrmFields.some(
          (field) => field && field.toLowerCase().replace(/\s/g, "").includes(vrmQuery)
        );
      });
    }

    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter((s) => {
        const answers = s.rawAnswers || {};
        return (
          answers.name?.toLowerCase().includes(query) ||
          answers.email?.toLowerCase().includes(query) ||
          answers.phone?.toLowerCase().includes(query)
        );
      });
    }

    setFilteredSubmissions(filtered);
  };

  const applyTemplateFilters = () => {
    let filtered = [...forms];

    if (templateTypeFilter) {
      if (templateTypeFilter === "COURTESY") {
        filtered = filtered.filter((f) => f.type === "COURTESY_IN" || f.type === "COURTESY_OUT");
      } else {
        filtered = filtered.filter((f) => f.type === templateTypeFilter);
      }
    }

    setFilteredForms(filtered);
  };

  const handleDeleteForm = async (formId) => {
    if (!confirm("Delete this form template? This cannot be undone.")) return;

    try {
      const res = await fetch(`/api/forms/${formId}`, {
        method: "DELETE",
      });
      if (!res.ok) throw new Error("Failed to delete");
      loadForms();
    } catch (error) {
      alert("Failed to delete form");
    }
  };

  const getPublicUrl = (form) => {
    if (!form.isPublic || !form.publicSlug) return null;
    return `${window.location.origin}/public/forms/${form.publicSlug}`;
  };

  const getSubmissionCount = (formId) => {
    return submissions.filter((s) => s.formId?._id === formId).length;
  };

  const getVrm = (submission) => {
    const answers = submission.rawAnswers || {};
    return answers.vrm || answers.reg || answers.registration || answers.courtesy_vrm || null;
  };

  const formatFieldValue = (value) => {
    if (value === null || value === undefined) return "—";
    if (typeof value === "boolean") return value ? "Yes" : "No";
    if (typeof value === "object") return JSON.stringify(value);
    return value.toString();
  };

  // Start editing
  const handleStartEdit = () => {
    setEditFormData({ ...submissionDetail.submission?.rawAnswers });
    setIsEditing(true);
  };

  // Cancel editing
  const handleCancelEdit = () => {
    setIsEditing(false);
    setEditFormData({});
  };

  // Save edit
  const handleSaveEdit = async () => {
    const subId = selectedSubmission.id || selectedSubmission._id;
    setIsSavingEdit(true);
    try {
      const res = await fetch(`/api/forms/submissions/${subId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ rawAnswers: editFormData }),
      });

      if (!res.ok) throw new Error("Failed to save");

      // Reload submission detail
      await loadSubmissionDetail(subId);
      setIsEditing(false);
      setEditFormData({});
      toast.success("Submission updated");
    } catch (error) {
      console.error("Error saving edit:", error);
      toast.error("Failed to save changes");
    } finally {
      setIsSavingEdit(false);
    }
  };

  // Handle edit input change
  const handleEditInputChange = (fieldName, value) => {
    setEditFormData(prev => ({ ...prev, [fieldName]: value }));
  };

  // Print submission
  const handlePrint = () => {
    generatePrintContent(false);
  };

  // Export PDF
  const handleExportPdf = () => {
    generatePrintContent(true);
  };

  // Generate printable content
  const generatePrintContent = (isPdf) => {
    const printWindow = window.open("", "_blank");
    const formName = submissionDetail.submission?.formId?.name || "Form Submission";
    const vrm = getVrm(submissionDetail.submission) || "";

    printWindow.document.write(`
      <html>
        <head>
          <title>${formName}${vrm ? ` - ${vrm}` : ""}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Segoe UI', Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; color: #1a1a1a; }
            .header { border-bottom: 2px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px; }
            .logo { max-height: 50px; margin-bottom: 15px; }
            .dealer-name { font-size: 14px; color: #666; margin-bottom: 10px; }
            h1 { font-size: 26px; margin-bottom: 8px; color: #1a1a1a; }
            .vrm { font-family: monospace; font-size: 20px; font-weight: bold; color: #2563eb; margin-bottom: 8px; }
            .meta { font-size: 13px; color: #666; }
            .meta span { margin-right: 20px; }
            .section { margin-bottom: 25px; }
            .section-title { font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid #e5e5e5; }
            .fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
            .field { background: #f8f9fa; border-radius: 6px; padding: 12px; }
            .field-full { grid-column: 1 / -1; }
            .field-label { font-size: 11px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
            .field-value { font-size: 14px; color: #1a1a1a; word-break: break-word; }
            .field-value.empty { color: #999; font-style: italic; }
            .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e5e5; font-size: 11px; color: #999; text-align: center; }
            @media print {
              body { padding: 20px; }
              .no-print { display: none; }
            }
            .download-btn {
              position: fixed;
              top: 20px;
              right: 20px;
              padding: 10px 20px;
              background: #2563eb;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
            }
            .download-btn:hover { background: #1d4ed8; }
          </style>
        </head>
        <body>
          ${isPdf ? `<button class="download-btn no-print" onclick="window.print(); return false;">Download PDF</button>` : ""}
          <div class="header">
            ${submissionDetail.dealer?.logoUrl ? `<img src="${submissionDetail.dealer.logoUrl}" alt="Logo" class="logo" />` : ""}
            ${submissionDetail.dealer?.name ? `<div class="dealer-name">${submissionDetail.dealer.name}</div>` : ""}
            <h1>${formName}</h1>
            ${vrm ? `<div class="vrm">${vrm}</div>` : ""}
            <div class="meta">
              <span>Submitted: ${new Date(submissionDetail.submission?.submittedAt).toLocaleString()}</span>
              ${submissionDetail.submission?.lastEditedAt ? `<span>Edited: ${new Date(submissionDetail.submission.lastEditedAt).toLocaleString()}</span>` : ""}
            </div>
          </div>

          <div class="section">
            <div class="section-title">Form Responses</div>
            <div class="fields-grid">
              ${Object.entries(submissionDetail.submission?.rawAnswers || {}).map(([key, value]) => {
                const field = submissionDetail.fields?.find(f => f.fieldName === key);
                const label = field?.label || key;
                const formattedValue = formatFieldValue(value);
                const isLongText = formattedValue.length > 100;
                return `
                  <div class="field ${isLongText ? 'field-full' : ''}">
                    <div class="field-label">${label}</div>
                    <div class="field-value ${!value && value !== false ? 'empty' : ''}">${formattedValue || '—'}</div>
                  </div>
                `;
              }).join("")}
            </div>
          </div>

          <div class="footer">
            Generated from DealerFlow on ${new Date().toLocaleString()}
          </div>
        </body>
      </html>
    `);
    printWindow.document.close();
    if (!isPdf) {
      printWindow.print();
    }
  };

  // Delete submission
  const handleDelete = async () => {
    if (!confirm("Are you sure you want to delete this submission? This cannot be undone.")) return;

    const subId = selectedSubmission.id || selectedSubmission._id;
    try {
      const res = await fetch(`/api/forms/submissions/${subId}`, {
        method: "DELETE",
      });

      if (!res.ok) throw new Error("Failed to delete");

      // Remove from list
      setSubmissions(prev => prev.filter(s => (s.id || s._id) !== subId));
      setSelectedSubmission(null);
      setSubmissionDetail(null);
      toast.success("Submission deleted");
    } catch (error) {
      console.error("Error deleting:", error);
      toast.error("Failed to delete submission");
    }
  };

  const formTypes = ["PDI", "CAR_PREP", "TEST_DRIVE", "WARRANTY_CLAIM", "COURTESY_OUT", "COURTESY_IN", "DELIVERY", "SERVICE_RECEIPT", "BUYING_APPRAISAL", "CUSTOMER_PX_APPRAISAL", "REVIEW_FEEDBACK", "OTHER"];

  const newCount = submissions.filter(s => !s.viewed && s.status !== "viewed").length;

  return (
    <DashboardLayout>
      <Head><title>Forms | DealerFlow</title></Head>

      <div className="flex items-start justify-between mb-6">
        <div>
          <h1 className="text-3xl font-bold">Forms</h1>
          <p className="text-base-content/60 mt-1">Manage form templates and view submissions</p>
        </div>

        {/* Fill Out Form Button */}
        <div className="dropdown dropdown-end">
          <label tabIndex={0} className="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
            Fill Out Form
            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </label>
          <ul tabIndex={0} className="dropdown-content z-20 menu p-2 shadow-lg bg-base-100 rounded-box w-64 max-h-80 overflow-y-auto">
            {forms.length === 0 ? (
              <li className="text-base-content/60 px-4 py-2">No forms available</li>
            ) : (
              forms.map((form) => (
                <li key={form.id || form._id}>
                  <button
                    onClick={() => {
                      if (form.isPublic && form.publicSlug) {
                        window.open(`/public/forms/${form.publicSlug}`, '_blank');
                      } else {
                        router.push(`/forms/fill/${form.id || form._id}`);
                      }
                    }}
                    className="flex items-center justify-between"
                  >
                    <span>{form.name}</span>
                    <span className="badge badge-ghost badge-xs">{FORM_TYPE_LABELS[form.type] || form.type}</span>
                  </button>
                </li>
              ))
            )}
          </ul>
        </div>
      </div>

      {/* Tabs */}
      <div className="tabs tabs-boxed mb-6">
        <a
          className={`tab ${activeTab === "submissions" ? "tab-active" : ""}`}
          onClick={() => setActiveTab("submissions")}
        >
          Inbox
          {newCount > 0 && (
            <span className="badge badge-primary badge-sm ml-2">{newCount}</span>
          )}
        </a>
        <a
          className={`tab ${activeTab === "templates" ? "tab-active" : ""}`}
          onClick={() => setActiveTab("templates")}
        >
          Templates
        </a>
      </div>

      {/* Templates Tab */}
      {activeTab === "templates" && (
        <>
          {forms.length > 0 && (
            <div className="flex items-center gap-3 mb-4">
              <select
                className="select select-bordered select-sm"
                value={templateTypeFilter}
                onChange={(e) => {
                  setTemplateTypeFilter(e.target.value);
                  const newQuery = { ...router.query };
                  if (e.target.value) {
                    newQuery.type = e.target.value;
                  } else {
                    delete newQuery.type;
                  }
                  router.push({ pathname: router.pathname, query: newQuery }, undefined, { shallow: true });
                }}
              >
                <option value="">All Form Types</option>
                {formTypes.map((type) => (
                  <option key={type} value={type}>{FORM_TYPE_LABELS[type] || type}</option>
                ))}
              </select>
              {templateTypeFilter && (
                <button
                  className="btn btn-ghost btn-xs"
                  onClick={() => {
                    setTemplateTypeFilter("");
                    const newQuery = { ...router.query };
                    delete newQuery.type;
                    router.push({ pathname: router.pathname, query: newQuery }, undefined, { shallow: true });
                  }}
                >
                  Clear
                </button>
              )}
              <span className="text-sm text-base-content/60">
                {filteredForms.length} template{filteredForms.length !== 1 ? "s" : ""}
              </span>
            </div>
          )}

          <div className="card bg-base-200">
            <div className="card-body p-0">
              <div className="overflow-x-auto">
                <table className="table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Type</th>
                      <th>Access</th>
                      <th className="text-center">Fields</th>
                      <th className="text-center">Submissions</th>
                      <th className="text-right">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {isLoading ? (
                      <tr>
                        <td colSpan="6" className="text-center py-8">
                          <span className="loading loading-spinner loading-md"></span>
                        </td>
                      </tr>
                    ) : filteredForms.length === 0 ? (
                      <tr>
                        <td colSpan="6" className="text-center py-12 text-base-content/60">
                          {error ? (
                            <div className="text-error">{error}</div>
                          ) : templateTypeFilter ? (
                            `No ${FORM_TYPE_LABELS[templateTypeFilter] || templateTypeFilter} forms found`
                          ) : (
                            "No forms available"
                          )}
                        </td>
                      </tr>
                    ) : (
                      filteredForms.map((form) => (
                        <tr key={form._id} className="hover">
                          <td>
                            <div className="font-semibold">{form.name}</div>
                          </td>
                          <td>
                            <span className="badge badge-ghost badge-sm">
                              {FORM_TYPE_LABELS[form.type] || form.type}
                            </span>
                          </td>
                          <td>
                            {form.isPublic ? (
                              <span className="badge badge-success badge-sm">Public</span>
                            ) : (
                              <span className="badge badge-ghost badge-sm">Private</span>
                            )}
                          </td>
                          <td className="text-center">
                            <span className="font-mono text-sm">{form.fieldCount || 0}</span>
                          </td>
                          <td className="text-center">
                            <span className="font-mono text-sm">{getSubmissionCount(form._id)}</span>
                          </td>
                          <td className="text-right">
                            <div className="flex justify-end gap-1">
                              {form.isPublic && (
                                <button
                                  className="btn btn-xs btn-ghost"
                                  onClick={() => window.open(`/public/forms/${form.publicSlug}`, '_blank')}
                                  title="Preview form"
                                >
                                  Preview
                                </button>
                              )}
                              <Link
                                href={`/settings/forms/${form._id}`}
                                className="btn btn-xs btn-outline"
                              >
                                Edit Fields
                              </Link>
                              {form.isPublic && (
                                <button
                                  className="btn btn-xs btn-primary"
                                  onClick={() => setShareForm(form)}
                                >
                                  Share
                                </button>
                              )}
                              <button
                                className="btn btn-xs btn-ghost"
                                onClick={() => {
                                  setSelectedFormId(form._id);
                                  setActiveTab("submissions");
                                }}
                                title="View submissions"
                              >
                                Submissions
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </>
      )}

      {/* Submissions Tab - Split-View Inbox Layout */}
      {activeTab === "submissions" && (
        <>
          {/* Filters Bar */}
          <div className="flex flex-wrap gap-2 mb-4 items-center">
            {/* VRM Search */}
            <div className="relative flex-1 min-w-[200px] max-w-xs">
              <input
                type="text"
                placeholder="Search VRM..."
                className="input input-bordered input-sm w-full pl-8 font-mono uppercase"
                value={vrmSearch}
                onChange={(e) => setVrmSearch(e.target.value.toUpperCase())}
              />
              <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>

            {/* Customer Search */}
            <input
              type="text"
              placeholder="Customer name..."
              className="input input-bordered input-sm w-40"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />

            {/* Status Filter */}
            <select
              className="select select-bordered select-sm"
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
            >
              <option value="">All Status</option>
              <option value="new">New</option>
              <option value="viewed">Viewed</option>
              <option value="actioned">Actioned</option>
              <option value="archived">Archived</option>
            </select>

            {/* Form Type Filter */}
            <select
              className="select select-bordered select-sm"
              value={filterFormType}
              onChange={(e) => setFilterFormType(e.target.value)}
            >
              <option value="">All Types</option>
              {formTypes.map((type) => (
                <option key={type} value={type}>{FORM_TYPE_LABELS[type] || type}</option>
              ))}
            </select>

            {/* Specific Form Filter */}
            <select
              className="select select-bordered select-sm"
              value={selectedFormId}
              onChange={(e) => setSelectedFormId(e.target.value)}
            >
              <option value="">All Forms</option>
              {forms.map((form) => (
                <option key={form._id} value={form._id}>{form.name}</option>
              ))}
            </select>

            {/* Clear Filters */}
            {(vrmSearch || searchQuery || statusFilter || filterFormType || selectedFormId) && (
              <button
                className="btn btn-ghost btn-sm"
                onClick={() => {
                  setVrmSearch("");
                  setSearchQuery("");
                  setStatusFilter("");
                  setFilterFormType("");
                  setSelectedFormId("");
                }}
              >
                Clear
              </button>
            )}

            <span className="text-sm text-slate-500 ml-auto">
              {filteredSubmissions.length} submission{filteredSubmissions.length !== 1 ? "s" : ""}
            </span>
          </div>

          {/* Split View - 2-Column Grid */}
          <div className="grid grid-cols-12 h-[calc(100vh-64px)]">
            {/* Left Column - The List (col-span-4) */}
            <div className="col-span-4 border-r border-slate-200 h-[calc(100vh-64px)] overflow-y-auto bg-white">
              {isLoading ? (
                <div className="flex justify-center py-12">
                  <span className="loading loading-spinner loading-md"></span>
                </div>
              ) : filteredSubmissions.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-full text-slate-400 px-4">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 mb-4 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                  </svg>
                  <p className="text-lg font-medium">No submissions</p>
                  <p className="text-sm mt-1">Submissions will appear here</p>
                </div>
              ) : (
                <div>
                  {filteredSubmissions.map((submission) => {
                    const isSelected = (selectedSubmission?.id || selectedSubmission?._id) === (submission.id || submission._id);
                    const isNew = !submission.viewed && submission.status !== "viewed";
                    const vrm = getVrm(submission);

                    return (
                      <div
                        key={submission.id || submission._id}
                        onClick={() => setSelectedSubmission(submission)}
                        className={`p-4 border-b border-slate-100 cursor-pointer transition-colors hover:bg-slate-50 ${
                          isSelected ? "bg-blue-50 border-l-4 border-l-blue-600" : ""
                        }`}
                      >
                        {/* Row 1: Form Name + Time */}
                        <div className="flex items-center justify-between gap-2 mb-2">
                          <span className={`font-semibold text-slate-900 truncate ${isNew ? "font-bold" : ""}`}>
                            {submission.formId?.name || "Unknown Form"}
                          </span>
                          <span className="text-xs text-slate-400 whitespace-nowrap flex-shrink-0">
                            {timeAgo(submission.submittedAt)}
                          </span>
                        </div>

                        {/* Row 2: Vehicle Reg */}
                        {vrm && (
                          <div className="mb-2">
                            <span className="text-sm font-mono text-slate-600 bg-slate-100 px-1 rounded">
                              {vrm}
                            </span>
                          </div>
                        )}

                        {/* Row 3: Customer name + Status badges */}
                        <div className="flex items-center justify-between gap-2">
                          {submission.rawAnswers?.name && (
                            <span className="text-sm text-slate-500 truncate">
                              {submission.rawAnswers.name}
                            </span>
                          )}
                          <div className="flex items-center gap-1 flex-shrink-0">
                            {isNew && (
                              <span className="badge badge-primary badge-xs">New</span>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Right Column - The Viewer (col-span-8) */}
            <div className="col-span-8 bg-slate-50 p-8 h-full overflow-y-auto">
              {!selectedSubmission ? (
                /* Empty State - centered illustration */
                <div className="flex flex-col items-center justify-center h-full text-slate-400">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-24 w-24 mb-6 opacity-30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <p className="text-xl font-medium text-slate-500">No submission selected</p>
                  <p className="text-sm mt-2 text-slate-400">Select a submission from the list to view details</p>
                </div>
              ) : isLoadingDetail ? (
                <div className="flex flex-col items-center justify-center h-full">
                  <span className="loading loading-spinner loading-lg text-blue-600"></span>
                  <p className="mt-4 text-slate-500">Loading submission...</p>
                </div>
              ) : !submissionDetail ? (
                <div className="flex flex-col items-center justify-center h-full text-slate-400">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-16 w-16 mb-4 opacity-40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  <p className="text-lg font-medium">Failed to load submission</p>
                  <p className="text-sm mt-1">Please try selecting again</p>
                </div>
              ) : (
                /* Paper Style Card */
                <div className="bg-white shadow-sm rounded-xl p-8 max-w-3xl mx-auto">
                  {/* Header */}
                  <div className="flex items-start justify-between mb-6 pb-6 border-b border-slate-200">
                    <div>
                      <h2 className="text-2xl font-bold text-slate-900 mb-2">
                        {submissionDetail.submission?.formId?.name || "Form Submission"}
                      </h2>
                      <div className="flex items-center gap-3 text-sm text-slate-500">
                        {submissionDetail.submission?.formId?.type && (
                          <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-700">
                            {FORM_TYPE_LABELS[submissionDetail.submission.formId.type] || submissionDetail.submission.formId.type}
                          </span>
                        )}
                        <span>
                          {new Date(submissionDetail.submission?.submittedAt).toLocaleString()}
                        </span>
                      </div>
                    </div>

                    {/* Action Buttons */}
                    <div className="flex items-center gap-2">
                      {!isEditing && (
                        <button
                          className="btn btn-sm btn-outline"
                          onClick={handleStartEdit}
                        >
                          Edit
                        </button>
                      )}

                      {/* Status Dropdown */}
                      <div className="dropdown dropdown-end">
                        <label tabIndex={0} className="btn btn-sm btn-outline">
                          {submissionDetail.submission?.status === "actioned" ? "Actioned" :
                           submissionDetail.submission?.status === "archived" ? "Archived" :
                           submissionDetail.submission?.viewed ? "Viewed" : "New"}
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                          </svg>
                        </label>
                        <ul tabIndex={0} className="dropdown-content z-10 menu p-2 shadow-lg bg-white rounded-lg w-40 border border-slate-200">
                          <li>
                            <button onClick={async () => {
                              const subId = selectedSubmission.id || selectedSubmission._id;
                              await fetch(`/api/forms/submissions/${subId}`, {
                                method: "PATCH",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ status: "actioned" }),
                              });
                              setSubmissions(prev => prev.map(s =>
                                (s.id || s._id) === subId ? { ...s, status: "actioned", viewed: true } : s
                              ));
                              setSubmissionDetail(prev => ({
                                ...prev,
                                submission: { ...prev.submission, status: "actioned", viewed: true }
                              }));
                              toast.success("Marked as actioned");
                            }}>
                              Mark Actioned
                            </button>
                          </li>
                          <li>
                            <button onClick={async () => {
                              const subId = selectedSubmission.id || selectedSubmission._id;
                              await fetch(`/api/forms/submissions/${subId}`, {
                                method: "PATCH",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ status: "archived" }),
                              });
                              setSubmissions(prev => prev.map(s =>
                                (s.id || s._id) === subId ? { ...s, status: "archived", viewed: true } : s
                              ));
                              setSubmissionDetail(prev => ({
                                ...prev,
                                submission: { ...prev.submission, status: "archived", viewed: true }
                              }));
                              toast.success("Archived");
                            }}>
                              Archive
                            </button>
                          </li>
                          <li>
                            <button onClick={async () => {
                              const subId = selectedSubmission.id || selectedSubmission._id;
                              await fetch(`/api/forms/submissions/${subId}`, {
                                method: "PATCH",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ viewed: false, status: "new" }),
                              });
                              setSubmissions(prev => prev.map(s =>
                                (s.id || s._id) === subId ? { ...s, status: "new", viewed: false } : s
                              ));
                              setSubmissionDetail(prev => ({
                                ...prev,
                                submission: { ...prev.submission, status: "new", viewed: false }
                              }));
                              toast.success("Marked as unread");
                            }}>
                              Mark Unread
                            </button>
                          </li>
                        </ul>
                      </div>

                      {/* More Actions Menu */}
                      <div className="dropdown dropdown-end">
                        <label tabIndex={0} className="btn btn-sm btn-ghost btn-square">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                          </svg>
                        </label>
                        <ul tabIndex={0} className="dropdown-content z-10 menu p-2 shadow-lg bg-white rounded-lg w-44 border border-slate-200">
                          <li><button onClick={handleStartEdit}>Edit</button></li>
                          <li><button onClick={handlePrint}>Print</button></li>
                          <li><button onClick={handleExportPdf}>Export PDF</button></li>
                          <li className="divider my-1"></li>
                          <li><button onClick={handleDelete} className="text-error">Delete</button></li>
                        </ul>
                      </div>
                    </div>
                  </div>

                  {/* Edit History Notice */}
                  {submissionDetail.submission?.lastEditedAt && (
                    <div className="flex items-center gap-2 p-3 mb-6 bg-blue-50 text-blue-700 rounded-lg text-sm">
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <span>
                        Edited by {submissionDetail.submission.lastEditedByName} on {new Date(submissionDetail.submission.lastEditedAt).toLocaleString()}
                      </span>
                    </div>
                  )}

                  {/* Linked Records */}
                  {(submissionDetail.submission?.linkedVehicleId || submissionDetail.submission?.linkedAftercareCaseId || submissionDetail.submission?.linkedVehicleSaleId) && (
                    <div className="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                      <h4 className="font-semibold mb-3 text-xs uppercase tracking-wide text-slate-500">Linked Records</h4>
                      <div className="flex flex-wrap gap-2">
                        {submissionDetail.submission.linkedVehicleId && (
                          <Link href={`/vehicles/${submissionDetail.submission.linkedVehicleId._id}`} className="btn btn-sm btn-outline">
                            Vehicle: {submissionDetail.submission.linkedVehicleId.regCurrent}
                          </Link>
                        )}
                        {submissionDetail.submission.linkedAftercareCaseId && (
                          <Link href={`/warranty/${submissionDetail.submission.linkedAftercareCaseId._id}`} className="btn btn-sm btn-outline">
                            Aftercare Case
                          </Link>
                        )}
                        {submissionDetail.submission.linkedVehicleSaleId && (
                          <Link href={`/sales/${submissionDetail.submission.linkedVehicleSaleId._id}`} className="btn btn-sm btn-outline">
                            Sale Record
                          </Link>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Answers - View or Edit Mode */}
                  <div id="submission-print-content">
                    <div className="flex items-center justify-between mb-4">
                      <h4 className="font-semibold text-xs uppercase tracking-wide text-slate-500">
                        {isEditing ? "Edit Responses" : "Form Responses"}
                      </h4>
                      {isEditing && (
                        <div className="flex gap-2">
                          <button
                            className="btn btn-sm btn-ghost"
                            onClick={handleCancelEdit}
                            disabled={isSavingEdit}
                          >
                            Cancel
                          </button>
                          <button
                            className="btn btn-sm btn-primary"
                            onClick={handleSaveEdit}
                            disabled={isSavingEdit}
                          >
                            {isSavingEdit ? (
                              <span className="loading loading-spinner loading-xs"></span>
                            ) : (
                              "Save Changes"
                            )}
                          </button>
                        </div>
                      )}
                    </div>
                    <div className="space-y-4">
                      {Object.entries(isEditing ? editFormData : (submissionDetail.submission?.rawAnswers || {})).map(([key, value]) => {
                        const field = submissionDetail.fields?.find(f => f.fieldName === key);
                        const label = field?.label || key;
                        const fieldType = field?.type || "TEXT";

                        return (
                          <div key={key} className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                            <label className="block text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">
                              {label}
                            </label>
                            {isEditing ? (
                              <div className="mt-1">
                                {fieldType === "TEXTAREA" ? (
                                  <textarea
                                    className="textarea textarea-bordered w-full bg-white"
                                    value={value || ""}
                                    onChange={(e) => handleEditInputChange(key, e.target.value)}
                                    rows={3}
                                  />
                                ) : fieldType === "BOOLEAN" ? (
                                  <input
                                    type="checkbox"
                                    className="checkbox checkbox-primary"
                                    checked={value === true}
                                    onChange={(e) => handleEditInputChange(key, e.target.checked)}
                                  />
                                ) : fieldType === "NUMBER" ? (
                                  <input
                                    type="number"
                                    className="input input-bordered w-full bg-white"
                                    value={value || ""}
                                    onChange={(e) => handleEditInputChange(key, e.target.value)}
                                  />
                                ) : fieldType === "DATE" ? (
                                  <input
                                    type="date"
                                    className="input input-bordered w-full bg-white"
                                    value={value || ""}
                                    onChange={(e) => handleEditInputChange(key, e.target.value)}
                                  />
                                ) : fieldType === "DROPDOWN" ? (
                                  <select
                                    className="select select-bordered w-full bg-white"
                                    value={value || ""}
                                    onChange={(e) => handleEditInputChange(key, e.target.value)}
                                  >
                                    <option value="">Select...</option>
                                    {(field?.options?.values || field?.options?.choices || []).map((opt) => (
                                      <option key={opt} value={opt}>{opt}</option>
                                    ))}
                                  </select>
                                ) : (
                                  <input
                                    type="text"
                                    className="input input-bordered w-full bg-white"
                                    value={value || ""}
                                    onChange={(e) => handleEditInputChange(key, e.target.value)}
                                  />
                                )}
                              </div>
                            ) : (
                              <div className="text-slate-900 mt-1">
                                {formatFieldValue(value)}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* Files */}
                  {submissionDetail.files && submissionDetail.files.length > 0 && (
                    <div className="mt-6 pt-6 border-t border-slate-200">
                      <h4 className="font-semibold mb-4 text-xs uppercase tracking-wide text-slate-500">Uploaded Files</h4>
                      <div className="space-y-2">
                        {submissionDetail.files.map((file) => (
                          <div key={file._id} className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <div>
                              <p className="font-semibold text-slate-900">{file.filename || "File"}</p>
                              <p className="text-sm text-slate-500">
                                Field: {file.fieldName}
                                {file.size && ` • ${(file.size / 1024).toFixed(1)} KB`}
                              </p>
                            </div>
                            <a
                              href={file.url}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="btn btn-sm btn-primary"
                            >
                              Download
                            </a>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </>
      )}

      {/* Share Modal */}
      {shareForm && (
        <ShareFormModal
          form={shareForm}
          publicUrl={getPublicUrl(shareForm)}
          onClose={() => setShareForm(null)}
        />
      )}
    </DashboardLayout>
  );
}
