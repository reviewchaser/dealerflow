import connectMongo from "@/libs/mongoose";
import PrepTaskTemplate from "@/models/PrepTaskTemplate";

const DEFAULT_TASKS = ["PDI", "Valet", "Photos", "MOT Check", "Advert", "Plates", "Delivery Prep"];

export default async function handler(req, res) {
  await connectMongo();

  if (req.method === "GET") {
    try {
      let tasks = await PrepTaskTemplate.find().sort({ order: 1 }).lean();

      // If no tasks exist, seed with defaults
      if (tasks.length === 0) {
        for (let i = 0; i < DEFAULT_TASKS.length; i++) {
          await PrepTaskTemplate.create({ name: DEFAULT_TASKS[i], order: i + 1 });
        }
        tasks = await PrepTaskTemplate.find().sort({ order: 1 }).lean();
      }

      // Transform for frontend
      const result = tasks.map(t => ({
        ...t,
        id: t._id.toString(),
        _id: undefined,
      }));

      return res.status(200).json(result);
    } catch (error) {
      console.error("Error fetching prep tasks:", error);
      return res.status(500).json({ error: "Failed to fetch prep tasks" });
    }
  }

  if (req.method === "POST") {
    try {
      const { name, resetToDefaults } = req.body;

      // Handle reset to defaults
      if (resetToDefaults) {
        await PrepTaskTemplate.deleteMany({});
        for (let i = 0; i < DEFAULT_TASKS.length; i++) {
          await PrepTaskTemplate.create({ name: DEFAULT_TASKS[i], order: i + 1 });
        }
        const tasks = await PrepTaskTemplate.find().sort({ order: 1 }).lean();
        const result = tasks.map(t => ({
          ...t,
          id: t._id.toString(),
          _id: undefined,
        }));
        return res.status(200).json(result);
      }

      if (!name) {
        return res.status(400).json({ error: "Name is required" });
      }

      // Get the highest order number and add 1
      const highestTask = await PrepTaskTemplate.findOne().sort({ order: -1 });
      const order = highestTask ? highestTask.order + 1 : 1;

      const task = await PrepTaskTemplate.create({ name, order });
      const result = {
        ...task.toObject(),
        id: task._id.toString(),
        _id: undefined,
      };
      return res.status(201).json(result);
    } catch (error) {
      console.error("Error creating prep task:", error);
      return res.status(500).json({ error: "Failed to create prep task" });
    }
  }

  return res.status(405).json({ error: "Method not allowed" });
}
