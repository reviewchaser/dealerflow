import { useEffect, useState } from "react";
import Head from "next/head";
import Link from "next/link";
import DashboardLayout from "@/components/DashboardLayout";
import { toast } from "react-hot-toast";
import { showDummyNotification } from "@/utils/notifications";

const COLUMNS = [
  { key: "in_stock", label: "In Prep", gradient: "from-orange-100/60", accent: "border-l-orange-400", accentBg: "bg-orange-400" },
  { key: "in_prep", label: "Advertised", gradient: "from-blue-100/60", accent: "border-l-blue-400", accentBg: "bg-blue-400" },
  { key: "live", label: "Sold In Progress", gradient: "from-purple-100/60", accent: "border-l-purple-400", accentBg: "bg-purple-400" },
  { key: "reserved", label: "Completed", gradient: "from-emerald-100/60", accent: "border-l-emerald-400", accentBg: "bg-emerald-400" },
  { key: "delivered", label: "Delivered", gradient: "from-teal-100/60", accent: "border-l-teal-400", accentBg: "bg-teal-400" },
];

const ISSUE_SUBCATEGORIES = {
  mechanical: ["Engine", "Transmission", "Suspension", "Brakes", "Exhaust", "Other"],
  electrical: ["Battery", "Lights", "Starter Motor", "Alternator", "Sensors", "Other"],
  bodywork: ["Panel Damage", "Scratches", "Dents", "Bumper", "Windscreen", "Other"],
  interior: ["Seats", "Dashboard", "Trim", "Carpet", "Controls", "Other"],
  tyres: ["Tread Depth", "Puncture", "Alloys", "Alignment", "Other"],
  mot: ["Advisory", "Failed Item", "Due Soon", "Other"],
  service: ["Oil Change", "Filters", "Fluids", "Timing Belt", "Other"],
  fault_codes: ["Engine", "Transmission", "ABS", "Airbag", "Emissions", "Other"],
  other: ["General", "Misc"],
};

export default function SalesPrep() {
  const [vehicles, setVehicles] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedVehicle, setSelectedVehicle] = useState(null);
  const [showAddModal, setShowAddModal] = useState(false);
  const [draggedCard, setDraggedCard] = useState(null);
  const [newTaskName, setNewTaskName] = useState("");
  const [activeTab, setActiveTab] = useState("overview");
  const [editingTaskId, setEditingTaskId] = useState(null);
  const [editingTaskName, setEditingTaskName] = useState("");

  // Column sorting state
  const [columnSortOptions, setColumnSortOptions] = useState({});

  // Issues state
  const [showAddIssueModal, setShowAddIssueModal] = useState(false);
  const [issueForm, setIssueForm] = useState({
    category: "",
    subcategory: "",
    description: "",
    actionNeeded: "",
    status: "outstanding",
    notes: "",
    photos: [],
  });
  const [issueUpdateContent, setIssueUpdateContent] = useState({});
  const [expandedIssues, setExpandedIssues] = useState({});

  // Filters state
  const [activeFilters, setActiveFilters] = useState([]);
  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);

  // Documents state
  const [showAddDocumentModal, setShowAddDocumentModal] = useState(false);
  const [documentForm, setDocumentForm] = useState({
    name: "",
    type: "other",
    file: null,
  });

  // Location state
  const [locations, setLocations] = useState([]);
  const [showAddLocationModal, setShowAddLocationModal] = useState(false);

  // VRM Search state
  const [vrmSearch, setVrmSearch] = useState("");
  const [showVrmDropdown, setShowVrmDropdown] = useState(false);

  // Mobile state
  const [mobileActiveColumn, setMobileActiveColumn] = useState("in_stock");

  useEffect(() => {
    fetchVehicles();
    fetchLocations();
  }, []);

  const fetchVehicles = async () => {
    try {
      const res = await fetch("/api/vehicles");
      const data = await res.json();
      // Ensure we always set an array
      setVehicles(Array.isArray(data) ? data : []);
    } catch (error) {
      toast.error("Failed to load vehicles");
      setVehicles([]);
    } finally {
      setIsLoading(false);
    }
  };

  const fetchLocations = async () => {
    try {
      const res = await fetch("/api/locations");
      const data = await res.json();
      setLocations(data);
    } catch (error) {
      console.error("Failed to load locations:", error);
    }
  };

  // Open vehicle drawer - vehicle from grid already has tasks, issues, documents
  const openVehicleDrawer = (vehicle) => {
    // The vehicle object from getVehiclesByStatus already has all data
    // (tasks, issues, documents) populated from fetchVehicles API
    console.log("Opening vehicle drawer:", vehicle);
    console.log("Vehicle tasks:", vehicle.tasks);
    console.log("Vehicle issues:", vehicle.issues);
    console.log("Vehicle documents:", vehicle.documents);
    setSelectedVehicle({ ...vehicle, id: vehicle.id || vehicle._id });
    setActiveTab("overview"); // Reset to overview tab when opening
  };

  const updateVehicleStatus = async (vehicleId, newStatus) => {
    try {
      await fetch(`/api/vehicles/${vehicleId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus }),
      });
      fetchVehicles();
      toast.success(`Moved to ${newStatus.replace("_", " ")}`);
    } catch (error) {
      toast.error("Failed to update");
    }
  };

  const updateTaskStatus = async (taskId, newStatus) => {
    try {
      const payload = { status: newStatus };
      if (newStatus === "done") {
        payload.completedAt = new Date().toISOString();
      }
      await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
    } catch (error) {
      toast.error("Failed to update task");
    }
  };

  const updateTaskName = async (taskId, newName) => {
    if (!newName.trim()) {
      toast.error("Task name cannot be empty");
      return;
    }
    try {
      await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newName }),
      });
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
      setEditingTaskId(null);
      setEditingTaskName("");
      toast.success("Task updated");
    } catch (error) {
      toast.error("Failed to update task");
    }
  };

  const addTask = async () => {
    if (!newTaskName.trim()) return toast.error("Task name is required");
    try {
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/tasks`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newTaskName }),
      });
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || "Failed to add task");
      }
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      setNewTaskName("");
      fetchVehicles();
      toast.success("Task added");
    } catch (error) {
      console.error("Add task error:", error);
      toast.error(error.message || "Failed to add task");
    }
  };

  const deleteTask = async (taskId) => {
    try {
      await fetch(`/api/tasks/${taskId}`, { method: "DELETE" });
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Task removed");
    } catch (error) {
      toast.error("Failed to delete task");
    }
  };

  // Issue functions
  const addIssue = async (photoUrls = []) => {
    if (!issueForm.category || !issueForm.subcategory || !issueForm.description) {
      return toast.error("Category, subcategory, and description are required");
    }
    try {
      const issueData = {
        ...issueForm,
        photos: [...(issueForm.photos || []), ...photoUrls],
      };
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/issues`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(issueData),
      });
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || "Failed to add issue");
      }
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      setShowAddIssueModal(false);
      setIssueForm({
        category: "",
        subcategory: "",
        description: "",
        actionNeeded: "",
        status: "outstanding",
        notes: "",
        photos: [],
      });
      toast.success("Issue added");
    } catch (error) {
      console.error("Add issue error:", error);
      toast.error(error.message || "Failed to add issue");
    }
  };

  const updateIssue = async (issueId, updates) => {
    try {
      const res = await fetch(`/api/issues/${issueId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates),
      });
      if (!res.ok) throw new Error("Failed to update issue");
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Issue updated");
    } catch (error) {
      toast.error("Failed to update issue");
    }
  };

  const deleteIssue = async (issueId) => {
    try {
      await fetch(`/api/issues/${issueId}`, { method: "DELETE" });
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Issue removed");
    } catch (error) {
      toast.error("Failed to delete issue");
    }
  };

  const addIssueUpdate = async (issueId, content) => {
    if (!content?.trim()) {
      return toast.error("Update content cannot be empty");
    }

    try {
      await fetch(`/api/issues/${issueId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: content.trim(),
          userName: "Current User" // TODO: Replace with actual user name from auth
        }),
      });

      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      setIssueUpdateContent(prev => ({ ...prev, [issueId]: "" }));
      toast.success("Update added");
    } catch (error) {
      toast.error("Failed to add update");
    }
  };

  // Document functions
  const uploadDocument = async (file, name, type) => {
    if (!file) return;

    try {
      // First upload the file
      const uploadFormData = new FormData();
      uploadFormData.append("file", file);

      const uploadRes = await fetch("/api/vehicles/upload", {
        method: "POST",
        body: uploadFormData,
      });
      if (!uploadRes.ok) throw new Error("File upload failed");
      const uploadData = await uploadRes.json();

      // Then create the document record with the URL
      const docRes = await fetch(`/api/vehicles/${selectedVehicle.id}/documents`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, type, url: uploadData.url }),
      });
      if (!docRes.ok) throw new Error("Document creation failed");

      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      setShowAddDocumentModal(false);
      setDocumentForm({ name: "", type: "other", file: null });
      toast.success("Document uploaded");
    } catch (error) {
      console.error("Upload error:", error);
      toast.error("Failed to upload document");
    }
  };

  const deleteDocument = async (documentId) => {
    try {
      await fetch(`/api/documents/${documentId}`, { method: "DELETE" });
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Document removed");
    } catch (error) {
      toast.error("Failed to delete document");
    }
  };

  const handleDragStart = (e, vehicle) => {
    setDraggedCard(vehicle);
    e.dataTransfer.effectAllowed = "move";
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  const handleDrop = async (e, newStatus) => {
    e.preventDefault();
    if (!draggedCard || draggedCard.status === newStatus) return;
    const vehicleId = draggedCard.id || draggedCard._id;
    await updateVehicleStatus(vehicleId, newStatus);
    setDraggedCard(null);
  };

  const uploadV5 = async (file) => {
    if (!file) return;

    try {
      // First upload the file
      const formData = new FormData();
      formData.append("file", file);

      const uploadRes = await fetch("/api/vehicles/upload", {
        method: "POST",
        body: formData,
      });
      if (!uploadRes.ok) throw new Error("Upload failed");
      const uploadData = await uploadRes.json();

      // Then update the vehicle with the V5 URL
      await fetch(`/api/vehicles/${selectedVehicle.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ v5Url: uploadData.url }),
      });

      const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updated);
      fetchVehicles();
      toast.success("V5 uploaded");
    } catch (error) {
      console.error("V5 upload error:", error);
      toast.error("Failed to upload V5");
    }
  };

  const formatDate = (date) => {
    if (!date) return "‚Äî";
    return new Date(date).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
  };

  const toggleFilter = (filter) => {
    setActiveFilters(prev =>
      prev.includes(filter)
        ? prev.filter(f => f !== filter)
        : [...prev, filter]
    );
  };

  const getFilteredVehicles = (vehicleList) => {
    if (activeFilters.length === 0) return vehicleList;

    return vehicleList.filter(vehicle => {
      return activeFilters.every(filter => {
        const tasks = vehicle.tasks || [];
        const issues = vehicle.issues || [];
        const activeIssues = issues.filter(i => {
          const status = (i.status || "").toLowerCase();
          return ["outstanding", "ordered", "in progress", "in_progress"].includes(status);
        });

        // Prep task filters
        if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
        if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
        if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
        if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");

        // Issue filters
        if (filter === "needs_paint") return activeIssues.some(i => {
          const cat = (i.category || "").toLowerCase();
          return cat === "bodywork" || cat === "cosmetic";
        });
        if (filter === "needs_mechanical") return activeIssues.some(i => {
          const cat = (i.category || "").toLowerCase();
          return cat === "mechanical";
        });
        if (filter === "needs_electrical") return activeIssues.some(i => {
          const cat = (i.category || "").toLowerCase();
          return cat === "electrical";
        });

        // Location filter
        if (filter === "offsite") return vehicle.locationId != null;

        // MOT filters
        if (filter === "mot_due_soon") {
          if (!vehicle.motExpiryDate) return false;
          const expiry = new Date(vehicle.motExpiryDate);
          const now = new Date();
          const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
          return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
        }
        if (filter === "mot_expired") {
          if (!vehicle.motExpiryDate) return false;
          const expiry = new Date(vehicle.motExpiryDate);
          const now = new Date();
          return expiry < now;
        }

        // Sale type filters
        if (filter === "trade_only") return vehicle.saleType === "TRADE";
        if (filter === "retail_only") return vehicle.saleType === "RETAIL" || !vehicle.saleType;

        return true;
      });
    });
  };

  const getVehiclesByStatus = (status) => {
    const statusVehicles = vehicles.filter(v => v.status === status);
    const filtered = getFilteredVehicles(statusVehicles);

    // Apply sorting based on columnSortOptions
    const sortOption = columnSortOptions[status] || "oldest_first";

    return [...filtered].sort((a, b) => {
      const daysA = a.createdAt ? Math.floor((new Date() - new Date(a.createdAt)) / (1000 * 60 * 60 * 24)) : 0;
      const daysB = b.createdAt ? Math.floor((new Date() - new Date(b.createdAt)) / (1000 * 60 * 60 * 24)) : 0;

      switch (sortOption) {
        case "oldest_first":
          return daysB - daysA; // More days = older = first
        case "newest_first":
          return daysA - daysB; // Fewer days = newer = first
        case "alphabetical":
          const nameA = `${a.make || ""} ${a.model || ""}`.toLowerCase();
          const nameB = `${b.make || ""} ${b.model || ""}`.toLowerCase();
          return nameA.localeCompare(nameB);
        default:
          return daysB - daysA;
      }
    });
  };

  const getFilterCount = (filter) => {
    const allFiltered = getFilteredVehicles(vehicles.filter(v => {
      const tasks = v.tasks || [];
      const issues = v.issues || [];
      const activeIssues = issues.filter(i => {
        const status = (i.status || "").toLowerCase();
        return ["outstanding", "ordered", "in progress", "in_progress"].includes(status);
      });

      if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
      if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
      if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
      if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");
      if (filter === "needs_paint") return activeIssues.some(i => {
        const cat = (i.category || "").toLowerCase();
        return cat === "bodywork" || cat === "cosmetic";
      });
      if (filter === "needs_mechanical") return activeIssues.some(i => {
        const cat = (i.category || "").toLowerCase();
        return cat === "mechanical";
      });
      if (filter === "needs_electrical") return activeIssues.some(i => {
        const cat = (i.category || "").toLowerCase();
        return cat === "electrical";
      });
      if (filter === "offsite") return v.locationId != null;
      if (filter === "mot_due_soon") {
        if (!v.motExpiryDate) return false;
        const expiry = new Date(v.motExpiryDate);
        const now = new Date();
        const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
        return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
      }
      if (filter === "mot_expired") {
        if (!v.motExpiryDate) return false;
        const expiry = new Date(v.motExpiryDate);
        return expiry < new Date();
      }
      if (filter === "trade_only") return v.saleType === "TRADE";
      if (filter === "retail_only") return v.saleType === "RETAIL" || !v.saleType;
      return false;
    }));
    return allFiltered.length;
  };

  // VRM Search functions
  const getVrmSearchResults = () => {
    if (vrmSearch.length < 2) return [];
    const searchTerm = vrmSearch.toUpperCase().replace(/\s/g, "");
    return vehicles.filter(v => {
      const reg = (v.regCurrent || "").toUpperCase().replace(/\s/g, "");
      return reg.includes(searchTerm);
    }).slice(0, 8); // Limit to 8 results
  };

  const handleVrmSelect = (vehicle) => {
    // Close dropdown and clear search
    setVrmSearch("");
    setShowVrmDropdown(false);

    // Find which column this vehicle is in and scroll to it
    const columnIndex = COLUMNS.findIndex(col => col.key === vehicle.status);
    if (columnIndex >= 0) {
      // Scroll the column into view
      const columnElements = document.querySelectorAll('[data-column-key]');
      if (columnElements[columnIndex]) {
        columnElements[columnIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    }

    // Open the vehicle drawer with full details
    openVehicleDrawer(vehicle);
  };

  const getStatusLabel = (statusKey) => {
    const col = COLUMNS.find(c => c.key === statusKey);
    return col ? col.label : statusKey;
  };

  const handlePrintVehicle = () => {
    if (!selectedVehicle) return;

    const vehicle = selectedVehicle;
    const tasks = vehicle.tasks || [];
    const issues = vehicle.issues || [];
    const documents = vehicle.documents || [];
    const completedTasks = tasks.filter(t => t.status === "done").length;
    const daysInStock = vehicle.createdAt
      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
      : 0;

    // Get status label from COLUMNS
    const statusColumn = COLUMNS.find(col => col.key === vehicle.status);
    const statusLabel = statusColumn ? statusColumn.label : vehicle.status;

    // Generate HTML for print
    const printContent = `
<!DOCTYPE html>
<html>
<head>
  <title>${vehicle.year || ""} ${vehicle.make} ${vehicle.model} - ${vehicle.regCurrent}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }
    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
    .reg { font-size: 18px; font-family: monospace; color: #64748b; }
    .section { margin-bottom: 30px; }
    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .field { margin-bottom: 12px; }
    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
    .field-value { font-size: 14px; color: #1e293b; }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .badge-status { background: #e0e7ff; color: #4338ca; }
    .badge-days { background: ${daysInStock > 30 ? '#fef2f2' : '#f1f5f9'}; color: ${daysInStock > 30 ? '#dc2626' : '#475569'}; }
    .task-list { list-style: none; }
    .task-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
    .task-status { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .task-done { background: #dcfce7; color: #16a34a; }
    .task-pending { background: #fef3c7; color: #d97706; }
    .task-progress { background: #dbeafe; color: #2563eb; }
    .issue-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; }
    .issue-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .issue-desc { font-size: 14px; color: #1e293b; }
    .doc-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }
    @media print {
      body { padding: 20px; }
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">${vehicle.year || ""} ${vehicle.make} ${vehicle.model}</div>
    <div class="reg">${vehicle.regCurrent}</div>
  </div>

  <div class="section">
    <div class="section-title">Overview</div>
    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
      <span class="badge badge-status">${statusLabel}</span>
      <span class="badge badge-days">Days in Stock: ${daysInStock}</span>
      ${vehicle.locationId ? `<span class="badge" style="background:#eef2ff;color:#4f46e5;">üìç ${vehicle.locationId.name || 'Offsite'}</span>` : '<span class="badge" style="background:#f0fdf4;color:#16a34a;">üìç On Site</span>'}
    </div>
  </div>

  <div class="section">
    <div class="section-title">Vehicle Details</div>
    <div class="grid">
      <div class="field">
        <div class="field-label">Registration</div>
        <div class="field-value">${vehicle.regCurrent || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">VIN</div>
        <div class="field-value">${vehicle.vin || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Make</div>
        <div class="field-value">${vehicle.make || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Model</div>
        <div class="field-value">${vehicle.model || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Year</div>
        <div class="field-value">${vehicle.year || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Mileage</div>
        <div class="field-value">${vehicle.mileageCurrent ? vehicle.mileageCurrent.toLocaleString() + ' miles' : '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Colour</div>
        <div class="field-value">${vehicle.colour || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">Fuel Type</div>
        <div class="field-value">${vehicle.fuelType || '‚Äî'}</div>
      </div>
      <div class="field">
        <div class="field-label">MOT Expiry</div>
        <div class="field-value">${vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : '‚Äî'}</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Prep Checklist (${completedTasks}/${tasks.length} complete)</div>
    ${tasks.length > 0 ? `
    <ul class="task-list">
      ${tasks.map(task => `
        <li class="task-item">
          <span class="task-status ${task.status === 'done' ? 'task-done' : task.status === 'in_progress' ? 'task-progress' : 'task-pending'}">
            ${task.status === 'done' ? '‚úì' : task.status === 'in_progress' ? '‚Üí' : '‚óã'}
          </span>
          <span style="${task.status === 'done' ? 'text-decoration: line-through; color: #94a3b8;' : ''}">${task.name}</span>
          ${task.completedAt ? `<span style="font-size: 11px; color: #94a3b8; margin-left: auto;">${new Date(task.completedAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</span>` : ''}
        </li>
      `).join('')}
    </ul>
    ` : '<p style="color: #94a3b8; font-size: 14px;">No tasks</p>'}
  </div>

  <div class="section">
    <div class="section-title">Issues (${issues.length})</div>
    ${issues.length > 0 ? issues.map(issue => `
      <div class="issue-card">
        <div class="issue-header">
          <span class="issue-badge">${issue.category}</span>
          ${issue.subcategory ? `<span class="issue-badge">${issue.subcategory}</span>` : ''}
          <span class="issue-badge" style="margin-left: auto;">${issue.status || 'Outstanding'}</span>
        </div>
        <div class="issue-desc">${issue.description}</div>
        ${issue.actionNeeded ? `<div style="font-size: 12px; color: #64748b; margin-top: 6px;">Action: ${issue.actionNeeded}</div>` : ''}
      </div>
    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No issues recorded</p>'}
  </div>

  <div class="section">
    <div class="section-title">Documents (${documents.length})</div>
    ${documents.length > 0 ? documents.map(doc => `
      <div class="doc-item">
        <span style="font-weight: 500;">${doc.name}</span>
        <span style="font-size: 12px; color: #94a3b8; margin-left: 8px;">(${doc.type.replace(/_/g, ' ')})</span>
      </div>
    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No documents uploaded</p>'}
    ${vehicle.v5Url ? '<div class="doc-item"><span style="font-weight: 500;">V5 Document</span> <span style="font-size: 12px; color: #16a34a;">‚úì Uploaded</span></div>' : ''}
  </div>

  ${vehicle.notes ? `
  <div class="section">
    <div class="section-title">Notes</div>
    <p style="font-size: 14px; white-space: pre-wrap;">${vehicle.notes}</p>
  </div>
  ` : ''}

  <div class="footer">
    Printed from DealerFlow on ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
  </div>
</body>
</html>
    `;

    // Open in new tab
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
  };

  const getMOTStatus = (motExpiryDate) => {
    if (!motExpiryDate) return null;
    const expiry = new Date(motExpiryDate);
    const now = new Date();
    const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));

    if (daysUntilExpiry < 0) return { type: "expired", label: "MOT EXPIRED", class: "badge-error" };
    if (daysUntilExpiry <= 30) return { type: "due_soon", label: "MOT DUE", class: "badge-warning" };
    return null;
  };

  const getActiveIssuesByCategory = (issues = []) => {
    const activeIssues = issues.filter(i => {
      const status = (i.status || "").toLowerCase();
      return ["outstanding", "ordered", "in_progress", "in progress"].includes(status);
    });
    const categoryCounts = {};
    activeIssues.forEach(issue => {
      categoryCounts[issue.category] = (categoryCounts[issue.category] || 0) + 1;
    });
    return categoryCounts;
  };

  return (
    <DashboardLayout>
      <Head><title>Sales & Prep | DealerFlow</title></Head>

      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-3xl font-bold">Sales & Prep Board</h1>
          <p className="text-base-content/60 mt-1">Manage vehicle prep and sales pipeline &bull; Drag cards to move between stages</p>
        </div>
        <button className="btn btn-primary" onClick={() => setShowAddModal(true)}>
          + Add Vehicle
        </button>
      </div>

      {/* Consolidated Filters */}
      <div className="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-slate-200 mb-4 -mx-6 px-6 py-4">
        <div className="flex gap-2 items-center">
            {/* VRM Search */}
            <div className="relative">
              <div className="relative">
                <svg className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  placeholder="Search VRM..."
                  className="input input-sm input-bordered pl-9 pr-8 w-44 font-mono uppercase"
                  value={vrmSearch}
                  onChange={(e) => {
                    setVrmSearch(e.target.value.toUpperCase());
                    setShowVrmDropdown(e.target.value.length >= 2);
                  }}
                  onFocus={() => vrmSearch.length >= 2 && setShowVrmDropdown(true)}
                  onKeyDown={(e) => {
                    if (e.key === "Escape") {
                      setShowVrmDropdown(false);
                      e.target.blur();
                    }
                  }}
                />
                {vrmSearch && (
                  <button
                    className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                    onClick={() => {
                      setVrmSearch("");
                      setShowVrmDropdown(false);
                    }}
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                )}
              </div>

              {/* VRM Search Dropdown */}
              {showVrmDropdown && (
                <>
                  <div className="fixed inset-0 z-10" onClick={() => setShowVrmDropdown(false)}></div>
                  <div className="absolute top-full left-0 mt-1 w-72 bg-white rounded-xl shadow-xl border border-slate-200 z-20 overflow-hidden">
                    {getVrmSearchResults().length > 0 ? (
                      <ul className="py-1 max-h-64 overflow-y-auto">
                        {getVrmSearchResults().map((vehicle) => (
                          <li key={vehicle.id || vehicle._id}>
                            <button
                              className="w-full px-4 py-2.5 text-left hover:bg-slate-50 flex items-center justify-between gap-2 transition-colors"
                              onClick={() => handleVrmSelect(vehicle)}
                            >
                              <div className="flex items-center gap-3">
                                <span className="font-mono font-bold text-slate-900">{vehicle.regCurrent}</span>
                                <span className="text-sm text-slate-500">{vehicle.make} {vehicle.model}</span>
                              </div>
                              <span className="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">
                                {getStatusLabel(vehicle.status)}
                              </span>
                            </button>
                          </li>
                        ))}
                      </ul>
                    ) : (
                      <div className="px-4 py-6 text-center">
                        <svg className="w-8 h-8 mx-auto text-slate-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm text-slate-500">No vehicles found</p>
                        <p className="text-xs text-slate-400 mt-1">Try a different registration</p>
                      </div>
                    )}
                  </div>
                </>
              )}
            </div>

            <div className="divider divider-horizontal mx-1"></div>

            {/* All Vehicles Button */}
            <button
              className={`btn btn-sm ${activeFilters.length === 0 ? "btn-primary" : "btn-outline"}`}
              onClick={() => setActiveFilters([])}
            >
              All Vehicles ({vehicles.length})
            </button>

            <div className="divider divider-horizontal mx-1"></div>

            {/* Consolidated Filters Dropdown */}
            <div className="dropdown">
              <button
                className={`btn btn-sm ${activeFilters.length > 0 ? "btn-primary" : "btn-outline"}`}
                onClick={() => setShowFiltersDropdown(!showFiltersDropdown)}
              >
                Filters {activeFilters.length > 0 && `(${activeFilters.length} active)`}
                <span className="ml-1">{showFiltersDropdown ? "‚ñ≤" : "‚ñº"}</span>
              </button>

              {showFiltersDropdown && (
                <div className="dropdown-content z-10 menu p-4 shadow bg-base-100 rounded-box w-[calc(100vw-2rem)] sm:w-96 max-w-96 mt-2 right-0 sm:right-auto max-h-[60vh] overflow-y-auto">
                  <div className="flex justify-between items-center mb-3">
                    <h4 className="font-semibold">Filter Vehicles</h4>
                    {activeFilters.length > 0 && (
                      <button
                        className="btn btn-ghost btn-xs"
                        onClick={() => setActiveFilters([])}
                      >
                        Clear All
                      </button>
                    )}
                  </div>

                  <div className="space-y-4">
                    {/* PREP TASKS Section */}
                    <div>
                      <p className="text-xs font-semibold text-base-content/60 mb-2 uppercase">Prep Tasks</p>
                      <div className="space-y-1">
                        {[
                          { key: "awaiting_pdi", label: "Awaiting PDI" },
                          { key: "awaiting_valet", label: "Awaiting Valet" },
                          { key: "awaiting_photos", label: "Awaiting Photos" },
                          { key: "awaiting_mot", label: "Awaiting MOT Check" },
                        ].map(filter => (
                          <label key={filter.key} className="flex items-center gap-2 cursor-pointer hover:bg-base-200 p-2 rounded">
                            <input
                              type="checkbox"
                              className="checkbox checkbox-sm"
                              checked={activeFilters.includes(filter.key)}
                              onChange={() => toggleFilter(filter.key)}
                            />
                            <span className="text-sm flex-1">{filter.label}</span>
                            <span className="badge badge-sm">{getFilterCount(filter.key)}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div className="divider my-1"></div>

                    {/* ISSUES Section */}
                    <div>
                      <p className="text-xs font-semibold text-base-content/60 mb-2 uppercase">Issues</p>
                      <div className="space-y-1">
                        {[
                          { key: "needs_paint", label: "Needs Paint" },
                          { key: "needs_mechanical", label: "Needs Mechanical" },
                          { key: "needs_electrical", label: "Needs Electrical" },
                        ].map(filter => (
                          <label key={filter.key} className="flex items-center gap-2 cursor-pointer hover:bg-base-200 p-2 rounded">
                            <input
                              type="checkbox"
                              className="checkbox checkbox-sm"
                              checked={activeFilters.includes(filter.key)}
                              onChange={() => toggleFilter(filter.key)}
                            />
                            <span className="text-sm flex-1">{filter.label}</span>
                            <span className="badge badge-sm">{getFilterCount(filter.key)}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div className="divider my-1"></div>

                    {/* LOCATION Section */}
                    <div>
                      <p className="text-xs font-semibold text-base-content/60 mb-2 uppercase">Location</p>
                      <label className="flex items-center gap-2 cursor-pointer hover:bg-base-200 p-2 rounded">
                        <input
                          type="checkbox"
                          className="checkbox checkbox-sm"
                          checked={activeFilters.includes("offsite")}
                          onChange={() => toggleFilter("offsite")}
                        />
                        <span className="text-sm flex-1">Offsite Only</span>
                        <span className="badge badge-sm">{getFilterCount("offsite")}</span>
                      </label>
                    </div>

                    <div className="divider my-1"></div>

                    {/* SALE TYPE Section */}
                    <div>
                      <p className="text-xs font-semibold text-base-content/60 mb-2 uppercase">Sale Type</p>
                      <div className="space-y-1">
                        {[
                          { key: "trade_only", label: "Trade Only" },
                          { key: "retail_only", label: "Retail Only" },
                        ].map(filter => (
                          <label key={filter.key} className="flex items-center gap-2 cursor-pointer hover:bg-base-200 p-2 rounded">
                            <input
                              type="checkbox"
                              className="checkbox checkbox-sm"
                              checked={activeFilters.includes(filter.key)}
                              onChange={() => toggleFilter(filter.key)}
                            />
                            <span className="text-sm flex-1">{filter.label}</span>
                            <span className="badge badge-sm">{getFilterCount(filter.key)}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div className="divider my-1"></div>

                    {/* MOT STATUS Section */}
                    <div>
                      <p className="text-xs font-semibold text-base-content/60 mb-2 uppercase">MOT Status</p>
                      <div className="space-y-1">
                        {[
                          { key: "mot_expired", label: "MOT Expired" },
                          { key: "mot_due_soon", label: "MOT Due Soon" },
                        ].map(filter => (
                          <label key={filter.key} className="flex items-center gap-2 cursor-pointer hover:bg-base-200 p-2 rounded">
                            <input
                              type="checkbox"
                              className="checkbox checkbox-sm"
                              checked={activeFilters.includes(filter.key)}
                              onChange={() => toggleFilter(filter.key)}
                            />
                            <span className="text-sm flex-1">{filter.label}</span>
                            <span className="badge badge-sm">{getFilterCount(filter.key)}</span>
                          </label>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
      </div>

      {isLoading ? (
        <div className="flex justify-center py-20">
          <span className="loading loading-spinner loading-lg"></span>
        </div>
      ) : (
        <>
          {/* Mobile Column Tabs */}
          <div className="md:hidden mb-4 overflow-x-auto">
            <div className="flex gap-1 p-1 bg-slate-100 rounded-xl min-w-max">
              {COLUMNS.map((col) => {
                const count = getVehiclesByStatus(col.key).length;
                return (
                  <button
                    key={col.key}
                    onClick={() => setMobileActiveColumn(col.key)}
                    className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${
                      mobileActiveColumn === col.key
                        ? "bg-white shadow-sm text-slate-900"
                        : "text-slate-500 hover:text-slate-700"
                    }`}
                  >
                    <span>{col.label}</span>
                    <span className={`px-1.5 py-0.5 rounded text-xs font-bold ${
                      mobileActiveColumn === col.key ? "bg-slate-100" : "bg-slate-200/50"
                    }`}>
                      {count}
                    </span>
                  </button>
                );
              })}
            </div>
          </div>

          {/* Mobile Single Column View */}
          <div className="md:hidden">
            {COLUMNS.filter(col => col.key === mobileActiveColumn).map((col) => {
              const columnVehicles = getVehiclesByStatus(col.key);
              return (
                <div key={col.key} className="space-y-3">
                  {columnVehicles.map((vehicle) => {
                    const tasks = vehicle.tasks || [];
                    const completedTasks = tasks.filter(t => t.status === "done").length;
                    const motStatus = getMOTStatus(vehicle.motExpiryDate);
                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);
                    const daysInStock = vehicle.createdAt
                      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
                      : 0;

                    return (
                      <div
                        key={vehicle.id}
                        className={`bg-white rounded-xl shadow-md border-l-4 ${col.accent} overflow-hidden active:scale-[0.98] transition-transform`}
                        onClick={() => openVehicleDrawer(vehicle)}
                      >
                        <div className="p-4">
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1">
                              <p className="font-bold text-slate-900 text-base">
                                {vehicle.year || ""} {vehicle.make} {vehicle.model}
                              </p>
                              <p className="text-sm text-slate-500 font-mono">{vehicle.regCurrent}</p>
                            </div>
                            <span className="text-xs text-slate-400">{daysInStock}d</span>
                          </div>
                          <div className="flex gap-1.5 flex-wrap mb-2">
                            {vehicle.saleType === "TRADE" && (
                              <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-slate-800 text-white">TRADE</span>
                            )}
                            {motStatus?.type === "expired" && (
                              <span className="px-2 py-0.5 rounded text-[10px] font-semibold bg-red-100 text-red-700">MOT Expired</span>
                            )}
                            {Object.entries(issueCounts).map(([category, count]) => (
                              <span key={category} className="px-2 py-0.5 rounded text-[10px] font-semibold bg-rose-100 text-rose-700">
                                {count} {category}
                              </span>
                            ))}
                          </div>
                          {tasks.length > 0 && (
                            <div className="flex items-center gap-2">
                              <div className="flex-1 bg-slate-100 rounded-full h-1.5">
                                <div className={`h-1.5 rounded-full ${col.accentBg}`} style={{ width: `${(completedTasks / tasks.length) * 100}%` }}></div>
                              </div>
                              <span className="text-[10px] text-slate-500 font-medium">{completedTasks}/{tasks.length}</span>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                  {columnVehicles.length === 0 && (
                    <div className="text-center py-12 text-slate-400">
                      <p className="text-sm">No vehicles in {col.label}</p>
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* Mobile Floating Action Button */}
          <button
            onClick={() => setShowAddModal(true)}
            className="md:hidden fixed bottom-20 right-4 z-40 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all active:scale-95"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </button>

          {/* Desktop Multi-Column View */}
          <div className="hidden md:flex gap-4 overflow-x-auto pb-6">
            {COLUMNS.map((col) => {
              const columnVehicles = getVehiclesByStatus(col.key);
              return (
                <div
                  key={col.key}
                  data-column-key={col.key}
                  className={`flex-shrink-0 w-64 bg-gradient-to-b ${col.gradient} to-transparent rounded-2xl p-3 min-h-[400px]`}
                  onDragOver={handleDragOver}
                onDrop={(e) => handleDrop(e, col.key)}
              >
                {/* Integrated Header */}
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <h3 className="font-semibold text-slate-700 text-sm">
                      {col.label}
                    </h3>
                    <span className="bg-slate-900/10 text-slate-700 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center">
                      {columnVehicles.length}
                    </span>
                  </div>
                  <div className="dropdown dropdown-end">
                    <label tabIndex={0} className="btn btn-ghost btn-xs gap-1 bg-white/30 backdrop-blur-sm hover:bg-white/50 rounded-full">
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                      </svg>
                      <span className="text-xs">
                        {columnSortOptions[col.key] === "newest_first" ? "Newest" :
                         columnSortOptions[col.key] === "alphabetical" ? "A-Z" : "Oldest"}
                      </span>
                    </label>
                    <ul tabIndex={0} className="dropdown-content z-30 menu p-2 shadow-lg bg-white rounded-xl w-44 mt-2">
                      <li>
                        <button
                          className={`rounded-lg ${columnSortOptions[col.key] === "oldest_first" || !columnSortOptions[col.key] ? "active bg-slate-100" : ""}`}
                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "oldest_first" }))}
                        >
                          Oldest First
                        </button>
                      </li>
                      <li>
                        <button
                          className={`rounded-lg ${columnSortOptions[col.key] === "newest_first" ? "active bg-slate-100" : ""}`}
                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "newest_first" }))}
                        >
                          Newest First
                        </button>
                      </li>
                      <li>
                        <button
                          className={`rounded-lg ${columnSortOptions[col.key] === "alphabetical" ? "active bg-slate-100" : ""}`}
                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "alphabetical" }))}
                        >
                          Alphabetical (Make/Model)
                        </button>
                      </li>
                    </ul>
                  </div>
                </div>

                {/* Cards Container */}
                <div className="space-y-3">
                  {columnVehicles.map((vehicle) => {
                    const tasks = vehicle.tasks || [];
                    const completedTasks = tasks.filter(t => t.status === "done").length;
                    const motStatus = getMOTStatus(vehicle.motExpiryDate);
                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);

                    // Calculate days in stock
                    const daysInStock = vehicle.createdAt
                      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
                      : 0;

                    return (
                      <div
                        key={vehicle.id}
                        draggable
                        onDragStart={(e) => handleDragStart(e, vehicle)}
                        className={`bg-white rounded-xl shadow-xl shadow-slate-900/5 cursor-grab active:cursor-grabbing hover:shadow-2xl hover:shadow-slate-900/10 hover:-translate-y-0.5 transition-all duration-200 border-l-[6px] ${col.accent} overflow-hidden`}
                        onClick={() => openVehicleDrawer(vehicle)}
                      >
                        <div className="p-3">
                          {/* Title */}
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1 min-w-0">
                              <p className="font-bold text-slate-900 text-sm leading-tight truncate">
                                {vehicle.year || ""} {vehicle.make} {vehicle.model}
                              </p>
                              <p className="text-xs text-slate-500 font-mono mt-0.5">{vehicle.regCurrent}</p>
                            </div>
                          </div>

                          {/* Tags */}
                          <div className="flex gap-1.5 flex-wrap mb-2">
                            {/* Trade badge - only show for trade vehicles */}
                            {vehicle.saleType === "TRADE" && (
                              <span className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-slate-800 text-white uppercase">
                                Trade
                              </span>
                            )}
                            {motStatus?.type === "expired" && (
                              <span className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-semibold bg-red-100 text-red-700">
                                MOT Expired
                              </span>
                            )}
                            {motStatus?.type === "due_soon" && (
                              <span className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-semibold bg-amber-100 text-amber-700">
                                MOT Due
                              </span>
                            )}
                            {Object.entries(issueCounts).map(([category, count]) => (
                              <span key={category} className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-semibold bg-rose-100 text-rose-700">
                                {count} {category}
                              </span>
                            ))}
                            {vehicle.locationId && (
                              <span className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-semibold bg-indigo-100 text-indigo-700">
                                üìç {vehicle.locationId.name}
                              </span>
                            )}
                          </div>

                          {/* Progress Bar */}
                          {tasks.length > 0 && (
                            <div className="mb-2">
                              <div className="flex items-center justify-between mb-1">
                                <span className="text-[10px] font-semibold text-slate-600">
                                  {completedTasks}/{tasks.length} tasks
                                </span>
                                <span className="text-[10px] font-semibold text-slate-400">
                                  {Math.round((completedTasks / tasks.length) * 100)}%
                                </span>
                              </div>
                              <div className="w-full bg-slate-100 rounded-full h-1.5">
                                <div
                                  className={`h-1.5 rounded-full transition-all ${col.accentBg}`}
                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}
                                ></div>
                              </div>
                            </div>
                          )}

                          {/* Footer - Days in Stock */}
                          <div className="pt-2 border-t border-slate-100 flex items-center justify-between">
                            <span className={`text-[10px] font-semibold ${daysInStock > 30 ? "text-red-600" : "text-slate-400"}`}>
                              {daysInStock}d in stock
                            </span>
                            {daysInStock > 30 && (
                              <span className="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold bg-red-50 text-red-600">
                                ‚ö†Ô∏è
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}

                  {/* Empty State */}
                  {columnVehicles.length === 0 && (
                    <div className="text-center py-8 px-4">
                      <div className="w-12 h-12 mx-auto mb-3 rounded-full bg-white/50 flex items-center justify-center">
                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                      </div>
                      <p className="text-sm text-slate-500 font-medium">No vehicles</p>
                      <p className="text-xs text-slate-400 mt-1">Drag cards here to move</p>
                    </div>
                  )}
                </div>
              </div>
            );
          })}
          </div>
        </>
      )}

      {/* Vehicle Detail Drawer - Full Screen on Mobile */}
      {selectedVehicle && (
        <div className="fixed inset-0 z-50 flex justify-end">
          <div className="bg-black/50 absolute inset-0 hidden md:block" onClick={() => setSelectedVehicle(null)}></div>
          <div className="relative bg-white w-full md:max-w-3xl h-full overflow-y-auto flex flex-col">
            {/* Sticky Header */}
            <div className="sticky top-0 bg-white border-b border-slate-200 px-4 md:px-6 py-3 md:py-4 flex justify-between items-center z-10">
              <div className="flex items-center gap-3">
                {/* Back button on mobile */}
                <button className="md:hidden btn btn-ghost btn-sm btn-circle" onClick={() => setSelectedVehicle(null)}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <div>
                  <h2 className="text-lg md:text-xl font-bold text-slate-900">
                    {selectedVehicle.year || ""} {selectedVehicle.make} {selectedVehicle.model}
                  </h2>
                  <p className="text-xs md:text-sm text-slate-500 font-mono mt-0.5">{selectedVehicle.regCurrent}</p>
                </div>
              </div>
              <div className="flex items-center gap-1 md:gap-2">
                <button className="hidden md:flex btn btn-outline btn-sm" onClick={handlePrintVehicle} title="Print vehicle details">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                  </svg>
                  Print
                </button>
                <button
                  className="btn btn-ghost btn-sm text-error"
                  onClick={async () => {
                    if (confirm("Delete this vehicle?")) {
                      await fetch(`/api/vehicles/${selectedVehicle.id}`, { method: "DELETE" });
                      setSelectedVehicle(null);
                      fetchVehicles();
                      toast.success("Vehicle deleted");
                    }
                  }}
                  title="Delete vehicle"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
                <button className="hidden md:flex btn btn-ghost btn-sm" onClick={() => setSelectedVehicle(null)}>
                  ‚úï
                </button>
              </div>
            </div>

            {/* Tabs - Underline Style - Scrollable on mobile */}
            <div className="sticky top-[57px] md:top-[73px] bg-white border-b border-slate-200 px-4 md:px-6 z-10 overflow-x-auto">
              <div className="flex gap-4 md:gap-6 min-w-max">
                <button
                  className={`py-3 text-sm font-medium border-b-2 transition-colors ${
                    activeTab === "overview"
                      ? "border-indigo-600 text-indigo-600"
                      : "border-transparent text-slate-500 hover:text-slate-700"
                  }`}
                  onClick={() => setActiveTab("overview")}
                >
                  Overview
                </button>
                <button
                  className={`py-3 text-sm font-medium border-b-2 transition-colors ${
                    activeTab === "checklist"
                      ? "border-indigo-600 text-indigo-600"
                      : "border-transparent text-slate-500 hover:text-slate-700"
                  }`}
                  onClick={() => setActiveTab("checklist")}
                >
                  Prep Checklist
                </button>
                <button
                  className={`py-3 text-sm font-medium border-b-2 transition-colors ${
                    activeTab === "issues"
                      ? "border-indigo-600 text-indigo-600"
                      : "border-transparent text-slate-500 hover:text-slate-700"
                  }`}
                  onClick={() => setActiveTab("issues")}
                >
                  Issues {selectedVehicle.issues?.length > 0 && `(${selectedVehicle.issues.length})`}
                </button>
                <button
                  className={`py-3 text-sm font-medium border-b-2 transition-colors ${
                    activeTab === "documents"
                      ? "border-indigo-600 text-indigo-600"
                      : "border-transparent text-slate-500 hover:text-slate-700"
                  }`}
                  onClick={() => setActiveTab("documents")}
                >
                  Documents {selectedVehicle.documents?.length > 0 && `(${selectedVehicle.documents.length})`}
                </button>
              </div>
            </div>

            <div className="p-6 space-y-6">
              {/* Debug info - remove after fixing */}
              <div className="bg-yellow-100 p-2 text-xs rounded">
                <p>Debug: activeTab = {activeTab}</p>
                <p>Tasks count: {selectedVehicle.tasks?.length || 0}</p>
                <p>Issues count: {selectedVehicle.issues?.length || 0}</p>
                <p>Documents count: {selectedVehicle.documents?.length || 0}</p>
              </div>

              {/* Overview Tab */}
              {activeTab === "overview" && (
                <div className="space-y-6">
                  {/* Identity Section */}
                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <h3 className="text-sm font-semibold text-slate-900 mb-4">Identity</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Registration</label>
                        <input
                          type="text"
                          className="input input-sm bg-slate-50 border-slate-200 text-slate-900"
                          value={selectedVehicle.regCurrent || ""}
                          onChange={(e) => setSelectedVehicle({ ...selectedVehicle, regCurrent: e.target.value.toUpperCase() })}
                          onBlur={async () => {
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ regCurrent: selectedVehicle.regCurrent }),
                            });
                            fetchVehicles();
                          }}
                        />
                      </div>
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">VIN</label>
                        <input
                          type="text"
                          className="input input-sm bg-slate-50 border-slate-200 text-slate-900"
                          value={selectedVehicle.vin || ""}
                          onChange={(e) => setSelectedVehicle({ ...selectedVehicle, vin: e.target.value })}
                          onBlur={async () => {
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ vin: selectedVehicle.vin }),
                            });
                            fetchVehicles();
                          }}
                        />
                      </div>
                    </div>
                  </div>

                  {/* Status & Location Section - Now below Identity */}
                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <h3 className="text-sm font-semibold text-slate-900 mb-4">Status & Location</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Vehicle Type</label>
                        <select
                          className="select select-sm select-bordered w-full"
                          value={selectedVehicle.type || "STOCK"}
                          onChange={async (e) => {
                            const newType = e.target.value;
                            const updates = { type: newType };
                            // Clear saleType if not Stock
                            if (newType !== "STOCK") {
                              updates.saleType = null;
                            }
                            setSelectedVehicle({ ...selectedVehicle, ...updates });
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify(updates),
                            });
                            fetchVehicles();
                            toast.success("Vehicle type updated");
                          }}
                        >
                          <option value="STOCK">Stock</option>
                          <option value="COURTESY">Courtesy</option>
                          <option value="FLEET_OTHER">Fleet</option>
                        </select>
                      </div>
                      {/* Sale Type - Only show for Stock vehicles */}
                      {(selectedVehicle.type === "STOCK" || !selectedVehicle.type) && (
                        <div className="form-control">
                          <label className="text-xs font-medium text-slate-600 mb-1 block">Sale Type</label>
                          <select
                            className="select select-sm select-bordered w-full"
                            value={selectedVehicle.saleType || "RETAIL"}
                            onChange={async (e) => {
                              const newSaleType = e.target.value;
                              setSelectedVehicle({ ...selectedVehicle, saleType: newSaleType });
                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ saleType: newSaleType }),
                              });
                              fetchVehicles();
                              toast.success("Sale type updated");
                            }}
                          >
                            <option value="RETAIL">Retail</option>
                            <option value="TRADE">Trade</option>
                          </select>
                        </div>
                      )}
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Status</label>
                        <select
                          className="select select-sm select-bordered w-full"
                          value={selectedVehicle.status || "in_stock"}
                          onChange={async (e) => {
                            const newStatus = e.target.value;
                            setSelectedVehicle({ ...selectedVehicle, status: newStatus });
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ status: newStatus }),
                            });
                            fetchVehicles();
                            toast.success(`Status updated to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);
                          }}
                        >
                          {COLUMNS.map(col => (
                            <option key={col.key} value={col.key}>{col.label}</option>
                          ))}
                        </select>
                      </div>
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Location</label>
                        <select
                          className="select select-sm select-bordered w-full"
                          value={selectedVehicle.locationId?.id || selectedVehicle.locationId?._id || selectedVehicle.locationId || ""}
                          onChange={async (e) => {
                            const value = e.target.value;
                            if (value === "__add_new__") {
                              setShowAddLocationModal(true);
                              return;
                            }
                            const locationId = value || null;
                            setSelectedVehicle({ ...selectedVehicle, locationId: locationId });
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ locationId }),
                            });
                            const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
                            setSelectedVehicle(updated);
                            fetchVehicles();
                            toast.success("Location updated");
                          }}
                        >
                          <option value="">On Site</option>
                          {locations.map(loc => (
                            <option key={loc.id || loc._id} value={loc.id || loc._id}>{loc.name}</option>
                          ))}
                          <option value="__add_new__">+ Add Location</option>
                        </select>
                      </div>
                    </div>
                  </div>

                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                      <h3 className="text-sm font-semibold text-slate-900 mb-4">Specs</h3>
                      <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-3">
                          <div className="form-control">
                            <label className="label label-text text-xs">Make</label>
                            <input
                              type="text"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.make || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, make: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ make: selectedVehicle.make }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>

                          <div className="form-control">
                            <label className="label label-text text-xs">Model</label>
                            <input
                              type="text"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.model || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, model: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ model: selectedVehicle.model }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div className="form-control">
                            <label className="label label-text text-xs">Year</label>
                            <input
                              type="number"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.year || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, year: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ year: selectedVehicle.year }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>

                          <div className="form-control">
                            <label className="label label-text text-xs">Mileage</label>
                            <input
                              type="number"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.mileageCurrent || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, mileageCurrent: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ mileageCurrent: selectedVehicle.mileageCurrent }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div className="form-control">
                            <label className="label label-text text-xs">Colour</label>
                            <input
                              type="text"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.colour || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, colour: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ colour: selectedVehicle.colour }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>

                          <div className="form-control">
                            <label className="label label-text text-xs">Fuel Type</label>
                            <select
                              className="select select-sm select-bordered"
                              value={selectedVehicle.fuelType || ""}
                              onChange={async (e) => {
                                const newValue = e.target.value;
                                setSelectedVehicle({ ...selectedVehicle, fuelType: newValue });
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ fuelType: newValue }),
                                });
                                fetchVehicles();
                              }}
                            >
                              <option value="">Select...</option>
                              <option value="Petrol">Petrol</option>
                              <option value="Diesel">Diesel</option>
                              <option value="Hybrid">Hybrid</option>
                              <option value="Electric">Electric</option>
                            </select>
                          </div>
                        </div>

                        <div className="form-control">
                          <label className="label label-text text-xs">MOT Expiry Date</label>
                          <input
                            type="date"
                            className="input input-sm input-bordered"
                            value={selectedVehicle.motExpiryDate ? new Date(selectedVehicle.motExpiryDate).toISOString().split('T')[0] : ""}
                            onChange={async (e) => {
                              const newValue = e.target.value;
                              setSelectedVehicle({ ...selectedVehicle, motExpiryDate: newValue });
                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ motExpiryDate: newValue }),
                              });
                              fetchVehicles();
                            }}
                          />
                        </div>
                      </div>
                    </div>

                  <div className="card bg-base-200">
                    <div className="card-body p-4">
                      <h3 className="font-semibold mb-2">V5 Document</h3>
                      {selectedVehicle.v5Url ? (
                        <div>
                          <a href={selectedVehicle.v5Url} target="_blank" rel="noopener noreferrer" className="btn btn-sm btn-outline w-full mb-2">
                            View V5 Document
                          </a>
                          <label className="btn btn-sm btn-ghost w-full">
                            Replace V5
                            <input type="file" accept="image/*,.pdf" className="hidden" onChange={(e) => uploadV5(e.target.files[0])} />
                          </label>
                        </div>
                      ) : (
                        <label className="btn btn-primary btn-sm w-full">
                          Upload V5
                          <input type="file" accept="image/*,.pdf" className="hidden" onChange={(e) => uploadV5(e.target.files[0])} />
                        </label>
                      )}
                    </div>
                  </div>

                  {selectedVehicle.notes && (
                    <div className="card bg-base-200">
                      <div className="card-body p-4">
                        <h3 className="font-semibold mb-2">Notes</h3>
                        <p className="text-sm whitespace-pre-wrap">{selectedVehicle.notes}</p>
                      </div>
                    </div>
                  )}
                </div>
              )}


              {/* Prep Checklist Tab */}
              {activeTab === "checklist" && (
                <div className="card bg-base-200">
                  <div className="card-body p-4">
                    <h3 className="font-semibold mb-3">Prep Checklist</h3>
                    <div className="space-y-2">
                      {selectedVehicle.tasks?.map((task) => (
                        <div key={task.id} className="flex items-center gap-2 p-2 rounded hover:bg-base-300 group">
                          <select
                            className="select select-bordered select-xs"
                            value={task.status || "pending"}
                            onChange={(e) => updateTaskStatus(task.id, e.target.value)}
                            onClick={(e) => e.stopPropagation()}
                          >
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="done">Done</option>
                            <option value="not_required">Not Required</option>
                          </select>
                          {editingTaskId === task.id ? (
                            <input
                              type="text"
                              className="input input-bordered input-xs flex-1"
                              value={editingTaskName}
                              onChange={(e) => setEditingTaskName(e.target.value)}
                              onBlur={() => {
                                if (editingTaskName.trim() && editingTaskName !== task.name) {
                                  updateTaskName(task.id, editingTaskName);
                                } else {
                                  setEditingTaskId(null);
                                  setEditingTaskName("");
                                }
                              }}
                              onKeyPress={(e) => {
                                if (e.key === "Enter") {
                                  if (editingTaskName.trim() && editingTaskName !== task.name) {
                                    updateTaskName(task.id, editingTaskName);
                                  } else {
                                    setEditingTaskId(null);
                                    setEditingTaskName("");
                                  }
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === "Escape") {
                                  setEditingTaskId(null);
                                  setEditingTaskName("");
                                }
                              }}
                              autoFocus
                            />
                          ) : (
                            <span
                              className={`flex-1 text-sm cursor-pointer ${task.status === "done" ? "line-through text-base-content/50" : ""}`}
                              onClick={() => {
                                setEditingTaskId(task.id);
                                setEditingTaskName(task.name);
                              }}
                              title="Click to edit"
                            >
                              {task.name}
                            </span>
                          )}
                          {task.completedAt && !editingTaskId && (
                            <span className="text-xs text-base-content/50">
                              {formatDate(task.completedAt)}
                            </span>
                          )}
                          <button
                            className="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity"
                            onClick={() => deleteTask(task.id)}
                          >
                            ‚úï
                          </button>
                        </div>
                      ))}
                    </div>
                    <div className="flex gap-2 mt-3">
                      <input
                        type="text"
                        className="input input-bordered input-sm flex-1"
                        placeholder="Add new task..."
                        value={newTaskName}
                        onChange={(e) => setNewTaskName(e.target.value)}
                        onKeyPress={(e) => e.key === "Enter" && addTask()}
                      />
                      <button className="btn btn-primary btn-sm" onClick={addTask}>
                        Add
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Issues Tab */}
              {activeTab === "issues" && (
                <div className="space-y-4">
                  <button
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => setShowAddIssueModal(true)}
                  >
                    + Add Issue
                  </button>

                  {selectedVehicle.issues && selectedVehicle.issues.length > 0 ? (
                    <div className="space-y-3">
                      {selectedVehicle.issues.map((issue) => (
                        <div key={issue.id} className="card bg-base-200">
                          <div className="card-body p-4">
                            {/* Header with badges and status */}
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <span className="badge badge-sm">{issue.category}</span>
                                {issue.subcategory && <span className="badge badge-sm badge-ghost ml-1">{issue.subcategory}</span>}
                              </div>
                              <select
                                className="select select-bordered select-xs"
                                value={issue.status || "Outstanding"}
                                onChange={(e) => updateIssue(issue.id, { status: e.target.value })}
                              >
                                <option value="Outstanding">Outstanding</option>
                                <option value="Ordered">Ordered</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Complete">Complete</option>
                              </select>
                            </div>

                            {/* Issue details */}
                            <p className="text-sm font-medium">{issue.description}</p>
                            {issue.actionNeeded && (
                              <p className="text-xs text-base-content/60 mt-1">Action: {issue.actionNeeded}</p>
                            )}
                            {issue.notes && (
                              <p className="text-xs text-base-content/60 mt-1">Notes: {issue.notes}</p>
                            )}

                            {/* Photos */}
                            {issue.photos && issue.photos.length > 0 && (
                              <div className="flex flex-wrap gap-2 mt-2">
                                {issue.photos.map((photo, idx) => (
                                  <a key={idx} href={photo} target="_blank" rel="noopener noreferrer">
                                    <img
                                      src={photo}
                                      alt={`Issue photo ${idx + 1}`}
                                      className="w-16 h-16 object-cover rounded-lg hover:opacity-80 transition-opacity border border-base-300"
                                    />
                                  </a>
                                ))}
                              </div>
                            )}

                            {/* Updates Timeline */}
                            <div className="mt-3">
                              <button
                                className="btn btn-ghost btn-xs w-full justify-between"
                                onClick={() => setExpandedIssues(prev => ({
                                  ...prev,
                                  [issue.id]: !prev[issue.id]
                                }))}
                              >
                                <span>
                                  {expandedIssues[issue.id] ? "Hide" : "Show"} Updates
                                  {issue.updates?.length > 0 && ` (${issue.updates.length})`}
                                </span>
                                <span>{expandedIssues[issue.id] ? "‚ñ≤" : "‚ñº"}</span>
                              </button>

                              {expandedIssues[issue.id] && (
                                <div className="mt-3 space-y-3">
                                  {/* Creation timestamp */}
                                  <div className="flex gap-2 text-xs">
                                    <div className="w-1 bg-base-300 rounded"></div>
                                    <p className="text-base-content/60">
                                      Created {formatDate(issue.createdAt)}
                                    </p>
                                  </div>

                                  {/* Updates timeline */}
                                  {issue.updates && issue.updates.length > 0 ? (
                                    issue.updates.map((update, idx) => (
                                      <div key={idx} className="flex gap-2 text-xs">
                                        <div className="w-1 bg-primary rounded"></div>
                                        <div className="flex-1">
                                          <p className="font-medium">{update.userName || "User"}</p>
                                          <p className="text-sm mt-1">{update.content}</p>
                                          <p className="text-base-content/60 mt-1">
                                            {formatDate(update.createdAt)}
                                          </p>
                                        </div>
                                      </div>
                                    ))
                                  ) : (
                                    <p className="text-xs text-base-content/60 text-center py-2">
                                      No updates yet
                                    </p>
                                  )}

                                  {/* Add update input */}
                                  <div className="flex gap-2 mt-3">
                                    <input
                                      type="text"
                                      className="input input-bordered input-sm flex-1"
                                      placeholder="Add an update..."
                                      value={issueUpdateContent[issue.id] || ""}
                                      onChange={(e) => setIssueUpdateContent(prev => ({
                                        ...prev,
                                        [issue.id]: e.target.value
                                      }))}
                                      onKeyPress={(e) => {
                                        if (e.key === "Enter") {
                                          addIssueUpdate(issue.id, issueUpdateContent[issue.id]);
                                        }
                                      }}
                                    />
                                    <button
                                      className="btn btn-primary btn-sm"
                                      onClick={() => addIssueUpdate(issue.id, issueUpdateContent[issue.id])}
                                    >
                                      Add
                                    </button>
                                  </div>
                                </div>
                              )}
                            </div>

                            {/* Delete button */}
                            <div className="flex justify-end mt-2">
                              <button
                                className="btn btn-ghost btn-xs text-error"
                                onClick={() => {
                                  if (confirm("Delete this issue?")) deleteIssue(issue.id);
                                }}
                              >
                                Delete
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-8 text-base-content/60">
                      No issues recorded
                    </div>
                  )}
                </div>
              )}

              {/* Documents Tab */}
              {activeTab === "documents" && (
                <div className="space-y-4">
                  <button
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => setShowAddDocumentModal(true)}
                  >
                    + Add Document/Image
                  </button>

                  {selectedVehicle.documents && selectedVehicle.documents.length > 0 ? (
                    <div className="space-y-3">
                      {selectedVehicle.documents.map((doc) => (
                        <div key={doc.id} className="card bg-base-200">
                          <div className="card-body p-4">
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <p className="text-sm font-medium">{doc.name}</p>
                                <span className="badge badge-sm mt-1">
                                  {doc.type === "v5" && "V5"}
                                  {doc.type === "service_history" && "Service History"}
                                  {doc.type === "fault_codes" && "Fault Codes"}
                                  {doc.type === "other" && "Other"}
                                </span>
                              </div>
                              <div className="flex gap-1">
                                <a
                                  href={doc.url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="btn btn-ghost btn-xs"
                                  onClick={(e) => e.stopPropagation()}
                                >
                                  View
                                </a>
                                <button
                                  className="btn btn-ghost btn-xs text-error"
                                  onClick={() => {
                                    if (confirm("Delete this document?")) deleteDocument(doc.id);
                                  }}
                                >
                                  Delete
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-8 text-base-content/60">
                      No documents uploaded
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {showAddModal && (
        <AddVehicleModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchVehicles(); }} />
      )}

      {showAddIssueModal && (
        <AddIssueModal
          issueForm={issueForm}
          setIssueForm={setIssueForm}
          onClose={() => {
            setShowAddIssueModal(false);
            setIssueForm({
              category: "",
              subcategory: "",
              description: "",
              actionNeeded: "",
              status: "outstanding",
              notes: "",
              photos: [],
            });
          }}
          onSubmit={addIssue}
        />
      )}

      {showAddDocumentModal && (
        <AddDocumentModal
          documentForm={documentForm}
          setDocumentForm={setDocumentForm}
          onClose={() => {
            setShowAddDocumentModal(false);
            setDocumentForm({ name: "", type: "other", file: null });
          }}
          onSubmit={() => {
            if (!documentForm.file) {
              return toast.error("File is required");
            }
            if (documentForm.type === "other" && !documentForm.name) {
              return toast.error("Document name is required for 'Other' type");
            }
            // Generate default name based on type if not "other"
            const docName = documentForm.type === "other"
              ? documentForm.name
              : documentForm.type.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
            uploadDocument(documentForm.file, docName, documentForm.type);
          }}
        />
      )}

      {showAddLocationModal && (
        <AddLocationModal
          onClose={() => setShowAddLocationModal(false)}
          onSuccess={(newLocation) => {
            setLocations([...locations, newLocation]);
            setSelectedVehicle({ ...selectedVehicle, locationId: newLocation.id || newLocation._id });
            fetch(`/api/vehicles/${selectedVehicle.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ locationId: newLocation.id || newLocation._id }),
            }).then(() => {
              fetchVehicles();
              setShowAddLocationModal(false);
            });
          }}
        />
      )}
    </DashboardLayout>
  );
}

function AddVehicleModal({ onClose, onSuccess }) {
  const [isLoading, setIsLoading] = useState(false);
  const [isLookingUp, setIsLookingUp] = useState(false);
  const [locations, setLocations] = useState([]);
  const [prepTemplates, setPrepTemplates] = useState([]);
  const [formData, setFormData] = useState({
    regCurrent: "", make: "", model: "", year: "", mileageCurrent: "",
    fuelType: "", transmission: "", colour: "", notes: "", locationId: "",
    type: "STOCK", // STOCK, COURTESY, FLEET_OTHER
    saleType: "RETAIL", // RETAIL, TRADE - only used when type is STOCK
  });

  // Appraisal lookup state
  const [matchedAppraisal, setMatchedAppraisal] = useState(null);
  const [isCheckingAppraisal, setIsCheckingAppraisal] = useState(false);
  const [appraisalDismissed, setAppraisalDismissed] = useState(false);

  // Document uploads
  const [v5File, setV5File] = useState(null);
  const [serviceHistoryFile, setServiceHistoryFile] = useState(null);
  const [faultCodesFile, setFaultCodesFile] = useState(null);
  const [otherDocuments, setOtherDocuments] = useState([]);

  // Initial issues (array of issues to create with the vehicle)
  const [initialIssues, setInitialIssues] = useState([]);
  const [showAddIssueInVehicleModal, setShowAddIssueInVehicleModal] = useState(false);
  const [newIssueForm, setNewIssueForm] = useState({
    category: "",
    subcategory: "",
    description: "",
    actionNeeded: "",
    status: "Outstanding",
    notes: "",
    photos: [],
  });

  // Prep checklist template
  const [selectedTemplate, setSelectedTemplate] = useState("default");

  useEffect(() => {
    fetchLocations();
    fetchPrepTemplates();
  }, []);

  const fetchLocations = async () => {
    try {
      const res = await fetch("/api/locations");
      const data = await res.json();
      setLocations(data);
    } catch (error) {
      console.error("Failed to fetch locations");
    }
  };

  const fetchPrepTemplates = async () => {
    try {
      const res = await fetch("/api/prep-tasks");
      const data = await res.json();
      setPrepTemplates(data);
      // Auto-select first template if available
      if (data.length > 0) setSelectedTemplate("default");
    } catch (error) {
      console.error("Failed to fetch prep templates");
    }
  };

  // Check for existing appraisal when VRM changes
  const checkForAppraisal = async (vrm) => {
    if (!vrm || vrm.length < 2) {
      setMatchedAppraisal(null);
      return;
    }
    setIsCheckingAppraisal(true);
    try {
      const res = await fetch(`/api/appraisals/by-vrm?vrm=${encodeURIComponent(vrm)}`);
      if (res.ok) {
        const appraisal = await res.json();
        setMatchedAppraisal(appraisal);
        setAppraisalDismissed(false);
      } else {
        setMatchedAppraisal(null);
      }
    } catch (error) {
      setMatchedAppraisal(null);
    } finally {
      setIsCheckingAppraisal(false);
    }
  };

  // Import data from matched appraisal
  const importFromAppraisal = () => {
    if (!matchedAppraisal) return;
    setFormData(prev => ({
      ...prev,
      regCurrent: matchedAppraisal.vehicleReg || prev.regCurrent,
      make: matchedAppraisal.vehicleMake || prev.make,
      model: matchedAppraisal.vehicleModel || prev.model,
      year: matchedAppraisal.vehicleYear || prev.year,
      mileageCurrent: matchedAppraisal.mileage || prev.mileageCurrent,
      notes: matchedAppraisal.conditionNotes || prev.notes,
    }));
    setAppraisalDismissed(true);
    toast.success("Imported data from appraisal");
  };

  const handleLookup = async () => {
    if (!formData.regCurrent) return toast.error("Enter registration first");
    setIsLookingUp(true);
    try {
      const res = await fetch("/api/dvla-lookup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ vehicleReg: formData.regCurrent }),
      });
      const data = await res.json();
      if (data.isDummy) showDummyNotification("DVLA API");
      setFormData(prev => ({
        ...prev,
        make: data.make || prev.make,
        model: data.model || prev.model,
        year: data.yearOfManufacture || prev.year,
        colour: data.colour || prev.colour,
        fuelType: data.fuelType || prev.fuelType,
        transmission: data.transmission || prev.transmission,
      }));
    } catch (error) {
      toast.error("Lookup failed");
    } finally {
      setIsLookingUp(false);
    }
  };

  const uploadFile = async (file) => {
    if (!file) return null;
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch("/api/vehicles/upload", {
      method: "POST",
      body: formData,
    });
    if (!res.ok) throw new Error("Upload failed");
    const data = await res.json();
    return data.url;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!formData.regCurrent || !formData.make || !formData.model) {
      return toast.error("Reg, make and model are required");
    }
    setIsLoading(true);
    try {
      // Create vehicle first
      // If "None" is selected, skip default tasks
      // If "default" is selected, create default tasks (don't skip)
      const skipDefault = selectedTemplate === "";
      const vehicleRes = await fetch("/api/vehicles", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...formData, skipDefaultTasks: skipDefault }),
      });
      if (!vehicleRes.ok) {
        const errorData = await vehicleRes.json();
        throw new Error(errorData.error || "Failed to create vehicle");
      }
      const vehicle = await vehicleRes.json();

      // Upload documents
      if (v5File) {
        const v5Url = await uploadFile(v5File);
        await fetch(`/api/vehicles/${vehicle.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ v5Url }),
        });
      }

      if (serviceHistoryFile) {
        const url = await uploadFile(serviceHistoryFile);
        await fetch(`/api/vehicles/${vehicle.id}/documents`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: "Service History", type: "service_history", url }),
        });
      }

      if (faultCodesFile) {
        const url = await uploadFile(faultCodesFile);
        await fetch(`/api/vehicles/${vehicle.id}/documents`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: "Fault Codes", type: "fault_codes", url }),
        });
      }

      // Upload other documents
      for (const doc of otherDocuments) {
        if (doc.file) {
          const url = await uploadFile(doc.file);
          await fetch(`/api/vehicles/${vehicle.id}/documents`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: doc.name || "Document", type: "other", url }),
          });
        }
      }

      // Create initial issues from the array
      for (const issue of initialIssues) {
        await fetch(`/api/vehicles/${vehicle.id}/issues`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: issue.category,
            subcategory: issue.subcategory,
            description: issue.description,
            actionNeeded: issue.actionNeeded,
            status: issue.status || "Outstanding",
            notes: issue.notes,
          }),
        });
      }

      // Create prep tasks based on template
      if (selectedTemplate && prepTemplates.length > 0) {
        for (const template of prepTemplates) {
          await fetch(`/api/vehicles/${vehicle.id}/tasks`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: template.name }),
          });
        }
      }

      // Link appraisal to vehicle if one was matched
      if (matchedAppraisal && matchedAppraisal.id) {
        await fetch(`/api/appraisals/${matchedAppraisal.id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            decision: "converted",
            vehicleId: vehicle.id,
            decidedAt: new Date(),
          }),
        });
      }

      toast.success("Vehicle added!");
      onSuccess();
    } catch (error) {
      console.error("Error:", error);
      toast.error(error.message);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
        <h3 className="font-bold text-lg mb-4">Add Vehicle</h3>
        <form onSubmit={handleSubmit}>
          {/* Vehicle Details Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Vehicle Details</h4>
            <div className="flex gap-2 mb-4">
              <input
                type="text"
                placeholder="Registration"
                className="input input-bordered flex-1 uppercase font-mono"
                value={formData.regCurrent}
                onChange={(e) => setFormData({ ...formData, regCurrent: e.target.value.toUpperCase() })}
                onBlur={(e) => checkForAppraisal(e.target.value)}
              />
              <button type="button" className="btn btn-secondary" onClick={handleLookup} disabled={isLookingUp}>
                {isLookingUp ? <span className="loading loading-spinner"></span> : "üîç Lookup"}
              </button>
            </div>

            {/* Appraisal Match Alert */}
            {isCheckingAppraisal && (
              <div className="alert mb-4">
                <span className="loading loading-spinner loading-sm"></span>
                <span>Checking for existing appraisals...</span>
              </div>
            )}
            {matchedAppraisal && !appraisalDismissed && (
              <div className="alert alert-info mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div className="flex-1">
                  <p className="font-semibold">Appraisal Found for {matchedAppraisal.vehicleReg}</p>
                  <p className="text-sm opacity-80">
                    {matchedAppraisal.vehicleMake} {matchedAppraisal.vehicleModel} {matchedAppraisal.vehicleYear ? `(${matchedAppraisal.vehicleYear})` : ""}
                    {matchedAppraisal.mileage ? ` ‚Ä¢ ${matchedAppraisal.mileage.toLocaleString()} miles` : ""}
                  </p>
                </div>
                <div className="flex gap-2">
                  <button type="button" className="btn btn-sm btn-primary" onClick={importFromAppraisal}>
                    Import from Appraisal
                  </button>
                  <button type="button" className="btn btn-sm btn-ghost" onClick={() => setAppraisalDismissed(true)}>
                    Enter Manually
                  </button>
                </div>
              </div>
            )}

            <div className="grid grid-cols-2 gap-4">
              <div className="form-control">
                <label className="label"><span className="label-text">Make *</span></label>
                <input type="text" className="input input-bordered" value={formData.make}
                  onChange={(e) => setFormData({ ...formData, make: e.target.value })} required />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Model *</span></label>
                <input type="text" className="input input-bordered" value={formData.model}
                  onChange={(e) => setFormData({ ...formData, model: e.target.value })} required />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Year</span></label>
                <input type="number" className="input input-bordered" value={formData.year}
                  onChange={(e) => setFormData({ ...formData, year: e.target.value })} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Mileage</span></label>
                <input type="number" className="input input-bordered" value={formData.mileageCurrent}
                  onChange={(e) => setFormData({ ...formData, mileageCurrent: e.target.value })} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Colour</span></label>
                <input type="text" className="input input-bordered" value={formData.colour}
                  onChange={(e) => setFormData({ ...formData, colour: e.target.value })} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Fuel Type</span></label>
                <select className="select select-bordered" value={formData.fuelType}
                  onChange={(e) => setFormData({ ...formData, fuelType: e.target.value })}>
                  <option value="">Select...</option>
                  <option value="Petrol">Petrol</option>
                  <option value="Diesel">Diesel</option>
                  <option value="Hybrid">Hybrid</option>
                  <option value="Electric">Electric</option>
                </select>
              </div>
            </div>
          </div>

          {/* Vehicle Type Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Vehicle Type</h4>
            <div className="grid grid-cols-2 gap-4">
              <div className="form-control">
                <label className="label"><span className="label-text">Vehicle Type</span></label>
                <select
                  className="select select-bordered"
                  value={formData.type}
                  onChange={(e) => {
                    const newType = e.target.value;
                    setFormData({
                      ...formData,
                      type: newType,
                      // Clear saleType if not Stock
                      saleType: newType === "STOCK" ? (formData.saleType || "RETAIL") : undefined
                    });
                  }}
                >
                  <option value="STOCK">Stock - For sale</option>
                  <option value="COURTESY">Courtesy - Loan vehicle</option>
                  <option value="FLEET_OTHER">Fleet/Other - Company vehicle</option>
                </select>
              </div>
              {/* Sale Type - Only show for Stock vehicles */}
              {formData.type === "STOCK" && (
                <div className="form-control">
                  <label className="label"><span className="label-text">Sale Type</span></label>
                  <select
                    className="select select-bordered"
                    value={formData.saleType || "RETAIL"}
                    onChange={(e) => setFormData({ ...formData, saleType: e.target.value })}
                  >
                    <option value="RETAIL">Retail - Customer sale</option>
                    <option value="TRADE">Trade - Dealer sale</option>
                  </select>
                </div>
              )}
            </div>
            <label className="label">
              <span className="label-text-alt text-base-content/60">
                {formData.type === "COURTESY" && "This vehicle will be available in courtesy car forms"}
                {formData.type === "FLEET_OTHER" && "This vehicle will not appear in sales board"}
                {formData.type === "STOCK" && formData.saleType === "TRADE" && "Trade vehicles are marked separately and can be filtered"}
                {formData.type === "STOCK" && formData.saleType !== "TRADE" && "This vehicle will go through the normal sales prep flow"}
              </span>
            </label>
          </div>

          {/* Location Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Location</h4>
            <div className="form-control">
              <select
                className="select select-bordered"
                value={formData.locationId}
                onChange={(e) => setFormData({ ...formData, locationId: e.target.value })}
              >
                <option value="">On Site</option>
                {locations.map(loc => (
                  <option key={loc.id} value={loc.id}>{loc.name}</option>
                ))}
              </select>
            </div>
          </div>

          {/* Document Uploads Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Document Uploads (Optional)</h4>
            <div className="space-y-3">
              <div className="form-control">
                <label className="label"><span className="label-text">V5 Document</span></label>
                <input type="file" className="file-input file-input-bordered w-full" accept="image/*,.pdf"
                  onChange={(e) => setV5File(e.target.files[0])} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Service History</span></label>
                <input type="file" className="file-input file-input-bordered w-full" accept="image/*,.pdf"
                  onChange={(e) => setServiceHistoryFile(e.target.files[0])} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Fault Codes</span></label>
                <input type="file" className="file-input file-input-bordered w-full" accept="image/*,.pdf"
                  onChange={(e) => setFaultCodesFile(e.target.files[0])} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Other Documents</span></label>
                <button
                  type="button"
                  className="btn btn-sm btn-outline"
                  onClick={() => setOtherDocuments([...otherDocuments, { name: "", file: null }])}
                >
                  + Add Document/Image
                </button>
                {otherDocuments.map((doc, idx) => (
                  <div key={idx} className="flex gap-2 mt-2">
                    <input
                      type="text"
                      placeholder="Document name"
                      className="input input-sm input-bordered flex-1"
                      value={doc.name}
                      onChange={(e) => {
                        const updated = [...otherDocuments];
                        updated[idx].name = e.target.value;
                        setOtherDocuments(updated);
                      }}
                    />
                    <input
                      type="file"
                      className="file-input file-input-sm file-input-bordered flex-1"
                      onChange={(e) => {
                        const updated = [...otherDocuments];
                        updated[idx].file = e.target.files[0];
                        setOtherDocuments(updated);
                      }}
                    />
                    <button
                      type="button"
                      className="btn btn-sm btn-ghost"
                      onClick={() => setOtherDocuments(otherDocuments.filter((_, i) => i !== idx))}
                    >
                      ‚úï
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Initial Issues Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Initial Issues (Optional)</h4>

            {/* Add Issue Button */}
            <button
              type="button"
              className="btn btn-outline btn-sm w-full mb-3"
              onClick={() => setShowAddIssueInVehicleModal(true)}
            >
              + Add Issue
            </button>

            {/* Issue Summary Cards */}
            {initialIssues.length > 0 && (
              <div className="space-y-2">
                {initialIssues.map((issue, index) => (
                  <div key={index} className="card bg-base-200">
                    <div className="card-body p-3">
                      <div className="flex justify-between items-start gap-2">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="badge badge-sm">{issue.category}</span>
                            {issue.subcategory && (
                              <span className="badge badge-sm badge-ghost">{issue.subcategory}</span>
                            )}
                          </div>
                          <p className="text-sm font-medium truncate">{issue.description}</p>
                          {issue.actionNeeded && (
                            <p className="text-xs text-base-content/60 mt-1">Action: {issue.actionNeeded}</p>
                          )}
                        </div>
                        <button
                          type="button"
                          className="btn btn-ghost btn-xs text-error"
                          onClick={() => {
                            setInitialIssues(initialIssues.filter((_, i) => i !== index));
                          }}
                        >
                          ‚úï
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Prep Checklist Template Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Prep Checklist Template</h4>
            <div className="form-control">
              <select
                className="select select-bordered"
                value={selectedTemplate}
                onChange={(e) => setSelectedTemplate(e.target.value)}
              >
                <option value="">None - add tasks manually</option>
                <option value="default">Standard Prep (5 tasks)</option>
              </select>
            </div>

            {/* Task Preview for Standard Prep */}
            {selectedTemplate === "default" && (
              <div className="mt-3 p-3 bg-base-200 rounded-lg">
                <p className="text-xs font-semibold text-base-content/70 mb-2">Tasks included:</p>
                <div className="text-xs text-base-content/60 space-y-1">
                  {["PDI", "Valet", "Photos", "MOT Check", "Advert"].map((task, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <span className="text-primary">‚úì</span>
                      <span>{task}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Notes Section */}
          <div className="mb-6">
            <div className="form-control">
              <label className="label"><span className="label-text">Additional Notes</span></label>
              <textarea className="textarea textarea-bordered" value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}></textarea>
            </div>
          </div>

          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
            <button type="submit" className="btn btn-primary" disabled={isLoading}>
              {isLoading ? <span className="loading loading-spinner"></span> : "Add Vehicle"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>

      {/* Nested Add Issue Modal */}
      {showAddIssueInVehicleModal && (
        <AddIssueModal
          issueForm={newIssueForm}
          setIssueForm={setNewIssueForm}
          onClose={() => {
            setShowAddIssueInVehicleModal(false);
            setNewIssueForm({
              category: "",
              subcategory: "",
              description: "",
              actionNeeded: "",
              status: "Outstanding",
              notes: "",
              photos: [],
            });
          }}
          onSubmit={() => {
            // Validate required fields
            if (!newIssueForm.category || !newIssueForm.subcategory || !newIssueForm.description) {
              return toast.error("Category, subcategory, and description are required");
            }

            // Add issue to the array
            setInitialIssues([...initialIssues, { ...newIssueForm }]);

            // Close modal and reset form
            setShowAddIssueInVehicleModal(false);
            setNewIssueForm({
              category: "",
              subcategory: "",
              description: "",
              actionNeeded: "",
              status: "Outstanding",
              notes: "",
              photos: [],
            });
            toast.success("Issue added");
          }}
        />
      )}
    </div>
  );
}

function AddIssueModal({ issueForm, setIssueForm, onClose, onSubmit }) {
  const [isLoading, setIsLoading] = useState(false);
  const [photoFiles, setPhotoFiles] = useState([]);
  const [photoPreviews, setPhotoPreviews] = useState([]);
  const [isUploadingPhotos, setIsUploadingPhotos] = useState(false);

  const handlePhotoChange = (e) => {
    const files = Array.from(e.target.files);
    setPhotoFiles(prev => [...prev, ...files]);

    // Create previews
    files.forEach(file => {
      const reader = new FileReader();
      reader.onloadend = () => {
        setPhotoPreviews(prev => [...prev, reader.result]);
      };
      reader.readAsDataURL(file);
    });
  };

  const removePhoto = (index) => {
    setPhotoFiles(prev => prev.filter((_, i) => i !== index));
    setPhotoPreviews(prev => prev.filter((_, i) => i !== index));
  };

  const uploadPhotos = async () => {
    const uploadedUrls = [];
    for (const file of photoFiles) {
      const formData = new FormData();
      formData.append("file", file);
      const res = await fetch("/api/vehicles/upload", {
        method: "POST",
        body: formData,
      });
      if (res.ok) {
        const data = await res.json();
        uploadedUrls.push(data.url);
      }
    }
    return uploadedUrls;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    try {
      // Upload photos first if any
      let photoUrls = [];
      if (photoFiles.length > 0) {
        setIsUploadingPhotos(true);
        photoUrls = await uploadPhotos();
        setIsUploadingPhotos(false);
      }
      // Pass photo URLs to onSubmit
      await onSubmit(photoUrls);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box max-w-2xl">
        <h3 className="font-bold text-lg mb-4">Add Issue</h3>
        <form onSubmit={handleSubmit}>
          <div className="grid grid-cols-2 gap-4">
            <div className="form-control">
              <label className="label"><span className="label-text">Category *</span></label>
              <select
                className="select select-bordered"
                value={issueForm.category}
                onChange={(e) => {
                  setIssueForm({ ...issueForm, category: e.target.value, subcategory: "" });
                }}
                required
              >
                <option value="">Select category...</option>
                <option value="mechanical">Mechanical</option>
                <option value="electrical">Electrical</option>
                <option value="bodywork">Bodywork</option>
                <option value="interior">Interior</option>
                <option value="tyres">Tyres</option>
                <option value="mot">MOT</option>
                <option value="service">Service</option>
                <option value="fault_codes">Fault Codes</option>
                <option value="other">Other</option>
              </select>
            </div>

            {issueForm.category && (
              <div className="form-control">
                <label className="label"><span className="label-text">Subcategory</span></label>
                <select
                  className="select select-bordered"
                  value={issueForm.subcategory}
                  onChange={(e) => setIssueForm({ ...issueForm, subcategory: e.target.value })}
                >
                  <option value="">Select subcategory...</option>
                  {ISSUE_SUBCATEGORIES[issueForm.category]?.map((sub) => (
                    <option key={sub} value={sub}>{sub}</option>
                  ))}
                </select>
              </div>
            )}

            {/* Fault Codes field - only show for fault_codes category */}
            {issueForm.category === "fault_codes" && (
              <div className="form-control col-span-2">
                <label className="label"><span className="label-text">Fault Codes</span></label>
                <input
                  type="text"
                  className="input input-bordered font-mono"
                  value={issueForm.faultCodes || ""}
                  onChange={(e) => setIssueForm({ ...issueForm, faultCodes: e.target.value })}
                  placeholder="e.g. P0301, P0420, C1234"
                />
                <label className="label">
                  <span className="label-text-alt">Enter codes separated by commas</span>
                </label>
              </div>
            )}

            <div className="form-control col-span-2">
              <label className="label"><span className="label-text">Description *</span></label>
              <textarea
                className="textarea textarea-bordered"
                value={issueForm.description}
                onChange={(e) => setIssueForm({ ...issueForm, description: e.target.value })}
                placeholder={issueForm.category === "fault_codes" ? "Describe what the fault codes indicate..." : "Describe the issue..."}
                required
                rows="3"
              ></textarea>
            </div>

            <div className="form-control col-span-2">
              <label className="label"><span className="label-text">Action Needed</span></label>
              <input
                type="text"
                className="input input-bordered"
                value={issueForm.actionNeeded}
                onChange={(e) => setIssueForm({ ...issueForm, actionNeeded: e.target.value })}
                placeholder="What needs to be done?"
              />
            </div>

            <div className="form-control">
              <label className="label"><span className="label-text">Status</span></label>
              <select
                className="select select-bordered"
                value={issueForm.status}
                onChange={(e) => setIssueForm({ ...issueForm, status: e.target.value })}
              >
                <option value="outstanding">Outstanding</option>
                <option value="ordered">Ordered</option>
                <option value="in_progress">In Progress</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>

            <div className="form-control col-span-2">
              <label className="label"><span className="label-text">Notes</span></label>
              <textarea
                className="textarea textarea-bordered"
                value={issueForm.notes}
                onChange={(e) => setIssueForm({ ...issueForm, notes: e.target.value })}
                placeholder="Additional notes..."
                rows="2"
              ></textarea>
            </div>

            {/* Photo Upload */}
            <div className="form-control col-span-2">
              <label className="label"><span className="label-text">Photos</span></label>
              <input
                type="file"
                accept="image/*"
                multiple
                onChange={handlePhotoChange}
                className="file-input file-input-bordered w-full"
              />
              {photoPreviews.length > 0 && (
                <div className="flex flex-wrap gap-2 mt-3">
                  {photoPreviews.map((preview, idx) => (
                    <div key={idx} className="relative">
                      <img src={preview} alt={`Preview ${idx + 1}`} className="w-20 h-20 object-cover rounded-lg" />
                      <button
                        type="button"
                        onClick={() => removePhoto(idx)}
                        className="absolute -top-2 -right-2 btn btn-circle btn-xs btn-error"
                      >
                        ‚úï
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
            <button type="submit" className="btn btn-primary" disabled={isLoading || isUploadingPhotos}>
              {isLoading || isUploadingPhotos ? (
                <>
                  <span className="loading loading-spinner loading-sm"></span>
                  {isUploadingPhotos ? "Uploading photos..." : "Saving..."}
                </>
              ) : "Add Issue"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}

function AddDocumentModal({ documentForm, setDocumentForm, onClose, onSubmit }) {
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    try {
      await onSubmit();
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box">
        <h3 className="font-bold text-lg mb-4">Add Document/Image</h3>
        <form onSubmit={handleSubmit}>
          <div className="space-y-4">
            <div className="form-control">
              <label className="label"><span className="label-text">Document Type</span></label>
              <select
                className="select select-bordered"
                value={documentForm.type}
                onChange={(e) => setDocumentForm({ ...documentForm, type: e.target.value })}
              >
                <option value="v5">V5</option>
                <option value="service_history">Service History</option>
                <option value="fault_codes">Fault Codes</option>
                <option value="other">Other</option>
              </select>
            </div>

            {/* Only show Document Name field when "Other" is selected */}
            {documentForm.type === "other" && (
              <div className="form-control">
                <label className="label"><span className="label-text">Document Name *</span></label>
                <input
                  type="text"
                  className="input input-bordered"
                  value={documentForm.name}
                  onChange={(e) => setDocumentForm({ ...documentForm, name: e.target.value })}
                  placeholder="e.g., MOT Certificate, Insurance"
                  required
                />
              </div>
            )}

            <div className="form-control">
              <label className="label"><span className="label-text">File *</span></label>
              <input
                type="file"
                className="file-input file-input-bordered w-full"
                onChange={(e) => setDocumentForm({ ...documentForm, file: e.target.files[0] })}
                accept="image/*,.pdf,.doc,.docx"
                required
              />
            </div>
          </div>

          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
            <button type="submit" className="btn btn-primary" disabled={isLoading}>
              {isLoading ? <span className="loading loading-spinner"></span> : "Upload Document/Image"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}

function AddLocationModal({ onClose, onSuccess }) {
  const [name, setName] = useState("");
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!name.trim()) return toast.error("Location name is required");

    setIsLoading(true);
    try {
      const res = await fetch("/api/locations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name.trim(), type: "offsite" }),
      });
      if (!res.ok) throw new Error("Failed to create location");
      const newLocation = await res.json();
      toast.success("Location added");
      onSuccess(newLocation);
    } catch (error) {
      toast.error("Failed to add location");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box">
        <h3 className="font-bold text-lg mb-4">Add New Location</h3>
        <form onSubmit={handleSubmit}>
          <div className="form-control">
            <label className="label">
              <span className="label-text">Location Name *</span>
            </label>
            <input
              type="text"
              className="input input-bordered w-full"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g., ABC Body Shop, Paint Centre"
              required
              autoFocus
            />
          </div>
          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>
              Cancel
            </button>
            <button type="submit" className="btn btn-primary" disabled={isLoading}>
              {isLoading ? <span className="loading loading-spinner"></span> : "Add Location"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}
