import crypto from "crypto";
import connectMongo from "@/libs/mongoose";
import Appraisal from "@/models/Appraisal";
import Dealer from "@/models/Dealer";
import { refreshDealerLogoUrl } from "@/libs/r2Client";

// Hash token with SHA256
function hashToken(token) {
  return crypto.createHash("sha256").update(token).digest("hex");
}

// This endpoint is PUBLIC - no auth required
export default async function handler(req, res) {
  if (req.method !== "GET") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  await connectMongo();

  try {
    const { token } = req.query;

    if (!token) {
      return res.status(400).json({ error: "Token is required" });
    }

    // Hash the provided token to find the appraisal
    const tokenHash = hashToken(token);
    const appraisal = await Appraisal.findOne({ shareTokenHash: tokenHash }).lean();

    if (!appraisal) {
      return res.status(404).json({ error: "Invalid or expired link" });
    }

    // Check if link has expired
    if (appraisal.shareExpiresAt && new Date(appraisal.shareExpiresAt) < new Date()) {
      return res.status(403).json({ error: "This link has expired" });
    }

    // Get dealer info for branding
    let dealerInfo = null;
    if (appraisal.dealerId) {
      const dealer = await Dealer.findById(appraisal.dealerId).lean();
      if (dealer) {
        dealerInfo = {
          name: dealer.name,
          logo: dealer.logoUrl,
          phone: dealer.phone,
          email: dealer.email,
        };
      }
    }

    // Return appraisal data (filtered to not include sensitive internal fields)
    return res.status(200).json({
      appraisal: {
        vehicleReg: appraisal.vehicleReg,
        vehicleMake: appraisal.vehicleMake,
        vehicleModel: appraisal.vehicleModel,
        vehicleYear: appraisal.vehicleYear,
        mileage: appraisal.mileage,
        colour: appraisal.colour,
        fuelType: appraisal.fuelType,
        conditionNotes: appraisal.conditionNotes,
        proposedPurchasePrice: appraisal.proposedPurchasePrice,
        decision: appraisal.decision,
        createdAt: appraisal.createdAt,
      },
      dealer: dealerInfo,
    });
  } catch (error) {
    console.error("Error fetching public appraisal:", error);
    return res.status(500).json({ error: "Failed to load appraisal" });
  }
}
