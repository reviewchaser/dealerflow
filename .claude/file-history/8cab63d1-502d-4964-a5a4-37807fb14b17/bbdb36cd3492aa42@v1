/**
 * DVLA Vehicle Enquiry Service API Integration
 *
 * Uses the official DVLA VES API to lookup vehicle details by registration number.
 * API Documentation: https://developer-portal.driver-vehicle-licensing.api.gov.uk/
 */

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  const { vehicleReg } = req.body;
  if (!vehicleReg) {
    return res.status(400).json({ error: "Vehicle registration required" });
  }

  // Clean up registration number - remove spaces and convert to uppercase
  const cleanReg = vehicleReg.toUpperCase().replace(/\s/g, "");

  const apiKey = process.env.DVLA_API_KEY;

  // If no API key, return dummy data for development
  if (!apiKey) {
    console.warn("DVLA_API_KEY not configured - returning dummy data");
    return res.status(200).json(generateDummyData(cleanReg));
  }

  try {
    const response = await fetch(
      "https://driver-vehicle-licensing.api.gov.uk/vehicle-enquiry/v1/vehicles",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": apiKey,
        },
        body: JSON.stringify({
          registrationNumber: cleanReg,
        }),
      }
    );

    if (!response.ok) {
      const errorText = await response.text();
      console.error("DVLA API error:", response.status, errorText);

      // Handle specific error codes
      if (response.status === 404) {
        return res.status(404).json({
          error: "Vehicle not found",
          message: "No vehicle found with this registration number",
        });
      }

      if (response.status === 400) {
        return res.status(400).json({
          error: "Invalid registration",
          message: "The registration number format is invalid",
        });
      }

      if (response.status === 403) {
        return res.status(500).json({
          error: "API access denied",
          message: "DVLA API access denied - check API key",
        });
      }

      return res.status(500).json({
        error: "DVLA lookup failed",
        message: "Unable to retrieve vehicle details",
      });
    }

    const data = await response.json();

    // Transform DVLA response to our format
    const vehicleData = {
      isDummy: false,
      registrationNumber: data.registrationNumber,
      make: data.make,
      model: data.model || "", // DVLA doesn't always return model
      colour: data.colour,
      yearOfManufacture: data.yearOfManufacture,
      engineCapacity: data.engineCapacity,
      fuelType: data.fuelType,
      transmission: data.transmission || "",
      taxStatus: data.taxStatus,
      taxDueDate: data.taxDueDate,
      motStatus: data.motStatus,
      motExpiryDate: data.motExpiryDate,
      // Additional fields from DVLA
      co2Emissions: data.co2Emissions,
      euroStatus: data.euroStatus,
      markedForExport: data.markedForExport,
      typeApproval: data.typeApproval,
      wheelplan: data.wheelplan,
      monthOfFirstRegistration: data.monthOfFirstRegistration,
      dateOfLastV5CIssued: data.dateOfLastV5CIssued,
      revenueWeight: data.revenueWeight,
      realDrivingEmissions: data.realDrivingEmissions,
    };

    return res.status(200).json(vehicleData);
  } catch (error) {
    console.error("DVLA lookup error:", error);
    return res.status(500).json({
      error: "DVLA lookup failed",
      message: error.message || "Unable to connect to DVLA service",
    });
  }
}

/**
 * Generate dummy data for development when API key is not configured
 */
function generateDummyData(vehicleReg) {
  // Generate varied MOT dates for testing
  const rand = Math.random();
  let daysOffset;
  let motStatus;

  if (rand < 0.3) {
    daysOffset = -Math.floor(Math.random() * 90);
    motStatus = "Not valid";
  } else if (rand < 0.5) {
    daysOffset = Math.floor(Math.random() * 30);
    motStatus = "Valid";
  } else {
    daysOffset = Math.floor(Math.random() * 365) + 30;
    motStatus = "Valid";
  }

  const motExpiryDate = new Date();
  motExpiryDate.setDate(motExpiryDate.getDate() + daysOffset);

  return {
    isDummy: true,
    message: "DVLA API not configured - showing demo data",
    registrationNumber: vehicleReg,
    make: "FORD",
    model: "FOCUS",
    colour: "BLUE",
    yearOfManufacture: 2019,
    engineCapacity: 1500,
    fuelType: "PETROL",
    transmission: "MANUAL",
    taxStatus: "Taxed",
    taxDueDate: "2025-03-01",
    motStatus: motStatus,
    motExpiryDate: motExpiryDate.toISOString().split("T")[0],
  };
}
