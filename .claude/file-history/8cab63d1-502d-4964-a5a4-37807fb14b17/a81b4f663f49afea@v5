import { useEffect, useState, useRef } from "react";
import { useRouter } from "next/router";
import Head from "next/head";
import Link from "next/link";
import DashboardLayout from "@/components/DashboardLayout";
import { toast } from "react-hot-toast";

// Column config matching Sales & Prep style
const COLUMNS = [
  { key: "not_booked_in", label: "Not Booked In", gradient: "from-red-100/60", accent: "border-l-red-400", accentBg: "bg-red-400" },
  { key: "on_site", label: "On Site", gradient: "from-amber-100/60", accent: "border-l-amber-400", accentBg: "bg-amber-400" },
  { key: "work_complete", label: "Work Complete", gradient: "from-blue-100/60", accent: "border-l-blue-400", accentBg: "bg-blue-400" },
  { key: "collected", label: "Collected", gradient: "from-emerald-100/60", accent: "border-l-emerald-400", accentBg: "bg-emerald-400" },
];

const PRIORITIES = {
  low: { bg: "bg-slate-100", text: "text-slate-600", border: "border-slate-200" },
  normal: { bg: "bg-blue-50", text: "text-blue-700", border: "border-blue-100" },
  high: { bg: "bg-amber-50", text: "text-amber-700", border: "border-amber-100" },
  critical: { bg: "bg-red-50", text: "text-red-700", border: "border-red-100" },
};

const SOURCE_LABELS = {
  warranty_claim_form: "Warranty Claim",
  low_review: "Low Review",
  complaint_form: "Complaint",
  manual: "Manual",
};

// Timeline event icons
const EVENT_ICONS = {
  CASE_CREATED: "ðŸ“‹",
  SUBMISSION_LINKED: "ðŸ”—",
  COMMENT_ADDED: "ðŸ’¬",
  STATUS_CHANGED: "ðŸ”„",
  AI_REVIEW_GENERATED: "ðŸ¤–",
  ATTACHMENT_ADDED: "ðŸ“Ž",
};

// Helper to calculate days since date
const daysSince = (date) => {
  if (!date) return 0;
  const diff = Date.now() - new Date(date).getTime();
  return Math.floor(diff / (1000 * 60 * 60 * 24));
};

// Helper for relative time display
const relativeTime = (date) => {
  const days = daysSince(date);
  if (days === 0) {
    const hours = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60 * 60));
    if (hours === 0) {
      const mins = Math.floor((Date.now() - new Date(date).getTime()) / (1000 * 60));
      return mins <= 1 ? "Just now" : `${mins}m ago`;
    }
    return `${hours}h ago`;
  }
  if (days === 1) return "Yesterday";
  if (days < 7) return `${days}d ago`;
  if (days < 30) return `${Math.floor(days / 7)}w ago`;
  return `${Math.floor(days / 30)}mo ago`;
};

export default function Warranty() {
  const router = useRouter();
  const [cases, setCases] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedCase, setSelectedCase] = useState(null);
  const [showAddModal, setShowAddModal] = useState(false);
  const [newComment, setNewComment] = useState("");
  const [commentAttachments, setCommentAttachments] = useState([]);
  const [isGeneratingAI, setIsGeneratingAI] = useState(false);
  const [showRegenerateConfirm, setShowRegenerateConfirm] = useState(false);
  const fileInputRef = useRef(null);

  // Drag state - matching Sales & Prep
  const [draggedCard, setDraggedCard] = useState(null);
  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });

  // Column sorting state
  const [columnSortOptions, setColumnSortOptions] = useState({});

  useEffect(() => { fetchCases(); }, []);

  // Auto-open case from query param (e.g., /warranty?caseId=123)
  useEffect(() => {
    if (router.query.caseId && !selectedCase) {
      fetchCaseDetail(router.query.caseId);
    }
  }, [router.query.caseId]);

  const fetchCases = async () => {
    try {
      const res = await fetch("/api/aftercare");
      const data = await res.json();
      setCases(Array.isArray(data) ? data : []);
    } catch (error) {
      toast.error("Failed to load cases");
      setCases([]);
    } finally {
      setIsLoading(false);
    }
  };

  const fetchCaseDetail = async (caseId) => {
    try {
      const res = await fetch(`/api/aftercare/${caseId}`);
      const data = await res.json();
      setSelectedCase(data);
    } catch (error) {
      toast.error("Failed to load case");
    }
  };

  // Drag handlers - matching Sales & Prep exactly
  const handleDragStart = (e, caseItem) => {
    setDraggedCard(caseItem);
    setDragPosition({ x: e.clientX, y: e.clientY });
    e.dataTransfer.effectAllowed = "move";
    // Create invisible drag image (we render our own preview)
    const emptyImg = new Image();
    emptyImg.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
    e.dataTransfer.setDragImage(emptyImg, 0, 0);
  };

  const handleDrag = (e) => {
    if (e.clientX !== 0 && e.clientY !== 0) {
      setDragPosition({ x: e.clientX, y: e.clientY });
    }
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  const handleDragEnd = () => {
    setDraggedCard(null);
  };

  const handleDrop = async (e, newStatus) => {
    e.preventDefault();
    if (!draggedCard || draggedCard.boardStatus === newStatus) {
      setDraggedCard(null);
      return;
    }
    const caseId = draggedCard.id || draggedCard._id;

    // Optimistic update
    setCases(prev => prev.map(c =>
      (c.id || c._id) === caseId ? { ...c, boardStatus: newStatus } : c
    ));

    try {
      await fetch(`/api/aftercare/${caseId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ boardStatus: newStatus }),
      });
      toast.success(`Moved to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);
      // Refresh to get updated events
      fetchCases();
    } catch (error) {
      toast.error("Failed to update");
      fetchCases(); // Revert on error
    }
    setDraggedCard(null);
  };

  const handleFileSelect = async (e) => {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;

    const uploadedFiles = [];
    for (const file of files) {
      const formData = new FormData();
      formData.append("file", file);
      try {
        const res = await fetch("/api/vehicles/upload", { method: "POST", body: formData });
        const data = await res.json();
        if (data.url) {
          uploadedFiles.push({ url: data.url, filename: data.filename || file.name });
        }
      } catch (err) {
        toast.error(`Failed to upload ${file.name}`);
      }
    }
    setCommentAttachments([...commentAttachments, ...uploadedFiles]);
  };

  const addComment = async () => {
    if (!newComment.trim() && commentAttachments.length === 0) return;
    try {
      await fetch(`/api/aftercare/${selectedCase.id}/comments`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: newComment || "(attachment)",
          authorType: "staff",
          attachments: commentAttachments
        }),
      });
      setNewComment("");
      setCommentAttachments([]);
      fetchCaseDetail(selectedCase.id);
      toast.success("Comment added");
    } catch (error) {
      toast.error("Failed to add comment");
    }
  };

  const generateAIReview = async (regenerate = false) => {
    if (regenerate) {
      setShowRegenerateConfirm(false);
    }
    setIsGeneratingAI(true);
    try {
      const res = await fetch("/api/ai/case-review", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ caseId: selectedCase.id }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || "Failed to generate");
      fetchCaseDetail(selectedCase.id);
      toast.success("AI review generated");
    } catch (error) {
      toast.error(error.message);
    } finally {
      setIsGeneratingAI(false);
    }
  };

  const copyToClipboard = (text, label) => {
    navigator.clipboard.writeText(text);
    toast.success(`${label} copied to clipboard`);
  };

  // Get cases by status with sorting
  const getCasesByStatus = (status) => {
    const filtered = cases.filter(c => c.boardStatus === status);
    const sortOption = columnSortOptions[status] || "oldest_first";

    return filtered.sort((a, b) => {
      if (sortOption === "newest_first") {
        return new Date(b.createdAt) - new Date(a.createdAt);
      }
      if (sortOption === "alphabetical") {
        const nameA = a.contactId?.name || "";
        const nameB = b.contactId?.name || "";
        return nameA.localeCompare(nameB);
      }
      // oldest_first (default)
      return new Date(a.createdAt) - new Date(b.createdAt);
    });
  };

  // Calculate attachment count for a case
  const getAttachmentCount = (c) => {
    const caseAttachments = c.attachments?.length || 0;
    const submissionAttachments = c.submissionAttachmentCount || 0;
    const commentAttachments = c.commentAttachmentCount || 0;
    return caseAttachments + submissionAttachments + commentAttachments;
  };

  // Get activity count (events count)
  const getActivityCount = (c) => c.events?.length || 0;

  return (
    <DashboardLayout>
      <Head><title>Customer/Warranty | DealerFlow</title></Head>

      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-3xl font-bold text-slate-900">Customer / Warranty Board</h1>
          <p className="text-slate-500 mt-1">Manage warranty cases and aftercare</p>
        </div>
        <button className="btn btn-primary" onClick={() => setShowAddModal(true)}>
          + New Case
        </button>
      </div>

      {isLoading ? (
        <div className="flex justify-center py-20">
          <span className="loading loading-spinner loading-lg"></span>
        </div>
      ) : (
        <>
          {/* Desktop Multi-Column View - Matching Sales & Prep exactly */}
          <div className="flex gap-4 overflow-x-auto pb-6">
            {COLUMNS.map((col) => {
              const columnCases = getCasesByStatus(col.key);
              return (
                <div
                  key={col.key}
                  data-column-key={col.key}
                  className={`flex-shrink-0 w-64 bg-gradient-to-b ${col.gradient} to-transparent rounded-2xl p-3 min-h-[400px]`}
                  onDragOver={handleDragOver}
                  onDrop={(e) => handleDrop(e, col.key)}
                >
                  {/* Integrated Header - Same as Sales & Prep */}
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <h3 className="font-semibold text-slate-700 text-sm">
                        {col.label}
                      </h3>
                      <span className="bg-slate-900/10 text-slate-700 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center">
                        {columnCases.length}
                      </span>
                    </div>
                    <div className="dropdown dropdown-end">
                      <label tabIndex={0} className="btn btn-ghost btn-xs gap-1 bg-white/30 backdrop-blur-sm hover:bg-white/50 rounded-full">
                        <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                        </svg>
                        <span className="text-xs">
                          {columnSortOptions[col.key] === "newest_first" ? "Newest" :
                           columnSortOptions[col.key] === "alphabetical" ? "A-Z" : "Oldest"}
                        </span>
                      </label>
                      <ul tabIndex={0} className="dropdown-content z-30 menu p-2 shadow-lg bg-white rounded-xl w-44 mt-2">
                        <li>
                          <button
                            className={`rounded-lg ${columnSortOptions[col.key] === "oldest_first" || !columnSortOptions[col.key] ? "active bg-slate-100" : ""}`}
                            onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "oldest_first" }))}
                          >
                            Oldest First
                          </button>
                        </li>
                        <li>
                          <button
                            className={`rounded-lg ${columnSortOptions[col.key] === "newest_first" ? "active bg-slate-100" : ""}`}
                            onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "newest_first" }))}
                          >
                            Newest First
                          </button>
                        </li>
                        <li>
                          <button
                            className={`rounded-lg ${columnSortOptions[col.key] === "alphabetical" ? "active bg-slate-100" : ""}`}
                            onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "alphabetical" }))}
                          >
                            Alphabetical (Name)
                          </button>
                        </li>
                      </ul>
                    </div>
                  </div>

                  {/* Cards Container */}
                  <div className="space-y-3">
                    {columnCases.map((caseItem) => {
                      const daysOpen = daysSince(caseItem.createdAt);
                      const attachmentCount = getAttachmentCount(caseItem);
                      const activityCount = getActivityCount(caseItem);
                      const priorityStyle = PRIORITIES[caseItem.priority] || PRIORITIES.normal;

                      return (
                        <div
                          key={caseItem.id}
                          draggable
                          onDragStart={(e) => handleDragStart(e, caseItem)}
                          onDrag={handleDrag}
                          onDragEnd={handleDragEnd}
                          className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all cursor-grab active:cursor-grabbing border border-slate-100/50 overflow-hidden ${draggedCard?.id === caseItem.id ? "opacity-40 scale-95" : ""}`}
                          onClick={() => fetchCaseDetail(caseItem.id)}
                        >
                          <div className="p-3">
                            {/* Top row: Reg + Warranty badge + Priority */}
                            <div className="flex justify-between items-start mb-2">
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className="font-mono font-bold text-slate-900 text-sm">
                                    {caseItem.regAtPurchase || caseItem.details?.vehicleReg || "No reg"}
                                  </span>
                                  {caseItem.warrantyType && (
                                    <span className="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100">
                                      {caseItem.warrantyType === "Dealer Warranty" ? "Dealer" : "External"}
                                    </span>
                                  )}
                                </div>
                              </div>
                              <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ${priorityStyle.bg} ${priorityStyle.text} border ${priorityStyle.border}`}>
                                {caseItem.priority}
                              </span>
                            </div>

                            {/* Customer name + Vehicle make/model */}
                            <div className="mb-2">
                              <p className="font-semibold text-slate-800 text-sm truncate">
                                {caseItem.contactId?.name || "Unknown"}
                              </p>
                              {caseItem.vehicleId && (
                                <p className="text-xs text-slate-500">
                                  {caseItem.vehicleId.make} {caseItem.vehicleId.model}
                                </p>
                              )}
                              {!caseItem.vehicleId && caseItem.details?.make && (
                                <p className="text-xs text-slate-500">
                                  {caseItem.details.make} {caseItem.details.model}
                                </p>
                              )}
                            </div>

                            {/* Footer row: Days open + icons + source */}
                            <div className="flex items-center justify-between text-xs text-slate-500">
                              <span className="font-medium">{daysOpen}d open</span>
                              <div className="flex items-center gap-2">
                                {attachmentCount > 0 && (
                                  <span className="flex items-center gap-0.5" title="Attachments">
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
                                    </svg>
                                    {attachmentCount}
                                  </span>
                                )}
                                {activityCount > 0 && (
                                  <span className="flex items-center gap-0.5" title="Activity">
                                    <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                    {activityCount}
                                  </span>
                                )}
                                {caseItem.source === "warranty_claim_form" && (
                                  <span className="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] font-medium bg-slate-100 text-slate-600">
                                    Warranty Claim
                                  </span>
                                )}
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })}

                    {columnCases.length === 0 && (
                      <div className="text-center py-12 text-slate-400">
                        <p className="text-sm">No cases in {col.label}</p>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>

          {/* Drag Preview - floating card that follows cursor (same as Sales & Prep) */}
          {draggedCard && (
            <div
              className="fixed pointer-events-none z-50"
              style={{
                left: dragPosition.x - 120,
                top: dragPosition.y - 30,
                transform: "rotate(3deg)",
              }}
            >
              <div className="bg-white rounded-xl shadow-2xl border-2 border-blue-400 w-60 p-3 opacity-90">
                <div className="flex items-center gap-2">
                  <p className="font-bold text-slate-900 text-sm truncate">
                    {draggedCard.contactId?.name || "Unknown"}
                  </p>
                </div>
                <span className="font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md inline-block mt-1">
                  {draggedCard.regAtPurchase || draggedCard.details?.vehicleReg || "No reg"}
                </span>
              </div>
            </div>
          )}
        </>
      )}

      {/* Case Detail Drawer */}
      {selectedCase && (
        <div className="fixed inset-0 z-50 flex justify-end">
          <div className="bg-black/50 absolute inset-0" onClick={() => setSelectedCase(null)}></div>
          <div className="relative bg-base-100 w-full max-w-xl h-full overflow-y-auto">
            {/* Header */}
            <div className="sticky top-0 bg-base-100 border-b border-base-300 p-4 z-10">
              <div className="flex justify-between items-start">
                <div className="flex-1">
                  <div className="flex items-center gap-2 flex-wrap">
                    <h2 className="text-xl font-bold font-mono">
                      {selectedCase.regAtPurchase || selectedCase.details?.vehicleReg || "No Reg"}
                    </h2>
                    {selectedCase.warrantyType && (
                      <span className="badge badge-sm badge-outline">
                        {selectedCase.warrantyType}
                      </span>
                    )}
                    <span className={`badge badge-sm ${PRIORITIES[selectedCase.priority]?.bg} ${PRIORITIES[selectedCase.priority]?.text}`}>
                      {selectedCase.priority}
                    </span>
                  </div>
                  <p className="text-sm text-base-content/60 mt-1">
                    {selectedCase.contactId?.name} &middot; {daysSince(selectedCase.createdAt)}d open
                  </p>
                </div>
                <button className="btn btn-ghost btn-sm" onClick={() => setSelectedCase(null)}>âœ•</button>
              </div>

              <div className="flex gap-2 mt-3">
                <select
                  className="select select-bordered select-sm flex-1"
                  value={selectedCase.boardStatus}
                  onChange={async (e) => {
                    const newStatus = e.target.value;
                    await fetch(`/api/aftercare/${selectedCase.id}`, {
                      method: "PUT",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ boardStatus: newStatus }),
                    });
                    setSelectedCase({ ...selectedCase, boardStatus: newStatus });
                    fetchCases();
                    toast.success(`Moved to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);
                  }}
                >
                  {COLUMNS.map(c => <option key={c.key} value={c.key}>{c.label}</option>)}
                </select>
                <select
                  className="select select-bordered select-sm"
                  value={selectedCase.priority}
                  onChange={async (e) => {
                    await fetch(`/api/aftercare/${selectedCase.id}`, {
                      method: "PUT",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ priority: e.target.value }),
                    });
                    setSelectedCase({ ...selectedCase, priority: e.target.value });
                    fetchCases();
                  }}
                >
                  <option value="low">Low</option>
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
            </div>

            <div className="p-4 space-y-4">
              {/* Customer & Vehicle Section */}
              <div className="card bg-base-200">
                <div className="card-body p-4">
                  <h3 className="font-semibold mb-2">Customer & Vehicle</h3>
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <div><span className="text-base-content/60">Name:</span> {selectedCase.contactId?.name || "â€”"}</div>
                    <div><span className="text-base-content/60">Phone:</span> {selectedCase.contactId?.phone || "â€”"}</div>
                    <div className="col-span-2"><span className="text-base-content/60">Email:</span> {selectedCase.contactId?.email || "â€”"}</div>
                    <div><span className="text-base-content/60">Reg at Purchase:</span> {selectedCase.regAtPurchase || "â€”"}</div>
                    <div><span className="text-base-content/60">Current Reg:</span> {selectedCase.currentReg || selectedCase.details?.vehicleReg || "â€”"}</div>
                    {selectedCase.vehicleId && (
                      <>
                        <div className="col-span-2">
                          <span className="text-base-content/60">Vehicle:</span>{" "}
                          {selectedCase.vehicleId.make} {selectedCase.vehicleId.model} {selectedCase.vehicleId.year}
                        </div>
                        <div className="col-span-2">
                          <Link
                            href={`/sales-prep?vehicleId=${selectedCase.vehicleId._id || selectedCase.vehicleId.id}`}
                            className="btn btn-xs btn-outline"
                          >
                            View Vehicle
                          </Link>
                        </div>
                      </>
                    )}
                  </div>
                </div>
              </div>

              {/* Quick Actions Row */}
              <div className="flex gap-2 flex-wrap">
                {selectedCase.aiReview?.payload ? (
                  <button
                    className="btn btn-sm btn-outline"
                    onClick={() => setShowRegenerateConfirm(true)}
                    disabled={isGeneratingAI}
                  >
                    {isGeneratingAI ? <span className="loading loading-spinner loading-xs"></span> : "Regenerate AI Review"}
                  </button>
                ) : (
                  <button
                    className="btn btn-sm btn-primary"
                    onClick={() => generateAIReview()}
                    disabled={isGeneratingAI}
                  >
                    {isGeneratingAI ? <span className="loading loading-spinner loading-xs"></span> : "Generate AI Review"}
                  </button>
                )}
                <button
                  className="btn btn-sm btn-outline"
                  disabled={!selectedCase.aiReview?.payload?.draftCustomerReply}
                  onClick={() => copyToClipboard(selectedCase.aiReview?.payload?.draftCustomerReply, "Customer reply")}
                >
                  Copy Customer Reply
                </button>
                <button
                  className="btn btn-sm btn-outline"
                  disabled={!selectedCase.aiReview?.payload?.draftInternalNote}
                  onClick={() => copyToClipboard(selectedCase.aiReview?.payload?.draftInternalNote, "Internal note")}
                >
                  Copy Internal Note
                </button>
              </div>

              {/* AI Case Review Panel */}
              {selectedCase.aiReview?.payload ? (
                <div className="card bg-info/10 border border-info/30">
                  <div className="card-body p-4">
                    <div className="flex justify-between items-start mb-3">
                      <h3 className="font-semibold text-sm flex items-center gap-2">
                        ðŸ¤– AI Case Review
                      </h3>
                      <span className="text-xs text-base-content/60">
                        Generated {relativeTime(selectedCase.aiReview.generatedAt)}
                      </span>
                    </div>

                    {/* Summary */}
                    <div className="mb-4">
                      <h4 className="font-medium text-xs uppercase text-base-content/60 mb-1">Summary</h4>
                      <p className="text-sm">{selectedCase.aiReview.payload.summary}</p>
                    </div>

                    {/* Possible Causes */}
                    {selectedCase.aiReview.payload.possibleCauses?.length > 0 && (
                      <div className="mb-4">
                        <h4 className="font-medium text-xs uppercase text-base-content/60 mb-1">Possible Causes</h4>
                        <ul className="text-sm list-disc list-inside space-y-1">
                          {selectedCase.aiReview.payload.possibleCauses.map((cause, i) => (
                            <li key={i}>{cause}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* Recommended Steps */}
                    {selectedCase.aiReview.payload.recommendedSteps?.length > 0 && (
                      <div className="mb-4">
                        <h4 className="font-medium text-xs uppercase text-base-content/60 mb-1">Recommended Next Steps</h4>
                        <ol className="text-sm list-decimal list-inside space-y-1">
                          {selectedCase.aiReview.payload.recommendedSteps.map((step, i) => (
                            <li key={i}>{step}</li>
                          ))}
                        </ol>
                      </div>
                    )}

                    {/* Warranty Considerations */}
                    {selectedCase.aiReview.payload.warrantyConsiderations?.length > 0 && (
                      <div className="mb-4">
                        <h4 className="font-medium text-xs uppercase text-base-content/60 mb-1">Warranty Considerations</h4>
                        <ul className="text-sm list-disc list-inside space-y-1">
                          {selectedCase.aiReview.payload.warrantyConsiderations.map((item, i) => (
                            <li key={i}>{item}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {/* Draft Customer Reply */}
                    {selectedCase.aiReview.payload.draftCustomerReply && (
                      <div className="mb-4">
                        <div className="flex justify-between items-center mb-1">
                          <h4 className="font-medium text-xs uppercase text-base-content/60">Draft Customer Reply</h4>
                          <button
                            className="btn btn-xs btn-ghost"
                            onClick={() => copyToClipboard(selectedCase.aiReview.payload.draftCustomerReply, "Customer reply")}
                          >
                            Copy
                          </button>
                        </div>
                        <p className="text-sm bg-base-100 p-2 rounded whitespace-pre-wrap">
                          {selectedCase.aiReview.payload.draftCustomerReply}
                        </p>
                      </div>
                    )}

                    {/* Draft Internal Note */}
                    {selectedCase.aiReview.payload.draftInternalNote && (
                      <div>
                        <div className="flex justify-between items-center mb-1">
                          <h4 className="font-medium text-xs uppercase text-base-content/60">Draft Internal Note</h4>
                          <button
                            className="btn btn-xs btn-ghost"
                            onClick={() => copyToClipboard(selectedCase.aiReview.payload.draftInternalNote, "Internal note")}
                          >
                            Copy
                          </button>
                        </div>
                        <p className="text-sm bg-base-100 p-2 rounded whitespace-pre-wrap">
                          {selectedCase.aiReview.payload.draftInternalNote}
                        </p>
                      </div>
                    )}
                  </div>
                </div>
              ) : (
                <div className="card bg-base-200 border border-base-300">
                  <div className="card-body p-4 text-center">
                    <p className="text-sm text-base-content/60">
                      Click "Generate AI Review" to get AI-powered analysis of this case.
                    </p>
                  </div>
                </div>
              )}

              {/* Issue Summary */}
              {selectedCase.summary && (
                <div className="card bg-base-200">
                  <div className="card-body p-4">
                    <h3 className="font-semibold mb-2">Issue Summary</h3>
                    <p className="text-sm whitespace-pre-wrap">{selectedCase.summary}</p>
                  </div>
                </div>
              )}

              {/* Timeline */}
              <div className="card bg-base-200">
                <div className="card-body p-4">
                  <h3 className="font-semibold mb-3">Timeline</h3>

                  {/* Event-driven timeline (newest first) */}
                  <div className="space-y-3 mb-4">
                    {(selectedCase.events || [])
                      .slice()
                      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                      .map((event, idx) => (
                        <div key={idx} className="flex gap-3 items-start">
                          <div className="text-lg" title={event.type}>
                            {EVENT_ICONS[event.type] || "ðŸ“Œ"}
                          </div>
                          <div className="flex-1 min-w-0">
                            <p className="text-sm">{event.summary || event.type.replace(/_/g, " ")}</p>
                            <p className="text-xs text-base-content/60" title={new Date(event.createdAt).toLocaleString()}>
                              {relativeTime(event.createdAt)}
                            </p>
                          </div>
                        </div>
                      ))}

                    {(!selectedCase.events || selectedCase.events.length === 0) && (
                      <p className="text-sm text-base-content/60">No timeline events yet.</p>
                    )}
                  </div>

                  {/* Comments (legacy display for existing comments) */}
                  {selectedCase.comments?.length > 0 && (
                    <div className="border-t border-base-300 pt-3 mt-3">
                      <h4 className="font-medium text-sm mb-2">Comments</h4>
                      <div className="space-y-3">
                        {selectedCase.comments.map((comment) => (
                          <div key={comment.id} className={`p-3 rounded-lg ${
                            comment.authorType === "customer" ? "bg-primary/10" : "bg-base-100"
                          }`}>
                            <div className="flex justify-between text-xs text-base-content/60 mb-1">
                              <span>{comment.authorType === "customer" ? "Customer" : "Staff"}</span>
                              <span title={new Date(comment.createdAt).toLocaleString()}>
                                {relativeTime(comment.createdAt)}
                              </span>
                            </div>
                            <p className="text-sm">{comment.content}</p>
                            {comment.attachments?.length > 0 && (
                              <div className="flex gap-2 mt-2 flex-wrap">
                                {comment.attachments.map((att, i) => (
                                  <a
                                    key={i}
                                    href={att.url || att}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="badge badge-sm badge-outline gap-1"
                                  >
                                    ðŸ“Ž {att.filename || "File"}
                                  </a>
                                ))}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Add Comment with Attachment */}
                  <div className="mt-4">
                    {commentAttachments.length > 0 && (
                      <div className="flex gap-2 flex-wrap mb-2">
                        {commentAttachments.map((att, i) => (
                          <span key={i} className="badge badge-sm gap-1">
                            ðŸ“Ž {att.filename}
                            <button
                              className="text-error ml-1"
                              onClick={() => setCommentAttachments(commentAttachments.filter((_, j) => j !== i))}
                            >
                              âœ•
                            </button>
                          </span>
                        ))}
                      </div>
                    )}
                    <div className="flex gap-2">
                      <input
                        type="text"
                        className="input input-bordered input-sm flex-1"
                        placeholder="Add a comment..."
                        value={newComment}
                        onChange={(e) => setNewComment(e.target.value)}
                        onKeyPress={(e) => e.key === "Enter" && addComment()}
                      />
                      <input
                        type="file"
                        ref={fileInputRef}
                        className="hidden"
                        multiple
                        onChange={handleFileSelect}
                      />
                      <button
                        className="btn btn-ghost btn-sm"
                        onClick={() => fileInputRef.current?.click()}
                        title="Attach files"
                      >
                        ðŸ“Ž
                      </button>
                      <button className="btn btn-primary btn-sm" onClick={addComment}>Add</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Regenerate Confirm Modal */}
      {showRegenerateConfirm && (
        <div className="modal modal-open">
          <div className="modal-box">
            <h3 className="font-bold text-lg">Regenerate AI Review?</h3>
            <p className="py-4">This will replace the existing AI review with a new one. This action cannot be undone.</p>
            <div className="modal-action">
              <button className="btn btn-ghost" onClick={() => setShowRegenerateConfirm(false)}>Cancel</button>
              <button className="btn btn-primary" onClick={() => generateAIReview(true)}>Regenerate</button>
            </div>
          </div>
          <div className="modal-backdrop" onClick={() => setShowRegenerateConfirm(false)}></div>
        </div>
      )}

      {/* Add Case Modal */}
      {showAddModal && (
        <AddCaseModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchCases(); }} />
      )}
    </DashboardLayout>
  );
}

function AddCaseModal({ onClose, onSuccess }) {
  const [isLoading, setIsLoading] = useState(false);
  const [formData, setFormData] = useState({
    customerName: "", customerEmail: "", customerPhone: "",
    vehicleReg: "", regAtPurchase: "", summary: "", priority: "normal",
    warrantyType: "",
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!formData.customerName) return toast.error("Customer name required");
    setIsLoading(true);
    try {
      const res = await fetch("/api/aftercare", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...formData, source: "manual" }),
      });
      if (!res.ok) throw new Error("Failed to create");
      toast.success("Case created!");
      onSuccess();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box">
        <h3 className="font-bold text-lg mb-4">New Aftercare Case</h3>
        <form onSubmit={handleSubmit}>
          <div className="form-control mb-3">
            <label className="label"><span className="label-text">Customer Name *</span></label>
            <input type="text" className="input input-bordered" value={formData.customerName}
              onChange={(e) => setFormData({ ...formData, customerName: e.target.value })} required />
          </div>
          <div className="grid grid-cols-2 gap-3">
            <div className="form-control">
              <label className="label"><span className="label-text">Phone</span></label>
              <input type="tel" className="input input-bordered" value={formData.customerPhone}
                onChange={(e) => setFormData({ ...formData, customerPhone: e.target.value })} />
            </div>
            <div className="form-control">
              <label className="label"><span className="label-text">Email</span></label>
              <input type="email" className="input input-bordered" value={formData.customerEmail}
                onChange={(e) => setFormData({ ...formData, customerEmail: e.target.value })} />
            </div>
          </div>
          <div className="grid grid-cols-2 gap-3 mt-3">
            <div className="form-control">
              <label className="label"><span className="label-text">Current Reg</span></label>
              <input type="text" className="input input-bordered uppercase" value={formData.vehicleReg}
                onChange={(e) => setFormData({ ...formData, vehicleReg: e.target.value.toUpperCase() })} />
            </div>
            <div className="form-control">
              <label className="label"><span className="label-text">Reg at Purchase</span></label>
              <input type="text" className="input input-bordered uppercase" value={formData.regAtPurchase}
                onChange={(e) => setFormData({ ...formData, regAtPurchase: e.target.value.toUpperCase() })} />
            </div>
          </div>
          <div className="grid grid-cols-2 gap-3 mt-3">
            <div className="form-control">
              <label className="label"><span className="label-text">Priority</span></label>
              <select className="select select-bordered" value={formData.priority}
                onChange={(e) => setFormData({ ...formData, priority: e.target.value })}>
                <option value="low">Low</option>
                <option value="normal">Normal</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
              </select>
            </div>
            <div className="form-control">
              <label className="label"><span className="label-text">Warranty Type</span></label>
              <select className="select select-bordered" value={formData.warrantyType}
                onChange={(e) => setFormData({ ...formData, warrantyType: e.target.value })}>
                <option value="">Not specified</option>
                <option value="Dealer Warranty">Dealer Warranty</option>
                <option value="External Warranty">External Warranty</option>
              </select>
            </div>
          </div>
          <div className="form-control mt-3">
            <label className="label"><span className="label-text">Issue Summary</span></label>
            <textarea className="textarea textarea-bordered" value={formData.summary}
              onChange={(e) => setFormData({ ...formData, summary: e.target.value })}></textarea>
          </div>
          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
            <button type="submit" className="btn btn-primary" disabled={isLoading}>
              {isLoading ? <span className="loading loading-spinner"></span> : "Create Case"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}
