import connectMongo from "@/libs/mongoose";
import CustomerPXAppraisal from "@/models/CustomerPXAppraisal";
import Dealer from "@/models/Dealer";
import Vehicle from "@/models/Vehicle";
import Contact from "@/models/Contact";

export default async function handler(req, res) {
  try {
    await connectMongo();

    if (req.method === "GET") {
      const { decision } = req.query;
      let query = {};
      if (decision && decision !== "all") query.decision = decision;

      const appraisals = await CustomerPXAppraisal.find(query)
        .populate("contactId")
        .populate("vehicleId")
        .sort({ createdAt: -1 })
        .lean();

      return res.status(200).json(appraisals);
    }

    if (req.method === "POST") {
      const {
        vehicleReg, vehicleMake, vehicleModel, vehicleYear,
        mileage, colour, fuelType, conditionNotes, proposedPurchasePrice,
        outstandingFinanceAmount, aiHintText, v5Url, serviceHistoryUrl,
        otherDocuments, prepTemplateId, customerName, customerEmail, customerPhone,
        conditionRating, formSubmissionId, interestedInVehicle, dealerSlug, dealerId
      } = req.body;

      if (!vehicleReg) {
        return res.status(400).json({ error: "Vehicle registration is required" });
      }

      // Find dealer by slug or ID
      let dealer = null;
      if (dealerSlug) {
        dealer = await Dealer.findOne({ slug: dealerSlug }).lean();
        if (!dealer) {
          // Try finding by ID if slug doesn't match
          dealer = await Dealer.findById(dealerSlug).lean();
        }
      } else if (dealerId) {
        dealer = await Dealer.findById(dealerId).lean();
      } else {
        // Default to first dealer if none specified
        dealer = await Dealer.findOne().lean();
      }

      const appraisalData = {
        vehicleReg: vehicleReg.toUpperCase().replace(/\s/g, ""),
        dealerId: dealer?._id,
      };

      // Add optional fields only if they have values
      if (vehicleMake) appraisalData.vehicleMake = vehicleMake;
      if (vehicleModel) appraisalData.vehicleModel = vehicleModel;
      if (vehicleYear) appraisalData.vehicleYear = vehicleYear;
      if (mileage) appraisalData.mileage = Number(mileage);
      if (colour) appraisalData.colour = colour;
      if (fuelType) appraisalData.fuelType = fuelType;
      if (conditionNotes) appraisalData.conditionNotes = conditionNotes;
      if (proposedPurchasePrice) appraisalData.proposedPurchasePrice = Number(proposedPurchasePrice);
      if (outstandingFinanceAmount) appraisalData.outstandingFinanceAmount = Number(outstandingFinanceAmount);
      if (aiHintText) appraisalData.aiHintText = aiHintText;
      if (v5Url) appraisalData.v5Url = v5Url;
      if (serviceHistoryUrl) appraisalData.serviceHistoryUrl = serviceHistoryUrl;
      if (otherDocuments) appraisalData.otherDocuments = otherDocuments;
      if (prepTemplateId && prepTemplateId !== "default") appraisalData.prepTemplateId = prepTemplateId;
      if (customerName) appraisalData.customerName = customerName;
      if (customerEmail) appraisalData.customerEmail = customerEmail;
      if (customerPhone) appraisalData.customerPhone = customerPhone;
      if (conditionRating) appraisalData.conditionRating = conditionRating;
      if (formSubmissionId) appraisalData.formSubmissionId = formSubmissionId;
      if (interestedInVehicle) appraisalData.interestedInVehicle = interestedInVehicle;

      const appraisal = await CustomerPXAppraisal.create(appraisalData);

      const populated = await CustomerPXAppraisal.findById(appraisal._id).populate("contactId").lean();
      const result = {
        ...populated,
        id: populated._id.toString(),
        _id: undefined,
      };
      return res.status(201).json(result);
    }

    return res.status(405).json({ error: "Method not allowed" });
  } catch (error) {
    console.error("API Error:", error);
    return res.status(500).json({ error: error.message });
  }
}
