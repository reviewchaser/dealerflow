import mongoose from "mongoose";
import toJSON from "./plugins/toJSON.js";

// Dealer status for admin control
export const DEALER_STATUS = {
  ACTIVE: "ACTIVE",
  DISABLED: "DISABLED",
};

// Dealer plan tiers
export const DEALER_PLAN = {
  FREE: "FREE",       // Free tier - limited features, requires approval
  TRIAL: "TRIAL",     // Trial period - full features
  PAID: "PAID",       // Paid subscription - full features
};

// Approval status for new registrations
export const APPROVAL_STATUS = {
  PENDING: "PENDING",     // Awaiting super-admin approval
  APPROVED: "APPROVED",   // Approved and active
  REJECTED: "REJECTED",   // Rejected - can't access
};

const dealerSchema = new mongoose.Schema(
  {
    name: { type: String, required: true },
    // Platform admin can disable dealers
    status: {
      type: String,
      enum: Object.values(DEALER_STATUS),
      default: DEALER_STATUS.ACTIVE,
      index: true,
    },
    // Subscription plan tier
    plan: {
      type: String,
      enum: Object.values(DEALER_PLAN),
      default: DEALER_PLAN.TRIAL, // New dealers start on trial
      index: true,
    },
    // Approval status for new registrations
    approvalStatus: {
      type: String,
      enum: Object.values(APPROVAL_STATUS),
      default: APPROVAL_STATUS.APPROVED, // Existing dealers are approved by default
      index: true,
    },
    approvedAt: { type: Date },
    approvedByUserId: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
    rejectedAt: { type: Date },
    rejectedByUserId: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
    rejectionReason: { type: String },
    // Company details for forms and branding
    companyName: { type: String }, // Legal company name e.g. "My New Motor LTD"
    companyAddress: { type: String }, // Full address for forms
    companyPhone: { type: String }, // Phone for forms/contact
    companyEmail: { type: String }, // Email for forms/contact
    // Legacy fields (kept for compatibility)
    address: { type: String },
    phone: { type: String },
    email: { type: String },
    websiteUrl: { type: String },
    googleReviewUrl: { type: String },
    logoUrl: { type: String }, // Dealer logo for branding (deprecated - use logoKey)
    logoKey: { type: String }, // S3 object key for logo (private bucket)
    slug: { type: String, unique: true, sparse: true }, // URL slug for public forms
    settings: { type: Object, default: {} }, // branding, default task templates
    // Form customization - intro text, T&Cs per form type
    formCustomText: {
      type: Map,
      of: {
        introText: String,
        termsText: String,
        contactPhone: String,
      },
      default: {},
    },
    // === ONBOARDING FIELDS ===
    completedOnboarding: { type: Boolean, default: false },
    timezone: { type: String, default: "Europe/London" },
    // Comprehensive onboarding state with module/form toggles
    onboarding: {
      completedAt: { type: Date },
      dismissedAt: { type: Date },
      enabledModules: {
        salesPrep: { type: Boolean, default: true },
        appraisals: { type: Boolean, default: true },
        warranty: { type: Boolean, default: false },
        reviews: { type: Boolean, default: false },
      },
      enabledForms: [{ type: String }], // ["PDI", "DELIVERY", "TEST_DRIVE", ...]
      completedSteps: [{ type: String }], // ["first_vehicle", "first_appraisal", ...]
    },
    primaryContactEmail: { type: String },
    primaryContactPhone: { type: String },
    // Board configuration for Sales & Prep view
    boardConfig: {
      columns: [{
        key: { type: String },
        label: { type: String },
        order: { type: Number },
        color: { type: String },
      }]
    },
    // Task auto-completion settings
    taskAutoComplete: {
      enabled: { type: Boolean, default: true },
      mappings: [{
        formType: { type: String },
        taskName: { type: String },
      }]
    },
    // Default task template group for new vehicles
    defaultTaskTemplateGroupId: { type: mongoose.Schema.Types.ObjectId, ref: "VehicleTaskTemplateGroup" },

    // === SALES SETTINGS ===
    salesSettings: {
      // Sequential numbering
      nextStockNumber: { type: Number, default: 1 },
      stockNumberPrefix: { type: String, default: "" },
      nextDealNumber: { type: Number, default: 1 },
      dealNumberPrefix: { type: String, default: "D" },
      nextInvoiceNumber: { type: Number, default: 1 },
      invoiceNumberPrefix: { type: String, default: "INV" },
      nextDepositReceiptNumber: { type: Number, default: 1 },
      depositReceiptPrefix: { type: String, default: "DEP" },

      // Default VAT settings
      defaultVatScheme: {
        type: String,
        enum: ["MARGIN", "VAT_QUALIFYING", "NO_VAT"],
        default: "MARGIN",
      },
      vatRate: { type: Number, default: 0.2 },

      // VAT registration
      vatNumber: { type: String },
      vatRegistered: { type: Boolean, default: false },

      // Company registration
      companyNumber: { type: String },

      // Bank details for invoices
      bankDetails: {
        accountName: { type: String },
        sortCode: { type: String },
        accountNumber: { type: String },
        iban: { type: String },
        bic: { type: String },
      },

      // Terms templates
      terms: {
        consumerInPerson: { type: String },
        consumerDistance: { type: String },
        businessInPerson: { type: String },
        businessDistance: { type: String },
        depositTerms: { type: String },
      },

      // Default warranty
      defaultWarrantyMonths: { type: Number, default: 3 },
    },
  },
  { timestamps: true }
);

dealerSchema.plugin(toJSON);

// Use existing model or create new one (prevents OverwriteModelError in dev)
export default mongoose.models?.Dealer || mongoose.model("Dealer", dealerSchema);
