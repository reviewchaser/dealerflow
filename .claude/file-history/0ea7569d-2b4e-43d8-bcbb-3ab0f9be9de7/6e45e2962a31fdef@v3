import { useState, useEffect, useCallback } from "react";
import { toast } from "react-hot-toast";
import ContactPicker from "@/components/ContactPicker";

// Format currency
const formatCurrency = (amount) => {
  if (amount === null || amount === undefined) return "—";
  return new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
  }).format(amount);
};

// Format date helper
const formatDate = (date) => {
  if (!date) return "";
  return new Date(date).toLocaleDateString("en-GB", {
    day: "numeric",
    month: "short",
    year: "numeric",
  });
};

// Format datetime helper
const formatDateTime = (date) => {
  if (!date) return "";
  return new Date(date).toLocaleString("en-GB", {
    day: "numeric",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

// Status labels and colors
const STATUS_CONFIG = {
  DRAFT: { label: "Draft", color: "bg-slate-100 text-slate-600" },
  DEPOSIT_TAKEN: { label: "Deposit Taken", color: "bg-amber-100 text-amber-700" },
  INVOICED: { label: "Invoiced", color: "bg-blue-100 text-blue-700" },
  DELIVERED: { label: "Delivered", color: "bg-purple-100 text-purple-700" },
  COMPLETED: { label: "Completed", color: "bg-emerald-100 text-emerald-700" },
  CANCELLED: { label: "Cancelled", color: "bg-red-100 text-red-700" },
};

const VAT_SCHEME_LABELS = {
  MARGIN: "Margin Scheme",
  VAT_QUALIFYING: "VAT Qualifying",
  NO_VAT: "No VAT",
};

/**
 * DealDrawer - Display and manage deal details
 *
 * Props:
 * - dealId: The ID of the deal to display
 * - isOpen: Whether the drawer is open
 * - onClose: Function to call when closing the drawer
 * - onUpdate: Function to call when deal is updated
 */
export default function DealDrawer({
  dealId,
  isOpen,
  onClose,
  onUpdate,
}) {
  const [deal, setDeal] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [fetchError, setFetchError] = useState(null);
  const [activeTab, setActiveTab] = useState("overview");
  const [actionLoading, setActionLoading] = useState(null);

  // Deposit modal state
  const [showDepositModal, setShowDepositModal] = useState(false);
  const [depositAmount, setDepositAmount] = useState("");
  const [depositMethod, setDepositMethod] = useState("CARD");
  const [depositReference, setDepositReference] = useState("");

  // Customer editing state
  const [isEditingCustomer, setIsEditingCustomer] = useState(false);

  // Lock body scroll when drawer is open
  useEffect(() => {
    if (isOpen) {
      const scrollY = window.scrollY;
      const html = document.documentElement;

      document.body.style.position = "fixed";
      document.body.style.top = `-${scrollY}px`;
      document.body.style.left = "0";
      document.body.style.right = "0";
      document.body.style.width = "100%";
      document.body.style.overflow = "hidden";
      document.body.style.touchAction = "none";

      html.style.overflow = "hidden";

      return () => {
        document.body.style.position = "";
        document.body.style.top = "";
        document.body.style.left = "";
        document.body.style.right = "";
        document.body.style.width = "";
        document.body.style.overflow = "";
        document.body.style.touchAction = "";

        html.style.overflow = "";

        window.scrollTo(0, scrollY);
      };
    }
  }, [isOpen]);

  useEffect(() => {
    if (isOpen && dealId) {
      fetchDeal();
    } else if (!dealId) {
      // Reset state when dealId is cleared
      setDeal(null);
      setFetchError(null);
    }
  }, [isOpen, dealId]);

  const fetchDeal = async () => {
    setIsLoading(true);
    setFetchError(null);
    try {
      const res = await fetch(`/api/deals/${dealId}`);
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || `Failed to load deal (${res.status})`);
      }
      const data = await res.json();
      setDeal(data);
    } catch (error) {
      console.error("[DealDrawer] Fetch error:", error);
      setFetchError(error.message || "Failed to load deal details");
      // Don't show toast here - we'll show error in UI instead
    } finally {
      setIsLoading(false);
    }
  };

  // Calculate totals
  const calculateTotals = () => {
    if (!deal) return {};

    const addOnsNetTotal = (deal.addOns || []).reduce(
      (sum, a) => sum + (a.unitPriceNet * (a.qty || 1)),
      0
    );
    const addOnsVatTotal = (deal.addOns || []).reduce((sum, a) => {
      if (a.vatTreatment === "STANDARD") {
        return sum + a.unitPriceNet * (a.qty || 1) * (a.vatRate || 0.2);
      }
      return sum;
    }, 0);

    let subtotal, totalVat, grandTotal;

    if (deal.vatScheme === "VAT_QUALIFYING") {
      subtotal = (deal.vehiclePriceNet || 0) + addOnsNetTotal;
      totalVat = (deal.vehicleVatAmount || 0) + addOnsVatTotal;
      grandTotal = subtotal + totalVat;
    } else {
      subtotal = (deal.vehiclePriceGross || 0) + addOnsNetTotal + addOnsVatTotal;
      totalVat = 0;
      grandTotal = subtotal;
    }

    const totalPaid = (deal.payments || [])
      .filter((p) => !p.isRefunded)
      .reduce((sum, p) => sum + p.amount, 0);

    const pxNetValue = deal.partExchange
      ? (deal.partExchange.allowance || 0) - (deal.partExchange.settlement || 0)
      : 0;

    const balanceDue = grandTotal - totalPaid - pxNetValue;

    return {
      addOnsNetTotal,
      addOnsVatTotal,
      subtotal,
      totalVat,
      grandTotal,
      totalPaid,
      pxNetValue,
      balanceDue,
    };
  };

  // Deal actions
  const handleTakeDeposit = async () => {
    if (!depositAmount || parseFloat(depositAmount) <= 0) {
      toast.error("Please enter a valid deposit amount");
      return;
    }

    setActionLoading("deposit");
    try {
      const res = await fetch(`/api/deals/${dealId}/take-deposit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: parseFloat(depositAmount),
          method: depositMethod,
          reference: depositReference,
        }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to record deposit");
      }

      const result = await res.json();
      toast.success(`Deposit recorded: ${result.documentNumber}`);
      setShowDepositModal(false);
      setDepositAmount("");
      setDepositReference("");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleGenerateInvoice = async () => {
    setActionLoading("invoice");
    try {
      const res = await fetch(`/api/deals/${dealId}/generate-invoice`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to generate invoice");
      }

      const result = await res.json();
      toast.success(`Invoice generated: ${result.documentNumber}`);
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleMarkDelivered = async () => {
    setActionLoading("delivered");
    try {
      const res = await fetch(`/api/deals/${dealId}/mark-delivered`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to mark as delivered");
      }

      toast.success("Deal marked as delivered");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleMarkCompleted = async () => {
    setActionLoading("completed");
    try {
      const res = await fetch(`/api/deals/${dealId}/mark-completed`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to complete deal");
      }

      toast.success("Deal completed");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleCancelDeal = async () => {
    if (!confirm("Are you sure you want to cancel this deal?")) return;

    setActionLoading("cancel");
    try {
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cancelReason: "Cancelled by user" }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to cancel deal");
      }

      toast.success("Deal cancelled");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleUpdateCustomer = async (contactId) => {
    if (!contactId) return;

    setActionLoading("customer");
    try {
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ soldToContactId: contactId }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to update customer");
      }

      toast.success("Customer updated");
      setIsEditingCustomer(false);
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  if (!isOpen) return null;

  const totals = calculateTotals();
  const statusConfig = STATUS_CONFIG[deal?.status] || STATUS_CONFIG.DRAFT;

  return (
    <div
      className="fixed inset-0 flex justify-end z-50 drawer-locked"
      style={{ touchAction: "none", overscrollBehavior: "none" }}
    >
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity duration-300"
        onClick={onClose}
      />

      {/* Drawer */}
      <div
        className="relative bg-[#f8fafc] flex flex-col w-full max-w-3xl min-w-0 translate-x-0 overflow-x-hidden shadow-2xl"
        style={{
          height: "100dvh",
          maxHeight: "100dvh",
          touchAction: "pan-y",
        }}
      >
        {isLoading ? (
          <div className="flex items-center justify-center h-full">
            <span className="loading loading-spinner loading-lg text-[#0066CC]"></span>
          </div>
        ) : fetchError ? (
          <div className="flex flex-col items-center justify-center h-full p-6">
            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
              <svg className="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <p className="text-lg font-semibold text-slate-900 mb-1">Failed to load deal</p>
            <p className="text-sm text-slate-500 text-center mb-4">{fetchError}</p>
            <div className="flex gap-2">
              <button className="btn btn-ghost" onClick={onClose}>
                Close
              </button>
              <button className="btn bg-[#0066CC] hover:bg-[#0052a3] text-white border-none" onClick={fetchDeal}>
                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Retry
              </button>
            </div>
          </div>
        ) : !deal ? (
          <div className="flex flex-col items-center justify-center h-full p-6">
            <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
              <svg className="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <p className="text-lg font-semibold text-slate-900 mb-1">Deal not found</p>
            <p className="text-sm text-slate-500 text-center mb-4">This deal may have been deleted or you may not have access</p>
            <button className="btn btn-ghost" onClick={onClose}>
              Close
            </button>
          </div>
        ) : (
          <>
            {/* Header */}
            <div className="sticky top-0 bg-white border-b border-slate-100 px-4 md:px-6 py-4 md:py-5 z-10 shrink-0 shadow-sm">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <button
                    className="flex items-center justify-center w-9 h-9 rounded-xl bg-slate-100 hover:bg-[#0066CC]/10 text-slate-500 hover:text-[#0066CC] transition-all"
                    onClick={onClose}
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <div>
                    <h2 className="text-lg md:text-xl font-bold text-slate-900">
                      Deal #{deal.dealNumber || "—"}
                    </h2>
                    <div className="flex items-center gap-2 mt-1">
                      <span className={`inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-semibold ${statusConfig.color}`}>
                        {statusConfig.label}
                      </span>
                      {deal.vehicle && (
                        <span className="inline-flex items-center px-2.5 py-1 rounded-lg bg-slate-900 text-white text-xs font-mono font-bold tracking-wider">
                          {deal.vehicle.regCurrent}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
                <button
                  className="flex items-center justify-center w-9 h-9 rounded-xl bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 transition-all"
                  onClick={onClose}
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            {/* Tabs */}
            <div className="sticky top-[73px] md:top-[89px] bg-white border-b border-slate-100 px-4 py-3 z-10 shrink-0">
              {/* Mobile: Dropdown selector */}
              <div className="md:hidden">
                <select
                  value={activeTab}
                  onChange={(e) => setActiveTab(e.target.value)}
                  className="select select-bordered w-full font-medium"
                >
                  <option value="overview">Overview</option>
                  <option value="customer">Customer</option>
                  <option value="addons">Add-ons ({deal.addOns?.length || 0})</option>
                  <option value="payments">Payments ({deal.payments?.length || 0})</option>
                </select>
              </div>

              {/* Desktop: Pill tabs */}
              <div className="hidden md:flex items-center gap-2 overflow-x-auto pb-1 -mb-1">
                {[
                  { id: "overview", label: "Overview" },
                  { id: "customer", label: "Customer" },
                  { id: "addons", label: "Add-ons", count: deal.addOns?.length },
                  { id: "payments", label: "Payments", count: deal.payments?.length },
                ].map((tab) => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${
                      activeTab === tab.id
                        ? "bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25"
                        : "bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-slate-900"
                    }`}
                  >
                    <span>{tab.label}</span>
                    {tab.count > 0 && (
                      <span className={`inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold ${
                        activeTab === tab.id
                          ? "bg-white/20 text-white"
                          : "bg-slate-200 text-slate-600"
                      }`}>
                        {tab.count}
                      </span>
                    )}
                  </button>
                ))}
              </div>
            </div>

            {/* Content */}
            <div
              className="p-4 md:p-6 space-y-4 md:space-y-6 flex-1 overflow-y-auto overflow-x-hidden min-w-0 overscroll-contain"
              style={{ paddingBottom: "calc(96px + env(safe-area-inset-bottom, 0px))" }}
            >
              {/* Overview Tab */}
              {activeTab === "overview" && (
                <div className="space-y-4">
                  {/* Action Buttons */}
                  {deal.status !== "COMPLETED" && deal.status !== "CANCELLED" && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <h3 className="text-sm font-bold text-slate-800">Actions</h3>
                      </div>
                      <div className="p-4 flex flex-wrap gap-2">
                        {deal.status === "DRAFT" && (
                          <button
                            onClick={() => setShowDepositModal(true)}
                            disabled={actionLoading}
                            className="btn btn-sm bg-amber-500 hover:bg-amber-600 text-white border-none"
                          >
                            {actionLoading === "deposit" ? (
                              <span className="loading loading-spinner loading-xs"></span>
                            ) : (
                              "Take Deposit"
                            )}
                          </button>
                        )}
                        {(deal.status === "DEPOSIT_TAKEN" || deal.status === "DRAFT") && deal.soldToContactId && deal.vehiclePriceGross && (
                          <button
                            onClick={handleGenerateInvoice}
                            disabled={actionLoading}
                            className="btn btn-sm bg-blue-500 hover:bg-blue-600 text-white border-none"
                          >
                            {actionLoading === "invoice" ? (
                              <span className="loading loading-spinner loading-xs"></span>
                            ) : (
                              "Generate Invoice"
                            )}
                          </button>
                        )}
                        {deal.status === "INVOICED" && (
                          <button
                            onClick={handleMarkDelivered}
                            disabled={actionLoading}
                            className="btn btn-sm bg-purple-500 hover:bg-purple-600 text-white border-none"
                          >
                            {actionLoading === "delivered" ? (
                              <span className="loading loading-spinner loading-xs"></span>
                            ) : (
                              "Mark Delivered"
                            )}
                          </button>
                        )}
                        {deal.status === "DELIVERED" && (
                          <button
                            onClick={handleMarkCompleted}
                            disabled={actionLoading}
                            className="btn btn-sm bg-emerald-500 hover:bg-emerald-600 text-white border-none"
                          >
                            {actionLoading === "completed" ? (
                              <span className="loading loading-spinner loading-xs"></span>
                            ) : (
                              "Complete Deal"
                            )}
                          </button>
                        )}
                        <button
                          onClick={handleCancelDeal}
                          disabled={actionLoading}
                          className="btn btn-sm btn-ghost text-red-500 hover:bg-red-50"
                        >
                          Cancel Deal
                        </button>
                      </div>
                    </div>
                  )}

                  {/* Vehicle Section */}
                  {deal.vehicle && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h8m-8 5h8m-4-9a9 9 0 110 18 9 9 0 010-18z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Vehicle</h3>
                        </div>
                      </div>
                      <div className="p-4">
                        <div className="flex items-start gap-4">
                          {deal.vehicle.primaryImageUrl && (
                            <img
                              src={deal.vehicle.primaryImageUrl}
                              alt={`${deal.vehicle.make} ${deal.vehicle.model}`}
                              className="w-20 h-20 object-cover rounded-xl"
                            />
                          )}
                          <div className="flex-1">
                            <p className="font-semibold text-slate-900">
                              {deal.vehicle.year} {deal.vehicle.make} {deal.vehicle.model}
                            </p>
                            <p className="text-sm text-slate-500 mt-1">
                              {deal.vehicle.regCurrent}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Pricing Summary */}
                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Pricing</h3>
                        </div>
                        <span className={`inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium ${
                          deal.vatScheme === "VAT_QUALIFYING"
                            ? "bg-blue-100 text-blue-700"
                            : "bg-slate-100 text-slate-600"
                        }`}>
                          {VAT_SCHEME_LABELS[deal.vatScheme] || deal.vatScheme}
                        </span>
                      </div>
                    </div>
                    <div className="p-4 space-y-3">
                      {/* Vehicle Price */}
                      <div className="flex justify-between items-center">
                        <span className="text-sm text-slate-600">Vehicle</span>
                        <span className="font-semibold text-slate-900">
                          {deal.vatScheme === "VAT_QUALIFYING"
                            ? formatCurrency(deal.vehiclePriceNet)
                            : formatCurrency(deal.vehiclePriceGross)}
                        </span>
                      </div>

                      {/* Add-ons */}
                      {totals.addOnsNetTotal > 0 && (
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-slate-600">Add-ons</span>
                          <span className="font-semibold text-slate-900">
                            {formatCurrency(totals.addOnsNetTotal)}
                          </span>
                        </div>
                      )}

                      {/* VAT (only for VAT Qualifying) */}
                      {deal.vatScheme === "VAT_QUALIFYING" && totals.totalVat > 0 && (
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-slate-600">VAT @ 20%</span>
                          <span className="font-semibold text-slate-900">
                            {formatCurrency(totals.totalVat)}
                          </span>
                        </div>
                      )}

                      <div className="border-t border-slate-100 pt-3">
                        <div className="flex justify-between items-center">
                          <span className="text-sm font-semibold text-slate-700">Total</span>
                          <span className="text-lg font-bold text-slate-900">
                            {formatCurrency(totals.grandTotal)}
                          </span>
                        </div>
                      </div>

                      {/* Part Exchange */}
                      {totals.pxNetValue > 0 && (
                        <div className="flex justify-between items-center text-emerald-600">
                          <span className="text-sm">Part Exchange</span>
                          <span className="font-semibold">-{formatCurrency(totals.pxNetValue)}</span>
                        </div>
                      )}

                      {/* Payments */}
                      {totals.totalPaid > 0 && (
                        <div className="flex justify-between items-center text-emerald-600">
                          <span className="text-sm">Paid</span>
                          <span className="font-semibold">-{formatCurrency(totals.totalPaid)}</span>
                        </div>
                      )}

                      {/* Balance Due */}
                      <div className="border-t border-slate-100 pt-3">
                        <div className="flex justify-between items-center">
                          <span className="text-sm font-semibold text-slate-700">Balance Due</span>
                          <span className={`text-lg font-bold ${
                            totals.balanceDue <= 0 ? "text-emerald-600" : "text-slate-900"
                          }`}>
                            {formatCurrency(Math.max(0, totals.balanceDue))}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Timeline */}
                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                      <div className="flex items-center gap-2">
                        <div className="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center">
                          <svg className="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </div>
                        <h3 className="text-sm font-bold text-slate-800">Timeline</h3>
                      </div>
                    </div>
                    <div className="p-4 space-y-3 text-sm">
                      <div className="flex justify-between">
                        <span className="text-slate-500">Created</span>
                        <span className="text-slate-900">{formatDateTime(deal.createdAt)}</span>
                      </div>
                      {deal.depositTakenAt && (
                        <div className="flex justify-between">
                          <span className="text-slate-500">Deposit Taken</span>
                          <span className="text-slate-900">{formatDateTime(deal.depositTakenAt)}</span>
                        </div>
                      )}
                      {deal.invoicedAt && (
                        <div className="flex justify-between">
                          <span className="text-slate-500">Invoiced</span>
                          <span className="text-slate-900">{formatDateTime(deal.invoicedAt)}</span>
                        </div>
                      )}
                      {deal.deliveredAt && (
                        <div className="flex justify-between">
                          <span className="text-slate-500">Delivered</span>
                          <span className="text-slate-900">{formatDateTime(deal.deliveredAt)}</span>
                        </div>
                      )}
                      {deal.completedAt && (
                        <div className="flex justify-between">
                          <span className="text-slate-500">Completed</span>
                          <span className="text-slate-900">{formatDateTime(deal.completedAt)}</span>
                        </div>
                      )}
                      {deal.cancelledAt && (
                        <div className="flex justify-between text-red-600">
                          <span>Cancelled</span>
                          <span>{formatDateTime(deal.cancelledAt)}</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Notes */}
                  {(deal.notes || deal.internalNotes) && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <h3 className="text-sm font-bold text-slate-800">Notes</h3>
                      </div>
                      <div className="p-4 space-y-3">
                        {deal.notes && (
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Customer Notes</span>
                            <p className="text-sm text-slate-700 mt-1">{deal.notes}</p>
                          </div>
                        )}
                        {deal.internalNotes && (
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Internal Notes</span>
                            <p className="text-sm text-slate-700 mt-1">{deal.internalNotes}</p>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Customer Tab */}
              {activeTab === "customer" && (
                <div className="space-y-4">
                  {/* Sold To Section */}
                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-[#0066CC]/10 flex items-center justify-center">
                            <svg className="w-4 h-4 text-[#0066CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Sold To</h3>
                        </div>
                        {deal.customer && deal.status === "DRAFT" && !isEditingCustomer && (
                          <button
                            onClick={() => setIsEditingCustomer(true)}
                            className="btn btn-ghost btn-xs text-[#0066CC]"
                          >
                            Change
                          </button>
                        )}
                      </div>
                    </div>
                    <div className="p-4">
                      {isEditingCustomer || !deal.customer ? (
                        <div className="space-y-3">
                          <ContactPicker
                            value={deal.soldToContactId}
                            onChange={(contactId) => handleUpdateCustomer(contactId)}
                            filterTypeTags={["customer"]}
                            placeholder="Search or create a customer..."
                          />
                          {isEditingCustomer && (
                            <button
                              onClick={() => setIsEditingCustomer(false)}
                              className="btn btn-ghost btn-sm w-full"
                            >
                              Cancel
                            </button>
                          )}
                        </div>
                      ) : (
                        <div className="space-y-3">
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Name</span>
                            <p className="font-semibold text-slate-900 mt-0.5">{deal.customer.displayName}</p>
                          </div>
                          {deal.customer.companyName && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Company</span>
                              <p className="text-slate-700 mt-0.5">{deal.customer.companyName}</p>
                            </div>
                          )}
                          {deal.customer.email && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Email</span>
                              <p className="text-slate-700 mt-0.5">{deal.customer.email}</p>
                            </div>
                          )}
                          {deal.customer.phone && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Phone</span>
                              <p className="text-slate-700 mt-0.5">{deal.customer.phone}</p>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Invoice To (if different) */}
                  {deal.invoiceTo && deal.invoiceTo.id !== deal.customer?.id && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Invoice To</h3>
                        </div>
                      </div>
                      <div className="p-4 space-y-3">
                        <div>
                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Name</span>
                          <p className="font-semibold text-slate-900 mt-0.5">{deal.invoiceTo.displayName}</p>
                        </div>
                        {deal.invoiceTo.companyName && (
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Company</span>
                            <p className="text-slate-700 mt-0.5">{deal.invoiceTo.companyName}</p>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Part Exchange */}
                  {deal.partExchange && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Part Exchange</h3>
                        </div>
                      </div>
                      <div className="p-4 space-y-3">
                        <div>
                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Vehicle</span>
                          <p className="font-semibold text-slate-900 mt-0.5">
                            {deal.partExchange.vrm} - {deal.partExchange.make} {deal.partExchange.model}
                          </p>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Allowance</span>
                            <p className="font-semibold text-slate-900 mt-0.5">
                              {formatCurrency(deal.partExchange.allowance)}
                            </p>
                          </div>
                          {deal.partExchange.settlement > 0 && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Settlement</span>
                              <p className="font-semibold text-red-600 mt-0.5">
                                -{formatCurrency(deal.partExchange.settlement)}
                              </p>
                            </div>
                          )}
                        </div>
                        <div className="pt-2 border-t border-slate-100">
                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Net Value</span>
                          <p className="font-bold text-emerald-600 mt-0.5">
                            {formatCurrency(totals.pxNetValue)}
                          </p>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Add-ons Tab */}
              {activeTab === "addons" && (
                <div className="space-y-4">
                  {deal.addOns?.length > 0 ? (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <h3 className="text-sm font-bold text-slate-800">Add-ons</h3>
                      </div>
                      <div className="divide-y divide-slate-100">
                        {deal.addOns.map((addon, idx) => (
                          <div key={idx} className="p-4 flex items-center justify-between">
                            <div>
                              <p className="font-medium text-slate-900">{addon.name}</p>
                              <p className="text-sm text-slate-500">
                                {addon.qty > 1 && `${addon.qty} x `}
                                {formatCurrency(addon.unitPriceNet)}
                                {addon.vatTreatment === "STANDARD" && " + VAT"}
                              </p>
                            </div>
                            <span className="font-semibold text-slate-900">
                              {formatCurrency(addon.unitPriceNet * (addon.qty || 1))}
                            </span>
                          </div>
                        ))}
                      </div>
                      <div className="px-4 py-3 bg-slate-50 border-t border-slate-100 flex justify-between">
                        <span className="font-medium text-slate-700">Total</span>
                        <span className="font-bold text-slate-900">
                          {formatCurrency(totals.addOnsNetTotal + totals.addOnsVatTotal)}
                        </span>
                      </div>
                    </div>
                  ) : (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center">
                      <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                      </div>
                      <p className="text-sm font-medium text-slate-600">No add-ons</p>
                      <p className="text-xs text-slate-400 mt-1">Add products like warranties or accessories</p>
                    </div>
                  )}
                </div>
              )}

              {/* Payments Tab */}
              {activeTab === "payments" && (
                <div className="space-y-4">
                  {deal.payments?.length > 0 ? (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <h3 className="text-sm font-bold text-slate-800">Payments</h3>
                      </div>
                      <div className="divide-y divide-slate-100">
                        {deal.payments.map((payment, idx) => (
                          <div key={idx} className="p-4">
                            <div className="flex items-center justify-between">
                              <div>
                                <div className="flex items-center gap-2">
                                  <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${
                                    payment.type === "DEPOSIT"
                                      ? "bg-amber-100 text-amber-700"
                                      : payment.type === "BALANCE"
                                      ? "bg-emerald-100 text-emerald-700"
                                      : "bg-slate-100 text-slate-600"
                                  }`}>
                                    {payment.type}
                                  </span>
                                  <span className="text-sm text-slate-500">{payment.method}</span>
                                </div>
                                <p className="text-xs text-slate-400 mt-1">
                                  {formatDateTime(payment.paidAt)}
                                  {payment.reference && ` • ${payment.reference}`}
                                </p>
                              </div>
                              <span className={`font-semibold ${
                                payment.isRefunded ? "text-red-500 line-through" : "text-emerald-600"
                              }`}>
                                {formatCurrency(payment.amount)}
                              </span>
                            </div>
                          </div>
                        ))}
                      </div>
                      <div className="px-4 py-3 bg-slate-50 border-t border-slate-100 flex justify-between">
                        <span className="font-medium text-slate-700">Total Paid</span>
                        <span className="font-bold text-emerald-600">
                          {formatCurrency(totals.totalPaid)}
                        </span>
                      </div>
                    </div>
                  ) : (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center">
                      <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                      </div>
                      <p className="text-sm font-medium text-slate-600">No payments recorded</p>
                      <p className="text-xs text-slate-400 mt-1">Take a deposit to get started</p>
                    </div>
                  )}
                </div>
              )}
            </div>
          </>
        )}
      </div>

      {/* Deposit Modal */}
      {showDepositModal && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowDepositModal(false)} />
          <div className="relative bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 className="text-lg font-bold text-slate-900 mb-4">Take Deposit</h3>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                  Amount
                </label>
                <div className="relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">£</span>
                  <input
                    type="number"
                    value={depositAmount}
                    onChange={(e) => setDepositAmount(e.target.value)}
                    className="input input-bordered w-full pl-7"
                    placeholder="0.00"
                    step="0.01"
                    min="0"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                  Payment Method
                </label>
                <select
                  value={depositMethod}
                  onChange={(e) => setDepositMethod(e.target.value)}
                  className="select select-bordered w-full"
                >
                  <option value="CARD">Card</option>
                  <option value="CASH">Cash</option>
                  <option value="BANK_TRANSFER">Bank Transfer</option>
                  <option value="FINANCE">Finance</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                  Reference (optional)
                </label>
                <input
                  type="text"
                  value={depositReference}
                  onChange={(e) => setDepositReference(e.target.value)}
                  className="input input-bordered w-full"
                  placeholder="e.g., Transaction ID"
                />
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button
                onClick={() => setShowDepositModal(false)}
                className="btn btn-ghost flex-1"
              >
                Cancel
              </button>
              <button
                onClick={handleTakeDeposit}
                disabled={actionLoading === "deposit"}
                className="btn bg-amber-500 hover:bg-amber-600 text-white border-none flex-1"
              >
                {actionLoading === "deposit" ? (
                  <span className="loading loading-spinner loading-sm"></span>
                ) : (
                  "Record Deposit"
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
