# DealerHQ - Development Notes

## Recent Work Completed (January 2026)

### Sales Module Implementation
Full vehicle sales module with deal lifecycle, UK VAT handling, invoicing, and documents.

**Key Files:**
- `models/Deal.js` - Deal model with status workflow (DEPOSIT_TAKEN → INVOICED → DELIVERED → COMPLETED)
- `models/SalesDocument.js` - Invoice and deposit receipt records
- `models/PartExchange.js` - Links appraisals to deals
- `components/DealDrawer.js` - Deal management drawer with all tabs
- `pages/deals.js` - Deals list page with status tabs

### Reports Consolidation
Single consolidated reports page replacing separate report pages.

**Location:** `pages/reports/index.js`

**Report Types:**
- Sales Summary - revenue, deals closed, avg deal value
- VAT Report - output/input VAT for returns
- Inventory - current stock value and distribution
- Stock Book - purchase/sale/profit per vehicle
- Profitable Models - best performing makes/models
- Warranty Costs - aftercare claims analysis

**Features:** Period filtering, CSV export, print/PDF

### Document Updates
- Deposit receipts and invoices now always show mileage and VIN (with "Not recorded" fallback)
- Retail invoices include signature fields for buyer and dealer
- Trade/Export invoices do NOT show signature fields (controlled by `saleType` in snapshot)

### Part Exchange VRM Lookup Fix
Fixed DVLA lookup in DealDrawer - was using GET, changed to POST with JSON body:
```javascript
const res = await fetch("/api/dvla/vehicle-enquiry", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ registrationNumber: cleanVrm }),
});
```

### Marketing Homepage
Updated pricing and signup flow:
- Free tier emphasized (highlighted, "No card required")
- Pro: £49/month or £490/year (save £98)
- Monthly/yearly billing toggle
- All CTAs push free tier first

**Location:** `pages/index.js`

---

## Pending Test Drive Form Simplifications

When implementing test drive form changes:

If VRM is matched from stock, remove make/model fields below (redundant).

**Remove these fields:**
- License Number, License Expiry Date, License Type
- All Insurance details fields
- Mileage Out, Fuel Level Out
- Accompanied by staff member, Staff Member Name
- Date field below signature box
- All Return details (Damage Description, Damage Photos)

**Default values:**
- Date of test drive: today's date
- Time out: current time

---

## Architecture Notes

### Tenant-Aware Routes
Pages under `/pages/app/[dealerSlug]/` use TenantPage wrapper:
```javascript
import TenantPage from "@/components/TenantPage";
import MainPage from "@/pages/original-page";

export default function TenantRoute() {
  return <TenantPage><MainPage /></TenantPage>;
}
```

### DVLA API
POST to `/api/dvla/vehicle-enquiry` with `{ registrationNumber: "XX00XXX" }` in body.

### Sales Documents
Invoices and deposit receipts store snapshot data at time of generation. Changes to deal after document generation don't affect existing documents.

Key snapshot fields:
- `saleType`: RETAIL, TRADE, or EXPORT (controls signature display)
- `vatScheme`: VAT_QUALIFYING or MARGIN_SCHEME (controls VAT breakdown display)
