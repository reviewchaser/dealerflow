import { useEffect, useState } from "react";
import Head from "next/head";
import { useRouter } from "next/router";

// Format currency
const formatCurrency = (amount) => {
  if (amount === null || amount === undefined) return "—";
  return new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
  }).format(amount);
};

// Format date
const formatDate = (date) => {
  if (!date) return "";
  return new Date(date).toLocaleDateString("en-GB", {
    day: "numeric",
    month: "long",
    year: "numeric",
  });
};

export default function HandoverPackPage() {
  const router = useRouter();
  const { token, pdiId, serviceReceiptId } = router.query;
  const [invoice, setInvoice] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [activeTab, setActiveTab] = useState("invoice");

  useEffect(() => {
    if (!token) return;

    const fetchInvoice = async () => {
      setIsLoading(true);
      try {
        const res = await fetch(`/api/public/invoice/${token}`);
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || "Document not found");
        }
        const data = await res.json();
        setInvoice(data);
      } catch (error) {
        setError(error.message);
      } finally {
        setIsLoading(false);
      }
    };

    fetchInvoice();
  }, [token]);

  const handlePrint = () => {
    window.print();
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-100">
        <div className="loading loading-spinner loading-lg text-emerald-600"></div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-100">
        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md text-center">
          <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h1 className="text-xl font-bold text-slate-900 mb-2">Handover Pack Not Found</h1>
          <p className="text-slate-500">{error}</p>
        </div>
      </div>
    );
  }

  const snap = invoice?.snapshotData;
  const isMargin = snap?.vatScheme === "MARGIN";
  const invoiceTo = snap?.invoiceTo?.name ? snap.invoiceTo : snap?.customer;

  const tabs = [
    { id: "invoice", label: "Invoice", available: true },
    { id: "pdi", label: "PDI", available: !!pdiId },
    { id: "serviceReceipt", label: "Service Receipt", available: !!serviceReceiptId },
  ].filter((t) => t.available);

  return (
    <>
      <Head>
        <title>Handover Pack - {snap?.vehicle?.regCurrent} | DealerHQ</title>
      </Head>

      {/* Header - hidden when printing */}
      <div className="print:hidden bg-gradient-to-r from-emerald-600 to-emerald-700 text-white">
        <div className="max-w-[900px] mx-auto px-4 py-6">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-bold">Vehicle Handover Pack</h1>
              <p className="text-emerald-100 mt-1">
                {snap?.vehicle?.year} {snap?.vehicle?.make} {snap?.vehicle?.model}
                <span className="mx-2">•</span>
                <span className="font-mono font-bold">{snap?.vehicle?.regCurrent}</span>
              </p>
            </div>
            <button
              onClick={handlePrint}
              className="btn bg-white/20 hover:bg-white/30 text-white border-none"
            >
              <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
              </svg>
              Print All
            </button>
          </div>

          {/* Tabs */}
          {tabs.length > 1 && (
            <div className="flex gap-2 mt-6">
              {tabs.map((tab) => (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                    activeTab === tab.id
                      ? "bg-white text-emerald-700"
                      : "bg-white/20 text-white hover:bg-white/30"
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Content */}
      <div className="min-h-screen bg-slate-100 print:bg-white">
        {/* Invoice Tab */}
        {activeTab === "invoice" && invoice && (
          <div className="max-w-[900px] mx-auto p-4 print:p-0">
            <div className="bg-white shadow-xl print:shadow-none rounded-2xl print:rounded-none overflow-hidden">
              {/* Invoice Header */}
              <div className="bg-gradient-to-r from-slate-800 to-slate-900 print:from-slate-800 print:to-slate-800 text-white p-8 print:p-6">
                <div className="flex items-start justify-between">
                  <div>
                    <h2 className="text-3xl font-bold">INVOICE</h2>
                    <p className="text-slate-300 mt-1 text-lg">{invoice.documentNumber}</p>
                  </div>
                  <div className="text-right">
                    <p className="font-bold text-xl">{snap?.dealer?.companyName || snap?.dealer?.name}</p>
                    {snap?.dealer?.address && (
                      <p className="text-slate-300 text-sm mt-2 whitespace-pre-line">{snap.dealer.address}</p>
                    )}
                    {snap?.dealer?.vatNumber && (
                      <p className="text-slate-400 text-sm mt-2">VAT: {snap.dealer.vatNumber}</p>
                    )}
                  </div>
                </div>
              </div>

              {/* Invoice Body */}
              <div className="p-8 print:p-6 space-y-6">
                {/* Invoice Info */}
                <div className="grid grid-cols-3 gap-6">
                  <div>
                    <p className="text-sm text-slate-500 uppercase tracking-wide font-medium">Date</p>
                    <p className="text-lg font-semibold text-slate-900 mt-1">{formatDate(invoice.issuedAt)}</p>
                  </div>
                  <div>
                    <p className="text-sm text-slate-500 uppercase tracking-wide font-medium">Invoice No.</p>
                    <p className="text-lg font-semibold text-slate-900 mt-1">{invoice.documentNumber}</p>
                  </div>
                  <div>
                    <p className="text-sm text-slate-500 uppercase tracking-wide font-medium">VAT</p>
                    <p className="text-lg font-semibold text-slate-900 mt-1">
                      {isMargin ? "Margin" : "Standard"}
                    </p>
                  </div>
                </div>

                {/* Bill To */}
                <div className="bg-slate-50 rounded-xl p-5 print:bg-slate-50">
                  <p className="text-sm text-slate-500 uppercase tracking-wide font-medium mb-2">Invoice To</p>
                  <p className="text-lg font-bold text-slate-900">{invoiceTo?.name}</p>
                  {invoiceTo?.companyName && <p className="text-slate-600">{invoiceTo.companyName}</p>}
                </div>

                {/* Vehicle Details */}
                <div className="border border-slate-200 rounded-xl overflow-hidden">
                  <table className="w-full">
                    <thead className="bg-slate-50">
                      <tr>
                        <th className="text-left px-4 py-3 text-sm font-semibold text-slate-600">Description</th>
                        <th className="text-right px-4 py-3 text-sm font-semibold text-slate-600 w-28">Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr className="border-t border-slate-100">
                        <td className="px-4 py-4">
                          <p className="font-semibold text-slate-900">
                            {snap?.vehicle?.year} {snap?.vehicle?.make} {snap?.vehicle?.model}
                          </p>
                          <p className="text-sm text-slate-500">
                            VRM: {snap?.vehicle?.regCurrent}
                            {snap?.vehicle?.vin && ` | VIN: ${snap.vehicle.vin}`}
                          </p>
                        </td>
                        <td className="px-4 py-4 text-right font-semibold text-slate-900">
                          {formatCurrency(snap?.vehiclePriceGross)}
                        </td>
                      </tr>
                      {snap?.addOns?.map((addon, idx) => (
                        <tr key={idx} className="border-t border-slate-100">
                          <td className="px-4 py-3 text-slate-700">{addon.name}</td>
                          <td className="px-4 py-3 text-right text-slate-900">
                            {formatCurrency(addon.unitPriceNet * (addon.qty || 1))}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot className="bg-slate-800 text-white">
                      <tr>
                        <td className="px-4 py-3 font-semibold">Total</td>
                        <td className="px-4 py-3 text-right text-xl font-bold">
                          {formatCurrency(snap?.grandTotal)}
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                {/* Margin Scheme Notice */}
                {isMargin && (
                  <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 text-center">
                    <p className="text-amber-800 font-medium">Sold under the VAT margin scheme. No VAT is recoverable.</p>
                  </div>
                )}

                {/* Balance */}
                <div className="flex justify-end">
                  <div className="w-64 border border-slate-200 rounded-xl overflow-hidden">
                    {snap?.totalPaid > 0 && (
                      <div className="flex justify-between px-4 py-2 border-b border-slate-100">
                        <span className="text-emerald-600">Paid</span>
                        <span className="font-semibold text-emerald-600">-{formatCurrency(snap.totalPaid)}</span>
                      </div>
                    )}
                    <div className="flex justify-between px-4 py-3 bg-blue-50">
                      <span className="font-bold text-blue-900">Balance Due</span>
                      <span className="text-xl font-bold text-blue-900">{formatCurrency(snap?.balanceDue)}</span>
                    </div>
                  </div>
                </div>

                {/* Terms */}
                {snap?.termsText && (
                  <div className="border-t border-slate-200 pt-6">
                    <p className="text-xs text-slate-400 uppercase tracking-wide font-medium mb-2">Terms & Conditions</p>
                    <p className="text-xs text-slate-500 whitespace-pre-line">{snap.termsText}</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* PDI Tab */}
        {activeTab === "pdi" && pdiId && (
          <div className="max-w-[900px] mx-auto p-4">
            <div className="bg-white shadow-xl rounded-2xl overflow-hidden">
              <div className="p-4 border-b border-slate-200 flex items-center justify-between">
                <h2 className="text-lg font-bold text-slate-900">Pre-Delivery Inspection (PDI)</h2>
                <a
                  href={`/public/forms/${pdiId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="btn btn-sm bg-blue-500 hover:bg-blue-600 text-white border-none"
                >
                  Open Full PDI
                </a>
              </div>
              <iframe
                src={`/public/forms/${pdiId}`}
                className="w-full h-[800px] border-0"
                title="PDI Document"
              />
            </div>
          </div>
        )}

        {/* Service Receipt Tab */}
        {activeTab === "serviceReceipt" && serviceReceiptId && (
          <div className="max-w-[900px] mx-auto p-4">
            <div className="bg-white shadow-xl rounded-2xl overflow-hidden">
              <div className="p-4 border-b border-slate-200 flex items-center justify-between">
                <h2 className="text-lg font-bold text-slate-900">Service Receipt</h2>
                <a
                  href={`/public/forms/${serviceReceiptId}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="btn btn-sm bg-blue-500 hover:bg-blue-600 text-white border-none"
                >
                  Open Full Receipt
                </a>
              </div>
              <iframe
                src={`/public/forms/${serviceReceiptId}`}
                className="w-full h-[800px] border-0"
                title="Service Receipt Document"
              />
            </div>
          </div>
        )}
      </div>

      <style jsx global>{`
        @media print {
          @page {
            size: A4;
            margin: 0;
          }
          body {
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
          }
        }
      `}</style>
    </>
  );
}
