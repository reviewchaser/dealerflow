import mongoose from "mongoose";
import toJSON from "./plugins/toJSON";

/**
 * Contact Model
 *
 * Unified contact model for customers, suppliers, and finance companies.
 * Uses typeTags array to support contacts that serve multiple roles.
 */

const contactSchema = new mongoose.Schema(
  {
    dealerId: { type: mongoose.Schema.Types.ObjectId, ref: "Dealer", required: true },

    // Contact type tags (can have multiple)
    typeTags: [{
      type: String,
      enum: ["CUSTOMER", "FINANCE", "SUPPLIER"],
    }],

    // Whether this is a prospect (lead) or actual contact
    isProspect: { type: Boolean, default: false },

    // === BASIC INFO ===
    displayName: { type: String, required: true }, // Primary display name
    companyName: { type: String }, // Company if applicable

    // Contact details
    email: { type: String, lowercase: true, trim: true },
    phone: { type: String },
    mobile: { type: String },

    // Address
    address: {
      line1: { type: String },
      line2: { type: String },
      town: { type: String },
      county: { type: String },
      postcode: { type: String, uppercase: true },
      country: { type: String, default: "United Kingdom" },
    },

    // === BUSINESS INFO (for suppliers/finance) ===
    companyNumber: { type: String },
    vatNumber: { type: String },
    accountReference: { type: String }, // Supplier/finance account ref

    // === FINANCE COMPANY SPECIFIC ===
    financeSettings: {
      commissionRate: { type: Number }, // Percentage
      contactPerson: { type: String },
      contactEmail: { type: String },
      contactPhone: { type: String },
    },

    // === METADATA ===
    notes: { type: String },
    isActive: { type: Boolean, default: true },

    // Source tracking
    sourceType: {
      type: String,
      enum: ["MANUAL", "TEST_DRIVE", "APPRAISAL", "ENQUIRY", "IMPORT"],
      default: "MANUAL",
    },
    sourceId: { type: mongoose.Schema.Types.ObjectId }, // Link to source record

    // Audit fields
    createdByUserId: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
    updatedByUserId: { type: mongoose.Schema.Types.ObjectId, ref: "User" },
  },
  { timestamps: true }
);

contactSchema.plugin(toJSON);

// Indexes
contactSchema.index({ dealerId: 1, displayName: 1 });
contactSchema.index({ dealerId: 1, email: 1 }, { sparse: true });
contactSchema.index({ dealerId: 1, phone: 1 }, { sparse: true });
contactSchema.index({ dealerId: 1, typeTags: 1 });
contactSchema.index({ dealerId: 1, isActive: 1 });
contactSchema.index({ dealerId: 1, createdAt: -1 });

// Text search index for name/email/company
contactSchema.index({ displayName: "text", email: "text", companyName: "text" });

export default mongoose.models?.Contact || mongoose.model("Contact", contactSchema);
