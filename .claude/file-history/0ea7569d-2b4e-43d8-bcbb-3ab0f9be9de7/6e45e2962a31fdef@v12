import { useState, useEffect, useCallback } from "react";
import { toast } from "react-hot-toast";
import ContactPicker from "@/components/ContactPicker";

// Format currency
const formatCurrency = (amount) => {
  if (amount === null || amount === undefined) return "—";
  return new Intl.NumberFormat("en-GB", {
    style: "currency",
    currency: "GBP",
  }).format(amount);
};

// Format date helper
const formatDate = (date) => {
  if (!date) return "";
  return new Date(date).toLocaleDateString("en-GB", {
    day: "numeric",
    month: "short",
    year: "numeric",
  });
};

// Format datetime helper
const formatDateTime = (date) => {
  if (!date) return "";
  return new Date(date).toLocaleString("en-GB", {
    day: "numeric",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
};

// Status labels and colors
const STATUS_CONFIG = {
  DRAFT: { label: "Draft", color: "bg-slate-100 text-slate-600" },
  DEPOSIT_TAKEN: { label: "Deposit Taken", color: "bg-amber-100 text-amber-700" },
  INVOICED: { label: "Invoiced", color: "bg-blue-100 text-blue-700" },
  DELIVERED: { label: "Delivered", color: "bg-purple-100 text-purple-700" },
  COMPLETED: { label: "Completed", color: "bg-emerald-100 text-emerald-700" },
  CANCELLED: { label: "Cancelled", color: "bg-red-100 text-red-700" },
};

const VAT_SCHEME_LABELS = {
  MARGIN: "Margin Scheme",
  VAT_QUALIFYING: "VAT Qualifying",
  NO_VAT: "No VAT",
  ZERO: "Zero-rated",
  EXEMPT: "VAT Exempt",
};

const SALE_TYPE_OPTIONS = [
  { value: "RETAIL", label: "Retail", description: "Sale to end customer" },
  { value: "TRADE", label: "Trade", description: "Sale to motor trader" },
  { value: "EXPORT", label: "Export", description: "Export sale" },
];

const BUYER_USE_OPTIONS = [
  { value: "PERSONAL", label: "Personal use", description: "Consumer rights apply" },
  { value: "BUSINESS", label: "Business use", description: "B2B terms apply" },
];

const SALE_CHANNEL_OPTIONS = [
  { value: "IN_PERSON", label: "In person", description: "Customer saw vehicle on-site" },
  { value: "DISTANCE", label: "Distance", description: "Online/phone sale - 14 day cooling off" },
];

const PAYMENT_TYPE_OPTIONS = [
  { value: "CASH", label: "Cash" },
  { value: "CARD", label: "Card" },
  { value: "BANK_TRANSFER", label: "Bank Transfer" },
  { value: "FINANCE", label: "Finance" },
  { value: "MIXED", label: "Mixed" },
];

const FINANCE_TYPE_OPTIONS = [
  { value: "HP", label: "Hire Purchase (HP)" },
  { value: "PCP", label: "Personal Contract Purchase (PCP)" },
  { value: "LEASE", label: "Lease" },
  { value: "PERSONAL_LOAN", label: "Personal Loan" },
  { value: "OTHER", label: "Other" },
];

const FINANCE_STATUS_OPTIONS = [
  { value: "QUOTED", label: "Quoted" },
  { value: "SUBMITTED", label: "Submitted" },
  { value: "APPROVED", label: "Approved" },
  { value: "DECLINED", label: "Declined" },
  { value: "PAID_OUT", label: "Paid Out" },
];

/**
 * DealDrawer - Display and manage deal details
 *
 * Props:
 * - dealId: The ID of the deal to display
 * - isOpen: Whether the drawer is open
 * - onClose: Function to call when closing the drawer
 * - onUpdate: Function to call when deal is updated
 */
export default function DealDrawer({
  dealId,
  isOpen,
  onClose,
  onUpdate,
}) {
  const [deal, setDeal] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [fetchError, setFetchError] = useState(null);
  const [activeTab, setActiveTab] = useState("overview");
  const [actionLoading, setActionLoading] = useState(null);

  // Deposit modal state
  const [showDepositModal, setShowDepositModal] = useState(false);
  const [depositAmount, setDepositAmount] = useState("");
  const [depositMethod, setDepositMethod] = useState("CARD");
  const [depositReference, setDepositReference] = useState("");

  // Customer editing state
  const [isEditingCustomer, setIsEditingCustomer] = useState(false);
  const [isEditingInvoiceTo, setIsEditingInvoiceTo] = useState(false);
  const [invoiceToOption, setInvoiceToOption] = useState("CUSTOMER"); // CUSTOMER or OTHER

  // Document state
  const [documents, setDocuments] = useState({ depositReceipt: null, invoice: null });

  // Handover pack state
  const [showHandoverModal, setShowHandoverModal] = useState(false);
  const [handoverDocs, setHandoverDocs] = useState({
    invoice: true,
    pdi: false,
    serviceReceipt: false,
  });
  const [linkedSubmissions, setLinkedSubmissions] = useState({ pdi: null, serviceReceipt: null });
  const [isGeneratingPack, setIsGeneratingPack] = useState(false);

  // Deal details editing state
  const [isEditingPrice, setIsEditingPrice] = useState(false);
  const [priceInput, setPriceInput] = useState("");
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

  // Add-on state
  const [showAddOnPicker, setShowAddOnPicker] = useState(false);
  const [availableAddOns, setAvailableAddOns] = useState([]);
  const [addOnsLoading, setAddOnsLoading] = useState(false);
  const [addOnQty, setAddOnQty] = useState(1);
  const [addOnPrice, setAddOnPrice] = useState("");

  // Agreed Work Items state
  const [showAgreedWorkModal, setShowAgreedWorkModal] = useState(false);
  const [agreedWorkForm, setAgreedWorkForm] = useState({
    title: "",
    details: "",
    type: "PREP",
    syncToVehicle: true,
  });

  // Part Exchange state
  const [showPxModal, setShowPxModal] = useState(false);
  const [pxForm, setPxForm] = useState({
    vrm: "",
    make: "",
    model: "",
    year: "",
    mileage: "",
    colour: "",
    fuelType: "",
    allowance: "",
    settlement: "",
    sourceType: "MANUAL",
    sourceId: null,
    conditionNotes: "",
  });
  const [pxLoading, setPxLoading] = useState(false);
  const [pxLookupLoading, setPxLookupLoading] = useState(false);
  const [pxAppraisalSuggestions, setPxAppraisalSuggestions] = useState([]);
  const [pxAppraisalSearching, setPxAppraisalSearching] = useState(false);
  const [selectedPxAppraisal, setSelectedPxAppraisal] = useState(null);

  // VRM Lookup for Part Exchange
  const handlePxVrmLookup = async () => {
    const cleanVrm = pxForm.vrm?.replace(/\s/g, "").toUpperCase();
    if (!cleanVrm || cleanVrm.length < 2) {
      toast.error("Please enter a valid registration");
      return;
    }

    setPxLookupLoading(true);
    try {
      const res = await fetch(`/api/dvla/vehicle-enquiry?vrm=${encodeURIComponent(cleanVrm)}`);
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "VRM lookup failed");
      }

      const data = await res.json();

      // Extract year from registration date
      let year = "";
      if (data.yearOfManufacture) {
        year = String(data.yearOfManufacture);
      } else if (data.monthOfFirstRegistration) {
        year = data.monthOfFirstRegistration.split("-")[0];
      }

      setPxForm((prev) => ({
        ...prev,
        vrm: cleanVrm,
        make: data.make || prev.make,
        model: data.model || prev.model,
        year: year || prev.year,
        colour: data.colour || prev.colour,
        fuelType: data.fuelType || prev.fuelType,
      }));

      toast.success("Vehicle details loaded from DVLA");
    } catch (error) {
      toast.error(error.message || "VRM lookup failed");
    } finally {
      setPxLookupLoading(false);
    }
  };

  // Search appraisals by VRM for Part Exchange import
  const handlePxAppraisalSearch = async (vrm) => {
    const cleanVrm = vrm?.replace(/\s/g, "").toUpperCase();
    if (!cleanVrm || cleanVrm.length < 2) {
      setPxAppraisalSuggestions([]);
      return;
    }

    setPxAppraisalSearching(true);
    try {
      const res = await fetch(`/api/vehicles/vrm-suggestions?q=${encodeURIComponent(cleanVrm)}`);
      if (res.ok) {
        const data = await res.json();
        setPxAppraisalSuggestions(data);
      }
    } catch (error) {
      console.error("Appraisal search failed:", error);
    } finally {
      setPxAppraisalSearching(false);
    }
  };

  // Select an appraisal to import into PX form
  const handleSelectPxAppraisal = (appraisal) => {
    setSelectedPxAppraisal(appraisal);
    setPxForm({
      vrm: appraisal.vehicleReg || "",
      make: appraisal.vehicleMake || "",
      model: appraisal.vehicleModel || "",
      year: appraisal.vehicleYear || "",
      mileage: appraisal.mileage || "",
      colour: appraisal.colour || "",
      fuelType: appraisal.fuelType || "",
      allowance: appraisal.proposedPurchasePrice || "",
      settlement: appraisal.outstandingFinanceAmount || "",
      sourceType: appraisal.type === "customer_px" ? "CUSTOMER_FORM" : "DEALER_APPRAISAL",
      sourceId: appraisal.id,
      conditionNotes: appraisal.conditionNotes || "",
    });
    setPxAppraisalSuggestions([]);
    toast.success(`Imported from ${appraisal.type === "customer_px" ? "customer" : "dealer"} appraisal`);
  };

  // Clear PX appraisal selection
  const handleClearPxAppraisal = () => {
    setSelectedPxAppraisal(null);
    setPxForm({
      vrm: "",
      make: "",
      model: "",
      year: "",
      mileage: "",
      colour: "",
      fuelType: "",
      allowance: "",
      settlement: "",
      sourceType: "MANUAL",
      sourceId: null,
      conditionNotes: "",
    });
  };

  // Fetch available add-on products
  const fetchAddOnProducts = async () => {
    setAddOnsLoading(true);
    try {
      const res = await fetch("/api/addons");
      if (res.ok) {
        const data = await res.json();
        setAvailableAddOns(data);
      }
    } catch (error) {
      console.error("Failed to fetch add-ons:", error);
    } finally {
      setAddOnsLoading(false);
    }
  };

  // Add an add-on to the deal
  const handleAddAddOn = async (addOnProduct) => {
    if (!deal) return;

    const price = addOnPrice ? parseFloat(addOnPrice) : addOnProduct.defaultPriceNet;

    const newAddOn = {
      addOnProductId: addOnProduct.id,
      name: addOnProduct.name,
      category: addOnProduct.category,
      qty: addOnQty,
      unitPriceNet: price,
      vatTreatment: addOnProduct.vatTreatment || "STANDARD",
      vatRate: addOnProduct.vatRate || 0.2,
    };

    setActionLoading("addon");
    try {
      const updatedAddOns = [...(deal.addOns || []), newAddOn];
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ addOns: updatedAddOns }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to add add-on");
      }

      toast.success("Add-on added");
      setShowAddOnPicker(false);
      setAddOnQty(1);
      setAddOnPrice("");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  // Remove an add-on from the deal
  const handleRemoveAddOn = async (index) => {
    if (!deal) return;

    setActionLoading("addon");
    try {
      const updatedAddOns = deal.addOns.filter((_, i) => i !== index);
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ addOns: updatedAddOns }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to remove add-on");
      }

      toast.success("Add-on removed");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  // Add an agreed work item
  const handleAddAgreedWork = async () => {
    if (!deal || !agreedWorkForm.title.trim()) {
      toast.error("Please enter a title");
      return;
    }

    setActionLoading("agreedWork");
    try {
      const newRequest = {
        title: agreedWorkForm.title.trim(),
        details: agreedWorkForm.details.trim(),
        type: agreedWorkForm.type,
        status: "REQUESTED",
        createdAt: new Date().toISOString(),
      };

      // If sync to vehicle is enabled, create a VehicleIssue
      if (agreedWorkForm.syncToVehicle && deal.vehicleId) {
        const vehicleId = deal.vehicleId._id || deal.vehicleId;
        const issueRes = await fetch(`/api/vehicles/${vehicleId}/issues`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: agreedWorkForm.type === "COSMETIC" ? "Cosmetic" : agreedWorkForm.type === "PREP" ? "Mechanical" : "Other",
            subcategory: "Customer Promise",
            description: agreedWorkForm.title.trim(),
            actionNeeded: agreedWorkForm.details.trim() || `Agreed at sale: ${agreedWorkForm.title.trim()}`,
            priority: "high",
            status: "Outstanding",
          }),
        });

        if (issueRes.ok) {
          const issue = await issueRes.json();
          newRequest.linkToIssueId = issue.id || issue._id;
        }
      }

      const updatedRequests = [...(deal.requests || []), newRequest];
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ requests: updatedRequests }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to add agreed work");
      }

      toast.success("Agreed work added");
      setShowAgreedWorkModal(false);
      setAgreedWorkForm({ title: "", details: "", type: "PREP", syncToVehicle: true });
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  // Update agreed work status
  const handleUpdateAgreedWorkStatus = async (index, newStatus) => {
    if (!deal) return;

    setActionLoading("agreedWork");
    try {
      const updatedRequests = deal.requests.map((req, i) => {
        if (i === index) {
          return {
            ...req,
            status: newStatus,
            completedAt: newStatus === "DONE" ? new Date().toISOString() : null,
          };
        }
        return req;
      });

      const res = await fetch(`/api/deals/${dealId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ requests: updatedRequests }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to update status");
      }

      toast.success("Status updated");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  // Remove an agreed work item
  const handleRemoveAgreedWork = async (index) => {
    if (!deal) return;

    setActionLoading("agreedWork");
    try {
      const updatedRequests = deal.requests.filter((_, i) => i !== index);
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ requests: updatedRequests }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to remove agreed work");
      }

      toast.success("Agreed work removed");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  // Lock body scroll when drawer is open
  useEffect(() => {
    if (isOpen) {
      const scrollY = window.scrollY;
      const html = document.documentElement;

      document.body.style.position = "fixed";
      document.body.style.top = `-${scrollY}px`;
      document.body.style.left = "0";
      document.body.style.right = "0";
      document.body.style.width = "100%";
      document.body.style.overflow = "hidden";
      document.body.style.touchAction = "none";

      html.style.overflow = "hidden";

      return () => {
        document.body.style.position = "";
        document.body.style.top = "";
        document.body.style.left = "";
        document.body.style.right = "";
        document.body.style.width = "";
        document.body.style.overflow = "";
        document.body.style.touchAction = "";

        html.style.overflow = "";

        window.scrollTo(0, scrollY);
      };
    }
  }, [isOpen]);

  useEffect(() => {
    if (isOpen && dealId) {
      fetchDeal();
    } else if (!dealId) {
      // Reset state when dealId is cleared
      setDeal(null);
      setFetchError(null);
    }
  }, [isOpen, dealId]);

  const fetchDeal = async () => {
    setIsLoading(true);
    setFetchError(null);
    try {
      const res = await fetch(`/api/deals/${dealId}`);
      if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || `Failed to load deal (${res.status})`);
      }
      const data = await res.json();
      setDeal(data);
      // Fetch documents after deal is loaded
      fetchDocuments();
    } catch (error) {
      console.error("[DealDrawer] Fetch error:", error);
      setFetchError(error.message || "Failed to load deal details");
      // Don't show toast here - we'll show error in UI instead
    } finally {
      setIsLoading(false);
    }
  };

  const fetchDocuments = async () => {
    try {
      const res = await fetch(`/api/deals/${dealId}/documents`);
      if (res.ok) {
        const data = await res.json();
        setDocuments({
          depositReceipt: data.documents?.find(d => d.type === "DEPOSIT_RECEIPT" && d.status !== "VOID"),
          invoice: data.documents?.find(d => d.type === "INVOICE" && d.status !== "VOID"),
        });
      }
    } catch (error) {
      console.error("Failed to fetch documents:", error);
    }
  };

  // Fetch linked submissions (PDI, Service Receipt) for the vehicle
  const fetchLinkedSubmissions = async () => {
    if (!deal?.vehicleId?._id && !deal?.vehicleId) return;

    const vehicleId = deal.vehicleId._id || deal.vehicleId;
    try {
      const res = await fetch(`/api/vehicles/${vehicleId}/submissions`);
      if (res.ok) {
        const data = await res.json();
        setLinkedSubmissions({
          pdi: data.submissions?.find(s => s.formType === "PDI"),
          serviceReceipt: data.submissions?.find(s => s.formType === "SERVICE_RECEIPT"),
        });
      }
    } catch (error) {
      console.error("Failed to fetch linked submissions:", error);
    }
  };

  // Open handover modal
  const handleOpenHandover = async () => {
    await fetchLinkedSubmissions();
    setHandoverDocs({
      invoice: true,
      pdi: !!linkedSubmissions.pdi,
      serviceReceipt: !!linkedSubmissions.serviceReceipt,
    });
    setShowHandoverModal(true);
  };

  // Generate handover pack
  const handleGenerateHandoverPack = async () => {
    if (!documents.invoice) {
      toast.error("Invoice is required");
      return;
    }

    setIsGeneratingPack(true);
    try {
      // Open the handover pack page in a new tab
      const params = new URLSearchParams({
        invoiceToken: documents.invoice.shareToken,
        ...(handoverDocs.pdi && linkedSubmissions.pdi && { pdiId: linkedSubmissions.pdi.id }),
        ...(handoverDocs.serviceReceipt && linkedSubmissions.serviceReceipt && { serviceId: linkedSubmissions.serviceReceipt.id }),
      });

      window.open(`/public/handover-pack/${documents.invoice.shareToken}?${params.toString()}`, "_blank");
      setShowHandoverModal(false);
    } catch (error) {
      toast.error("Failed to generate handover pack");
    } finally {
      setIsGeneratingPack(false);
    }
  };

  // Calculate totals
  const calculateTotals = () => {
    if (!deal) return {};

    const addOnsNetTotal = (deal.addOns || []).reduce(
      (sum, a) => sum + (a.unitPriceNet * (a.qty || 1)),
      0
    );
    const addOnsVatTotal = (deal.addOns || []).reduce((sum, a) => {
      if (a.vatTreatment === "STANDARD") {
        return sum + a.unitPriceNet * (a.qty || 1) * (a.vatRate || 0.2);
      }
      return sum;
    }, 0);

    let subtotal, totalVat, grandTotal;

    if (deal.vatScheme === "VAT_QUALIFYING") {
      subtotal = (deal.vehiclePriceNet || 0) + addOnsNetTotal;
      totalVat = (deal.vehicleVatAmount || 0) + addOnsVatTotal;
      grandTotal = subtotal + totalVat;
    } else {
      subtotal = (deal.vehiclePriceGross || 0) + addOnsNetTotal + addOnsVatTotal;
      totalVat = 0;
      grandTotal = subtotal;
    }

    const totalPaid = (deal.payments || [])
      .filter((p) => !p.isRefunded)
      .reduce((sum, p) => sum + p.amount, 0);

    const pxNetValue = deal.partExchange
      ? (deal.partExchange.allowance || 0) - (deal.partExchange.settlement || 0)
      : 0;

    const balanceDue = grandTotal - totalPaid - pxNetValue;

    return {
      addOnsNetTotal,
      addOnsVatTotal,
      subtotal,
      totalVat,
      grandTotal,
      totalPaid,
      pxNetValue,
      balanceDue,
    };
  };

  // Deal actions
  const handleTakeDeposit = async () => {
    if (!depositAmount || parseFloat(depositAmount) <= 0) {
      toast.error("Please enter a valid deposit amount");
      return;
    }

    setActionLoading("deposit");
    try {
      const res = await fetch(`/api/deals/${dealId}/take-deposit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          amount: parseFloat(depositAmount),
          method: depositMethod,
          reference: depositReference,
        }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to record deposit");
      }

      const result = await res.json();
      toast.success(`Deposit recorded: ${result.documentNumber}`);
      setShowDepositModal(false);
      setDepositAmount("");
      setDepositReference("");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  // Add Part Exchange
  const handleAddPartExchange = async () => {
    if (!pxForm.vrm) {
      toast.error("Please enter a VRM");
      return;
    }
    if (!pxForm.allowance || parseFloat(pxForm.allowance) <= 0) {
      toast.error("Please enter a valid allowance amount");
      return;
    }

    setPxLoading(true);
    try {
      const res = await fetch(`/api/deals/${dealId}/add-part-exchange`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          vrm: pxForm.vrm,
          make: pxForm.make,
          model: pxForm.model,
          year: pxForm.year ? parseInt(pxForm.year) : undefined,
          mileage: pxForm.mileage ? parseInt(pxForm.mileage) : undefined,
          colour: pxForm.colour,
          fuelType: pxForm.fuelType || undefined,
          allowance: parseFloat(pxForm.allowance),
          settlement: pxForm.settlement ? parseFloat(pxForm.settlement) : 0,
          sourceType: pxForm.sourceType || "MANUAL",
          sourceId: pxForm.sourceId || undefined,
          conditionSummary: pxForm.conditionNotes || undefined,
        }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to add part exchange");
      }

      toast.success("Part exchange added");
      setShowPxModal(false);
      setSelectedPxAppraisal(null);
      setPxForm({
        vrm: "",
        make: "",
        model: "",
        year: "",
        mileage: "",
        colour: "",
        fuelType: "",
        allowance: "",
        settlement: "",
        sourceType: "MANUAL",
        sourceId: null,
        conditionNotes: "",
      });
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setPxLoading(false);
    }
  };

  const handleGenerateInvoice = async () => {
    setActionLoading("invoice");
    try {
      const res = await fetch(`/api/deals/${dealId}/generate-invoice`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to generate invoice");
      }

      const result = await res.json();
      toast.success(`Invoice generated: ${result.documentNumber}`);
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleMarkDelivered = async () => {
    setActionLoading("delivered");
    try {
      const res = await fetch(`/api/deals/${dealId}/mark-delivered`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to mark as delivered");
      }

      toast.success("Deal marked as delivered");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleMarkCompleted = async () => {
    setActionLoading("completed");
    try {
      const res = await fetch(`/api/deals/${dealId}/mark-completed`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to complete deal");
      }

      toast.success("Deal completed");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleCancelDeal = async () => {
    if (!confirm("Are you sure you want to cancel this deal?")) return;

    setActionLoading("cancel");
    try {
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ cancelReason: "Cancelled by user" }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to cancel deal");
      }

      toast.success("Deal cancelled");
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleUpdateCustomer = async (contactId) => {
    if (!contactId) return;

    setActionLoading("customer");
    try {
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ soldToContactId: contactId }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to update customer");
      }

      toast.success("Customer updated");
      setIsEditingCustomer(false);
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  const handleUpdateInvoiceTo = async (contactId) => {
    setActionLoading("invoiceTo");
    try {
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ invoiceToContactId: contactId || null }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to update invoice recipient");
      }

      toast.success("Invoice recipient updated");
      setIsEditingInvoiceTo(false);
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  // Update invoice to option when deal loads
  useEffect(() => {
    if (deal) {
      if (deal.invoiceToContactId && deal.invoiceToContactId !== deal.soldToContactId) {
        setInvoiceToOption("OTHER");
      } else {
        setInvoiceToOption("CUSTOMER");
      }
    }
  }, [deal?.id, deal?.invoiceToContactId, deal?.soldToContactId]);

  // Generic field update handler
  const handleUpdateField = async (updates, successMessage) => {
    setActionLoading("field");
    try {
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to update");
      }

      if (successMessage) toast.success(successMessage);
      fetchDeal();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  // Update vehicle price
  const handleUpdatePrice = async () => {
    const price = parseFloat(priceInput);
    if (isNaN(price) || price <= 0) {
      toast.error("Please enter a valid price");
      return;
    }

    const updates = { vehiclePriceGross: price };

    // For VAT qualifying, calculate net and VAT
    if (deal.vatScheme === "VAT_QUALIFYING") {
      const vatRate = deal.vatRate || 0.2;
      const net = price / (1 + vatRate);
      updates.vehiclePriceNet = Math.round(net * 100) / 100;
      updates.vehicleVatAmount = Math.round((price - net) * 100) / 100;
    }

    await handleUpdateField(updates, "Price updated");
    setIsEditingPrice(false);
  };

  // Delete draft deal
  const handleDeleteDraft = async () => {
    if (deal.status !== "DRAFT") {
      toast.error("Only draft deals can be deleted");
      return;
    }

    setActionLoading("delete");
    try {
      const res = await fetch(`/api/deals/${dealId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ hardDelete: true }),
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to delete deal");
      }

      toast.success("Draft deleted");
      setShowDeleteConfirm(false);
      onClose?.();
      onUpdate?.();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setActionLoading(null);
    }
  };

  // Check deal readiness
  const getReadinessChecks = () => {
    if (!deal) return [];

    const checks = [
      {
        id: "vehicle",
        label: "Vehicle selected",
        passed: !!deal.vehicleId || !!deal.vehicle,
        tab: null, // Vehicle is auto-selected on deal creation
      },
      {
        id: "customer",
        label: "Customer selected",
        passed: !!deal.soldToContactId || !!deal.customer,
        tab: "customer",
      },
      {
        id: "saleType",
        label: "Sale type set",
        passed: !!deal.saleType,
        tab: "overview",
      },
      {
        id: "paymentType",
        label: "Settlement plan set",
        passed: !!deal.paymentType,
        tab: "overview",
      },
      {
        id: "price",
        label: "Vehicle price set",
        passed: deal.vehiclePriceGross > 0,
        tab: "overview",
      },
      {
        id: "vatScheme",
        label: "VAT treatment set",
        passed: !!deal.vatScheme,
        tab: "overview",
      },
    ];

    return checks;
  };

  // Check if deposit can be taken
  const canTakeDeposit = () => {
    if (!deal) return { allowed: false, reasons: [] };

    const reasons = [];
    if (!deal.soldToContactId && !deal.customer) reasons.push("Customer not selected");
    if (!deal.vehiclePriceGross || deal.vehiclePriceGross <= 0) reasons.push("Vehicle price not set");

    return { allowed: reasons.length === 0, reasons };
  };

  // Check if invoice can be generated
  const canGenerateInvoice = () => {
    if (!deal) return { allowed: false, reasons: [] };

    // Already invoiced
    if (["INVOICED", "DELIVERED", "COMPLETED"].includes(deal.status)) {
      return { allowed: false, reasons: ["Invoice already generated"] };
    }
    if (deal.status === "CANCELLED") {
      return { allowed: false, reasons: ["Deal is cancelled"] };
    }

    const reasons = [];
    if (!deal.soldToContactId && !deal.customer) reasons.push("Customer not selected");
    if (!deal.vehiclePriceGross || deal.vehiclePriceGross <= 0) reasons.push("Vehicle price not set");
    if (!deal.vatScheme) reasons.push("VAT treatment not set");
    if (!deal.saleType) reasons.push("Sale type not set");

    return { allowed: reasons.length === 0, reasons };
  };

  if (!isOpen) return null;

  const totals = calculateTotals();
  const statusConfig = STATUS_CONFIG[deal?.status] || STATUS_CONFIG.DRAFT;

  return (
    <div
      className="fixed inset-0 flex justify-end z-50 drawer-locked"
      style={{ touchAction: "none", overscrollBehavior: "none" }}
    >
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity duration-300"
        onClick={onClose}
      />

      {/* Drawer */}
      <div
        className="relative bg-[#f8fafc] flex flex-col w-full max-w-3xl min-w-0 translate-x-0 overflow-x-hidden shadow-2xl"
        style={{
          height: "100dvh",
          maxHeight: "100dvh",
          touchAction: "pan-y",
        }}
      >
        {isLoading ? (
          <div className="flex items-center justify-center h-full">
            <span className="loading loading-spinner loading-lg text-[#0066CC]"></span>
          </div>
        ) : fetchError ? (
          <div className="flex flex-col items-center justify-center h-full p-6">
            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
              <svg className="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <p className="text-lg font-semibold text-slate-900 mb-1">Failed to load deal</p>
            <p className="text-sm text-slate-500 text-center mb-4">{fetchError}</p>
            <div className="flex gap-2">
              <button className="btn btn-ghost" onClick={onClose}>
                Close
              </button>
              <button className="btn bg-[#0066CC] hover:bg-[#0052a3] text-white border-none" onClick={fetchDeal}>
                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Retry
              </button>
            </div>
          </div>
        ) : !deal ? (
          <div className="flex flex-col items-center justify-center h-full p-6">
            <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
              <svg className="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <p className="text-lg font-semibold text-slate-900 mb-1">Deal not found</p>
            <p className="text-sm text-slate-500 text-center mb-4">This deal may have been deleted or you may not have access</p>
            <button className="btn btn-ghost" onClick={onClose}>
              Close
            </button>
          </div>
        ) : (
          <>
            {/* Header */}
            <div className="sticky top-0 bg-white border-b border-slate-100 px-4 md:px-6 py-4 md:py-5 z-10 shrink-0 shadow-sm">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <button
                    className="flex items-center justify-center w-9 h-9 rounded-xl bg-slate-100 hover:bg-[#0066CC]/10 text-slate-500 hover:text-[#0066CC] transition-all"
                    onClick={onClose}
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <div>
                    <h2 className="text-lg md:text-xl font-bold text-slate-900">
                      Deal #{deal.dealNumber || "—"}
                    </h2>
                    <div className="flex items-center gap-2 mt-1">
                      <span className={`inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-semibold ${statusConfig.color}`}>
                        {statusConfig.label}
                      </span>
                      {deal.vehicle && (
                        <span className="inline-flex items-center px-2.5 py-1 rounded-lg bg-slate-900 text-white text-xs font-mono font-bold tracking-wider">
                          {deal.vehicle.regCurrent}
                        </span>
                      )}
                    </div>
                  </div>
                </div>
                {/* Document buttons */}
                <div className="flex items-center gap-2">
                  {documents.depositReceipt && (
                    <a
                      href={documents.depositReceipt.shareUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-amber-100 hover:bg-amber-200 text-amber-700 text-xs font-medium transition-colors"
                      title="View Deposit Receipt"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      <span className="hidden md:inline">Receipt</span>
                    </a>
                  )}
                  {documents.invoice && (
                    <a
                      href={documents.invoice.shareUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs font-medium transition-colors"
                      title="View Invoice"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      <span className="hidden md:inline">Invoice</span>
                    </a>
                  )}
                  {documents.invoice && (
                    <button
                      onClick={handleOpenHandover}
                      className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-emerald-100 hover:bg-emerald-200 text-emerald-700 text-xs font-medium transition-colors"
                      title="Generate Handover Pack"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                      </svg>
                      <span className="hidden md:inline">Handover</span>
                    </button>
                  )}
                  <button
                    className="flex items-center justify-center w-9 h-9 rounded-xl bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 transition-all"
                    onClick={onClose}
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="sticky top-[73px] md:top-[89px] bg-white border-b border-slate-100 px-4 py-3 z-10 shrink-0">
              {/* Mobile: Dropdown selector */}
              <div className="md:hidden">
                <select
                  value={activeTab}
                  onChange={(e) => setActiveTab(e.target.value)}
                  className="select select-bordered w-full font-medium"
                >
                  <option value="overview">Summary</option>
                  <option value="customer">Customer</option>
                  <option value="addons">Add-ons ({deal.addOns?.length || 0})</option>
                  <option value="payments">Payments ({deal.payments?.length || 0})</option>
                </select>
              </div>

              {/* Desktop: Pill tabs */}
              <div className="hidden md:flex items-center gap-2 overflow-x-auto pb-1 -mb-1">
                {[
                  { id: "overview", label: "Summary" },
                  { id: "customer", label: "Customer" },
                  { id: "addons", label: "Add-ons", count: deal.addOns?.length },
                  { id: "payments", label: "Payments", count: deal.payments?.length },
                ].map((tab) => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium whitespace-nowrap transition-all ${
                      activeTab === tab.id
                        ? "bg-[#0066CC] text-white shadow-md shadow-[#0066CC]/25"
                        : "bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-slate-900"
                    }`}
                  >
                    <span>{tab.label}</span>
                    {tab.count > 0 && (
                      <span className={`inline-flex items-center justify-center min-w-[20px] h-5 px-1.5 rounded-full text-xs font-bold ${
                        activeTab === tab.id
                          ? "bg-white/20 text-white"
                          : "bg-slate-200 text-slate-600"
                      }`}>
                        {tab.count}
                      </span>
                    )}
                  </button>
                ))}
              </div>
            </div>

            {/* Content */}
            <div
              className="p-4 md:p-6 space-y-4 md:space-y-6 flex-1 overflow-y-auto overflow-x-hidden min-w-0 overscroll-contain"
              style={{ paddingBottom: "calc(96px + env(safe-area-inset-bottom, 0px))" }}
            >
              {/* Overview Tab */}
              {activeTab === "overview" && (
                <div className="space-y-4">
                  {/* Deal Readiness - Show for Draft deals */}
                  {deal.status === "DRAFT" && (() => {
                    const checks = getReadinessChecks();
                    const passedCount = checks.filter(c => c.passed).length;
                    const allPassed = passedCount === checks.length;
                    return (
                      <div className={`rounded-2xl border shadow-sm overflow-hidden ${
                        allPassed ? "bg-emerald-50 border-emerald-200" : "bg-amber-50 border-amber-200"
                      }`}>
                        <div className="px-4 py-3 border-b border-inherit">
                          <div className="flex items-center justify-between">
                            <h3 className="text-sm font-bold text-slate-800">Deal Readiness</h3>
                            <span className={`text-xs font-medium px-2 py-0.5 rounded-full ${
                              allPassed ? "bg-emerald-100 text-emerald-700" : "bg-amber-100 text-amber-700"
                            }`}>
                              {passedCount}/{checks.length} complete
                            </span>
                          </div>
                        </div>
                        <div className="p-4 grid grid-cols-2 gap-2">
                          {checks.map((check) => (
                            <div
                              key={check.id}
                              className={`flex items-center gap-2 text-sm ${
                                check.passed ? "text-emerald-700" : "text-amber-700"
                              }`}
                            >
                              {check.passed ? (
                                <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                              ) : (
                                <svg className="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                              )}
                              <span className={check.passed ? "" : "font-medium"}>
                                {check.tab && !check.passed ? (
                                  <button
                                    onClick={() => setActiveTab(check.tab)}
                                    className="underline hover:no-underline"
                                  >
                                    {check.label}
                                  </button>
                                ) : (
                                  check.label
                                )}
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })()}

                  {/* Sale Classification Section */}
                  {deal.status === "DRAFT" && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <h3 className="text-sm font-bold text-slate-800">Sale Classification</h3>
                      </div>
                      <div className="p-4 space-y-4">
                        {/* Step 1: Sale Type */}
                        <div>
                          <label className="block text-xs font-medium text-slate-500 mb-1.5">Sale Type</label>
                          <div className="flex flex-wrap gap-2">
                            {SALE_TYPE_OPTIONS.map((opt) => (
                              <button
                                key={opt.value}
                                onClick={() => handleUpdateField({
                                  saleType: opt.value,
                                  // Reset dependent fields when sale type changes
                                  ...(opt.value !== "RETAIL" ? { buyerUse: null, saleChannel: null } : {})
                                })}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                  deal.saleType === opt.value
                                    ? "bg-[#0066CC] text-white"
                                    : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                                }`}
                                title={opt.description}
                              >
                                {opt.label}
                              </button>
                            ))}
                          </div>
                        </div>

                        {/* Step 2: Buyer Use - Only for Retail */}
                        {deal.saleType === "RETAIL" && (
                          <div>
                            <label className="block text-xs font-medium text-slate-500 mb-1.5">Buyer Use</label>
                            <div className="flex flex-wrap gap-2">
                              {BUYER_USE_OPTIONS.map((opt) => (
                                <button
                                  key={opt.value}
                                  onClick={() => handleUpdateField({ buyerUse: opt.value })}
                                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                    deal.buyerUse === opt.value
                                      ? "bg-[#0066CC] text-white"
                                      : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                                  }`}
                                  title={opt.description}
                                >
                                  {opt.label}
                                </button>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* Step 3: Sale Channel - Only for Retail */}
                        {deal.saleType === "RETAIL" && (
                          <div>
                            <label className="block text-xs font-medium text-slate-500 mb-1.5">Sale Channel</label>
                            <div className="flex flex-wrap gap-2">
                              {SALE_CHANNEL_OPTIONS.map((opt) => (
                                <button
                                  key={opt.value}
                                  onClick={() => handleUpdateField({ saleChannel: opt.value })}
                                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                    deal.saleChannel === opt.value
                                      ? "bg-[#0066CC] text-white"
                                      : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                                  }`}
                                  title={opt.description}
                                >
                                  {opt.label}
                                </button>
                              ))}
                            </div>
                            {deal.saleChannel === "DISTANCE" && (
                              <p className="text-xs text-amber-600 mt-2 flex items-center gap-1">
                                <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                14-day cooling off period applies
                              </p>
                            )}
                          </div>
                        )}

                        {/* Step 4: Business Details - For Trade or Business buyers */}
                        {(deal.saleType === "TRADE" || deal.buyerUse === "BUSINESS") && (
                          <div className="border-t border-slate-100 pt-4 space-y-3">
                            <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide">Business Details</h4>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Company Name</label>
                                <input
                                  type="text"
                                  className="input input-sm input-bordered w-full"
                                  placeholder="Company name"
                                  value={deal.businessDetails?.companyName || ""}
                                  onChange={(e) => handleUpdateField({
                                    businessDetails: { ...deal.businessDetails, companyName: e.target.value }
                                  })}
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Company Reg Number</label>
                                <input
                                  type="text"
                                  className="input input-sm input-bordered w-full"
                                  placeholder="e.g., 12345678"
                                  value={deal.businessDetails?.companyRegNumber || ""}
                                  onChange={(e) => handleUpdateField({
                                    businessDetails: { ...deal.businessDetails, companyRegNumber: e.target.value }
                                  })}
                                />
                              </div>
                              <div className="md:col-span-2">
                                <label className="block text-xs text-slate-500 mb-1">VAT Number</label>
                                <input
                                  type="text"
                                  className="input input-sm input-bordered w-full"
                                  placeholder="e.g., GB 123 4567 89"
                                  value={deal.businessDetails?.vatNumber || ""}
                                  onChange={(e) => handleUpdateField({
                                    businessDetails: { ...deal.businessDetails, vatNumber: e.target.value }
                                  })}
                                />
                              </div>
                            </div>
                          </div>
                        )}

                        {/* VAT Treatment */}
                        <div className="border-t border-slate-100 pt-4">
                          <label className="block text-xs font-medium text-slate-500 mb-1.5">VAT Treatment</label>
                          <div className="flex flex-wrap gap-2">
                            {[
                              { value: "MARGIN", label: "Margin Scheme" },
                              { value: "VAT_QUALIFYING", label: "Standard VAT" },
                              { value: "NO_VAT", label: "Zero-rated / No VAT" },
                            ].map((opt) => (
                              <button
                                key={opt.value}
                                onClick={() => handleUpdateField({ vatScheme: opt.value })}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                  deal.vatScheme === opt.value
                                    ? "bg-[#0066CC] text-white"
                                    : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                                }`}
                              >
                                {opt.label}
                              </button>
                            ))}
                          </div>
                        </div>

                      </div>
                    </div>
                  )}

                  {/* Vehicle Section */}
                  {deal.vehicle && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h8m-8 5h8m-4-9a9 9 0 110 18 9 9 0 010-18z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Vehicle</h3>
                        </div>
                      </div>
                      <div className="p-4">
                        <div className="flex items-start gap-4">
                          {deal.vehicle.primaryImageUrl && (
                            <img
                              src={deal.vehicle.primaryImageUrl}
                              alt={`${deal.vehicle.make} ${deal.vehicle.model}`}
                              className="w-20 h-20 object-cover rounded-xl"
                            />
                          )}
                          <div className="flex-1">
                            <p className="font-semibold text-slate-900">
                              {deal.vehicle.year} {deal.vehicle.make} {deal.vehicle.model}
                            </p>
                            <p className="text-sm text-slate-500 mt-1">
                              {deal.vehicle.regCurrent}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Pricing Summary */}
                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Pricing</h3>
                        </div>
                        <span className={`inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium ${
                          deal.vatScheme === "VAT_QUALIFYING"
                            ? "bg-blue-100 text-blue-700"
                            : "bg-slate-100 text-slate-600"
                        }`}>
                          {VAT_SCHEME_LABELS[deal.vatScheme] || deal.vatScheme}
                        </span>
                      </div>
                    </div>
                    <div className="p-4 space-y-3">
                      {/* Vehicle Price - Editable for Draft */}
                      <div className="flex justify-between items-center">
                        <span className="text-sm text-slate-600">Vehicle</span>
                        {deal.status === "DRAFT" && isEditingPrice ? (
                          <div className="flex items-center gap-2">
                            <div className="relative w-28">
                              <span className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400 text-sm">£</span>
                              <input
                                type="number"
                                step="0.01"
                                className="input input-sm input-bordered w-full pl-6 pr-2 text-right"
                                value={priceInput}
                                onChange={(e) => setPriceInput(e.target.value)}
                                onKeyDown={(e) => {
                                  if (e.key === "Enter") handleUpdatePrice();
                                  if (e.key === "Escape") setIsEditingPrice(false);
                                }}
                                autoFocus
                              />
                            </div>
                            <button
                              onClick={handleUpdatePrice}
                              disabled={actionLoading === "field"}
                              className="btn btn-xs btn-ghost text-emerald-600"
                            >
                              ✓
                            </button>
                            <button
                              onClick={() => setIsEditingPrice(false)}
                              className="btn btn-xs btn-ghost text-slate-400"
                            >
                              ✕
                            </button>
                          </div>
                        ) : (
                          <div className="flex items-center gap-2">
                            <span className="font-semibold text-slate-900">
                              {deal.vehiclePriceGross > 0
                                ? formatCurrency(deal.vehiclePriceGross)
                                : "—"}
                            </span>
                            {deal.status === "DRAFT" && (
                              <button
                                onClick={() => {
                                  setPriceInput(deal.vehiclePriceGross?.toString() || "");
                                  setIsEditingPrice(true);
                                }}
                                className="btn btn-xs btn-ghost text-[#0066CC]"
                              >
                                Edit
                              </button>
                            )}
                          </div>
                        )}
                      </div>

                      {/* Show net + VAT breakdown for VAT Qualifying */}
                      {deal.vatScheme === "VAT_QUALIFYING" && deal.vehiclePriceGross > 0 && (
                        <div className="text-xs text-slate-500 text-right">
                          Net: {formatCurrency(deal.vehiclePriceNet)} + VAT: {formatCurrency(deal.vehicleVatAmount)}
                        </div>
                      )}

                      {/* Add-ons */}
                      {totals.addOnsNetTotal > 0 && (
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-slate-600">Add-ons</span>
                          <span className="font-semibold text-slate-900">
                            {formatCurrency(totals.addOnsNetTotal)}
                          </span>
                        </div>
                      )}

                      {/* VAT (only for VAT Qualifying) */}
                      {deal.vatScheme === "VAT_QUALIFYING" && totals.totalVat > 0 && (
                        <div className="flex justify-between items-center">
                          <span className="text-sm text-slate-600">VAT @ 20%</span>
                          <span className="font-semibold text-slate-900">
                            {formatCurrency(totals.totalVat)}
                          </span>
                        </div>
                      )}

                      <div className="border-t border-slate-100 pt-3">
                        <div className="flex justify-between items-center">
                          <span className="text-sm font-semibold text-slate-700">Total</span>
                          <span className="text-lg font-bold text-slate-900">
                            {formatCurrency(totals.grandTotal)}
                          </span>
                        </div>
                      </div>

                      {/* Part Exchange */}
                      {totals.pxNetValue > 0 && (
                        <div className="flex justify-between items-center text-emerald-600">
                          <span className="text-sm">Part Exchange</span>
                          <span className="font-semibold">-{formatCurrency(totals.pxNetValue)}</span>
                        </div>
                      )}

                      {/* Payments */}
                      {totals.totalPaid > 0 && (
                        <div className="flex justify-between items-center text-emerald-600">
                          <span className="text-sm">Paid</span>
                          <span className="font-semibold">-{formatCurrency(totals.totalPaid)}</span>
                        </div>
                      )}

                      {/* Balance Due */}
                      <div className="border-t border-slate-100 pt-3">
                        <div className="flex justify-between items-center">
                          <span className="text-sm font-semibold text-slate-700">Balance Due</span>
                          <span className={`text-lg font-bold ${
                            totals.balanceDue <= 0 ? "text-emerald-600" : "text-slate-900"
                          }`}>
                            {formatCurrency(Math.max(0, totals.balanceDue))}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Part Exchange Section */}
                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-emerald-50 to-white border-b border-slate-100">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Part Exchange</h3>
                        </div>
                        {!deal.partExchange && deal.status === "DRAFT" && (
                          <button
                            onClick={() => setShowPxModal(true)}
                            className="btn btn-ghost btn-xs text-emerald-600"
                          >
                            + Add PX
                          </button>
                        )}
                      </div>
                    </div>
                    {deal.partExchange ? (
                      <div className="p-4 space-y-3">
                        <div>
                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Vehicle</span>
                          <p className="font-semibold text-slate-900 mt-0.5">
                            {deal.partExchange.vrm} - {deal.partExchange.make} {deal.partExchange.model}
                          </p>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Allowance</span>
                            <p className="font-semibold text-slate-900 mt-0.5">
                              {formatCurrency(deal.partExchange.allowance)}
                            </p>
                          </div>
                          {deal.partExchange.settlement > 0 && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Settlement</span>
                              <p className="font-semibold text-red-600 mt-0.5">
                                -{formatCurrency(deal.partExchange.settlement)}
                              </p>
                            </div>
                          )}
                        </div>
                        <div className="pt-2 border-t border-slate-100">
                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Net Value</span>
                          <p className="font-bold text-emerald-600 mt-0.5">
                            {formatCurrency(totals.pxNetValue)}
                          </p>
                        </div>
                      </div>
                    ) : (
                      <div className="p-4">
                        <p className="text-sm text-slate-400 text-center py-4">No part exchange on this deal</p>
                        {deal.status === "DRAFT" && (
                          <button
                            onClick={() => setShowPxModal(true)}
                            className="btn btn-outline btn-sm w-full text-emerald-600 border-emerald-200 hover:bg-emerald-50"
                          >
                            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Add Part Exchange
                          </button>
                        )}
                      </div>
                    )}
                  </div>

                  {/* Agreed Work Items Section */}
                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-orange-50 to-white border-b border-slate-100">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-orange-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Agreed Work</h3>
                          {deal.requests?.length > 0 && (
                            <span className="bg-orange-100 text-orange-700 text-xs px-2 py-0.5 rounded-full font-medium">
                              {deal.requests.filter(r => r.status !== "DONE" && r.status !== "CANCELLED").length} pending
                            </span>
                          )}
                        </div>
                        {deal.status === "DRAFT" && (
                          <button
                            onClick={() => setShowAgreedWorkModal(true)}
                            className="btn btn-ghost btn-xs text-orange-600"
                          >
                            + Add
                          </button>
                        )}
                      </div>
                    </div>
                    <div className="p-4">
                      {deal.requests?.length > 0 ? (
                        <div className="space-y-3">
                          {deal.requests.map((req, idx) => (
                            <div
                              key={idx}
                              className={`flex items-start justify-between gap-3 p-3 rounded-xl ${
                                req.status === "DONE"
                                  ? "bg-emerald-50 border border-emerald-200"
                                  : req.status === "CANCELLED"
                                    ? "bg-slate-50 border border-slate-200 opacity-60"
                                    : "bg-orange-50 border border-orange-200"
                              }`}
                            >
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2">
                                  <span className={`text-xs px-1.5 py-0.5 rounded font-medium ${
                                    req.type === "PREP" ? "bg-blue-100 text-blue-700" :
                                    req.type === "COSMETIC" ? "bg-purple-100 text-purple-700" :
                                    req.type === "ACCESSORY" ? "bg-cyan-100 text-cyan-700" :
                                    "bg-slate-100 text-slate-600"
                                  }`}>
                                    {req.type}
                                  </span>
                                  {req.linkToIssueId && (
                                    <span className="text-xs text-slate-400">Synced to vehicle</span>
                                  )}
                                </div>
                                <p className={`font-medium mt-1 ${req.status === "DONE" ? "line-through text-slate-500" : "text-slate-900"}`}>
                                  {req.title}
                                </p>
                                {req.details && (
                                  <p className="text-sm text-slate-500 mt-0.5">{req.details}</p>
                                )}
                              </div>
                              <div className="flex items-center gap-2">
                                {req.status !== "DONE" && req.status !== "CANCELLED" && (
                                  <button
                                    onClick={() => handleUpdateAgreedWorkStatus(idx, "DONE")}
                                    disabled={actionLoading === "agreedWork"}
                                    className="flex items-center justify-center w-7 h-7 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white transition-all"
                                    title="Mark as done"
                                  >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                  </button>
                                )}
                                {deal.status === "DRAFT" && (
                                  <button
                                    onClick={() => handleRemoveAgreedWork(idx)}
                                    disabled={actionLoading === "agreedWork"}
                                    className="flex items-center justify-center w-7 h-7 rounded-lg bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 transition-all"
                                    title="Remove"
                                  >
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                  </button>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="text-center py-4">
                          <p className="text-sm text-slate-400">No agreed work items</p>
                          <p className="text-xs text-slate-400 mt-1">
                            Add items that have been promised to the customer
                          </p>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Next Actions */}
                  {deal.status !== "COMPLETED" && deal.status !== "CANCELLED" && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-blue-50 to-white border-b border-slate-100">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Next Actions</h3>
                        </div>
                      </div>
                      <div className="p-4 space-y-4">
                        {/* Take Deposit - for Draft or Deposit_Taken status */}
                        {(deal.status === "DRAFT" || deal.status === "DEPOSIT_TAKEN") && (() => {
                          const { allowed, reasons } = canTakeDeposit();
                          return (
                            <div className="space-y-2">
                              <div className="flex items-center justify-between">
                                <span className="text-sm font-medium text-slate-700">Take Deposit</span>
                                {deal.status === "DEPOSIT_TAKEN" && (
                                  <span className="text-xs text-emerald-600 font-medium">Additional deposit</span>
                                )}
                              </div>
                              {deal.status === "DRAFT" && !allowed && reasons.length > 0 && (
                                <div className="bg-amber-50 border border-amber-200 rounded-xl p-3">
                                  <p className="text-xs font-medium text-amber-800 mb-1.5">Required:</p>
                                  <ul className="space-y-1">
                                    {reasons.map((r, i) => (
                                      <li key={i} className="text-xs text-amber-700 flex items-center gap-1.5">
                                        <svg className="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        {r}
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              <button
                                onClick={() => (allowed || deal.status === "DEPOSIT_TAKEN") && setShowDepositModal(true)}
                                disabled={actionLoading || (deal.status === "DRAFT" && !allowed)}
                                className={`btn btn-sm w-full border-none ${
                                  allowed || deal.status === "DEPOSIT_TAKEN"
                                    ? "bg-amber-500 hover:bg-amber-600 text-white"
                                    : "bg-slate-200 text-slate-400 cursor-not-allowed"
                                }`}
                              >
                                {actionLoading === "deposit" ? (
                                  <span className="loading loading-spinner loading-xs"></span>
                                ) : (
                                  <>
                                    <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1" />
                                    </svg>
                                    {deal.status === "DEPOSIT_TAKEN" ? "Take Additional Deposit" : "Take Deposit"}
                                  </>
                                )}
                              </button>
                            </div>
                          );
                        })()}

                        {/* Generate Invoice */}
                        {(deal.status === "DRAFT" || deal.status === "DEPOSIT_TAKEN") && (() => {
                          const { allowed, reasons } = canGenerateInvoice();
                          return (
                            <div className="space-y-2 pt-2 border-t border-slate-100">
                              <div className="flex items-center justify-between">
                                <span className="text-sm font-medium text-slate-700">Generate Invoice</span>
                                {deal.status === "DRAFT" && (
                                  <span className="text-xs text-slate-400">Invoice-first supported</span>
                                )}
                              </div>
                              {!allowed && reasons.length > 0 && !reasons.includes("Invoice already generated") && (
                                <div className="bg-blue-50 border border-blue-200 rounded-xl p-3">
                                  <p className="text-xs font-medium text-blue-800 mb-1.5">Required:</p>
                                  <ul className="space-y-1">
                                    {reasons.map((r, i) => (
                                      <li key={i} className="text-xs text-blue-700 flex items-center gap-1.5">
                                        <svg className="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        {r}
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              <button
                                onClick={() => allowed && handleGenerateInvoice()}
                                disabled={actionLoading || !allowed}
                                className={`btn btn-sm w-full border-none ${
                                  allowed
                                    ? "bg-blue-500 hover:bg-blue-600 text-white"
                                    : "bg-slate-200 text-slate-400 cursor-not-allowed"
                                }`}
                              >
                                {actionLoading === "invoice" ? (
                                  <span className="loading loading-spinner loading-xs"></span>
                                ) : (
                                  <>
                                    <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    Generate Invoice
                                  </>
                                )}
                              </button>
                            </div>
                          );
                        })()}

                        {/* Mark Delivered */}
                        {deal.status === "INVOICED" && (
                          <button
                            onClick={handleMarkDelivered}
                            disabled={actionLoading}
                            className="btn btn-sm w-full bg-purple-500 hover:bg-purple-600 text-white border-none"
                          >
                            {actionLoading === "delivered" ? (
                              <span className="loading loading-spinner loading-xs"></span>
                            ) : (
                              <>
                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                </svg>
                                Mark Delivered
                              </>
                            )}
                          </button>
                        )}

                        {/* Complete Deal */}
                        {deal.status === "DELIVERED" && (
                          <button
                            onClick={handleMarkCompleted}
                            disabled={actionLoading}
                            className="btn btn-sm w-full bg-emerald-500 hover:bg-emerald-600 text-white border-none"
                          >
                            {actionLoading === "completed" ? (
                              <span className="loading loading-spinner loading-xs"></span>
                            ) : (
                              <>
                                <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                Complete Deal
                              </>
                            )}
                          </button>
                        )}

                        {/* Delete/Cancel actions */}
                        <div className="pt-2 border-t border-slate-100">
                          {deal.status === "DRAFT" ? (
                            <button
                              onClick={() => setShowDeleteConfirm(true)}
                              disabled={actionLoading}
                              className="btn btn-sm btn-ghost w-full text-red-500 hover:bg-red-50"
                            >
                              Delete Draft
                            </button>
                          ) : (
                            <button
                              onClick={handleCancelDeal}
                              disabled={actionLoading}
                              className="btn btn-sm btn-ghost w-full text-red-500 hover:bg-red-50"
                            >
                              Cancel Deal
                            </button>
                          )}
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Settlement Plan */}
                  {deal.status === "DRAFT" && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Settlement Plan</h3>
                        </div>
                      </div>
                      <div className="p-4 space-y-4">
                        <div>
                          <label className="block text-xs font-medium text-slate-500 mb-1.5">How will this be paid?</label>
                          <div className="flex flex-wrap gap-2">
                            {PAYMENT_TYPE_OPTIONS.map((opt) => (
                              <button
                                key={opt.value}
                                onClick={() => handleUpdateField({ paymentType: opt.value })}
                                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                                  deal.paymentType === opt.value
                                    ? "bg-[#0066CC] text-white"
                                    : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                                }`}
                              >
                                {opt.label}
                              </button>
                            ))}
                          </div>
                        </div>

                        {/* Finance Details - shown when paymentType is FINANCE or MIXED */}
                        {(deal.paymentType === "FINANCE" || deal.paymentType === "MIXED") && (
                          <div className="border-t border-slate-100 pt-4 space-y-3">
                            <h4 className="text-xs font-semibold text-slate-500 uppercase tracking-wide">Finance Details</h4>
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Provider</label>
                                <input
                                  type="text"
                                  className="input input-sm input-bordered w-full"
                                  placeholder="Finance company"
                                  value={deal.finance?.provider || ""}
                                  onChange={(e) => handleUpdateField({
                                    finance: { ...deal.finance, provider: e.target.value }
                                  })}
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Finance Type</label>
                                <select
                                  className="select select-sm select-bordered w-full"
                                  value={deal.finance?.financeType || ""}
                                  onChange={(e) => handleUpdateField({
                                    finance: { ...deal.finance, financeType: e.target.value }
                                  })}
                                >
                                  <option value="">Select...</option>
                                  {FINANCE_TYPE_OPTIONS.map((opt) => (
                                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                                  ))}
                                </select>
                              </div>
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Amount Financed</label>
                                <div className="relative">
                                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">£</span>
                                  <input
                                    type="number"
                                    className="input input-sm input-bordered w-full pl-7"
                                    placeholder="0.00"
                                    value={deal.finance?.amountFinanced || ""}
                                    onChange={(e) => handleUpdateField({
                                      finance: { ...deal.finance, amountFinanced: parseFloat(e.target.value) || null }
                                    })}
                                  />
                                </div>
                              </div>
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Customer Deposit</label>
                                <div className="relative">
                                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">£</span>
                                  <input
                                    type="number"
                                    className="input input-sm input-bordered w-full pl-7"
                                    placeholder="0.00"
                                    value={deal.finance?.customerDeposit || ""}
                                    onChange={(e) => handleUpdateField({
                                      finance: { ...deal.finance, customerDeposit: parseFloat(e.target.value) || null }
                                    })}
                                  />
                                </div>
                              </div>
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Status</label>
                                <select
                                  className="select select-sm select-bordered w-full"
                                  value={deal.finance?.status || "QUOTED"}
                                  onChange={(e) => handleUpdateField({
                                    finance: { ...deal.finance, status: e.target.value }
                                  })}
                                >
                                  {FINANCE_STATUS_OPTIONS.map((opt) => (
                                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                                  ))}
                                </select>
                              </div>
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Reference</label>
                                <input
                                  type="text"
                                  className="input input-sm input-bordered w-full"
                                  placeholder="Agreement ref"
                                  value={deal.finance?.reference || ""}
                                  onChange={(e) => handleUpdateField({
                                    finance: { ...deal.finance, reference: e.target.value }
                                  })}
                                />
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Timeline */}
                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                      <div className="flex items-center gap-2">
                        <div className="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center">
                          <svg className="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </div>
                        <h3 className="text-sm font-bold text-slate-800">Timeline</h3>
                      </div>
                    </div>
                    <div className="p-4 space-y-3 text-sm">
                      <div className="flex justify-between">
                        <span className="text-slate-500">Created</span>
                        <span className="text-slate-900">{formatDateTime(deal.createdAt)}</span>
                      </div>
                      {deal.depositTakenAt && (
                        <div className="flex justify-between">
                          <span className="text-slate-500">Deposit Taken</span>
                          <span className="text-slate-900">{formatDateTime(deal.depositTakenAt)}</span>
                        </div>
                      )}
                      {deal.invoicedAt && (
                        <div className="flex justify-between">
                          <span className="text-slate-500">Invoiced</span>
                          <span className="text-slate-900">{formatDateTime(deal.invoicedAt)}</span>
                        </div>
                      )}
                      {deal.deliveredAt && (
                        <div className="flex justify-between">
                          <span className="text-slate-500">Delivered</span>
                          <span className="text-slate-900">{formatDateTime(deal.deliveredAt)}</span>
                        </div>
                      )}
                      {deal.completedAt && (
                        <div className="flex justify-between">
                          <span className="text-slate-500">Completed</span>
                          <span className="text-slate-900">{formatDateTime(deal.completedAt)}</span>
                        </div>
                      )}
                      {deal.cancelledAt && (
                        <div className="flex justify-between text-red-600">
                          <span>Cancelled</span>
                          <span>{formatDateTime(deal.cancelledAt)}</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Notes */}
                  {(deal.notes || deal.internalNotes) && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <h3 className="text-sm font-bold text-slate-800">Notes</h3>
                      </div>
                      <div className="p-4 space-y-3">
                        {deal.notes && (
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Customer Notes</span>
                            <p className="text-sm text-slate-700 mt-1">{deal.notes}</p>
                          </div>
                        )}
                        {deal.internalNotes && (
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Internal Notes</span>
                            <p className="text-sm text-slate-700 mt-1">{deal.internalNotes}</p>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Customer Tab */}
              {activeTab === "customer" && (
                <div className="space-y-4">
                  {/* Sold To Section */}
                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-[#0066CC]/10 flex items-center justify-center">
                            <svg className="w-4 h-4 text-[#0066CC]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Sold To</h3>
                        </div>
                        {deal.customer && deal.status === "DRAFT" && !isEditingCustomer && (
                          <button
                            onClick={() => setIsEditingCustomer(true)}
                            className="btn btn-ghost btn-xs text-[#0066CC]"
                          >
                            Change
                          </button>
                        )}
                      </div>
                    </div>
                    <div className="p-4">
                      {isEditingCustomer || !deal.customer ? (
                        <div className="space-y-3">
                          <ContactPicker
                            value={deal.soldToContactId}
                            onChange={(contactId) => handleUpdateCustomer(contactId)}
                            filterTypeTags={["customer"]}
                            placeholder="Search or create a customer..."
                          />
                          {isEditingCustomer && (
                            <button
                              onClick={() => setIsEditingCustomer(false)}
                              className="btn btn-ghost btn-sm w-full"
                            >
                              Cancel
                            </button>
                          )}
                        </div>
                      ) : (
                        <div className="space-y-3">
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Name</span>
                            <p className="font-semibold text-slate-900 mt-0.5">{deal.customer.displayName}</p>
                          </div>
                          {deal.customer.companyName && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Company</span>
                              <p className="text-slate-700 mt-0.5">{deal.customer.companyName}</p>
                            </div>
                          )}
                          {deal.customer.email && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Email</span>
                              <p className="text-slate-700 mt-0.5">{deal.customer.email}</p>
                            </div>
                          )}
                          {deal.customer.phone && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Phone</span>
                              <p className="text-slate-700 mt-0.5">{deal.customer.phone}</p>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Invoice To Section */}
                  <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                    <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-amber-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Invoice To</h3>
                        </div>
                        <span className="text-xs text-slate-400">Who receives the invoice?</span>
                      </div>
                    </div>
                    <div className="p-4 space-y-4">
                      {/* Invoice recipient toggle */}
                      {deal.status === "DRAFT" && (
                        <div className="flex flex-wrap gap-2">
                          <button
                            onClick={() => {
                              setInvoiceToOption("CUSTOMER");
                              if (deal.invoiceToContactId) {
                                handleUpdateInvoiceTo(null);
                              }
                            }}
                            className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                              invoiceToOption === "CUSTOMER"
                                ? "bg-[#0066CC] text-white"
                                : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                            }`}
                          >
                            Customer
                          </button>
                          <button
                            onClick={() => {
                              setInvoiceToOption("OTHER");
                              setIsEditingInvoiceTo(true);
                            }}
                            className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                              invoiceToOption === "OTHER"
                                ? "bg-[#0066CC] text-white"
                                : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                            }`}
                          >
                            Finance / Broker
                          </button>
                        </div>
                      )}

                      {/* Show current invoice recipient */}
                      {invoiceToOption === "CUSTOMER" ? (
                        <div className="bg-slate-50 rounded-xl p-3">
                          <p className="text-sm text-slate-600">
                            Invoice will be addressed to: <span className="font-medium text-slate-900">{deal.customer?.displayName || "Customer"}</span>
                          </p>
                        </div>
                      ) : deal.invoiceTo && !isEditingInvoiceTo ? (
                        <div className="space-y-3">
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Name</span>
                            <p className="font-semibold text-slate-900 mt-0.5">{deal.invoiceTo.displayName}</p>
                          </div>
                          {deal.invoiceTo.companyName && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Company</span>
                              <p className="text-slate-700 mt-0.5">{deal.invoiceTo.companyName}</p>
                            </div>
                          )}
                          {deal.status === "DRAFT" && (
                            <button
                              onClick={() => setIsEditingInvoiceTo(true)}
                              className="btn btn-ghost btn-sm text-[#0066CC]"
                            >
                              Change
                            </button>
                          )}
                        </div>
                      ) : invoiceToOption === "OTHER" && (isEditingInvoiceTo || !deal.invoiceTo) ? (
                        <div className="space-y-3">
                          <ContactPicker
                            value={deal.invoiceToContactId}
                            onChange={(contactId) => handleUpdateInvoiceTo(contactId)}
                            filterTypeTags={["finance_company", "supplier"]}
                            placeholder="Search finance company or broker..."
                            allowCreate={true}
                          />
                          {isEditingInvoiceTo && (
                            <button
                              onClick={() => setIsEditingInvoiceTo(false)}
                              className="btn btn-ghost btn-sm w-full"
                            >
                              Cancel
                            </button>
                          )}
                        </div>
                      ) : null}
                    </div>
                  </div>

                  {/* Part Exchange */}
                  {deal.partExchange && (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <div className="flex items-center gap-2">
                          <div className="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                            <svg className="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                          </div>
                          <h3 className="text-sm font-bold text-slate-800">Part Exchange</h3>
                        </div>
                      </div>
                      <div className="p-4 space-y-3">
                        <div>
                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Vehicle</span>
                          <p className="font-semibold text-slate-900 mt-0.5">
                            {deal.partExchange.vrm} - {deal.partExchange.make} {deal.partExchange.model}
                          </p>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Allowance</span>
                            <p className="font-semibold text-slate-900 mt-0.5">
                              {formatCurrency(deal.partExchange.allowance)}
                            </p>
                          </div>
                          {deal.partExchange.settlement > 0 && (
                            <div>
                              <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Settlement</span>
                              <p className="font-semibold text-red-600 mt-0.5">
                                -{formatCurrency(deal.partExchange.settlement)}
                              </p>
                            </div>
                          )}
                        </div>
                        <div className="pt-2 border-t border-slate-100">
                          <span className="text-xs font-medium text-slate-400 uppercase tracking-wide">Net Value</span>
                          <p className="font-bold text-emerald-600 mt-0.5">
                            {formatCurrency(totals.pxNetValue)}
                          </p>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Add-ons Tab */}
              {activeTab === "addons" && (
                <div className="space-y-4">
                  {deal.addOns?.length > 0 ? (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100 flex items-center justify-between">
                        <h3 className="text-sm font-bold text-slate-800">Add-ons</h3>
                        {deal.status === "DRAFT" && (
                          <button
                            onClick={() => {
                              setShowAddOnPicker(true);
                              fetchAddOnProducts();
                            }}
                            className="btn btn-ghost btn-xs text-[#0066CC]"
                          >
                            + Add
                          </button>
                        )}
                      </div>
                      <div className="divide-y divide-slate-100">
                        {deal.addOns.map((addon, idx) => (
                          <div key={idx} className="p-4 flex items-center justify-between gap-3">
                            <div className="flex-1 min-w-0">
                              <p className="font-medium text-slate-900">{addon.name}</p>
                              <p className="text-sm text-slate-500">
                                {addon.qty > 1 && `${addon.qty} x `}
                                {formatCurrency(addon.unitPriceNet)}
                                {addon.vatTreatment === "STANDARD" && " + VAT"}
                              </p>
                            </div>
                            <span className="font-semibold text-slate-900">
                              {formatCurrency(addon.unitPriceNet * (addon.qty || 1))}
                            </span>
                            {deal.status === "DRAFT" && (
                              <button
                                onClick={() => handleRemoveAddOn(idx)}
                                disabled={actionLoading === "addon"}
                                className="flex items-center justify-center w-8 h-8 rounded-lg bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 transition-all"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                              </button>
                            )}
                          </div>
                        ))}
                      </div>
                      <div className="px-4 py-3 bg-slate-50 border-t border-slate-100 flex justify-between">
                        <span className="font-medium text-slate-700">Total</span>
                        <span className="font-bold text-slate-900">
                          {formatCurrency(totals.addOnsNetTotal + totals.addOnsVatTotal)}
                        </span>
                      </div>
                    </div>
                  ) : (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center">
                      <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                      </div>
                      <p className="text-sm font-medium text-slate-600">No add-ons</p>
                      <p className="text-xs text-slate-400 mt-1">Add products like warranties or accessories</p>
                      {deal.status === "DRAFT" && (
                        <button
                          onClick={() => {
                            setShowAddOnPicker(true);
                            fetchAddOnProducts();
                          }}
                          className="btn btn-sm bg-[#0066CC] hover:bg-[#0052a3] text-white border-none mt-4"
                        >
                          Add Add-on
                        </button>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* Payments Tab */}
              {activeTab === "payments" && (
                <div className="space-y-4">
                  {deal.payments?.length > 0 ? (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                      <div className="px-4 py-3 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100">
                        <h3 className="text-sm font-bold text-slate-800">Payments</h3>
                      </div>
                      <div className="divide-y divide-slate-100">
                        {deal.payments.map((payment, idx) => (
                          <div key={idx} className="p-4">
                            <div className="flex items-center justify-between">
                              <div>
                                <div className="flex items-center gap-2">
                                  <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold ${
                                    payment.type === "DEPOSIT"
                                      ? "bg-amber-100 text-amber-700"
                                      : payment.type === "BALANCE"
                                      ? "bg-emerald-100 text-emerald-700"
                                      : "bg-slate-100 text-slate-600"
                                  }`}>
                                    {payment.type}
                                  </span>
                                  <span className="text-sm text-slate-500">{payment.method}</span>
                                </div>
                                <p className="text-xs text-slate-400 mt-1">
                                  {formatDateTime(payment.paidAt)}
                                  {payment.reference && ` • ${payment.reference}`}
                                </p>
                              </div>
                              <span className={`font-semibold ${
                                payment.isRefunded ? "text-red-500 line-through" : "text-emerald-600"
                              }`}>
                                {formatCurrency(payment.amount)}
                              </span>
                            </div>
                          </div>
                        ))}
                      </div>
                      <div className="px-4 py-3 bg-slate-50 border-t border-slate-100 flex justify-between">
                        <span className="font-medium text-slate-700">Total Paid</span>
                        <span className="font-bold text-emerald-600">
                          {formatCurrency(totals.totalPaid)}
                        </span>
                      </div>
                    </div>
                  ) : (
                    <div className="bg-white rounded-2xl border border-slate-100 shadow-sm p-8 text-center">
                      <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                      </div>
                      <p className="text-sm font-medium text-slate-600">No payments recorded</p>
                      <p className="text-xs text-slate-400 mt-1">Take a deposit to get started</p>
                    </div>
                  )}
                </div>
              )}
            </div>
          </>
        )}
      </div>

      {/* Deposit Modal */}
      {showDepositModal && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowDepositModal(false)} />
          <div className="relative bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 className="text-lg font-bold text-slate-900 mb-4">Take Deposit</h3>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                  Amount
                </label>
                <div className="relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">£</span>
                  <input
                    type="number"
                    value={depositAmount}
                    onChange={(e) => setDepositAmount(e.target.value)}
                    className="input input-bordered w-full pl-7"
                    placeholder="0.00"
                    step="0.01"
                    min="0"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                  Payment Method
                </label>
                <select
                  value={depositMethod}
                  onChange={(e) => setDepositMethod(e.target.value)}
                  className="select select-bordered w-full"
                >
                  <option value="CARD">Card</option>
                  <option value="CASH">Cash</option>
                  <option value="BANK_TRANSFER">Bank Transfer</option>
                  <option value="FINANCE">Finance</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                  Reference (optional)
                </label>
                <input
                  type="text"
                  value={depositReference}
                  onChange={(e) => setDepositReference(e.target.value)}
                  className="input input-bordered w-full"
                  placeholder="e.g., Transaction ID"
                />
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button
                onClick={() => setShowDepositModal(false)}
                className="btn btn-ghost flex-1"
              >
                Cancel
              </button>
              <button
                onClick={handleTakeDeposit}
                disabled={actionLoading === "deposit"}
                className="btn bg-amber-500 hover:bg-amber-600 text-white border-none flex-1"
              >
                {actionLoading === "deposit" ? (
                  <span className="loading loading-spinner loading-sm"></span>
                ) : (
                  "Record Deposit"
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add-on Picker Modal */}
      {showAddOnPicker && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowAddOnPicker(false)} />
          <div className="relative bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[80vh] flex flex-col">
            <div className="p-4 border-b border-slate-100 flex items-center justify-between">
              <h3 className="text-lg font-bold text-slate-900">Add Add-on</h3>
              <button
                onClick={() => setShowAddOnPicker(false)}
                className="flex items-center justify-center w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-all"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-4">
              {addOnsLoading ? (
                <div className="flex items-center justify-center py-8">
                  <span className="loading loading-spinner loading-md text-[#0066CC]"></span>
                </div>
              ) : availableAddOns.length === 0 ? (
                <div className="text-center py-8">
                  <div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                  </div>
                  <p className="text-sm font-medium text-slate-600">No add-on products available</p>
                  <p className="text-xs text-slate-400 mt-1">Create add-on products in Settings first</p>
                </div>
              ) : (
                <div className="space-y-2">
                  {availableAddOns.map((addon) => (
                    <button
                      key={addon.id || addon._id}
                      onClick={() => handleAddAddOn(addon)}
                      disabled={actionLoading === "addon"}
                      className="w-full p-4 text-left bg-slate-50 hover:bg-slate-100 rounded-xl transition-all"
                    >
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="font-medium text-slate-900">{addon.name}</p>
                          <p className="text-sm text-slate-500">
                            {addon.category || "Uncategorized"}
                            {addon.description && ` • ${addon.description}`}
                          </p>
                        </div>
                        <div className="text-right">
                          <p className="font-semibold text-slate-900">
                            {formatCurrency(addon.defaultPriceNet)}
                          </p>
                          <p className="text-xs text-slate-500">
                            {addon.vatTreatment === "EXEMPT" ? "VAT Exempt" : "+ VAT"}
                          </p>
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      {showDeleteConfirm && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowDeleteConfirm(false)} />
          <div className="relative bg-white rounded-2xl shadow-xl w-full max-w-sm p-6">
            <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </div>
            <h3 className="text-lg font-bold text-slate-900 text-center mb-2">Delete Draft?</h3>
            <p className="text-sm text-slate-500 text-center mb-6">
              This will permanently delete this draft deal. This action cannot be undone.
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setShowDeleteConfirm(false)}
                className="btn btn-ghost flex-1"
              >
                Cancel
              </button>
              <button
                onClick={handleDeleteDraft}
                disabled={actionLoading === "delete"}
                className="btn bg-red-500 hover:bg-red-600 text-white border-none flex-1"
              >
                {actionLoading === "delete" ? (
                  <span className="loading loading-spinner loading-sm"></span>
                ) : (
                  "Delete"
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Agreed Work Modal */}
      {showAgreedWorkModal && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowAgreedWorkModal(false)} />
          <div className="relative bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 className="text-lg font-bold text-slate-900 mb-4">Add Agreed Work</h3>
            <p className="text-sm text-slate-500 mb-4">
              Record work that has been promised to the customer. This will appear on the deposit receipt.
            </p>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">Title *</label>
                <input
                  type="text"
                  value={agreedWorkForm.title}
                  onChange={(e) => setAgreedWorkForm({ ...agreedWorkForm, title: e.target.value })}
                  placeholder="e.g., Repair scratch on rear bumper"
                  className="input input-bordered w-full"
                  autoFocus
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">Details</label>
                <textarea
                  value={agreedWorkForm.details}
                  onChange={(e) => setAgreedWorkForm({ ...agreedWorkForm, details: e.target.value })}
                  placeholder="Optional additional details..."
                  className="textarea textarea-bordered w-full"
                  rows={2}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">Type</label>
                <div className="flex flex-wrap gap-2">
                  {[
                    { value: "PREP", label: "Prep Work" },
                    { value: "COSMETIC", label: "Cosmetic" },
                    { value: "ACCESSORY", label: "Accessory" },
                    { value: "ADMIN", label: "Admin" },
                    { value: "OTHER", label: "Other" },
                  ].map((opt) => (
                    <button
                      key={opt.value}
                      onClick={() => setAgreedWorkForm({ ...agreedWorkForm, type: opt.value })}
                      className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                        agreedWorkForm.type === opt.value
                          ? "bg-[#0066CC] text-white"
                          : "bg-slate-100 text-slate-600 hover:bg-slate-200"
                      }`}
                    >
                      {opt.label}
                    </button>
                  ))}
                </div>
              </div>

              <div className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                <input
                  type="checkbox"
                  id="syncToVehicle"
                  checked={agreedWorkForm.syncToVehicle}
                  onChange={(e) => setAgreedWorkForm({ ...agreedWorkForm, syncToVehicle: e.target.checked })}
                  className="checkbox checkbox-sm checkbox-primary"
                />
                <label htmlFor="syncToVehicle" className="flex-1 text-sm text-slate-700">
                  <span className="font-medium">Also add to vehicle issues</span>
                  <span className="block text-xs text-slate-400">Creates a linked issue for prep tracking</span>
                </label>
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button
                onClick={() => {
                  setShowAgreedWorkModal(false);
                  setAgreedWorkForm({ title: "", details: "", type: "PREP", syncToVehicle: true });
                }}
                className="btn btn-ghost flex-1"
              >
                Cancel
              </button>
              <button
                onClick={handleAddAgreedWork}
                disabled={!agreedWorkForm.title.trim() || actionLoading === "agreedWork"}
                className="btn bg-orange-500 hover:bg-orange-600 text-white border-none flex-1"
              >
                {actionLoading === "agreedWork" ? (
                  <span className="loading loading-spinner loading-sm"></span>
                ) : (
                  "Add Work Item"
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Part Exchange Modal */}
      {showPxModal && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowPxModal(false)} />
          <div className="relative bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
            <div className="p-4 border-b border-slate-100 flex items-center justify-between shrink-0">
              <h3 className="text-lg font-bold text-slate-900">Add Part Exchange</h3>
              <button
                onClick={() => setShowPxModal(false)}
                className="flex items-center justify-center w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-all"
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-4">
              {/* Import from Appraisals Section */}
              {selectedPxAppraisal ? (
                <div className="p-3 bg-emerald-50 border border-emerald-200 rounded-xl">
                  <div className="flex items-start justify-between gap-2">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="text-xs font-medium px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700">
                          {selectedPxAppraisal.type === "customer_px" ? "Customer Appraisal" : "Dealer Appraisal"}
                        </span>
                        {selectedPxAppraisal.issueCount > 0 && (
                          <span className="text-xs font-medium px-2 py-0.5 rounded-full bg-amber-100 text-amber-700">
                            {selectedPxAppraisal.issueCount} issue{selectedPxAppraisal.issueCount > 1 ? "s" : ""}
                          </span>
                        )}
                      </div>
                      <p className="text-sm font-semibold text-emerald-800">
                        {selectedPxAppraisal.vehicleReg} - {selectedPxAppraisal.vehicleMake} {selectedPxAppraisal.vehicleModel}
                      </p>
                      {selectedPxAppraisal.conditionNotes && (
                        <p className="text-xs text-emerald-600 mt-1 line-clamp-2">{selectedPxAppraisal.conditionNotes}</p>
                      )}
                    </div>
                    <button
                      onClick={handleClearPxAppraisal}
                      className="p-1.5 rounded-lg text-emerald-500 hover:text-emerald-700 hover:bg-emerald-100"
                      title="Clear and enter manually"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
              ) : (
                <div className="relative">
                  <label className="block text-xs font-medium text-slate-500 uppercase tracking-wide mb-2">
                    Import from Appraisals
                  </label>
                  <div className="relative">
                    <input
                      type="text"
                      placeholder="Search by VRM to import..."
                      className="input input-bordered w-full pl-10 text-sm"
                      onChange={(e) => handlePxAppraisalSearch(e.target.value)}
                    />
                    <svg className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    {pxAppraisalSearching && (
                      <span className="absolute right-3 top-1/2 -translate-y-1/2 loading loading-spinner loading-xs text-slate-400"></span>
                    )}
                  </div>
                  {/* Appraisal Suggestions Dropdown */}
                  {pxAppraisalSuggestions.length > 0 && (
                    <div className="absolute z-10 mt-1 w-full bg-white rounded-xl border border-slate-200 shadow-lg max-h-48 overflow-y-auto">
                      {pxAppraisalSuggestions.map((a) => (
                        <button
                          key={a.id}
                          onClick={() => handleSelectPxAppraisal(a)}
                          className="w-full px-3 py-2 text-left hover:bg-slate-50 border-b border-slate-100 last:border-0"
                        >
                          <div className="flex items-center justify-between gap-2">
                            <div>
                              <p className="text-sm font-medium text-slate-900">{a.vehicleReg}</p>
                              <p className="text-xs text-slate-500">{a.vehicleMake} {a.vehicleModel} {a.vehicleYear}</p>
                            </div>
                            <div className="flex items-center gap-1">
                              {a.issueCount > 0 && (
                                <span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded">
                                  {a.issueCount} issue{a.issueCount > 1 ? "s" : ""}
                                </span>
                              )}
                              <span className={`text-xs px-1.5 py-0.5 rounded ${
                                a.type === "customer_px" ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-600"
                              }`}>
                                {a.type === "customer_px" ? "Customer" : "Dealer"}
                              </span>
                            </div>
                          </div>
                        </button>
                      ))}
                    </div>
                  )}
                  <p className="text-xs text-slate-400 mt-1">Find a customer or dealer appraisal to auto-fill details</p>
                </div>
              )}

              <div className="border-t border-slate-200 pt-4">
                <label className="block text-sm font-medium text-slate-700 mb-1">
                  Registration <span className="text-red-500">*</span>
                </label>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={pxForm.vrm}
                    onChange={(e) => setPxForm({ ...pxForm, vrm: e.target.value.toUpperCase() })}
                    className="input input-bordered flex-1 font-mono"
                    placeholder="AB12 CDE"
                    onKeyDown={(e) => {
                      if (e.key === "Enter" && pxForm.vrm) {
                        e.preventDefault();
                        handlePxVrmLookup();
                      }
                    }}
                  />
                  <button
                    type="button"
                    onClick={handlePxVrmLookup}
                    disabled={pxLookupLoading || !pxForm.vrm}
                    className="btn bg-[#0066CC] hover:bg-[#0055B3] text-white border-none px-4"
                  >
                    {pxLookupLoading ? (
                      <span className="loading loading-spinner loading-xs"></span>
                    ) : (
                      <>
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <span className="hidden sm:inline ml-1">Lookup</span>
                      </>
                    )}
                  </button>
                </div>
                <p className="text-xs text-slate-400 mt-1">Enter VRM and click Lookup to auto-fill vehicle details</p>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Make</label>
                  <input
                    type="text"
                    value={pxForm.make}
                    onChange={(e) => setPxForm({ ...pxForm, make: e.target.value })}
                    className="input input-bordered w-full"
                    placeholder="e.g., Ford"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Model</label>
                  <input
                    type="text"
                    value={pxForm.model}
                    onChange={(e) => setPxForm({ ...pxForm, model: e.target.value })}
                    className="input input-bordered w-full"
                    placeholder="e.g., Focus"
                  />
                </div>
              </div>

              <div className="grid grid-cols-3 gap-3">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Year</label>
                  <input
                    type="number"
                    value={pxForm.year}
                    onChange={(e) => setPxForm({ ...pxForm, year: e.target.value })}
                    className="input input-bordered w-full"
                    placeholder="2020"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Mileage</label>
                  <input
                    type="number"
                    value={pxForm.mileage}
                    onChange={(e) => setPxForm({ ...pxForm, mileage: e.target.value })}
                    className="input input-bordered w-full"
                    placeholder="50000"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-1">Colour</label>
                  <input
                    type="text"
                    value={pxForm.colour}
                    onChange={(e) => setPxForm({ ...pxForm, colour: e.target.value })}
                    className="input input-bordered w-full"
                    placeholder="Silver"
                  />
                </div>
              </div>

              <div className="border-t border-slate-200 pt-4">
                <h4 className="text-sm font-semibold text-slate-900 mb-3">Valuation</h4>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">
                      Allowance <span className="text-red-500">*</span>
                    </label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">£</span>
                      <input
                        type="number"
                        value={pxForm.allowance}
                        onChange={(e) => setPxForm({ ...pxForm, allowance: e.target.value })}
                        className="input input-bordered w-full pl-7"
                        placeholder="5000"
                        step="0.01"
                        min="0"
                      />
                    </div>
                    <p className="text-xs text-slate-400 mt-1">Agreed value to customer</p>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-1">Settlement</label>
                    <div className="relative">
                      <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">£</span>
                      <input
                        type="number"
                        value={pxForm.settlement}
                        onChange={(e) => setPxForm({ ...pxForm, settlement: e.target.value })}
                        className="input input-bordered w-full pl-7"
                        placeholder="0"
                        step="0.01"
                        min="0"
                      />
                    </div>
                    <p className="text-xs text-slate-400 mt-1">Finance to pay off</p>
                  </div>
                </div>

                {/* Net preview */}
                {pxForm.allowance && (
                  <div className="mt-3 p-3 bg-emerald-50 rounded-lg text-center">
                    <p className="text-xs text-emerald-600 uppercase tracking-wide font-medium">Net Value to Customer</p>
                    <p className="text-xl font-bold text-emerald-700">
                      {formatCurrency(parseFloat(pxForm.allowance || 0) - parseFloat(pxForm.settlement || 0))}
                    </p>
                  </div>
                )}
              </div>
            </div>

            <div className="flex gap-3 p-4 border-t border-slate-100 shrink-0">
              <button
                onClick={() => {
                  setShowPxModal(false);
                  setSelectedPxAppraisal(null);
                  setPxAppraisalSuggestions([]);
                  setPxForm({ vrm: "", make: "", model: "", year: "", mileage: "", colour: "", fuelType: "", allowance: "", settlement: "", sourceType: "MANUAL", sourceId: null, conditionNotes: "" });
                }}
                className="btn btn-ghost flex-1"
              >
                Cancel
              </button>
              <button
                onClick={handleAddPartExchange}
                disabled={!pxForm.vrm || !pxForm.allowance || pxLoading}
                className="btn bg-emerald-500 hover:bg-emerald-600 text-white border-none flex-1"
              >
                {pxLoading ? (
                  <span className="loading loading-spinner loading-sm"></span>
                ) : (
                  "Add Part Exchange"
                )}
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Handover Pack Modal */}
      {showHandoverModal && (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/50" onClick={() => setShowHandoverModal(false)} />
          <div className="relative bg-white rounded-2xl shadow-xl w-full max-w-md p-6">
            <h3 className="text-lg font-bold text-slate-900 mb-2">Generate Handover Pack</h3>
            <p className="text-sm text-slate-500 mb-6">
              Select documents to include in the customer handover pack.
            </p>

            <div className="space-y-3">
              {/* Invoice - required */}
              <div className="flex items-center gap-3 p-3 bg-blue-50 rounded-xl border border-blue-100">
                <input
                  type="checkbox"
                  checked={handoverDocs.invoice}
                  disabled
                  className="checkbox checkbox-sm checkbox-primary"
                />
                <div className="flex-1">
                  <p className="font-medium text-slate-900 flex items-center gap-2">
                    Invoice
                    <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">Required</span>
                  </p>
                  <p className="text-xs text-slate-500">
                    {documents.invoice?.documentNumber}
                    {documents.invoice?.issuedAt && (
                      <> • Issued {new Date(documents.invoice.issuedAt).toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" })}</>
                    )}
                  </p>
                </div>
                <svg className="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                </svg>
              </div>

              {/* PDI - optional */}
              <div className={`flex items-center gap-3 p-3 rounded-xl border ${
                linkedSubmissions.pdi
                  ? "bg-white border-slate-200 hover:border-slate-300 cursor-pointer"
                  : "bg-slate-50 border-slate-100"
              }`}
              onClick={() => linkedSubmissions.pdi && setHandoverDocs({ ...handoverDocs, pdi: !handoverDocs.pdi })}
              >
                <input
                  type="checkbox"
                  checked={handoverDocs.pdi}
                  onChange={(e) => setHandoverDocs({ ...handoverDocs, pdi: e.target.checked })}
                  disabled={!linkedSubmissions.pdi}
                  className="checkbox checkbox-sm checkbox-primary"
                />
                <div className="flex-1">
                  <p className={`font-medium flex items-center gap-2 ${linkedSubmissions.pdi ? "text-slate-900" : "text-slate-400"}`}>
                    Pre-Delivery Inspection (PDI)
                    {!linkedSubmissions.pdi && <span className="text-xs bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full">Optional</span>}
                  </p>
                  <p className="text-xs text-slate-500">
                    {linkedSubmissions.pdi
                      ? `Completed ${new Date(linkedSubmissions.pdi.createdAt).toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" })}`
                      : "No PDI found — can proceed without"}
                  </p>
                </div>
                {linkedSubmissions.pdi && (
                  <svg className="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                )}
              </div>

              {/* Service Receipt - optional */}
              <div className={`flex items-center gap-3 p-3 rounded-xl border ${
                linkedSubmissions.serviceReceipt
                  ? "bg-white border-slate-200 hover:border-slate-300 cursor-pointer"
                  : "bg-slate-50 border-slate-100"
              }`}
              onClick={() => linkedSubmissions.serviceReceipt && setHandoverDocs({ ...handoverDocs, serviceReceipt: !handoverDocs.serviceReceipt })}
              >
                <input
                  type="checkbox"
                  checked={handoverDocs.serviceReceipt}
                  onChange={(e) => setHandoverDocs({ ...handoverDocs, serviceReceipt: e.target.checked })}
                  disabled={!linkedSubmissions.serviceReceipt}
                  className="checkbox checkbox-sm checkbox-primary"
                />
                <div className="flex-1">
                  <p className={`font-medium flex items-center gap-2 ${linkedSubmissions.serviceReceipt ? "text-slate-900" : "text-slate-400"}`}>
                    Service Receipt
                    {!linkedSubmissions.serviceReceipt && <span className="text-xs bg-slate-200 text-slate-500 px-2 py-0.5 rounded-full">Optional</span>}
                  </p>
                  <p className="text-xs text-slate-500">
                    {linkedSubmissions.serviceReceipt
                      ? `Completed ${new Date(linkedSubmissions.serviceReceipt.createdAt).toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" })}`
                      : "No service receipt found — can proceed without"}
                  </p>
                </div>
                {linkedSubmissions.serviceReceipt && (
                  <svg className="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                )}
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button
                onClick={() => setShowHandoverModal(false)}
                className="btn btn-ghost flex-1"
              >
                Cancel
              </button>
              <button
                onClick={handleGenerateHandoverPack}
                disabled={isGeneratingPack}
                className="btn bg-emerald-500 hover:bg-emerald-600 text-white border-none flex-1"
              >
                {isGeneratingPack ? (
                  <span className="loading loading-spinner loading-sm"></span>
                ) : (
                  <>
                    <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Generate Pack
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
