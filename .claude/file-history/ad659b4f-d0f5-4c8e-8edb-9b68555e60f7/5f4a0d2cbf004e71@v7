import { useEffect, useState } from "react";
import Head from "next/head";
import Link from "next/link";
import DashboardLayout from "@/components/DashboardLayout";
import { toast } from "react-hot-toast";
import { showDummyNotification } from "@/utils/notifications";

const COLUMNS = [
  { key: "in_stock", label: "In Prep", gradient: "from-orange-100/60", accent: "border-l-orange-400", accentBg: "bg-orange-400" },
  { key: "in_prep", label: "Advertised", gradient: "from-blue-100/60", accent: "border-l-blue-400", accentBg: "bg-blue-400" },
  { key: "live", label: "Sold In Progress", gradient: "from-purple-100/60", accent: "border-l-purple-400", accentBg: "bg-purple-400" },
  { key: "reserved", label: "Completed", gradient: "from-emerald-100/60", accent: "border-l-emerald-400", accentBg: "bg-emerald-400" },
  { key: "delivered", label: "Delivered", gradient: "from-teal-100/60", accent: "border-l-teal-400", accentBg: "bg-teal-400" },
];

const ISSUE_SUBCATEGORIES = {
  mechanical: ["Engine", "Transmission", "Suspension", "Brakes", "Exhaust", "Other"],
  electrical: ["Battery", "Lights", "Starter Motor", "Alternator", "Sensors", "Other"],
  bodywork: ["Panel Damage", "Scratches", "Dents", "Bumper", "Windscreen", "Other"],
  interior: ["Seats", "Dashboard", "Trim", "Carpet", "Controls", "Other"],
  tyres: ["Tread Depth", "Puncture", "Alloys", "Alignment", "Other"],
  mot: ["Advisory", "Failed Item", "Due Soon", "Other"],
  service: ["Oil Change", "Filters", "Fluids", "Timing Belt", "Other"],
  fault_codes: ["Engine", "Transmission", "ABS", "Airbag", "Emissions", "Other"],
  other: ["General", "Misc"],
};

export default function SalesPrep() {
  const [vehicles, setVehicles] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedVehicle, setSelectedVehicle] = useState(null);
  const [showAddModal, setShowAddModal] = useState(false);
  const [draggedCard, setDraggedCard] = useState(null);
  const [dragPosition, setDragPosition] = useState({ x: 0, y: 0 });
  const [newTaskName, setNewTaskName] = useState("");
  const [activeTab, setActiveTab] = useState("overview");
  const [editingTaskId, setEditingTaskId] = useState(null);
  const [editingTaskName, setEditingTaskName] = useState("");

  // Column sorting state
  const [columnSortOptions, setColumnSortOptions] = useState({});

  // Job sheet share state
  const [showJobSheetModal, setShowJobSheetModal] = useState(false);
  const [jobSheetLink, setJobSheetLink] = useState(null);
  const [isGeneratingJobSheet, setIsGeneratingJobSheet] = useState(false);

  // Issues state
  const [showAddIssueModal, setShowAddIssueModal] = useState(false);
  const [issueForm, setIssueForm] = useState({
    category: "",
    subcategory: "",
    description: "",
    actionNeeded: "",
    status: "outstanding",
    notes: "",
    photos: [],
  });
  const [issueUpdateContent, setIssueUpdateContent] = useState({});
  const [expandedIssues, setExpandedIssues] = useState({});

  // Filters state
  const [activeFilters, setActiveFilters] = useState([]);
  const [showFiltersDropdown, setShowFiltersDropdown] = useState(false);

  // Documents state
  const [showAddDocumentModal, setShowAddDocumentModal] = useState(false);
  const [documentForm, setDocumentForm] = useState({
    name: "",
    type: "other",
    file: null,
  });

  // Location state
  const [locations, setLocations] = useState([]);
  const [showAddLocationModal, setShowAddLocationModal] = useState(false);

  // Vehicle Labels state
  const [availableLabels, setAvailableLabels] = useState([]);
  const [showLabelsDropdown, setShowLabelsDropdown] = useState(false);
  const [showAddLabelModal, setShowAddLabelModal] = useState(false);
  const [newLabelForm, setNewLabelForm] = useState({ name: "", colour: "#6366f1" });

  // VRM Search state
  const [vrmSearch, setVrmSearch] = useState("");
  const [showVrmDropdown, setShowVrmDropdown] = useState(false);

  // Mobile state
  const [mobileActiveColumn, setMobileActiveColumn] = useState("in_stock");

  useEffect(() => {
    fetchVehicles();
    fetchLocations();
    fetchLabels();
  }, []);

  const fetchVehicles = async () => {
    try {
      const res = await fetch("/api/vehicles");
      if (!res.ok) {
        throw new Error(`API error: ${res.status}`);
      }
      const data = await res.json();
      setVehicles(Array.isArray(data) ? data : []);
    } catch (error) {
      console.error("Failed to load vehicles:", error);
      toast.error("Failed to load vehicles");
      setVehicles([]);
    } finally {
      setIsLoading(false);
    }
  };

  const fetchLocations = async () => {
    try {
      const res = await fetch("/api/locations");
      const data = await res.json();
      setLocations(data);
    } catch (error) {
      console.error("Failed to load locations:", error);
    }
  };

  const fetchLabels = async () => {
    try {
      const res = await fetch("/api/labels");
      const data = await res.json();
      setAvailableLabels(Array.isArray(data) ? data : []);
    } catch (error) {
      console.error("Failed to load labels:", error);
    }
  };

  // Toggle a label on/off for a vehicle
  const toggleVehicleLabel = async (vehicleId, labelId) => {
    try {
      const res = await fetch(`/api/vehicles/${vehicleId}/labels/${labelId}`, {
        method: "POST",
      });
      if (res.ok) {
        const updatedData = await res.json();
        // Update selected vehicle if it's the same one
        if (selectedVehicle?.id === vehicleId) {
          setSelectedVehicle(prev => ({
            ...prev,
            labels: updatedData.labels || [],
          }));
        }
        fetchVehicles();
      }
    } catch (error) {
      toast.error("Failed to update label");
    }
  };

  // Create a new label
  const createLabel = async () => {
    if (!newLabelForm.name.trim()) {
      toast.error("Label name is required");
      return;
    }
    try {
      const res = await fetch("/api/labels", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newLabelForm),
      });
      if (res.ok) {
        const newLabel = await res.json();
        setAvailableLabels(prev => [...prev, newLabel]);
        setNewLabelForm({ name: "", colour: "#6366f1" });
        setShowAddLabelModal(false);
        toast.success("Label created");
      }
    } catch (error) {
      toast.error("Failed to create label");
    }
  };

  // Open vehicle drawer - vehicle from grid already has tasks, issues, documents
  const openVehicleDrawer = (vehicle) => {
    setSelectedVehicle({ ...vehicle, id: vehicle.id || vehicle._id });
    setActiveTab("overview");
    setShowLabelsDropdown(false); // Close labels dropdown when opening new vehicle
  };

  const updateVehicleStatus = async (vehicleId, newStatus) => {
    try {
      await fetch(`/api/vehicles/${vehicleId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus }),
      });
      fetchVehicles();
      toast.success(`Moved to ${newStatus.replace("_", " ")}`);
    } catch (error) {
      toast.error("Failed to update");
    }
  };

  const updateTaskStatus = async (taskId, newStatus) => {
    try {
      const payload = { status: newStatus };
      if (newStatus === "done") {
        payload.completedAt = new Date().toISOString();
      }
      await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
    } catch (error) {
      toast.error("Failed to update task");
    }
  };

  const updateTaskName = async (taskId, newName) => {
    if (!newName.trim()) {
      toast.error("Task name cannot be empty");
      return;
    }
    try {
      await fetch(`/api/tasks/${taskId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newName }),
      });
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}`);
      const data = await res.json();
      setSelectedVehicle(data);
      fetchVehicles();
      setEditingTaskId(null);
      setEditingTaskName("");
      toast.success("Task updated");
    } catch (error) {
      toast.error("Failed to update task");
    }
  };

  const addTask = async () => {
    if (!newTaskName.trim()) return toast.error("Task name is required");
    try {
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/tasks`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: newTaskName }),
      });
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || "Failed to add task");
      }
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      setNewTaskName("");
      fetchVehicles();
      toast.success("Task added");
    } catch (error) {
      console.error("Add task error:", error);
      toast.error(error.message || "Failed to add task");
    }
  };

  const deleteTask = async (taskId) => {
    try {
      await fetch(`/api/tasks/${taskId}`, { method: "DELETE" });
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Task removed");
    } catch (error) {
      toast.error("Failed to delete task");
    }
  };

  // Issue functions
  const addIssue = async (photoUrls = []) => {
    if (!issueForm.category || !issueForm.subcategory || !issueForm.description) {
      return toast.error("Category, subcategory, and description are required");
    }
    try {
      const issueData = {
        ...issueForm,
        photos: [...(issueForm.photos || []), ...photoUrls],
      };
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/issues`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(issueData),
      });
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(errorData.error || "Failed to add issue");
      }
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      setShowAddIssueModal(false);
      setIssueForm({
        category: "",
        subcategory: "",
        description: "",
        actionNeeded: "",
        status: "outstanding",
        notes: "",
        photos: [],
      });
      toast.success("Issue added");
    } catch (error) {
      console.error("Add issue error:", error);
      toast.error(error.message || "Failed to add issue");
    }
  };

  const updateIssue = async (issueId, updates) => {
    try {
      const res = await fetch(`/api/issues/${issueId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updates),
      });
      if (!res.ok) throw new Error("Failed to update issue");
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Issue updated");
    } catch (error) {
      toast.error("Failed to update issue");
    }
  };

  const deleteIssue = async (issueId) => {
    try {
      await fetch(`/api/issues/${issueId}`, { method: "DELETE" });
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Issue removed");
    } catch (error) {
      toast.error("Failed to delete issue");
    }
  };

  const addIssueUpdate = async (issueId, content) => {
    if (!content?.trim()) {
      return toast.error("Update content cannot be empty");
    }

    try {
      await fetch(`/api/issues/${issueId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: content.trim(),
          userName: "Current User" // TODO: Replace with actual user name from auth
        }),
      });

      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      setIssueUpdateContent(prev => ({ ...prev, [issueId]: "" }));
      toast.success("Update added");
    } catch (error) {
      toast.error("Failed to add update");
    }
  };

  // Document functions
  const uploadDocument = async (file, name, type) => {
    if (!file) return;

    try {
      // First upload the file
      const uploadFormData = new FormData();
      uploadFormData.append("file", file);

      const uploadRes = await fetch("/api/vehicles/upload", {
        method: "POST",
        body: uploadFormData,
      });
      if (!uploadRes.ok) throw new Error("File upload failed");
      const uploadData = await uploadRes.json();

      // Then create the document record with the URL
      const docRes = await fetch(`/api/vehicles/${selectedVehicle.id}/documents`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, type, url: uploadData.url }),
      });
      if (!docRes.ok) throw new Error("Document creation failed");

      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      setShowAddDocumentModal(false);
      setDocumentForm({ name: "", type: "other", file: null });
      toast.success("Document uploaded");
    } catch (error) {
      console.error("Upload error:", error);
      toast.error("Failed to upload document");
    }
  };

  const deleteDocument = async (documentId) => {
    try {
      await fetch(`/api/documents/${documentId}`, { method: "DELETE" });
      const updatedVehicle = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updatedVehicle);
      fetchVehicles();
      toast.success("Document removed");
    } catch (error) {
      toast.error("Failed to delete document");
    }
  };

  const handleDragStart = (e, vehicle) => {
    setDraggedCard(vehicle);
    setDragPosition({ x: e.clientX, y: e.clientY });
    e.dataTransfer.effectAllowed = "move";
    // Create invisible drag image (we'll render our own preview)
    const emptyImg = new Image();
    emptyImg.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
    e.dataTransfer.setDragImage(emptyImg, 0, 0);
  };

  const handleDrag = (e) => {
    if (e.clientX !== 0 && e.clientY !== 0) {
      setDragPosition({ x: e.clientX, y: e.clientY });
    }
  };

  const handleDragOver = (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = "move";
  };

  const handleDragEnd = () => {
    setDraggedCard(null);
  };

  const handleDrop = async (e, newStatus) => {
    e.preventDefault();
    if (!draggedCard || draggedCard.status === newStatus) {
      setDraggedCard(null);
      return;
    }
    const vehicleId = draggedCard.id || draggedCard._id;
    await updateVehicleStatus(vehicleId, newStatus);
    setDraggedCard(null);
  };

  const uploadV5 = async (file) => {
    if (!file) return;

    try {
      // First upload the file
      const formData = new FormData();
      formData.append("file", file);

      const uploadRes = await fetch("/api/vehicles/upload", {
        method: "POST",
        body: formData,
      });
      if (!uploadRes.ok) throw new Error("Upload failed");
      const uploadData = await uploadRes.json();

      // Then update the vehicle with the V5 URL
      await fetch(`/api/vehicles/${selectedVehicle.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ v5Url: uploadData.url }),
      });

      const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
      setSelectedVehicle(updated);
      fetchVehicles();
      toast.success("V5 uploaded");
    } catch (error) {
      console.error("V5 upload error:", error);
      toast.error("Failed to upload V5");
    }
  };

  const formatDate = (date) => {
    if (!date) return "â€”";
    return new Date(date).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
  };

  const toggleFilter = (filter) => {
    setActiveFilters(prev =>
      prev.includes(filter)
        ? prev.filter(f => f !== filter)
        : [...prev, filter]
    );
  };

  const getFilteredVehicles = (vehicleList) => {
    if (activeFilters.length === 0) return vehicleList;

    return vehicleList.filter(vehicle => {
      return activeFilters.every(filter => {
        const tasks = vehicle.tasks || [];
        const issues = vehicle.issues || [];
        const activeIssues = issues.filter(i => {
          const status = (i.status || "").toLowerCase();
          return ["outstanding", "ordered", "in progress", "in_progress"].includes(status);
        });

        // Prep task filters
        if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
        if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
        if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
        if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");

        // Issue filters
        if (filter === "needs_paint") return activeIssues.some(i => {
          const cat = (i.category || "").toLowerCase();
          return cat === "bodywork" || cat === "cosmetic";
        });
        if (filter === "needs_mechanical") return activeIssues.some(i => {
          const cat = (i.category || "").toLowerCase();
          return cat === "mechanical";
        });
        if (filter === "needs_electrical") return activeIssues.some(i => {
          const cat = (i.category || "").toLowerCase();
          return cat === "electrical";
        });

        // Location filter
        if (filter === "offsite") return vehicle.locationId != null;

        // MOT filters
        if (filter === "mot_due_soon") {
          if (!vehicle.motExpiryDate) return false;
          const expiry = new Date(vehicle.motExpiryDate);
          const now = new Date();
          const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
          return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
        }
        if (filter === "mot_expired") {
          if (!vehicle.motExpiryDate) return false;
          const expiry = new Date(vehicle.motExpiryDate);
          const now = new Date();
          return expiry < now;
        }

        // Sale type filters
        if (filter === "trade_only") return vehicle.saleType === "TRADE";
        if (filter === "retail_only") return vehicle.saleType === "RETAIL" || !vehicle.saleType;

        return true;
      });
    });
  };

  const getVehiclesByStatus = (status) => {
    const statusVehicles = vehicles.filter(v => v.status === status);
    const filtered = getFilteredVehicles(statusVehicles);

    // Apply sorting based on columnSortOptions
    const sortOption = columnSortOptions[status] || "oldest_first";

    return [...filtered].sort((a, b) => {
      const daysA = a.createdAt ? Math.floor((new Date() - new Date(a.createdAt)) / (1000 * 60 * 60 * 24)) : 0;
      const daysB = b.createdAt ? Math.floor((new Date() - new Date(b.createdAt)) / (1000 * 60 * 60 * 24)) : 0;

      switch (sortOption) {
        case "oldest_first":
          return daysB - daysA; // More days = older = first
        case "newest_first":
          return daysA - daysB; // Fewer days = newer = first
        case "alphabetical":
          const nameA = `${a.make || ""} ${a.model || ""}`.toLowerCase();
          const nameB = `${b.make || ""} ${b.model || ""}`.toLowerCase();
          return nameA.localeCompare(nameB);
        default:
          return daysB - daysA;
      }
    });
  };

  const getFilterCount = (filter) => {
    const allFiltered = getFilteredVehicles(vehicles.filter(v => {
      const tasks = v.tasks || [];
      const issues = v.issues || [];
      const activeIssues = issues.filter(i => {
        const status = (i.status || "").toLowerCase();
        return ["outstanding", "ordered", "in progress", "in_progress"].includes(status);
      });

      if (filter === "awaiting_pdi") return !tasks.find(t => t.name.toLowerCase().includes("pdi") && t.status === "done");
      if (filter === "awaiting_valet") return !tasks.find(t => t.name.toLowerCase().includes("valet") && t.status === "done");
      if (filter === "awaiting_photos") return !tasks.find(t => t.name.toLowerCase().includes("photo") && t.status === "done");
      if (filter === "awaiting_mot") return !tasks.find(t => t.name.toLowerCase().includes("mot") && t.status === "done");
      if (filter === "needs_paint") return activeIssues.some(i => {
        const cat = (i.category || "").toLowerCase();
        return cat === "bodywork" || cat === "cosmetic";
      });
      if (filter === "needs_mechanical") return activeIssues.some(i => {
        const cat = (i.category || "").toLowerCase();
        return cat === "mechanical";
      });
      if (filter === "needs_electrical") return activeIssues.some(i => {
        const cat = (i.category || "").toLowerCase();
        return cat === "electrical";
      });
      if (filter === "offsite") return v.locationId != null;
      if (filter === "mot_due_soon") {
        if (!v.motExpiryDate) return false;
        const expiry = new Date(v.motExpiryDate);
        const now = new Date();
        const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));
        return daysUntilExpiry >= 0 && daysUntilExpiry <= 30;
      }
      if (filter === "mot_expired") {
        if (!v.motExpiryDate) return false;
        const expiry = new Date(v.motExpiryDate);
        return expiry < new Date();
      }
      if (filter === "trade_only") return v.saleType === "TRADE";
      if (filter === "retail_only") return v.saleType === "RETAIL" || !v.saleType;
      return false;
    }));
    return allFiltered.length;
  };

  // VRM Search functions
  const getVrmSearchResults = () => {
    if (vrmSearch.length < 2) return [];
    const searchTerm = vrmSearch.toUpperCase().replace(/\s/g, "");
    return vehicles.filter(v => {
      const reg = (v.regCurrent || "").toUpperCase().replace(/\s/g, "");
      return reg.includes(searchTerm);
    }).slice(0, 8); // Limit to 8 results
  };

  const handleVrmSelect = (vehicle) => {
    // Close dropdown and clear search
    setVrmSearch("");
    setShowVrmDropdown(false);

    // Find which column this vehicle is in and scroll to it
    const columnIndex = COLUMNS.findIndex(col => col.key === vehicle.status);
    if (columnIndex >= 0) {
      // Scroll the column into view
      const columnElements = document.querySelectorAll('[data-column-key]');
      if (columnElements[columnIndex]) {
        columnElements[columnIndex].scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }
    }

    // Open the vehicle drawer with full details
    openVehicleDrawer(vehicle);
  };

  const getStatusLabel = (statusKey) => {
    const col = COLUMNS.find(c => c.key === statusKey);
    return col ? col.label : statusKey;
  };

  const handlePrintVehicle = () => {
    if (!selectedVehicle) return;

    const vehicle = selectedVehicle;
    const tasks = vehicle.tasks || [];
    const issues = vehicle.issues || [];
    const documents = vehicle.documents || [];
    const completedTasks = tasks.filter(t => t.status === "done").length;
    const daysInStock = vehicle.createdAt
      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
      : 0;

    // Get status label from COLUMNS
    const statusColumn = COLUMNS.find(col => col.key === vehicle.status);
    const statusLabel = statusColumn ? statusColumn.label : vehicle.status;

    // Generate HTML for print
    const printContent = `
<!DOCTYPE html>
<html>
<head>
  <title>${vehicle.year || ""} ${vehicle.make} ${vehicle.model} - ${vehicle.regCurrent}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 40px; color: #1e293b; }
    .header { border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; margin-bottom: 30px; }
    .title { font-size: 28px; font-weight: bold; margin-bottom: 8px; }
    .reg { font-size: 18px; font-family: monospace; color: #64748b; }
    .section { margin-bottom: 30px; }
    .section-title { font-size: 16px; font-weight: 600; color: #475569; margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .field { margin-bottom: 12px; }
    .field-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
    .field-value { font-size: 14px; color: #1e293b; }
    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .badge-status { background: #e0e7ff; color: #4338ca; }
    .badge-days { background: ${daysInStock > 30 ? '#fef2f2' : '#f1f5f9'}; color: ${daysInStock > 30 ? '#dc2626' : '#475569'}; }
    .task-list { list-style: none; }
    .task-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
    .task-status { width: 20px; height: 20px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .task-done { background: #dcfce7; color: #16a34a; }
    .task-pending { background: #fef3c7; color: #d97706; }
    .task-progress { background: #dbeafe; color: #2563eb; }
    .issue-card { border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
    .issue-header { display: flex; gap: 8px; margin-bottom: 8px; }
    .issue-badge { background: #f1f5f9; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .issue-desc { font-size: 14px; color: #1e293b; }
    .doc-item { padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 12px; color: #94a3b8; }
    @media print {
      body { padding: 20px; }
      .no-print { display: none; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">${vehicle.year || ""} ${vehicle.make} ${vehicle.model}</div>
    <div class="reg">${vehicle.regCurrent}</div>
  </div>

  <div class="section">
    <div class="section-title">Overview</div>
    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
      <span class="badge badge-status">${statusLabel}</span>
      <span class="badge badge-days">Days in Stock: ${daysInStock}</span>
      ${vehicle.locationId ? `<span class="badge" style="background:#eef2ff;color:#4f46e5;">ğŸ“ ${vehicle.locationId.name || 'Offsite'}</span>` : '<span class="badge" style="background:#f0fdf4;color:#16a34a;">ğŸ“ On Site</span>'}
    </div>
  </div>

  <div class="section">
    <div class="section-title">Vehicle Details</div>
    <div class="grid">
      <div class="field">
        <div class="field-label">Registration</div>
        <div class="field-value">${vehicle.regCurrent || 'â€”'}</div>
      </div>
      <div class="field">
        <div class="field-label">VIN</div>
        <div class="field-value">${vehicle.vin || 'â€”'}</div>
      </div>
      <div class="field">
        <div class="field-label">Make</div>
        <div class="field-value">${vehicle.make || 'â€”'}</div>
      </div>
      <div class="field">
        <div class="field-label">Model</div>
        <div class="field-value">${vehicle.model || 'â€”'}</div>
      </div>
      <div class="field">
        <div class="field-label">Year</div>
        <div class="field-value">${vehicle.year || 'â€”'}</div>
      </div>
      <div class="field">
        <div class="field-label">Mileage</div>
        <div class="field-value">${vehicle.mileageCurrent ? vehicle.mileageCurrent.toLocaleString() + ' miles' : 'â€”'}</div>
      </div>
      <div class="field">
        <div class="field-label">Colour</div>
        <div class="field-value">${vehicle.colour || 'â€”'}</div>
      </div>
      <div class="field">
        <div class="field-label">Fuel Type</div>
        <div class="field-value">${vehicle.fuelType || 'â€”'}</div>
      </div>
      <div class="field">
        <div class="field-label">MOT Expiry</div>
        <div class="field-value">${vehicle.motExpiryDate ? new Date(vehicle.motExpiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : 'â€”'}</div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Prep Checklist (${completedTasks}/${tasks.length} complete)</div>
    ${tasks.length > 0 ? `
    <ul class="task-list">
      ${tasks.map(task => `
        <li class="task-item">
          <span class="task-status ${task.status === 'done' ? 'task-done' : task.status === 'in_progress' ? 'task-progress' : 'task-pending'}">
            ${task.status === 'done' ? 'âœ“' : task.status === 'in_progress' ? 'â†’' : 'â—‹'}
          </span>
          <span style="${task.status === 'done' ? 'text-decoration: line-through; color: #94a3b8;' : ''}">${task.name}</span>
          ${task.completedAt ? `<span style="font-size: 11px; color: #94a3b8; margin-left: auto;">${new Date(task.completedAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' })}</span>` : ''}
        </li>
      `).join('')}
    </ul>
    ` : '<p style="color: #94a3b8; font-size: 14px;">No tasks</p>'}
  </div>

  <div class="section">
    <div class="section-title">Issues (${issues.length})</div>
    ${issues.length > 0 ? issues.map(issue => `
      <div class="issue-card">
        <div class="issue-header">
          <span class="issue-badge">${issue.category}</span>
          ${issue.subcategory ? `<span class="issue-badge">${issue.subcategory}</span>` : ''}
          <span class="issue-badge" style="margin-left: auto;">${issue.status || 'Outstanding'}</span>
        </div>
        <div class="issue-desc">${issue.description}</div>
        ${issue.actionNeeded ? `<div style="font-size: 12px; color: #64748b; margin-top: 6px;">Action: ${issue.actionNeeded}</div>` : ''}
      </div>
    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No issues recorded</p>'}
  </div>

  <div class="section">
    <div class="section-title">Documents (${documents.length})</div>
    ${documents.length > 0 ? documents.map(doc => `
      <div class="doc-item">
        <span style="font-weight: 500;">${doc.name}</span>
        <span style="font-size: 12px; color: #94a3b8; margin-left: 8px;">(${doc.type.replace(/_/g, ' ')})</span>
      </div>
    `).join('') : '<p style="color: #94a3b8; font-size: 14px;">No documents uploaded</p>'}
    ${vehicle.v5Url ? '<div class="doc-item"><span style="font-weight: 500;">V5 Document</span> <span style="font-size: 12px; color: #16a34a;">âœ“ Uploaded</span></div>' : ''}
  </div>

  ${vehicle.notes ? `
  <div class="section">
    <div class="section-title">Notes</div>
    <p style="font-size: 14px; white-space: pre-wrap;">${vehicle.notes}</p>
  </div>
  ` : ''}

  <div class="footer">
    Printed from DealerFlow on ${new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
  </div>
</body>
</html>
    `;

    // Open in new tab
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
  };

  // Job sheet share handlers
  const handleGenerateJobSheet = async () => {
    if (!selectedVehicle) return;
    setIsGeneratingJobSheet(true);
    try {
      const res = await fetch(`/api/vehicles/${selectedVehicle.id}/job-sheet`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ expiresInDays: 60 }),
      });
      if (!res.ok) throw new Error("Failed to generate share link");
      const data = await res.json();
      const fullUrl = `${window.location.origin}${data.shareUrl}`;
      setJobSheetLink({
        url: fullUrl,
        expiresAt: data.expiresAt,
      });
      setShowJobSheetModal(true);
    } catch (error) {
      toast.error(error.message);
    } finally {
      setIsGeneratingJobSheet(false);
    }
  };

  const copyJobSheetLink = () => {
    if (jobSheetLink?.url) {
      navigator.clipboard.writeText(jobSheetLink.url);
      toast.success("Link copied to clipboard!");
    }
  };

  const shareViaWhatsApp = () => {
    if (jobSheetLink?.url) {
      const text = `Job sheet for ${selectedVehicle?.regCurrent}: ${jobSheetLink.url}`;
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank");
    }
  };

  const getMOTStatus = (motExpiryDate) => {
    if (!motExpiryDate) return null;
    const expiry = new Date(motExpiryDate);
    const now = new Date();
    const daysUntilExpiry = Math.ceil((expiry - now) / (1000 * 60 * 60 * 24));

    if (daysUntilExpiry < 0) return { type: "expired", label: "MOT EXPIRED", class: "bg-red-50 text-red-700 border border-red-200" };
    if (daysUntilExpiry <= 30) return { type: "due_soon", label: "MOT DUE", class: "bg-amber-50 text-amber-700 border border-amber-200" };
    return null;
  };

  const getActiveIssuesByCategory = (issues = []) => {
    const activeIssues = issues.filter(i => {
      const status = (i.status || "").toLowerCase();
      return ["outstanding", "ordered", "in_progress", "in progress"].includes(status);
    });
    const categoryCounts = {};
    activeIssues.forEach(issue => {
      categoryCounts[issue.category] = (categoryCounts[issue.category] || 0) + 1;
    });
    return categoryCounts;
  };

  return (
    <DashboardLayout>
      <Head><title>Stock & Prep | DealerFlow</title></Head>

      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-3xl font-bold">Stock & Prep Board</h1>
          <p className="text-base-content/60 mt-1">Manage vehicle prep and sales pipeline &bull; Drag cards to move between stages</p>
        </div>
        <button className="btn btn-primary" onClick={() => setShowAddModal(true)}>
          + Add Vehicle
        </button>
      </div>

      {/* Consolidated Filters */}
      <div className="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-slate-200 mb-4 -mx-6 px-6 py-4">
        <div className="flex gap-2 items-center">
            {/* VRM Search */}
            <div className="relative">
              <div className="relative">
                <svg className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input
                  type="text"
                  placeholder="Search VRM..."
                  className="input input-sm input-bordered pl-9 pr-8 w-44 font-mono uppercase"
                  value={vrmSearch}
                  onChange={(e) => {
                    setVrmSearch(e.target.value.toUpperCase());
                    setShowVrmDropdown(e.target.value.length >= 2);
                  }}
                  onFocus={() => vrmSearch.length >= 2 && setShowVrmDropdown(true)}
                  onKeyDown={(e) => {
                    if (e.key === "Escape") {
                      setShowVrmDropdown(false);
                      e.target.blur();
                    }
                  }}
                />
                {vrmSearch && (
                  <button
                    className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600"
                    onClick={() => {
                      setVrmSearch("");
                      setShowVrmDropdown(false);
                    }}
                  >
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                )}
              </div>

              {/* VRM Search Dropdown */}
              {showVrmDropdown && (
                <>
                  <div className="fixed inset-0 z-10" onClick={() => setShowVrmDropdown(false)}></div>
                  <div className="absolute top-full left-0 mt-1 w-72 bg-white rounded-xl shadow-xl border border-slate-200 z-20 overflow-hidden">
                    {getVrmSearchResults().length > 0 ? (
                      <ul className="py-1 max-h-64 overflow-y-auto">
                        {getVrmSearchResults().map((vehicle) => (
                          <li key={vehicle.id || vehicle._id}>
                            <button
                              className="w-full px-4 py-2.5 text-left hover:bg-slate-50 flex items-center justify-between gap-2 transition-colors"
                              onClick={() => handleVrmSelect(vehicle)}
                            >
                              <div className="flex items-center gap-3">
                                <span className="font-mono font-bold text-slate-900">{vehicle.regCurrent}</span>
                                <span className="text-sm text-slate-500">{vehicle.make} {vehicle.model}</span>
                              </div>
                              <span className="text-xs px-2 py-0.5 rounded-full bg-slate-100 text-slate-600">
                                {getStatusLabel(vehicle.status)}
                              </span>
                            </button>
                          </li>
                        ))}
                      </ul>
                    ) : (
                      <div className="px-4 py-6 text-center">
                        <svg className="w-8 h-8 mx-auto text-slate-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p className="text-sm text-slate-500">No vehicles found</p>
                        <p className="text-xs text-slate-400 mt-1">Try a different registration</p>
                      </div>
                    )}
                  </div>
                </>
              )}
            </div>

            <div className="divider divider-horizontal mx-1"></div>

            {/* All Vehicles Button */}
            <button
              className={`btn btn-sm ${activeFilters.length === 0 ? "btn-primary" : "btn-outline"}`}
              onClick={() => setActiveFilters([])}
            >
              All Vehicles ({vehicles.length})
            </button>

            <div className="divider divider-horizontal mx-1"></div>

            {/* Consolidated Filters - Strictly Separated Desktop/Mobile */}
            <div className="relative shrink-0">
              {/* Trigger Button - Fixed for mobile */}
              <button
                className={`flex items-center gap-2 px-3 py-2 rounded-lg shrink-0 whitespace-nowrap text-sm font-medium transition-all ${
                  activeFilters.length > 0
                    ? "bg-blue-600 text-white"
                    : "bg-white border border-slate-200 text-slate-700 hover:border-slate-300"
                }`}
                onClick={() => setShowFiltersDropdown(!showFiltersDropdown)}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                <span className="hidden sm:inline">Filters</span>
                {activeFilters.length > 0 && (
                  <span className={`text-xs px-1.5 py-0.5 rounded-full ${
                    activeFilters.length > 0 ? "bg-white/20 text-white" : "bg-slate-100 text-slate-600"
                  }`}>{activeFilters.length}</span>
                )}
              </button>

              {showFiltersDropdown && (
                <>
                  {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                  {/* DESKTOP: Dropdown Panel (lg: and up) */}
                  {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                  <div className="hidden lg:block">
                    {/* Backdrop */}
                    <div
                      className="fixed inset-0 z-40"
                      onClick={() => setShowFiltersDropdown(false)}
                    />

                    {/* Desktop Filter Panel */}
                    <div className="absolute z-50 top-full right-0 mt-2 w-[720px] bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden">
                      {/* 3-Column Grid with Dividers */}
                      <div className="grid grid-cols-3 divide-x divide-slate-100">
                        {/* Column 1: Prep Tasks */}
                        <div className="p-5">
                          <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Prep Tasks</h5>
                          {[
                            { key: "awaiting_pdi", label: "Awaiting PDI" },
                            { key: "awaiting_valet", label: "Awaiting Valet" },
                            { key: "awaiting_photos", label: "Awaiting Photos" },
                            { key: "awaiting_mot", label: "Awaiting MOT" },
                          ].map(filter => {
                            const isActive = activeFilters.includes(filter.key);
                            const count = getFilterCount(filter.key);
                            return (
                              <button
                                key={filter.key}
                                onClick={() => toggleFilter(filter.key)}
                                className={`w-full flex justify-between items-center px-3 py-2 mb-2 rounded-md text-sm font-medium transition-all ${
                                  isActive
                                    ? "bg-blue-50 text-blue-700 border border-blue-200 shadow-sm"
                                    : "text-slate-600 border border-transparent hover:bg-slate-50 hover:border-slate-200"
                                }`}
                              >
                                <span>{filter.label}</span>
                                <span className={`text-xs px-1.5 py-0.5 rounded ${
                                  isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                }`}>{count}</span>
                              </button>
                            );
                          })}
                        </div>

                        {/* Column 2: Issues */}
                        <div className="p-5">
                          <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Issues</h5>
                          {[
                            { key: "needs_paint", label: "Needs Paint" },
                            { key: "needs_mechanical", label: "Needs Mechanical" },
                            { key: "needs_electrical", label: "Needs Electrical" },
                          ].map(filter => {
                            const isActive = activeFilters.includes(filter.key);
                            const count = getFilterCount(filter.key);
                            return (
                              <button
                                key={filter.key}
                                onClick={() => toggleFilter(filter.key)}
                                className={`w-full flex justify-between items-center px-3 py-2 mb-2 rounded-md text-sm font-medium transition-all ${
                                  isActive
                                    ? "bg-blue-50 text-blue-700 border border-blue-200 shadow-sm"
                                    : "text-slate-600 border border-transparent hover:bg-slate-50 hover:border-slate-200"
                                }`}
                              >
                                <span>{filter.label}</span>
                                <span className={`text-xs px-1.5 py-0.5 rounded ${
                                  isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                }`}>{count}</span>
                              </button>
                            );
                          })}
                        </div>

                        {/* Column 3: Location + Sale Type + MOT Status */}
                        <div className="p-5">
                          <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Location</h5>
                          {(() => {
                            const isActive = activeFilters.includes("offsite");
                            const count = getFilterCount("offsite");
                            return (
                              <button
                                onClick={() => toggleFilter("offsite")}
                                className={`w-full flex justify-between items-center px-3 py-2 mb-2 rounded-md text-sm font-medium transition-all ${
                                  isActive
                                    ? "bg-blue-50 text-blue-700 border border-blue-200 shadow-sm"
                                    : "text-slate-600 border border-transparent hover:bg-slate-50 hover:border-slate-200"
                                }`}
                              >
                                <span>Offsite Only</span>
                                <span className={`text-xs px-1.5 py-0.5 rounded ${
                                  isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                }`}>{count}</span>
                              </button>
                            );
                          })()}

                          <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-5">Sale Type</h5>
                          {[
                            { key: "trade_only", label: "Trade Only" },
                            { key: "retail_only", label: "Retail Only" },
                          ].map(filter => {
                            const isActive = activeFilters.includes(filter.key);
                            const count = getFilterCount(filter.key);
                            return (
                              <button
                                key={filter.key}
                                onClick={() => toggleFilter(filter.key)}
                                className={`w-full flex justify-between items-center px-3 py-2 mb-2 rounded-md text-sm font-medium transition-all ${
                                  isActive
                                    ? "bg-blue-50 text-blue-700 border border-blue-200 shadow-sm"
                                    : "text-slate-600 border border-transparent hover:bg-slate-50 hover:border-slate-200"
                                }`}
                              >
                                <span>{filter.label}</span>
                                <span className={`text-xs px-1.5 py-0.5 rounded ${
                                  isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                }`}>{count}</span>
                              </button>
                            );
                          })}

                          <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-5">MOT Status</h5>
                          {[
                            { key: "mot_expired", label: "MOT Expired" },
                            { key: "mot_due_soon", label: "MOT Due Soon" },
                          ].map(filter => {
                            const isActive = activeFilters.includes(filter.key);
                            const count = getFilterCount(filter.key);
                            return (
                              <button
                                key={filter.key}
                                onClick={() => toggleFilter(filter.key)}
                                className={`w-full flex justify-between items-center px-3 py-2 mb-2 rounded-md text-sm font-medium transition-all ${
                                  isActive
                                    ? "bg-blue-50 text-blue-700 border border-blue-200 shadow-sm"
                                    : "text-slate-600 border border-transparent hover:bg-slate-50 hover:border-slate-200"
                                }`}
                              >
                                <span>{filter.label}</span>
                                <span className={`text-xs px-1.5 py-0.5 rounded ${
                                  isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                                }`}>{count}</span>
                              </button>
                            );
                          })}
                        </div>
                      </div>

                      {/* Desktop Footer */}
                      <div className="bg-slate-50 border-t border-slate-100 p-4 flex justify-between items-center">
                        <button
                          onClick={() => setActiveFilters([])}
                          className="text-sm text-slate-500 hover:text-red-600 underline decoration-slate-300 transition-colors"
                        >
                          Clear all filters
                        </button>
                        <button
                          onClick={() => setShowFiltersDropdown(false)}
                          className="bg-slate-900 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 shadow-lg shadow-slate-200 transition-colors"
                        >
                          Apply Filters
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                  {/* MOBILE: Full-Screen Modal (< lg screens) */}
                  {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                  <div className="lg:hidden fixed inset-0 z-[9999] w-full h-full bg-white flex flex-col">
                    {/* Mobile Header - Sticky */}
                    <div className="sticky top-0 z-10 bg-white border-b border-slate-100 px-4 py-4 flex justify-between items-center">
                      <h2 className="text-lg font-bold text-slate-900">Filters</h2>
                      <div className="flex items-center gap-3">
                        {activeFilters.length > 0 && (
                          <button
                            onClick={() => setActiveFilters([])}
                            className="text-sm text-slate-500 hover:text-red-500 transition-colors"
                          >
                            Reset
                          </button>
                        )}
                        <button
                          onClick={() => setShowFiltersDropdown(false)}
                          className="p-2 -mr-2 rounded-lg hover:bg-slate-100 transition-colors"
                        >
                          <svg className="w-6 h-6 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </div>
                    </div>

                    {/* Mobile Body - Scrollable with bottom padding */}
                    <div className="flex-1 overflow-y-auto p-4 pb-32">
                      {/* Prep Tasks */}
                      <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Prep Tasks</h5>
                      {[
                        { key: "awaiting_pdi", label: "Awaiting PDI" },
                        { key: "awaiting_valet", label: "Awaiting Valet" },
                        { key: "awaiting_photos", label: "Awaiting Photos" },
                        { key: "awaiting_mot", label: "Awaiting MOT" },
                      ].map(filter => {
                        const isActive = activeFilters.includes(filter.key);
                        const count = getFilterCount(filter.key);
                        return (
                          <button
                            key={filter.key}
                            onClick={() => toggleFilter(filter.key)}
                            className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                              isActive
                                ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                                : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                            }`}
                          >
                            <span>{filter.label}</span>
                            <span className={`text-sm px-2.5 py-1 rounded-lg ${
                              isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                            }`}>{count}</span>
                          </button>
                        );
                      })}

                      {/* Issues */}
                      <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6">Issues</h5>
                      {[
                        { key: "needs_paint", label: "Needs Paint" },
                        { key: "needs_mechanical", label: "Needs Mechanical" },
                        { key: "needs_electrical", label: "Needs Electrical" },
                      ].map(filter => {
                        const isActive = activeFilters.includes(filter.key);
                        const count = getFilterCount(filter.key);
                        return (
                          <button
                            key={filter.key}
                            onClick={() => toggleFilter(filter.key)}
                            className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                              isActive
                                ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                                : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                            }`}
                          >
                            <span>{filter.label}</span>
                            <span className={`text-sm px-2.5 py-1 rounded-lg ${
                              isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                            }`}>{count}</span>
                          </button>
                        );
                      })}

                      {/* Location */}
                      <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6">Location</h5>
                      {(() => {
                        const isActive = activeFilters.includes("offsite");
                        const count = getFilterCount("offsite");
                        return (
                          <button
                            onClick={() => toggleFilter("offsite")}
                            className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                              isActive
                                ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                                : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                            }`}
                          >
                            <span>Offsite Only</span>
                            <span className={`text-sm px-2.5 py-1 rounded-lg ${
                              isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                            }`}>{count}</span>
                          </button>
                        );
                      })()}

                      {/* Sale Type */}
                      <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6">Sale Type</h5>
                      {[
                        { key: "trade_only", label: "Trade Only" },
                        { key: "retail_only", label: "Retail Only" },
                      ].map(filter => {
                        const isActive = activeFilters.includes(filter.key);
                        const count = getFilterCount(filter.key);
                        return (
                          <button
                            key={filter.key}
                            onClick={() => toggleFilter(filter.key)}
                            className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                              isActive
                                ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                                : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                            }`}
                          >
                            <span>{filter.label}</span>
                            <span className={`text-sm px-2.5 py-1 rounded-lg ${
                              isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                            }`}>{count}</span>
                          </button>
                        );
                      })}

                      {/* MOT Status */}
                      <h5 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3 mt-6">MOT Status</h5>
                      {[
                        { key: "mot_expired", label: "MOT Expired" },
                        { key: "mot_due_soon", label: "MOT Due Soon" },
                      ].map(filter => {
                        const isActive = activeFilters.includes(filter.key);
                        const count = getFilterCount(filter.key);
                        return (
                          <button
                            key={filter.key}
                            onClick={() => toggleFilter(filter.key)}
                            className={`w-full flex justify-between items-center px-4 py-3.5 mb-2 rounded-xl text-base font-medium transition-all ${
                              isActive
                                ? "bg-blue-50 text-blue-700 border-2 border-blue-400 shadow-sm"
                                : "text-slate-700 border border-slate-200 hover:bg-slate-50 active:bg-slate-100"
                            }`}
                          >
                            <span>{filter.label}</span>
                            <span className={`text-sm px-2.5 py-1 rounded-lg ${
                              isActive ? "bg-blue-100 text-blue-700" : "bg-slate-100 text-slate-500"
                            }`}>{count}</span>
                          </button>
                        );
                      })}
                    </div>

                    {/* Mobile Footer - Fixed at bottom, full-width Apply button */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 p-4 z-20">
                      <button
                        onClick={() => setShowFiltersDropdown(false)}
                        className="w-full bg-slate-900 text-white py-4 rounded-xl text-base font-bold hover:bg-slate-800 active:bg-slate-700 transition-colors shadow-lg"
                      >
                        Apply Filters {activeFilters.length > 0 && `(${activeFilters.length})`}
                      </button>
                    </div>
                  </div>
                </>
              )}
            </div>
          </div>
      </div>

      {isLoading ? (
        <div className="flex justify-center py-20">
          <span className="loading loading-spinner loading-lg"></span>
        </div>
      ) : (
        <>
          {/* Mobile Column Tabs */}
          <div className="md:hidden mb-4 overflow-x-auto">
            <div className="flex gap-1 p-1 bg-slate-100 rounded-xl min-w-max">
              {COLUMNS.map((col) => {
                const count = getVehiclesByStatus(col.key).length;
                return (
                  <button
                    key={col.key}
                    onClick={() => setMobileActiveColumn(col.key)}
                    className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${
                      mobileActiveColumn === col.key
                        ? "bg-white shadow-sm text-slate-900"
                        : "text-slate-500 hover:text-slate-700"
                    }`}
                  >
                    <span>{col.label}</span>
                    <span className={`px-1.5 py-0.5 rounded text-xs font-bold ${
                      mobileActiveColumn === col.key ? "bg-slate-100" : "bg-slate-200/50"
                    }`}>
                      {count}
                    </span>
                  </button>
                );
              })}
            </div>
          </div>

          {/* Mobile Single Column View */}
          <div className="md:hidden">
            {COLUMNS.filter(col => col.key === mobileActiveColumn).map((col) => {
              const columnVehicles = getVehiclesByStatus(col.key);

              // Issue category styling with icons (mobile)
              const issueCategoryStyles = {
                Mechanical: { bg: "bg-red-50", text: "text-red-700", border: "border-red-100", icon: (
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                )},
                Cosmetic: { bg: "bg-purple-50", text: "text-purple-700", border: "border-purple-100", icon: (
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                  </svg>
                )},
                Electrical: { bg: "bg-yellow-50", text: "text-yellow-800", border: "border-yellow-100", icon: (
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                )},
                Other: { bg: "bg-blue-50", text: "text-blue-700", border: "border-blue-100", icon: (
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                )},
              };

              return (
                <div key={col.key} className="space-y-3">
                  {columnVehicles.map((vehicle) => {
                    const tasks = vehicle.tasks || [];
                    const completedTasks = tasks.filter(t => t.status === "done").length;
                    const motStatus = getMOTStatus(vehicle.motExpiryDate);
                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);
                    const daysInStock = vehicle.createdAt
                      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
                      : 0;

                    return (
                      <div
                        key={vehicle.id}
                        className="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow border border-slate-100/50 overflow-hidden active:scale-[0.98]"
                        onClick={() => openVehicleDrawer(vehicle)}
                      >
                        <div className="p-4">
                          {/* Title with Registration Badge */}
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 flex-wrap mb-1">
                                <p className="font-bold text-slate-900 text-base">
                                  {vehicle.year || ""} {vehicle.make} {vehicle.model}
                                </p>
                                <span className="font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md">
                                  {vehicle.regCurrent}
                                </span>
                              </div>
                            </div>
                            {/* Days in stock (de-emphasized) */}
                            <span className={`inline-flex items-center gap-1 text-xs ${daysInStock > 30 ? "text-red-500" : "text-slate-400"}`}>
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              {daysInStock}d
                            </span>
                          </div>

                          {/* Tags - Modern Pill Style */}
                          <div className="flex gap-1.5 flex-wrap mb-3">
                            {vehicle.locationId && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                {vehicle.locationId.name || "Offsite"}
                              </span>
                            )}
                            {vehicle.saleType === "TRADE" && (
                              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase">
                                Trade
                              </span>
                            )}
                            {motStatus?.type === "expired" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                MOT Expired
                              </span>
                            )}
                            {/* Issue Pills with Icons */}
                            {Object.entries(issueCounts).map(([category, count]) => {
                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;
                              return (
                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>
                                  {style.icon}
                                  {count} {category}
                                </span>
                              );
                            })}
                            {/* Custom Labels */}
                            {vehicle.labels?.map((label) => (
                              <span
                                key={label.id}
                                className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border"
                                style={{
                                  backgroundColor: `${label.colour}10`,
                                  color: label.colour,
                                  borderColor: `${label.colour}30`,
                                }}
                              >
                                <span className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: label.colour }}></span>
                                {label.name}
                              </span>
                            ))}
                          </div>

                          {/* Slick Progress Bar */}
                          {tasks.length > 0 && (
                            <div>
                              <span className="text-xs text-slate-400 mb-1 block">
                                {completedTasks}/{tasks.length} tasks
                              </span>
                              <div className="w-full bg-slate-100 rounded-full h-2">
                                <div
                                  className="h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400"
                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}
                                ></div>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                  {columnVehicles.length === 0 && (
                    <div className="text-center py-12 text-slate-400">
                      <p className="text-sm">No vehicles in {col.label}</p>
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          {/* Mobile Floating Action Button */}
          <button
            onClick={() => setShowAddModal(true)}
            className="md:hidden fixed bottom-20 right-4 z-40 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition-all active:scale-95"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </button>

          {/* Desktop Multi-Column View */}
          <div className="hidden md:flex gap-4 overflow-x-auto pb-6">
            {COLUMNS.map((col) => {
              const columnVehicles = getVehiclesByStatus(col.key);
              return (
                <div
                  key={col.key}
                  data-column-key={col.key}
                  className={`flex-shrink-0 w-64 bg-gradient-to-b ${col.gradient} to-transparent rounded-2xl p-3 min-h-[400px]`}
                  onDragOver={handleDragOver}
                onDrop={(e) => handleDrop(e, col.key)}
              >
                {/* Integrated Header */}
                <div className="flex items-center justify-between mb-3">
                  <div className="flex items-center gap-2">
                    <h3 className="font-semibold text-slate-700 text-sm">
                      {col.label}
                    </h3>
                    <span className="bg-slate-900/10 text-slate-700 w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center">
                      {columnVehicles.length}
                    </span>
                  </div>
                  <div className="dropdown dropdown-end">
                    <label tabIndex={0} className="btn btn-ghost btn-xs gap-1 bg-white/30 backdrop-blur-sm hover:bg-white/50 rounded-full">
                      <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                      </svg>
                      <span className="text-xs">
                        {columnSortOptions[col.key] === "newest_first" ? "Newest" :
                         columnSortOptions[col.key] === "alphabetical" ? "A-Z" : "Oldest"}
                      </span>
                    </label>
                    <ul tabIndex={0} className="dropdown-content z-30 menu p-2 shadow-lg bg-white rounded-xl w-44 mt-2">
                      <li>
                        <button
                          className={`rounded-lg ${columnSortOptions[col.key] === "oldest_first" || !columnSortOptions[col.key] ? "active bg-slate-100" : ""}`}
                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "oldest_first" }))}
                        >
                          Oldest First
                        </button>
                      </li>
                      <li>
                        <button
                          className={`rounded-lg ${columnSortOptions[col.key] === "newest_first" ? "active bg-slate-100" : ""}`}
                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "newest_first" }))}
                        >
                          Newest First
                        </button>
                      </li>
                      <li>
                        <button
                          className={`rounded-lg ${columnSortOptions[col.key] === "alphabetical" ? "active bg-slate-100" : ""}`}
                          onClick={() => setColumnSortOptions(prev => ({ ...prev, [col.key]: "alphabetical" }))}
                        >
                          Alphabetical (Make/Model)
                        </button>
                      </li>
                    </ul>
                  </div>
                </div>

                {/* Cards Container */}
                <div className="space-y-3">
                  {columnVehicles.map((vehicle) => {
                    const tasks = vehicle.tasks || [];
                    const completedTasks = tasks.filter(t => t.status === "done").length;
                    const motStatus = getMOTStatus(vehicle.motExpiryDate);
                    const issueCounts = getActiveIssuesByCategory(vehicle.issues);

                    // Calculate days in stock
                    const daysInStock = vehicle.createdAt
                      ? Math.floor((new Date() - new Date(vehicle.createdAt)) / (1000 * 60 * 60 * 24))
                      : 0;

                    // Issue category styling with icons
                    const issueCategoryStyles = {
                      Mechanical: { bg: "bg-red-50", text: "text-red-700", border: "border-red-100", icon: (
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      )},
                      Cosmetic: { bg: "bg-purple-50", text: "text-purple-700", border: "border-purple-100", icon: (
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                        </svg>
                      )},
                      Electrical: { bg: "bg-yellow-50", text: "text-yellow-800", border: "border-yellow-100", icon: (
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                      )},
                      Other: { bg: "bg-blue-50", text: "text-blue-700", border: "border-blue-100", icon: (
                        <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      )},
                    };

                    return (
                      <div
                        key={vehicle.id}
                        draggable
                        onDragStart={(e) => handleDragStart(e, vehicle)}
                        onDrag={handleDrag}
                        onDragEnd={handleDragEnd}
                        className={`bg-white rounded-xl shadow-sm hover:shadow-md transition-all cursor-grab active:cursor-grabbing border border-slate-100/50 overflow-hidden ${draggedCard?.id === vehicle.id ? "opacity-40 scale-95" : ""}`}
                        onClick={() => openVehicleDrawer(vehicle)}
                      >
                        <div className="p-3">
                          {/* Title with Registration Badge */}
                          <div className="flex justify-between items-start mb-2">
                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 flex-wrap">
                                <p className="font-bold text-slate-900 text-sm leading-tight">
                                  {vehicle.year || ""} {vehicle.make} {vehicle.model}
                                </p>
                                <span className="font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md">
                                  {vehicle.regCurrent}
                                </span>
                              </div>
                            </div>
                          </div>

                          {/* Tags - Modern Pill Style */}
                          <div className="flex gap-1.5 flex-wrap mb-2">
                            {/* Trade badge */}
                            {vehicle.saleType === "TRADE" && (
                              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-[10px] font-bold bg-slate-800 text-white uppercase">
                                Trade
                              </span>
                            )}
                            {motStatus?.type === "expired" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-700 border border-red-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                MOT Expired
                              </span>
                            )}
                            {motStatus?.type === "due_soon" && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                MOT Due
                              </span>
                            )}
                            {/* Issue Pills with Icons */}
                            {Object.entries(issueCounts).map(([category, count]) => {
                              const style = issueCategoryStyles[category] || issueCategoryStyles.Other;
                              return (
                                <span key={category} className={`inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold ${style.bg} ${style.text} border ${style.border}`}>
                                  {style.icon}
                                  {count} {category}
                                </span>
                              );
                            })}
                            {vehicle.locationId && (
                              <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold bg-indigo-50 text-indigo-700 border border-indigo-100">
                                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                {vehicle.locationId.name}
                              </span>
                            )}
                            {/* Custom Labels */}
                            {vehicle.labels?.map((label) => (
                              <span
                                key={label.id}
                                className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded-full text-[10px] font-semibold border"
                                style={{
                                  backgroundColor: `${label.colour}10`,
                                  color: label.colour,
                                  borderColor: `${label.colour}30`,
                                }}
                              >
                                <span className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: label.colour }}></span>
                                {label.name}
                              </span>
                            ))}
                          </div>

                          {/* Slick Progress Bar */}
                          {tasks.length > 0 && (
                            <div className="mb-2">
                              <span className="text-xs text-slate-400 mb-1 block">
                                {completedTasks}/{tasks.length} tasks
                              </span>
                              <div className="w-full bg-slate-100 rounded-full h-2">
                                <div
                                  className="h-2 rounded-full transition-all bg-gradient-to-r from-blue-500 to-cyan-400"
                                  style={{ width: `${(completedTasks / tasks.length) * 100}%` }}
                                ></div>
                              </div>
                            </div>
                          )}

                          {/* Footer - Days in Stock (de-emphasized) */}
                          <div className="pt-2 border-t border-slate-100 flex items-center justify-between">
                            <span className={`inline-flex items-center gap-1 text-[10px] font-medium ${daysInStock > 30 ? "text-red-500" : "text-slate-400"}`}>
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              {daysInStock}d in stock
                            </span>
                            {daysInStock > 30 && (
                              <span className="inline-flex items-center px-1.5 py-0.5 rounded-full text-[10px] font-semibold bg-red-50 text-red-500 border border-red-100">
                                Aging
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    );
                  })}

                  {/* Empty State */}
                  {columnVehicles.length === 0 && (
                    <div className="text-center py-8 px-4">
                      <div className="w-12 h-12 mx-auto mb-3 rounded-full bg-white/50 flex items-center justify-center">
                        <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                      </div>
                      <p className="text-sm text-slate-500 font-medium">No vehicles</p>
                      <p className="text-xs text-slate-400 mt-1">Drag cards here to move</p>
                    </div>
                  )}
                </div>
              </div>
            );
          })}
          </div>
        </>
      )}

      {/* Vehicle Detail Drawer - Full Screen on Mobile */}
      {selectedVehicle && (
        <div className="fixed inset-0 z-50 flex justify-end">
          <div className="bg-black/50 absolute inset-0 hidden md:block" onClick={() => setSelectedVehicle(null)}></div>
          <div className="relative bg-white w-full md:max-w-3xl h-full overflow-y-auto flex flex-col">
            {/* Sticky Header */}
            <div className="sticky top-0 bg-white border-b border-slate-200 px-4 md:px-6 py-3 md:py-4 flex justify-between items-center z-10">
              <div className="flex items-center gap-3">
                {/* Back button on mobile */}
                <button className="md:hidden btn btn-ghost btn-sm btn-circle" onClick={() => setSelectedVehicle(null)}>
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <div>
                  <h2 className="text-lg md:text-xl font-bold text-slate-900">
                    {selectedVehicle.year || ""} {selectedVehicle.make} {selectedVehicle.model}
                  </h2>
                  <p className="text-xs md:text-sm text-slate-500 font-mono mt-0.5">{selectedVehicle.regCurrent}</p>
                </div>
              </div>
              <div className="flex items-center gap-1 md:gap-2">
                <button
                  className="hidden md:flex btn btn-outline btn-sm"
                  onClick={handleGenerateJobSheet}
                  disabled={isGeneratingJobSheet}
                  title="Share job sheet with mechanic"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                  </svg>
                  {isGeneratingJobSheet ? "..." : "Share"}
                </button>
                <button className="hidden md:flex btn btn-outline btn-sm" onClick={handlePrintVehicle} title="Print vehicle details">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                  </svg>
                  Print
                </button>
                <button
                  className="btn btn-ghost btn-sm text-error"
                  onClick={async () => {
                    if (confirm("Delete this vehicle?")) {
                      await fetch(`/api/vehicles/${selectedVehicle.id}`, { method: "DELETE" });
                      setSelectedVehicle(null);
                      fetchVehicles();
                      toast.success("Vehicle deleted");
                    }
                  }}
                  title="Delete vehicle"
                >
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
                <button className="hidden md:flex btn btn-ghost btn-sm" onClick={() => setSelectedVehicle(null)}>
                  âœ•
                </button>
              </div>
            </div>

            {/* Tabs - Using DaisyUI tabs */}
            <div className="bg-base-100 border-b border-base-300 px-4">
              <div className="tabs tabs-bordered">
                <button
                  className={`tab ${activeTab === "overview" ? "tab-active" : ""}`}
                  onClick={() => setActiveTab("overview")}
                >
                  Overview
                </button>
                <button
                  className={`tab ${activeTab === "checklist" ? "tab-active" : ""}`}
                  onClick={() => setActiveTab("checklist")}
                >
                  Checklist {selectedVehicle.tasks?.length > 0 && `(${selectedVehicle.tasks.length})`}
                </button>
                <button
                  className={`tab ${activeTab === "issues" ? "tab-active" : ""}`}
                  onClick={() => setActiveTab("issues")}
                >
                  Issues {selectedVehicle.issues?.length > 0 && `(${selectedVehicle.issues.length})`}
                </button>
                <button
                  className={`tab ${activeTab === "documents" ? "tab-active" : ""}`}
                  onClick={() => setActiveTab("documents")}
                >
                  Documents {selectedVehicle.documents?.length > 0 && `(${selectedVehicle.documents.length})`}
                </button>
              </div>
            </div>

            <div className="p-6 space-y-6">
              {/* Overview Tab */}
              {activeTab === "overview" && (
                <div className="space-y-6">
                  {/* Identity Section */}
                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <h3 className="text-sm font-semibold text-slate-900 mb-4">Identity</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Registration</label>
                        <input
                          type="text"
                          className="input input-sm bg-slate-50 border-slate-200 text-slate-900"
                          value={selectedVehicle.regCurrent || ""}
                          onChange={(e) => setSelectedVehicle({ ...selectedVehicle, regCurrent: e.target.value.toUpperCase() })}
                          onBlur={async () => {
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ regCurrent: selectedVehicle.regCurrent }),
                            });
                            fetchVehicles();
                          }}
                        />
                      </div>
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">VIN</label>
                        <input
                          type="text"
                          className="input input-sm bg-slate-50 border-slate-200 text-slate-900"
                          value={selectedVehicle.vin || ""}
                          onChange={(e) => setSelectedVehicle({ ...selectedVehicle, vin: e.target.value })}
                          onBlur={async () => {
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ vin: selectedVehicle.vin }),
                            });
                            fetchVehicles();
                          }}
                        />
                      </div>
                    </div>
                  </div>

                  {/* Custom Labels Section */}
                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <h3 className="text-sm font-semibold text-slate-900 mb-3">Custom Labels</h3>

                    {/* Applied Labels Display */}
                    {selectedVehicle.labels?.length > 0 && (
                      <div className="flex flex-wrap gap-2 mb-3">
                        {selectedVehicle.labels.map((label) => (
                          <span
                            key={label.id}
                            className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold"
                            style={{
                              backgroundColor: `${label.colour}20`,
                              color: label.colour,
                            }}
                          >
                            <span className="w-2 h-2 rounded-full" style={{ backgroundColor: label.colour }}></span>
                            {label.name}
                            <button
                              type="button"
                              onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}
                              className="ml-0.5 hover:opacity-70"
                            >
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </span>
                        ))}
                      </div>
                    )}

                    {/* Labels Dropdown */}
                    <div className="relative">
                      <button
                        type="button"
                        onClick={() => setShowLabelsDropdown(!showLabelsDropdown)}
                        className="w-full flex items-center justify-between px-3 py-2 border border-slate-300 rounded-lg bg-white text-sm hover:border-slate-400 transition-colors"
                      >
                        <span className="text-slate-600">
                          {selectedVehicle.labels?.length > 0
                            ? `${selectedVehicle.labels.length} label${selectedVehicle.labels.length > 1 ? 's' : ''} selected`
                            : "Select labels..."
                          }
                        </span>
                        <svg className={`w-4 h-4 text-slate-400 transition-transform ${showLabelsDropdown ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                      </button>

                      {showLabelsDropdown && (
                        <div className="absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-auto">
                          {availableLabels.map((label) => {
                            const isApplied = selectedVehicle.labels?.some(l => l.id === label.id);
                            return (
                              <button
                                key={label.id}
                                type="button"
                                onClick={() => toggleVehicleLabel(selectedVehicle.id, label.id)}
                                className="w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left"
                              >
                                <span
                                  className="w-3 h-3 rounded-full flex-shrink-0"
                                  style={{ backgroundColor: label.colour }}
                                ></span>
                                <span className="flex-1 text-sm text-slate-700">{label.name}</span>
                                {isApplied && (
                                  <svg className="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                                  </svg>
                                )}
                              </button>
                            );
                          })}

                          {/* Add New Label Option */}
                          <div className="border-t border-slate-100">
                            <button
                              type="button"
                              onClick={() => {
                                setShowLabelsDropdown(false);
                                setShowAddLabelModal(true);
                              }}
                              className="w-full flex items-center gap-2 px-3 py-2 hover:bg-slate-50 transition-colors text-left text-indigo-600"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                              </svg>
                              <span className="text-sm font-medium">Add new label</span>
                            </button>
                          </div>
                        </div>
                      )}
                    </div>

                    {availableLabels.length === 0 && (
                      <button
                        type="button"
                        onClick={() => setShowAddLabelModal(true)}
                        className="w-full flex items-center justify-center gap-2 px-3 py-2 border border-dashed border-slate-300 rounded-lg text-sm text-slate-500 hover:border-slate-400 hover:text-slate-600 transition-colors"
                      >
                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                        Create your first label
                      </button>
                    )}
                  </div>

                  {/* Status & Location Section - Now below Identity */}
                  <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                    <h3 className="text-sm font-semibold text-slate-900 mb-4">Status & Location</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Vehicle Type</label>
                        <select
                          className="select select-sm select-bordered w-full"
                          value={selectedVehicle.type || "STOCK"}
                          onChange={async (e) => {
                            const newType = e.target.value;
                            const updates = { type: newType };
                            // Clear saleType if not Stock
                            if (newType !== "STOCK") {
                              updates.saleType = null;
                            }
                            setSelectedVehicle({ ...selectedVehicle, ...updates });
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify(updates),
                            });
                            fetchVehicles();
                            toast.success("Vehicle type updated");
                          }}
                        >
                          <option value="STOCK">Stock</option>
                          <option value="COURTESY">Courtesy</option>
                          <option value="FLEET_OTHER">Fleet</option>
                        </select>
                      </div>
                      {/* Sale Type - Only show for Stock vehicles */}
                      {(selectedVehicle.type === "STOCK" || !selectedVehicle.type) && (
                        <div className="form-control">
                          <label className="text-xs font-medium text-slate-600 mb-1 block">Sale Type</label>
                          <select
                            className="select select-sm select-bordered w-full"
                            value={selectedVehicle.saleType || "RETAIL"}
                            onChange={async (e) => {
                              const newSaleType = e.target.value;
                              setSelectedVehicle({ ...selectedVehicle, saleType: newSaleType });
                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ saleType: newSaleType }),
                              });
                              fetchVehicles();
                              toast.success("Sale type updated");
                            }}
                          >
                            <option value="RETAIL">Retail</option>
                            <option value="TRADE">Trade</option>
                          </select>
                        </div>
                      )}
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Status</label>
                        <select
                          className="select select-sm select-bordered w-full"
                          value={selectedVehicle.status || "in_stock"}
                          onChange={async (e) => {
                            const newStatus = e.target.value;
                            setSelectedVehicle({ ...selectedVehicle, status: newStatus });
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ status: newStatus }),
                            });
                            fetchVehicles();
                            toast.success(`Status updated to ${COLUMNS.find(c => c.key === newStatus)?.label || newStatus}`);
                          }}
                        >
                          {COLUMNS.map(col => (
                            <option key={col.key} value={col.key}>{col.label}</option>
                          ))}
                        </select>
                      </div>
                      <div className="form-control">
                        <label className="text-xs font-medium text-slate-600 mb-1 block">Location</label>
                        <select
                          className="select select-sm select-bordered w-full"
                          value={selectedVehicle.locationId?.id || selectedVehicle.locationId?._id || selectedVehicle.locationId || ""}
                          onChange={async (e) => {
                            const value = e.target.value;
                            if (value === "__add_new__") {
                              setShowAddLocationModal(true);
                              return;
                            }
                            const locationId = value || null;
                            setSelectedVehicle({ ...selectedVehicle, locationId: locationId });
                            await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                              method: "PUT",
                              headers: { "Content-Type": "application/json" },
                              body: JSON.stringify({ locationId }),
                            });
                            const updated = await fetch(`/api/vehicles/${selectedVehicle.id}`).then(r => r.json());
                            setSelectedVehicle(updated);
                            fetchVehicles();
                            toast.success("Location updated");
                          }}
                        >
                          <option value="">On Site</option>
                          {locations.map(loc => (
                            <option key={loc.id || loc._id} value={loc.id || loc._id}>{loc.name}</option>
                          ))}
                          <option value="__add_new__">+ Add Location</option>
                        </select>
                      </div>
                    </div>
                  </div>

                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                      <h3 className="text-sm font-semibold text-slate-900 mb-4">Specs</h3>
                      <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-3">
                          <div className="form-control">
                            <label className="label label-text text-xs">Make</label>
                            <input
                              type="text"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.make || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, make: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ make: selectedVehicle.make }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>

                          <div className="form-control">
                            <label className="label label-text text-xs">Model</label>
                            <input
                              type="text"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.model || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, model: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ model: selectedVehicle.model }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div className="form-control">
                            <label className="label label-text text-xs">Year</label>
                            <input
                              type="number"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.year || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, year: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ year: selectedVehicle.year }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>

                          <div className="form-control">
                            <label className="label label-text text-xs">Mileage</label>
                            <input
                              type="number"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.mileageCurrent || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, mileageCurrent: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ mileageCurrent: selectedVehicle.mileageCurrent }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <div className="form-control">
                            <label className="label label-text text-xs">Colour</label>
                            <input
                              type="text"
                              className="input input-sm input-bordered"
                              value={selectedVehicle.colour || ""}
                              onChange={(e) => setSelectedVehicle({ ...selectedVehicle, colour: e.target.value })}
                              onBlur={async () => {
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ colour: selectedVehicle.colour }),
                                });
                                fetchVehicles();
                              }}
                            />
                          </div>

                          <div className="form-control">
                            <label className="label label-text text-xs">Fuel Type</label>
                            <select
                              className="select select-sm select-bordered"
                              value={selectedVehicle.fuelType || ""}
                              onChange={async (e) => {
                                const newValue = e.target.value;
                                setSelectedVehicle({ ...selectedVehicle, fuelType: newValue });
                                await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                  method: "PUT",
                                  headers: { "Content-Type": "application/json" },
                                  body: JSON.stringify({ fuelType: newValue }),
                                });
                                fetchVehicles();
                              }}
                            >
                              <option value="">Select...</option>
                              <option value="Petrol">Petrol</option>
                              <option value="Diesel">Diesel</option>
                              <option value="Hybrid">Hybrid</option>
                              <option value="Electric">Electric</option>
                            </select>
                          </div>
                        </div>

                        <div className="form-control">
                          <label className="label label-text text-xs">MOT Expiry Date</label>
                          <input
                            type="date"
                            className="input input-sm input-bordered"
                            value={selectedVehicle.motExpiryDate ? new Date(selectedVehicle.motExpiryDate).toISOString().split('T')[0] : ""}
                            onChange={async (e) => {
                              const newValue = e.target.value;
                              setSelectedVehicle({ ...selectedVehicle, motExpiryDate: newValue });
                              await fetch(`/api/vehicles/${selectedVehicle.id}`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ motExpiryDate: newValue }),
                              });
                              fetchVehicles();
                            }}
                          />
                        </div>
                      </div>
                    </div>

                  <div className="card bg-base-200">
                    <div className="card-body p-4">
                      <h3 className="font-semibold mb-2">V5 Document</h3>
                      {selectedVehicle.v5Url ? (
                        <div>
                          <a href={selectedVehicle.v5Url} target="_blank" rel="noopener noreferrer" className="btn btn-sm btn-outline w-full mb-2">
                            View V5 Document
                          </a>
                          <label className="btn btn-sm btn-ghost w-full">
                            Replace V5
                            <input type="file" accept="image/*,.pdf" className="hidden" onChange={(e) => uploadV5(e.target.files[0])} />
                          </label>
                        </div>
                      ) : (
                        <label className="btn btn-primary btn-sm w-full">
                          Upload V5
                          <input type="file" accept="image/*,.pdf" className="hidden" onChange={(e) => uploadV5(e.target.files[0])} />
                        </label>
                      )}
                    </div>
                  </div>

                  {selectedVehicle.notes && (
                    <div className="card bg-base-200">
                      <div className="card-body p-4">
                        <h3 className="font-semibold mb-2">Notes</h3>
                        <p className="text-sm whitespace-pre-wrap">{selectedVehicle.notes}</p>
                      </div>
                    </div>
                  )}
                </div>
              )}


              {/* Prep Checklist Tab */}
              {activeTab === "checklist" && (
                <div className="card bg-base-200">
                  <div className="card-body p-4">
                    <h3 className="font-semibold mb-3">Prep Checklist</h3>
                    <div className="space-y-2">
                      {selectedVehicle.tasks?.map((task) => (
                        <div key={task.id} className="flex items-center gap-2 p-2 rounded hover:bg-base-300 group">
                          <select
                            className="select select-bordered select-xs"
                            value={task.status || "pending"}
                            onChange={(e) => updateTaskStatus(task.id, e.target.value)}
                            onClick={(e) => e.stopPropagation()}
                          >
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="done">Done</option>
                            <option value="not_required">Not Required</option>
                          </select>
                          {editingTaskId === task.id ? (
                            <input
                              type="text"
                              className="input input-bordered input-xs flex-1"
                              value={editingTaskName}
                              onChange={(e) => setEditingTaskName(e.target.value)}
                              onBlur={() => {
                                if (editingTaskName.trim() && editingTaskName !== task.name) {
                                  updateTaskName(task.id, editingTaskName);
                                } else {
                                  setEditingTaskId(null);
                                  setEditingTaskName("");
                                }
                              }}
                              onKeyPress={(e) => {
                                if (e.key === "Enter") {
                                  if (editingTaskName.trim() && editingTaskName !== task.name) {
                                    updateTaskName(task.id, editingTaskName);
                                  } else {
                                    setEditingTaskId(null);
                                    setEditingTaskName("");
                                  }
                                }
                              }}
                              onKeyDown={(e) => {
                                if (e.key === "Escape") {
                                  setEditingTaskId(null);
                                  setEditingTaskName("");
                                }
                              }}
                              autoFocus
                            />
                          ) : (
                            <span
                              className={`flex-1 text-sm cursor-pointer ${task.status === "done" ? "line-through text-base-content/50" : ""}`}
                              onClick={() => {
                                setEditingTaskId(task.id);
                                setEditingTaskName(task.name);
                              }}
                              title="Click to edit"
                            >
                              {task.name}
                            </span>
                          )}
                          {task.completedAt && !editingTaskId && (
                            <span className="text-xs text-base-content/50">
                              {formatDate(task.completedAt)}
                            </span>
                          )}
                          <button
                            className="btn btn-ghost btn-xs opacity-0 group-hover:opacity-100 transition-opacity"
                            onClick={() => deleteTask(task.id)}
                          >
                            âœ•
                          </button>
                        </div>
                      ))}
                    </div>
                    <div className="flex gap-2 mt-3">
                      <input
                        type="text"
                        className="input input-bordered input-sm flex-1"
                        placeholder="Add new task..."
                        value={newTaskName}
                        onChange={(e) => setNewTaskName(e.target.value)}
                        onKeyPress={(e) => e.key === "Enter" && addTask()}
                      />
                      <button className="btn btn-primary btn-sm" onClick={addTask}>
                        Add
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Issues Tab */}
              {activeTab === "issues" && (
                <div className="space-y-4">
                  <button
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => setShowAddIssueModal(true)}
                  >
                    + Add Issue
                  </button>

                  {selectedVehicle.issues && selectedVehicle.issues.length > 0 ? (
                    <div className="space-y-3">
                      {selectedVehicle.issues.map((issue) => (
                        <div key={issue.id} className="card bg-base-200">
                          <div className="card-body p-4">
                            {/* Header with badges and status */}
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <span className="badge badge-sm">{issue.category}</span>
                                {issue.subcategory && <span className="badge badge-sm badge-ghost ml-1">{issue.subcategory}</span>}
                              </div>
                              <select
                                className="select select-bordered select-xs"
                                value={issue.status || "Outstanding"}
                                onChange={(e) => updateIssue(issue.id, { status: e.target.value })}
                              >
                                <option value="Outstanding">Outstanding</option>
                                <option value="Ordered">Ordered</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Complete">Complete</option>
                              </select>
                            </div>

                            {/* Issue details */}
                            <p className="text-sm font-medium">{issue.description}</p>
                            {issue.actionNeeded && (
                              <p className="text-xs text-base-content/60 mt-1">Action: {issue.actionNeeded}</p>
                            )}
                            {issue.notes && (
                              <p className="text-xs text-base-content/60 mt-1">Notes: {issue.notes}</p>
                            )}

                            {/* Photos */}
                            {issue.photos && issue.photos.length > 0 && (
                              <div className="flex flex-wrap gap-2 mt-2">
                                {issue.photos.map((photo, idx) => (
                                  <a key={idx} href={photo} target="_blank" rel="noopener noreferrer">
                                    <img
                                      src={photo}
                                      alt={`Issue photo ${idx + 1}`}
                                      className="w-16 h-16 object-cover rounded-lg hover:opacity-80 transition-opacity border border-base-300"
                                    />
                                  </a>
                                ))}
                              </div>
                            )}

                            {/* Updates Timeline */}
                            <div className="mt-3">
                              <button
                                className="btn btn-ghost btn-xs w-full justify-between"
                                onClick={() => setExpandedIssues(prev => ({
                                  ...prev,
                                  [issue.id]: !prev[issue.id]
                                }))}
                              >
                                <span>
                                  {expandedIssues[issue.id] ? "Hide" : "Show"} Updates
                                  {issue.updates?.length > 0 && ` (${issue.updates.length})`}
                                </span>
                                <span>{expandedIssues[issue.id] ? "â–²" : "â–¼"}</span>
                              </button>

                              {expandedIssues[issue.id] && (
                                <div className="mt-3 space-y-3">
                                  {/* Creation timestamp */}
                                  <div className="flex gap-2 text-xs">
                                    <div className="w-1 bg-base-300 rounded"></div>
                                    <p className="text-base-content/60">
                                      Created {formatDate(issue.createdAt)}
                                    </p>
                                  </div>

                                  {/* Updates timeline */}
                                  {issue.updates && issue.updates.length > 0 ? (
                                    issue.updates.map((update, idx) => (
                                      <div key={idx} className="flex gap-2 text-xs">
                                        <div className="w-1 bg-primary rounded"></div>
                                        <div className="flex-1">
                                          <p className="font-medium">{update.userName || "User"}</p>
                                          <p className="text-sm mt-1">{update.content}</p>
                                          <p className="text-base-content/60 mt-1">
                                            {formatDate(update.createdAt)}
                                          </p>
                                        </div>
                                      </div>
                                    ))
                                  ) : (
                                    <p className="text-xs text-base-content/60 text-center py-2">
                                      No updates yet
                                    </p>
                                  )}

                                  {/* Add update input */}
                                  <div className="flex gap-2 mt-3">
                                    <input
                                      type="text"
                                      className="input input-bordered input-sm flex-1"
                                      placeholder="Add an update..."
                                      value={issueUpdateContent[issue.id] || ""}
                                      onChange={(e) => setIssueUpdateContent(prev => ({
                                        ...prev,
                                        [issue.id]: e.target.value
                                      }))}
                                      onKeyPress={(e) => {
                                        if (e.key === "Enter") {
                                          addIssueUpdate(issue.id, issueUpdateContent[issue.id]);
                                        }
                                      }}
                                    />
                                    <button
                                      className="btn btn-primary btn-sm"
                                      onClick={() => addIssueUpdate(issue.id, issueUpdateContent[issue.id])}
                                    >
                                      Add
                                    </button>
                                  </div>
                                </div>
                              )}
                            </div>

                            {/* Delete button */}
                            <div className="flex justify-end mt-2">
                              <button
                                className="btn btn-ghost btn-xs text-error"
                                onClick={() => {
                                  if (confirm("Delete this issue?")) deleteIssue(issue.id);
                                }}
                              >
                                Delete
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-8 text-base-content/60">
                      No issues recorded
                    </div>
                  )}
                </div>
              )}

              {/* Documents Tab */}
              {activeTab === "documents" && (
                <div className="space-y-4">
                  <button
                    className="btn btn-primary btn-sm w-full"
                    onClick={() => setShowAddDocumentModal(true)}
                  >
                    + Add Document/Image
                  </button>

                  {selectedVehicle.documents && selectedVehicle.documents.length > 0 ? (
                    <div className="space-y-3">
                      {selectedVehicle.documents.map((doc) => (
                        <div key={doc.id} className="card bg-base-200">
                          <div className="card-body p-4">
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <p className="text-sm font-medium">{doc.name}</p>
                                <span className="badge badge-sm mt-1">
                                  {doc.type === "v5" && "V5"}
                                  {doc.type === "service_history" && "Service History"}
                                  {doc.type === "fault_codes" && "Fault Codes"}
                                  {doc.type === "other" && "Other"}
                                </span>
                              </div>
                              <div className="flex gap-1">
                                <a
                                  href={doc.url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="btn btn-ghost btn-xs"
                                  onClick={(e) => e.stopPropagation()}
                                >
                                  View
                                </a>
                                <button
                                  className="btn btn-ghost btn-xs text-error"
                                  onClick={() => {
                                    if (confirm("Delete this document?")) deleteDocument(doc.id);
                                  }}
                                >
                                  Delete
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-8 text-base-content/60">
                      No documents uploaded
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Drag Preview - floating card that follows cursor */}
      {draggedCard && (
        <div
          className="fixed pointer-events-none z-50"
          style={{
            left: dragPosition.x - 120,
            top: dragPosition.y - 30,
            transform: "rotate(3deg)",
          }}
        >
          <div className="bg-white rounded-xl shadow-2xl border-2 border-blue-400 w-60 p-3 opacity-90">
            <div className="flex items-center gap-2">
              <p className="font-bold text-slate-900 text-sm truncate">
                {draggedCard.year} {draggedCard.make} {draggedCard.model}
              </p>
            </div>
            <span className="font-mono text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-md inline-block mt-1">
              {draggedCard.regCurrent}
            </span>
          </div>
        </div>
      )}

      {showAddModal && (
        <AddVehicleModal onClose={() => setShowAddModal(false)} onSuccess={() => { setShowAddModal(false); fetchVehicles(); }} />
      )}

      {showAddIssueModal && (
        <AddIssueModal
          issueForm={issueForm}
          setIssueForm={setIssueForm}
          onClose={() => {
            setShowAddIssueModal(false);
            setIssueForm({
              category: "",
              subcategory: "",
              description: "",
              actionNeeded: "",
              status: "outstanding",
              notes: "",
              photos: [],
            });
          }}
          onSubmit={addIssue}
        />
      )}

      {showAddDocumentModal && (
        <AddDocumentModal
          documentForm={documentForm}
          setDocumentForm={setDocumentForm}
          onClose={() => {
            setShowAddDocumentModal(false);
            setDocumentForm({ name: "", type: "other", file: null });
          }}
          onSubmit={() => {
            if (!documentForm.file) {
              return toast.error("File is required");
            }
            if (documentForm.type === "other" && !documentForm.name) {
              return toast.error("Document name is required for 'Other' type");
            }
            // Generate default name based on type if not "other"
            const docName = documentForm.type === "other"
              ? documentForm.name
              : documentForm.type.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
            uploadDocument(documentForm.file, docName, documentForm.type);
          }}
        />
      )}

      {showAddLocationModal && (
        <AddLocationModal
          onClose={() => setShowAddLocationModal(false)}
          onSuccess={(newLocation) => {
            setLocations([...locations, newLocation]);
            setSelectedVehicle({ ...selectedVehicle, locationId: newLocation.id || newLocation._id });
            fetch(`/api/vehicles/${selectedVehicle.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ locationId: newLocation.id || newLocation._id }),
            }).then(() => {
              fetchVehicles();
              setShowAddLocationModal(false);
            });
          }}
        />
      )}

      {/* Add Label Modal */}
      {showAddLabelModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div className="flex items-center justify-between p-4 border-b border-slate-200">
              <h3 className="text-lg font-bold text-slate-900">Create New Label</h3>
              <button
                onClick={() => {
                  setShowAddLabelModal(false);
                  setNewLabelForm({ name: "", colour: "#6366f1" });
                }}
                className="btn btn-ghost btn-sm btn-circle"
              >
                âœ•
              </button>
            </div>
            <div className="p-4 space-y-4">
              <div className="form-control">
                <label className="label">
                  <span className="label-text font-medium">Label Name</span>
                </label>
                <input
                  type="text"
                  placeholder="e.g., Hot Lead, Awaiting Finance"
                  className="input input-bordered w-full"
                  value={newLabelForm.name}
                  onChange={(e) => setNewLabelForm({ ...newLabelForm, name: e.target.value })}
                  autoFocus
                />
              </div>
              <div className="form-control">
                <label className="label">
                  <span className="label-text font-medium">Colour</span>
                </label>
                <div className="flex items-center gap-3">
                  <input
                    type="color"
                    className="w-12 h-10 rounded cursor-pointer border border-slate-300"
                    value={newLabelForm.colour}
                    onChange={(e) => setNewLabelForm({ ...newLabelForm, colour: e.target.value })}
                  />
                  <div className="flex gap-2">
                    {["#ef4444", "#f59e0b", "#22c55e", "#3b82f6", "#8b5cf6", "#ec4899", "#6b7280"].map(color => (
                      <button
                        key={color}
                        type="button"
                        onClick={() => setNewLabelForm({ ...newLabelForm, colour: color })}
                        className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 ${newLabelForm.colour === color ? 'border-slate-900 scale-110' : 'border-transparent'}`}
                        style={{ backgroundColor: color }}
                      />
                    ))}
                  </div>
                </div>
              </div>
              {/* Preview */}
              {newLabelForm.name && (
                <div className="pt-2">
                  <label className="label">
                    <span className="label-text font-medium">Preview</span>
                  </label>
                  <span
                    className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-semibold"
                    style={{
                      backgroundColor: `${newLabelForm.colour}20`,
                      color: newLabelForm.colour,
                    }}
                  >
                    <span className="w-2 h-2 rounded-full" style={{ backgroundColor: newLabelForm.colour }}></span>
                    {newLabelForm.name}
                  </span>
                </div>
              )}
            </div>
            <div className="flex justify-end gap-2 p-4 border-t border-slate-200">
              <button
                className="btn btn-ghost"
                onClick={() => {
                  setShowAddLabelModal(false);
                  setNewLabelForm({ name: "", colour: "#6366f1" });
                }}
              >
                Cancel
              </button>
              <button
                className="btn btn-primary"
                onClick={createLabel}
                disabled={!newLabelForm.name.trim()}
              >
                Create Label
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Job Sheet Share Modal */}
      {showJobSheetModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div className="flex items-center justify-between p-4 border-b border-slate-200">
              <h3 className="text-lg font-bold text-slate-900">Share Job Sheet</h3>
              <button
                onClick={() => {
                  setShowJobSheetModal(false);
                  setJobSheetLink(null);
                }}
                className="btn btn-ghost btn-sm btn-circle"
              >
                âœ•
              </button>
            </div>
            <div className="p-4">
              {isGeneratingJobSheet ? (
                <div className="flex flex-col items-center py-8">
                  <div className="w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mb-3"></div>
                  <p className="text-slate-600">Generating share link...</p>
                </div>
              ) : jobSheetLink ? (
                <div className="space-y-4">
                  <div className="bg-slate-50 rounded-lg p-3">
                    <p className="text-xs text-slate-500 mb-1">Shareable Link</p>
                    <p className="text-sm font-mono text-slate-900 break-all">{jobSheetLink}</p>
                  </div>
                  <p className="text-xs text-slate-500">
                    This link expires in 60 days. Anyone with this link can view the job sheet.
                  </p>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={copyJobSheetLink}
                      className="btn btn-outline btn-sm gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                      Copy Link
                    </button>
                    <button
                      onClick={shareViaWhatsApp}
                      className="btn btn-success btn-sm gap-2 text-white"
                    >
                      <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                      </svg>
                      WhatsApp
                    </button>
                    <button
                      onClick={() => {
                        const subject = `Job Sheet - ${selectedVehicle?.regCurrent || 'Vehicle'}`;
                        const body = `Here is the job sheet for ${selectedVehicle?.regCurrent || 'the vehicle'}:\n\n${jobSheetLink}`;
                        window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
                      }}
                      className="btn btn-outline btn-sm gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                      </svg>
                      Email
                    </button>
                    <button
                      onClick={() => window.open(jobSheetLink, '_blank')}
                      className="btn btn-outline btn-sm gap-2"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                      </svg>
                      Print / PDF
                    </button>
                  </div>
                </div>
              ) : (
                <div className="text-center py-8 text-slate-500">
                  No link generated yet
                </div>
              )}
            </div>
            <div className="flex justify-end p-4 border-t border-slate-200">
              <button
                className="btn btn-ghost"
                onClick={() => {
                  setShowJobSheetModal(false);
                  setJobSheetLink(null);
                }}
              >
                Close
              </button>
            </div>
          </div>
        </div>
      )}
    </DashboardLayout>
  );
}

function AddVehicleModal({ onClose, onSuccess }) {
  const [isLoading, setIsLoading] = useState(false);
  const [isLookingUp, setIsLookingUp] = useState(false);
  const [locations, setLocations] = useState([]);
  const [prepTemplates, setPrepTemplates] = useState([]);
  const [formData, setFormData] = useState({
    regCurrent: "", make: "", model: "", year: "", mileageCurrent: "",
    fuelType: "", transmission: "", colour: "", notes: "", locationId: "",
    type: "STOCK", // STOCK, COURTESY, FLEET_OTHER
    saleType: "RETAIL", // RETAIL, TRADE - only used when type is STOCK
  });

  // Appraisal lookup state
  const [matchedAppraisal, setMatchedAppraisal] = useState(null);
  const [isCheckingAppraisal, setIsCheckingAppraisal] = useState(false);
  const [appraisalDismissed, setAppraisalDismissed] = useState(false);

  // VRM appraisal suggestions
  const [appraisalSuggestions, setAppraisalSuggestions] = useState([]);
  const [showAppraisalDropdown, setShowAppraisalDropdown] = useState(false);
  const [isSearchingAppraisals, setIsSearchingAppraisals] = useState(false);

  // Document uploads
  const [v5File, setV5File] = useState(null);
  const [serviceHistoryFile, setServiceHistoryFile] = useState(null);
  const [faultCodesFile, setFaultCodesFile] = useState(null);
  const [otherDocuments, setOtherDocuments] = useState([]);

  // Initial issues (array of issues to create with the vehicle)
  const [initialIssues, setInitialIssues] = useState([]);
  const [showAddIssueInVehicleModal, setShowAddIssueInVehicleModal] = useState(false);
  const [newIssueForm, setNewIssueForm] = useState({
    category: "",
    subcategory: "",
    description: "",
    actionNeeded: "",
    status: "Outstanding",
    notes: "",
    photos: [],
  });

  // Prep checklist template
  const [selectedTemplate, setSelectedTemplate] = useState("default");

  useEffect(() => {
    fetchLocations();
    fetchPrepTemplates();
  }, []);

  const fetchLocations = async () => {
    try {
      const res = await fetch("/api/locations");
      const data = await res.json();
      setLocations(data);
    } catch (error) {
      console.error("Failed to fetch locations");
    }
  };

  const fetchPrepTemplates = async () => {
    try {
      const res = await fetch("/api/prep-tasks");
      const data = await res.json();
      setPrepTemplates(data);
      // Auto-select first template if available
      if (data.length > 0) setSelectedTemplate("default");
    } catch (error) {
      console.error("Failed to fetch prep templates");
    }
  };

  // Search unconverted appraisals as user types VRM
  const searchAppraisals = async (vrm) => {
    if (!vrm || vrm.length < 2) {
      setAppraisalSuggestions([]);
      setShowAppraisalDropdown(false);
      return;
    }
    setIsSearchingAppraisals(true);
    try {
      const res = await fetch(`/api/appraisals/search-unconverted?q=${encodeURIComponent(vrm)}`);
      if (res.ok) {
        const results = await res.json();
        setAppraisalSuggestions(results);
        setShowAppraisalDropdown(results.length > 0);
      } else {
        setAppraisalSuggestions([]);
        setShowAppraisalDropdown(false);
      }
    } catch (error) {
      setAppraisalSuggestions([]);
      setShowAppraisalDropdown(false);
    } finally {
      setIsSearchingAppraisals(false);
    }
  };

  // Handle selecting an appraisal from suggestions
  const handleSelectAppraisalSuggestion = (appraisal) => {
    setFormData(prev => ({
      ...prev,
      regCurrent: appraisal.vehicleReg || prev.regCurrent,
      make: appraisal.vehicleMake || prev.make,
      model: appraisal.vehicleModel || prev.model,
      year: appraisal.vehicleYear || prev.year,
      mileageCurrent: appraisal.mileage || prev.mileageCurrent,
    }));
    setMatchedAppraisal(appraisal);
    setAppraisalDismissed(false);
    setShowAppraisalDropdown(false);
    setAppraisalSuggestions([]);
    toast.success(`Loaded appraisal for ${appraisal.vehicleReg}`);
  };

  // Check for existing appraisal when VRM changes
  const checkForAppraisal = async (vrm) => {
    if (!vrm || vrm.length < 2) {
      setMatchedAppraisal(null);
      return;
    }
    setIsCheckingAppraisal(true);
    try {
      const res = await fetch(`/api/appraisals/by-vrm?vrm=${encodeURIComponent(vrm)}`);
      if (res.ok) {
        const appraisal = await res.json();
        setMatchedAppraisal(appraisal);
        setAppraisalDismissed(false);
      } else {
        setMatchedAppraisal(null);
      }
    } catch (error) {
      setMatchedAppraisal(null);
    } finally {
      setIsCheckingAppraisal(false);
    }
  };

  // Import data from matched appraisal
  const importFromAppraisal = () => {
    if (!matchedAppraisal) return;
    setFormData(prev => ({
      ...prev,
      regCurrent: matchedAppraisal.vehicleReg || prev.regCurrent,
      make: matchedAppraisal.vehicleMake || prev.make,
      model: matchedAppraisal.vehicleModel || prev.model,
      year: matchedAppraisal.vehicleYear || prev.year,
      mileageCurrent: matchedAppraisal.mileage || prev.mileageCurrent,
      notes: matchedAppraisal.conditionNotes || prev.notes,
    }));
    setAppraisalDismissed(true);
    toast.success("Imported data from appraisal");
  };

  // Convert appraisal directly to stock (uses the convert API)
  const convertAppraisalToStock = async () => {
    if (!matchedAppraisal) return;
    setIsLoading(true);
    try {
      // Determine the API endpoint based on appraisal type
      const endpoint = matchedAppraisal.type === "customer_px"
        ? `/api/customer-px/${matchedAppraisal.id}/convert`
        : `/api/appraisals/${matchedAppraisal.id}/convert`;

      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initialStatus: "in_stock" }),
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || "Failed to convert appraisal");
      }

      toast.success("Appraisal converted to stock!");
      onSuccess();
    } catch (error) {
      toast.error(error.message);
    } finally {
      setIsLoading(false);
    }
  };

  const handleLookup = async () => {
    if (!formData.regCurrent) return toast.error("Enter registration first");
    setIsLookingUp(true);
    try {
      const res = await fetch("/api/dvla-lookup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ vehicleReg: formData.regCurrent }),
      });
      const data = await res.json();

      // Check for error response
      if (!res.ok || data.error) {
        toast.error(data.message || data.error || "Vehicle not found");
        return;
      }

      if (data.isDummy) showDummyNotification("DVLA API");

      // Update form with DVLA data
      setFormData(prev => ({
        ...prev,
        make: data.make || prev.make,
        model: data.model || prev.model,
        year: data.yearOfManufacture || prev.year,
        colour: data.colour || prev.colour,
        fuelType: data.fuelType || prev.fuelType,
        transmission: data.transmission || prev.transmission,
        motExpiryDate: data.motExpiryDate || prev.motExpiryDate,
      }));

      toast.success(`Found: ${data.make} ${data.model || ""} (${data.yearOfManufacture || ""})`);
    } catch (error) {
      toast.error("Lookup failed - please try again");
    } finally {
      setIsLookingUp(false);
    }
  };

  const uploadFile = async (file) => {
    if (!file) return null;
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch("/api/vehicles/upload", {
      method: "POST",
      body: formData,
    });
    if (!res.ok) throw new Error("Upload failed");
    const data = await res.json();
    return data.url;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!formData.regCurrent || !formData.make || !formData.model) {
      return toast.error("Reg, make and model are required");
    }
    setIsLoading(true);
    try {
      // Create vehicle first
      // If "None" is selected, skip default tasks
      // If "default" is selected, create default tasks (don't skip)
      const skipDefault = selectedTemplate === "";
      const vehicleRes = await fetch("/api/vehicles", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...formData, skipDefaultTasks: skipDefault }),
      });
      if (!vehicleRes.ok) {
        const errorData = await vehicleRes.json();
        throw new Error(errorData.error || "Failed to create vehicle");
      }
      const vehicle = await vehicleRes.json();

      // Upload documents
      if (v5File) {
        const v5Url = await uploadFile(v5File);
        await fetch(`/api/vehicles/${vehicle.id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ v5Url }),
        });
      }

      if (serviceHistoryFile) {
        const url = await uploadFile(serviceHistoryFile);
        await fetch(`/api/vehicles/${vehicle.id}/documents`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: "Service History", type: "service_history", url }),
        });
      }

      if (faultCodesFile) {
        const url = await uploadFile(faultCodesFile);
        await fetch(`/api/vehicles/${vehicle.id}/documents`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name: "Fault Codes", type: "fault_codes", url }),
        });
      }

      // Upload other documents
      for (const doc of otherDocuments) {
        if (doc.file) {
          const url = await uploadFile(doc.file);
          await fetch(`/api/vehicles/${vehicle.id}/documents`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: doc.name || "Document", type: "other", url }),
          });
        }
      }

      // Create initial issues from the array
      for (const issue of initialIssues) {
        await fetch(`/api/vehicles/${vehicle.id}/issues`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            category: issue.category,
            subcategory: issue.subcategory,
            description: issue.description,
            actionNeeded: issue.actionNeeded,
            status: issue.status || "Outstanding",
            notes: issue.notes,
          }),
        });
      }

      // Create prep tasks based on template
      // Only create from prepTemplates if a custom template is selected (not "default" which is handled by API)
      if (selectedTemplate && selectedTemplate !== "default" && prepTemplates.length > 0) {
        for (const template of prepTemplates) {
          await fetch(`/api/vehicles/${vehicle.id}/tasks`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: template.name }),
          });
        }
      }

      // Link appraisal to vehicle if one was matched
      if (matchedAppraisal && matchedAppraisal.id) {
        await fetch(`/api/appraisals/${matchedAppraisal.id}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            decision: "converted",
            vehicleId: vehicle.id,
            decidedAt: new Date(),
          }),
        });
      }

      toast.success("Vehicle added!");
      onSuccess();
    } catch (error) {
      console.error("Error:", error);
      toast.error(error.message);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box max-w-4xl max-h-[90vh] overflow-y-auto">
        <h3 className="font-bold text-lg mb-4">Add Vehicle</h3>
        <form onSubmit={handleSubmit}>
          {/* Vehicle Details Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Vehicle Details</h4>
            <div className="relative flex gap-2 mb-4">
              <div className="relative flex-1">
                <input
                  type="text"
                  placeholder="Registration"
                  className="input input-bordered w-full uppercase font-mono"
                  value={formData.regCurrent}
                  onChange={(e) => {
                    const newValue = e.target.value.toUpperCase();
                    setFormData({ ...formData, regCurrent: newValue });
                    searchAppraisals(newValue);
                  }}
                  onFocus={() => {
                    if (appraisalSuggestions.length > 0) setShowAppraisalDropdown(true);
                  }}
                  onBlur={(e) => {
                    // Delay hiding dropdown so click on suggestion can register
                    setTimeout(() => setShowAppraisalDropdown(false), 200);
                    checkForAppraisal(e.target.value);
                  }}
                />
                {isSearchingAppraisals && (
                  <span className="absolute right-3 top-1/2 -translate-y-1/2 loading loading-spinner loading-sm"></span>
                )}
                {/* Appraisal Suggestions Dropdown */}
                {showAppraisalDropdown && appraisalSuggestions.length > 0 && (
                  <div className="absolute top-full left-0 right-0 z-50 mt-1 bg-base-100 border border-base-300 rounded-lg shadow-xl max-h-64 overflow-y-auto">
                    <div className="px-3 py-2 text-xs text-base-content/60 border-b border-base-200 bg-base-200/50">
                      Unconverted Appraisals
                    </div>
                    {appraisalSuggestions.map((appraisal) => (
                      <button
                        key={appraisal.id}
                        type="button"
                        className="w-full px-3 py-2 text-left hover:bg-base-200 border-b border-base-200 last:border-b-0 flex items-center gap-3"
                        onClick={() => handleSelectAppraisalSuggestion(appraisal)}
                      >
                        <div className="flex-1">
                          <div className="font-mono font-bold">{appraisal.vehicleReg}</div>
                          <div className="text-sm text-base-content/70">
                            {appraisal.vehicleMake} {appraisal.vehicleModel} {appraisal.vehicleYear ? `(${appraisal.vehicleYear})` : ""}
                          </div>
                        </div>
                        <span className={`badge badge-sm ${appraisal.type === "dealer" ? "badge-primary" : "badge-secondary"}`}>
                          {appraisal.type === "dealer" ? "Dealer" : "Customer PX"}
                        </span>
                      </button>
                    ))}
                  </div>
                )}
              </div>
              <button type="button" className="btn btn-secondary" onClick={handleLookup} disabled={isLookingUp}>
                {isLookingUp ? <span className="loading loading-spinner"></span> : "ğŸ” Lookup"}
              </button>
            </div>

            {/* Appraisal Match Alert */}
            {isCheckingAppraisal && (
              <div className="alert mb-4">
                <span className="loading loading-spinner loading-sm"></span>
                <span>Checking for existing appraisals...</span>
              </div>
            )}
            {matchedAppraisal && !appraisalDismissed && (
              <div className="alert alert-success mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div className="flex-1">
                  <p className="font-semibold">
                    {matchedAppraisal.type === "customer_px" ? "Customer PX" : "Dealer"} Appraisal Found: {matchedAppraisal.vehicleReg}
                  </p>
                  <p className="text-sm opacity-80">
                    {matchedAppraisal.vehicleMake} {matchedAppraisal.vehicleModel} {matchedAppraisal.vehicleYear ? `(${matchedAppraisal.vehicleYear})` : ""}
                    {matchedAppraisal.mileage ? ` â€¢ ${matchedAppraisal.mileage.toLocaleString()} miles` : ""}
                  </p>
                </div>
                <div className="flex flex-col sm:flex-row gap-2">
                  <button type="button" className="btn btn-sm btn-primary" onClick={convertAppraisalToStock} disabled={isLoading}>
                    {isLoading ? <span className="loading loading-spinner loading-sm"></span> : "Convert to Stock"}
                  </button>
                  <button type="button" className="btn btn-sm btn-ghost" onClick={importFromAppraisal}>
                    Import Data Only
                  </button>
                  <button type="button" className="btn btn-sm btn-ghost" onClick={() => setAppraisalDismissed(true)}>
                    Dismiss
                  </button>
                </div>
              </div>
            )}

            <div className="grid grid-cols-2 gap-4">
              <div className="form-control">
                <label className="label"><span className="label-text">Make *</span></label>
                <input type="text" className="input input-bordered" value={formData.make}
                  onChange={(e) => setFormData({ ...formData, make: e.target.value })} required />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Model *</span></label>
                <input type="text" className="input input-bordered" value={formData.model}
                  onChange={(e) => setFormData({ ...formData, model: e.target.value })} required />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Year</span></label>
                <input type="number" className="input input-bordered" value={formData.year}
                  onChange={(e) => setFormData({ ...formData, year: e.target.value })} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Mileage</span></label>
                <input type="number" className="input input-bordered" value={formData.mileageCurrent}
                  onChange={(e) => setFormData({ ...formData, mileageCurrent: e.target.value })} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Colour</span></label>
                <input type="text" className="input input-bordered" value={formData.colour}
                  onChange={(e) => setFormData({ ...formData, colour: e.target.value })} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Fuel Type</span></label>
                <select className="select select-bordered" value={formData.fuelType}
                  onChange={(e) => setFormData({ ...formData, fuelType: e.target.value })}>
                  <option value="">Select...</option>
                  <option value="Petrol">Petrol</option>
                  <option value="Diesel">Diesel</option>
                  <option value="Hybrid">Hybrid</option>
                  <option value="Electric">Electric</option>
                </select>
              </div>
            </div>
          </div>

          {/* Vehicle Type Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Vehicle Type</h4>
            <div className="grid grid-cols-2 gap-4">
              <div className="form-control">
                <label className="label"><span className="label-text">Vehicle Type</span></label>
                <select
                  className="select select-bordered"
                  value={formData.type}
                  onChange={(e) => {
                    const newType = e.target.value;
                    setFormData({
                      ...formData,
                      type: newType,
                      // Clear saleType if not Stock
                      saleType: newType === "STOCK" ? (formData.saleType || "RETAIL") : undefined
                    });
                  }}
                >
                  <option value="STOCK">Stock - For sale</option>
                  <option value="COURTESY">Courtesy - Loan vehicle</option>
                  <option value="FLEET_OTHER">Fleet/Other - Company vehicle</option>
                </select>
              </div>
              {/* Sale Type - Only show for Stock vehicles */}
              {formData.type === "STOCK" && (
                <div className="form-control">
                  <label className="label"><span className="label-text">Sale Type</span></label>
                  <select
                    className="select select-bordered"
                    value={formData.saleType || "RETAIL"}
                    onChange={(e) => setFormData({ ...formData, saleType: e.target.value })}
                  >
                    <option value="RETAIL">Retail - Customer sale</option>
                    <option value="TRADE">Trade - Dealer sale</option>
                  </select>
                </div>
              )}
            </div>
            <label className="label">
              <span className="label-text-alt text-base-content/60">
                {formData.type === "COURTESY" && "This vehicle will be available in courtesy car forms"}
                {formData.type === "FLEET_OTHER" && "This vehicle will not appear in sales board"}
                {formData.type === "STOCK" && formData.saleType === "TRADE" && "Trade vehicles are marked separately and can be filtered"}
                {formData.type === "STOCK" && formData.saleType !== "TRADE" && "This vehicle will go through the normal sales prep flow"}
              </span>
            </label>
          </div>

          {/* Location Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Location</h4>
            <div className="form-control">
              <select
                className="select select-bordered"
                value={formData.locationId}
                onChange={(e) => setFormData({ ...formData, locationId: e.target.value })}
              >
                <option value="">On Site</option>
                {locations.map(loc => (
                  <option key={loc.id} value={loc.id}>{loc.name}</option>
                ))}
              </select>
            </div>
          </div>

          {/* Document Uploads Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Document Uploads (Optional)</h4>
            <div className="space-y-3">
              <div className="form-control">
                <label className="label"><span className="label-text">V5 Document</span></label>
                <input type="file" className="file-input file-input-bordered w-full" accept="image/*,.pdf"
                  onChange={(e) => setV5File(e.target.files[0])} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Service History</span></label>
                <input type="file" className="file-input file-input-bordered w-full" accept="image/*,.pdf"
                  onChange={(e) => setServiceHistoryFile(e.target.files[0])} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Fault Codes</span></label>
                <input type="file" className="file-input file-input-bordered w-full" accept="image/*,.pdf"
                  onChange={(e) => setFaultCodesFile(e.target.files[0])} />
              </div>
              <div className="form-control">
                <label className="label"><span className="label-text">Other Documents</span></label>
                <button
                  type="button"
                  className="btn btn-sm btn-outline"
                  onClick={() => setOtherDocuments([...otherDocuments, { name: "", file: null }])}
                >
                  + Add Document/Image
                </button>
                {otherDocuments.map((doc, idx) => (
                  <div key={idx} className="flex gap-2 mt-2">
                    <input
                      type="text"
                      placeholder="Document name"
                      className="input input-sm input-bordered flex-1"
                      value={doc.name}
                      onChange={(e) => {
                        const updated = [...otherDocuments];
                        updated[idx].name = e.target.value;
                        setOtherDocuments(updated);
                      }}
                    />
                    <input
                      type="file"
                      className="file-input file-input-sm file-input-bordered flex-1"
                      onChange={(e) => {
                        const updated = [...otherDocuments];
                        updated[idx].file = e.target.files[0];
                        setOtherDocuments(updated);
                      }}
                    />
                    <button
                      type="button"
                      className="btn btn-sm btn-ghost"
                      onClick={() => setOtherDocuments(otherDocuments.filter((_, i) => i !== idx))}
                    >
                      âœ•
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>

          {/* Initial Issues Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Initial Issues (Optional)</h4>

            {/* Add Issue Button */}
            <button
              type="button"
              className="btn btn-outline btn-sm w-full mb-3"
              onClick={() => setShowAddIssueInVehicleModal(true)}
            >
              + Add Issue
            </button>

            {/* Issue Summary Cards */}
            {initialIssues.length > 0 && (
              <div className="space-y-2">
                {initialIssues.map((issue, index) => (
                  <div key={index} className="card bg-base-200">
                    <div className="card-body p-3">
                      <div className="flex justify-between items-start gap-2">
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="badge badge-sm">{issue.category}</span>
                            {issue.subcategory && (
                              <span className="badge badge-sm badge-ghost">{issue.subcategory}</span>
                            )}
                          </div>
                          <p className="text-sm font-medium truncate">{issue.description}</p>
                          {issue.actionNeeded && (
                            <p className="text-xs text-base-content/60 mt-1">Action: {issue.actionNeeded}</p>
                          )}
                        </div>
                        <button
                          type="button"
                          className="btn btn-ghost btn-xs text-error"
                          onClick={() => {
                            setInitialIssues(initialIssues.filter((_, i) => i !== index));
                          }}
                        >
                          âœ•
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Prep Checklist Template Section */}
          <div className="mb-6">
            <h4 className="font-semibold text-md mb-3">Prep Checklist Template</h4>
            <div className="form-control">
              <select
                className="select select-bordered"
                value={selectedTemplate}
                onChange={(e) => setSelectedTemplate(e.target.value)}
              >
                <option value="">None - add tasks manually</option>
                <option value="default">Standard Prep (5 tasks)</option>
              </select>
            </div>

            {/* Task Preview for Standard Prep */}
            {selectedTemplate === "default" && (
              <div className="mt-3 p-3 bg-base-200 rounded-lg">
                <p className="text-xs font-semibold text-base-content/70 mb-2">Tasks included:</p>
                <div className="text-xs text-base-content/60 space-y-1">
                  {["PDI", "Valet", "Photos", "MOT Check", "Advert"].map((task, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <span className="text-primary">âœ“</span>
                      <span>{task}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>

          {/* Notes Section */}
          <div className="mb-6">
            <div className="form-control">
              <label className="label"><span className="label-text">Additional Notes</span></label>
              <textarea className="textarea textarea-bordered" value={formData.notes}
                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}></textarea>
            </div>
          </div>

          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
            <button type="submit" className="btn btn-primary" disabled={isLoading}>
              {isLoading ? <span className="loading loading-spinner"></span> : "Add Vehicle"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>

      {/* Nested Add Issue Modal */}
      {showAddIssueInVehicleModal && (
        <AddIssueModal
          issueForm={newIssueForm}
          setIssueForm={setNewIssueForm}
          onClose={() => {
            setShowAddIssueInVehicleModal(false);
            setNewIssueForm({
              category: "",
              subcategory: "",
              description: "",
              actionNeeded: "",
              status: "Outstanding",
              notes: "",
              photos: [],
            });
          }}
          onSubmit={() => {
            // Validate required fields
            if (!newIssueForm.category || !newIssueForm.subcategory || !newIssueForm.description) {
              return toast.error("Category, subcategory, and description are required");
            }

            // Add issue to the array
            setInitialIssues([...initialIssues, { ...newIssueForm }]);

            // Close modal and reset form
            setShowAddIssueInVehicleModal(false);
            setNewIssueForm({
              category: "",
              subcategory: "",
              description: "",
              actionNeeded: "",
              status: "Outstanding",
              notes: "",
              photos: [],
            });
            toast.success("Issue added");
          }}
        />
      )}
    </div>
  );
}

function AddIssueModal({ issueForm, setIssueForm, onClose, onSubmit }) {
  const [isLoading, setIsLoading] = useState(false);
  const [photoFiles, setPhotoFiles] = useState([]);
  const [photoPreviews, setPhotoPreviews] = useState([]);
  const [isUploadingPhotos, setIsUploadingPhotos] = useState(false);

  const handlePhotoChange = (e) => {
    const files = Array.from(e.target.files);
    setPhotoFiles(prev => [...prev, ...files]);

    // Create previews
    files.forEach(file => {
      const reader = new FileReader();
      reader.onloadend = () => {
        setPhotoPreviews(prev => [...prev, reader.result]);
      };
      reader.readAsDataURL(file);
    });
  };

  const removePhoto = (index) => {
    setPhotoFiles(prev => prev.filter((_, i) => i !== index));
    setPhotoPreviews(prev => prev.filter((_, i) => i !== index));
  };

  const uploadPhotos = async () => {
    const uploadedUrls = [];
    for (const file of photoFiles) {
      const formData = new FormData();
      formData.append("file", file);
      const res = await fetch("/api/vehicles/upload", {
        method: "POST",
        body: formData,
      });
      if (res.ok) {
        const data = await res.json();
        uploadedUrls.push(data.url);
      }
    }
    return uploadedUrls;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    try {
      // Upload photos first if any
      let photoUrls = [];
      if (photoFiles.length > 0) {
        setIsUploadingPhotos(true);
        photoUrls = await uploadPhotos();
        setIsUploadingPhotos(false);
      }
      // Pass photo URLs to onSubmit
      await onSubmit(photoUrls);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box max-w-2xl">
        <h3 className="font-bold text-lg mb-4">Add Issue</h3>
        <form onSubmit={handleSubmit}>
          <div className="grid grid-cols-2 gap-4">
            <div className="form-control">
              <label className="label"><span className="label-text">Category *</span></label>
              <select
                className="select select-bordered"
                value={issueForm.category}
                onChange={(e) => {
                  setIssueForm({ ...issueForm, category: e.target.value, subcategory: "" });
                }}
                required
              >
                <option value="">Select category...</option>
                <option value="mechanical">Mechanical</option>
                <option value="electrical">Electrical</option>
                <option value="bodywork">Bodywork</option>
                <option value="interior">Interior</option>
                <option value="tyres">Tyres</option>
                <option value="mot">MOT</option>
                <option value="service">Service</option>
                <option value="fault_codes">Fault Codes</option>
                <option value="other">Other</option>
              </select>
            </div>

            {issueForm.category && (
              <div className="form-control">
                <label className="label"><span className="label-text">Subcategory</span></label>
                <select
                  className="select select-bordered"
                  value={issueForm.subcategory}
                  onChange={(e) => setIssueForm({ ...issueForm, subcategory: e.target.value })}
                >
                  <option value="">Select subcategory...</option>
                  {ISSUE_SUBCATEGORIES[issueForm.category]?.map((sub) => (
                    <option key={sub} value={sub}>{sub}</option>
                  ))}
                </select>
              </div>
            )}

            {/* Fault Codes field - only show for fault_codes category */}
            {issueForm.category === "fault_codes" && (
              <div className="form-control col-span-2">
                <label className="label"><span className="label-text">Fault Codes</span></label>
                <input
                  type="text"
                  className="input input-bordered font-mono"
                  value={issueForm.faultCodes || ""}
                  onChange={(e) => setIssueForm({ ...issueForm, faultCodes: e.target.value })}
                  placeholder="e.g. P0301, P0420, C1234"
                />
                <label className="label">
                  <span className="label-text-alt">Enter codes separated by commas</span>
                </label>
              </div>
            )}

            <div className="form-control col-span-2">
              <label className="label"><span className="label-text">Description *</span></label>
              <textarea
                className="textarea textarea-bordered"
                value={issueForm.description}
                onChange={(e) => setIssueForm({ ...issueForm, description: e.target.value })}
                placeholder={issueForm.category === "fault_codes" ? "Describe what the fault codes indicate..." : "Describe the issue..."}
                required
                rows="3"
              ></textarea>
            </div>

            <div className="form-control col-span-2">
              <label className="label"><span className="label-text">Action Needed</span></label>
              <input
                type="text"
                className="input input-bordered"
                value={issueForm.actionNeeded}
                onChange={(e) => setIssueForm({ ...issueForm, actionNeeded: e.target.value })}
                placeholder="What needs to be done?"
              />
            </div>

            <div className="form-control">
              <label className="label"><span className="label-text">Status</span></label>
              <select
                className="select select-bordered"
                value={issueForm.status}
                onChange={(e) => setIssueForm({ ...issueForm, status: e.target.value })}
              >
                <option value="outstanding">Outstanding</option>
                <option value="ordered">Ordered</option>
                <option value="in_progress">In Progress</option>
                <option value="resolved">Resolved</option>
              </select>
            </div>

            {/* Parts Required Section */}
            <div className="form-control">
              <label className="label cursor-pointer justify-start gap-3">
                <input
                  type="checkbox"
                  className="checkbox checkbox-primary"
                  checked={issueForm.partsRequired || false}
                  onChange={(e) => setIssueForm({ ...issueForm, partsRequired: e.target.checked })}
                />
                <span className="label-text">Parts Required</span>
              </label>
            </div>

            {issueForm.partsRequired && (
              <div className="form-control col-span-2">
                <label className="label"><span className="label-text">Parts Details</span></label>
                <textarea
                  className="textarea textarea-bordered"
                  value={issueForm.partsDetails || ""}
                  onChange={(e) => setIssueForm({ ...issueForm, partsDetails: e.target.value })}
                  placeholder="Supplier, part numbers, who ordered, ETA..."
                  rows="2"
                ></textarea>
              </div>
            )}

            <div className="form-control col-span-2">
              <label className="label"><span className="label-text">Notes</span></label>
              <textarea
                className="textarea textarea-bordered"
                value={issueForm.notes}
                onChange={(e) => setIssueForm({ ...issueForm, notes: e.target.value })}
                placeholder="Additional notes..."
                rows="2"
              ></textarea>
            </div>

            {/* Photo Upload */}
            <div className="form-control col-span-2">
              <label className="label"><span className="label-text">Photos</span></label>
              <input
                type="file"
                accept="image/*"
                multiple
                onChange={handlePhotoChange}
                className="file-input file-input-bordered w-full"
              />
              {photoPreviews.length > 0 && (
                <div className="flex flex-wrap gap-2 mt-3">
                  {photoPreviews.map((preview, idx) => (
                    <div key={idx} className="relative">
                      <img src={preview} alt={`Preview ${idx + 1}`} className="w-20 h-20 object-cover rounded-lg" />
                      <button
                        type="button"
                        onClick={() => removePhoto(idx)}
                        className="absolute -top-2 -right-2 btn btn-circle btn-xs btn-error"
                      >
                        âœ•
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
            <button type="submit" className="btn btn-primary" disabled={isLoading || isUploadingPhotos}>
              {isLoading || isUploadingPhotos ? (
                <>
                  <span className="loading loading-spinner loading-sm"></span>
                  {isUploadingPhotos ? "Uploading photos..." : "Saving..."}
                </>
              ) : "Add Issue"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}

function AddDocumentModal({ documentForm, setDocumentForm, onClose, onSubmit }) {
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    try {
      await onSubmit();
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box">
        <h3 className="font-bold text-lg mb-4">Add Document/Image</h3>
        <form onSubmit={handleSubmit}>
          <div className="space-y-4">
            <div className="form-control">
              <label className="label"><span className="label-text">Document Type</span></label>
              <select
                className="select select-bordered"
                value={documentForm.type}
                onChange={(e) => setDocumentForm({ ...documentForm, type: e.target.value })}
              >
                <option value="v5">V5</option>
                <option value="service_history">Service History</option>
                <option value="fault_codes">Fault Codes</option>
                <option value="other">Other</option>
              </select>
            </div>

            {/* Only show Document Name field when "Other" is selected */}
            {documentForm.type === "other" && (
              <div className="form-control">
                <label className="label"><span className="label-text">Document Name *</span></label>
                <input
                  type="text"
                  className="input input-bordered"
                  value={documentForm.name}
                  onChange={(e) => setDocumentForm({ ...documentForm, name: e.target.value })}
                  placeholder="e.g., MOT Certificate, Insurance"
                  required
                />
              </div>
            )}

            <div className="form-control">
              <label className="label"><span className="label-text">File *</span></label>
              <input
                type="file"
                className="file-input file-input-bordered w-full"
                onChange={(e) => setDocumentForm({ ...documentForm, file: e.target.files[0] })}
                accept="image/*,.pdf,.doc,.docx"
                required
              />
            </div>
          </div>

          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
            <button type="submit" className="btn btn-primary" disabled={isLoading}>
              {isLoading ? <span className="loading loading-spinner"></span> : "Upload Document/Image"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}

function AddLocationModal({ onClose, onSuccess }) {
  const [name, setName] = useState("");
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!name.trim()) return toast.error("Location name is required");

    setIsLoading(true);
    try {
      const res = await fetch("/api/locations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name.trim(), type: "offsite" }),
      });
      if (!res.ok) throw new Error("Failed to create location");
      const newLocation = await res.json();
      toast.success("Location added");
      onSuccess(newLocation);
    } catch (error) {
      toast.error("Failed to add location");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="modal modal-open">
      <div className="modal-box">
        <h3 className="font-bold text-lg mb-4">Add New Location</h3>
        <form onSubmit={handleSubmit}>
          <div className="form-control">
            <label className="label">
              <span className="label-text">Location Name *</span>
            </label>
            <input
              type="text"
              className="input input-bordered w-full"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g., ABC Body Shop, Paint Centre"
              required
              autoFocus
            />
          </div>
          <div className="modal-action">
            <button type="button" className="btn btn-ghost" onClick={onClose}>
              Cancel
            </button>
            <button type="submit" className="btn btn-primary" disabled={isLoading}>
              {isLoading ? <span className="loading loading-spinner"></span> : "Add Location"}
            </button>
          </div>
        </form>
      </div>
      <div className="modal-backdrop" onClick={onClose}></div>
    </div>
  );
}
